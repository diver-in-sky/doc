


























<!doctype html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
  <link rel="icon" type="image/png" sizes="16x16" href=../../_static/favicon/favicon-16x16.png>
  <link rel="icon" type="image/png" sizes="32x32" href=../../_static/favicon/favicon-32x32.png>
  <link rel="icon" type="image/png" sizes="96x96" href=../../_static/favicon/favicon-96x96.png>

    <title>1. Lua tutorials</title>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/js/menu.js"></script>
      <script type="text/javascript" src="../../_static/js/mobile_menu.js"></script>
      <script type="text/javascript" src="../../_static/js/stacktable.min.js"></script>
      <script type="text/javascript" src="../../_static/js/headers.js"></script>
      <script type="text/javascript" src="../../_static/js/dropdown.js"></script>
      <script type="text/javascript" src="../../_static/js/jquery.sticky-kit.min.js"></script>
      <link rel="stylesheet" href="../../_static/design.css">

    
    <!--[if lt IE 9]>
      <script src="/js/ie8.js"></script>
      <link rel="stylesheet" href="/theme/ie8.css" />
    <![endif]-->
    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-22120502-1', 'auto');
  ga('send', 'pageview');
</script>

<!-- Rating@Mail.ru counter -->
<script type="text/javascript">
  var _tmr = _tmr || [];
  _tmr.push({id: "2284916", type: "pageView", start: (new Date()).getTime()});
  (function (d, w) {
    var ts = d.createElement("script"); ts.type = "text/javascript"; ts.async = true;
    ts.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//top-fwz1.mail.ru/js/code.js";
    var f = function () {var s = d.getElementsByTagName("script")[0]; s.parentNode.insertBefore(ts, s);};
    if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); }
  })(document, window);
</script>
<noscript>
  <div style="position:absolute;left:-10000px;">
    <img src="//top-fwz1.mail.ru/counter?id=2284916;js=na" style="border:0;"
         height="1" width="1" alt="Рейтинг@Mail.ru" />
  </div>
</noscript>
<!-- //Rating@Mail.ru counter -->


    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:       '',
        VERSION:        '1.7.2',
        COLLAPSE_INDEX:  false,
        FILE_SUFFIX:    '.html',
        HAS_SOURCE:      true
      };
      
      
      var disqus_config = function () {
          this.page.identifier = "doc/tutorials/lua_tutorials";
          this.language        = "en"
      };
    </script>
    

  </head>
  <body class="p-cols_design b-doc-doc/tutorials/lua_tutorials">
    <div class="b-wrapper">
      <!-- HEADER > -->
      
  <header class="b-header">
    <div class="b-header_menu_mobile">
      <div class="b-burger-button">
        <span></span>
      </div>
      <form role="search" class="b-header-search" action="../../search.html" method="get">
        <input name="q" type="search">
      </form>
    </div>
    <div class="b-menu_mobile">
      <div class="b-menu_mobile__wrapper">
        <nav class="b-header_menu">
          
  <ul class="b-menu">
    
      
      <li class="b-menu-item">
      
        <a href="../../index.html" class="b-menu-item-url">Overview</a>
      </li>
    
      
      <li class="b-menu-item">
      
        <a href="../../try.html" class="b-menu-item-url">Try</a>
      </li>
    
      
      <li class="b-menu-item p-active">
      
        <a href="../../doc.html" class="b-menu-item-url">Documentation</a>
      </li>
    
      
      <li class="b-menu-item">
      
        <a href="../../download.html" class="b-menu-item-url">Download</a>
      </li>
    
      
      <li class="b-menu-item">
      
        <a href="../../careers.html" class="b-menu-item-url">Careers</a>
      </li>
    
      
      <li class="b-menu-item">
      
        <a href="../../rocks.html" class="b-menu-item-url">Rocks</a>
      </li>
    
  </ul>

        </nav>
      </div>
    </div>
    <div class="b-header-wrapper">
      <nav class="b-header_menu">
        
  <ul class="b-menu">
    
      
      <li class="b-menu-item">
      
        <a href="../../index.html" class="b-menu-item-url">Overview</a>
      </li>
    
      
      <li class="b-menu-item">
      
        <a href="../../try.html" class="b-menu-item-url">Try</a>
      </li>
    
      
      <li class="b-menu-item p-active">
      
        <a href="../../doc.html" class="b-menu-item-url">Documentation</a>
      </li>
    
      
      <li class="b-menu-item">
      
        <a href="../../download.html" class="b-menu-item-url">Download</a>
      </li>
    
      
      <li class="b-menu-item">
      
        <a href="../../careers.html" class="b-menu-item-url">Careers</a>
      </li>
    
      
      <li class="b-menu-item">
      
        <a href="../../rocks.html" class="b-menu-item-url">Rocks</a>
      </li>
    
  </ul>

      </nav>
    </div>
  </header>

      <!-- < HEADER -->

      <div class="b-content b-clearbox">
        
  
    <section class="b-block-lightgray b-documentation_top b-clearbox p-documentation_in">
      <div class="b-block-wrapper">
        <h2 class="b-section-title b-ellipsis toggle-navigation" title="1. Lua tutorials"> 1. Lua tutorials </h2>
  <div class="b-doc-language_selector">
    <ul class="b-doc-language_selector-list">
    
      <li class="b-doc-language_selector-item">
      
        <a href="#" class="b-doc-language_selector-item-url p-active"> En </a>
      
      </li>
    
      <li class="b-doc-language_selector-item">
      
        <a href="
  
    ../../ru/doc/tutorials/lua_tutorials.html
  
"
           class="b-doc-language_selector-item-url"> Ru </a>
      
      </li>
    
    </ul>
  </div>
</div>
    </section>
    
      <div class="b-cols_content b-clearbox">
        <div class="b-cols_content_left">
          <div class="b-menu-toc">
            
<form id="searchbox" role="search" class="search b-search" action="../../search.html" method="get">
  <input class="b-search-text" name="q" type="text"/ placeholder="Search the manual">
  <input class="b-search-but" type="submit" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>

<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../whats_new.html">What&#8217;s new?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../whats_new.html#what-s-new-in-tarantool-1-7">What&#8217;s new in Tarantool 1.7?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../intro.html#an-application-server-together-with-a-database-manager">An application server together with a database manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro.html#database-features">Database features</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">1. Lua tutorials</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#insert-one-million-tuples-with-a-lua-stored-procedure">1.1. Insert one million tuples with a Lua stored procedure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configure">1.1.1. Configure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#delimiter">1.1.2. Delimiter</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-a-function-that-returns-a-string">1.1.3. Create a function that returns a string</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-a-function-that-calls-another-function-and-sets-a-variable">1.1.4. Create a function that calls another function and sets a variable</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modify-the-function-so-it-returns-a-one-letter-random-string">1.1.5. Modify the function so it returns a one-letter random string</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modify-the-function-so-it-returns-a-ten-letter-random-string">1.1.6. Modify the function so it returns a ten-letter random string</a></li>
<li class="toctree-l4"><a class="reference internal" href="#make-a-tuple-out-of-a-number-and-a-string">1.1.7. Make a tuple out of a number and a string</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modify-main-function-to-insert-a-tuple-into-the-database">1.1.8. Modify main_function to insert a tuple into the database</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modify-main-function-to-insert-a-million-tuples-into-the-database">1.1.9. Modify main_function to insert a million tuples into the database</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sum-a-json-field-for-all-tuples">1.2. Sum a JSON field for all tuples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#indexed-pattern-search">1.3. Indexed pattern search</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="c_tutorial.html">2. C tutorial</a><ul>
<li class="toctree-l3"><a class="reference internal" href="c_tutorial.html#c-stored-procedures">2.1. C stored procedures</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../book/index.html">User&#8217;s Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../book/intro.html">1. Preface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../book/intro.html#how-to-read-the-documentation">1.1. How to read the documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/intro.html#getting-in-touch-with-the-tarantool-community">1.2. Getting in touch with the Tarantool community</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../book/user_guide_getting_started.html">2. Getting started</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../book/user_guide_getting_started.html#downloading-and-installing-a-binary-package">2.1. Downloading and installing a binary package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/user_guide_getting_started.html#starting-tarantool-and-making-your-first-database">2.2. Starting Tarantool and making your first database</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/user_guide_getting_started.html#connecting-remotely">2.3. Connecting remotely</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../book/box/index.html">3. Database</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../book/box/index.html#data-model">3.1. Data model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#space">3.1.1. Space</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#tuple-set">3.1.2. Tuple set</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#index">3.1.3. Index</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#data-types">3.1.4. Data types</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#operations">3.1.5. Operations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#persistence">3.1.6. Persistence</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#data-manipulation">3.1.7. Data manipulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#index-operations">3.1.8. Index operations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../book/box/index.html#transaction-control">3.2. Transaction control</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#cooperative-multitasking-environment">3.2.1. Cooperative multitasking environment</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../book/box/index.html#example">3.2.1.1. Example</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#implicit-yields">3.2.2. Implicit yields</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../book/box/index.html#access-control">3.3. Access control</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#passwords">3.3.1. Passwords</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#users-and-the-user-space">3.3.2. Users and the _user space</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#privileges-and-the-priv-space">3.3.3. Privileges and the _priv space</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#functions-and-the-func-space">3.3.4. Functions and the _func space</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#box-session-and-security">3.3.5. box.session and security</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#roles">3.3.6. Roles</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../book/box/index.html#example-showing-a-role-within-a-role">3.3.6.1. Example showing a role within a role</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../book/box/index.html#triggers">3.4. Triggers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#connection-triggers">3.4.1. Connection triggers</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../book/box/index.html#id3">3.4.1.1. Example</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#authentication-triggers">3.4.2. Authentication triggers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#lua-module.box.space">3.4.3. Replace triggers</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../book/box/index.html#id4">3.4.3.1. Example</a></li>
<li class="toctree-l5"><a class="reference internal" href="../book/box/index.html#another-example">3.4.3.2. Another example</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#getting-a-list-of-triggers">3.4.4. Getting a list of triggers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../book/box/index.html#limitations">3.5. Limitations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/box/index.html#vinyl-storage-engine">3.6. Vinyl storage engine</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#differences-between-memtx-and-vinyl-storage-engines">3.6.1. Differences between memtx and vinyl storage engines</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#vinyl-features">3.6.2. Vinyl features</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/index.html#under-the-hood">3.6.3. Under the hood</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../book/box/index.html#inserting-the-first-200-000-keys">3.6.3.1. Inserting the first 200.000 keys</a></li>
<li class="toctree-l5"><a class="reference internal" href="../book/box/index.html#inserting-the-next-300-000-keys">3.6.3.2. Inserting the next 300.000 keys</a></li>
<li class="toctree-l5"><a class="reference internal" href="../book/box/index.html#inserting-the-next-200-000-keys">3.6.3.3. Inserting the next 200.000 keys</a></li>
<li class="toctree-l5"><a class="reference internal" href="../book/box/index.html#inserting-the-last-300-000-keys">3.6.3.4. Inserting the last 300.000 keys</a></li>
<li class="toctree-l5"><a class="reference internal" href="../book/box/index.html#reading-million-keys">3.6.3.5. Reading million keys</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../book/app_server.html">4. Application server</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../book/app_server.html#about-modules-rocks">4.1. About modules/rocks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/app_server.html#installing-an-existing-module">4.2. Installing an existing module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/app_server.html#creating-a-new-lua-module-locally">4.3. Creating a new Lua module locally</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/app_server.html#creating-a-new-c-c-module-locally">4.4. Creating a new C/C++ module locally</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/app_server.html#creating-a-mixed-lua-c-module-locally">4.5. Creating a mixed Lua/C module locally</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/app_server.html#tips-for-special-situations">4.6. Tips for special situations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/app_server.html#cookbook-recipes">4.7. Cookbook recipes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#hello-world-lua">4.7.1. hello_world.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#console-start-lua">4.7.2. console_start.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#fio-read-lua">4.7.3. fio_read.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#fio-write-lua">4.7.4. fio_write.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#ffi-printf-lua">4.7.5. ffi_printf.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#ffi-gettimeofday-lua">4.7.6. ffi_gettimeofday.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#ffi-zlib-lua">4.7.7. ffi_zlib.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#ffi-meta-lua">4.7.8. ffi_meta.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#print-arrays-lua">4.7.9. print_arrays.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#count-array-lua">4.7.10. count_array.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#count-array-with-nils-lua">4.7.11. count_array_with_nils.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#count-array-with-nulls-lua">4.7.12. count_array_with_nulls.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#count-map-lua">4.7.13. count_map.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#swap-lua">4.7.14. swap.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#uri-lua">4.7.15. uri.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#class-lua">4.7.16. class.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#garbage-lua">4.7.17. garbage.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#fiber-producer-and-consumer-lua">4.7.18. fiber_producer_and_consumer.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#socket-tcpconnect-lua">4.7.19. socket_tcpconnect.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#socket-tcp-echo-lua">4.7.20. socket_tcp_echo.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#getaddrinfo-lua">4.7.21. getaddrinfo.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#socket-udp-echo-lua">4.7.22. socket_udp_echo.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#http-get-lua">4.7.23. http_get.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#http-send-lua">4.7.24. http_send.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#http-server-lua">4.7.25. http_server.lua</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/app_server.html#http-generate-html-lua">4.7.26. http_generate_html.lua</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../book/administration.html">5. Server administration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../book/administration.html#using-tarantool-as-a-client">5.1. Using tarantool as a client</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#conventions-used-in-this-section">5.1.1. Conventions used in this section</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#options-when-starting-client-from-the-command-line">5.1.2. Options when starting client from the command line</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#tokens-requests-and-special-key-combinations">5.1.3. Tokens, requests, and special key combinations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#requests">5.1.4. Requests</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../book/administration.html#utility-tarantoolctl">5.2. Utility tarantoolctl</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#configuration-for-tarantoolctl">5.2.1. Configuration for tarantoolctl</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#commands-for-tarantoolctl">5.2.2. Commands for tarantoolctl</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#typical-code-snippets-for-tarantoolctl">5.2.3. Typical code snippets for tarantoolctl</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#a-detailed-example-for-tarantoolctl">5.2.4. A detailed example for tarantoolctl</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#an-example-for-tarantoolctl-connect">5.2.5. An example for tarantoolctl connect</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../book/administration.html#administrative-ports">5.3. Administrative ports</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/administration.html#administrative-requests">5.4. Administrative requests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/administration.html#server-introspection">5.5. Server introspection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/administration.html#replication">5.6. Replication</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#replication-architecture">5.6.1. Replication architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#setting-up-a-master">5.6.2. Setting up a master</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#setting-up-a-replica">5.6.3. Setting up a replica</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#recovering-from-a-degraded-state">5.6.4. Recovering from a degraded state</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#quick-startup-of-a-new-simple-two-server-cluster">5.6.5. Quick startup of a new simple two-server cluster</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#monitoring-a-replica-s-actions">5.6.6. Monitoring a replica&#8217;s actions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#preventing-duplicate-actions">5.6.7. Preventing duplicate actions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#master-master-replication">5.6.8. Master-master replication</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#all-the-what-if-questions">5.6.9. All the &#8220;What If?&#8221; questions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#hands-on-replication-tutorial">5.6.10. Hands-on replication tutorial</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../book/administration.html#backups">5.7. Backups</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#cold-backup">5.7.1. Cold backup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#continuous-remote-backup">5.7.2. Continuous remote backup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#hot-backup">5.7.3. Hot backup</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../book/administration.html#updates-upgrades">5.8. Updates/upgrades</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#updating-tarantool-in-production">5.8.1. Updating Tarantool in production</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#upgrading-a-tarantool-database">5.8.2. Upgrading a Tarantool database</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../book/administration.html#server-signal-handling">5.9. Server signal handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/administration.html#process-title">5.10. Process title</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/administration.html#system-specific-administration-notes">5.11. System-specific administration notes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#debian-gnu-linux-and-ubuntu">5.11.1. Debian GNU/Linux and Ubuntu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#fedora-rhel-centos">5.11.2. Fedora, RHEL, CentOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#freebsd">5.11.3. FreeBSD</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#mac-os-x">5.11.4. Mac OS X</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../book/administration.html#notes-for-systemd-users">5.12. Notes for systemd users</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#instance-management">5.12.1. Instance management</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../book/administration.html#creating-instances">5.12.1.1. Creating instances</a></li>
<li class="toctree-l5"><a class="reference internal" href="../book/administration.html#starting-instances">5.12.1.2. Starting instances</a></li>
<li class="toctree-l5"><a class="reference internal" href="../book/administration.html#monitoring-instances">5.12.1.3. Monitoring instances</a></li>
<li class="toctree-l5"><a class="reference internal" href="../book/administration.html#attaching-to-instances">5.12.1.4. Attaching to instances</a></li>
<li class="toctree-l5"><a class="reference internal" href="../book/administration.html#checking-logs">5.12.1.5. Checking logs</a></li>
<li class="toctree-l5"><a class="reference internal" href="../book/administration.html#stopping-instances">5.12.1.6. Stopping instances</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#daemon-supervision">5.12.2. Daemon supervision</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#customizing-the-service-file">5.12.3. Customizing the service file</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#debugging">5.12.4. Debugging</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#precautions">5.12.5. Precautions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#limitations">5.12.6. Limitations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/administration.html#sysvinit-systemd-conversion">5.12.7. sysvinit -&gt; systemd conversion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../book/connectors/index.html">6. Connectors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../book/connectors/index.html#protocol">6.1. Protocol</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/connectors/index.html#packet-example">6.2. Packet example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/connectors/index.html#setting-up-the-server-for-connector-examples">6.3. Setting up the server for connector examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/connectors/index.html#java">6.4. Java</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/connectors/index.html#go">6.5. Go</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/connectors/index.html#r">6.6. R</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/connectors/index.html#erlang">6.7. Erlang</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/connectors/index.html#perl">6.8. Perl</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/connectors/index.html#php">6.9. PHP</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/connectors/index.html#python">6.10. Python</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/connectors/index.html#node-js">6.11. node.js</a></li>
<li class="toctree-l3"><a class="reference internal" href="../book/connectors/index.html#c">6.12. C</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../book/connectors/index.html#example-1">6.12.1. Example 1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/connectors/index.html#example-2">6.12.2. Example 2</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../book/connectors/index.html#interpreting-function-return-values">6.13. Interpreting function return values</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../book/faq.html">7. FAQ</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/reference_lua/index.html">1. Built-in library reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/box.html">1.1. Module <cite>box</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../book/box/box_schema.html">1.1.1. Submodule <cite>box.schema</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/box_space.html">1.1.2. Submodule <cite>box.space</cite></a><ul>
<li class="toctree-l5"><a class="reference internal" href="../book/box/box_space.html#example-use-box-space-functions-to-read-space-tuples">1.1.2.1. Example: use box.space functions to read _space tuples</a></li>
<li class="toctree-l5"><a class="reference internal" href="../book/box/box_space.html#example-use-box-space-functions-to-organize-a-space-tuple">1.1.2.2. Example: use box.space functions to organize a _space tuple</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/box_index.html">1.1.3. Submodule <cite>box.index</cite></a><ul>
<li class="toctree-l5"><a class="reference internal" href="../book/box/box_index.html#example-showing-use-of-the-box-functions">1.1.3.1. Example showing use of the box functions</a></li>
<li class="toctree-l5"><a class="reference internal" href="../book/box/box_index.html#example-showing-a-user-defined-iterator">1.1.3.2. Example showing a user-defined iterator</a></li>
<li class="toctree-l5"><a class="reference internal" href="../book/box/box_index.html#submodule-box-index-with-index-type-rtree-for-spatial-searches">1.1.3.3. Submodule <cite>box.index</cite> with index type = RTREE for spatial searches</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/box_session.html">1.1.4. Submodule <cite>box.session</cite></a><ul>
<li class="toctree-l5"><a class="reference internal" href="../book/box/box_session.html#example">1.1.4.1. Example</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/box_tuple.html">1.1.5. Submodule <cite>box.tuple</cite></a><ul>
<li class="toctree-l5"><a class="reference internal" href="../book/box/box_tuple.html#example">1.1.5.1. Example</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/box_cfg.html">1.1.6. Submodule <cite>box.cfg</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/box_slab.html">1.1.7. Submodule <cite>box.slab</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/box_info.html">1.1.8. Submodule <cite>box.info</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="../book/box/box_stat.html">1.1.9. Submodule <cite>box.stat</cite></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/clock.html">1.2. Module <cite>clock</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/console.html">1.3. Module <cite>console</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/crypto.html">1.4. Module <cite>crypto</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/crypto.html#incremental-methods-in-the-crypto-module">1.4.1. Incremental methods in the crypto module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/crypto.html#getting-the-same-results-from-digest-and-crypto-modules">1.4.2. Getting the same results from digest and crypto modules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/csv.html">1.5. Module <cite>csv</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/digest.html">1.6. Module <cite>digest</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/digest.html#incremental-methods-in-the-digest-module">1.6.1. Incremental methods in the digest module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/digest.html#example">1.6.2. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/errno.html">1.7. Module <cite>errno</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/box_error.html">1.8. Submodule <cite>box.error</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/fiber.html">1.9. Module <cite>fiber</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/fiber.html#example-of-fiber-use">1.9.1. Example Of Fiber Use</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/fiber_ipc.html">1.10. Submodule <cite>fiber-ipc</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/fiber_ipc.html#example">1.10.1. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/fiber_cond.html">1.11. Submodule <cite>fiber-cond</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/fiber_cond.html#example">1.11.1. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/fio.html">1.12. Module <cite>fio</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/fio.html#common-pathname-manipulations">1.12.1. Common pathname manipulations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/fio.html#common-file-manipulations">1.12.2. Common file manipulations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/fun.html">1.13. Module <cite>fun</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/json.html">1.14. Module <cite>json</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/json.html#configuration-settings">1.14.1. Configuration settings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/log.html">1.15. Module <cite>log</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/log.html#example">1.15.1. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/msgpack.html">1.16. Module <cite>msgpack</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/msgpack.html#example">1.16.1. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/net_box.html">1.17. Module <cite>net.box</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/net_box.html#example">1.17.1. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/box_once.html">1.18. Function <cite>box.once</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/pickle.html">1.19. Module <cite>pickle</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/socket.html">1.20. Module <cite>socket</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/socket.html#examples">1.20.1. Examples</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../reference/reference_lua/socket.html#use-of-a-tcp-socket-over-the-internet">1.20.1.1. Use of a TCP socket over the Internet</a></li>
<li class="toctree-l5"><a class="reference internal" href="../reference/reference_lua/socket.html#use-of-a-udp-socket-on-localhost">1.20.1.2. Use of a UDP socket on localhost</a></li>
<li class="toctree-l5"><a class="reference internal" href="../reference/reference_lua/socket.html#use-tcp-server-to-accept-file-contents-sent-with-socat">1.20.1.3. Use tcp_server to accept file contents sent with socat</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/strict.html">1.21. Module <cite>strict</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/tap.html">1.22. Module <cite>tap</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/tap.html#example">1.22.1. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/tarantool.html">1.23. Module <cite>tarantool</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/uuid.html">1.24. Module <cite>uuid</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/uuid.html#example">1.24.1. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/xlog.html">1.25. Module <cite>xlog</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/yaml.html">1.26. Module <cite>yaml</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_lua/yaml.html#example">1.26.1. Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/other.html">1.27. Miscellaneous</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/errcodes.html">1.28. Database error codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_lua/errcodes.html#handling-errors">1.29. Handling errors</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/reference_rock/index.html">2. Rocks reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_rock/dbms.html">2.1. SQL DBMS Modules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_rock/dbms.html#mysql-example">2.1.1. MySQL Example</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../reference/reference_rock/dbms.html#installation">2.1.1.1. Installation</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../reference/reference_rock/dbms.html#with-luarocks">2.1.1.1.1. With LuaRocks</a></li>
<li class="toctree-l6"><a class="reference internal" href="../reference/reference_rock/dbms.html#with-github">2.1.1.1.2. With GitHub</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../reference/reference_rock/dbms.html#connecting">2.1.1.2. Connecting</a></li>
<li class="toctree-l5"><a class="reference internal" href="../reference/reference_rock/dbms.html#how-to-ping">2.1.1.3. How to ping</a></li>
<li class="toctree-l5"><a class="reference internal" href="../reference/reference_rock/dbms.html#executing-a-statement">2.1.1.4. Executing a statement</a></li>
<li class="toctree-l5"><a class="reference internal" href="../reference/reference_rock/dbms.html#closing-connection">2.1.1.5. Closing connection</a></li>
<li class="toctree-l5"><a class="reference internal" href="../reference/reference_rock/dbms.html#example">2.1.1.6. Example</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_rock/dbms.html#postgresql-example">2.1.2. PostgreSQL Example</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../reference/reference_rock/dbms.html#id1">2.1.2.1. Installation</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../reference/reference_rock/dbms.html#id2">2.1.2.1.1. With LuaRocks</a></li>
<li class="toctree-l6"><a class="reference internal" href="../reference/reference_rock/dbms.html#id3">2.1.2.1.2. With GitHub</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="../reference/reference_rock/dbms.html#id4">2.1.2.2. Connecting</a></li>
<li class="toctree-l5"><a class="reference internal" href="../reference/reference_rock/dbms.html#id5">2.1.2.3. How to ping</a></li>
<li class="toctree-l5"><a class="reference internal" href="../reference/reference_rock/dbms.html#id6">2.1.2.4. Executing a statement</a></li>
<li class="toctree-l5"><a class="reference internal" href="../reference/reference_rock/dbms.html#id7">2.1.2.5. Closing connection</a></li>
<li class="toctree-l5"><a class="reference internal" href="../reference/reference_rock/dbms.html#id8">2.1.2.6. Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_rock/expirationd.html">2.2. Module <cite>expirationd</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_rock/shard.html">2.3. Module <cite>shard</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_rock/shard.html#example-shard-init-syntax-for-one-shard">2.3.1. Example: shard.init syntax for one shard</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_rock/shard.html#example-shard-init-syntax-for-three-shards">2.3.2. Example: shard.init syntax for three shards</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_rock/shard.html#example-shard-minimal-configuration">2.3.3. Example: Shard, Minimal Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_rock/shard.html#example-shard-scaling-out">2.3.4. Example: Shard, Scaling Out</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../reference/reference_rock/tdb.html">2.4. Module <cite>tdb</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_rock/tdb.html#debugger-commands">2.4.1. Debugger Commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/reference_rock/tdb.html#example-session">2.4.2. Example Session</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/configuration/index.html">3. Configuration reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/configuration/index.html#command-options">3.1. Command options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/configuration/index.html#uri">3.2. URI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/configuration/index.html#initialization-file">3.3. Initialization file</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/configuration/index.html#configuration-parameters">3.4. Configuration parameters</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration/index.html#basic-parameters">3.4.1. Basic parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration/index.html#configuring-the-storage">3.4.2. Configuring the storage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration/index.html#snapshot-daemon">3.4.3. Snapshot daemon</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration/index.html#binary-logging-and-snapshots">3.4.4. Binary logging and snapshots</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration/index.html#replication">3.4.5. Replication</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration/index.html#networking">3.4.6. Networking</a></li>
<li class="toctree-l4"><a class="reference internal" href="../reference/configuration/index.html#logging">3.4.7. Logging</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/index.html">Contributor&#8217;s Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../dev_guide/reference_capi/index.html">1. C API reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/reference_capi/box.html">1.1. Module <cite>box</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/reference_capi/clock.html">1.2. Module <cite>clock</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/reference_capi/coio.html">1.3. Module <cite>coio</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/reference_capi/error.html">1.4. Module <cite>error</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/reference_capi/fiber.html">1.5. Module <cite>fiber</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/reference_capi/box_index.html">1.6. Module <cite>index</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/reference_capi/latch.html">1.7. Module <cite>latch</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/reference_capi/utils.html">1.8. Module <cite>lua/utils</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/reference_capi/say.html">1.9. Module <cite>say</cite> (logging)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/reference_capi/schema.html">1.10. Module <cite>schema</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/reference_capi/trivia.html">1.11. Module <cite>trivia/config</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/reference_capi/tuple.html">1.12. Module <cite>tuple</cite></a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/reference_capi/txn.html">1.13. Module <cite>txn</cite></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../dev_guide/internals_index.html">2. Internals</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/internals_index.html#tarantool-s-binary-protocol">2.1. Tarantool&#8217;s binary protocol</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/internals_index.html#notation-in-diagrams">2.1.1. Notation in diagrams</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/internals_index.html#greeting-packet">2.1.2. Greeting packet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/internals_index.html#unified-packet-structure">2.1.3. Unified packet structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/internals_index.html#authentication">2.1.4. Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/internals_index.html#requests">2.1.5. Requests</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/internals_index.html#response-packet-structure">2.1.6. Response packet structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/internals_index.html#replication-packet-structure">2.1.7. Replication packet structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/internals_index.html#xlog-snap">2.1.8. XLOG / SNAP</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/internals_index.html#data-persistence-and-the-wal-file-format">2.2. Data persistence and the WAL file format</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/internals_index.html#the-snapshot-file-format">2.3. The snapshot file format</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/internals_index.html#the-recovery-process">2.4. The recovery process</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/internals_index.html#server-startup-with-replication">2.5. Server startup with replication</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../dev_guide/build_contribute_index.html">3. Build and contribute</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/building_from_source.html">3.1. Building from source</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/building_documentation.html">3.2. Building documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/release_management.html">3.3. Release management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/release_management.html#how-to-make-a-minor-release">3.3.1. How to make a minor release</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../dev_guide/guidelines_index.html">4. Guidelines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/developer_guidelines.html">4.1. Developer guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/developer_guidelines.html#how-to-work-on-a-bug">4.1.1. How to work on a bug</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/documentation_guidelines.html">4.2. Documentation guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/documentation_guidelines.html#markup-issues">4.2.1. Markup issues</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/documentation_guidelines.html#wrapping-text">4.2.1.1. Wrapping text</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/documentation_guidelines.html#formatting-code-snippets">4.2.1.2. Formatting code snippets</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/documentation_guidelines.html#using-separated-links">4.2.1.3. Using separated links</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/documentation_guidelines.html#creating-labels-for-local-links">4.2.1.4. Creating labels for local links</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/documentation_guidelines.html#making-comments">4.2.1.5. Making comments</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/documentation_guidelines.html#language-and-style-issues">4.2.2. Language and style issues</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/documentation_guidelines.html#us-vs-british-spelling">4.2.2.1. US vs British spelling</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/documentation_guidelines.html#examples-and-templates">4.2.3. Examples and templates</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/documentation_guidelines.html#module-and-function">4.2.3.1. Module and function</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/documentation_guidelines.html#module-class-and-method">4.2.3.2. Module, class and method</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/c_style_guide.html">4.3. C Style Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/c_style_guide.html#general-guidelines">4.3.1. General guidelines</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#commenting-style">4.3.1.1. Commenting style</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#header-files">4.3.1.2. Header files</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#allocating-memory">4.3.1.3. Allocating memory</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#other">4.3.1.4. Other</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/c_style_guide.html#linux-kernel-coding-style">4.3.2. Linux kernel coding style</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-1-indentation">4.3.2.1. Chapter 1: Indentation</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-2-breaking-long-lines-and-strings">4.3.2.2. Chapter 2: Breaking long lines and strings</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-3-placing-braces-and-spaces">4.3.2.3. Chapter 3: Placing Braces and Spaces</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-3-1-spaces">4.3.2.4. Chapter 3.1:  Spaces</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-4-naming">4.3.2.5. Chapter 4: Naming</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-5-typedefs">4.3.2.6. Chapter 5: Typedefs</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-6-functions">4.3.2.7. Chapter 6: Functions</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-7-centralized-exiting-of-functions">4.3.2.8. Chapter 7: Centralized exiting of functions</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-8-commenting">4.3.2.9. Chapter 8: Commenting</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-9-you-ve-made-a-mess-of-it">4.3.2.10. Chapter 9: You&#8217;ve made a mess of it</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-10-kconfig-configuration-files">4.3.2.11. Chapter 10: Kconfig configuration files</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-11-data-structures">4.3.2.12. Chapter 11: Data structures</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-12-macros-enums-and-rtl">4.3.2.13. Chapter 12: Macros, Enums and RTL</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-13-printing-kernel-messages">4.3.2.14. Chapter 13: Printing kernel messages</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-14-allocating-memory">4.3.2.15. Chapter 14: Allocating memory</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-15-the-inline-disease">4.3.2.16. Chapter 15: The inline disease</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-16-function-return-values-and-names">4.3.2.17. Chapter 16: Function return values and names</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-17-don-t-re-invent-the-kernel-macros">4.3.2.18. Chapter 17:  Don&#8217;t re-invent the kernel macros</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#chapter-18-editor-modelines-and-other-cruft">4.3.2.19. Chapter 18:  Editor modelines and other cruft</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/c_style_guide.html#appendix-i-references">4.3.2.20. Appendix I: References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../dev_guide/python_style_guide.html">4.4. Python Style Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/python_style_guide.html#introduction">4.4.1. Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/python_style_guide.html#a-foolish-consistency-is-the-hobgoblin-of-little-minds">4.4.2. A Foolish Consistency is the Hobgoblin of Little Minds</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/python_style_guide.html#code-lay-out">4.4.3. Code lay-out</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/python_style_guide.html#indentation">4.4.3.1. Indentation</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/python_style_guide.html#tabs-or-spaces">4.4.3.2. Tabs or Spaces?</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/python_style_guide.html#maximum-line-length">4.4.3.3. Maximum Line Length</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/python_style_guide.html#blank-lines">4.4.3.4. Blank Lines</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/python_style_guide.html#encodings-pep-263">4.4.3.5. Encodings (PEP 263)</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/python_style_guide.html#imports">4.4.3.6. Imports</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/python_style_guide.html#whitespace-in-expressions-and-statements">4.4.4. Whitespace in Expressions and Statements</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/python_style_guide.html#pet-peeves">4.4.4.1. Pet Peeves</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/python_style_guide.html#other-recommendations">4.4.4.2. Other Recommendations</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/python_style_guide.html#comments">4.4.5. Comments</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/python_style_guide.html#block-comments">4.4.5.1. Block Comments</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/python_style_guide.html#inline-comments">4.4.5.2. Inline Comments</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/python_style_guide.html#documentation-strings">4.4.5.3. Documentation Strings</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/python_style_guide.html#version-bookkeeping">4.4.6. Version Bookkeeping</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/python_style_guide.html#naming-conventions">4.4.7. Naming Conventions</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/python_style_guide.html#descriptive-naming-styles">4.4.7.1. Descriptive: Naming Styles</a></li>
<li class="toctree-l5"><a class="reference internal" href="../dev_guide/python_style_guide.html#prescriptive-naming-conventions">4.4.7.2. Prescriptive: Naming Conventions</a><ul>
<li class="toctree-l6"><a class="reference internal" href="../dev_guide/python_style_guide.html#names-to-avoid">4.4.7.2.1. Names to Avoid</a></li>
<li class="toctree-l6"><a class="reference internal" href="../dev_guide/python_style_guide.html#package-and-module-names">4.4.7.2.2. Package and Module Names</a></li>
<li class="toctree-l6"><a class="reference internal" href="../dev_guide/python_style_guide.html#class-names">4.4.7.2.3. Class Names</a></li>
<li class="toctree-l6"><a class="reference internal" href="../dev_guide/python_style_guide.html#exception-names">4.4.7.2.4. Exception Names</a></li>
<li class="toctree-l6"><a class="reference internal" href="../dev_guide/python_style_guide.html#global-variable-names">4.4.7.2.5. Global Variable Names</a></li>
<li class="toctree-l6"><a class="reference internal" href="../dev_guide/python_style_guide.html#function-names">4.4.7.2.6. Function Names</a></li>
<li class="toctree-l6"><a class="reference internal" href="../dev_guide/python_style_guide.html#function-and-method-arguments">4.4.7.2.7. Function and method arguments</a></li>
<li class="toctree-l6"><a class="reference internal" href="../dev_guide/python_style_guide.html#method-names-and-instance-variables">4.4.7.2.8. Method Names and Instance Variables</a></li>
<li class="toctree-l6"><a class="reference internal" href="../dev_guide/python_style_guide.html#constants">4.4.7.2.9. Constants</a></li>
<li class="toctree-l6"><a class="reference internal" href="../dev_guide/python_style_guide.html#designing-for-inheritance">4.4.7.2.10. Designing for inheritance</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/python_style_guide.html#references">4.4.8. References</a></li>
<li class="toctree-l4"><a class="reference internal" href="../dev_guide/python_style_guide.html#copyright">4.4.9. Copyright</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
        <div class="b-cols_content_right">
          <div class="b-cols_content_right-slot">
  <div class="b-page_header">
    <ul class="b-path-list">
      <li class="b-path-list-item">
        <a href="../index.html"
           class="b-path-list-item-url">
          Documentation
        </a>
      </li>
      
        <li class="b-path-list-item">
          <a href="index.html"
             class="b-path-list-item-url b-ellipsis">
            Tutorials
          </a>
        </li>
      
      
      <li class="b-path-list-item">
        <div title="1. Lua tutorials" class="b-path_current b-ellipsis">
          1. Lua tutorials
        </div>
      </li>
      
    </ul>
  </div>

  <article class="b-article">
    
    <div class="section" id="lua-tutorials">
<span id="id1"></span><h1>1. Lua tutorials<a class="headerlink" href="#lua-tutorials" title="Permalink to this headline">¶</a></h1>
<p>Here are three tutorials on using Lua stored procedures with Tarantool:</p>
<ul class="simple">
<li><a class="reference internal" href="#c-lua-tutorial-insert-one-million-tuples"><span class="std std-ref">Insert one million tuples with a Lua stored procedure</span></a>,</li>
<li><a class="reference internal" href="#c-lua-tutorial-sum-a-json-field"><span class="std std-ref">Sum a JSON field for all tuples</span></a>,</li>
<li><a class="reference internal" href="#c-lua-tutorial-indexed-pattern-search"><span class="std std-ref">Indexed pattern search</span></a>.</li>
</ul>
<div class="section" id="insert-one-million-tuples-with-a-lua-stored-procedure">
<span id="c-lua-tutorial-insert-one-million-tuples"></span><h2>1.1. Insert one million tuples with a Lua stored procedure<a class="headerlink" href="#insert-one-million-tuples-with-a-lua-stored-procedure" title="Permalink to this headline">¶</a></h2>
<p>This is an exercise assignment: “Insert one million tuples. Each tuple should
have a constantly-increasing numeric primary-key field and a random alphabetic
10-character string field.”</p>
<p>The purpose of the exercise is to show what Lua functions look like inside
Tarantool. It will be necessary to employ the Lua math library, the Lua string
library, the Tarantool box library, the Tarantool box.tuple library, loops, and
concatenations. It should be easy to follow even for a person who has not used
either Lua or Tarantool before. The only requirement is a knowledge of how other
programming languages work and a memory of the first two chapters of this manual.
But for better understanding, follow the comments and the links, which point to
the Lua manual or to elsewhere in this Tarantool manual. To further enhance
learning, type the statements in with the tarantool client while reading along.</p>
<div class="section" id="configure">
<h3>1.1.1. Configure<a class="headerlink" href="#configure" title="Permalink to this headline">¶</a></h3>
<p>We are going to use the &#8220;tarantool_sandbox&#8221; that was created in section
<a class="reference internal" href="../book/user_guide_getting_started.html#user-guide-getting-started-first-database"><span class="std std-ref">first database</span></a>. So there is a single space, and a numeric primary key,
and a running tarantool server which also serves as a client.</p>
</div>
<div class="section" id="delimiter">
<h3>1.1.2. Delimiter<a class="headerlink" href="#delimiter" title="Permalink to this headline">¶</a></h3>
<p>In earlier versions of Tarantool, multi-line functions had to be
enclosed within &#8220;delimiters&#8221;. They are no longer necessary, and
so they will not be used in this tutorial. However, they are still
supported. Users who wish to use delimiters, or users of
older versions of Tarantool, should check the syntax description for
<a class="reference internal" href="../book/administration.html#administration-setting-delimiter"><span class="std std-ref">declaring a delimiter</span></a> before proceeding.</p>
</div>
<div class="section" id="create-a-function-that-returns-a-string">
<h3>1.1.3. Create a function that returns a string<a class="headerlink" href="#create-a-function-that-returns-a-string" title="Permalink to this headline">¶</a></h3>
<p>We will start by making a function that returns a fixed string, “Hello world”.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">string_function</span><span class="p">()</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="s">hello world&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The word &#8220;<code class="docutils literal"><span class="pre">function</span></code>&#8221; is a Lua keyword &#8211; we&#8217;re about to go into Lua. The
function name is string_function. The function has one executable statement,
<code class="docutils literal"><span class="pre">return</span> <span class="pre">&quot;hello</span> <span class="pre">world&quot;</span></code>. The string &#8220;hello world&#8221; is enclosed in double quotes
here, although Lua doesn&#8217;t care &#8211; one could use single quotes instead. The
word &#8220;<code class="docutils literal"><span class="pre">end</span></code>&#8221; means “this is the end of the Lua function declaration.”
To confirm that the function works, we can say</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">string_function</span><span class="p">()</span>
</pre></div>
</div>
<p>Sending <code class="docutils literal"><span class="pre">function-name()</span></code> means “invoke the Lua function.” The effect is
that the string which the function returns will end up on the screen.</p>
<p>For more about Lua strings see Lua manual <a class="reference external" href="http://www.lua.org/pil/2.4.html">chapter 2.4 &#8220;Strings&#8221;</a> . For more
about functions see Lua manual <a class="reference external" href="http://www.lua.org/pil/5.html">chapter 5 &#8220;Functions&#8221;</a>.</p>
<p>The screen now looks like this:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">string_funciton</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="s2">&quot;</span><span class="s">hello world&quot;</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">string_function</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hello world</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="create-a-function-that-calls-another-function-and-sets-a-variable">
<h3>1.1.4. Create a function that calls another function and sets a variable<a class="headerlink" href="#create-a-function-that-calls-another-function-and-sets-a-variable" title="Permalink to this headline">¶</a></h3>
<p>Now that <code class="docutils literal"><span class="pre">string_function</span></code> exists, we can invoke it from another
function.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">string_value</span>
  <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">string_value</span>
<span class="k">end</span>
</pre></div>
</div>
<p>We begin by declaring a variable &#8220;<code class="docutils literal"><span class="pre">string_value</span></code>&#8221;. The word &#8220;<code class="docutils literal"><span class="pre">local</span></code>&#8221;
means that string_value appears only in <code class="docutils literal"><span class="pre">main_function</span></code>. If we didn&#8217;t use
&#8220;<code class="docutils literal"><span class="pre">local</span></code>&#8221; then <code class="docutils literal"><span class="pre">string_value</span></code> would be visible everywhere - even by other
users using other clients connected to this server! Sometimes that&#8217;s a very
desirable feature for inter-client communication, but not this time.</p>
<p>Then we assign a value to <code class="docutils literal"><span class="pre">string_value</span></code>, namely, the result of
<code class="docutils literal"><span class="pre">string_function()</span></code>. Soon we will invoke <code class="docutils literal"><span class="pre">main_function()</span></code> to check that it
got the value.</p>
<p>For more about Lua variables see Lua manual <a class="reference external" href="http://www.lua.org/pil/4.2.html">chapter 4.2 &#8220;Local Variables and Blocks&#8221;</a> .</p>
<p>The screen now looks like this:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">string_value</span>
<span class="gp">         &gt; </span>  <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="n">string_value</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">main_function</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hello world</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="modify-the-function-so-it-returns-a-one-letter-random-string">
<h3>1.1.5. Modify the function so it returns a one-letter random string<a class="headerlink" href="#modify-the-function-so-it-returns-a-one-letter-random-string" title="Permalink to this headline">¶</a></h3>
<p>Now that it&#8217;s a bit clearer how to make a variable, we can change
<code class="docutils literal"><span class="pre">string_function()</span></code> so that, instead of returning a fixed literal
&#8220;Hello world&#8221;, it returns a random letter between &#8216;A&#8217; and &#8216;Z&#8217;.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">string_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">random_number</span>
  <span class="kd">local</span> <span class="n">random_string</span>
  <span class="n">random_number</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
  <span class="n">random_string</span> <span class="o">=</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">random_number</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">random_string</span>
<span class="k">end</span>
</pre></div>
</div>
<p>It is not necessary to destroy the old <code class="docutils literal"><span class="pre">string_function()</span></code> contents, they&#8217;re
simply overwritten. The first assignment invokes a random-number function
in Lua&#8217;s math library; the parameters mean “the number must be an integer
between 65 and 90.” The second assignment invokes an integer-to-character
function in Lua&#8217;s string library; the parameter is the code point of the
character. Luckily the ASCII value of &#8216;A&#8217; is 65 and the ASCII value of &#8216;Z&#8217;
is 90 so the result will always be a letter between A and Z.</p>
<p>For more about Lua math-library functions see Lua users &#8220;<a class="reference external" href="http://lua-users.org/wiki/MathLibraryTutorial">Math Library Tutorial</a>&#8221;.
For more about Lua string-library functions see Lua users &#8220;<a class="reference external" href="http://lua-users.org/wiki/StringLibraryTutorial">String Library Tutorial</a>&#8221; .</p>
<p>Once again the <code class="docutils literal"><span class="pre">string_function()</span></code> can be invoked from main_function() which
can be invoked with <code class="docutils literal"><span class="pre">main_function()</span></code>.</p>
<p>The screen now looks like this:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">string_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">random_number</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">random_string</span>
<span class="gp">         &gt; </span>  <span class="n">random_number</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="n">random_string</span> <span class="o">=</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">random_number</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="n">random_string</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">main_function</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">C</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
<p>... Well, actually it won&#8217;t always look like this because <code class="docutils literal"><span class="pre">math.random()</span></code>
produces random numbers. But for the illustration purposes it won&#8217;t matter
what the random string values are.</p>
</div>
<div class="section" id="modify-the-function-so-it-returns-a-ten-letter-random-string">
<h3>1.1.6. Modify the function so it returns a ten-letter random string<a class="headerlink" href="#modify-the-function-so-it-returns-a-ten-letter-random-string" title="Permalink to this headline">¶</a></h3>
<p>Now that it&#8217;s clear how to produce one-letter random strings, we can reach our
goal of producing a ten-letter string by concatenating ten one-letter strings,
in a loop.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">string_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">random_number</span>
  <span class="kd">local</span> <span class="n">random_string</span>
  <span class="n">random_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
  <span class="k">for</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
    <span class="n">random_number</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
    <span class="n">random_string</span> <span class="o">=</span> <span class="n">random_string</span> <span class="o">..</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">random_number</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="n">random_string</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The words &#8220;for x = 1,10,1&#8221; mean “start with x equals 1, loop until x equals 10,
increment x by 1 for each iteration.” The symbol &#8221;..&#8221; means &#8220;concatenate&#8221;, that
is, add the string on the right of the &#8221;..&#8221; sign to the string on the left of
the &#8221;..&#8221; sign. Since we start by saying that random_string is &#8220;&#8221; (a blank
string), the end result is that random_string has 10 random letters. Once
again the <code class="docutils literal"><span class="pre">string_function()</span></code> can be invoked from <code class="docutils literal"><span class="pre">main_function()</span></code> which
can be invoked with <code class="docutils literal"><span class="pre">main_function()</span></code>.</p>
<p>For more about Lua loops see Lua manual <a class="reference external" href="http://www.lua.org/pil/4.3.4.html">chapter 4.3.4 &#8220;Numeric for&#8221;</a>.</p>
<p>The screen now looks like this:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">string_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">random_number</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">random_string</span>
<span class="gp">         &gt; </span>  <span class="n">random_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
<span class="gp">         &gt; </span>  <span class="k">for</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
<span class="gp">         &gt; </span>    <span class="n">random_number</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
<span class="gp">         &gt; </span>    <span class="n">random_string</span> <span class="o">=</span> <span class="n">random_string</span> <span class="o">..</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">random_number</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="k">end</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="n">random_string</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">main_function</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;ZUDJBHKEFM&#39;</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="make-a-tuple-out-of-a-number-and-a-string">
<h3>1.1.7. Make a tuple out of a number and a string<a class="headerlink" href="#make-a-tuple-out-of-a-number-and-a-string" title="Permalink to this headline">¶</a></h3>
<p>Now that it&#8217;s clear how to make a 10-letter random string, it&#8217;s possible to
make a tuple that contains a number and a 10-letter random string, by invoking
a function in Tarantool&#8217;s library of Lua functions.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">string_value</span><span class="p">,</span> <span class="n">t</span>
  <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="n">string_value</span><span class="p">})</span>
  <span class="k">return</span> <span class="n">t</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Once this is done, t will be the value of a new tuple which has two fields.
The first field is numeric: 1. The second field is a random string. Once again
the <code class="docutils literal"><span class="pre">string_function()</span></code> can be invoked from <code class="docutils literal"><span class="pre">main_function()</span></code> which can be
invoked with  <code class="docutils literal"><span class="pre">main_function()</span></code>.</p>
<p>For more about Tarantool tuples see Tarantool manual section <a class="reference internal" href="../book/box/box_tuple.html#box-tuple"><span class="std std-ref">Submodule box.tuple</span></a>.</p>
<p>The screen now looks like this:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
<span class="gp">         &gt; </span><span class="kd">local</span> <span class="n">string_value</span><span class="p">,</span> <span class="n">t</span>
<span class="gp">         &gt; </span><span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
<span class="gp">         &gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="n">string_value</span><span class="p">})</span>
<span class="gp">         &gt; </span><span class="k">return</span> <span class="n">t</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">main_function</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;PNPZPCOOKA&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="modify-main-function-to-insert-a-tuple-into-the-database">
<h3>1.1.8. Modify main_function to insert a tuple into the database<a class="headerlink" href="#modify-main-function-to-insert-a-tuple-into-the-database" title="Permalink to this headline">¶</a></h3>
<p>Now that it&#8217;s clear how to make a tuple that contains a number and a 10-letter
random string, the only trick remaining is putting that tuple into tester.
Remember that tester is the first space that was defined in the sandbox, so
it&#8217;s like a database table.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">string_value</span><span class="p">,</span> <span class="n">t</span>
  <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span><span class="n">string_value</span><span class="p">})</span>
  <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The new line here is <code class="docutils literal"><span class="pre">box.space.tester:replace(t)</span></code>. The name contains
&#8216;tester&#8217; because the insertion is going to be to tester. The second parameter
is the tuple value. To be perfectly correct we could have said
<code class="docutils literal"><span class="pre">box.space.tester:insert(t)</span></code> here, rather than <code class="docutils literal"><span class="pre">box.space.tester:replace(t)</span></code>,
but &#8220;replace&#8221; means “insert even if there is already a tuple whose primary-key
value is a duplicate”, and that makes it easier to re-run the exercise even if
the sandbox database isn&#8217;t empty. Once this is done, tester will contain a tuple
with two fields. The first field will be 1. The second field will be a random
10-letter string. Once again the <code class="docutils literal"><span class="pre">string_function(</span></code>) can be invoked from
<code class="docutils literal"><span class="pre">main_function()</span></code> which can be invoked with <code class="docutils literal"><span class="pre">main_function()</span></code>. But
<code class="docutils literal"><span class="pre">main_function()</span></code> won&#8217;t tell the whole story, because it does not return t, it
only puts t into the database. To confirm that something got inserted, we&#8217;ll use
a SELECT request.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">main_function</span><span class="p">()</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
<p>For more about Tarantool insert and replace calls, see Tarantool manual section
<a class="reference internal" href="../book/box/box_space.html#box-space"><span class="std std-ref">Submodule box.space</span></a>.</p>
<p>The screen now looks like this:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">string_value</span><span class="p">,</span> <span class="n">t</span>
<span class="gp">         &gt; </span>  <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span><span class="n">string_value</span><span class="p">})</span>
<span class="gp">         &gt; </span>  <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">main_function</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;EUJYVEECIL&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="modify-main-function-to-insert-a-million-tuples-into-the-database">
<h3>1.1.9. Modify main_function to insert a million tuples into the database<a class="headerlink" href="#modify-main-function-to-insert-a-million-tuples-into-the-database" title="Permalink to this headline">¶</a></h3>
<p>Now that it&#8217;s clear how to insert one tuple into the database, it&#8217;s no big deal
to figure out how to scale up: instead of inserting with a literal value = 1
for the primary key, insert with a variable value = between 1 and 1 million, in
a loop. Since we already saw how to loop, that&#8217;s a simple thing. The only extra
wrinkle that we add here is a timing function.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">string_value</span><span class="p">,</span> <span class="n">t</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1000000</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
    <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="n">i</span><span class="p">,</span><span class="n">string_value</span><span class="p">})</span>
    <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="nb">os.clock</span><span class="p">()</span>
<span class="n">main_function</span><span class="p">()</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="nb">os.clock</span><span class="p">()</span>
<span class="s1">&#39;</span><span class="s">insert done in &#39;</span> <span class="o">..</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> seconds&#39;</span>
</pre></div>
</div>
<p>The standard Lua function
<cite>os.clock() &lt;http://www.lua.org/manual/5.1/manual.html#pdf-os.clock&gt;</cite>
will return the number of CPU seconds since the
start. Therefore, by getting start_time = number of seconds just before the
inserting, and then getting end_time = number of seconds just after the
inserting, we can calculate (end_time - start_time) = elapsed time in seconds.
We will display that value by putting it in a request without any assignments,
which causes Tarantool to send the value to the client, which prints it. (Lua&#8217;s
answer to the C <code class="docutils literal"><span class="pre">printf()</span></code> function, which is <code class="docutils literal"><span class="pre">print()</span></code>, will also work.)</p>
<p>For more on Lua <code class="docutils literal"><span class="pre">os.clock()</span></code> see Lua manual <a class="reference external" href="http://www.lua.org/pil/22.1.html">chapter 22.1 &#8220;Date and Time&#8221;</a>.
For more on Lua print() see Lua manual <a class="reference external" href="http://www.lua.org/pil/5.html">chapter 5 &#8220;Functions&#8221;</a>.</p>
<p>Since this is the grand finale, we will redo the final versions of all the
necessary requests: the request that
created <code class="docutils literal"><span class="pre">string_function()</span></code>, the request that created <code class="docutils literal"><span class="pre">main_function()</span></code>,
and the request that invokes <code class="docutils literal"><span class="pre">main_function()</span></code>.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">string_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">random_number</span>
  <span class="kd">local</span> <span class="n">random_string</span>
  <span class="n">random_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
  <span class="k">for</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
    <span class="n">random_number</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
    <span class="n">random_string</span> <span class="o">=</span> <span class="n">random_string</span> <span class="o">..</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">random_number</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="n">random_string</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">string_value</span><span class="p">,</span> <span class="n">t</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1000000</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
    <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="n">i</span><span class="p">,</span><span class="n">string_value</span><span class="p">})</span>
    <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="nb">os.clock</span><span class="p">()</span>
<span class="n">main_function</span><span class="p">()</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="nb">os.clock</span><span class="p">()</span>
<span class="s1">&#39;</span><span class="s">insert done in &#39;</span> <span class="o">..</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> seconds&#39;</span>
</pre></div>
</div>
<p>The screen now looks like this:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">string_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">random_number</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">random_string</span>
<span class="gp">         &gt; </span>  <span class="n">random_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
<span class="gp">         &gt; </span>  <span class="k">for</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
<span class="gp">         &gt; </span>    <span class="n">random_number</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
<span class="gp">         &gt; </span>    <span class="n">random_string</span> <span class="o">=</span> <span class="n">random_string</span> <span class="o">..</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">random_number</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="k">end</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="n">random_string</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">string_value</span><span class="p">,</span> <span class="n">t</span>
<span class="gp">         &gt; </span>  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1000000</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
<span class="gp">         &gt; </span>    <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>    <span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="n">i</span><span class="p">,</span><span class="n">string_value</span><span class="p">})</span>
<span class="gp">         &gt; </span>    <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="k">end</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">start_time</span> <span class="o">=</span> <span class="nb">os.clock</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">main_function</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">end_time</span> <span class="o">=</span> <span class="nb">os.clock</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="s1">&#39;</span><span class="s">insert done in &#39;</span> <span class="o">..</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> seconds&#39;</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">insert done in 37.62 seconds</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
<p>What has been shown is that Lua functions are quite expressive (in fact one can
do more with Tarantool&#8217;s Lua stored procedures than one can do with stored
procedures in some SQL DBMSs), and that it&#8217;s straightforward to combine
Lua-library functions and Tarantool-library functions.</p>
<p>What has also been shown is that inserting a million tuples took 37 seconds. The
host computer was a Linux laptop. By changing <a class="reference internal" href="../reference/configuration/index.html#cfg-binary-logging-snapshots-wal-mode"><span class="std std-ref">wal_mode</span></a> to &#8216;none&#8217; before
running the test, one can reduce the elapsed time to 4 seconds.</p>
</div>
</div>
<div class="section" id="sum-a-json-field-for-all-tuples">
<span id="c-lua-tutorial-sum-a-json-field"></span><h2>1.2. Sum a JSON field for all tuples<a class="headerlink" href="#sum-a-json-field-for-all-tuples" title="Permalink to this headline">¶</a></h2>
<p>This is an exercise assignment: “Assume that inside every tuple there is a
string formatted as JSON. Inside that string there is a JSON numeric field.
For each tuple, find the numeric field&#8217;s value and add it to a &#8216;sum&#8217; variable.
At end, return the &#8216;sum&#8217; variable.” The purpose of the exercise is to get
experience in one way to read and process tuples.</p>
<div class="highlight-lua"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">json</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">json&#39;</span><span class="p">)</span>
<span class="k">function</span> <span class="nf">sum_json_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sum</span><span class="p">,</span> <span class="n">field_value</span><span class="p">,</span> <span class="n">is_valid_json</span><span class="p">,</span> <span class="n">lua_table</span>
  <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span> <span class="k">in</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">pairs</span><span class="p">()</span> <span class="k">do</span>
    <span class="n">is_valid_json</span><span class="p">,</span> <span class="n">lua_table</span> <span class="o">=</span> <span class="nb">pcall</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">decode</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">is_valid_json</span> <span class="k">then</span>
      <span class="n">field_value</span> <span class="o">=</span> <span class="n">lua_table</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">field_value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">number&quot;</span> <span class="k">then</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">+</span> <span class="n">field_value</span> <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="n">sum</span>
<span class="k">end</span>
</pre></div>
</td></tr></table></div>
<p><strong>LINE 3: WHY &#8220;LOCAL&#8221;.</strong> This line declares all the variables that will be used in
the function. Actually it&#8217;s not necessary to declare all variables at the start,
and in a long function it would be better to declare variables just before using
them. In fact it&#8217;s not even necessary to declare variables at all, but an
undeclared variable is &#8220;global&#8221;. That&#8217;s not desirable for any of the variables
that are declared in line 1, because all of them are for use only within the function.</p>
<p><strong>LINE 5: WHY &#8220;PAIRS()&#8221;.</strong> Our job is to go through all the rows and there are two
ways to do it: with <a class="reference internal" href="../book/box/box_space.html#box-space-pairs"><span class="std std-ref">box.space.space_object:pairs()</span></a> or with
<code class="docutils literal"><span class="pre">variable</span> <span class="pre">=</span> <span class="pre">select(...)</span></code> followed by <code class="samp docutils literal"><span class="pre">for</span> <span class="pre">i,</span> <em><span class="pre">n</span></em><span class="pre">,</span> <span class="pre">1</span> <span class="pre">do</span> <em><span class="pre">some-function</span></em><span class="pre">(variable[i])</span> <span class="pre">end</span></code>.
We preferred <code class="docutils literal"><span class="pre">pairs()</span></code> for this example.</p>
<p><strong>LINE 5: START THE MAIN LOOP.</strong> Everything inside this &#8220;<code class="docutils literal"><span class="pre">for</span></code>&#8221; loop will be
repeated as long as there is another index key. A tuple is fetched and can be
referenced with variable <code class="code docutils literal"><span class="pre">t</span></code>.</p>
<p><strong>LINE 6: WHY &#8220;PCALL&#8221;.</strong> If we simply said <code class="docutils literal"><span class="pre">lua_table</span> <span class="pre">=</span> <span class="pre">json.decode(t[2]))</span></code>, then
the function would abort with an error if it encountered something wrong with the
JSON string - a missing colon, for example. By putting the function inside &#8220;<code class="docutils literal"><span class="pre">pcall</span></code>&#8221;
(<a class="reference external" href="http://www.lua.org/pil/8.4.html">protected call</a>), we&#8217;re saying: we want to intercept that sort of error, so if
there&#8217;s a problem just set <code class="docutils literal"><span class="pre">is_valid_json</span> <span class="pre">=</span> <span class="pre">false</span></code> and we will know what to do
about it later.</p>
<p><strong>LINE 6: MEANING.</strong> The function is <a class="reference internal" href="../reference/reference_lua/json.html#json-decode"><span class="std std-ref">json.decode</span></a> which means decode a JSON
string, and the parameter is t[2] which is a reference to a JSON string. There&#8217;s
a bit of hard coding here, we&#8217;re assuming that the second field in the tuple is
where the JSON string was inserted. For example, we&#8217;re assuming a tuple looks like</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">444</span>
<span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="s1">&#39;{&quot;Hello&quot;: &quot;world&quot;, &quot;Quantity&quot;: 15}&#39;</span>
</pre></div>
</div>
<p>meaning that the tuple&#8217;s first field, the primary key field, is a number while
the tuple&#8217;s second field, the JSON string, is a string. Thus the entire statement
means &#8220;decode <code class="docutils literal"><span class="pre">t[2]</span></code> (the tuple&#8217;s second field) as a JSON string; if there&#8217;s an
error set <code class="docutils literal"><span class="pre">is_valid_json</span> <span class="pre">=</span> <span class="pre">false</span></code>; if there&#8217;s no error set <code class="docutils literal"><span class="pre">is_valid_json</span> <span class="pre">=</span> <span class="pre">true</span></code> and
set <code class="docutils literal"><span class="pre">lua_table</span> <span class="pre">=</span></code> a Lua table which has the decoded string&#8221;.</p>
<p><strong>LINE 8.</strong> At last we are ready to get the JSON field value from the Lua table that
came from the JSON string. The value in field_name, which is the parameter for the
whole function, must be a name of a JSON field. For example, inside the JSON string
<code class="docutils literal"><span class="pre">'{&quot;Hello&quot;:</span> <span class="pre">&quot;world&quot;,</span> <span class="pre">&quot;Quantity&quot;:</span> <span class="pre">15}'</span></code>, there are two JSON fields: &#8220;Hello&#8221; and
&#8220;Quantity&#8221;. If the whole function is invoked with <code class="docutils literal"><span class="pre">sum_json_field(&quot;Quantity&quot;)</span></code>,
then <code class="docutils literal"><span class="pre">field_value</span> <span class="pre">=</span> <span class="pre">lua_table[field_name]</span></code> is effectively the same as
<code class="docutils literal"><span class="pre">field_value</span> <span class="pre">=</span> <span class="pre">lua_table[&quot;Quantity&quot;]</span></code> or even <code class="docutils literal"><span class="pre">field_value</span> <span class="pre">=</span> <span class="pre">lua_table.Quantity</span></code>.
Those are just three different ways of saying: for the Quantity field in the Lua table,
get the value and put it in variable <code class="code docutils literal"><span class="pre">field_value</span></code>.</p>
<p><strong>LINE 9: WHY &#8220;IF&#8221;.</strong> Suppose that the JSON string is well formed but the JSON field
is not a number, or is missing. In that case, the function would be aborted when
there was an attempt to add it to the sum. By first checking
<code class="docutils literal"><span class="pre">type(field_value)</span> <span class="pre">==</span> <span class="pre">&quot;number&quot;</span></code>, we avoid that abortion. Anyone who knows that
the database is in perfect shape can skip this kind of thing.</p>
<p>And the function is complete. Time to test it. Starting with an empty database,
defined the same way as the sandbox database that was introduced in
<a class="reference internal" href="../book/user_guide_getting_started.html#user-guide-getting-started-first-database"><span class="std std-ref">first database</span></a>,</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- if tester is left over from some previous test, destroy it</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">drop</span><span class="p">()</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
</pre></div>
</div>
<p>then add some tuples where the first field is a number and the second
field is a string.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">444</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">{&quot;Item&quot;: &quot;widget&quot;, &quot;Quantity&quot;: 15}&#39;</span><span class="p">}</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">445</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">{&quot;Item&quot;: &quot;widget&quot;, &quot;Quantity&quot;: 7}&#39;</span><span class="p">}</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">446</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">{&quot;Item&quot;: &quot;golf club&quot;, &quot;Quantity&quot;: &quot;sunshine&quot;}&#39;</span><span class="p">}</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">447</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">{&quot;Item&quot;: &quot;waffle iron&quot;, &quot;Quantit&quot;: 3}&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>Since this is a test, there are deliberate errors. The &#8220;golf club&#8221; and the
&#8220;waffle iron&#8221; do not have numeric Quantity fields, so must be ignored.
Therefore the real sum of the Quantity field in the JSON strings should be:
15 + 7 = 22.</p>
<p>Invoke the function with <code class="docutils literal"><span class="pre">sum_json_field(&quot;Quantity&quot;)</span></code>.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">sum_json_field</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Quantity&quot;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">22</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>It works. We&#8217;ll just leave, as exercises for future improvement, the possibility
that the &#8220;hard coding&#8221; assumptions could be removed, that there might have to be
an overflow check if some field values are huge, and that the function should
contain a &#8220;yield&#8221; instruction if the count of tuples is huge.</p>
</div>
<div class="section" id="indexed-pattern-search">
<span id="c-lua-tutorial-indexed-pattern-search"></span><h2>1.3. Indexed pattern search<a class="headerlink" href="#indexed-pattern-search" title="Permalink to this headline">¶</a></h2>
<p>Here is a generic function which takes a field identifier
and a search pattern, and returns all tuples that match. <br />
* The field must be the first field of a TREE index. <br />
* The function will use <a class="reference external" href="http://www.lua.org/manual/5.2/manual.html#6.4.1">Lua pattern matching</a>,
which allows &#8220;magic characters&#8221; in regular expressions. <br />
* The initial characters in the pattern, as far as the
first magic character, will be used as an index search key.
For each tuple that is found via the index, there will be
a match of the whole pattern. <br />
* To be <a class="reference internal" href="../book/box/index.html#atomic-cooperative-multitasking"><span class="std std-ref">cooperative</span></a>,
the function should yield after every
10 tuples, unless there is a reason to delay yielding. <br />
With this function, we can take advantage of Tarantool&#8217;s indexes
for speed, and take advantage of Lua&#8217;s pattern matching for flexibility.
It does everything that an SQL &#8220;LIKE&#8221; search can do, and far more.</p>
<p>Read the following Lua code to see how it works.
The comments that begin with &#8220;SEE NOTE ...&#8221; refer to long
explanations that follow the code.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">indexed_pattern_search</span><span class="p">(</span><span class="n">space_name</span><span class="p">,</span> <span class="n">field_no</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
  <span class="c1">-- SEE NOTE #1 &quot;FIND AN APPROPRIATE INDEX&quot;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Error: Failed to find the specified space&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
  <span class="k">end</span>
  <span class="kd">local</span> <span class="n">index_no</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">INDEX_MAX</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">].</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span> <span class="k">break</span> <span class="k">end</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">].</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">TREE&quot;</span>
        <span class="ow">and</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">].</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fieldno</span> <span class="o">==</span> <span class="n">field_no</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">].</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">scalar&quot;</span>
        <span class="ow">or</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">].</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">string&quot;</span><span class="p">))</span> <span class="k">then</span>
      <span class="n">index_no</span> <span class="o">=</span> <span class="n">i</span>
      <span class="k">break</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">index_no</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Error: Failed to find an appropriate index&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
  <span class="k">end</span>
  <span class="c1">-- SEE NOTE #2 &quot;DERIVE INDEX SEARCH KEY FROM PATTERN&quot;</span>
  <span class="kd">local</span> <span class="n">index_search_key</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
  <span class="kd">local</span> <span class="n">index_search_key_length</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">local</span> <span class="n">last_character</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
  <span class="kd">local</span> <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
  <span class="kd">local</span> <span class="n">c2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nb">string.len</span><span class="p">(</span><span class="n">pattern</span><span class="p">),</span><span class="mi">1</span> <span class="k">do</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">string.sub</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">last_character</span> <span class="o">~=</span> <span class="s2">&quot;</span><span class="s">%&quot;</span><span class="p">)</span> <span class="k">then</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="s">^&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">$&quot;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">(&quot;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">)&quot;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">.&quot;</span>
                   <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">[&quot;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">]&quot;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">*&quot;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">+&quot;</span>
                   <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">-&quot;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">?&quot;</span><span class="p">)</span> <span class="k">then</span>
        <span class="k">break</span>
      <span class="k">end</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">%&quot;</span><span class="p">)</span> <span class="k">then</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="nb">string.sub</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">string.match</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">%p&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span> <span class="k">break</span> <span class="k">end</span>
        <span class="n">index_search_key</span> <span class="o">=</span> <span class="n">index_search_key</span> <span class="o">..</span> <span class="n">c2</span>
      <span class="k">else</span>
        <span class="n">index_search_key</span> <span class="o">=</span> <span class="n">index_search_key</span> <span class="o">..</span> <span class="n">c</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">last_character</span> <span class="o">=</span> <span class="n">c</span>
  <span class="k">end</span>
  <span class="n">index_search_key_length</span> <span class="o">=</span> <span class="nb">string.len</span><span class="p">(</span><span class="n">index_search_key</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">index_search_key_length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Error: index search key &quot;</span> <span class="o">..</span> <span class="n">index_search_key</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="s"> is too short&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
  <span class="k">end</span>
  <span class="c1">-- SEE NOTE #3 &quot;OUTER LOOP: INITIATE&quot;</span>
  <span class="kd">local</span> <span class="n">result_set</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="kd">local</span> <span class="n">number_of_tuples_in_result_set</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">local</span> <span class="n">previous_tuple_field</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
  <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
    <span class="kd">local</span> <span class="n">number_of_tuples_since_last_yield</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">local</span> <span class="n">is_time_for_a_yield</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="c1">-- SEE NOTE #4 &quot;INNER LOOP: ITERATOR&quot;</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">tuple</span> <span class="k">in</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">].</span><span class="n">index</span><span class="p">[</span><span class="n">index_no</span><span class="p">]:</span>
    <span class="nb">pairs</span><span class="p">(</span><span class="n">index_search_key</span><span class="p">,{</span><span class="n">iterator</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">GE</span><span class="p">})</span> <span class="k">do</span>
      <span class="c1">-- SEE NOTE #5 &quot;INNER LOOP: BREAK IF INDEX KEY IS TOO GREAT&quot;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">string.sub</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="n">field_no</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">index_search_key_length</span><span class="p">)</span>
      <span class="o">&gt;</span> <span class="n">index_search_key</span><span class="p">)</span> <span class="k">then</span>
        <span class="k">break</span>
      <span class="k">end</span>
      <span class="c1">-- SEE NOTE #6 &quot;INNER LOOP: BREAK AFTER EVERY 10 TUPLES -- MAYBE&quot;</span>
      <span class="n">number_of_tuples_since_last_yield</span> <span class="o">=</span> <span class="n">number_of_tuples_since_last_yield</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">number_of_tuples_since_last_yield</span> <span class="o">&gt;=</span> <span class="mi">10</span>
          <span class="ow">and</span> <span class="n">tuple</span><span class="p">[</span><span class="n">field_no</span><span class="p">]</span> <span class="o">~=</span> <span class="n">previous_tuple_field</span><span class="p">)</span> <span class="k">then</span>
        <span class="n">index_search_key</span> <span class="o">=</span> <span class="n">tuple</span><span class="p">[</span><span class="n">field_no</span><span class="p">]</span>
        <span class="n">is_time_for_a_yield</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="k">break</span>
        <span class="k">end</span>
      <span class="n">previous_tuple_field</span> <span class="o">=</span> <span class="n">tuple</span><span class="p">[</span><span class="n">field_no</span><span class="p">]</span>
      <span class="c1">-- SEE NOTE #7 &quot;INNER LOOP: ADD TO RESULT SET IF PATTERN MATCHES&quot;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">string.match</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="n">field_no</span><span class="p">],</span> <span class="n">pattern</span><span class="p">)</span> <span class="o">~=</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span>
        <span class="n">number_of_tuples_in_result_set</span> <span class="o">=</span> <span class="n">number_of_tuples_in_result_set</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">result_set</span><span class="p">[</span><span class="n">number_of_tuples_in_result_set</span><span class="p">]</span> <span class="o">=</span> <span class="n">tuple</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="c1">-- SEE NOTE #8 &quot;OUTER LOOP: BREAK, OR YIELD AND CONTINUE&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_time_for_a_yield</span> <span class="o">~=</span> <span class="kc">true</span><span class="p">)</span> <span class="k">then</span>
      <span class="k">break</span>
    <span class="k">end</span>
    <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fiber&#39;</span><span class="p">).</span><span class="n">yield</span><span class="p">()</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="n">result_set</span>
<span class="k">end</span>
</pre></div>
</div>
<p>NOTE #1 &#8220;FIND AN APPROPRIATE INDEX&#8221; <br />
The caller has passed space_name (a string) and field_no (a number).
The requirements are: <br />
(a) index type must be &#8220;TREE&#8221; because for other index types
(HASH, BITSET, RTREE) a search with iterator=GE
will not return strings in order by string value; <br />
(b) field_no must be the first index part; <br />
(c) the field must contain strings, because for other data types
(such as &#8220;unsigned&#8221;) pattern searches are not possible; <br />
If these requirements are not met by any index, then
print an error message and return nil.</p>
<p>NOTE #2 &#8220;DERIVE INDEX SEARCH KEY FROM PATTERN&#8221; <br />
The caller has passed pattern (a string).
The index search key will be
the characters in the pattern as far as the first magic character.
Lua&#8217;s magic characters are % ^ $ ( ) . [ ] * + - ?.
For example, if the pattern is &#8220;ABC.E&#8221;, the period is a magic
character and therefore the index search key will be &#8220;ABC&#8221;.
But there is a complication ... If we see &#8220;%&#8221; followed by a punctuation
character, that punctuation character is &#8220;escaped&#8221; so
remove the &#8220;%&#8221; when making the index search key. For example, if the
pattern is &#8220;AB%$E&#8221;, the dollar sign is escaped and therefore
the index search key will be &#8220;AB$E&#8221;.
Finally there is a check that the index search key length
must be at least three &#8211; this is an arbitrary number, and in
fact zero would be okay, but short index search keys will cause
long search times.</p>
<p>NOTE #3 &#8211; &#8220;OUTER LOOP: INITIATE&#8221; <br />
The function&#8217;s job is to return a result set,
just as box.space.select would. We will fill
it within an outer loop that contains an inner
loop. The outer loop&#8217;s job is to execute the inner
loop, and possibly yield, until the search ends.
The inner loop&#8217;s job is to find tuples via the index, and put
them in the result set if they match the pattern.</p>
<p>NOTE #4 &#8220;INNER LOOP: ITERATOR&#8221; <br />
The for loop here is using pairs(), see the
<a class="reference internal" href="../reference/reference_lua/xlog.html#box-index-index-pairs"><span class="std std-ref">explanation of what index iterators are</span></a>.
Within the inner loop,
there will be a local variable named &#8220;tuple&#8221; which contains
the latest tuple found via the index search key.</p>
<p>NOTE #5 &#8220;INNER LOOP: BREAK IF INDEX KEY IS TOO GREAT&#8221; <br />
The iterator is GE (Greater or Equal), and we must be
more specific: if the search index key has N characters,
then the leftmost N characters of the result&#8217;s index field
must not be greater than the search index key. For example,
if the search index key is &#8216;ABC&#8217;, then &#8216;ABCDE&#8217; is
a potential match, but &#8216;ABD&#8217; is a signal that
no more matches are possible.</p>
<p>NOTE #6 &#8220;INNER LOOP: BREAK AFTER EVERY 10 TUPLES &#8211; MAYBE&#8221; <br />
This chunk of code is for cooperative multitasking.
The number 10 is arbitrary, and usually a larger number would be okay.
The simple rule would be &#8220;after checking 10 tuples, yield,
and then resume the search (that is, do the inner loop again)
starting after the last value that was found&#8221;. However, if
the index is non-unique or if there is more than one field
in the index, then we might have duplicates &#8211; for example
{&#8220;ABC&#8221;,1}, {&#8220;ABC&#8221;, 2}, {&#8220;ABC&#8221;, 3}&#8221; &#8211; and it would be difficult
to decide which &#8220;ABC&#8221; tuple to resume with. Therefore, if
the result&#8217;s index field is the same as the previous
result&#8217;s index field, there is no break.</p>
<p>NOTE #7 &#8220;INNER LOOP: ADD TO RESULT SET IF PATTERN MATCHES&#8221; <br />
Compare the result&#8217;s index field to the entire pattern.
For example, suppose that the caller passed pattern &#8220;ABC.E&#8221;
and there is an indexed field containing &#8220;ABCDE&#8221;.
Therefore the initial index search key is &#8220;ABC&#8221;.
Therefore a tuple containing an indexed field with &#8220;ABCDE&#8221;
will be found by the iterator, because &#8220;ABCDE&#8221; &gt; &#8220;ABC&#8221;.
In that case string.match will return a value which is not nil.
Therefore this tuple can be added to the result set.</p>
<p>NOTE #8 &#8220;OUTER LOOP: BREAK, OR YIELD AND CONTINUE&#8221; <br />
There are three conditions which will cause a break from
the inner loop: (1) the for loop ends naturally because
there are no more index keys which are greater than or
equal to the index search key, (2) the index key is too
great as described in NOTE #5, (3) it is time for a yield
as described in NOTE #6. If condition (1) or condition (2)
is true, then there is nothing more to do, the outer loop
ends too. If and only if condition (3) is true, the
outer loop must yield and then continue. If it does
continue, then the inner loop &#8211; the iterator search &#8211;
will happen again with a new value for the index search key.</p>
<p>EXAMPLE:</p>
<p>Start Tarantool, cut and paste the code for function <code class="docutils literal"><span class="pre">indexed_pattern_search</span></code>,
and try the following:</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="n">box</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">t</span><span class="p">:</span><span class="n">drop</span><span class="p">()</span>
<span class="n">box</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">t</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;primary&#39;</span><span class="p">,{})</span>
<span class="n">box</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">t</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;secondary&#39;</span><span class="p">,{</span><span class="n">unique</span><span class="o">=</span><span class="n">false</span><span class="p">,</span><span class="n">parts</span><span class="o">=</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;string&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;string&#39;</span><span class="p">}})</span>
<span class="n">box</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">t</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">}</span>
<span class="n">box</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">t</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;AB&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">}</span>
<span class="n">box</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">t</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;ABC&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">}</span>
<span class="n">box</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">t</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;ABCD&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">}</span>
<span class="n">box</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">t</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;ABCDE&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">}</span>
<span class="n">box</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">t</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">6</span><span class="p">,</span><span class="s1">&#39;ABCDE&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">}</span>
<span class="n">box</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">t</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;ABCDEF&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">}</span>
<span class="n">box</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">t</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;ABCDF&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">}</span>
<span class="n">indexed_pattern_search</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;ABC.E.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The result will be:</p>
<pre class="highlight literal-block">
tarantool&gt; <strong>indexed_pattern_search(&quot;t&quot;, 2, &quot;ABC.E.&quot;)</strong>
---
- - [7, 'ABCDEF', 'a']
...
</pre>
</div>
</div>

  </article>

            
            
            
  
    
      <div class="b-page_over-tail">
    
    
      <div class="b-page_over-prev">
        <a href="index.html"
           class="b-prev b-ellipsis"
           title="Tutorials">Tutorials</a>
      </div>
    
    <div class="b-page_over-lang">
      <ul class="b-page_over-lang-list">
        <li class="b-page_over-lang-item">
          <a href="../../_sources/doc/tutorials/lua_tutorials.txt"
             class="b-page_over-lang-url"> Source </a>
        </li>
      </ul>
    </div>
    
      <div class="b-page_over-next">
        <a href="c_tutorial.html"
           class="b-next b-ellipsis"
           title="2. C tutorial">2. C tutorial</a>
      </div>
    
    </div>
  
</div>
        </div>
      </div>
    
  

      </div>
    </div>
    <!-- FOOTER > -->
    
<footer class="b-footer">
  <div class="b-footer-wrapper">
    <nav class="b-footer_menu">
      
  <ul class="b-menu">
    
      
      <li class="b-menu-item">
      
        <a href="../../index.html" class="b-menu-item-url">Overview</a>
      </li>
    
      
      <li class="b-menu-item">
      
        <a href="../../try.html" class="b-menu-item-url">Try</a>
      </li>
    
      
      <li class="b-menu-item p-active">
      
        <a href="../../doc.html" class="b-menu-item-url">Documentation</a>
      </li>
    
      
      <li class="b-menu-item">
      
        <a href="../../download.html" class="b-menu-item-url">Download</a>
      </li>
    
      
      <li class="b-menu-item">
      
        <a href="../../careers.html" class="b-menu-item-url">Careers</a>
      </li>
    
      
      <li class="b-menu-item">
      
        <a href="../../rocks.html" class="b-menu-item-url">Rocks</a>
      </li>
    
  </ul>

      <div class="b-footer-other">
        <a href="http://15.tarantool.org">1.5 web site and downloads</a>
      </div>
    </nav>
  </div>
</footer>

    <!-- < FOOTER -->
    <div id="mobile-checker"></div>
  </body>
</html>

