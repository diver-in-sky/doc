





<!doctype html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Документация Tarantool 1.7.1</title>
    <link rel="icon" type="image/png" sizes="192x192"
          href="/theme/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32"
          href="/theme/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96"
          href="/theme/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16"
          href="/theme/favicon/favicon-16x16.png">
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:       '',
        VERSION:        '1.7.1',
        COLLAPSE_INDEX:  false,
        FILE_SUFFIX:    '.html',
        HAS_SOURCE:      true
      };
      
      
      var disqus_config = function () {
          // Replace PAGE_URL with your page's canonical URL variable
          // this.page.url = PAGE_URL;
          this.page.identifier = "singlehtml";
          this.language = "ru"
      };
    </script>
    <script id="dsq-count-scr" src="https://tarantooldb.disqus.com/count.js" async/></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <script type="text/javascript" src="_static/jquery.pin.min.js"></script>
    <script type="text/javascript" src="_static/headers.js"></script>
    <script type="text/javascript" src="_static/jquery-ui.js"></script>
    <script type="text/javascript" src="/js/menu.js"></script>
    <script type="text/javascript" src="/js/mobile_menu.js"></script>
    <link rel="stylesheet" href="/theme/font-awesome.min.css">
    <link rel="stylesheet" href="/theme/design.css">
    <link rel="stylesheet" href="/theme/pygmentize.css">
    <link rel="stylesheet" href="_static/sphinx_design.css">
    <link rel="stylesheet" href="_static/jquery-ui.css">
     
    <!--[if lt IE 9]>
      <script src="/js/ie8.js"></script>
      <link rel="stylesheet" href="/theme/ie8.css" />
    <![endif]-->
    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-22120502-1', 'auto');
  ga('send', 'pageview');
</script>

<!-- Rating@Mail.ru counter -->
<script type="text/javascript">
  var _tmr = _tmr || [];
  _tmr.push({id: "2284916", type: "pageView", start: (new Date()).getTime()});
  (function (d, w) {
    var ts = d.createElement("script"); ts.type = "text/javascript"; ts.async = true;
    ts.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//top-fwz1.mail.ru/js/code.js";
    var f = function () {var s = d.getElementsByTagName("script")[0]; s.parentNode.insertBefore(ts, s);};
    if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); }
  })(document, window);
</script>
<noscript>
  <div style="position:absolute;left:-10000px;">
    <img src="//top-fwz1.mail.ru/counter?id=2284916;js=na" style="border:0;"
         height="1" width="1" alt="Рейтинг@Mail.ru" />
  </div>
</noscript>
<!-- //Rating@Mail.ru counter -->


  </head>
  
  <body class="p-cols_design b-doc-singlehtml">
  
    <div class="b-wrapper">
      <!-- HEADER > -->
      
  <header class="b-header">
    <div class="b-header_menu_mobile">
      <div class="b-burger-button">
        <span></span>
      </div>
      <form role="search" class="b-header-search" action="search.html" method="get">
        <input name="q" type="search">
      </form>
    </div>
    <div class="b-menu_mobile">
      <div class="b-menu_mobile__wrapper">
        <nav class="b-header_menu">
          
  <ul class="b-menu">
    
      <li class="b-menu-item">
        <a href="/" class="b-menu-item-url">Overview</a>
      </li>
    
      <li class="b-menu-item">
        <a href="http://try.tarantool.org" class="b-menu-item-url">Try</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/doc/" class="b-menu-item-url">Documentation</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/download.html" class="b-menu-item-url">Download</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/careers.html" class="b-menu-item-url">Careers</a>
      </li>
    
      <li class="b-menu-item">
        <a href="http://rocks.tarantool.org" class="b-menu-item-url">Rocks</a>
      </li>
    
  </ul>

        </nav>
      </div>
      <div class="b-menu__close">
        <!-- empty -->
      </div>
    </div>
    <div class="b-header-wrapper">
      <nav class="b-header_menu">
        
  <ul class="b-menu">
    
      <li class="b-menu-item">
        <a href="/" class="b-menu-item-url">Overview</a>
      </li>
    
      <li class="b-menu-item">
        <a href="http://try.tarantool.org" class="b-menu-item-url">Try</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/doc/" class="b-menu-item-url">Documentation</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/download.html" class="b-menu-item-url">Download</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/careers.html" class="b-menu-item-url">Careers</a>
      </li>
    
      <li class="b-menu-item">
        <a href="http://rocks.tarantool.org" class="b-menu-item-url">Rocks</a>
      </li>
    
  </ul>

      </nav>
    </div>
  </header>

      <!-- < HEADER -->

      <div class="b-content b-clearbox">
        
  <section class="b-lightgray_block b-documentation_top b-clearbox p-documentation_in">
    <div class="b-block-wrapper">
      <h2
      
        class="b-section-title b-ellipsis toggle-navigation"
      
        title="Документация Tarantool 1.7.1">
          Документация Tarantool 1.7.1
      </h2>
  <div class="b-doc-language_selector">
    <ul class="b-doc-language_selector-list">
    
      <li class="b-doc-language_selector-item">
      
        <a href="
  
    ../singlehtml.html
  
"
           class="b-doc-language_selector-item-url"> En </a>
      
      </li>
    
      <li class="b-doc-language_selector-item">
      
        <a href="
  
    ru/singlehtml.html
  
"
           class="b-doc-language_selector-item-url p-active"> Ru </a>
      
      </li>
    
    </ul>
  </div>
</div>
  </section>
  
    <div class="b-cols_content b-clearbox">
      <div class="b-cols_content_left">
        

<ul>
<li class="toctree-l1"><a class="reference internal" href="singlehtml.html#document-intro">Общие сведения</a><ul>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#an-application-server-together-with-a-database-manager">Сервер приложений + СУБД</a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#database-features">Возможности СУБД</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="singlehtml.html#document-faq">Вопросы и ответы</a></li>
<li class="toctree-l1"><a class="reference internal" href="singlehtml.html#document-book/index">Руководство пользователя</a><ul>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-book/intro">1. Предисловие</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#how-to-read-the-documentation">1.1. Как пользоваться документацией</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#getting-in-touch-with-the-tarantool-community">1.2. Как связаться с сообществом разработчиков Tarantool'а</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-book/user_guide_getting_started">2. Начало работы</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#downloading-and-installing-a-binary-package">2.1. Скачивание и установка бинарного пакета</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#starting-tarantool-and-making-your-first-database">2.2. Первичный запуск Tarantool'а и создание базы данных</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#connecting-remotely">2.3. Установка удаленного соединения</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-book/box/index">3. Функционал СУБД</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#document-data-model">3.1. Модель данных</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#space">3.1.1. Пространство</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#tuple-set">3.1.2. Tuple set</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#index">3.1.3. Индекс</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#data-types">3.1.4. Типы данных</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#operations">3.1.5. Операции</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#saving-to-disk">3.1.6. Saving to disk</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#data-manipulation">3.1.7. Манипулирование данными</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#index-operations">3.1.8. Операции с индексами</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#the-box-library">3.1.9. Библиотека &quot;box&quot;</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#submodules-of-the-box-library">3.2. Вложенные модули из библиотеки &quot;box&quot;</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#the-two-storage-engines-memtx-and-vinyl">3.3. Два движка базы данных: memtx и vinyl</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#library-reference">3.4. Library reference</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#document-book/box/box_schema">3.4.1. Вложенный модуль <cite>box.schema</cite></a><ul>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#example">3.4.1.1. Пример</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#document-book/box/box_space">3.4.2. Вложенный модуль <cite>box.space</cite></a><ul>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#example-use-box-space-functions-to-read-space-tuples">3.4.2.1. Example: use box.space functions to read _space tuples</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#example-use-box-space-functions-to-organize-a-space-tuple">3.4.2.2. Example: use box.space functions to organize a _space tuple</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#document-book/box/box_index">3.4.3. Вложенный модуль <cite>box.index</cite></a><ul>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#example-showing-use-of-the-box-functions">3.4.3.1. Example showing use of the box functions</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#example-showing-a-user-defined-iterator">3.4.3.2. Example showing a user-defined iterator</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#submodule-box-index-with-index-type-rtree-for-spatial-searches">3.4.3.3. Submodule <cite>box.index</cite> with index type = RTREE for spatial searches</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#document-book/box/box_session">3.4.4. Вложенный модуль <cite>box.session</cite></a><ul>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#example">3.4.4.1. Пример</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#document-book/box/box_tuple">3.4.5. Вложенный модуль <cite>box.tuple</cite></a><ul>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#example">3.4.5.1. Пример</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#document-book/box/box_introspection">3.4.6. Просмотр состояния сервера</a><ul>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#lua-module.box.cfg">3.4.6.1. Submodule <cite>box.cfg</cite></a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#lua-module.box.info">3.4.6.2. Submodule <cite>box.info</cite></a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#lua-module.box.slab">3.4.6.3. Submodule <cite>box.slab</cite></a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#submodule-box-stat">3.4.6.4. Submodule <cite>box.stat</cite></a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#document-book/box/admin">3.4.7. Служебные запросы</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#document-book/box/atomic">3.4.8. Атомарные операции</a><ul>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#cooperative-multitasking-environment">3.4.8.1. Среда взаимной многозадачности</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#example">3.4.8.2. Пример</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#the-implicit-yield-rules">3.4.8.3. Правила неявной передачи управления</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#document-book/box/authentication">3.4.9. Ограничение доступа</a><ul>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#passwords">3.4.9.1. Passwords</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#users-and-the-user-space">3.4.9.2. Users and the _user space</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#privileges-and-the-priv-space">3.4.9.3. Privileges and the _priv space</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#functions-and-the-func-space">3.4.9.4. Functions and the _func space</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#box-session-and-security">3.4.9.5. <code class="docutils literal"><span class="pre">box.session</span></code> and security</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#roles">3.4.9.6. Roles</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#example-showing-a-role-within-a-role">3.4.9.7. Example showing a role within a role</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#document-book/box/triggers">3.4.10. Триггеры</a><ul>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#connection-triggers">3.4.10.1. Connection triggers</a><ul>
<li class="toctree-l6"><a class="reference internal" href="singlehtml.html#example">3.4.10.1.1. Пример</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#authentication-triggers">3.4.10.2. Authentication triggers</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#lua-module.box.space">3.4.10.3. Replace triggers</a><ul>
<li class="toctree-l6"><a class="reference internal" href="singlehtml.html#id1">3.4.10.3.1. Пример</a></li>
<li class="toctree-l6"><a class="reference internal" href="singlehtml.html#another-example">3.4.10.3.2. Another Example</a></li>
</ul>
</li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#getting-a-list-of-triggers">3.4.10.4. Getting a list of triggers</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#document-book/box/limitations">3.4.11. Ограничения</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#document-book/box/vinyl_diff">3.4.12. Различия между движками memtx и vinyl</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-book/replication/index">4. Репликация</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#replication-architecture">4.1. Архитектура механизма репликации</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#setting-up-the-master">4.2. Настройка главного сервера</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#setting-up-a-replica">4.3. Настройка сервера-реплики</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#recovering-from-a-degraded-state">4.4. Восстановление после сбоя</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#instructions-for-quick-startup-of-a-new-two-server-simple-cluster">4.5. Инструкции по быстрому запуску простого кластера из двух серверов с нуля</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#monitoring-a-replica-s-actions">4.6. Мониторинг действий реплики</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#preventing-duplicate-actions">4.7. Предотвращение дублирующихся действий</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#master-master-replication">4.8. Репликация по схеме master-master</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#all-the-what-if-questions">4.9. Ответы на вопросы &quot;Что если?&quot;</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#hands-on-replication-tutorial">4.10. Практическое руководство по репликации</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-book/configuration/index">5. Справочник по конфигурированию</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#command-options">5.1. Опции командной строки</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#uri">5.2. Универсальный код ресурса (URI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#initialization-file">5.3. Файл инициализации</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#configuration-parameters">5.4. Параметры конфигурации</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#basic-parameters">5.4.1. Основные параметры</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#configuring-the-storage">5.4.2. Настройка хранилища данных</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#snapshot-daemon">5.4.3. Фоновая программа для работы со снимками</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#binary-logging-and-snapshots">5.4.4. Журналирование и снимки в бинарном формате</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#replication">5.4.5. Репликация</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#networking">5.4.6. Работа с сетевыми соединениями</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#logging">5.4.7. Запись в журнал</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#local-hot-standby">5.5. Режим горячего резервирования</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-book/administration">6. Администрирование серверной части</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#server-signal-handling">6.1. Обработка сигналов от сервера</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#process-title">6.2. Название процесса</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#using-tarantool-as-a-client">6.3. Использование tarantool в качестве клиента</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#conventions-used-in-this-section">6.3.1. Условные обозначения, используемые в этом разделе</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#options-when-starting-client-from-the-command-line">6.3.2. Параметры запуска клиента из командной строки</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#tokens-requests-and-special-key-combinations">6.3.3. Токены, запросы и специальные комбинации клавиш</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#requests">6.3.4. Запросы</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#utility-tarantoolctl">6.4. Утилита tarantoolctl</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#configuration-for-tarantoolctl">6.4.1. Конфигурирование tarantoolctl</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#commands-for-tarantoolctl">6.4.2. Команды для tarantoolctl</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#typical-code-snippets-for-tarantoolctl">6.4.3. Примеры кода для tarantoolctl</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#a-detailed-example-for-tarantoolctl">6.4.4. Подробный пример для tarantoolctl</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#utility-tarantoolctl-connect">6.5. Утилита tarantoolctl connect</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#admin-ports">6.6. Порты для администрирования</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#system-specific-administration-notes">6.7. Заметки по администрированию для разных платформ</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#debian-gnu-linux-and-ubuntu">6.7.1. Debian GNU/Linux and Ubuntu</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#fedora-rhel-centos">6.7.2. Fedora, RHEL, CentOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#freebsd">6.7.3. FreeBSD</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#mac-os-x">6.7.4. Mac OS X</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#notes-for-systemd-users">6.8. Заметки для пользователей systemd</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#instance-management">6.8.1. Управление экземплярами</a><ul>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#creating-instances">6.8.1.1. Создание экземпляров</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#starting-instances">6.8.1.2. Запуск экземпляров</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#monitoring-instances">6.8.1.3. Мониторинг экземпляров</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#attaching-to-instances">6.8.1.4. Подсоединение к экземплярам</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#checking-logs">6.8.1.5. Проверка журнала</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#stopping-instances">6.8.1.6. Остановка экземпляров</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#daemon-supervision">6.8.2. Контроль за фоновыми программами</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#customizing-the-service-file">6.8.3. Правка настроек сервисного файла</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#debugging">6.8.4. Отладка</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#precautions">6.8.5. Особые указания</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#updating-tarantool-in-production">6.9. Обновление Tarantool'а в условиях эксплуатации</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#backups">6.10. Резервное копирование</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#upgrades">6.11. Обновление Tarantool'а</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-book/connectors/index">7. Коннекторы</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#protocol">7.1. Протокол</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#packet-example">7.2. Пример пакета данных</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#setting-up-the-server-for-connector-examples">7.3. Настройка окружения для примеров работы с коннекторами</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#java">7.4. Java</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#go">7.5. Go</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#r">7.6. R</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#perl">7.7. Perl</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#php">7.8. PHP</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#python">7.9. Python</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#c">7.10. C</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#example-1">7.10.1. Пример 1</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#example-2">7.10.2. Пример 2</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#interpreting-function-return-values">7.11. Интерпретация возвращаемых значений</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-book/modules">8. Модули</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#installing-an-existing-module">8.1. Установка существующего модуля</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#creating-a-new-lua-module-locally">8.2. Создание нового модуля на языке Lua</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#creating-a-new-c-c-module-locally">8.3. Создание нового модуля на языке C/C++</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#creating-a-mixed-lua-c-module-locally">8.4. Создание нового модуля на смеси языков Lua/C</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#tips-for-special-situations">8.5. Примечания для особых случаев</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-book/app/a_errcodes">9. Приложение A. Коды ошибок</a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-book/app/b_internals">10. Приложение B. Детали реализации</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#data-persistence-and-the-wal-file-format">10.1. Сохранность данных и формат WAL-файла</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#the-snapshot-file-format">10.2. Формат статического файла-снимка</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#the-recovery-process">10.3. Процесс восстановления</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#server-startup-with-replication">10.4. Запуск сервера с репликацией</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-book/app/c_lua_tutorial">11. Приложение C. Учебные примеры на языке Lua</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#insert-one-million-tuples-with-a-lua-stored-procedure">11.1. Вставка 1 млн кортежей с помощью хранимой процедуры на языке Lua</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#configure">11.1.1. Configure</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#delimiter">11.1.2. Delimiter</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#create-a-function-that-returns-a-string">11.1.3. Create a function that returns a string</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#create-a-function-that-calls-another-function-and-sets-a-variable">11.1.4. Create a function that calls another function and sets a variable</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#modify-the-function-so-it-returns-a-one-letter-random-string">11.1.5. Modify the function so it returns a one-letter random string</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#modify-the-function-so-it-returns-a-ten-letter-random-string">11.1.6. Modify the function so it returns a ten-letter random string</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#make-a-tuple-out-of-a-number-and-a-string">11.1.7. Make a tuple out of a number and a string</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#modify-main-function-to-insert-a-tuple-into-the-database">11.1.8. Modify main_function to insert a tuple into the database</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#modify-main-function-to-insert-a-million-tuples-into-the-database">11.1.9. Modify main_function to insert a million tuples into the database</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#sum-a-json-field-for-all-tuples">11.2. Подсчет суммы по JSON-полям во всех кортежах</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#indexed-pattern-search">11.3. Индексированный поиск по шаблонам</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-book/app/d_vinyl/index">12. Приложение D. Vinyl</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#introduction">12.1. Введение</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#under-the-hood">12.2. А что там &quot;под капотом&quot;?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#inserting-the-first-200-000-keys">12.2.1. Inserting the first 200.000 keys</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#inserting-the-next-300-000-keys">12.2.2. Inserting the next 300.000 keys</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#inserting-the-next-200-000-keys">12.2.3. Inserting the next 200.000 keys</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#inserting-the-last-300-000-keys">12.2.4. Inserting the last 300.000 keys</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#reading-million-keys">12.2.5. Reading million keys</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-book/app/e_cookbook">13. Приложение E. Готовые рецепты</a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-book/app/f_c_tutorial">14. Приложение F. Учебные примеры на языке C</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#c-stored-procedures">14.1. Работа с хранимыми процедурами на языке C</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-book/app/g_changes">15. Приложение G. Версионные изменения</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#changes-in-tarantool-version-1-7">15.1. Изменения в версии Tarantool 1.7</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="singlehtml.html#document-reference_lua/index">Справочник по Lua API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/box">Module <cite>box</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#document-book/box/box_schema">3.4.1. Вложенный модуль <cite>box.schema</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#example">3.4.1.1. Пример</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#document-book/box/box_space">3.4.2. Вложенный модуль <cite>box.space</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#example-use-box-space-functions-to-read-space-tuples">3.4.2.1. Example: use box.space functions to read _space tuples</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#example-use-box-space-functions-to-organize-a-space-tuple">3.4.2.2. Example: use box.space functions to organize a _space tuple</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#document-book/box/box_index">3.4.3. Вложенный модуль <cite>box.index</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#example-showing-use-of-the-box-functions">3.4.3.1. Example showing use of the box functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#example-showing-a-user-defined-iterator">3.4.3.2. Example showing a user-defined iterator</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#submodule-box-index-with-index-type-rtree-for-spatial-searches">3.4.3.3. Submodule <cite>box.index</cite> with index type = RTREE for spatial searches</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#document-book/box/box_session">3.4.4. Вложенный модуль <cite>box.session</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#example">3.4.4.1. Пример</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#document-book/box/box_tuple">3.4.5. Вложенный модуль <cite>box.tuple</cite></a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#example">3.4.5.1. Пример</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#document-book/box/box_introspection">3.4.6. Просмотр состояния сервера</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#lua-module.box.cfg">3.4.6.1. Submodule <cite>box.cfg</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#lua-module.box.info">3.4.6.2. Submodule <cite>box.info</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#lua-module.box.slab">3.4.6.3. Submodule <cite>box.slab</cite></a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#submodule-box-stat">3.4.6.4. Submodule <cite>box.stat</cite></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#document-book/box/triggers">3.4.10. Триггеры</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#connection-triggers">3.4.10.1. Connection triggers</a><ul>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#example">3.4.10.1.1. Пример</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#authentication-triggers">3.4.10.2. Authentication triggers</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#lua-module.box.space">3.4.10.3. Replace triggers</a><ul>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#id1">3.4.10.3.1. Пример</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#another-example">3.4.10.3.2. Another Example</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#getting-a-list-of-triggers">3.4.10.4. Getting a list of triggers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/clock">Модуль <cite>clock</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/console">Модуль <cite>console</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/crypto">Модуль <cite>crypto</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#incremental-methods-in-the-crypto-module">Incremental methods in the crypto module</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#getting-the-same-results-from-digest-and-crypto-modules">Getting the same results from digest and crypto modules</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/csv">Module <cite>csv</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/digest">Модуль <cite>digest</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#incremental-methods-in-the-digest-module">Incremental methods in the digest module</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/box_error">Вложенный модуль <cite>box.error</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/fiber">Модуль <cite>fiber</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#example-of-fiber-use">Example Of Fiber Use</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/fiber_ipc">Модуль <cite>fiber-ipc</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/fio">Module <cite>fio</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#common-pathname-manipulations">Common pathname manipulations</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#common-file-manipulations">Common file manipulations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/fun">Module <cite>fun</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/jit">Module <cite>jit</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/json">Module <cite>json</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#configuration-settings">Configuration settings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/log">Module <cite>log</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/msgpack">Модуль <cite>msgpack</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/net_box">Модуль <cite>net.box</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#example-showing-use-of-most-of-the-net-box-methods">Example showing use of most of the net.box methods</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/box_once">Функция <cite>box.once</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/os">Module <cite>os</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/pickle">Модуль <cite>pickle</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/socket">Модуль <cite>socket</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#example">Example</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#use-of-a-tcp-socket-over-the-internet">Use of a TCP socket over the Internet</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#use-of-a-udp-socket-on-localhost">Use of a UDP socket on localhost</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#use-tcp-server-to-accept-file-contents-sent-with-socat">Use tcp_server to accept file contents sent with socat</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/strict">Модуль <cite>strict</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/tap">Module <cite>tap</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/tarantool">Модуль <cite>tarantool</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/uuid">Module <cite>uuid</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/yaml">Module <cite>yaml</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_lua/other">Разное</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="singlehtml.html#document-reference_rock/index">Справочник по Lua rocks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_rock/dbms">Модули SQL СУБД</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#mysql-example">MySQL Example</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#installation">Installation</a><ul>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#with-luarocks">With LuaRocks</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#with-github">With GitHub</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#connecting">Connecting</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#how-to-ping">How to ping</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#executing-a-statement">Executing a statement</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#closing-connection">Closing connection</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#postgresql-example">PostgreSQL Example</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#id1">Installation</a><ul>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#id2">With LuaRocks</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#id3">With GitHub</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#id4">Connecting</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#id5">How to ping</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#id6">Executing a statement</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#id7">Closing connection</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#id8">Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_rock/expirationd">Модуль <cite>expirationd</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_rock/shard">Модуль <cite>shard</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#example-shard-init-syntax-for-one-shard">Example: shard.init syntax for one shard</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#example-shard-init-syntax-for-three-shards">Example: shard.init syntax for three shards</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#example-shard-minimal-configuration">Example: Shard, Minimal Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#example-shard-scaling-out">Example: Shard, Scaling Out</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_rock/tdb">Module <cite>tdb</cite></a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#debugger-commands">Debugger Commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#example-session">Example Session</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="singlehtml.html#document-reference_capi/index">Справочник по C API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_capi/box">Модуль <cite>box</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_capi/clock">Модуль <cite>clock</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_capi/coio">Модуль <cite>coio</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_capi/error">Модуль <cite>error</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_capi/fiber">Модуль <cite>fiber</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_capi/box_index">Модуль <cite>index</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_capi/latch">Модуль <cite>latch</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_capi/utils">Модуль <cite>lua/utils</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_capi/say">Модуль <cite>say</cite> (логирование)</a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_capi/schema">Модуль <cite>schema</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_capi/trivia">Модуль <cite>trivia/config</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_capi/tuple">Модуль <cite>tuple</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-reference_capi/txn">Модуль <cite>txn</cite></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="singlehtml.html#document-dev_guide/index">Руководство разработчика</a><ul>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-dev_guide/intro">Состав документации</a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-dev_guide/building_from_source">Сборка из исходных файлов</a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-dev_guide/building_documentation">Сборка документации</a></li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-dev_guide/developer_guidelines">Соглашения по разработке</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#how-to-work-on-a-bug">How to work on a bug</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-dev_guide/documentation_guidelines">Соглашения по документации</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#markup-issues">Markup issues</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#wrapping-text">Wrapping text</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#formatting-code-snippets">Formatting code snippets</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#using-separated-links">Using separated links</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#creating-labels-for-local-links">Creating labels for local links</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#making-comments">Making comments</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#language-and-style-issues">Language and style issues</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#us-vs-british-spelling">US vs British spelling</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#examples-and-templates">Examples and templates</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#module-and-function">Module and function</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#module-class-and-method">Module, class and method</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-dev_guide/box_protocol">Бинарный протокол в Tarantool'е</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#notion-in-diagrams">Обозначения на диаграммах</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#overview">Общие сведения о протоколе</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#greeting-packet">Пакет-приветствие</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#unified-packet-structure">Unified packet structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#authentication">Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#requests">Requests</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#response-packet-structure">Response packet structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#replication-packet-structure">Replication packet structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#xlog-snap">XLOG / SNAP</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-dev_guide/c_style_guide">Соглашения по разработке на языке C</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#general-guidelines">General guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#commenting-style">Commenting style</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#header-files">Header files</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#allocating-memory">Allocating memory</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#other">Other</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#linux-kernel-coding-style">Linux kernel coding style</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-1-indentation">Chapter 1: Indentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-2-breaking-long-lines-and-strings">Chapter 2: Breaking long lines and strings</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-3-placing-braces-and-spaces">Chapter 3: Placing Braces and Spaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-3-1-spaces">Chapter 3.1:  Spaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-4-naming">Chapter 4: Naming</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-5-typedefs">Chapter 5: Typedefs</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-6-functions">Chapter 6: Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-7-centralized-exiting-of-functions">Chapter 7: Centralized exiting of functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-8-commenting">Chapter 8: Commenting</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-9-you-ve-made-a-mess-of-it">Chapter 9: You've made a mess of it</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-10-kconfig-configuration-files">Chapter 10: Kconfig configuration files</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-11-data-structures">Chapter 11: Data structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-12-macros-enums-and-rtl">Chapter 12: Macros, Enums and RTL</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-13-printing-kernel-messages">Chapter 13: Printing kernel messages</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-14-allocating-memory">Chapter 14: Allocating memory</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-15-the-inline-disease">Chapter 15: The inline disease</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-16-function-return-values-and-names">Chapter 16: Function return values and names</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-17-don-t-re-invent-the-kernel-macros">Chapter 17:  Don't re-invent the kernel macros</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#chapter-18-editor-modelines-and-other-cruft">Chapter 18:  Editor modelines and other cruft</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#appendix-i-references">Appendix I: References</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-dev_guide/python_style_guide">Соглашения по разработке на языке Python</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#a-foolish-consistency-is-the-hobgoblin-of-little-minds">A Foolish Consistency is the Hobgoblin of Little Minds</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#code-lay-out">Code lay-out</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#indentation">Indentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#tabs-or-spaces">Tabs or Spaces?</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#maximum-line-length">Maximum Line Length</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#blank-lines">Blank Lines</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#encodings-pep-263">Encodings (PEP 263)</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#imports">Imports</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#whitespace-in-expressions-and-statements">Whitespace in Expressions and Statements</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#pet-peeves">Pet Peeves</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#other-recommendations">Other Recommendations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#comments">Comments</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#block-comments">Block Comments</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#inline-comments">Inline Comments</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#documentation-strings">Documentation Strings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#version-bookkeeping">Version Bookkeeping</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#naming-conventions">Naming Conventions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#descriptive-naming-styles">Descriptive: Naming Styles</a></li>
<li class="toctree-l4"><a class="reference internal" href="singlehtml.html#prescriptive-naming-conventions">Prescriptive: Naming Conventions</a><ul>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#names-to-avoid">Names to Avoid</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#package-and-module-names">Package and Module Names</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#class-names">Class Names</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#exception-names">Exception Names</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#global-variable-names">Global Variable Names</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#function-names">Function Names</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#function-and-method-arguments">Function and method arguments</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#method-names-and-instance-variables">Method Names and Instance Variables</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#constants">Constants</a></li>
<li class="toctree-l5"><a class="reference internal" href="singlehtml.html#designing-for-inheritance">Designing for inheritance</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#references">References</a></li>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#copyright">Copyright</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="singlehtml.html#document-dev_guide/release_management">Работа с релизами</a><ul>
<li class="toctree-l3"><a class="reference internal" href="singlehtml.html#how-to-make-a-minor-release">How to make a minor release</a></li>
</ul>
</li>
</ul>
</li>
</ul>

      </div>
      <div class="b-cols_content_right">
        <div class="b-cols_content_right-slot">
  <div class="b-page_header">
    <ul class="b-path-list">
      <li class="b-path-list-item">
        <a href="singlehtml.html#document-index"
           class="b-path-list-item-url">
          Documentation
        </a>
      </li>
      
      
      <li class="b-path-list-item">
        <div title="Документация Tarantool 1.7.1" class="b-path_current b-ellipsis">
          Документация Tarantool 1.7.1
        </div>
      </li>
      
    </ul>
  </div>

  <div class="section" id="documentation">
<h1>Документация<a class="headerlink" href="#documentation" title="Ссылка на этот заголовок">¶</a></h1>
<div class="toctree-wrapper compound">
<span id="document-intro"></span><div class="section" id="overview">
<h2>Общие сведения<a class="headerlink" href="#overview" title="Ссылка на этот заголовок">¶</a></h2>
<div class="section" id="an-application-server-together-with-a-database-manager">
<h3>Сервер приложений + СУБД<a class="headerlink" href="#an-application-server-together-with-a-database-manager" title="Ссылка на этот заголовок">¶</a></h3>
<p>Tarantool представляет собой сервер приложений на языке Lua, интегрированный с СУБД. В основе Tarantool лежат файберы (fibers), что позволяет нескольким Lua-приложениям работать в одном потоке (thread), при этом Tarantool-сервер может одновременно запускать другие потоки для обработки ввода-вывода данных и фоновых сервисных задач. Tarantool включает в себя LuaJIT (Just In Time) Lua-компилятор, Lua-библиотеки для решения наиболее частых задач, а также сервер баз данных Tarantool, представляющий собой NoSQL СУБД. Таким образом, Tarantool может всё то же, что node.js и Twisted, а кроме того обеспечивает сохранность данных.</p>
<p>Tarantool -- это open-source проект. Исходный код открыт для всех и распространяется бесплатно согласно лицензии <a class="reference external" href="http://www.gnu.org/licenses/license-list.html#ModifiedBSD">BSD license</a>. Поддерживаемые платформы: GNU / Linux, Mac OS и FreeBSD.</p>
<p>Создателем Tarantool'а -- а также его основным пользователем -- является компания <a class="reference external" href="http://api.mail.ru">Mail.Ru</a>, крупнейшая Интернет-компания России (30 млн пользователей, 25 млн электронных писем в день, веб-сайт в списке <a class="reference external" href="http://www.alexa.com/siteinfo/mail.ru">top 40</a> международного Alexa-рейтинга). Tarantool используется для обработки самых &quot;горячих&quot; данных Mail.Ru, таких как данные пользовательских онлайн-сессий, настройки онлайн-приложений, кеширование сервисных данных, алгоритмы распределения данных и шардинга, и т.д. Tarantool также используется во всё большем количестве проектов вне стен Mail.Ru. Это, к примеру, онлайн-игры, цифровой маркетинг, социальные сети. Несмотря на то что Mail.Ru спонсирует разработку Tarantool'а, весь процесс разработки, в т.ч. дальнейшие планы и база обнаруженных ошибок, является полностью открытым. В Tarantool включены патчи от большого числа сторонних разработчиков. Усилиями сообщества разработчиков Tarantool'а были написаны (и далее поддерживаются) библиотеки для подключения модулей на внешних языках программирования. А сообщество Lua-разработчиков предоставило сотни полезных пакетов, большинство из которых можно использовать в качестве расширений для Tarantool'а.</p>
<p>Пользователи Tarantool'а могут создавать, изменять и удалять <strong>Lua-функции</strong> прямо во время исполнения кода. Также они могут указывать <strong>Lua-программы</strong>, которые будут загружаться во время запуска Tarantool'а. Такие программы могут служить триггерами, выполнять фоновые задачи и взаимодействовать с другими программами по сети. В отличие от многих популярных сред разработки приложений, которые используют &quot;реактивный&quot; принцип, сетевое взаимодействие в Lua устроено последовательно, но очень эффективно, т.к. оно использует среду <strong>взаимной многозадачности</strong> самого Tarantool'а.</p>
<p>Один из встраиваемых Lua-пакетов -- это API для функционала СУБД. Таким образом, некоторые разработчики рассматривают Tarantool как СУБД с популярным языком для написания хранимых процедур, другие рассматривают его как Lua-интерпретатор, а третьи -- как вариант замены сразу нескольких компонентов в многозвенных веб-приложениях. Производительность Tarantool'а может достигать сотен тысяч транзакций в секунду на ноутбуке, и ее можно наращивать &quot;вверх&quot; или &quot;вширь&quot; за счет новых серверных ферм.</p>
</div>
<div class="section" id="database-features">
<h3>Возможности СУБД<a class="headerlink" href="#database-features" title="Ссылка на этот заголовок">¶</a></h3>
<p>Компонент &quot;box&quot; -- серверная часть с функционалом СУБД -- это важная часть Tarantool'а, хотя он может работать и без данного компонента.</p>
<p>API для функционала СУБД позволяет хранить Lua-объекты, управлять коллекциями объектов, создавать и удалять вторичные ключи, делать атомарные изменения, конфигурировать и мониторить репликацию, производить контролируемое переключение при отказе (failover), а также исполнять код на Lua, который вызывается событиями в базе. А для прозрачного доступа к удаленным (remote) экземплярам баз данных разработан API для вызова удаленных процедур.</p>
<p>В архитектуре серверной части СУБД Tarantool'а реализована концепция &quot;движков&quot; базы данных (storage engines), где в разных ситуациях используются разные наборы алгоритмов и структуры данных. В Tarantool'е есть два встроенных движка: in-memory движок, который держит все данные и индексы в оперативной памяти, и двухуровневый движок для B-деревьев, который обрабатывает данные размером в 10-1000 раз больше того, что может поместиться в оперативной памяти. Все движки в Tarantool'е поддерживают транзакции и репликацию, поскольку они используют единый механизм <strong>упреждающей записи</strong> (WAL = write ahead log). Это механизм обеспечивает согласованность и сохранность данных при сбоях. Таким образом, изменения не считаются завершенными, пока не проходит запись в лог WAL. Подсистема логирования также поддерживает групповые коммиты.</p>
<p><strong>In-memory движок</strong> (memtx) хранит все данные в оперативной памяти, поэтому время ожидания при чтении у него очень мало. Также, когда пользователи запрашивают статические снимки (snapshots), этот движок создает персистентные копии данных в постоянной памяти, например на жестком диске. Если Tarantool-сервер прекращает работать и данные в оперативной памяти теряются, то при следующем запуске Tarantool-сервер загружает в память самую свежую копию данных с диска и применяет к ней все транзакции из лога, которые были сделаны с момента создания копии. Таким образом, данные при сбое не теряются.</p>
<p>В штатных ситуациях <strong>in-memory движок работает без блокировок</strong>. Вместо низкоуровневых механизмов параллельной обработки данных, которые предлагает операционная система (например, mutex'ов), Tarantool использует среду взаимной многозадачности, и таким образом может работать с тысячами соединений одновременно. В Tarantool'е есть фиксированное количество независимых нитей (thread), и у них нет общего состояния. Для обмена данными между нитями используются очереди сообщений, что позволяет уменьшить накладные расходы. Такой подход накладывает ограничение на количество процессорных ядер, которые Tarantool-сервер может использовать, но в то же время он позволяет избежать конкуренции за шину памяти, а также дает запас масштабируемости по скорости доступа к памяти и производительности сети. В результате даже сильно нагруженный Tarantool-сервер в среднем использует процессор не более чем на 10%. Кроме того, Tarantool поддерживает поиск как по первичным, так и по <strong>вторичным ключам в индексах</strong>.</p>
<p><strong>Дисковый движок</strong> (<a class="reference internal" href="singlehtml.html#index-vinyl"><span class="std std-ref">vinyl</span></a>) совмещает в себе подходы, заимствованные из современных файловых систем, журналируемых merge-деверьев (log-structured merge trees) и классических B-деревьев. Все данные в этом движке разбиты по забегам (runs), где каждый забег представляет собой файл на диске. Максимальный размер забега обычно равен 64МБ, и его можно настраивать. Каждый забег -- это набор страниц, которые нужны для каких-то целей. Если забег полностью смержен, то диапазоны ключей на его страницах не пересекаются. Если же диапазоны ключей в забеге в какой-то момент сильно изменялись, то мы имеем дело с частично смерженным забегом. В этом случае на некоторых страницах появились новые ключи и значения, которых ранее не было в данном забеге. Дисковый движок обновляет данные по принципу дописывания в конец: новые данные никогда не затирают старые.</p>
<p>Tarantool поддерживает работу с <strong>составными ключами в индексах</strong>. Возможные типы ключей: HASH, TREE, BITSET и RTREE.</p>
<p>Tarantool также поддерживает <strong>асинхронную репликацию</strong> -- как локальную, так и на удаленных серверах. При этом репликацию можно настроить по принципу <strong>мастер-мастер</strong>, когда несколько узлов могут не только обрабатывать входящую нагрузку, но и получать данные от других узлов.</p>
</div>
</div>
<span id="document-faq"></span><div class="section" id="faq">
<h2>Вопросы и ответы<a class="headerlink" href="#faq" title="Ссылка на этот заголовок">¶</a></h2>
<div class="table container">
<table border="1" class="left-align-column-1 left-align-column-2 top-align-column-1 border-0-column-1 border-0-column-2 docutils">
<colgroup>
<col width="9%" />
<col width="91%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><p class="first last">Вопрос: <br /> Ответ: <br /></p>
</td>
<td><p class="first last">Почему Tarantool? <br /> Tarantool -- это in-memory сервер баз данных последнего поколения, предназначенный для работы с веб-приложениями. Разработка ведется с учетом многолетнего опыта использования Tarantool'а в стенах Mail.Ru. Первый релиз состоялся в 2008 году.</p>
</td>
</tr>
<tr class="row-even"><td><p class="first last">Вопрос: <br /> Ответ: <br /></p>
</td>
<td><p class="first last">Почему Lua? <br /> Lua -- это легкий, быстрый и расширяемый язык, позволяющий использовать различные парадигмы программирования. Lua также легко встраивается в различные приложения. Ко-рутины (coroutines) в Lua близко соотносятся с файберами (fibers) в Tarantool'е, а вся Lua-архитектура гладко ложится на его внутреннюю реализацию. Lua -- это первый язык, на котором можно писать хранимые процедуры для Tarantool'а. В будущем список поддерживаемых языков планируется расширить.</p>
</td>
</tr>
<tr class="row-odd"><td><p class="first last">Вопрос: <br /> Ответ: <br /></p>
</td>
<td><p class="first last">В чем состоит главное преимущество Tarantool'а? <br /> Tarantool предоставляет богатый набор функций по работе с базами данных (HASH, TREE, RTREE, BitSet-индексы, вторичные индексы, составные индексы, транзакции, триггеры, асинхронная репликация), и всё это -- в гибкой среде Lua-интерпретатора. <br /> Эти два обстоятельства делают Tarantool быстрым и надежным in-memory сервером баз данных с атомарными операциями и сложной логикой на стороне сервера. Преимуществом Tarantool'а по сравнению с традиционными SQL СУБД является его высокая производительность: низкие накладные расходы и безблокировочная архитектура позволяют Tarantool'у обрабатывать на порядок больше запросов в секунду на аналогичном оборудовании. Преимущество же перед другими NoSQL СУБД заключается в большей гибкости Tarantool'а: язык Lua позволяет гибко обрабатывать данные, хранящиеся в компактном, ненормализованном формате.</p>
</td>
</tr>
<tr class="row-even"><td><p class="first last">Вопрос: <br /> Ответ: <br /></p>
</td>
<td><p class="first last">Каковы ваши планы по развитию? <br /> Мы постоянно улучшаем производительность серверной части. Наши главные цели на 2016-2018 год -- это автоматический шардинг и синхронная репликация, а также частичная поддержка SQL. План работ находится в открытом доступе, и все желающие могут оставлять запросы на добавление функционала.</p>
</td>
</tr>
<tr class="row-odd"><td><p class="first last">Вопрос: <br /> Ответ: <br /></p>
</td>
<td><p class="first last">Кто разрабатывает Tarantool? <br /> Во-первых, этим занимается команда разработки в Mail.Ru -- см. историю коммитов на github.com/tarantool. Вся разработка ведется открытым образом. Кроме того, активную роль играют члены сообщества разработчиков Tarantool'а. Их силами было создано большинство коннекторов и ведутся доработки под разные дистрибутивы.</p>
</td>
</tr>
<tr class="row-even"><td><p class="first last">Вопрос: <br /> Ответ: <br /></p>
</td>
<td><p class="first last">Насколько серьезны планы Mail.Ru в отношении Tarantool'а? <br /> Tarantool -- это проект с открытым кодом, распространяемый под лицензией BSD, поэтому он не зависит от внешних спонсоров. В то же время, Tarantool -- это часть технологического &quot;костяка&quot; Mail.Ru, и поэтому он пользуется сильной поддержкой со стороны Mail.Ru.</p>
</td>
</tr>
<tr class="row-odd"><td><p class="first last">Вопрос: <br /> Ответ: <br /></p>
</td>
<td><p class="first last">Возникают ли проблемы из-за того, что Tarantool является in-memory решением? <br /> Основной движок баз данных в Tarantool'е работает с оперативной памятью, но при этом он гарантирует сохранность данных благодаря механизму WAL (write ahead log), т.е. журналу упреждающей записи. Также в Tarantool'е используются технологии сжатия и распределения данных, которые позволяют использовать все виды памяти наиболее эффективно. Если Tarantool сталкивается с нехваткой оперативной памяти, то он приостанавливает прием запросов на изменение данных до тех пор, пока не появится свободная память, но при этом с успехом продолжает обработку запросов на чтение и удаление данных. А для больших баз, где объем данных значительно превосходит имеющийся объем оперативной памяти, у Tarantool'а есть второй движок, чьи возможности ограничены лишь размером жесткого диска.</p>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<span id="document-book/index"></span><div class="section" id="user-guide">
<span id="id1"></span><h2>Руководство пользователя<a class="headerlink" href="#user-guide" title="Ссылка на этот заголовок">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-book/intro"></span><div class="section" id="preface">
<h3>1. Предисловие<a class="headerlink" href="#preface" title="Ссылка на этот заголовок">¶</a></h3>
<p>Добро пожаловать в мир Tarantool! Сейчас вы читаете &quot;Руководство пользователя&quot;. Мы советуем начинать именно с него, а затем переходить к &quot;Справочникам&quot;, если вам понадобятся более подробные сведения.</p>
<div class="section" id="how-to-read-the-documentation">
<h4>1.1. Как пользоваться документацией<a class="headerlink" href="#how-to-read-the-documentation" title="Ссылка на этот заголовок">¶</a></h4>
<p>Знакомство с Tarantool'ом вы можете начать с того, что скачаете готовый установочный пакет (как описано в начале главы 2 &quot;Начало работы&quot;) или воспользуетесь нашим онлайн-стендом на <a class="reference external" href="http://try.tarantool.org">http://try.tarantool.org</a>. В любом случае для первого знакомства вы можете выполнить тренировочные примеры из второй части главы 2 &quot;Первичный запуск Tarantool'а и создание базы данных&quot;.</p>
<p>В главе 3 &quot;Функционал СУБД&quot; рассказано о возможностях Tarantool'а как NoSQL СУБД. В конце этой главы также приводится справочник по библиотекам Tarantool'а. Но если вы собираетесь использовать Tarantool только как сервер приложений Lua, то вы можете пропустить и эту, и следующую за ней главу 4 &quot;Репликация&quot;.</p>
<p>Глава 5 &quot;Справочник по конфигурированию&quot; и глава 6 &quot;Администрирование серверной части&quot; предназначены в первую очередь для системных администраторов. Тем не менее любому пользователю Tarantool'а полезно знать, как производится настройка Tarantool-сервера, поэтому мы настоятельно рекомендуем прочесть раздел про параметры <code class="docutils literal"><span class="pre">box.cfg</span></code>.</p>
<p>Глава 7 &quot;Коннекторы&quot; актуальна только для тех пользователей, которые хотят устанавливать соединение с Tarantool'ом с помощью программ на других языках программирования (например C, Perl или Python) — для прочих пользователей эта глава неактуальна.</p>
<p>В главе 8 &quot;Модули&quot; показано, как устанавливать существующие модули (библиотеки) и разрабатывать новые модули на языках языках Lua и C.</p>
<p>В первых двух Приложениях, A и B, приводится справочная информация по внутренней реализации Tarantool'а: коды ошибок, логика внутренних процессов (восстановления и репликации) и собственные форматы файлов.</p>
<p>Три длинных учебных примера в Приложении C — &quot;Вставка 1 млн кортежей с помощью хранимой процедуры на языке Lua&quot;, &quot;Подсчет суммы по JSON-полям во всех кортежах&quot; и &quot;Индексированный поиск по шаблонам&quot; — предназначены для пользователей, которые еще плохо знакомы с языком Lua или NoSQL СУБД.</p>
<p>В Приложении D &quot;Vinyl&quot; подробно рассказывается про дисковый движок Tarantool'а под названием <cite>vinyl</cite>.</p>
<p>В Приложении E &quot;Готовые рецепты&quot; собраны рабочие фрагменты кода, которые пригодятся для решения типичных или, наоборот, особо трудных задач.</p>
<p>В Приложении F содержится один длинный учебный пример по работе с хранимыми процедурами на языке C.
Опытным пользователям могут быть интересны Справочники и Руководство разработчика, а также подробные комментарии в исходном коде.</p>
<p>В Приложении G &quot;Версионные изменения&quot; приводится список существенных изменений для конкретных версий Tarantool'а.</p>
<p>Опытным же пользователям могут пригодиться Справочники и Руководство разработчика.</p>
</div>
<div class="section" id="getting-in-touch-with-the-tarantool-community">
<h4>1.2. Как связаться с сообществом разработчиков Tarantool'а<a class="headerlink" href="#getting-in-touch-with-the-tarantool-community" title="Ссылка на этот заголовок">¶</a></h4>
<p>Оставить сообщение о найденых дефектах или сделать запрос на новый функционал можно тут: <a class="reference external" href="http://github.com/tarantool/tarantool/issues">http://github.com/tarantool/tarantool/issues</a></p>
<p>Пообщаться напрямую с командой разработки Tarantool'а можно в <a class="reference external" href="http://telegram.me/tarantool">telegram</a> или на форумах (<a class="reference external" href="https://groups.google.com/forum/#!forum/tarantool">англоязычном</a> или <a class="reference external" href="https://googlegroups.com/group/tarantool-ru">русскоязычном</a>).</p>
</div>
</div>
<span id="document-book/user_guide_getting_started"></span><div class="section" id="getting-started">
<span id="user-guide-getting-started"></span><h3>2. Начало работы<a class="headerlink" href="#getting-started" title="Ссылка на этот заголовок">¶</a></h3>
<p>В этой главе рассказывается, как скачать, установить и начать работать с Tarantool'ом с нуля.</p>
<p>Для промышленной эксплуатации рекомендуется скачать бинарный (исполняемый) пакет. Тогда вы гарантированно получите сборку той же версии, что и у разработчиков. Это существенно упростит поиск ошибок, если вам в будущем понадобится помощь, а также позволит избежать проблем из-за того, что вы использовали инструменты или параметры отличные от тех, что использовали при сборке сами разработчики. См. раздел “<a class="reference internal" href="#user-guide-getting-started-downloading-and-installing-a-binary-package"><span class="std std-ref">Скачивание и установка бинарного пакета</span></a>”.</p>
<p>Для разработческих целей вы можете скачать исходные файлы и собрать бинарный пакет самостоятельно с помощью компилятора C/C++ и обычных инструментов для сборки. Хотя это и более трудный способ получить бинарный пакет, но он дает вам больший контроль над результатом. Также в состав исходных файлов входят дополнительные пакеты, например набор тестов для Tarantool'а. См. раздел &quot;<a class="reference internal" href="singlehtml.html#building-from-source"><span class="std std-ref">Сборка из исходных файлов</span></a>&quot;.</p>
<p>После установки вы можете сразу опробовать Tarantool в действии. Ниже вы найдете инструкции по созданию безопасной тестовой среды. Всего за несколько минут вы сможете запустить Tarantool-сервер и задать несколько инструкций по манипулированию данными. См. раздел &quot;<a class="reference internal" href="#user-guide-getting-started-first-database"><span class="std std-ref">Первичный запуск Tarantool'а и создание базы данных</span></a>”.</p>
<div class="section" id="downloading-and-installing-a-binary-package">
<span id="user-guide-getting-started-downloading-and-installing-a-binary-package"></span><h4>2.1. Скачивание и установка бинарного пакета<a class="headerlink" href="#downloading-and-installing-a-binary-package" title="Ссылка на этот заголовок">¶</a></h4>
<p>Бинарные пакеты для двух версий Tarantool'а — стабильной 1.6 и самой свежей 1.7 — выложены на странице <a class="reference external" href="http://tarantool.org/download.html">http://tarantool.org/download.html</a>. При каждом изменении исходного кода на GitHub (репозиторий <a class="reference external" href="http://github.com/tarantool/tarantool">http://github.com/tarantool/tarantool</a>, ветка &quot;1.7&quot;) происходит сборка, автоматическое тестирование и выкладка бинарных пакетов на вышеуказанную страницу.</p>
<p>Чтобы скачать и установить бинарный пакет для вашей операционной системы, откройте терминал с командной строкой и введите инструкции, которые даны для вашей операционной системы на странице <a class="reference external" href="http://tarantool.org/download.html">http://tarantool.org/download.html</a>.</p>
</div>
<div class="section" id="starting-tarantool-and-making-your-first-database">
<span id="user-guide-getting-started-first-database"></span><h4>2.2. Первичный запуск Tarantool'а и создание базы данных<a class="headerlink" href="#starting-tarantool-and-making-your-first-database" title="Ссылка на этот заголовок">¶</a></h4>
<p>Далее рассказывается, как создать простую тестовую базу данных после установки Tarantool'а.</p>
<p>Создайте новую директорию. Она понадобится только для тестовых целей, и ее можно будет удалить по окончании экспериментов.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> mkdir ~/tarantool_sandbox
<span class="gp">$</span> <span class="nb">cd</span> ~/tarantool_sandbox
</pre></div>
</div>
<p>Далее рассказывается, как создать простую тестовую базу данных после установки Tarantool'а.</p>
<p>Запустите Tarantool-сервер. Имя программы — <strong class="program">tarantool</strong>.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="c1"># Если вы скачали бинарный пакет с помощью apt-get или yum, введите:</span>
<span class="gp">$</span> /usr/bin/tarantool
<span class="gp">$</span> <span class="c1"># Если вы скачали бинарный пакет в формате TAR</span>
<span class="gp">$</span> <span class="c1"># и разархивировали его в директорию ~/tarantool, введите:</span>
<span class="gp">$</span> ~/tarantool/bin/tarantool
<span class="gp">$</span> <span class="c1"># Если вы собрали Tarantool из исходных файлов, введите:</span>
<span class="gp">$</span> ~/tarantool/src/tarantool
</pre></div>
</div>
<p>Tarantool-сервер запускается в интерактивном режиме и выводит приглашение командной строки. Чтобы создать базу данных, задайте ее настройки с помощью вызова <a class="reference internal" href="singlehtml.html#box-introspection-box-cfg"><span class="std std-ref">box.cfg</span></a>. Вот пример минимальной конфигурации:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span> <span class="o">=</span> <span class="mi">3301</span><span class="p">}</span>
</pre></div>
</div>
<p>Если все в порядке, то Tarantool-сервер начнет в прогрессе отображать процесс инициализации, например:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span> <span class="o">=</span> <span class="mi">3301</span><span class="p">}</span>
<span class="go">2015-08-07 09:41:41.077 ... version 1.7.0-1216-g73f7154</span>
<span class="go">2015-08-07 09:41:41.077 ... log level 5</span>
<span class="go">2015-08-07 09:41:41.078 ... mapping 1073741824 bytes for a shared arena...</span>
<span class="go">2015-08-07 09:41:41.079 ... initialized</span>
<span class="go">2015-08-07 09:41:41.081 ... initializing an empty data directory</span>
<span class="go">2015-08-07 09:41:41.095 ... creating &#39;./00000000000000000000.snap.inprogress&#39;</span>
<span class="go">2015-08-07 09:41:41.095 ... saving snapshot &#39;./00000000000000000000.snap.inprogress&#39;</span>
<span class="go">2015-08-07 09:41:41.127 ... done</span>
<span class="go">2015-08-07 09:41:41.128 ... primary: bound to 0.0.0.0:3301</span>
<span class="go">2015-08-07 09:41:41.128 ... ready to accept requests</span>
</pre></div>
</div>
<p>Поскольку Tarantool-сервер уже запущен, вы можете запустить новый терминал и присоединиться к основному порту Tarantool-сервера, введя следующую команду:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> telnet <span class="m">0</span> 3301
</pre></div>
</div>
<p>но пока что будет лучше оставить Tarantool-сервер работать в интерактивном режиме. На промышленных серверах <a class="reference internal" href="singlehtml.html#administration-using-tarantool-as-a-client"><span class="std std-ref">интерактивный режим</span></a> нужен лишь для администрирования, однако для наглядности большинство примеров в данном руководстве даны именно в интерактивном режиме. Итак, Tarantool ждет от вас ввода инструкций.</p>
<p>Создайте первое пространство и первый <a class="reference internal" href="singlehtml.html#box-index"><span class="std std-ref">индекс</span></a>:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">hash&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}</span>
<span class="gp">         &gt; </span><span class="p">})</span>
</pre></div>
</div>
<p>Выполните вставку трех &quot;кортежей&quot; (tuple) в первое &quot;пространство&quot; (space) из вашей базы данных:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">({</span><span class="mi">1</span><span class="p">})</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">({</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Music&#39;</span><span class="p">})</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">({</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Length&#39;</span><span class="p">,</span> <span class="mi">93</span><span class="p">})</span>
</pre></div>
</div>
<p>Произведите выборку кортежа из первого пространства в базе по первому указанному ключу:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">3</span><span class="p">}</span>
</pre></div>
</div>
<p>Вот что должно отображаться на вашем терминале к этому моменту:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="go">2015-06-10 12:04:18.158 ... creating &#39;./00000000000000000000.xlog.inprogress&#39;</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;s:create_index(&#39;primary&#39;, {type = &#39;hash&#39;, parts = {1, &#39;unsigned&#39;}})</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Music&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Length&#39;</span><span class="p">,</span> <span class="mi">93</span><span class="p">}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">3</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span> <span class="s">&#39;Length&#39;</span><span class="p p-Indicator">,</span> <span class="nv">93</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
<p>Далее, чтобы подготовиться к тестовому примеру в следующем разделе, введите:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">guest&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read,write,execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">universe&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="connecting-remotely">
<h4>2.3. Установка удаленного соединения<a class="headerlink" href="#connecting-remotely" title="Ссылка на этот заголовок">¶</a></h4>
<p>В предыдущем разделе ваш первый запрос был <code class="samp docutils literal"><span class="pre">box.cfg</span><em><span class="pre">listen</span> <span class="pre">=</span> <span class="pre">3301</span></em></code>. Значением <code class="docutils literal"><span class="pre">listen</span></code> может быть любой URI (универсальный код ресурса), в данном случае — просто номер локального порта (3301). Вы можете отправлять запросы на URI для прослушивания с помощью:</p>
<ol class="loweralpha simple">
<li>telnet,</li>
<li><p class="first">коннектора (см. главу &quot;<a class="reference internal" href="singlehtml.html#index-box-connectors"><span class="std std-ref">Коннекторы</span></a>&quot;),</p>
</li>
<li><p class="first">другого экземпляра Tarantool'а с помощью <a class="reference internal" href="singlehtml.html#console-module"><span class="std std-ref">console module</span></a>, либо</p>
</li>
<li><code class="docutils literal"><span class="pre">tarantoolctl</span> <span class="pre">connect</span></code>.</li>
</ol>
<p>Давайте попробуем вариант с <code class="docutils literal"><span class="pre">tarantoolctl</span> <span class="pre">connect</span></code>.</p>
<p>Переключитесь на другой терминал. Например, в Linux-системе для этого нужно запустить новый экземпляр Bash. При этом вам не потребуется вызывать cd, чтобы переключиться на директорию <code class="code docutils literal"><span class="pre">~/tarantool_sandbox</span></code>.</p>
<p>Запустите утилиту <code class="docutils literal"><span class="pre">tarantoolctl</span></code>:</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">$</span> <strong><span class="pre">tarantoolctl</span> <span class="pre">connect</span> <span class="pre">'3301'</span></strong></code>
</pre>
<p>Данная команда означает &quot;использовать утилиту <a class="reference internal" href="singlehtml.html#administration-tarantoolctl-connect"><span class="std std-ref">tarantoolctl</span></a> для соединения с Tarantool-сервером, который слушает на <code class="docutils literal"><span class="pre">localhost:3301</span></code>.&quot;</p>
<p>Введите следующий запрос:</p>
<pre class="highlight literal-block">
tarantool&gt; {<strong>{box.space.tester:select{2}}</strong>}
</pre>
<p>Это означает &quot;послать запрос тому Tarantool-серверу и вывести результат на экран.&quot; Результатом в данном случае будет один из кортежей, что вы вставляли ранее. На терминале теперь должно отображаться примерно следующее:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">$</span> tarantoolctl connect 3301
<span class="go">/usr/local/bin/tarantoolctl: connected to localhost:3301</span>
<span class="gp">localhost:3301&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">2</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="s">&#39;Music&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>

<span class="go">localhost:3301&gt;</span>
</pre></div>
</div>
<p>Вы можете повторно вводить команды <code class="code docutils literal"><span class="pre">box.space...:insert{}</span></code> и <code class="code docutils literal"><span class="pre">box.space...:select{}</span></code> сколько угодно раз, на любом экземпляре Tarantool'а. В конце тестирования воспользуйтесь следующими командами. Чтобы удалить пространство: <code class="code docutils literal"><span class="pre">s:drop()</span></code>. Чтобы остановить  <code class="docutils literal"><span class="pre">tarantoolctl</span></code>: Ctrl+C или Ctrl+D. Чтобы остановить Tarantool (альтернативный вариант): <a class="reference internal" href="singlehtml.html#os-exit"><span class="std std-ref">os.exit()</span></a>. Чтобы остановить Tarantool (с другого терминала): <code class="code docutils literal"><span class="pre">sudo</span> <span class="pre">pkill</span> <span class="pre">-f</span> <span class="pre">tarantool</span></code>. Чтобы удалить тестовую базу: <code class="code docutils literal"><span class="pre">rm</span> <span class="pre">-r</span> <span class="pre">~/tarantool_sandbox</span></code>.</p>
<p>Если вы выполнили все инструкции из этой главы, то к данному моменту вы уже установили Tarantool (из бинарного пакета, либо из исходных файлов), запустили Tarantool-сервер, а также выполнили вставку и выборку кортежей.</p>
</div>
</div>
<span id="document-book/box/index"></span><div class="section" id="database">
<span id="database-chapter"></span><h3>3. Функционал СУБД<a class="headerlink" href="#database" title="Ссылка на этот заголовок">¶</a></h3>
<p>В этой главе описывается то, как в Tarantool'е организовано хранение данных и какие операции с данным он поддерживает.</p>
<div class="section" id="document-data-model">
<h4>3.1. Модель данных<a class="headerlink" href="#document-data-model" title="Ссылка на этот заголовок">¶</a></h4>
<p>Если вы уже выполнили тестовое задание из раздела <a class="reference internal" href="singlehtml.html#user-guide-getting-started-first-database"><span class="std std-ref">Первичный запуск Tarantool'а и создание базы данных</span></a> в предыдущей главе, то ваша база данных имеет следующий вид:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>+--------------------------------------------+
|                                            |
| ПРОСТРАНСТВО &#39;tester&#39;                      |
| +----------------------------------------+ |
| |                                        | |
| | НАБОР КОРТЕЖЕЙ &#39;tester&#39;                | |
| | +-----------------------------------+  | |
| | | Кортеж: [ 1 ]                     |  | |
| | | Кортеж: [ 2, &#39;Music&#39; ]            |  | |
| | | Кортеж: [ 3, &#39;length&#39;, 93 ]       |  | |
| | +-----------------------------------+  | |
| |                                        | |
| | ИНДЕКС &#39;primary&#39;                       | |
| | +-----------------------------------+  | |
| | | Ключ: 1                           |  | |
| | | Ключ: 2                           |  | |
| | | Ключ: 3                           |  | |
| | +-----------------------------------+  | |
| |                                        | |
| +----------------------------------------+ |
+--------------------------------------------+
</pre></div>
</div>
<div class="section" id="space">
<h5>3.1.1. Пространство<a class="headerlink" href="#space" title="Ссылка на этот заголовок">¶</a></h5>
<p><em>Пространство</em> с именем 'tester' в нашем примере — это контейнер.</p>
<p>Когда Tarantool используется для хранения данных, то он создает по меньшей мере одно пространство (space). В общем же случае пространств может быть много. Каждое пространство имеет уникальное имя, заданное пользователем, а также уникальный числовой идентификатор, который тоже может быть задан пользователем, но обычно назначается автоматически самим Tarantool'ом. Пространство всегда содержит один набор кортежей и один или более индексов.</p>
</div>
<div class="section" id="tuple-set">
<h5>3.1.2. Tuple set<a class="headerlink" href="#tuple-set" title="Ссылка на этот заголовок">¶</a></h5>
<p><em>Набор кортежей</em> — в нашем примере он назван 'tester' — это группа кортежей.</p>
<p>Каждое пространство всегда содержит один набор кортежей. Идентификатор набора кортежей совпадает с именем самого пространства, в нашем примере — <cite>tester</cite>.</p>
<p>Кортеж (tuple) выполняет ту же роль, что &quot;строка&quot; или &quot;запись&quot;, а компоненты кортежа (его &quot;полЯ&quot;) выполняют ту же роль, что &quot;поле столбца, соответствующее данной строке&quot; или &quot;поле в записи&quot; за тем исключением, что поля кортежа могут быть составными (например, они могут быть массивами или отображениями) и им не нужны имена. Поэтому нет необходимости предварительно определять набор кортежей при создании пространства, а каждый кортеж может иметь различное количество элементов. Кортежи хранятся в виде <a class="reference external" href="https://en.wikipedia.org/wiki/MessagePack">MsgPack</a>-массивов.</p>
<p>Кортеж может иметь любое количество полей, и это могут быть поля разных типов. Идентификатором поля является его номер. Поля нумеруются, начиная с 1. Так, например, “1” может использоваться в некоторых контекстах для обозначения первого поля кортежа.</p>
<p>When Tarantool returns a tuple value, it surrounds strings with single quotes,
separates fields with commas, and encloses the tuple inside square brackets.
For example: <code class="docutils literal"><span class="pre">[3,</span> <span class="pre">'length',</span> <span class="pre">93]</span></code>.</p>
</div>
<div class="section" id="index">
<span id="index-box-index"></span><h5>3.1.3. Индекс<a class="headerlink" href="#index" title="Ссылка на этот заголовок">¶</a></h5>
<p><em>Индекс</em> — в нашем примере он первичный — это совокупность значений ключей и указателей.</p>
<p>In order for a tuple set to be useful, there must always be at least one index
in a space. There can be many indexes. As with spaces, the user can and should
specify the index name, and let Tarantool come up with a unique numeric identifier
(the &quot;index id&quot;). In our example there is one index and its name is “primary”.</p>
<p>Индекс может быть <em>составным</em>. Значение ключа в таком индексе составляется из значений двух или более полей кортежа, причем они могут браться в любом порядке. Индекс может быть <em>уникальным</em>. В этом случае один и тот же ключ не может встречаться в индексе более одного раза. Также индекс может быть одного из следующих <em>четырех типов</em>: HASH (он самый быстрый и самый экономный в плане использования памяти, но он должен быть уникальным), TREE (он позволяет делать поиск по части ключа и получать отсортированные результаты), BITSET (он хорош для поиска с '=' и больших количеством AND-условий) или RTREE (для пространственных координат). Первый индекс называется “<em>первичным</em>” (primary) и должен быть уникальным. Все остальные индексы называются “вторичными” (secondary).</p>
<p>Индекс может содержать идентификаторы полей кортежа и типы данных для этих полей. Индексированные поля могут содержать данные следующих типов:</p>
<ul class="simple">
<li><p class="first"><code class="docutils literal"><span class="pre">unsigned</span></code> (беззнаковое целое число в диапазоне от 0 до 18,446,744,073,709,551,615)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">integer</span></code> (знаковое целое число в диапазоне от -9,223,372,036,854,775,808 до 9,223,372,036,854,775,807)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">number</span></code> (беззнаковое целое число, либо знаковое целое число, либо число с плавающей точкой)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">string</span></code> (строковое значение, т.е. любая последовательность октетов)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">scalar</span></code> (логическое значение, либо число, либо строковое значение)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">array</span></code> (последовательность чисел для <a class="reference internal" href="singlehtml.html#box-index-rtree"><span class="std std-ref">RTREE-индексов</span></a>)</p>
</li>
</ul>
<p>В рамках нашего примера рассмотрим следующий запрос:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">hash&#39;</span><span class="p">,</span> <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
</pre></div>
</div>
<p>В результате у всех кортежей в пространстве <cite>tester</cite> должно быть поле с номером 1, содержащее беззнаковое целое число.</p>
<p>Определения пространств и индексов хранятся в системных пространствах. Можно (с некоторыми ограничениями) на ходу добавлять, удалять и менять эти определения. Правила синтаксиса в определениях пространств и индексов даны в разделе <a class="reference internal" href="#index-box-library"><span class="std std-ref">Библиотека &quot;box&quot;</span></a>.</p>
</div>
<div class="section" id="data-types">
<h5>3.1.4. Типы данных<a class="headerlink" href="#data-types" title="Ссылка на этот заголовок">¶</a></h5>
<p>Tarantool работает с числами (numbers), строками (strings), логическими значениями (booleans), таблицами (tables) и пользовательскими типами данных (userdata).</p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="18%" />
<col width="41%" />
<col width="23%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">Общий тип</p>
</th>
<th class="head"><p class="first last">Особый тип</p>
</th>
<th class="head"><p class="first last">Результат Lua type()</p>
</th>
<th class="head"><p class="first last">Пример</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>scalar</td>
<td>number</td>
<td>&quot;<a class="reference external" href="http://www.lua.org/pil/2.3.html">number</a>&quot;</td>
<td>12345</td>
</tr>
<tr class="row-odd"><td>scalar</td>
<td>string</td>
<td>&quot;<a class="reference external" href="http://www.lua.org/pil/2.4.html">string</a>&quot;</td>
<td>'A B C'</td>
</tr>
<tr class="row-even"><td>scalar</td>
<td>boolean</td>
<td>&quot;<a class="reference external" href="http://www.lua.org/pil/2.2.html">boolean</a>&quot;</td>
<td>true</td>
</tr>
<tr class="row-odd"><td>scalar</td>
<td>nil</td>
<td>&quot;<a class="reference external" href="http://www.lua.org/pil/2.1.html">nil</a>&quot;</td>
<td>nil</td>
</tr>
<tr class="row-even"><td>compound</td>
<td>Lua table</td>
<td>&quot;<a class="reference external" href="http://www.lua.org/pil/2.5.html">table</a>&quot;</td>
<td>table: 0x410f8b10</td>
</tr>
<tr class="row-odd"><td>compound</td>
<td>tuple</td>
<td>&quot;<a class="reference external" href="http://www.lua.org/pil/28.1.html">Userdata</a>&quot;</td>
<td>12345: {'A B C'}</td>
</tr>
</tbody>
</table>
<p>In Lua, a <em>number</em> is double-precision floating-point, but Tarantool allows both
integer and floating-point values. Tarantool will try to store a number as
floating-point if the value contains a decimal point or is very large (greater
than 100 billion = 1e14), otherwise Tarantool will store it as an integer. To
ensure that even very large numbers will be treated as integers, use the
<a class="reference internal" href="singlehtml.html#other-tonumber64"><span class="std std-ref">tonumber64</span></a> function, or the <code class="docutils literal"><span class="pre">LL</span></code> (Long Long) suffix,
or the <code class="docutils literal"><span class="pre">ULL</span></code> (Unsigned Long Long) suffix. Here are examples of numbers using
regular notation, exponential notation, the ULL suffix, and the tonumber64
function: <code class="docutils literal"><span class="pre">-55</span></code>, <code class="docutils literal"><span class="pre">-2.7e+20</span></code>, <code class="docutils literal"><span class="pre">100000000000000ULL</span></code>,
<code class="docutils literal"><span class="pre">tonumber64('18446744073709551615')</span></code>.</p>
<p>For database storage, Tarantool uses MsgPack rules. Storage is variable-length,
so the smallest number requires only one byte but the largest number requires
nine bytes. When a field has an 'unsigned' index, all values must be unsigned integers
between 0 and 18,446,744,073,709,551,615.</p>
<p>Тип <em>string</em> (строка) — это последовательность байтов, имеющая переменную длину. Как правило, строки представлены в виде алфавитно-числовых символы, заключенных в одинарные кавычки.</p>
<p>Тип <em>boolean</em> (логический) может иметь только значения <code class="docutils literal"><span class="pre">true</span></code> или <code class="docutils literal"><span class="pre">false</span></code>.</p>
<p>Тип <em>nil</em> (нулевой) может иметь только одно значение, также называемое <em>nil</em>, но часто отображаемое как <em>null</em>. Нулевое значение можно сравнивать со значениями любых типов с помощью операторов == (равен) или ~= (не равен), но никакие другие операции для нулевых значений не доступны. Нулевые значения также нельзя использовать в Lua-таблицах; вместо нулевого значения в таком случае можно указать <a class="reference internal" href="singlehtml.html#yaml-null"><span class="std std-ref">yaml.NULL</span></a>, либо <a class="reference internal" href="singlehtml.html#json-null"><span class="std std-ref">json.NULL</span></a>, либо <a class="reference internal" href="singlehtml.html#msgpack-null"><span class="std std-ref">msgpack.NULL</span></a>.</p>
<p>Тип <em>tuple</em> возвращается в формате YAML, например <code class="docutils literal"><span class="pre">-</span> <span class="pre">[120,</span> <span class="pre">'a',</span> <span class="pre">'b',</span> <span class="pre">'c']</span></code>. Некоторые функции могут возвращать таблицы с несколькими кортежами. Скалярная величина может быть конвертирована в кортеж с 1 полем. Lua-таблица может содержать все типы полей, допустимые для кортежей, кроме нулевого типа (nil).</p>
<p>Некоторые из этих типов данных подходят для <a class="reference internal" href="singlehtml.html#details-about-index-field-types"><span class="std std-ref">индексируемых полей</span></a>.</p>
<p>См. также примеры кортежей в разделе про модуль <a class="reference internal" href="singlehtml.html#box-tuple"><span class="std std-ref">box.tuple</span></a>.</p>
</div>
<div class="section" id="operations">
<h5>3.1.5. Операции<a class="headerlink" href="#operations" title="Ссылка на этот заголовок">¶</a></h5>
<p>Основные операции — это пять операций для изменения данных (INSERT, UPDATE, UPSERT, DELETE, REPLACE) и одна операция для возвращения данных (SELECT). Также в Tarantool'е поддерживаются второстепенные операции типа PING, которые можно использовать только в рамках бинарного протокола. Кроме того, в Tarantool'е есть операции для <a class="reference internal" href="singlehtml.html#box-index-index-pairs"><span class="std std-ref">индекс-итераторов</span></a>, которые можно использовать только в коде на языке Lua. (Индекс-итераторы нужны для обхода индексов от одного ключа к другому и дают возможность пользоваться преимуществами разных типов индексов, например вычислять значение выражений логического типа при обходе BITSET-индексов или двигаться в порядке убывания значений при обходе TREE-индексов.)</p>
<p>Шесть примеров основных операций:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">-- Добавляем новый кортеж в набор кортежей с именем tester.</span>
<span class="go">-- Первое поле, field[1], будет равно 999 (тип = unsigned).</span>
<span class="go">-- Второе поле, field[2], будет равно &#39;Taranto&#39; (тип = string).</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">999</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Taranto&#39;</span><span class="p">}</span>

<span class="go">-- Обновляем кортеж, меняем значение поля field[2].</span>
<span class="go">-- Условие &quot;{999}&quot;, содержащее значение ключа, которое нужно</span>
<span class="go">-- искать в первичном индексе, построенном по первому полю</span>
<span class="go">-- кортежа, является обязательным, поскольку запросам update()</span>
<span class="go">-- всегда требуется условие, определяющее значение первичного</span>
<span class="go">-- ключа, в данном случае field[1].</span>
<span class="go">-- Условие &quot;{{&#39;=&#39;, 2, &#39;Tarantino&#39;}}&quot; определяет, что полю field[2] нужно</span>
<span class="go">-- присвоить новое значение.</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="mi">999</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tarantino&#39;</span><span class="p">}})</span>

<span class="go">-- Выполняем операцию upsert() для кортежа и снова меняем</span>
<span class="go">-- значение поля field[2].</span>
<span class="go">-- Синтаксис запроса upsert() аналогичен синтаксису update(),</span>
<span class="go">-- но возвращаемые значения у этих запросов разные.</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">upsert</span><span class="p">({</span><span class="mi">999</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tarantism&#39;</span><span class="p">}})</span>

<span class="go">-- Производим замену кортежа с помощью replace(), добавляем новое поле.</span>
<span class="go">-- Это можно сделать и с помощью запроса update(),</span>
<span class="go">-- но такой вариант часто оказывается более сложным.</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">{</span><span class="mi">999</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tarantella&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tarantula&#39;</span><span class="p">}</span>

<span class="go">-- Возвращаем значение кортежа.</span>
<span class="go">-- Условие &quot;{999}&quot; все еще обязательно, хотя оно и не должно</span>
<span class="go">-- содержать значение первичного ключа.</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">999</span><span class="p">}</span>

<span class="go">-- Удаляем кортеж.</span>
<span class="go">-- Условие, определяющее значение первичного ключа,</span>
<span class="go">-- снова является обязательным.</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">delete</span><span class="p">{</span><span class="mi">999</span><span class="p">}</span>
</pre></div>
</div>
<p>Как Tarantool выполняет основные операции? Давайте рассмотрим это на следующем примере:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="mi">3</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">size&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">}})</span>
</pre></div>
</div>
<p>Это аналогично следующему выражению на языке SQL:</p>
<div class="highlight-SQL"><div class="highlight"><pre><span></span><span class="k">UPDATE</span> <span class="n">tester</span> <span class="k">SET</span> <span class="ss">&quot;field[2]&quot;</span> <span class="o">=</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="ss">&quot;field[3]&quot;</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">WHERE</span> <span class="ss">&quot;field[[1]&quot;</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<ol class="arabic simple">
<li>If this is happening on a remote client, then the client parses the statement
and changes it to a binary-protocol instruction which has already been
checked, and which the server can understand without needing to parse
everything again. The client ships a packet to the server.</li>
<li>The server's “transaction processor” thread uses the primary-key index on
field[1] to find the location of the tuple in memory. It determines that the
tuple can be updated (not much can go wrong when you're merely changing an
unindexed field value to something shorter).</li>
<li>The transaction processor thread sends a message to the write-ahead logging
(WAL) thread.</li>
</ol>
<p>At this point, a <em>yield</em> takes place. To know the significance of that -- and
it's quite significant -- you have to know a few facts and a few new words.</p>
<div class="fact admonition">
<p class="first admonition-title">ФАКТ #1:</p>
<p class="last">There is only one transaction processor thread. Some people are used to the
idea that there can be multiple threads operating on the database, with
(say) thread #1 reading row #x while thread #2 writes row #y. With Tarantool
no such thing ever happens. Only the transaction processor thread can access
the database, and there is only one transaction processor thread for each
instance of the server.</p>
</div>
<div class="fact admonition">
<p class="first admonition-title">ФАКТ #2:</p>
<p class="last">The transaction processor thread can handle many <em>fibers</em>. A fiber is a set
of computer instructions that may contain &quot;yield&quot; signals. The transaction
processor thread will execute all computer instructions until a yield, then
switch to execute the instructions of a different fiber. Thus (say) the
thread reads row #x for the sake of fiber #1, then writes row #y for the sake
of fiber #2.</p>
</div>
<div class="fact admonition" id="index-yields-must-happen">
<p class="first admonition-title">ФАКТ #3:</p>
<p class="last">Yields must happen, otherwise the transaction processor thread would stick
permanently on the same fiber. There are <a class="reference internal" href="singlehtml.html#atomic-the-implicit-yield-rules"><span class="std std-ref">implicit yields</span></a>:
every data-change operation or network-access causes an implicit yield, and
every statement that goes through the tarantool client causes an implicit
yield. And there are explicit yields: in a Lua function one can and should
add “yield” statements to prevent hogging. This is called <em>cooperative multitasking</em>.</p>
</div>
<p>Поскольку все операции, связанные с изменением данных, заканчиваются неявной передачей управления и неявным коммитом, и поскольку каждая такая операция может затрагивать не более одного кортежа, то не возникает нужды в блокировках. Для примера рассмотрим следующую Lua-функцию, которая осуществляет три операции в Tarantool'е:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">999</span><span class="p">}</span>             <span class="c1">-- не происходит ни передачи управления, ни коммита</span>
<span class="n">s</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="o">...</span><span class="p">},{{</span><span class="o">...</span><span class="p">}})</span>   <span class="c1">-- происходит и передача управления, и коммит</span>
<span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">999</span><span class="p">}</span>             <span class="c1">-- не происходит ни передачи управления, ни коммита</span>
</pre></div>
</div>
<p>Последовательность операций “SELECT + UPDATE” является атомарной транзакцией: функция сохраняет базу данных в согласованном виде, пока не отработает UPDATE. А в случае “UPDATE + SELECT” согласованности нет, поскольку после операции UPDATE поток обработки транзакций может переключится на другой файбер и удалить тот кортеж, что был обновлен в рамках предыдущей операции UPDATE.</p>
<p>Примечание про движок: в движке vinyl передача управления происходит по-другому, см. раздел про <a class="reference internal" href="singlehtml.html#vinyl-diff"><span class="std std-ref">различия между движками memtx и vinyl</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p>Примечание про составные транзакции:</p>
<p class="last">В разделе про <a class="reference internal" href="singlehtml.html#atomic-atomic-execution"><span class="std std-ref">атомарные операции</span></a> описано, как передачу управления можно отложить.</p>
</div>
<p>Посколько блокировки не используются, а запись на диск производится только при работе с WAL-файлом, то транзакции в Tarantool'е обычно совершаются быстро. Кроме того, если мы имеем дело с мощным многоядерным процессором, то Tarantool-сервер может задействовать для работы не все потоки такого процессора, и продвинутые пользователи могут безболезненно запускать второй Tarantool-сервер на том же процессоре.</p>
<p>См. также примеры с запросами в регрессионных тестах для Tarantool'а (<a class="reference external" href="https://github.com/tarantool/tarantool/tree/1.7/test/box">https://github.com/tarantool/tarantool/tree/1.7/test/box</a>). Полное описание грамматики поддерживаемых в Tarantool'е функций для манипулирования данными см. далее в этой главе.</p>
<p>Не все операции в Tarantool'е можно выразить с помощью функций по манипулированию данными или с помощью языка Lua. Чтобы получить доступ ко всем возможностями манипулирования данными, вам понадобится <a class="reference internal" href="singlehtml.html#index-box-connectors"><span class="std std-ref">коннектор для Perl, PHP, Python или другого языка программирования</span></a>. Бинарный клиент-серверный протокол для коннекторов является открытым. Документация по нему доступна в виде аннотированных <a class="reference internal" href="singlehtml.html#box-protocol-iproto-protocol"><span class="std std-ref">BNF-диаграмм</span></a>.</p>
</div>
<div class="section" id="saving-to-disk">
<h5>3.1.6. Saving to disk<a class="headerlink" href="#saving-to-disk" title="Ссылка на этот заголовок">¶</a></h5>
<p>Tarantool сохраняет данные и информацию об изменениях в нескольких WAL-файлах (write-ahead log). Записью в WAL занимается отдельный поток. Он ловит все запросы, которые могут привести к изменению данных в базе, например <code class="docutils literal"><span class="pre">box.schema.create</span></code> или <code class="docutils literal"><span class="pre">box.space.insert</span></code>. Как правило, запись о запросе, включая служебные поля и флаги, делается в WAL-файл немедленно. Это обеспечивает сохранность данных, поскольку, даже если данные из памяти утеряны вследствие перебоя в электроснабжении, Tarantool восстановит их автоматически при следующем старте: он загрузит данные из WAL-файлов, а затем применит все записанные в WAL-файлах запросы (это называется &quot;процесс восстановления&quot;). Пользователи могут менять частоту записи или вовсе отключать запись в WAL с помощью параметра <a class="reference internal" href="singlehtml.html#cfg-binary-logging-snapshots-wal-mode"><span class="std std-ref">wal_mode</span></a>.</p>
<p>Tarantool также сохраняет ряд файлов со статическими снимками данных (snapshots). Файл со снимком — это дисковая копия всех данных в базе на какой-то момент. Вместо того, чтобы зачитывать все WAL-файлы, появившиеся с момента создания базы, Tarantool в процессе восстановления может загрузить самый свежий снимок и затем зачитать только те WAL-файлы, которые были сделаны с момента сохранения снимка. Снимки могут делаться автоматически, или же пользователи могут создавать их сами в любой момент с помощью запроса <a class="reference internal" href="singlehtml.html#admin-snapshot"><span class="std std-ref">box.snapshot()</span></a>.</p>
<p>См. подробности о работе потока записи в WAL в разделе  <a class="reference internal" href="singlehtml.html#b-internals"><span class="std std-ref">Детали реализации</span></a>.</p>
</div>
<div class="section" id="data-manipulation">
<h5>3.1.7. Манипулирование данными<a class="headerlink" href="#data-manipulation" title="Ссылка на этот заголовок">¶</a></h5>
<p>Основные запросы для <em>манипулирования данными</em> — это <code class="docutils literal"><span class="pre">insert</span></code>, <code class="docutils literal"><span class="pre">replace</span></code>, <code class="docutils literal"><span class="pre">update</span></code>, <code class="docutils literal"><span class="pre">upsert</span></code>, <code class="docutils literal"><span class="pre">delete</span></code>, <code class="docutils literal"><span class="pre">select</span></code>. Все они реализованы в библиотеке <code class="docutils literal"><span class="pre">box</span></code>. Многие из этих запросов могут возвращать данные. Как правило, и вводимые, и возвращаемые значения являются Lua-таблицами.</p>
<p>Lua-синтаксис в данных функциях может различаться. Далее приводятся варианты таких различий на примере SELECT-запросов. Аналогичные правила существуют и для остальных функций. В каждом из приведенных примеров выполняются следующие действия: производится выборка по набору кортежей из пространства с именем 'tester', где значение поля, которое соответствует ключу в первичном индексе, равно 1. Также во всех примерах мы подразумеваем, что числовой идентификатор пространства 'tester' равен 512, но это верно только для нашей тестовой базы.</p>
<p id="index-object-reference">Во-первых, есть пять <em>способов ссылки на объект</em>:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">-- #1 имя_модуля . имя_вложенного_модуля . имя_объекта</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="go">-- #2 вместо имени объекта указываем литерал в квадратных скобках</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">]:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="go">-- #3 вместо имени объекта указываем числовой идентификатор в квадратных скобках</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="mi">512</span><span class="p">]:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="go">-- #4 вместо литерала, обозначающего имя объекта, указываем переменную</span>
<span class="gp">tarantool&gt; </span><span class="n">variable</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">tester&#39;</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">variable</span><span class="p">]:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="go">-- #5 указываем переменную вместо ссылки на весь объект</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
<p>Для примеров в остальной части документации мы будем, как правило, использовать вариант синтаксиса #1, например &quot;<code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">tester</span></em><span class="pre">:</span></code>&quot;. Но вы можете с тем же успехом пользоваться любым из пяти описанных выше вариантов.</p>
<p>Также мы в дальнейшем будем использовать синтаксис типа  &quot;<code class="code docutils literal"><span class="pre">space_object:</span></code>&quot; для ссылки на пространства (как в приведенных выше примерах) и &quot;<code class="code docutils literal"><span class="pre">index_object:</span></code>&quot; для ссылки на индексы (например, <code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">tester</span></em><span class="pre">.index.</span><em><span class="pre">primary</span></em><span class="pre">:</span></code>).</p>
<p>Во-вторых, есть семь <em>способов задания параметров</em>:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">-- #1</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="go">-- #2</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">1</span><span class="p">})</span>
<span class="go">-- #3</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">-- #4</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="go">-- #5</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">1</span><span class="p">},{</span><span class="n">iterator</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">EQ&#39;</span><span class="p">})</span>
<span class="go">-- #6</span>
<span class="gp">tarantool&gt; </span><span class="n">variable</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="n">variable</span><span class="p">}</span>
<span class="go">-- #7</span>
<span class="gp">tarantool&gt; </span><span class="n">variable</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
</pre></div>
</div>
<p>Значение первичного ключа заключается в фигурные скобки. Если же этот первичный ключ является составным, то и значение будет составным, например <code class="docutils literal"><span class="pre">...select{1,2,3}</span></code>. Фигурные скобки в свою очередь могут заключаться в круглые скобки — например, <code class="docutils literal"><span class="pre">...select({...})</span></code>. Это опциональный вариант синтаксиса, и он необходим только в том случае, если нужно передать что-то помимо первичного ключа, как в примере #5. Вместо значений-литералов — например, 1 (скалярное значение) или {1} (Lua-таблица) — можно использовать имена переменных, как в примерах #6 и #7. Хотя в некоторых случаях фигурные скобки можно опускать, мы рекомендуем всегда их использовать. Так вы явно обозначите, что значение имеет тип &quot;Lua-таблица&quot;. В примерах и описаниях в документации мы везде используем фигурные скобки, например &quot;{1}&quot;.  Но как и в случае со ссылками на объект, вы можете пользоваться любым допустимым вариантом синтаксиса.</p>
<p>Все функции для манипулирования данными оперируют наборами кортежей. Однако, поскольку первичные ключи всегда уникальны, количество кортежей в таком наборе всегда равно 0 или 1. Единственным исключением является функция <code class="docutils literal"><span class="pre">box.space...select</span></code>, которая может брать на вход как первичный, так и вторичный ключ.</p>
</div>
<div class="section" id="index-operations">
<h5>3.1.8. Операции с индексами<a class="headerlink" href="#index-operations" title="Ссылка на этот заголовок">¶</a></h5>
<p>Операции с индексами производятся автоматически. Если запрос по манипулированию данными меняет данные в кортеже, то меняются и ключи в индексе для данного кортежа. Поэтому пользователю нужно знать только как и зачем задавать индексы.</p>
<p>Простая операция для создания индекса, которую мы рассматривали ранее, имела следующий вид:</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span>:samp:`box.space.{имя-пространства}:create_index(&#39;{имя-индекса}&#39;)`
</pre></div>
</div>
<p>По умолчанию, при этом создается TREE-индекс по первому полю (обычно его называют &quot;Field#1&quot;) для всех кортежей в пространстве. Предполагается, что индексируемое поле является числовым.</p>
<p>Также возможны следующие варианты:</p>
<ol class="arabic">
<li><p class="first">Индексируемое поле может быть строкой, а не числом.</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:create_index('</span><em><span class="pre">index-name</span></em><span class="pre">',</span> <span class="pre">{parts</span> <span class="pre">=</span> <span class="pre">{1,</span> <span class="pre">'string'}})</span></code>
</pre>
<p>Обычный индекс, как правило, строится по полям одного из двух типов: 'NUM' = числовой (numeric) = любое неотрицательное целое число, либо 'STR' = строка (string) = любая последовательность байтов. Числа в индексе упорядочены по числовой прямой (например, число 2345 больше, чем число 500), а строки — по коду первого байта, затем по коду второго, третьего и т.д. (и теперь строка '2345' будет меньше, чем строка '500').</p>
<p>Подробнее о других типах индексов см. в описании функции <a class="reference internal" href="singlehtml.html#box-space-create-index"><span class="std std-ref">create_index</span></a>.</p>
</li>
<li><p class="first">Индекс может строиться по нескольким полям.</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:create_index('</span><em><span class="pre">index-name</span></em><span class="pre">',</span> <span class="pre">{</span>
&nbsp;&nbsp;&nbsp; <span class="pre">parts</span> <span class="pre">=</span> <span class="pre">{3,</span> <span class="pre">'unsigned',</span> <span class="pre">2,</span> <span class="pre">'string'}</span>
<span class="pre">})</span></code>
</pre>
<p>В обычном индексе может быть максимум 255 частей. Каждая часть характеризуется номером поля и его типом.</p>
</li>
<li><p class="first">Индекс может быть неуникальным.</p>
<pre class="highlight literal-block">
box.space.*space-name*:create_index('<em>index-name</em>', { unique = false })
</pre>
<p>Первичный индекс для кортежа должен строиться по уникальным значениям полей, но остальные (вторичные) индексы могут строиться по неуникальным значениям.</p>
</li>
<li><p class="first">Индекс может представлять собой не только дерево.</p>
<pre class="highlight literal-block">
box.space.*space-name*:create_index('<em>index-name</em>', { type = 'hash' })
</pre>
<p>Чаще всего индекс — это дерево (по умолчанию) или хеш (в этом случае индекс должен быть уникальным; в определенных случаях такой индекс занимает меньше места и поиск по нему работает быстрее). Третий тип индекса — это набор битов (bitset); это неуникальный индекс, предназначенный для работы с различными бинарными значениями. Четвертый тип индекса — это R-дерево; это тоже неуникальный индекс, предназначенный для работы с массивами, а не со строками или беззнаковыми числами.</p>
</li>
</ol>
<p>Наличие индексов никак не влияет на синтаксис запросов на изменение данных. А вот SELECT-запросы, благодаря индексам, становятся более разнообразными.</p>
<p>Вот простой SELECT-запрос, который мы рассматривали ранее:</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span>:extsamp:`box.space.{*{имя-пространства}*}:select({*{значение}*})`
</pre></div>
</div>
<p>По умолчанию, такой запрос ищет нужный кортеж по значению в первом (первичном) индексе. Поскольку первичный индекс всегда уникален, то данный запрос вернет не более одного кортежа.</p>
<p>Также возможны следующие варианты:</p>
<ol class="arabic">
<li><p class="first">Помимо условия равенства, при поиске могут использоваться и другие условия сравнения.</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select(value,</span> <span class="pre">{iterator</span> <span class="pre">=</span> <span class="pre">'GT'})</span></code>
</pre>
<p>Можно использовать следующие операторы сравнения: LT (меньше), LE (меньше или равно), EQ (равно), REQ (неравно), GE (больше или равно), GT (больше). Сравнения имеют смысл только для индексов типа 'tree'.</p>
<p>Этот вариант поиска может вернуть более одного кортежа. В таком случае кортежи будут отсортированы в порядке убывания по ключу (если использовался оператор LT, LE или REQ), либо в порядке возрастания (во всех остальных случаях).</p>
</li>
<li><p class="first">Поиск может производиться по вторичному индексу.</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">.index.</span><em><span class="pre">index-name</span></em><span class="pre">:select(value)</span></code>
</pre>
<p>При поиске по первичному индексу имя индекса можно не указывать. При поиске же по вторичному индексу имя индекса указывать необходимо.</p>
</li>
<li><p class="first">Поиск может производиться как по всему ключу, так и по его частям.</p>
<pre class="highlight literal-block">
-- Suppose an index has two parts
<code class="samp docutils literal"><span class="pre">tarantool&gt;</span> <span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">.index.</span><em><span class="pre">index-name</span></em><span class="pre">.parts</span></code>
---
- - type: unsigned
    fieldno: 1
  - type: string
    fieldno: 2
...
-- Suppose the space has three tuples
<code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select()</span></code>
---
- - [1, 'A']
  - [1, 'B']
  - [2, '']
...
</pre>
<p>Поиск может производиться по всем полям (в этом случае используется таблица значений):</p>
<pre class="highlight literal-block">
<code class="extsamp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select({1,</span> <span class="pre">'A'})</span></code>
</pre>
<p>Либо же по одному полю (в этом случае используется таблица или скалярное значение):</p>
<pre class="highlight literal-block">
<code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select(1)</span></code>
</pre>
<p>Во втором случае Tarantool вернет два кортежа: <code class="docutils literal"><span class="pre">{1,</span> <span class="pre">'A'}</span></code> и <code class="docutils literal"><span class="pre">{1,</span> <span class="pre">'B'}</span></code>. При необходимости можно задать даже нулевые поля, в результате чего Tarantool вернет все три кортежа.</p>
</li>
</ol>
<p><strong>Примеры:</strong></p>
<ul>
<li><p class="first">Пример работы с BITSET-индексом:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">bitset_example&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">bitset&#39;</span><span class="p">,{</span><span class="n">unique</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">BITSET&#39;</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">bitset_example</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">bitset</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">iterator</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">BITS_ANY_SET&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Мы получим следующий результат:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span> <span class="nv">7</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">4</span><span class="p p-Indicator">,</span> <span class="nv">3</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>поскольку (7 AND 2) не равно 0 и (3 AND 2) не равно 0.</p>
<p>При поиске по BITSET-индексам можно использовать операторы BITS_ANY_SET, BITS_ALL_SET, BITS_ALL_NOT_SET, EQ и ALL.</p>
</li>
<li><p class="first">Пример работы с RTREE-индексом:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">rtree_example&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">rtree_example</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">rtree_example</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">rtree&#39;</span><span class="p">,{</span><span class="n">unique</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">RTREE&#39;</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">ARRAY&#39;</span><span class="p">}})</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">rtree_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">}}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">rtree_example</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">}}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">rtree_example</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">rtree</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GT&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Мы получим следующий результат:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">9</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">]]</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>поскольку прямоугольник с углами в координатах 4,7,5,9 лежит целиком внутри прямоугольника с углами в координатах 3,5,9,10.</p>
<p>При поиске по RTREE-индексам можно использовать операторы GT, GE, LT, LE, OVERLAPS и NEIGHBOR.</p>
</li>
</ul>
</div>
<div class="section" id="the-box-library">
<span id="index-box-library"></span><h5>3.1.9. Библиотека &quot;box&quot;<a class="headerlink" href="#the-box-library" title="Ссылка на этот заголовок">¶</a></h5>
<p>Наряду с исполнением кусков кода на Lua и заданием собственных функций, вы можете использовать функционал СУБД, предоставляемый Lua-библиотекой <code class="docutils literal"><span class="pre">box</span></code> и ее вложенными модулями.</p>
</div>
</div>
<div class="section" id="submodules-of-the-box-library">
<h4>3.2. Вложенные модули из библиотеки &quot;box&quot;<a class="headerlink" href="#submodules-of-the-box-library" title="Ссылка на этот заголовок">¶</a></h4>
<p>Содержимое библиотеки``box`` можно просматривать во время исполнения с помощью команды <code class="docutils literal"><span class="pre">box</span></code> (без аргументов). Библиотека <code class="docutils literal"><span class="pre">box</span></code> содержит следующие вложенные модули: <code class="docutils literal"><span class="pre">box.schema</span></code>, <code class="docutils literal"><span class="pre">box.tuple</span></code>, <code class="docutils literal"><span class="pre">box.space</span></code>, <code class="docutils literal"><span class="pre">box.index</span></code>, <code class="docutils literal"><span class="pre">box.cfg</span></code>, <code class="docutils literal"><span class="pre">box.info</span></code>, <code class="docutils literal"><span class="pre">box.slab</span></code>, <code class="docutils literal"><span class="pre">box.stat</span></code>. Каждый вложенный модуль содержит по крайней мере одну Lua-функцию, а некоторые вложенные модули также содержат поля-члены. Функции во вложенных модулях предназначены для определения данных (операции CREATE и DROP), манипулирования данными (INSERT DELETE UPDATE UPSERT SELECT REPLACE) и просмотра данных (просмотр содержимого пространств и конфигурации сервера).</p>
<div class="table container">
<p><strong>Факторы, которые могут влиять на быстродействие функций для манипулирования данными из библиотеки box</strong></p>
<table border="1" class="left-align-column-1 left-align-column-2 docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><p class="first last">Размер индекса</p>
</td>
<td><p class="first last">Количество ключей в индексе равно количеству кортежей в наборе данных. В случае с TREE-индексом: с ростом количества ключей увеличивается время поиска, хотя зависимость здесь, конечно же, не линейная. В случае с HASH-индексом: с ростом количества ключей увеличивается объем используемой памяти, но количество низкоуровневых шагов остается примерно тем же.</p>
</td>
</tr>
<tr class="row-even"><td><p class="first last">Тип индекса</p>
</td>
<td><p class="first last">Как правило, поиск по HASH-индексу работает быстрее, чем по TREE-индексу, если в наборе есть более одного кортежа.</p>
</td>
</tr>
<tr class="row-odd"><td><p class="first last">Количество обращений к индексам</p>
</td>
<td><p class="first last">Обычно для выборки значений одного кортежа используется только один индекс. Но при обновлении значений в кортеже требуется N обращений, если у набора кортежей есть N индексов.</p>
</td>
</tr>
<tr class="row-even"><td><p class="first last">Количество обращений к кортежам</p>
</td>
<td><p class="first last">Некоторые запросы, например SELECT, могут возвращать несколько кортежей. Как правило, это наименее важный фактор из всех.</p>
</td>
</tr>
<tr class="row-odd"><td><p class="first last">Настройки WAL</p>
</td>
<td><p class="first last">Важным параметром для записи в WAL является <a class="reference internal" href="singlehtml.html#cfg-binary-logging-snapshots-wal-mode"><span class="std std-ref">wal_mode</span></a>. Если запись в WAL отключена или задана запись с задержкой, но этот фактор не так важен. Если же запись в WAL производится при каждом запросе на изменение данных, то при каждом таком запросе приходится ждать, пока отработает обращение к более медленному диску, и данный фактор становится важнее всех остальных.</p>
</td>
</tr>
</tbody>
</table>
</div>
<p>Далее в описании каждой функции для манипулирования данными будет дано примечание, какие из перечисленных выше факторов могут влиять на ее быстродействие.</p>
</div>
<div class="section" id="the-two-storage-engines-memtx-and-vinyl">
<span id="index-two-storage-engines"></span><h4>3.3. Два движка базы данных: memtx и vinyl<a class="headerlink" href="#the-two-storage-engines-memtx-and-vinyl" title="Ссылка на этот заголовок">¶</a></h4>
<p>Движок для работы с данными — это набор инструкций очень низкого уровня, которые задают логику хранения и доступа к значениям полей кортежей. В Tarantool'е есть 2 движка: memtx (для работы с данными в памяти) и vinyl (для работы с данными на диске). Чтобы в конфигурации Tarantool'а указать движок vinyl, добавьте условие <code class="docutils literal"><span class="pre">engine</span> <span class="pre">=</span> <span class="pre">'vinyl'</span></code>. В текущей документации главный акцент сделан на использовании движка memtx, поскольку он используется по умолчанию и появился раньше vinyl'а. В то же время vinyl является полностью рабочим движком для работы с данными вида &quot;ключ-значение&quot;, и он подойдет тем, кто хочет хранить данные непосредственно на диске и таким образом уменьшить время восстановления и получить возможность работы с базой большего объема. Пояснения по архитектуре и результаты сравнительных тестов на быстродействие приведены в Приложении D: <a class="reference internal" href="singlehtml.html#index-vinyl"><span class="std std-ref">vinyl</span></a>. С другой стороны, в vinyl'е нет некоторых функций и опций, которые есть в memtx'е. Далее в документации для всех таких случаев даны примечания, начинающиеся со слов &quot;Примечание про движок: vinyl&quot;. А в конце данной главы приведен обзор всех <a class="reference internal" href="singlehtml.html#vinyl-diff"><span class="std std-ref">отличий между движками memtx и vinyl</span></a>.</p>
</div>
<div class="section" id="library-reference">
<h4>3.4. Library reference<a class="headerlink" href="#library-reference" title="Ссылка на этот заголовок">¶</a></h4>
<div class="toctree-wrapper compound">
<span id="document-book/box/box_schema"></span><div class="section" id="lua-module.box.schema">
<span id="submodule-box-schema"></span><span id="box-schema"></span><h5>3.4.1. Вложенный модуль <cite>box.schema</cite><a class="headerlink" href="#lua-module.box.schema" title="Ссылка на этот заголовок">¶</a></h5>
<p>The <code class="docutils literal"><span class="pre">box.schema</span></code> submodule has data-definition functions
for spaces, users, roles, and function tuples.</p>
<span class="target" id="box-schema-space-create"></span><dl class="function">
<dt id="lua-функция.box.schema.space.create">
<em class="property"> </em><code class="descclassname">box.schema.space.</code><code class="descname">create</code><big>(</big><em>space-name</em><span class="optional">[</span>, <em>{options}</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.schema.space.create" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create a space.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>space-name</strong> (<em>string</em>) -- name of space, which should not be a number
and should not contain special characters</li>
<li><strong>options</strong> (<em>table</em>) -- see &quot;Options for box.schema.space.create&quot; chart, below</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">space object</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">userdata</p>
</td>
</tr>
</tbody>
</table>
<div class="table container">
<p><strong>Options for box.schema.space.create</strong></p>
<table border="1" class="left-align-column-1 left-align-column-2 left-align-column-3 left-align-column-4 docutils">
<colgroup>
<col width="19%" />
<col width="42%" />
<col width="12%" />
<col width="27%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Effect</th>
<th class="head">Type</th>
<th class="head">Default</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>temporary</td>
<td>space is temporary</td>
<td>boolean</td>
<td>false</td>
</tr>
<tr class="row-odd"><td>id</td>
<td>unique identifier</td>
<td>number</td>
<td>last space's id, +1</td>
</tr>
<tr class="row-even"><td>field_count</td>
<td>fixed field count</td>
<td>number</td>
<td>0 i.e. not fixed</td>
</tr>
<tr class="row-odd"><td>if_not_exists</td>
<td>no error if
duplicate name</td>
<td>boolean</td>
<td>false</td>
</tr>
<tr class="row-even"><td>engine</td>
<td>storage engine =
<a class="reference internal" href="singlehtml.html#index-two-storage-engines"><span class="std std-ref">'memtx' or 'vinyl'</span></a></td>
<td>string</td>
<td>'memtx'</td>
</tr>
<tr class="row-odd"><td>user</td>
<td>user name</td>
<td>string</td>
<td>current user's name</td>
</tr>
<tr class="row-even"><td>format</td>
<td>field names+types</td>
<td>table</td>
<td>(blank)</td>
</tr>
</tbody>
</table>
</div>
<p>There are five <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">syntax variations</span></a> for object references targeting
space objects, for example <code class="samp docutils literal"><span class="pre">box.schema.space.drop(</span><em><span class="pre">space-id</span></em><span class="pre">)</span></code>
will drop a space. However, the common approach is to use functions
attached to the space objects, for example
<a class="reference internal" href="singlehtml.html#box-space-drop"><span class="std std-ref">space_object:drop()</span></a>.</p>
<p>Note re storage engine: vinyl does not support temporary spaces.</p>
</dd></dl>

<div class="section" id="example">
<h6>3.4.1.1. Пример<a class="headerlink" href="#example" title="Ссылка на этот заголовок">¶</a></h6>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">space55&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">space55&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">id</span> <span class="o">=</span> <span class="mi">555</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">temporary</span> <span class="o">=</span> <span class="kc">false</span>
<span class="gp">         &gt; </span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Space &#39;space55&#39; already exists</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">space55&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">if_not_exists</span> <span class="o">=</span> <span class="kc">true</span>
<span class="gp">         &gt; </span><span class="p">})</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>For an illustration with the <code class="docutils literal"><span class="pre">format</span></code> clause, see
<a class="reference internal" href="singlehtml.html#box-space-space"><span class="std std-ref">box.space._space</span></a> example.</p>
<p>After a space is created, usually the next step is to
<a class="reference internal" href="singlehtml.html#box-space-create-index"><span class="std std-ref">create an index</span></a> for it, and then it is
available for insert, select, and all the other <a class="reference internal" href="singlehtml.html#box-space"><span class="std std-ref">box.space</span></a> functions.</p>
<dl class="function">
<dt id="lua-функция.box.schema.user.create">
<em class="property"> </em><code class="descclassname">box.schema.user.</code><code class="descname">create</code><big>(</big><em>user-name</em><span class="optional">[</span>, <em>{options}</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.schema.user.create" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create a user.
For explanation of how Tarantool maintains user data, see
section <a class="reference internal" href="singlehtml.html#authentication-users"><span class="std std-ref">Users and the _user space</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>user-name</strong> (<em>string</em>) -- name of user, which should not be a number
and should not contain special characters</li>
<li><strong>options</strong> (<em>table</em>) -- <code class="docutils literal"><span class="pre">if_not_exists</span></code>, <code class="docutils literal"><span class="pre">password</span></code></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Примеры:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">X&#39;</span><span class="p">})</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">if_not_exists</span> <span class="o">=</span> <span class="kc">false</span><span class="p">})</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.user.drop">
<em class="property"> </em><code class="descclassname">box.schema.user.</code><code class="descname">drop</code><big>(</big><em>user-name</em><span class="optional">[</span>, <em>{options}</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.schema.user.drop" title="Ссылка на это определение">¶</a></dt>
<dd><p>Drop a user.
For explanation of how Tarantool maintains user data, see
section <a class="reference internal" href="singlehtml.html#authentication-users"><span class="std std-ref">Users and the _user space</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>user-name</strong> (<em>string</em>) -- the name of the user</li>
<li><strong>options</strong> (<em>table</em>) -- <code class="docutils literal"><span class="pre">if_exists</span></code></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Примеры:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">,{</span><span class="n">if_exists</span><span class="o">=</span><span class="kc">false</span><span class="p">})</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.user.exists">
<em class="property"> </em><code class="descclassname">box.schema.user.</code><code class="descname">exists</code><big>(</big><em>user-name</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.user.exists" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return true if a user exists; return false if a user does not exist.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>user-name</strong> (<em>string</em>) -- the name of the user</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">bool</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-schema-user-grant"></span><dl class="function">
<dt id="lua-функция.box.schema.user.grant">
<em class="property"> </em><code class="descclassname">box.schema.user.</code><code class="descname">grant</code><big>(</big><em>user-name</em>, <em>priveleges</em>, <em>object-type</em>, <em>object-name</em><span class="optional">[</span>, <em>{options}</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.schema.user.grant" title="Ссылка на это определение">¶</a></dt>
<dt>
<em class="property"> </em><code class="descclassname">box.schema.user.</code><code class="descname">grant</code><big>(</big><em>user-name</em>, <em>priveleges</em>, <em>'universe'</em><span class="optional">[</span>, <em>nil</em>, <em>{options}</em><span class="optional">]</span><big>)</big></dt>
<dt>
<em class="property"> </em><code class="descclassname">box.schema.user.</code><code class="descname">grant</code><big>(</big><em>user-name</em>, <em>role-name</em><span class="optional">[</span>, <em>nil</em>, <em>nil</em>, <em>{options}</em><span class="optional">]</span><big>)</big></dt>
<dd><p>Grant <a class="reference internal" href="singlehtml.html#authentication-privileges"><span class="std std-ref">privileges</span></a> to a user.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>user-name</strong> (<em>string</em>) -- the name of the user</li>
<li><strong>priveleges</strong> (<em>string</em>) -- 'read' or 'write' or 'execute' or a combination,</li>
<li><strong>object-type</strong> (<em>string</em>) -- 'space' or 'function'.</li>
<li><strong>object-name</strong> (<em>string</em>) -- name of object to grant permissions to</li>
<li><strong>role-name</strong> (<em>string</em>) -- name of role to grant to user.</li>
<li><strong>options</strong> (<em>table</em>) -- <code class="docutils literal"><span class="pre">grantor</span></code>, <code class="docutils literal"><span class="pre">if_not_exists</span></code></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>If <code class="samp docutils literal"><span class="pre">'function','</span><em><span class="pre">object-name</span></em><span class="pre">'</span></code> is specified, then a _func tuple with
that object-name must exist.</p>
<p><strong>Variation:</strong> instead of <code class="docutils literal"><span class="pre">object-type,</span> <span class="pre">object-name</span></code> say 'universe' which
means 'all object-types and all objects'.</p>
<p><strong>Variation:</strong> instead of <code class="docutils literal"><span class="pre">privilege,</span> <span class="pre">object-type,</span> <span class="pre">object-name</span></code> say
<code class="docutils literal"><span class="pre">role-name</span></code> (see section <a class="reference internal" href="singlehtml.html#authentication-roles"><span class="std std-ref">Roles</span></a>).</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">function&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">f&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read,write&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">universe&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Accountant&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read,write,execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">universe&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">X&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">universe&#39;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="p">{</span><span class="n">if_not_exists</span><span class="o">=</span><span class="kc">true</span><span class="p">}))</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.user.revoke">
<em class="property"> </em><code class="descclassname">box.schema.user.</code><code class="descname">revoke</code><big>(</big><em>user-name</em>, <em>privilege</em>, <em>object-type</em>, <em>object-name</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.user.revoke" title="Ссылка на это определение">¶</a></dt>
<dd><p>Revoke <a class="reference internal" href="singlehtml.html#authentication-privileges"><span class="std std-ref">privileges</span></a> from a user.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>user-name</strong> (<em>string</em>) -- the name of the user</li>
<li><strong>privilege</strong> (<em>string</em>) -- 'read' or 'write' or 'execute' or a combination</li>
<li><strong>object-type</strong> (<em>string</em>) -- 'space' or 'function'</li>
<li><strong>object-name</strong> (<em>string</em>) -- the name of a function or space</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>The user must exist, and the object must exist,
but it is not an error if the user does not have the privilege.</p>
<p><strong>Variation:</strong> instead of <code class="docutils literal"><span class="pre">object-type,</span> <span class="pre">object-name</span></code> say 'universe'
which means 'all object-types and all objects'.</p>
<p><strong>Variation:</strong> instead of <code class="docutils literal"><span class="pre">privilege,</span> <span class="pre">object-type,</span> <span class="pre">object-name</span></code> say
<code class="docutils literal"><span class="pre">role-name</span></code> (see section <a class="reference internal" href="singlehtml.html#authentication-roles"><span class="std std-ref">Roles</span></a>).</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">function&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">f&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read,write&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">universe&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Accountant&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.user.password">
<em class="property"> </em><code class="descclassname">box.schema.user.</code><code class="descname">password</code><big>(</big><em>password</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.user.password" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return a hash of a password.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>password</strong> (<em>string</em>) -- password</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">string</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">password</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">ЛЕНА&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.user.passwd">
<em class="property"> </em><code class="descclassname">box.schema.user.</code><code class="descname">passwd</code><big>(</big><span class="optional">[</span><em>user-name</em>, <span class="optional">]</span><em>password</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.user.passwd" title="Ссылка на это определение">¶</a></dt>
<dd><p>Associate a password with the user who is currently logged in.
or with another user.
Users who wish to change their own passwords should
use box.schema.user.passwd(password).
Administrators who wish to change passwords of other users should
use box.schema.user.passwd(user-name, password).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>user-name</strong> (<em>string</em>) -- user-name</li>
<li><strong>password</strong> (<em>string</em>) -- password</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">passwd</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">ЛЕНА&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">passwd</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">ЛЕНА&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.user.info">
<em class="property"> </em><code class="descclassname">box.schema.user.</code><code class="descname">info</code><big>(</big><span class="optional">[</span><em>user-name</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.schema.user.info" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return a description of a user's privileges.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>user-name</strong> (<em>string</em>) -- the name of the user.
This is optional; if it is not
supplied, then the information
will be for the user who is
currently logged in.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">info</span><span class="p">()</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Lena&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.role.create">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">create</code><big>(</big><em>role-name</em><span class="optional">[</span>, <em>{options}</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.create" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create a role.
For explanation of how Tarantool maintains role data, see
section <a class="reference internal" href="singlehtml.html#authentication-roles"><span class="std std-ref">Roles</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>role-name</strong> (<em>string</em>) -- name of role, which should not be a number
and should not contain special characters</li>
<li><strong>options</strong> (<em>table</em>) -- <code class="docutils literal"><span class="pre">if_not_exists</span></code></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Accountant&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Accountant&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">if_not_exists</span> <span class="o">=</span> <span class="kc">false</span><span class="p">})</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.role.drop">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">drop</code><big>(</big><em>role-name</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.drop" title="Ссылка на это определение">¶</a></dt>
<dd><p>Drop a role.
For explanation of how Tarantool maintains role data, see
section <a class="reference internal" href="singlehtml.html#authentication-roles"><span class="std std-ref">Roles</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>role-name</strong> (<em>string</em>) -- the name of the role</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Accountant&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.role.exists">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">exists</code><big>(</big><em>role-name</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.exists" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return true if a role exists; return false if a role does not exist.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>role-name</strong> (<em>string</em>) -- the name of the role</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">bool</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Accountant&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.role.grant">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">grant</code><big>(</big><em>user-name</em>, <em>privilege</em>, <em>object-type</em>, <em>object-name</em><span class="optional">[</span>, <em>option</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.grant" title="Ссылка на это определение">¶</a></dt>
<dd><p>Grant <a class="reference internal" href="singlehtml.html#authentication-privileges"><span class="std std-ref">privileges</span></a> to a role.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>user-name</strong> (<em>string</em>) -- the name of the role</li>
<li><strong>privilege</strong> (<em>string</em>) -- 'read' or 'write' or 'execute' or a combination</li>
<li><strong>object-type</strong> (<em>string</em>) -- 'space' or 'function'</li>
<li><strong>object-name</strong> (<em>string</em>) -- the name of a function or space</li>
<li><strong>option</strong> (<em>bool</em>) -- {if_not_exists=true} or {if_not_exists=false}</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>The role must exist, and the object must exist.</p>
<p><strong>Variation:</strong> instead of <code class="docutils literal"><span class="pre">object-type,</span> <span class="pre">object-name</span></code> say 'universe'
which means 'all object-types and all objects'.</p>
<p><strong>Variation:</strong> instead of <code class="docutils literal"><span class="pre">privilege,</span> <span class="pre">object-type,</span> <span class="pre">object-name</span></code> say
<code class="docutils literal"><span class="pre">role-name</span></code> -- to grant a role to a role.</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Accountant&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Accountant&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">function&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">f&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Accountant&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read,write&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">universe&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">public&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Accountant&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">role1&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">role2&#39;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="p">{</span><span class="n">if_not_exists</span><span class="o">=</span><span class="kc">false</span><span class="p">})</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.role.revoke">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">revoke</code><big>(</big><em>user-name</em>, <em>privilege</em>, <em>object-type</em>, <em>object-name</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.revoke" title="Ссылка на это определение">¶</a></dt>
<dd><p>Revoke <a class="reference internal" href="singlehtml.html#authentication-privileges"><span class="std std-ref">privileges</span></a> from a role.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>user-name</strong> (<em>string</em>) -- the name of the role</li>
<li><strong>privilege</strong> (<em>string</em>) -- 'read' or 'write' or 'execute' or a combination</li>
<li><strong>object-type</strong> (<em>string</em>) -- 'space' or 'function'</li>
<li><strong>object-name</strong> (<em>string</em>) -- the name of a function or space</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>The role must exist, and the object must exist,
but it is not an error if the role does not have the privilege.</p>
<p><strong>Variation:</strong> instead of <code class="docutils literal"><span class="pre">object-type,</span> <span class="pre">object-name</span></code> say 'universe'
which means 'all object-types and all objects'.</p>
<p><strong>Variation:</strong> instead of <code class="docutils literal"><span class="pre">privilege,</span> <span class="pre">object-type,</span> <span class="pre">object-name</span></code> say
<code class="docutils literal"><span class="pre">role-name</span></code>.</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Accountant&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Accountant&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">function&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">f&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Accountant&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read,write&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">universe&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">public&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Accountant&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.role.info">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">info</code><big>(</big><span class="optional">[</span><em>role-name</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.info" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return a description of a role's privileges.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>role-name</strong> (<em>string</em>) -- the name of the role.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Accountant&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-schema-func-create"></span><dl class="function">
<dt id="lua-функция.box.schema.func.create">
<em class="property"> </em><code class="descclassname">box.schema.func.</code><code class="descname">create</code><big>(</big><em>func-name</em><span class="optional">[</span>, <em>{options}</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.schema.func.create" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create a function tuple.
This does not create the function itself -- that is done with Lua --
but if it is necessary to grant privileges for a function,
box.schema.func.create must be done first.
For explanation of how Tarantool maintains function data, see
section <a class="reference internal" href="singlehtml.html#authentication-funcs"><span class="std std-ref">Functions and the _func space</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>func-name</strong> (<em>string</em>) -- name of function, which should not be a number
and should not contain special characters</li>
<li><strong>options</strong> (<em>table</em>) -- <code class="docutils literal"><span class="pre">if_not_exists</span></code>, <code class="docutils literal"><span class="pre">setuid</span></code>, <code class="docutils literal"><span class="pre">language</span></code>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">calculate&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">calculate&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">if_not_exists</span> <span class="o">=</span> <span class="kc">false</span><span class="p">})</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">calculate&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">setuid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">})</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">calculate&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">language</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">LUA&#39;</span><span class="p">})</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-schema-func-drop"></span><dl class="function">
<dt id="lua-функция.box.schema.func.drop">
<em class="property"> </em><code class="descclassname">box.schema.func.</code><code class="descname">drop</code><big>(</big><em>func-name</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.func.drop" title="Ссылка на это определение">¶</a></dt>
<dd><p>Drop a function tuple.
For explanation of how Tarantool maintains function data, see
section <a class="reference internal" href="singlehtml.html#authentication-funcs"><span class="std std-ref">Functions and the _func space</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>func-name</strong> (<em>string</em>) -- the name of the function</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">calculate&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.func.exists">
<em class="property"> </em><code class="descclassname">box.schema.func.</code><code class="descname">exists</code><big>(</big><em>func-name</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.func.exists" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return true if a function tuple exists; return false if a function tuple does not exist.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>func-name</strong> (<em>string</em>) -- the name of the function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">bool</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">calculate&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>
<span id="document-book/box/box_space"></span><div class="section" id="submodule-box-space">
<span id="box-space"></span><h5>3.4.2. Вложенный модуль <cite>box.space</cite><a class="headerlink" href="#submodule-box-space" title="Ссылка на этот заголовок">¶</a></h5>
<p>The <code class="docutils literal"><span class="pre">box.space</span></code> submodule has the data-manipulation functions <code class="docutils literal"><span class="pre">select</span></code>,
<code class="docutils literal"><span class="pre">insert</span></code>, <code class="docutils literal"><span class="pre">replace</span></code>, <code class="docutils literal"><span class="pre">update</span></code>, <code class="docutils literal"><span class="pre">upsert</span></code>, <code class="docutils literal"><span class="pre">delete</span></code>, <code class="docutils literal"><span class="pre">get</span></code>, <code class="docutils literal"><span class="pre">put</span></code>.
It also has members, such as id, and whether or not a space is enabled. Submodule
source code is available in file
<a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.7/src/box/lua/schema.lua">src/box/lua/schema.lua</a>.</p>
<p>A list of all <code class="docutils literal"><span class="pre">box.space</span></code> functions follows, then comes a list of all
<code class="docutils literal"><span class="pre">box.space</span></code> members.</p>
<blockquote>
<div><div class="table container">
<p><strong>The functions and members of box.space</strong></p>
<table border="1" class="left-align-column-1 left-align-column-2 docutils">
<colgroup>
<col width="54%" />
<col width="46%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Use</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><a class="reference internal" href="#box-space-create-index"><span class="std std-ref">space_object:create_index()</span></a></td>
<td>Create an index</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-space-insert"><span class="std std-ref">space_object:insert()</span></a></td>
<td>Insert a tuple</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-space-select"><span class="std std-ref">space_object:select()</span></a></td>
<td>Select one or more tuples</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-space-get"><span class="std std-ref">space_object:get()</span></a></td>
<td>Select a tuple</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-space-drop"><span class="std std-ref">space_object:drop()</span></a></td>
<td>Destroy a space</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-space-rename"><span class="std std-ref">space_object:rename()</span></a></td>
<td>Rename a space</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-space-replace"><span class="std std-ref">space_object:replace()</span></a></td>
<td>Insert or replace a tuple</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-space-replace"><span class="std std-ref">space_object:put()</span></a></td>
<td>Insert or replace a tuple</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-space-update"><span class="std std-ref">space_object:update()</span></a></td>
<td>Update a tuple</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-space-upsert"><span class="std std-ref">space_object:upsert()</span></a></td>
<td>Update a tuple</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-space-delete"><span class="std std-ref">space_object:delete()</span></a></td>
<td>Delete a tuple</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-space-count"><span class="std std-ref">space_object:count()</span></a></td>
<td>Get count of tuples</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-space-len"><span class="std std-ref">space_object:len()</span></a></td>
<td>Get count of tuples</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-space-truncate"><span class="std std-ref">space_object:truncate()</span></a></td>
<td>Delete all tuples</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-space-auto-increment"><span class="std std-ref">space_object:auto_increment()</span></a></td>
<td>Generate key + Insert a tuple</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-space-pairs"><span class="std std-ref">space_object:pairs()</span></a></td>
<td>Prepare for iterating</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-space-id"><span class="std std-ref">space_object.id</span></a></td>
<td>.Numeric identifier of space</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-space-enabled"><span class="std std-ref">space_object.enabled</span></a></td>
<td>.Flag, true if space is enabled</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-space-field-count"><span class="std std-ref">space_object.field_count</span></a></td>
<td>.Required number of fields</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-space-field-count"><span class="std std-ref">space_object.index</span></a></td>
<td>.Container of space's indexes</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-space-schema"><span class="std std-ref">box.space._schema</span></a></td>
<td>.(Metadata) List of schemas</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-space-space"><span class="std std-ref">box.space._space</span></a></td>
<td>.(Metadata) List of spaces</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-space-index"><span class="std std-ref">box.space._index</span></a></td>
<td>.(Metadata) List of indexes</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-space-user"><span class="std std-ref">box.space._user</span></a></td>
<td>.(Metadata) List of users</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-space-priv"><span class="std std-ref">box.space._priv</span></a></td>
<td>.(Metadata) List of privileges</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-space-cluster"><span class="std std-ref">box.space._cluster</span></a></td>
<td>.(Metadata) List of clusters</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-space-func"><span class="std std-ref">box.space._func</span></a></td>
<td>.(Metadata) List of function
tuples</td>
</tr>
</tbody>
</table>
</div>
</div></blockquote>
<span class="target" id="lua-module.box.space"></span><dl class="class">
<dt id="lua-объект.box.space.space_object">
<em class="property">объект </em><code class="descclassname">box.space.</code><code class="descname">space_object</code><a class="headerlink" href="#lua-объект.box.space.space_object" title="Ссылка на это определение">¶</a></dt>
<dd><span class="target" id="box-space-create-index"></span><dl class="method">
<dt id="lua-функция.space_object.create_index">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">create_index</code><big>(</big><em>index-name</em><span class="optional">[</span>, <em>{options}</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.space_object.create_index" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create an index. It is mandatory to create an index for a tuple set
before trying to insert tuples into it, or select tuples from it. The
first created index, which will be used as the primary-key index, must be
unique.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;
<span class="ccodei">index_name</span> (type = string) = name of index, which should not be a number
and should not contain special characters;
<span class="ccodei">options</span>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">index object</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">index_object</td>
</tr>
</tbody>
</table>
<div class="table container">
<p>Options for <code class="docutils literal"><span class="pre">space_object:create_index</span></code>:</p>
<table border="1" class="left-align-column-1 left-align-column-2 left-align-column-3 left-align-column-4 docutils">
<colgroup>
<col width="18%" />
<col width="24%" />
<col width="34%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Effect</th>
<th class="head">Type</th>
<th class="head">Default</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>type</td>
<td>type of index</td>
<td>string
('HASH' or 'TREE' or
'BITSET' or 'RTREE')</td>
<td>'TREE'</td>
</tr>
<tr class="row-odd"><td>id</td>
<td>unique identifier</td>
<td>number</td>
<td>last index's id, +1</td>
</tr>
<tr class="row-even"><td>unique</td>
<td>index is unique</td>
<td>boolean</td>
<td><code class="docutils literal"><span class="pre">true</span></code></td>
</tr>
<tr class="row-odd"><td>if_not_exists</td>
<td>no error if
duplicate name</td>
<td>boolean</td>
<td><code class="docutils literal"><span class="pre">false</span></code></td>
</tr>
<tr class="row-even"><td>parts</td>
<td>field-numbers  +
types</td>
<td>{field_no, 'unsigned' or
'string' or 'integer' or
'number' or 'array' or
'scalar'}</td>
<td><code class="docutils literal"><span class="pre">{1,</span> <span class="pre">'unsigned'}</span></code></td>
</tr>
</tbody>
</table>
</div>
<p>Possible errors: too many parts. Index '...' already exists. Primary key must be unique.</p>
<p>Note re storage engine: vinyl supports only the TREE index type,
and vinyl secondary indexes must be created before tuples are inserted.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">space55</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">}})</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<blockquote id="details-about-index-field-types">
<div><p>Details about index field types: <br />
The six index field types (unsigned | string | integer | number | array | scalar)
differ depending on what values are allowed, and what index types are allowed. <br />
<strong>unsigned</strong>: unsigned integers between 0 and 18446744073709551615, about 18 quintillion.
May also be called 'uint' or 'num', but 'num' is deprecated.
Legal in memtx TREE or HASH indexes, and in vinyl TREE indexes. <br />
<strong>string</strong>: any set of octets, up to the <a class="reference internal" href="singlehtml.html#limitations-bytes-in-index-key"><span class="std std-ref">maximum length</span></a>.
May also be called 'str'.
Legal in memtx TREE or HASH or BITSET indexes, and in vinyl TREE indexes. <br />
<strong>integer</strong>: integers between -9223372036854775808 and 18446744073709551615.
May also be called 'int'.
Legal in memtx TREE or HASH indexes, and in vinyl TREE indexes. <br />
<strong>number</strong>: integers between -9223372036854775808 and 18446744073709551615,
single-precision floating point numbers, or double-precision floating point numbers.
Legal in memtx TREE or HASH indexes, and in vinyl TREE indexes. <br />
<strong>array</strong>: array of integers between -9223372036854775808 and 9223372036854775807.
Legal in memtx RTREE indexes. <br />
<strong>scalar</strong>: booleans (true or false), or integers between -9223372036854775808 and 18446744073709551615,
or single-precision floating point numbers, or double-precison floating-point numbers,
or strings. When there is a mix of types, the key order is: booleans, then numbers, then strings.
Legal in memtx TREE or HASH indexes, and in vinyl TREE indexes.</p>
<div class="table container">
<p><strong>Index field types to use in create_index</strong></p>
<table border="1" class="left-align-column-1 left-align-column-2 left-align-column-3 left-align-column-4 top-align-column-1 docutils">
<colgroup>
<col width="17%" />
<col width="26%" />
<col width="38%" />
<col width="18%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><p class="first last">Тип поля для индексирования</p>
</td>
<td>What can be in it</td>
<td>Where is it legal</td>
<td><p class="first last">Примеры:</p>
</td>
</tr>
<tr class="row-even"><td><strong>unsigned</strong></td>
<td>integers between 0 and
18446744073709551615</td>
<td>memtx TREE or HASH
indexes, <br />
vinyl TREE indexes</td>
<td>123456 <br /></td>
</tr>
<tr class="row-odd"><td><strong>string</strong></td>
<td>strings -- any set of
octets</td>
<td>memtx TREE or HASH indexes <br />
vinyl TREE indexes</td>
<td>'A B C' <br />
'\65 \66 \67'</td>
</tr>
<tr class="row-even"><td><strong>integer</strong></td>
<td>integers between
-9223372036854775808 and
18446744073709551615</td>
<td>memtx TREE or HASH indexes, <br />
vinyl TREE indexes</td>
<td>-2^63 <br /></td>
</tr>
<tr class="row-odd"><td><strong>number</strong></td>
<td>integers between
-9223372036854775808 and
18446744073709551615,
single-precision
floating point numbers,
double-precision
floating point numbers</td>
<td>memtx TREE or HASH indexes, <br />
vinyl TREE indexes</td>
<td>1.234 <br />
-44 <br />
1.447e+44</td>
</tr>
<tr class="row-even"><td><strong>array</strong></td>
<td>array of integers between
-9223372036854775808 and
9223372036854775807</td>
<td>memtx RTREE indexes</td>
<td>{10, 11} <br />
{3, 5, 9, 10}</td>
</tr>
<tr class="row-odd"><td><strong>scalar</strong></td>
<td>booleans (true or false),
integers between
-9223372036854775808 and
18446744073709551615,
single-precision floating
point numbers,
double-precision floating
point numbers, strings</td>
<td>memtx TREE or HASH indexes, <br />
vinyl TREE indexes</td>
<td>true <br />
-1 <br />
1.234 <br />
'' <br />
'俄國'</td>
</tr>
</tbody>
</table>
</div>
</div></blockquote>
<span class="target" id="box-space-insert"></span><dl class="method">
<dt id="lua-функция.space_object.insert">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">insert</code><big>(</big><em>tuple</em><big>)</big><a class="headerlink" href="#lua-функция.space_object.insert" title="Ссылка на это определение">¶</a></dt>
<dd><p>Insert a tuple into a space.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;
<span class="ccodei">tuple</span> (type = Lua table or tuple) = tuple to be inserted.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the inserted tuple</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">tuple</td>
</tr>
</tbody>
</table>
<p>Possible errors: If a tuple with the same unique-key value already exists,
returns <code class="xref std std-errcode docutils literal"><span class="pre">ER_TUPLE_FOUND</span></code>.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">5000</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">tuple number five thousand&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">5000</span><span class="p p-Indicator">,</span> <span class="s">&#39;tuple</span><span class="nv"> </span><span class="s">number</span><span class="nv"> </span><span class="s">five</span><span class="nv"> </span><span class="s">thousand&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-space-select"></span><dl class="method">
<dt id="lua-функция.space_object.select">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">select</code><big>(</big><em>key</em><big>)</big><a class="headerlink" href="#lua-функция.space_object.select" title="Ссылка на это определение">¶</a></dt>
<dd><p>Search for a tuple or a set of tuples in the given space.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;
<span class="ccodei">key</span> (type = Lua table or scalar) = key to be matched against the index key,
which may be multi-part.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the tuples whose primary-key fields are equal to the passed
field-values. If the number of passed field-values is less
than the number of fields in the primary key, then only the
passed field-values are compared, so <code class="docutils literal"><span class="pre">select{1,2}</span></code> will match
a tuple whose primary key is <code class="docutils literal"><span class="pre">{1,2,3}</span></code>.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">array of tuples</td>
</tr>
</tbody>
</table>
<p>Possible errors: No such space; wrong type.</p>
<p><strong>Complexity Factors:</strong> Index size, Index type.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tmp&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">temporary</span><span class="o">=</span><span class="kc">true</span><span class="p">})</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,{</span><span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">}})</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">A&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;A&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;B&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">C&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;C&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">D&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="s">&#39;D&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="c1">-- must equal both primary-key fields</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;B&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="c1">-- must equal only one primary-key field</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;A&#39;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;B&#39;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;C&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="c1">-- must equal 0 fields, so returns all tuples</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">{}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;A&#39;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;B&#39;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;C&#39;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="s">&#39;D&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>For examples of complex <code class="docutils literal"><span class="pre">select</span></code> requests, where one can specify which
index to search and what condition to use (for example &quot;greater than&quot;
instead of &quot;equal to&quot;) and how many tuples to return, see the later section
<a class="reference internal" href="singlehtml.html#box-index-select"><span class="std std-ref">index_object:select</span></a>.</p>
</dd></dl>

<span class="target" id="box-space-get"></span><dl class="method">
<dt id="lua-функция.space_object.get">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">get</code><big>(</big><em>key</em><big>)</big><a class="headerlink" href="#lua-функция.space_object.get" title="Ссылка на это определение">¶</a></dt>
<dd><p>Search for a tuple in the given space.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;
<span class="ccodei">key</span> (type = Lua table or scalar) = key to be matched against the index
key, which may be multi-part.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the tuple whose index key matches <span class="ccodei">key</span>, or null.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">tuple</td>
</tr>
</tbody>
</table>
<p>Possible errors: If space_object does not exist.</p>
<p><strong>Complexity Factors:</strong> Index size, Index type,
Number of indexes accessed, WAL settings.</p>
<p>The <code class="docutils literal"><span class="pre">box.space...select</span></code> function returns a set
of tuples as a Lua table; the <code class="docutils literal"><span class="pre">box.space...get</span></code>
function returns at most a single tuple. And it is possible to get
the first tuple in a tuple set by appending <code class="docutils literal"><span class="pre">[1]</span></code>.
Therefore <code class="docutils literal"><span class="pre">box.space.tester:get{1}</span></code> has the same
effect as <code class="docutils literal"><span class="pre">box.space.tester:select{1}[1]</span></code>,
if exactly one tuple is found.</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">get</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-space-drop"></span><dl class="method">
<dt id="lua-функция.space_object.drop">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">drop</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.space_object.drop" title="Ссылка на это определение">¶</a></dt>
<dd><p>Drop a space.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">nil</td>
</tr>
</tbody>
</table>
<p>Possible errors: If space_object does not exist.</p>
<p><strong>Complexity Factors:</strong> Index size, Index type,
Number of indexes accessed, WAL settings.</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">space_that_does_not_exist</span><span class="p">:</span><span class="n">drop</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-space-rename"></span><dl class="method">
<dt id="lua-функция.space_object.rename">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">rename</code><big>(</big><em>space-name</em><big>)</big><a class="headerlink" href="#lua-функция.space_object.rename" title="Ссылка на это определение">¶</a></dt>
<dd><p>Rename a space.</p>
<p>Parameters:<code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;
<span class="ccodei">space-name</span> (type = string) = new name for space.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">nil</td>
</tr>
</tbody>
</table>
<p>Possible errors: space_object does not exist.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">space55</span><span class="p">:</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">space56&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">space56</span><span class="p">:</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">space55&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-space-replace"></span><dl class="method">
<dt id="lua-функция.space_object.replace">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">replace</code><big>(</big><em>tuple</em><big>)</big><a class="headerlink" href="#lua-функция.space_object.replace" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.space_object.put">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">put</code><big>(</big><em>tuple</em><big>)</big><a class="headerlink" href="#lua-функция.space_object.put" title="Ссылка на это определение">¶</a></dt>
<dd><p>Insert a tuple into a space. If a tuple with the same primary key already
exists, <code class="docutils literal"><span class="pre">box.space...:replace()</span></code> replaces the existing tuple with a new
one. The syntax variants <code class="docutils literal"><span class="pre">box.space...:replace()</span></code> and
<code class="docutils literal"><span class="pre">box.space...:put()</span></code> have the same effect; the latter is sometimes used
to show that the effect is the converse of <code class="docutils literal"><span class="pre">box.space...:get()</span></code>.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;
<span class="ccodei">tuple</span> (type = Lua table or tuple) = tuple to be inserted.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the inserted tuple.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">tuple</td>
</tr>
</tbody>
</table>
<p>Possible errors: If a different tuple with the same unique-key
value already exists, returns <code class="xref std std-errcode docutils literal"><span class="pre">ER_TUPLE_FOUND</span></code>. (This
will only happen if there is a unique secondary index.)</p>
<p><strong>Complexity Factors:</strong> Index size, Index type,
Number of indexes accessed, WAL settings.</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">{</span><span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">tuple number five thousand&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-space-update"></span><dl class="method">
<dt id="lua-функция.space_object.update">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">update</code><big>(</big><em>key</em>, <em>{{operator</em>, <em>field_no</em>, <em>value}</em>, <em>...}</em><big>)</big><a class="headerlink" href="#lua-функция.space_object.update" title="Ссылка на это определение">¶</a></dt>
<dd><p>Update a tuple.</p>
<p>The <code class="docutils literal"><span class="pre">update</span></code> function supports operations on fields — assignment,
arithmetic (if the field is numeric), cutting and pasting
fragments of a field, deleting or inserting a field. Multiple
operations can be combined in a single update request, and in this
case they are performed atomically and sequentially. Each operation
requires specification of a field number. When multiple operations
are present, the field number for each operation is assumed to be
relative to the most recent state of the tuple, that is, as if all
previous operations in a multi-operation update have already been
applied. In other words, it is always safe to merge multiple <code class="docutils literal"><span class="pre">update</span></code>
invocations into a single invocation, with no change in semantics.</p>
<p>Possible operators are:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">+</span></code> for addition (values must be numeric)</li>
<li><code class="docutils literal"><span class="pre">-</span></code> for subtraction (values must be numeric)</li>
<li><code class="docutils literal"><span class="pre">&amp;</span></code> for bitwise AND (values must be unsigned numeric)</li>
<li><code class="docutils literal"><span class="pre">|</span></code> for bitwise OR (values must be unsigned numeric)</li>
<li><code class="docutils literal"><span class="pre">^</span></code> for bitwise <abbr title="exclusive OR">XOR</abbr> (values must be unsigned numeric)</li>
<li><code class="docutils literal"><span class="pre">:</span></code> for string splice</li>
<li><code class="docutils literal"><span class="pre">!</span></code> for insertion</li>
<li><code class="docutils literal"><span class="pre">#</span></code> for deletion</li>
<li><code class="docutils literal"><span class="pre">=</span></code> for assignment</li>
</ul>
</div></blockquote>
<p>For <code class="docutils literal"><span class="pre">!</span></code> and <code class="docutils literal"><span class="pre">=</span></code> operations the field number can be <code class="docutils literal"><span class="pre">-1</span></code>, meaning the last field in the tuple.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;
<span class="ccodei">key</span> (type = Lua table or scalar) = primary-key field values, must be passed as a Lua
table if key is multi-part;
<span class="ccodei">{operator, field_no, value}</span> (type = table): a group of arguments for each
operation, indicating what the operation is, what field the
operation will apply to, and what value will be applied. The
field number can be negative, meaning the position from the end of
tuple (#tuple + negative field number + 1).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the updated tuple.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">tuple</td>
</tr>
</tbody>
</table>
<p>Possible errors: it is illegal to modify a primary-key field.</p>
<p><strong>Complexity Factors:</strong> Index size, Index type, number of indexes accessed, WAL
settings.</p>
<p>Thus, in the instruction:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">s</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="mi">44</span><span class="p">,</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">+&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">55</span> <span class="p">},</span> <span class="p">{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">x&#39;</span><span class="p">}})</span>
</pre></div>
</div>
<p>the primary-key value is <code class="docutils literal"><span class="pre">44</span></code>, the operators are <code class="docutils literal"><span class="pre">'+'</span></code> and <code class="docutils literal"><span class="pre">'='</span></code> meaning
<em>add a value to a field and then assign a value to a field</em>, the first
affected field is field <code class="docutils literal"><span class="pre">1</span></code> and the value which will be added to it is
<code class="docutils literal"><span class="pre">55</span></code>, the second affected field is field <code class="docutils literal"><span class="pre">3</span></code> and the value which will be
assigned to it is <code class="docutils literal"><span class="pre">'x'</span></code>.</p>
<p><strong>Example:</strong></p>
<p>Assume that initially there is a space named <code class="docutils literal"><span class="pre">tester</span></code>
with a primary-key index whose type is <code class="docutils literal"><span class="pre">unsigned</span></code>.
There is one tuple, with <code class="docutils literal"><span class="pre">field[1]</span></code> = <code class="docutils literal"><span class="pre">999</span></code> and <code class="docutils literal"><span class="pre">field[2]</span></code> = <code class="docutils literal"><span class="pre">'A'</span></code>.</p>
<p>In the update: <br />
<code class="docutils literal"><span class="pre">box.space.tester:update(999,</span> <span class="pre">{{'=',</span> <span class="pre">2,</span> <span class="pre">'B'}})</span></code> <br />
The first argument is <code class="docutils literal"><span class="pre">tester</span></code>, that is, the affected space is <code class="docutils literal"><span class="pre">tester</span></code>.
The second argument is <code class="docutils literal"><span class="pre">999</span></code>, that is, the affected tuple is identified by
primary key value = 999.
The third argument is <code class="docutils literal"><span class="pre">=</span></code>, that is, there is one operation —
<em>assignment to a field</em>.
The fourth argument is <code class="docutils literal"><span class="pre">2</span></code>, that is, the affected field is <code class="docutils literal"><span class="pre">field[2]</span></code>.
The fifth argument is <code class="docutils literal"><span class="pre">'B'</span></code>, that is, <code class="docutils literal"><span class="pre">field[2]</span></code> contents change to <code class="docutils literal"><span class="pre">'B'</span></code>.
Therefore, after this update, <code class="docutils literal"><span class="pre">field[1]</span></code> = <code class="docutils literal"><span class="pre">999</span></code> and <code class="docutils literal"><span class="pre">field[2]</span></code> = <code class="docutils literal"><span class="pre">'B'</span></code>.</p>
<p>In the update: <br />
<code class="docutils literal"><span class="pre">box.space.tester:update({999},</span> <span class="pre">{{'=',</span> <span class="pre">2,</span> <span class="pre">'B'}})</span></code> <br />
the arguments are the same, except that the key is passed as a Lua table
(inside braces). This is unnecessary when the primary key has only one
field, but would be necessary if the primary key had more than one field.
Therefore, after this update, <code class="docutils literal"><span class="pre">field[1]</span></code> = <code class="docutils literal"><span class="pre">999</span></code> and <code class="docutils literal"><span class="pre">field[2]</span></code> = <code class="docutils literal"><span class="pre">'B'</span></code> (no change).</p>
<p>In the update: <br />
<code class="docutils literal"><span class="pre">box.space.tester:update({999},</span> <span class="pre">{{'=',</span> <span class="pre">3,</span> <span class="pre">1}})</span></code> <br />
the arguments are the same, except that the fourth argument is <code class="docutils literal"><span class="pre">3</span></code>,
that is, the affected field is <code class="docutils literal"><span class="pre">field[3]</span></code>. It is okay that, until now,
<code class="docutils literal"><span class="pre">field[3]</span></code> has not existed. It gets added. Therefore, after this update,
<code class="docutils literal"><span class="pre">field[1]</span></code> = <code class="docutils literal"><span class="pre">999</span></code>, <code class="docutils literal"><span class="pre">field[2]</span></code> = <code class="docutils literal"><span class="pre">'B'</span></code>, <code class="docutils literal"><span class="pre">field[3]</span></code> = <code class="docutils literal"><span class="pre">1</span></code>.</p>
<p>In the update: <br />
<code class="docutils literal"><span class="pre">box.space.tester:update({999},</span> <span class="pre">{{'+',</span> <span class="pre">3,</span> <span class="pre">1}})</span></code> <br />
the arguments are the same, except that the third argument is <code class="docutils literal"><span class="pre">'+'</span></code>,
that is, the operation is addition rather than assignment. Since
<code class="docutils literal"><span class="pre">field[3]</span></code> previously contained <code class="docutils literal"><span class="pre">1</span></code>, this means we're adding <code class="docutils literal"><span class="pre">1</span></code>
to <code class="docutils literal"><span class="pre">1</span></code>. Therefore, after this update, <code class="docutils literal"><span class="pre">field[1]</span></code> = <code class="docutils literal"><span class="pre">999</span></code>,
<code class="docutils literal"><span class="pre">field[2]</span></code> = <code class="docutils literal"><span class="pre">'B'</span></code>, <code class="docutils literal"><span class="pre">field[3]</span></code> = <code class="docutils literal"><span class="pre">2</span></code>.</p>
<p>In the update: <br />
<code class="docutils literal"><span class="pre">box.space.tester:update({999},</span> <span class="pre">{{'|',</span> <span class="pre">3,</span> <span class="pre">1},</span> <span class="pre">{'=',</span> <span class="pre">2,</span> <span class="pre">'C'}})</span></code> <br />
the idea is to modify two fields at once. The formats are <code class="docutils literal"><span class="pre">'|'</span></code> and
<code class="docutils literal"><span class="pre">=</span></code>, that is, there are two operations, OR and assignment. The fourth
and fifth arguments mean that <code class="docutils literal"><span class="pre">field[3]</span></code> gets OR'ed with <code class="docutils literal"><span class="pre">1</span></code>. The
seventh and eighth arguments mean that <code class="docutils literal"><span class="pre">field[2]</span></code> gets assigned <code class="docutils literal"><span class="pre">'C'</span></code>.
Therefore, after this update, <code class="docutils literal"><span class="pre">field[1]</span></code> = <code class="docutils literal"><span class="pre">999</span></code>, <code class="docutils literal"><span class="pre">field[2]</span></code> = <code class="docutils literal"><span class="pre">'C'</span></code>,
<code class="docutils literal"><span class="pre">field[3]</span></code> = <code class="docutils literal"><span class="pre">3</span></code>.</p>
<p>In the update: <br />
<code class="docutils literal"><span class="pre">box.space.tester:update({999},</span> <span class="pre">{{'#',</span> <span class="pre">2,</span> <span class="pre">1},</span> <span class="pre">{'-',</span> <span class="pre">2,</span> <span class="pre">3}})</span></code> <br />
The idea is to delete <code class="docutils literal"><span class="pre">field[2]</span></code>, then subtract <code class="docutils literal"><span class="pre">3</span></code> from <code class="docutils literal"><span class="pre">field[3]</span></code>.
But after the delete, there is a renumbering, so <code class="docutils literal"><span class="pre">field[3]</span></code> becomes
<code class="docutils literal"><span class="pre">field[2]`</span></code> before we subtract <code class="docutils literal"><span class="pre">3</span></code> from it, and that's why the
seventh argument is <code class="docutils literal"><span class="pre">2</span></code>, not <code class="docutils literal"><span class="pre">3</span></code>. Therefore, after this update,
<code class="docutils literal"><span class="pre">field[1]</span></code> = <code class="docutils literal"><span class="pre">999</span></code>, <code class="docutils literal"><span class="pre">field[2]</span></code> = <code class="docutils literal"><span class="pre">0</span></code>.</p>
<p>In the update: <br />
<code class="docutils literal"><span class="pre">box.space.tester:update({999},</span> <span class="pre">{{'=',</span> <span class="pre">2,</span> <span class="pre">'XYZ'}})</span></code> <br />
we're making a long string so that splice will work in the next example.
Therefore, after this update, <code class="docutils literal"><span class="pre">field[1]</span></code> = <code class="docutils literal"><span class="pre">999</span></code>, <code class="docutils literal"><span class="pre">field[2]</span></code> = <code class="docutils literal"><span class="pre">'XYZ'</span></code>.</p>
<p>In the update: <br />
<code class="docutils literal"><span class="pre">box.space.tester:update({999},</span> <span class="pre">{{':',</span> <span class="pre">2,</span> <span class="pre">2,</span> <span class="pre">1,</span> <span class="pre">'!!'}})</span></code> <br />
The third argument is <code class="docutils literal"><span class="pre">':'</span></code>, that is, this is the example of splice.
The fourth argument is <code class="docutils literal"><span class="pre">2</span></code> because the change will occur in <code class="docutils literal"><span class="pre">field[2]</span></code>.
The fifth argument is 2 because deletion will begin with the second byte.
The sixth argument is 1 because the number of bytes to delete is 1.
The seventh argument is <code class="docutils literal"><span class="pre">'!!'</span></code>, because <code class="docutils literal"><span class="pre">'!!'</span></code> is to be added at this position.
Therefore, after this update, <code class="docutils literal"><span class="pre">field[1]</span></code> = <code class="docutils literal"><span class="pre">999</span></code>, <code class="docutils literal"><span class="pre">field[2]</span></code> = <code class="docutils literal"><span class="pre">'X!!Z'</span></code>.</p>
</dd></dl>

<span class="target" id="box-space-upsert"></span><dl class="method">
<dt id="lua-функция.space_object.upsert">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">upsert</code><big>(</big><em>tuple_value</em>, <em>{{operator</em>, <em>field_no</em>, <em>value}</em>, <em>...}</em><big>)</big><a class="headerlink" href="#lua-функция.space_object.upsert" title="Ссылка на это определение">¶</a></dt>
<dd><p>Update or insert a tuple.</p>
<p>If there is an existing tuple which matches the key fields of <code class="docutils literal"><span class="pre">tuple_value</span></code>, then the
request has the same effect as <a class="reference internal" href="#box-space-update"><span class="std std-ref">space_object:update()</span></a> and the
<code class="docutils literal"><span class="pre">{{operator,</span> <span class="pre">field_no,</span> <span class="pre">value},</span> <span class="pre">...}</span></code> parameter is used.
If there is no existing tuple which matches the key fields of <code class="docutils literal"><span class="pre">tuple_value</span></code>, then the
request has the same effect as <a class="reference internal" href="#box-space-insert"><span class="std std-ref">space_object:insert()</span></a> and the
<code class="docutils literal"><span class="pre">{tuple_value}</span></code> parameter is used. However, unlike <code class="docutils literal"><span class="pre">insert</span></code> or
<code class="docutils literal"><span class="pre">update</span></code>, <code class="docutils literal"><span class="pre">upsert</span></code> will not read a tuple and perform
error checks before returning -- this is a design feature which
enhances throughput but requires more caution on the part of the user.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;
<code class="samp docutils literal"><em><span class="pre">tuple_value</span></em></code> (type = Lua table or scalar) =
field values, must be passed as a Lua table;
<span class="ccodei">{operator, field_no, value}</span> (type = Lua table) = a group of arguments for each
operation, indicating what the operation is, what field the
operation will apply to, and what value will be applied. The
field number can be negative, meaning the position from the end of
the tuple (#tuple + negative field number + 1).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">null.</td>
</tr>
</tbody>
</table>
<p>Possible errors: it is illegal to modify a primary-key field.
It is illegal to use upsert with a space that has a unique secondary index.</p>
<p><strong>Complexity factors:</strong> Index size, Index type, number of indexes accessed, WAL
settings.</p>
<p><strong>Example:</strong></p>
<blockquote>
<div><div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">upsert</span><span class="p">({</span><span class="mi">12</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">c&#39;</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">a&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">b&#39;</span><span class="p">}})</span>
</pre></div>
</div>
</div></blockquote>
</dd></dl>

<span class="target" id="box-space-delete"></span><dl class="method">
<dt id="lua-функция.space_object.delete">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">delete</code><big>(</big><em>key</em><big>)</big><a class="headerlink" href="#lua-функция.space_object.delete" title="Ссылка на это определение">¶</a></dt>
<dd><p>Delete a tuple identified by a primary key.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>
<span class="ccodei">key</span> (type = Lua table or scalar) = key to be matched against the index
key, which may be multi-part.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the deleted tuple</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">tuple</td>
</tr>
</tbody>
</table>
<p><strong>Complexity Factors:</strong> Index size, Index type</p>
<p>Note re storage engine: vinyl will return <code class="docutils literal"><span class="pre">nil</span></code>, rather than the deleted tuple.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;My</span><span class="nv"> </span><span class="s">first</span><span class="nv"> </span><span class="s">tuple&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">a&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="s">&#39;Supplied</span><span class="nv"> </span><span class="s">key</span><span class="nv"> </span><span class="s">type</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">part</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">does</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">match</span><span class="nv"> </span><span class="s">index</span><span class="nv"> </span><span class="s">part</span><span class="nv"> </span><span class="s">type:</span>
  <span class="s">expected</span><span class="nv"> </span><span class="s">unsigned&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-space-id"></span><dl class="data">
<dt id="lua-данные.space_object.id">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">id</code><a class="headerlink" href="#lua-данные.space_object.id" title="Ссылка на это определение">¶</a></dt>
<dd><p>Ordinal space number. Spaces can be referenced by either name or
number. Thus, if space <code class="docutils literal"><span class="pre">tester</span></code> has <code class="docutils literal"><span class="pre">id</span> <span class="pre">=</span> <span class="pre">800</span></code>, then
<code class="docutils literal"><span class="pre">box.space.tester:insert{0}</span></code> and <code class="docutils literal"><span class="pre">box.space[800]:insert{0}</span></code>
are equivalent requests.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">.</span><span class="n">id</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">512</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-space-enabled"></span><dl class="data">
<dt id="lua-данные.space_object.enabled">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">enabled</code><a class="headerlink" href="#lua-данные.space_object.enabled" title="Ссылка на это определение">¶</a></dt>
<dd><p>Whether or not this space is enabled.
The value is <code class="docutils literal"><span class="pre">false</span></code> if the space has no index.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>.</p>
</dd></dl>

<span class="target" id="box-space-field-count"></span><dl class="data">
<dt id="lua-данные.space_object.field_count">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">field_count</code><a class="headerlink" href="#lua-данные.space_object.field_count" title="Ссылка на это определение">¶</a></dt>
<dd><p>The required field count for all tuples in this space. The field_count
can be set initially with:</p>
<pre class="highlight literal-block">
box.schema.space.create(..., {
    ... ,
    field_count = <em>field_count_value</em> ,
    ...
})
</pre>
<p>The default value is <code class="docutils literal"><span class="pre">0</span></code>, which means there is no required field count.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">.</span><span class="n">field_count</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="data">
<dt id="lua-данные.space_object.index">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">index</code><a class="headerlink" href="#lua-данные.space_object.index" title="Ссылка на это определение">¶</a></dt>
<dd><p>A container for all defined indexes. There is a Lua object of type
<a class="reference internal" href="singlehtml.html#box-index"><span class="std std-ref">box.index</span></a> with methods to search tuples and iterate over them in
predefined order.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body">table</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">tarantool</span><span class="o">&gt;</span> <span class="o">#</span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">.</span><span class="n">index</span>
<span class="c1">---</span>
<span class="o">-</span> <span class="mi">1</span>
<span class="o">...</span>
<span class="n">tarantool</span><span class="o">&gt;</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">primary</span><span class="p">.</span><span class="n">type</span>
<span class="c1">---</span>
<span class="o">-</span> <span class="n">TREE</span>
<span class="o">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-space-count"></span><dl class="method">
<dt id="lua-функция.space_object.count">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">count</code><big>(</big><span class="optional">[</span><em>key</em><span class="optional">]</span><span class="optional">[</span>, <em>iterator</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.space_object.count" title="Ссылка на это определение">¶</a></dt>
<dd><p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;
<span class="ccodei">key</span> (type = Lua table or scalar) = key to be matched against the primary index
key, which may be multi-part; <span class="ccodei">iterator</span> = comparison method.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">Number of tuples.</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">count</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">iterator</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-space-len"></span><dl class="method">
<dt id="lua-функция.space_object.len">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">len</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.space_object.len" title="Ссылка на это определение">¶</a></dt>
<dd><p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">Number of tuples in the space.</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">len</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Note re storage engine: vinyl does not support <code class="docutils literal"><span class="pre">len()</span></code>.  One possible workaround is to
say <code class="docutils literal"><span class="pre">#select(...)</span></code>.</p>
</dd></dl>

<span class="target" id="box-space-truncate"></span><dl class="method">
<dt id="lua-функция.space_object.truncate">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">truncate</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.space_object.truncate" title="Ссылка на это определение">¶</a></dt>
<dd><p>Deletes all tuples. .</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>.</p>
<p><strong>Complexity Factors:</strong> Index size, Index type, Number of tuples accessed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">nil</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">Note that <code class="docutils literal"><span class="pre">truncate</span></code> must be called only by the user who created
the space OR under a <cite>setuid</cite> function created by that user. Read
more about <cite>setuid</cite> functions <a class="reference internal" href="singlehtml.html#authentication-funcs"><span class="std std-ref">here</span></a></p>
</div>
<p>Note re storage engine: vinyl does not support <code class="docutils literal"><span class="pre">truncate()</span></code>.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">truncate</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">len</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-space-auto-increment"></span><dl class="method">
<dt id="lua-функция.space_object.auto_increment">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">auto_increment</code><big>(</big><em>field-value</em><span class="optional">[</span>, <em>field-value ...</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.space_object.auto_increment" title="Ссылка на это определение">¶</a></dt>
<dd><p>Insert a new tuple using an auto-increment primary key. The space specified
by space_object must have an <code class="docutils literal"><span class="pre">unsigned</span></code> or <code class="docutils literal"><span class="pre">integer</span></code> or <code class="docutils literal"><span class="pre">numeric</span></code> primary key index of type <code class="docutils literal"><span class="pre">TREE</span></code>. The
primary-key field will be incremented before the insert.</p>
<p>Note re storage engine: vinyl does not support <code class="docutils literal"><span class="pre">auto_increment()</span></code>.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;
<span class="ccodei">field-value(s)</span> (type = Lua table or scalar) = tuple's fields, other than the primary-key field.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the inserted tuple.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">tuple</td>
</tr>
</tbody>
</table>
<p><strong>Complexity Factors:</strong> Index size, Index type,
Number of indexes accessed, WAL settings.</p>
<p>Possible errors: index has wrong type or primary-key indexed field is not a number.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">auto_increment</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">Fld#1&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#2&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Fld#1&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;Fld#2&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">auto_increment</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">Fld#3&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="s">&#39;Fld#3&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-space-pairs"></span><dl class="method">
<dt id="lua-функция.space_object.pairs">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">pairs</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.space_object.pairs" title="Ссылка на это определение">¶</a></dt>
<dd><p>A helper function to prepare for iterating over all tuples in a space.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">function which can be used in a for/end loop. Within the loop, a value is returned for each iteration.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">function, tuple</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">space33&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="c1">-- index &#39;X&#39; has default parts {1, &#39;unsigned&#39;}</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">X&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Hello my &#39;</span><span class="p">},</span> <span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Lua world&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span> <span class="s">&#39;Hello</span><span class="nv"> </span><span class="s">my</span><span class="nv"> </span><span class="s">&#39;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Lua</span><span class="nv"> </span><span class="s">world&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">tmp</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">&#39;</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="k">in</span> <span class="n">s</span><span class="p">:</span><span class="nb">pairs</span><span class="p">()</span> <span class="k">do</span>
<span class="gp">         &gt; </span>  <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">..</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">tmp</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Hello my Lua world</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<span class="target" id="box-space-schema"></span><dl class="data">
<dt id="lua-данные.box.space._schema">
<em class="property"> </em><code class="descclassname">box.space.</code><code class="descname">_schema</code><a class="headerlink" href="#lua-данные.box.space._schema" title="Ссылка на это определение">¶</a></dt>
<dd><p><code class="docutils literal"><span class="pre">_schema</span></code> is a system tuple set. Its single tuple contains these fields:
<code class="docutils literal"><span class="pre">'version',</span> <span class="pre">major-version-number,</span> <span class="pre">minor-version-number</span></code>.</p>
<p><strong>Example:</strong></p>
<p>The following function will display all fields in all tuples of <code class="docutils literal"><span class="pre">_schema</span></code>:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">example</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">ta</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="kd">local</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span>
  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="k">in</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_schema</span><span class="p">:</span><span class="nb">pairs</span><span class="p">()</span> <span class="k">do</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">&#39;</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="o">#</span><span class="n">v</span> <span class="k">do</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">..</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> &#39;</span>
      <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="n">ta</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Here is what <code class="docutils literal"><span class="pre">example()</span></code> returns in a typical installation:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">example</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="s">&#39;cluster</span><span class="nv"> </span><span class="s">1ec4e1f8-8f1b-4304-bb22-6c47ce0cf9c6</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;max_id</span><span class="nv"> </span><span class="s">520</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;version</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">7</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-space-space"></span><dl class="data">
<dt id="lua-данные.box.space._space">
<em class="property"> </em><code class="descclassname">box.space.</code><code class="descname">_space</code><a class="headerlink" href="#lua-данные.box.space._space" title="Ссылка на это определение">¶</a></dt>
<dd><p><code class="docutils literal"><span class="pre">_space</span></code> is a system tuple set. Its tuples contain these fields: <code class="docutils literal"><span class="pre">id</span></code>,
<code class="docutils literal"><span class="pre">owner</span></code> (= id of user who owns the space),
<code class="docutils literal"><span class="pre">name</span></code>, <code class="docutils literal"><span class="pre">engine</span></code>, <code class="docutils literal"><span class="pre">field_count</span></code>,
<code class="docutils literal"><span class="pre">flags</span></code> (e.g. temporary), <code class="docutils literal"><span class="pre">format</span></code>.
These fields are established by <a class="reference internal" href="singlehtml.html#box-schema-space-create"><span class="std std-ref">space.create()</span></a>.</p>
<p><strong>Example:</strong></p>
<p>The following function will display all simple fields in all tuples of <code class="docutils literal"><span class="pre">_space</span></code>.</p>
<div class="highlight-lua_tarantool"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">example</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">ta</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="kd">local</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span>
  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="k">in</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_space</span><span class="p">:</span><span class="nb">pairs</span><span class="p">()</span> <span class="k">do</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">&#39;</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="o">#</span><span class="n">v</span> <span class="k">do</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">~=</span> <span class="s1">&#39;</span><span class="s">table&#39;</span> <span class="k">then</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">..</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> &#39;</span>
      <span class="k">end</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="n">ta</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Here is what <code class="docutils literal"><span class="pre">example()</span></code> returns in a typical installation:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">example</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="s">&#39;272</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">_schema</span><span class="nv"> </span><span class="s">memtx</span><span class="nv"> </span><span class="s">0</span><span class="nv">  </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;280</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">_space</span><span class="nv"> </span><span class="s">memtx</span><span class="nv"> </span><span class="s">0</span><span class="nv">  </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;281</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">_vspace</span><span class="nv"> </span><span class="s">sysview</span><span class="nv"> </span><span class="s">0</span><span class="nv">  </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;288</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">_index</span><span class="nv"> </span><span class="s">memtx</span><span class="nv"> </span><span class="s">0</span><span class="nv">  </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;296</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">_func</span><span class="nv"> </span><span class="s">memtx</span><span class="nv"> </span><span class="s">0</span><span class="nv">  </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;304</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">_user</span><span class="nv"> </span><span class="s">memtx</span><span class="nv"> </span><span class="s">0</span><span class="nv">  </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;305</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">_vuser</span><span class="nv"> </span><span class="s">sysview</span><span class="nv"> </span><span class="s">0</span><span class="nv">  </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;312</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">_priv</span><span class="nv"> </span><span class="s">memtx</span><span class="nv"> </span><span class="s">0</span><span class="nv">  </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;313</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">_vpriv</span><span class="nv"> </span><span class="s">sysview</span><span class="nv"> </span><span class="s">0</span><span class="nv">  </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;320</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">_cluster</span><span class="nv"> </span><span class="s">memtx</span><span class="nv"> </span><span class="s">0</span><span class="nv">  </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;512</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">tester</span><span class="nv"> </span><span class="s">memtx</span><span class="nv"> </span><span class="s">0</span><span class="nv">  </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;513</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">origin</span><span class="nv"> </span><span class="s">vinyl</span><span class="nv"> </span><span class="s">0</span><span class="nv">  </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;514</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">archive</span><span class="nv"> </span><span class="s">memtx</span><span class="nv"> </span><span class="s">0</span><span class="nv">  </span><span class="s">&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
<p><strong>Example:</strong></p>
<p>The following requests will create a space using
<code class="docutils literal"><span class="pre">box.schema.space.create</span></code> with a <code class="docutils literal"><span class="pre">format</span></code> clause.
Then it retrieves the _space tuple for the new space.
This illustrates the typical use of the <code class="docutils literal"><span class="pre">format</span></code> clause,
it shows the recommended names and data types for the fields.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">TM&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">id</span> <span class="o">=</span> <span class="mi">12345</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">format</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">         &gt; </span>    <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="s2">&quot;</span><span class="s">name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">field_1&quot;</span><span class="p">},</span>
<span class="gp">         &gt; </span>    <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="s2">&quot;</span><span class="s">type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">unsigned&quot;</span><span class="p">}</span>
<span class="gp">         &gt; </span>  <span class="p">}</span>
<span class="gp">         &gt; </span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">index</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[]</span>
  <span class="l l-Scalar l-Scalar-Plain">on_replace</span><span class="p p-Indicator">:</span> <span class="s">&#39;function:</span><span class="nv"> </span><span class="s">0x41c67338&#39;</span>
  <span class="l l-Scalar l-Scalar-Plain">temporary</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">12345</span>
  <span class="l l-Scalar l-Scalar-Plain">engine</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">memtx</span>
  <span class="l l-Scalar l-Scalar-Plain">enabled</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">TM</span>
  <span class="l l-Scalar l-Scalar-Plain">field_count</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">created</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_space</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="mi">12345</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">12345</span><span class="p p-Indicator">,</span> <span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;TM&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;memtx&#39;</span><span class="p p-Indicator">,</span> <span class="nv">0</span><span class="p p-Indicator">,</span> <span class="p p-Indicator">{},</span> <span class="p p-Indicator">[{</span><span class="s">&#39;name&#39;</span><span class="p p-Indicator">:</span> <span class="s">&#39;field_1&#39;</span><span class="p p-Indicator">},</span> <span class="p p-Indicator">{</span><span class="s">&#39;type&#39;</span><span class="p p-Indicator">:</span> <span class="s">&#39;unsigned&#39;</span><span class="p p-Indicator">}]]</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-space-index"></span><dl class="data">
<dt id="lua-данные.box.space._index">
<em class="property"> </em><code class="descclassname">box.space.</code><code class="descname">_index</code><a class="headerlink" href="#lua-данные.box.space._index" title="Ссылка на это определение">¶</a></dt>
<dd><p><code class="docutils literal"><span class="pre">_index</span></code> is a system tuple set. Its tuples contain these fields:
<code class="docutils literal"><span class="pre">id</span></code> (= id of space), <code class="docutils literal"><span class="pre">iid</span></code> (= index number within space),
<code class="docutils literal"><span class="pre">name</span></code>, <code class="docutils literal"><span class="pre">type</span></code>, <code class="docutils literal"><span class="pre">opts</span></code> (e.g. unique option),
[<code class="docutils literal"><span class="pre">tuple-field-no</span></code>, <code class="docutils literal"><span class="pre">tuple-field-type</span></code> ...].</p>
<p>The following function will display all fields in all tuples of <code class="docutils literal"><span class="pre">_index</span></code>:
(notice that the fifth field gets special treatment as a map value and
the sixth or later fields get special treatment as arrays):</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">example</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">ta</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="kd">local</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">value</span>
  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="k">in</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_index</span><span class="p">:</span><span class="nb">pairs</span><span class="p">()</span> <span class="k">do</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">&#39;</span>
     <span class="k">while</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="k">do</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">then</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">end</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">5</span> <span class="k">then</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">unique</span> <span class="o">==</span> <span class="kc">true</span> <span class="k">then</span>
          <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">true&#39;</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">then</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> &#39;</span> <span class="o">..</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">end</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">..</span> <span class="n">value</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> &#39;</span>
      <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">return</span> <span class="n">ta</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Here is what <code class="docutils literal"><span class="pre">example()</span></code> returns in a typical installation:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">example</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="s">&#39;272</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">primary</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">str</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;280</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">primary</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;280</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">owner</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;280</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">str</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;281</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">primary</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;281</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">owner</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;281</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">str</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;288</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">primary</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;288</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;289</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">primary</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;289</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;296</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">primary</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;296</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">owner</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;296</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">str</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;297</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">primary</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;297</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">owner</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;297</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">str</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;304</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">primary</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;304</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">owner</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;304</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">str</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;305</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">primary</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;305</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">owner</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;305</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">name</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">str</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;312</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">primary</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;312</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">owner</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;312</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">object</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">str</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;313</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">primary</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;313</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">owner</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;313</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">object</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">2</span><span class="nv"> </span><span class="s">str</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;320</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">primary</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;320</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">uuid</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">1</span><span class="nv"> </span><span class="s">str</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;512</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">primary</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;513</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">primary</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">num</span><span class="nv"> </span><span class="s">&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;516</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">primary</span><span class="nv"> </span><span class="s">tree</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">STR</span><span class="nv"> </span><span class="s">&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-space-user"></span><dl class="data">
<dt id="lua-данные.box.space._user">
<em class="property"> </em><code class="descclassname">box.space.</code><code class="descname">_user</code><a class="headerlink" href="#lua-данные.box.space._user" title="Ссылка на это определение">¶</a></dt>
<dd><p><code class="docutils literal"><span class="pre">_user</span></code> is a system tuple set for
support of the <a class="reference internal" href="singlehtml.html#authentication"><span class="std std-ref">authorization feature</span></a>.</p>
</dd></dl>

<span class="target" id="box-space-priv"></span><dl class="data">
<dt id="lua-данные.box.space._priv">
<em class="property"> </em><code class="descclassname">box.space.</code><code class="descname">_priv</code><a class="headerlink" href="#lua-данные.box.space._priv" title="Ссылка на это определение">¶</a></dt>
<dd><p><code class="docutils literal"><span class="pre">_priv</span></code> is a system tuple set for
support of the <a class="reference internal" href="singlehtml.html#authentication"><span class="std std-ref">authorization feature</span></a>.</p>
</dd></dl>

<span class="target" id="box-space-cluster"></span><dl class="data">
<dt id="lua-данные.box.space._cluster">
<em class="property"> </em><code class="descclassname">box.space.</code><code class="descname">_cluster</code><a class="headerlink" href="#lua-данные.box.space._cluster" title="Ссылка на это определение">¶</a></dt>
<dd><p><code class="docutils literal"><span class="pre">_cluster</span></code> is a system tuple set
for support of the <a class="reference internal" href="singlehtml.html#index-box-replication"><span class="std std-ref">replication feature</span></a>.</p>
</dd></dl>

<span class="target" id="box-space-func"></span><dl class="data">
<dt id="lua-данные.box.space._func">
<em class="property"> </em><code class="descclassname">box.space.</code><code class="descname">_func</code><a class="headerlink" href="#lua-данные.box.space._func" title="Ссылка на это определение">¶</a></dt>
<dd><p><code class="docutils literal"><span class="pre">_func</span></code> is a system tuple set
with function tuples made by <a class="reference internal" href="singlehtml.html#box-schema-func-create"><span class="std std-ref">box.schema.func.create</span></a>.</p>
</dd></dl>

<div class="section" id="example-use-box-space-functions-to-read-space-tuples">
<h6>3.4.2.1. Example: use box.space functions to read _space tuples<a class="headerlink" href="#example-use-box-space-functions-to-read-space-tuples" title="Ссылка на этот заголовок">¶</a></h6>
<p>This function will illustrate how to look at all the spaces, and for each
display: approximately how many tuples it contains, and the first field of
its first tuple. The function uses Tarantool <code class="docutils literal"><span class="pre">box.space</span></code> functions <code class="docutils literal"><span class="pre">len()</span></code>
and <code class="docutils literal"><span class="pre">pairs()</span></code>. The iteration through the spaces is coded as a scan of the
<code class="docutils literal"><span class="pre">_space</span></code> system tuple set, which contains metadata. The third field in
<code class="docutils literal"><span class="pre">_space</span></code> contains the space name, so the key instruction
<code class="docutils literal"><span class="pre">space_name</span> <span class="pre">=</span> <span class="pre">v[3]</span></code> means <code class="docutils literal"><span class="pre">space_name</span></code> is the <code class="docutils literal"><span class="pre">space_name</span></code> field in
the tuple of <code class="docutils literal"><span class="pre">_space</span></code> that we've just fetched with <code class="docutils literal"><span class="pre">pairs()</span></code>. The function
returns a table:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">example</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">tuple_count</span><span class="p">,</span> <span class="n">space_name</span><span class="p">,</span> <span class="n">line</span>
  <span class="kd">local</span> <span class="n">ta</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="k">in</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_space</span><span class="p">:</span><span class="nb">pairs</span><span class="p">()</span> <span class="k">do</span>
    <span class="n">space_name</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">].</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="k">then</span>
      <span class="n">tuple_count</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">1 or more&#39;</span>
    <span class="k">else</span>
      <span class="n">tuple_count</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">0&#39;</span>
    <span class="k">end</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">space_name</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> tuple_count =&#39;</span> <span class="o">..</span> <span class="n">tuple_count</span>
    <span class="k">if</span> <span class="n">tuple_count</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="s">1 or more&#39;</span> <span class="k">then</span>
      <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="k">in</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">]:</span><span class="nb">pairs</span><span class="p">()</span> <span class="k">do</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s">. first field in first tuple = &#39;</span> <span class="o">..</span> <span class="n">v1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">break</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="n">ta</span>
<span class="k">end</span>
</pre></div>
</div>
<p>And here is what happens when one invokes the function:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">example</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">_schema tuple_count =1 or more. first field in first tuple = cluster</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">_space tuple_count =1 or more. first field in first tuple = 272</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">_vspace tuple_count =1 or more. first field in first tuple = 272</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">_index tuple_count =1 or more. first field in first tuple = 272</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">_vindex tuple_count =1 or more. first field in first tuple = 272</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">_func tuple_count =1 or more. first field in first tuple = 1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">_vfunc tuple_count =1 or more. first field in first tuple = 1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">_user tuple_count =1 or more. first field in first tuple = 0</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">_vuser tuple_count =1 or more. first field in first tuple = 0</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">_priv tuple_count =1 or more. first field in first tuple = 1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">_vpriv tuple_count =1 or more. first field in first tuple = 1</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">_cluster tuple_count =1 or more. first field in first tuple = 1</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="section" id="example-use-box-space-functions-to-organize-a-space-tuple">
<h6>3.4.2.2. Example: use box.space functions to organize a _space tuple<a class="headerlink" href="#example-use-box-space-functions-to-organize-a-space-tuple" title="Ссылка на этот заголовок">¶</a></h6>
<p>The objective is to display field names and field types of a system space --
using metadata to find metadata.</p>
<p>To begin: how can one select the _space tuple that describes _space?</p>
<p>A simple way is to look at the constants in box.schema,
which tell us that there is an item named SPACE_ID == 288,
so these statements will retrieve the correct tuple: <br />
<span class="ccode">box.space._space:select{288}</span> <br />
or <br />
<span class="ccode">box.space._space:select{box.schema.SPACE_ID}</span> <br /></p>
<p>Another way is to look at the tuples in box.space._index,
which tell us that there is a secondary index named 'name' for space
number 288, so this statement also will retrieve the correct tuple: <br />
<span class="ccode">box.space._space.index.name:select{'_space'}</span></p>
<p>However, the retrieved tuple is not easy to read: <br />
<span class="ccode">tarantool&gt;</span> <span class="ccodeb">box.space._space.index.name:select{'_space'}</span> <br />
<span class="ccode">---</span> <br />
<span class="ccode">- - [280, 1, '_space', 'memtx', 0, '', [{'name': 'id',</span> <br />
&nbsp; &nbsp; &nbsp; <span class="ccode">'type': 'num'}, {'name': 'owner','type': 'num'},</span> <br />
&nbsp; &nbsp; &nbsp; <span class="ccode">{'name': 'name','type': 'str'}, {'name': 'engine',</span> <br />
&nbsp; &nbsp; &nbsp; <span class="ccode">'type': 'str'},{'name': 'field_count', 'type': 'num'},</span> <br />
&nbsp; &nbsp; &nbsp; <span class="ccode">{'name': 'flags','type': 'str'}, {'name': 'format',</span> <br />
&nbsp; &nbsp; &nbsp; <span class="ccode">'type': '*'}]]</span> <br />
&nbsp; &nbsp; &nbsp; <span class="ccode">...</span></p>
<p>It looks disorganized because field number 7
has been formatted with recommended names and data types.
How can one get those specific sub-fields?
Since it's visible that field number 7 is an array of maps,
this <cite>for</cite> loop will do the organizing: <br />
<span class="ccode">local tuple_of_space, field_name, field_type</span> <br />
<span class="ccode">tuple_of_space = box.space._space.index.name:select{'_space'}[1]</span> <br />
<span class="ccode">for i = 1, #tuple_of_space[7], 1</span> <br />
<span class="ccode">do</span> <br />
&nbsp; &nbsp; &nbsp; <span class="ccode">field_name = tuple_of_space[7][i]['name']</span> <br />
&nbsp; &nbsp; &nbsp; <span class="ccode">field_type = tuple_of_space[7][i]['type']</span> <br />
&nbsp; &nbsp; &nbsp; <span class="ccode">print(field_name .. ',' ..field_type)</span> <br />
<span class="ccode">end</span></p>
<p>And here is what happens when one executes the <cite>for</cite> loop: <br />
<span class="ccode">id,num</span> <br />
<span class="ccode">owner,num</span> <br />
<span class="ccode">name,str</span> <br />
<span class="ccode">engine,str</span> <br />
<span class="ccode">field_count,num</span> <br />
<span class="ccode">flags,str</span> <br />
<span class="ccode">format,*</span></p>
</div>
</div>
<span id="document-book/box/box_index"></span><div class="section" id="submodule-box-index">
<span id="box-index"></span><h5>3.4.3. Вложенный модуль <cite>box.index</cite><a class="headerlink" href="#submodule-box-index" title="Ссылка на этот заголовок">¶</a></h5>
<p>The <code class="docutils literal"><span class="pre">box.index</span></code> submodule provides read-only access for index definitions and
index keys. Indexes are contained in <code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">.index</span></code> array within
each space object. They provide an API for ordered iteration over tuples. This
API is a direct binding to corresponding methods of index objects of type
<code class="docutils literal"><span class="pre">box.index</span></code> in the storage engine.</p>
<span class="target" id="lua-module.box.index"></span><dl class="class">
<dt id="lua-объект.box.index.index_object">
<em class="property">объект </em><code class="descclassname">box.index.</code><code class="descname">index_object</code><a class="headerlink" href="#lua-объект.box.index.index_object" title="Ссылка на это определение">¶</a></dt>
<dd><dl class="data">
<dt id="lua-данные.index_object.unique">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">unique</code><a class="headerlink" href="#lua-данные.index_object.unique" title="Ссылка на это определение">¶</a></dt>
<dd><p>True if the index is unique, false if the index is not unique.</p>
<p>Parameters:</p>
<ul class="simple">
<li><code class="samp docutils literal"><em><span class="pre">index_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body">boolean</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="data">
<dt id="lua-данные.index_object.type">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">type</code><a class="headerlink" href="#lua-данные.index_object.type" title="Ссылка на это определение">¶</a></dt>
<dd><p>Index type, 'TREE' or 'HASH' or 'BITSET' or 'RTREE'.</p>
<p>Parameters:</p>
<ul class="simple">
<li><code class="samp docutils literal"><em><span class="pre">index_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>.</li>
</ul>
</dd></dl>

<dl class="data">
<dt id="lua-данные.index_object.parts">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">parts</code><a class="headerlink" href="#lua-данные.index_object.parts" title="Ссылка на это определение">¶</a></dt>
<dd><p>An array describing index key fields.</p>
<p>Parameters:</p>
<ul class="simple">
<li><code class="samp docutils literal"><em><span class="pre">index_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body">table</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">primary</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">unique</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="l l-Scalar l-Scalar-Plain">parts</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">unsigned</span>
    <span class="l l-Scalar l-Scalar-Plain">fieldno</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">space_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">513</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">primary</span>
  <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">TREE</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-index-index-pairs"></span><dl class="method">
<dt id="lua-функция.index_object.pairs">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">pairs</code><big>(</big><em>bitset-value | search-value</em>, <em>iterator-type</em><big>)</big><a class="headerlink" href="#lua-функция.index_object.pairs" title="Ссылка на это определение">¶</a></dt>
<dd><p>This method provides iteration support within an index.
The <span class="ccodei">bitset-value</span> or <span class="ccodei">search-value</span> parameter
specifies what must match within the index.
The <span class="ccodei">iterator-type</span>
parameter specifies the rule for matching and ordering. Different index types support
different iterators. For example, a TREE index maintains a
strict order of keys and can return all tuples in ascending or descending
order, starting from the specified key. Other index types, however, do not
support ordering.</p>
<p>To understand consistency of tuples returned by an iterator, it's essential
to know the principles of the Tarantool transaction processing subsystem. An
iterator in Tarantool does not own a consistent read view. Instead, each
procedure is granted exclusive access to all tuples and spaces until
there is a &quot;context switch&quot;: which may happen due to
<a class="reference internal" href="singlehtml.html#atomic-the-implicit-yield-rules"><span class="std std-ref">the-implicit-yield-rules</span></a>,
or by an
explicit call to <a class="reference internal" href="singlehtml.html#fiber-yield"><span class="std std-ref">fiber.yield</span></a>. When the execution flow returns
to the yielded procedure, the data set could have changed significantly.
Iteration, resumed after a yield point, does not preserve the read view,
but continues with the new content of the database.
The tutorial <a class="reference internal" href="singlehtml.html#c-lua-tutorial-indexed-pattern-search"><span class="std std-ref">Indexed pattern search</span></a>
shows one way that iterators and yields can be used together.</p>
<p>Parameters:</p>
<ul class="simple">
<li><code class="samp docutils literal"><em><span class="pre">index_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;</li>
<li><code class="samp docutils literal"><em><span class="pre">bitset-value</span></em> <span class="pre">|</span> <em><span class="pre">search-value...</span></em></code> = what to search for</li>
<li><code class="samp docutils literal"><em><span class="pre">iterator-type</span></em></code> = as defined in tables below.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">this method returns an iterator closure, i.e. a function which can
be used to get the next value on each invocation</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">function, tuple</td>
</tr>
</tbody>
</table>
<p>Possible errors: Selected iteration type is not supported for the index type,
or search value is not supported for the iteration type.</p>
<p>Complexity Factors: Index size, Index type, Number of tuples accessed.</p>
<p>A search-value can be a number (for example <code class="docutils literal"><span class="pre">1234</span></code>), a string
(for example <code class="docutils literal"><span class="pre">'abcd'</span></code>),
or a table of numbers and strings (for example <code class="docutils literal"><span class="pre">{1234,</span> <span class="pre">'abcd'}</span></code>).
Each part of a search-value will be compared to each part of an index key.</p>
<div class="table container">
<p><strong>Iterator types for TREE indexes</strong></p>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p>Formally the logic for TREE index searches is: <br />
comparison-operator is = or &gt;= or &gt; or &lt;= or &lt; depending on
iterator-type</p>
<pre class="highlight literal-block">
for i = 1 to number-of-parts-of-search-value
    if (search-value-part[i] is <code class="docutils literal"><span class="pre">nil</span></code> and &lt;comparison-operator&gt; is &quot;=&quot;) or
       (search-value-part[i] &lt;comparison-operator&gt; index-key-part[i] is true) then
           comparison-result[i] is true
    endif
</pre>
<p>if all comparison-results are true, then search-value &quot;matches&quot;
index key.</p>
<p class="last">Notice how, according to this logic, regardless what the index-key-part
contains, the comparison-result for equality is always true when a
search-value-part is <code class="docutils literal"><span class="pre">nil</span></code> or is missing. This behavior of
searches with nil is subject to change.</p>
</div>
<table border="1" class="left-align-column-1 left-align-column-2 left-align-column-3 docutils">
<colgroup>
<col width="21%" />
<col width="15%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type</th>
<th class="head">Arguments</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>box.index.EQ
or 'EQ'</td>
<td>search
value</td>
<td>The comparison operator is '==' (equal to).
If an index key is equal to a search value,
it matches.
Tuples are returned in ascending order by
index key. This is the default.</td>
</tr>
<tr class="row-odd"><td>box.index.REQ
or 'REQ'</td>
<td>search
value</td>
<td>Matching is the same as for
<code class="docutils literal"><span class="pre">box.index.EQ</span></code>.
Tuples are returned in descending order by
index key.</td>
</tr>
<tr class="row-even"><td>box.index.GT
or 'GT'</td>
<td>search
value</td>
<td>The comparison operator is '&gt;' (greater
than).
If an index key is greater than a search
value, it matches.
Tuples are returned in ascending order by
index key.</td>
</tr>
<tr class="row-odd"><td>box.index.GE
or 'GE'</td>
<td>search
value</td>
<td>The comparison operator is '&gt;=' (greater
than or equal to).
If an index key is greater than or equal to
a search value, it matches.
Tuples are returned in ascending order by
index key.</td>
</tr>
<tr class="row-even"><td>box.index.ALL
or 'ALL'</td>
<td>search
value</td>
<td>Same as box.index.GE.</td>
</tr>
<tr class="row-odd"><td>box.index.LT
or 'LT'</td>
<td>search
value</td>
<td>The comparison operator is '&lt;' (less than).
If an index key is less than a search
value, it matches.
Tuples are returned in descending order by
index key.</td>
</tr>
<tr class="row-even"><td>box.index.LE
or 'LE'</td>
<td>search
value</td>
<td>The comparison operator is '&lt;=' (less than
or equal to).
If an index key is less than or equal to a
search value, it matches.
Tuples are returned in descending order by
index key.</td>
</tr>
</tbody>
</table>
<p><strong>Iterator types for HASH indexes</strong></p>
<table border="1" class="left-align-column-1 left-align-column-2 left-align-column-3 docutils">
<colgroup>
<col width="20%" />
<col width="15%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type</th>
<th class="head">Arguments</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>box.index.ALL</td>
<td>none</td>
<td>All index keys match.
Tuples are returned in ascending order by
hash of index key, which will appear to be
random.</td>
</tr>
<tr class="row-odd"><td>box.index.EQ
or 'EQ'</td>
<td>search
value</td>
<td>The comparison operator is '==' (equal to).
If an index key is equal to a search value,
it matches.
The number of returned tuples will be 0 or 1.
This is the default.</td>
</tr>
<tr class="row-even"><td>box.index.GT
or 'GT'</td>
<td>search
value</td>
<td>The comparison operator is '&gt;' (greater than).
If a hash of an index key is greater than a
hash of a search value, it matches.
Tuples are returned in ascending order by hash
of index key, which will appear to be random.
Provided that the space is not being updated,
one can retrieve all the tuples in a space,
N tuples at a time, by using
{iterator='GT', limit=N}
in each search, and using the last returned
value from the previous result as the start
search value for the next search.</td>
</tr>
</tbody>
</table>
<p><strong>Iterator types for BITSET indexes</strong></p>
<table border="1" class="left-align-column-1 left-align-column-2 left-align-column-3 docutils">
<colgroup>
<col width="33%" />
<col width="13%" />
<col width="54%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type</th>
<th class="head">Arguments</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>box.index.ALL
or 'ALL'</td>
<td>none</td>
<td>All index keys match.
Tuples are returned in their order within
the space.</td>
</tr>
<tr class="row-odd"><td>box.index.EQ
or 'EQ'</td>
<td>bitset
value</td>
<td>If an index key is equal to a bitset value,
it matches.
Tuples are returned in their order within
the space. This is the default.</td>
</tr>
<tr class="row-even"><td>box.index.BITS_ALL_SET</td>
<td>bitset
value</td>
<td>If all of the bits which are 1 in the bitset
value are 1 in the index key, it matches.
Tuples are returned in their order within
the space.</td>
</tr>
<tr class="row-odd"><td>box.index.BITS_ANY_SET</td>
<td>bitset
value</td>
<td>If any of the bits which are 1 in the bitset
value are 1 in the index key, it matches.
Tuples are returned in their order within
the space.</td>
</tr>
<tr class="row-even"><td>box.index.BITS_ALL_NOT_SET</td>
<td>bitset
value</td>
<td>If all of the bits which are 1 in the bitset
value are 0 in the index key, it matches.
Tuples are returned in their order within
the space.</td>
</tr>
</tbody>
</table>
<p id="rtree-iterator"><strong>Iterator types for RTREE indexes</strong></p>
<table border="1" class="left-align-column-1 left-align-column-2 left-align-column-3 docutils">
<colgroup>
<col width="23%" />
<col width="13%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type</th>
<th class="head">Arguments</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>box.index.ALL
or 'ALL'</td>
<td>none</td>
<td>All keys match.
Tuples are returned in their order within the space.</td>
</tr>
<tr class="row-odd"><td>box.index.EQ
or 'EQ'</td>
<td>search
value</td>
<td>If all points of the rectangle-or-box defined by the
search value are the same as the rectangle-or-box
defined by the index key, it matches.
Tuples are returned in their order within the space.
&quot;Rectangle-or-box&quot; means &quot;rectangle-or-box as
explained in section about
<a class="reference internal" href="#box-index-rtree"><span class="std std-ref">RTREE</span></a>&quot;. This is the default.</td>
</tr>
<tr class="row-even"><td>box.index.GT
or 'GT'</td>
<td>search
value</td>
<td>If all points of the rectangle-or-box defined by the
search value are within the rectangle-or-box
defined by the index key, it matches.
Tuples are returned in their order within the space.</td>
</tr>
<tr class="row-odd"><td>box.index.GE
or 'GE'</td>
<td>search
value</td>
<td>If all points of the rectangle-or-box defined by the
search value are within, or at the side of, the
rectangle-or-box defined by the index key, it matches.
Tuples are returned in their order within the space.</td>
</tr>
<tr class="row-even"><td>box.index.LT
or 'LT'</td>
<td>search
value</td>
<td>If all points of the rectangle-or-box defined by the
index key are within the rectangle-or-box
defined by the search key, it matches.
Tuples are returned in their order within the space.</td>
</tr>
<tr class="row-odd"><td>box.index.LE
or 'LE'</td>
<td>search
value</td>
<td>If all points of the rectangle-or-box defined by the
index key are within, or at the side of, the
rectangle-or-box defined by the search key, it matches.
Tuples are returned in their order within the space.</td>
</tr>
<tr class="row-even"><td>box.index.OVERLAPS
or 'OVERLAPS'</td>
<td>search
values</td>
<td>If some points of the rectangle-or-box defined by the
search value are within the rectangle-or-box
defined by the index key, it matches.
Tuples are returned in their order within the space.</td>
</tr>
<tr class="row-odd"><td>box.index.NEIGHBOR
or 'NEIGHBOR'</td>
<td>search
value</td>
<td>If some points of the rectangle-or-box defined by the
defined by the key are within, or at the side of,
defined by the index key, it matches.
Tuples are returned in order: nearest neighbor first.</td>
</tr>
</tbody>
</table>
</div>
<p><strong>First Example of index pairs():</strong></p>
<p>Default 'TREE' Index and <code class="docutils literal"><span class="pre">pairs()</span></code> function:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">space17&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">}</span>
<span class="gp">         &gt; </span><span class="p">})</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">C&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">C&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;C&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;C&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">A&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;B&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;A&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">C&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">!&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;C&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;!&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">A&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">C&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;A&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;C&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">example</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tuple</span> <span class="k">in</span>
<span class="gp">         &gt; </span>    <span class="n">s</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">primary</span><span class="p">:</span><span class="nb">pairs</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>        <span class="n">iterator</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">ALL</span><span class="p">})</span> <span class="k">do</span>
<span class="gp">         &gt; </span>      <span class="nb">print</span><span class="p">(</span><span class="n">tuple</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="k">end</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">example</span><span class="p">()</span>
<span class="go">[&#39;A&#39;, &#39;C&#39;]</span>
<span class="go">[&#39;B&#39;, &#39;A&#39;]</span>
<span class="go">[&#39;C&#39;, &#39;!&#39;]</span>
<span class="go">[&#39;C&#39;, &#39;C&#39;]</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">drop</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p><strong>Second Example of index pairs():</strong></p>
<p>This Lua code finds all the tuples whose primary key values begin with 'XY'.
The assumptions include that there is a one-part primary-key
TREE index on the first field, which must be a string. The iterator loop ensures
that the search will return tuples where the first value
is greater than or equal to 'XY'. The conditional statement
within the loop ensures that the looping will stop when the
first two letters are not 'XY'.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">tuple</span> <span class="k">in</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">primary</span><span class="p">:</span><span class="nb">pairs</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">XY&quot;</span><span class="p">,{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">GE&quot;</span><span class="p">})</span> <span class="k">do</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">string.sub</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">~=</span> <span class="s2">&quot;</span><span class="s">XY&quot;</span><span class="p">)</span> <span class="k">then</span> <span class="k">break</span> <span class="k">end</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">tuple</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Third Example of index pairs():</strong></p>
<p>This Lua code finds all the tuples whose primary key values are
greater than or equal to 1000, and less than or equal to 1999
(this type of request is sometimes called a &quot;range search&quot; or a &quot;between search&quot;).
The assumptions include that there is a one-part primary-key
TREE index on the first field, which must be a number. The iterator loop ensures
that the search will return tuples where the first value
is greater than or equal to 1000. The conditional statement
within the loop ensures that the looping will stop when the
first value is greater than 1999.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">tuple</span> <span class="k">in</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">t2</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">primary</span><span class="p">:</span><span class="nb">pairs</span><span class="p">(</span><span class="mi">1000</span><span class="p">,{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">GE&quot;</span><span class="p">})</span> <span class="k">do</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1999</span><span class="p">)</span> <span class="k">then</span> <span class="k">break</span> <span class="k">end</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">tuple</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-index-select"></span><dl class="method">
<dt id="lua-функция.index_object.select">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">select</code><big>(</big><em>search-key</em>, <em>options</em><big>)</big><a class="headerlink" href="#lua-функция.index_object.select" title="Ссылка на это определение">¶</a></dt>
<dd><p>This is an alternative to <a class="reference internal" href="singlehtml.html#box-space-select"><span class="std std-ref">box.space...select()</span></a>
which goes via a particular index and can make use of additional
parameters that specify the iterator type, and the limit (that is, the
maximum number of tuples to return) and the offset (that is, which
tuple to start with in the list).</p>
<p>Parameters:</p>
<ul>
<li><p class="first"><code class="samp docutils literal"><em><span class="pre">index_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;</p>
</li>
<li><p class="first"><code class="samp docutils literal"><span class="pre">search-key</span></code> = values to be matched against the index key;</p>
</li>
<li><dl class="first docutils">
<dt><code class="samp docutils literal"><span class="pre">option(s)</span></code> any or all of</dt>
<dd><ul class="first last simple">
<li><code class="samp docutils literal"><span class="pre">iterator</span> <span class="pre">=</span> <em><span class="pre">iterator-type</span></em></code>,</li>
<li><code class="samp docutils literal"><span class="pre">limit</span> <span class="pre">=</span> <em><span class="pre">maximum-number-of-tuples</span></em></code>,</li>
<li><code class="samp docutils literal"><span class="pre">offset</span> <span class="pre">=</span> <em><span class="pre">start-tuple-number</span></em></code>.</li>
</ul>
</dd>
</dl>
</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the tuple or tuples that match the field values.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">array of tuples</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">-- Create a space named tester.</span>
<span class="gp">tarantool&gt; </span><span class="n">sp</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="go">-- Create a unique index &#39;primary&#39;</span>
<span class="go">-- which won&#39;t be needed for this example.</span>
<span class="gp">tarantool&gt; </span><span class="n">sp</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span> <span class="p">}})</span>
<span class="go">-- Create a non-unique index &#39;secondary&#39;</span>
<span class="go">-- with an index on the second field.</span>
<span class="gp">tarantool&gt; </span><span class="n">sp</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">secondary&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">tree&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">unique</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">}</span>
<span class="gp">         &gt; </span><span class="p">})</span>
<span class="go">-- Insert three tuples, values in field[2]</span>
<span class="go">-- equal to &#39;X&#39;, &#39;Y&#39;, and &#39;Z&#39;.</span>
<span class="gp">tarantool&gt; </span><span class="n">sp</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">X&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Row with field[2]=X&#39;</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">sp</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Y&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Row with field[2]=Y&#39;</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">sp</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Z&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Row with field[2]=Z&#39;</span><span class="p">}</span>
<span class="go">-- Select all tuples where the secondary index</span>
<span class="go">-- keys are greater than &#39;X&#39;.`</span>
<span class="gp">tarantool&gt; </span><span class="n">sp</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">secondary</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="s1">&#39;</span><span class="s">X&#39;</span><span class="p">},</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GT&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">limit</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="gp">         &gt; </span><span class="p">})</span>
</pre></div>
</div>
<p>The result will be a table of tuple and will look like this:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="s">&#39;Y&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;Row</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">field[2]=Y&#39;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span> <span class="s">&#39;Z&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;Row</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">field[2]=Z&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last"><code class="samp docutils literal"><span class="pre">index.</span><em><span class="pre">index-name</span></em></code> is optional. If it is omitted, then the assumed
index is the first (primary-key) index. Therefore, for the example
above, <code class="docutils literal"><span class="pre">box.space.tester:select({1},</span> <span class="pre">{iterator</span> <span class="pre">=</span> <span class="pre">'GT'})</span></code> would have
returned the same two rows, via the 'primary' index.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last"><code class="samp docutils literal"><span class="pre">iterator</span> <span class="pre">=</span> <em><span class="pre">iterator-type</span></em></code> is optional. If it is omitted, then
<code class="docutils literal"><span class="pre">iterator</span> <span class="pre">=</span> <span class="pre">'EQ'</span></code> is assumed.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last"><code class="samp docutils literal"><em><span class="pre">field-value</span></em> <span class="pre">[,</span> <em><span class="pre">field-value</span> <span class="pre">...</span></em><span class="pre">]</span></code> is optional. If it is omitted,
then every key in the index is considered to be a match, regardless of
iterator type. Therefore, for the example above,
<code class="docutils literal"><span class="pre">box.space.tester:select{}</span></code> will select every tuple in the tester
space via the first (primary-key) index.</p>
</div>
<div class="admonition note" id="box-index-note">
<p class="first admonition-title">Примечание</p>
<p class="last"><code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">.index.</span><em><span class="pre">index-name</span></em><span class="pre">:select(...)[1]`</span></code>. can be
replaced by <code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">.index.</span><em><span class="pre">index-name</span></em><span class="pre">:get(...)</span></code>.
That is, <code class="docutils literal"><span class="pre">get</span></code> can be used as a convenient shorthand to get the first
tuple in the tuple set that would be returned by <code class="docutils literal"><span class="pre">select</span></code>. However,
if there is more than one tuple in the tuple set, then <code class="docutils literal"><span class="pre">get</span></code> returns
an error.</p>
</div>
<p><strong>Example with BITSET index:</strong></p>
<p>The following script shows creation and search with a BITSET index.
Notice: BITSET cannot be unique, so first a primary-key index is created.
Notice: bit values are entered as hexadecimal literals for easier reading.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">space_with_bitset&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary_index&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">},</span>
<span class="gp">         &gt; </span>  <span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">TREE&#39;</span>
<span class="gp">         &gt; </span><span class="p">})</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">bitset_index&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">},</span>
<span class="gp">         &gt; </span>  <span class="n">unique</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">BITSET&#39;</span>
<span class="gp">         &gt; </span><span class="p">})</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">Tuple with bit value = 01&#39;</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">Tuple with bit value = 10&#39;</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">Tuple with bit value = 11&#39;</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">bitset_index</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">iterator</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">EQ</span>
<span class="gp">         &gt; </span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">bit</span><span class="nv"> </span><span class="s">value</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">10&#39;</span><span class="p p-Indicator">,</span> <span class="nv">2</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">bitset_index</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">iterator</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">BITS_ANY_SET</span>
<span class="gp">         &gt; </span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">bit</span><span class="nv"> </span><span class="s">value</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">10&#39;</span><span class="p p-Indicator">,</span> <span class="nv">2</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">bit</span><span class="nv"> </span><span class="s">value</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">11&#39;</span><span class="p p-Indicator">,</span> <span class="nv">3</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">bitset_index</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">iterator</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">BITS_ALL_SET</span>
<span class="gp">         &gt; </span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">bit</span><span class="nv"> </span><span class="s">value</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">10&#39;</span><span class="p p-Indicator">,</span> <span class="nv">2</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">bit</span><span class="nv"> </span><span class="s">value</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">11&#39;</span><span class="p p-Indicator">,</span> <span class="nv">3</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">bitset_index</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">iterator</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">BITS_ALL_NOT_SET</span>
<span class="gp">         &gt; </span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">bit</span><span class="nv"> </span><span class="s">value</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">01&#39;</span><span class="p p-Indicator">,</span> <span class="nv">1</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-index-get"></span><dl class="method">
<dt id="lua-функция.index_object.get">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">get</code><big>(</big><em>key</em><big>)</big><a class="headerlink" href="#lua-функция.index_object.get" title="Ссылка на это определение">¶</a></dt>
<dd><p>Search for a tuple via the given index, as described <a class="reference internal" href="#box-index-note"><span class="std std-ref">earlier</span></a>.</p>
<p>Parameters: <code class="samp docutils literal"><em><span class="pre">space_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;
<span class="ccodei">key</span> (type = Lua table or scalar) = key to be matched against the index key,
which may be multi-part.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the tuple whose index-key fields are equal to the passed key values.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">tuple</td>
</tr>
</tbody>
</table>
<p>Possible errors: No such index; wrong type; more than one tuple matches.</p>
<p>Complexity Factors: Index size, Index type.
See also <a class="reference internal" href="singlehtml.html#box-space-get"><span class="std std-ref">space_object:get()</span></a>.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">primary</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="s">&#39;Music&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-index-min"></span><dl class="method">
<dt id="lua-функция.index_object.min">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">min</code><big>(</big><span class="optional">[</span><em>key-value</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.index_object.min" title="Ссылка на это определение">¶</a></dt>
<dd><p>Find the minimum value in the specified index.</p>
<p>Parameters:</p>
<ul class="simple">
<li><code class="samp docutils literal"><em><span class="pre">index_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;</li>
<li><code class="samp docutils literal"><span class="pre">key-value</span></code>.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the tuple for the first key in the index. If optional
<code class="docutils literal"><span class="pre">key-value</span></code> is supplied, returns the first key which
is greater than or equal to <code class="docutils literal"><span class="pre">key-value</span></code>.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">tuple</td>
</tr>
</tbody>
</table>
<p>Possible errors: index is not of type 'TREE'.</p>
<p>Complexity Factors: Index size, Index type.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">primary</span><span class="p">:</span><span class="n">min</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;Alpha!&#39;</span><span class="p p-Indicator">,</span> <span class="nv">55</span><span class="p p-Indicator">,</span> <span class="s">&#39;This</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">first</span><span class="nv"> </span><span class="s">tuple!&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-index-max"></span><dl class="method">
<dt id="lua-функция.index_object.max">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">max</code><big>(</big><span class="optional">[</span><em>key-value</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.index_object.max" title="Ссылка на это определение">¶</a></dt>
<dd><p>Find the maximum value in the specified index.</p>
<p>Parameters:</p>
<ul class="simple">
<li><code class="samp docutils literal"><em><span class="pre">index_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;</li>
<li><code class="samp docutils literal"><span class="pre">key-value</span></code>.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the tuple for the last key in the index. If optional <code class="docutils literal"><span class="pre">key-value</span></code>
is supplied, returns the last key which is less than or equal to
<code class="docutils literal"><span class="pre">key-value</span></code>.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">tuple</td>
</tr>
</tbody>
</table>
<p>Possible errors: index is not of type 'TREE'.</p>
<p>Complexity Factors: Index size, Index type.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">primary</span><span class="p">:</span><span class="n">max</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;Gamma!&#39;</span><span class="p p-Indicator">,</span> <span class="nv">55</span><span class="p p-Indicator">,</span> <span class="s">&#39;This</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">third</span><span class="nv"> </span><span class="s">tuple!&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-index-random"></span><dl class="method">
<dt id="lua-функция.index_object.random">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">random</code><big>(</big><em>random-value</em><big>)</big><a class="headerlink" href="#lua-функция.index_object.random" title="Ссылка на это определение">¶</a></dt>
<dd><p>Find a random value in the specified index. This method is useful when it's
important to get insight into data distribution in an index without having
to iterate over the entire data set.</p>
<p>Parameters:</p>
<ul class="simple">
<li><code class="samp docutils literal"><em><span class="pre">index_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;</li>
<li><code class="samp docutils literal"><span class="pre">random-value</span></code> (type = number) = an arbitrary non-negative integer.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the tuple for the random key in the index.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">tuple</td>
</tr>
</tbody>
</table>
<p>Complexity Factors: Index size, Index type.</p>
<p>Note re storage engine: vinyl does not support <code class="docutils literal"><span class="pre">random()</span></code>.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">secondary</span><span class="p">:</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;Beta!&#39;</span><span class="p p-Indicator">,</span> <span class="nv">66</span><span class="p p-Indicator">,</span> <span class="s">&#39;This</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">second</span><span class="nv"> </span><span class="s">tuple!&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-index-count"></span><dl class="method">
<dt id="lua-функция.index_object.count">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">count</code><big>(</big><span class="optional">[</span><em>key</em><span class="optional">]</span><span class="optional">[</span>, <em>iterator</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.index_object.count" title="Ссылка на это определение">¶</a></dt>
<dd><p>Iterate over an index, counting the number of
tuples which match the key-value.</p>
<p>Parameters:</p>
<ul class="simple">
<li><code class="samp docutils literal"><em><span class="pre">index_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;</li>
<li><code class="samp docutils literal"><em><span class="pre">key-value</span></em></code> (type = Lua table or scalar) =
the value which must match the key(s) in the specified index. The type
may be a list of field-values, or a tuple containing only the
field-values;  <span class="ccodei">iterator</span> = comparison method.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the number of matching index keys.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">number</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">primary</span><span class="p">:</span><span class="n">count</span><span class="p">(</span><span class="mi">999</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">primary</span><span class="p">:</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Alpha!&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">LE&#39;</span> <span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.index_object.update">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">update</code><big>(</big><em>key</em>, <em>{{operator</em>, <em>field_no</em>, <em>value}</em>, <em>...}</em><big>)</big><a class="headerlink" href="#lua-функция.index_object.update" title="Ссылка на это определение">¶</a></dt>
<dd><p>Update a tuple.</p>
<p>Same as <a class="reference internal" href="singlehtml.html#box-space-update"><span class="std std-ref">box.space...update()</span></a>,
but key is searched in this index instead of primary key.
This index ought to be unique.</p>
<p>Parameters:</p>
<ul class="simple">
<li><code class="samp docutils literal"><em><span class="pre">index_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;</li>
<li><code class="samp docutils literal"><em><span class="pre">key</span></em></code> (type = Lua table or scalar) = key to be matched against
the index key;</li>
<li><code class="samp docutils literal"><em><span class="pre">operator,</span> <span class="pre">field_no,</span> <span class="pre">value</span></em></code> (type = Lua table) = update
operations (see: <a class="reference internal" href="singlehtml.html#box-space-update"><span class="std std-ref">box.space...update()</span></a>).</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the updated tuple.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">tuple</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="lua-функция.index_object.delete">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">delete</code><big>(</big><em>key</em><big>)</big><a class="headerlink" href="#lua-функция.index_object.delete" title="Ссылка на это определение">¶</a></dt>
<dd><p>Delete a tuple identified by a key.</p>
<p>Same as <a class="reference internal" href="singlehtml.html#box-space-delete"><span class="std std-ref">box.space...delete()</span></a>, but key is
searched in this index instead of in the primary-key index. This index
ought to be unique.</p>
<p>Parameters:</p>
<ul class="simple">
<li><code class="samp docutils literal"><em><span class="pre">index_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;</li>
<li><code class="samp docutils literal"><span class="pre">key</span></code> (type = Lua table or scalar) = key to be matched against
the index key.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the deleted tuple.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">tuple</td>
</tr>
</tbody>
</table>
<p>Note re storage engine: vinyl will return nil, rather than the deleted tuple.</p>
</dd></dl>

<span class="target" id="box-index-alter"></span><dl class="method">
<dt id="lua-функция.index_object.alter">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">alter</code><big>(</big><em>{options}</em><big>)</big><a class="headerlink" href="#lua-функция.index_object.alter" title="Ссылка на это определение">¶</a></dt>
<dd><p>Alter an index.</p>
<p>Parameters:</p>
<ul class="simple">
<li><code class="samp docutils literal"><em><span class="pre">index_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;</li>
<li><code class="samp docutils literal"><em><span class="pre">options</span></em></code> = options list, same as the options list for
<a class="reference internal" href="singlehtml.html#box-space-create-index"><span class="std std-ref">create_index</span></a>.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">nil</td>
</tr>
</tbody>
</table>
<p>Possible errors: Index does not exist, or
the first index cannot be changed to {unique = false}, or
the alter function is only applicable for the memtx storage engine.</p>
<p>Note re storage engine: vinyl does not support <code class="docutils literal"><span class="pre">alter()</span></code>.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">space55</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">primary</span><span class="p">:</span><span class="n">alter</span><span class="p">({</span><span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">HASH&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.index_object.drop">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">drop</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.index_object.drop" title="Ссылка на это определение">¶</a></dt>
<dd><p>Drop an index. Dropping a primary-key index has
a side effect: all tuples are deleted.</p>
<p>Parameters:</p>
<ul class="simple">
<li><code class="samp docutils literal"><em><span class="pre">index_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">nil.</td>
</tr>
</tbody>
</table>
<p>Possible errors: Index does not exist, or a primary-key index cannot
be dropped while a secondary-key index exists.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">space55</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">primary</span><span class="p">:</span><span class="n">drop</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.index_object.rename">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">rename</code><big>(</big><em>index-name</em><big>)</big><a class="headerlink" href="#lua-функция.index_object.rename" title="Ссылка на это определение">¶</a></dt>
<dd><p>Rename an index.</p>
<p>Parameters:</p>
<ul class="simple">
<li><code class="samp docutils literal"><em><span class="pre">index_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>;</li>
<li><code class="samp docutils literal"><em><span class="pre">index-name</span></em></code> (type = string) = new name for index.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">nil</td>
</tr>
</tbody>
</table>
<p>Possible errors: index_object does not exist.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">space55</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">primary</span><span class="p">:</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">secondary&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Complexity Factors: Index size, Index type, Number of tuples accessed.</p>
</dd></dl>

<dl class="method">
<dt id="lua-функция.index_object.bsize">
<em class="property"> </em><code class="descclassname">index_object:</code><code class="descname">bsize</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.index_object.bsize" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the total number of bytes taken by the index.</p>
<p>Parameters:</p>
<ul class="simple">
<li><code class="samp docutils literal"><em><span class="pre">index_object</span></em></code> = an <a class="reference internal" href="singlehtml.html#index-object-reference"><span class="std std-ref">object reference</span></a>.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">number of bytes</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">number</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<div class="section" id="example-showing-use-of-the-box-functions">
<h6>3.4.3.1. Example showing use of the box functions<a class="headerlink" href="#example-showing-use-of-the-box-functions" title="Ссылка на этот заголовок">¶</a></h6>
<p>This example will work with the sandbox configuration described in the preface.
That is, there is a space named tester with a numeric primary key. The example
function will:</p>
<ul>
<li><p class="first">select a tuple whose key value is 1000;</p>
</li>
<li><p class="first">return an error if the tuple already exists and already has 3 fields;</p>
</li>
<li><dl class="first docutils">
<dt>Insert or replace the tuple with:</dt>
<dd><ul class="first last simple">
<li>field[1] = 1000</li>
<li>field[2] = a uuid</li>
<li>field[3] = number of seconds since 1970-01-01;</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">Get field[3] from what was replaced;</p>
</li>
<li><p class="first">Format the value from field[3] as yyyy-mm-dd hh:mm:ss.ffff;</p>
</li>
<li><p class="first">Return the formatted value.</p>
</li>
</ul>
<p>The function uses Tarantool box functions
<a class="reference internal" href="singlehtml.html#box-space-select"><span class="std std-ref">box.space...select</span></a>,
<a class="reference internal" href="singlehtml.html#box-space-replace"><span class="std std-ref">box.space...replace</span></a>, <a class="reference internal" href="singlehtml.html#fiber-time"><span class="std std-ref">fiber.time</span></a>,
<a class="reference internal" href="singlehtml.html#uuid-str"><span class="std std-ref">uuid.str</span></a>. The function uses
Lua functions <a class="reference external" href="http://www.lua.org/pil/22.1.html">os.date()</a> and <a class="reference external" href="http://www.lua.org/pil/20.html">string.sub()</a>.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">example</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">table_of_selected_tuples</span><span class="p">,</span> <span class="n">d</span>
  <span class="kd">local</span> <span class="n">replaced_tuple</span><span class="p">,</span> <span class="n">time_field</span>
  <span class="kd">local</span> <span class="n">formatted_time_field</span>
  <span class="kd">local</span> <span class="n">fiber</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fiber&#39;</span><span class="p">)</span>
  <span class="n">table_of_selected_tuples</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1000</span><span class="p">}</span>
  <span class="k">if</span> <span class="n">table_of_selected_tuples</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="k">then</span>
    <span class="k">if</span> <span class="n">table_of_selected_tuples</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="k">then</span>
      <span class="k">if</span> <span class="o">#</span><span class="n">table_of_selected_tuples</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">then</span>
        <span class="n">box</span><span class="p">.</span><span class="n">error</span><span class="p">({</span><span class="n">code</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">This tuple already has 3 fields&#39;</span><span class="p">})</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">replaced_tuple</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span>
    <span class="p">{</span><span class="mi">1000</span><span class="p">,</span>  <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">uuid&#39;</span><span class="p">).</span><span class="n">str</span><span class="p">(),</span> <span class="nb">tostring</span><span class="p">(</span><span class="n">fiber</span><span class="p">.</span><span class="n">time</span><span class="p">())}</span>
  <span class="n">time_field</span> <span class="o">=</span> <span class="nb">tonumber</span><span class="p">(</span><span class="n">replaced_tuple</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
  <span class="n">formatted_time_field</span> <span class="o">=</span> <span class="nb">os.date</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">%Y-%m-%d %H:%M:%S&quot;</span><span class="p">,</span> <span class="n">time_field</span><span class="p">)</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">time_field</span> <span class="o">%</span> <span class="mi">1</span>
  <span class="n">d</span> <span class="o">=</span> <span class="nb">string.sub</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
  <span class="n">formatted_time_field</span> <span class="o">=</span> <span class="n">formatted_time_field</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s">.&#39;</span> <span class="o">..</span> <span class="n">d</span>
  <span class="k">return</span> <span class="n">formatted_time_field</span>
<span class="k">end</span>
</pre></div>
</div>
<p>... And here is what happens when one invokes the function:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">delete</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1000</span><span class="p p-Indicator">,</span> <span class="s">&#39;264ee2da03634f24972be76c43808254&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;1391037015.6809&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">example</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">2014-01-29 16:11:51.1582</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">example</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="s">&#39;This</span><span class="nv"> </span><span class="s">tuple</span><span class="nv"> </span><span class="s">already</span><span class="nv"> </span><span class="s">has</span><span class="nv"> </span><span class="s">3</span><span class="nv"> </span><span class="s">fields&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="section" id="example-showing-a-user-defined-iterator">
<h6>3.4.3.2. Example showing a user-defined iterator<a class="headerlink" href="#example-showing-a-user-defined-iterator" title="Ссылка на этот заголовок">¶</a></h6>
<p>Here is an example that shows how to build one's own iterator.
The <code class="docutils literal"><span class="pre">paged_iter</span></code> function is an &quot;iterator function&quot;, which will only be
understood by programmers who have read the Lua
manual section
<a class="reference external" href="https://www.lua.org/pil/7.1.html">Iterators and Closures</a>.
It does paginated retrievals, that is, it returns 10
tuples at a time from a table named &quot;t&quot;, whose
primary key was defined with
<span class="ccode">create_index('primary',{parts={1,'string'}})</span>.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">paged_iter</span><span class="p">(</span><span class="n">search_key</span><span class="p">,</span> <span class="n">tuples_per_page</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">iterator_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">GE&quot;</span>
  <span class="k">return</span> <span class="k">function</span> <span class="p">()</span>
  <span class="kd">local</span> <span class="n">page</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="nb">select</span><span class="p">(</span><span class="n">search_key</span><span class="p">,</span>
    <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="n">iterator_string</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">tuples_per_page</span><span class="p">})</span>
  <span class="k">if</span> <span class="o">#</span><span class="n">page</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">return</span> <span class="kc">nil</span> <span class="k">end</span>
  <span class="n">search_key</span> <span class="o">=</span> <span class="n">page</span><span class="p">[</span><span class="o">#</span><span class="n">page</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">iterator_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">GT&quot;</span>
  <span class="k">return</span> <span class="n">page</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Programmers who use <code class="docutils literal"><span class="pre">paged_iter</span></code> do not need to know
why it works, they only need to know that, if they
call it within a loop, they will get 10 tuples
at a time until there are no more tuples. In this
example the tuples are merely printed, a page at a time.
But it should be simple to change the functionality,
for example by yielding after each retrieval, or
by breaking when the tuples fail to match some
additional criteria.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">page</span> <span class="k">in</span> <span class="n">paged_iter</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">X&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">do</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">New Page. Number Of Tuples = &quot;</span> <span class="o">..</span> <span class="o">#</span><span class="n">page</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="o">#</span><span class="n">page</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span> <span class="nb">print</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="submodule-box-index-with-index-type-rtree-for-spatial-searches">
<span id="box-index-rtree"></span><h6>3.4.3.3. Submodule <cite>box.index</cite> with index type = RTREE for spatial searches<a class="headerlink" href="#submodule-box-index-with-index-type-rtree-for-spatial-searches" title="Ссылка на этот заголовок">¶</a></h6>
<p>The <a class="reference internal" href="#box-index"><span class="std std-ref">box.index</span></a> submodule may be used for spatial searches if the index type
is RTREE. There are operations for searching <em>rectangles</em> (geometric objects
with 4 corners and 4 sides) and <em>boxes</em> (geometric objects with more than 4
corners and more than 4 sides, sometimes called hyperrectangles). This manual
uses the term <em>rectangle-or-box</em> for the whole class of objects that includes both
rectangles and boxes. Only rectangles will be illustrated.</p>
<p>Rectangles are described according to their X-axis (horizontal axis) and Y-axis
(vertical axis) coordinates in a grid of arbitrary size. Here is a picture of
four rectangles on a grid with 11 horizontal points and 11 vertical points:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>           <span class="n">X</span> <span class="n">AXIS</span>
           <span class="mi">1</span>   <span class="mi">2</span>   <span class="mi">3</span>   <span class="mi">4</span>   <span class="mi">5</span>   <span class="mi">6</span>   <span class="mi">7</span>   <span class="mi">8</span>   <span class="mi">9</span>   <span class="mi">10</span>  <span class="mi">11</span>
        <span class="mi">1</span>
        <span class="mi">2</span>  <span class="c1">#-------+                                           &lt;-Rectangle#1</span>
<span class="n">Y</span> <span class="n">AXIS</span>  <span class="mi">3</span>  <span class="o">|</span>       <span class="o">|</span>
        <span class="mi">4</span>  <span class="o">+-------</span><span class="c1">#</span>
        <span class="mi">5</span>          <span class="c1">#-----------------------+                   &lt;-Rectangle#2</span>
        <span class="mi">6</span>          <span class="o">|</span>                       <span class="o">|</span>
        <span class="mi">7</span>          <span class="o">|</span>   <span class="c1">#---+               |                   &lt;-Rectangle#3</span>
        <span class="mi">8</span>          <span class="o">|</span>   <span class="o">|</span>   <span class="o">|</span>               <span class="o">|</span>
        <span class="mi">9</span>          <span class="o">|</span>   <span class="o">+---</span><span class="c1">#               |</span>
        <span class="mi">10</span>         <span class="o">+-----------------------</span><span class="c1">#</span>
        <span class="mi">11</span>                                     <span class="c1">#               &lt;-Rectangle#4</span>
</pre></div>
</div>
<p>The rectangles are defined according to this scheme: {X-axis coordinate of top
left, Y-axis coordinate of top left, X-axis coordinate of bottom right, Y-axis
coordinate of bottom right} -- or more succinctly: {x1,y1,x2,y2}. So in the
picture ... Rectangle#1 starts at position 1 on the X axis and position 2 on
the Y axis, and ends at position 3 on the X axis and position 4 on the Y axis,
so its coordinates are {1,2,3,4}. Rectangle#2's coordinates are {3,5,9,10}.
Rectangle#3's coordinates are {4,7,5,9}. And finally Rectangle#4's coordinates
are {10,11,10,11}. Rectangle#4 is actually a &quot;point&quot; since it has zero width
and zero height, so it could have been described with only two digits: {10,11}.</p>
<p>Some relationships between the rectangles are: &quot;Rectangle#1's nearest neighbor
is Rectangle#2&quot;, and &quot;Rectangle#3 is entirely inside Rectangle#2&quot;.</p>
<p>Now let us create a space and add an RTREE index.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">rectangles&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">HASH&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}</span>
<span class="gp">         &gt; </span><span class="p">})</span>
<span class="gp">tarantool&gt; </span><span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">rtree&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">RTREE&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">unique</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">ARRAY&#39;</span><span class="p">}</span>
<span class="gp">         &gt; </span><span class="p">})</span>
</pre></div>
</div>
<p>Field#1 doesn't matter, we just make it because we need a primary-key index.
(RTREE indexes cannot be unique and therefore cannot be primary-key indexes.)
The second field must be an &quot;array&quot;, which means its values must represent
{x,y} points or {x1,y1,x2,y2} rectangles. Now let us populate the table by
inserting two tuples, containing the coordinates of Rectangle#2 and Rectangle#4.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">}}</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">}}</span>
</pre></div>
</div>
<p>And now, following the description of <a class="reference internal" href="#rtree-iterator">RTREE iterator types</a>, we can search the
rectangles with these requests:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">r</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">EQ&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="p p-Indicator">[</span><span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">11</span><span class="p p-Indicator">]]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">r</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GT&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">9</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">]]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">r</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">NEIGHBOR&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span> <span class="nv">5</span><span class="p p-Indicator">,</span> <span class="nv">9</span><span class="p p-Indicator">,</span> <span class="nv">10</span><span class="p p-Indicator">]]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="p p-Indicator">[</span><span class="nv">10</span><span class="p p-Indicator">,</span> <span class="nv">11</span><span class="p p-Indicator">]]</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Request#1 returns 1 tuple because the point {10,11} is the same as the rectangle
{10,11,10,11} (&quot;Rectangle#4&quot; in the picture). Request#2 returns 1 tuple because
the rectangle {4,7,5,9}, which was &quot;Rectangle#3&quot; in the picture, is entirely
within{3,5,9,10} which was Rectangle#2. Request#3 returns 2 tuples, because the
NEIGHBOR iterator always returns all tuples, and the first returned tuple will
be {3,5,9,10} (&quot;Rectangle#2&quot; in the picture) because it is the closest neighbor
of {1,2,3,4} (&quot;Rectangle#1&quot; in the picture).</p>
<p>Now let us create a space and index for cuboids, which are rectangle-or-boxes that have
6 corners and 6 sides.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">R&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
<span class="gp">tarantool&gt; </span><span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">S&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">RTREE&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">unique</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">dimension</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">ARRAY&#39;</span><span class="p">}</span>
<span class="gp">         &gt; </span><span class="p">})</span>
</pre></div>
</div>
<p>The additional field here is <code class="docutils literal"><span class="pre">dimension=3</span></code>. The default dimension is 2, which is
why it didn't need to be specified for the examples of rectangle. The maximum dimension
is 20. Now for insertions and selections there will usually be 6 coordinates. For example:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">}}</span>
<span class="gp">tarantool&gt; </span><span class="n">r</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">GT</span><span class="p">})</span>
</pre></div>
</div>
<p>Now let us create a space and index for Manhattan-style spatial objects, which are rectangle-or-boxes that have
a different way to calculate neighbors.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">R&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
<span class="gp">tarantool&gt; </span><span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">S&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">RTREE&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">unique</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">distance</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">manhattan&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">ARRAY&#39;</span><span class="p">}</span>
<span class="gp">         &gt; </span><span class="p">})</span>
</pre></div>
</div>
<p>The additional field here is <code class="docutils literal"><span class="pre">distance='manhattan'</span></code>.
The default distance calculator is 'euclid', which is the straightforward as-the-crow-flies method.
The optional distance calculator is 'manhattan', which can be a more appropriate method
if one is following the lines of a grid rather than traveling in a straight line.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">}}</span>
<span class="gp">tarantool&gt; </span><span class="n">r</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">NEIGHBOR</span><span class="p">})</span>
</pre></div>
</div>
<p>More examples of spatial searching are online in the file <a class="reference external" href="https://github.com/tarantool/tarantool/wiki/R-tree-index-quick-start-and-usage">R tree index quick
start and usage</a>.</p>
</div>
</div>
<span id="document-book/box/box_session"></span><div class="section" id="submodule-box-session">
<h5>3.4.4. Вложенный модуль <cite>box.session</cite><a class="headerlink" href="#submodule-box-session" title="Ссылка на этот заголовок">¶</a></h5>
<p>The <code class="docutils literal"><span class="pre">box.session</span></code> submodule allows querying the session state, writing to a
session-specific temporary Lua table, or setting up triggers which will fire
when a session starts or ends. A <em>session</em> is an object associated with each
client connection.</p>
<span class="target" id="lua-module.box.session"></span><dl class="function">
<dt id="lua-функция.box.session.id">
<em class="property"> </em><code class="descclassname">box.session.</code><code class="descname">id</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.box.session.id" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the unique identifier (ID) for the current session.
The result can be 0 meaning there is no session.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">number</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.session.exists">
<em class="property"> </em><code class="descclassname">box.session.</code><code class="descname">exists</code><big>(</big><em>id</em><big>)</big><a class="headerlink" href="#lua-функция.box.session.exists" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">1 if the session exists, 0 if the session does not exist.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">number</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.session.peer">
<em class="property"> </em><code class="descclassname">box.session.</code><code class="descname">peer</code><big>(</big><em>id</em><big>)</big><a class="headerlink" href="#lua-функция.box.session.peer" title="Ссылка на это определение">¶</a></dt>
<dd><p>This function works only if there is a peer, that is,
if a connection has been made to a separate server.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">The host address and port of the session peer,
for example &quot;127.0.0.1:55457&quot;.
If the session exists but there is no connection to a
separate server, the return is null.
The command is executed on the server,
so the &quot;local name&quot; is the server's host
and port, and the &quot;peer name&quot; is the client's host
and port.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">string</td>
</tr>
</tbody>
</table>
<p>Possible errors: 'session.peer(): session does not exist'</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.session.sync">
<em class="property"> </em><code class="descclassname">box.session.</code><code class="descname">sync</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.box.session.sync" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the value of the <code class="code docutils literal"><span class="pre">sync</span></code> integer constant used in the
<a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.7/src/box/iproto_constants.h">binary protocol</a>.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">number</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="box-session-storage"></span><dl class="data">
<dt id="lua-данные.box.session.storage">
<em class="property"> </em><code class="descclassname">box.session.</code><code class="descname">storage</code><a class="headerlink" href="#lua-данные.box.session.storage" title="Ссылка на это определение">¶</a></dt>
<dd><p>A Lua table that can hold arbitrary unordered session-specific
names and values, which will last until the session ends.</p>
</dd></dl>

<div class="section" id="example">
<h6>3.4.4.1. Пример<a class="headerlink" href="#example" title="Ссылка на этот заголовок">¶</a></h6>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">peer</span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">id</span><span class="p">())</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">127.0.0.1:45129</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">storage</span><span class="p">.</span><span class="n">random_memorandum</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">Don&#39;t forget the eggs&quot;</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">storage</span><span class="p">.</span><span class="n">radius_of_mars</span> <span class="o">=</span> <span class="mi">3396</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">&#39;</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span> <span class="k">do</span>
<span class="gp">         &gt; </span>  <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">..</span> <span class="n">k</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s">=&#39;</span><span class="o">..</span> <span class="n">v</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> &#39;</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">m</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;radius_of_mars=3396</span><span class="nv"> </span><span class="s">random_memorandum=Don</span><span class="se">&#39;&#39;</span><span class="s">t</span><span class="nv"> </span><span class="s">forget</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">eggs.</span><span class="nv"> </span><span class="s">&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>See the section <a class="reference internal" href="singlehtml.html#triggers-box-triggers"><span class="std std-ref">Triggers</span></a>
for instructions about defining triggers for connect and disconnect
events with <code class="docutils literal"><span class="pre">box.session.on_connect()</span></code> and <code class="docutils literal"><span class="pre">box.session.on_disconnect()</span></code>.
See the section <a class="reference internal" href="singlehtml.html#authentication"><span class="std std-ref">Access control</span></a>
for instructions about <code class="docutils literal"><span class="pre">box.session</span></code> functions that affect user
identification and security.</p>
</div>
</div>
<span id="document-book/box/box_tuple"></span><div class="section" id="lua-module.box.tuple">
<span id="submodule-box-tuple"></span><span id="box-tuple"></span><h5>3.4.5. Вложенный модуль <cite>box.tuple</cite><a class="headerlink" href="#lua-module.box.tuple" title="Ссылка на этот заголовок">¶</a></h5>
<p>The <code class="docutils literal"><span class="pre">box.tuple</span></code> submodule provides read-only access for the <code class="docutils literal"><span class="pre">tuple</span></code>
userdata type. It allows, for a single tuple: selective retrieval of the field
contents, retrieval of information about size, iteration over all the fields,
and conversion to a Lua table.</p>
<span class="target" id="box-tuple-new"></span><dl class="function">
<dt id="lua-функция.box.tuple.new">
<em class="property"> </em><code class="descclassname">box.tuple.</code><code class="descname">new</code><big>(</big><em>value</em><big>)</big><a class="headerlink" href="#lua-функция.box.tuple.new" title="Ссылка на это определение">¶</a></dt>
<dd><p>Construct a new tuple from either a scalar or a Lua table. Alternatively,
one can get new tuples from tarantool's <a class="reference internal" href="singlehtml.html#box-space-select"><span class="std std-ref">select</span></a>
or <a class="reference internal" href="singlehtml.html#box-space-insert"><span class="std std-ref">insert</span></a> or <a class="reference internal" href="singlehtml.html#box-space-replace"><span class="std std-ref">replace</span></a>
or <a class="reference internal" href="singlehtml.html#box-space-update"><span class="std std-ref">update</span></a> requests,
which can be regarded as statements that do
<code class="docutils literal"><span class="pre">new()</span></code> implicitly.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>value</strong> (<em>lua-value</em>) -- the value that will become the tuple contents.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">a new tuple</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">tuple</p>
</td>
</tr>
</tbody>
</table>
<p>In the following example, <code class="docutils literal"><span class="pre">x</span></code> will be a new table object containing one
tuple and <code class="docutils literal"><span class="pre">t</span></code> will be a new tuple object. Saying <code class="docutils literal"><span class="pre">t</span></code> returns the
entire tuple <code class="docutils literal"><span class="pre">t</span></code>.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="mi">33</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="nb">tonumber</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">1&#39;</span><span class="p">),</span>
<span class="gp">         &gt; </span>  <span class="n">tonumber64</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">2&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span><span class="p">}:</span><span class="n">totable</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">abc&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">def&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">ghi&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">abc&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;abc&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;def&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;ghi&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;abc&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="class">
<dt id="lua-объект.box.tuple.tuple_object">
<em class="property">объект </em><code class="descclassname">box.tuple.</code><code class="descname">tuple_object</code><a class="headerlink" href="#lua-объект.box.tuple.tuple_object" title="Ссылка на это определение">¶</a></dt>
<dd><dl class="operator">
<dt id="lua-оператор.&lt;tuple_object&gt;.#">
<em class="property"> </em><code class="descname">#</code><code class="descclassname">&lt;tuple_object&gt;</code><a class="headerlink" href="#lua-оператор.<tuple_object>.#" title="Ссылка на это определение">¶</a></dt>
<dd><p>The <code class="docutils literal"><span class="pre">#</span></code> operator in Lua means &quot;return count of components&quot;. So,
if <code class="docutils literal"><span class="pre">t</span></code> is a tuple instance, <code class="docutils literal"><span class="pre">#t</span></code> will return the number of fields.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body">number</td>
</tr>
</tbody>
</table>
<p>In the following example, a tuple named <code class="docutils literal"><span class="pre">t</span></code> is created and then the
number of fields in <code class="docutils literal"><span class="pre">t</span></code> is returned.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">Fld#1&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#2&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#3&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#4&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="o">#</span><span class="n">t</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.tuple_object.bsize">
<em class="property"> </em><code class="descclassname">tuple_object:</code><code class="descname">bsize</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.tuple_object.bsize" title="Ссылка на это определение">¶</a></dt>
<dd><p>If <code class="docutils literal"><span class="pre">t</span></code> is a tuple instance, <code class="docutils literal"><span class="pre">t:bsize()</span></code> will return the number of
bytes in the tuple. It is useful to check this number when making
changes to data, because there is a fixed maximum: one megabyte. Every
field has one or more &quot;length&quot; bytes preceding the actual contents, so
<code class="docutils literal"><span class="pre">bsize()</span></code> returns a value which is slightly greater than the sum of
the lengths of the contents.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">number of bytes</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">number</td>
</tr>
</tbody>
</table>
<p>In the following example, a tuple named <code class="docutils literal"><span class="pre">t</span></code> is created which has
three fields, and for each field it takes one byte to store the length
and three bytes to store the contents, and a bit for overhead, so
<code class="docutils literal"><span class="pre">bsize()</span></code> returns <code class="docutils literal"><span class="pre">3*(1+3)+1</span></code>.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">aaa&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">bbb&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">ccc&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span><span class="p">:</span><span class="n">bsize</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">13</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="operator">
<dt id="lua-оператор.&lt;tuple_object&gt;.[]">
<em class="property"> </em><code class="descclassname">&lt;tuple_object&gt;</code><big>(</big><em>field-number</em><big>)</big><a class="headerlink" href="#lua-оператор.<tuple_object>.[]" title="Ссылка на это определение">¶</a></dt>
<dd><p>If <code class="docutils literal"><span class="pre">t</span></code> is a tuple instance, <code class="docutils literal"><span class="pre">t[field-number]</span></code> will return the field
numbered field-number in the tuple. The first field is <code class="docutils literal"><span class="pre">t[1]</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">field value.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">lua-value</td>
</tr>
</tbody>
</table>
<p>In the following example, a tuple named <code class="docutils literal"><span class="pre">t</span></code> is created and then the
second field in <code class="docutils literal"><span class="pre">t</span></code> is returned.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">Fld#1&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#2&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#3&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#4&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Fld#2</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.tuple_object.find">
<em class="property"> </em><code class="descclassname">tuple_object:</code><code class="descname">find</code><big>(</big><span class="optional">[</span><em>field-number</em>, <span class="optional">]</span><em>search-value</em><big>)</big><a class="headerlink" href="#lua-функция.tuple_object.find" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.tuple_object.findall">
<em class="property"> </em><code class="descclassname">tuple_object:</code><code class="descname">findall</code><big>(</big><span class="optional">[</span><em>field-number</em>, <span class="optional">]</span><em>search-value</em><big>)</big><a class="headerlink" href="#lua-функция.tuple_object.findall" title="Ссылка на это определение">¶</a></dt>
<dd><p>If <code class="docutils literal"><span class="pre">t</span></code> is a tuple instance, <code class="docutils literal"><span class="pre">t:find(search-value)</span></code> will return the
number of the first field in <code class="docutils literal"><span class="pre">t</span></code> that matches the search value,
and <code class="docutils literal"><span class="pre">t:findall(search-value</span> <span class="pre">[,</span> <span class="pre">search-value</span> <span class="pre">...])</span></code> will return numbers
of all fields in <code class="docutils literal"><span class="pre">t</span></code> that match the search value. Optionally one can
put a numeric argument <code class="docutils literal"><span class="pre">field-number</span></code> before the search-value to
indicate “start searching at field number <code class="docutils literal"><span class="pre">field-number</span></code>.”</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the number of the field in the tuple.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">number</td>
</tr>
</tbody>
</table>
<p>In the following example, a tuple named <code class="docutils literal"><span class="pre">t</span></code> is created and then: the
number of the first field in <code class="docutils literal"><span class="pre">t</span></code> which matches 'a' is returned, then
the numbers of all the fields in <code class="docutils literal"><span class="pre">t</span></code> which match 'a' are returned,
then the numbers of all the fields in t which match 'a' and are at or
after the second field are returned.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">a&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">b&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">c&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">a&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">a&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span><span class="p">:</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">a&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span><span class="p">:</span><span class="n">findall</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">a&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">4</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.tuple_object.transform">
<em class="property"> </em><code class="descclassname">tuple_object:</code><code class="descname">transform</code><big>(</big><em>start-field-number</em>, <em>fields-to-remove</em><span class="optional">[</span>, <em>field-value</em>, <em>...</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.tuple_object.transform" title="Ссылка на это определение">¶</a></dt>
<dd><p>If <code class="docutils literal"><span class="pre">t</span></code> is a tuple instance, <code class="samp docutils literal"><span class="pre">t:transform(</span><em><span class="pre">start-field-number</span></em><span class="pre">,</span><em><span class="pre">fields-to-remove</span></em><span class="pre">)</span></code>
will return a tuple where, starting from field <code class="docutils literal"><span class="pre">start-field-number</span></code>,
a number of fields (<code class="docutils literal"><span class="pre">fields-to-remove</span></code>) are removed. Optionally one
can add more arguments after <code class="docutils literal"><span class="pre">fields-to-remove</span></code> to indicate new
values that will replace what was removed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>start-field-number</strong> (<em>integer</em>) -- base 1, may be negative</li>
<li><strong>fields-to-remove</strong> (<em>integer</em>) -- </li>
<li><strong>field-value(s)</strong> (<em>lua-value</em>) -- </li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">tuple</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">tuple</p>
</td>
</tr>
</tbody>
</table>
<p>In the following example, a tuple named <code class="docutils literal"><span class="pre">t</span></code> is created and then,
starting from the second field, two fields are removed but one new
one is added, then the result is returned.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">Fld#1&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#2&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#3&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#4&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#5&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span><span class="p">:</span><span class="n">transform</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">x&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;Fld#1&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;x&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;Fld#4&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;Fld#5&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.tuple_object.unpack">
<em class="property"> </em><code class="descclassname">tuple_object:</code><code class="descname">unpack</code><big>(</big><span class="optional">[</span><em>start-field-number</em><span class="optional">[</span>, <em>end-field-number</em><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.tuple_object.unpack" title="Ссылка на это определение">¶</a></dt>
<dd><p>If <code class="docutils literal"><span class="pre">t</span></code> is a tuple instance, <code class="docutils literal"><span class="pre">t:unpack()</span></code> will return all fields,
<code class="docutils literal"><span class="pre">t:unpack(1)</span></code> will return all fields starting with field number 1,
<code class="docutils literal"><span class="pre">t:unpack(1,5)</span></code> will return all fields between field number 1 and field number 5.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">field(s) from the tuple.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">lua-value(s)</td>
</tr>
</tbody>
</table>
<p>In the following example, a tuple named <code class="docutils literal"><span class="pre">t</span></code> is created and then all
its fields are selected, then the result is returned.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">Fld#1&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#2&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#3&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#4&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#5&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span><span class="p">:</span><span class="nb">unpack</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Fld#1</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Fld#2</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Fld#3</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Fld#4</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Fld#5</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.tuple_object.pairs">
<em class="property"> </em><code class="descclassname">tuple_object:</code><code class="descname">pairs</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.tuple_object.pairs" title="Ссылка на это определение">¶</a></dt>
<dd><p>In Lua, <code class="docutils literal"><span class="pre">lua-table-value:pairs()</span></code> is a method which returns:
<code class="docutils literal"><span class="pre">function</span></code>, <code class="docutils literal"><span class="pre">lua-table-value</span></code>, <code class="docutils literal"><span class="pre">nil</span></code>. Tarantool has extended
this so that <code class="docutils literal"><span class="pre">tuple-value:pairs()</span></code> returns: <code class="docutils literal"><span class="pre">function</span></code>,
<code class="docutils literal"><span class="pre">tuple-value</span></code>, <code class="docutils literal"><span class="pre">nil</span></code>. It is useful for Lua iterators, because Lua
iterators traverse a value's components until an end marker is reached.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">function, tuple-value, nil</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">function, lua-value, nil</td>
</tr>
</tbody>
</table>
<p>In the following example, a tuple named <code class="docutils literal"><span class="pre">t</span></code> is created and then all
its fields are selected using a Lua for-end loop.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">Fld#1&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#2&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#3&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#4&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#5&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">tmp</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">&#39;</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="k">in</span> <span class="n">t</span><span class="p">:</span><span class="nb">pairs</span><span class="p">()</span> <span class="k">do</span>
<span class="gp">         &gt; </span>  <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">..</span> <span class="n">v</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">tmp</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Fld#1Fld#2Fld#3Fld#4Fld#5</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.tuple_object.update">
<em class="property"> </em><code class="descclassname">tuple_object:</code><code class="descname">update</code><big>(</big><em>{{format</em>, <em>field_number</em>, <em>value}</em>, <em>...}</em><big>)</big><a class="headerlink" href="#lua-функция.tuple_object.update" title="Ссылка на это определение">¶</a></dt>
<dd><p>Update a tuple.</p>
<p>This function updates a tuple which is not in a space. Compare the function
<code class="code docutils literal"><span class="pre">box.space.</span></code><code class="samp docutils literal"><em><span class="pre">space-name</span></em></code><code class="code docutils literal"><span class="pre">:update{</span></code><code class="samp docutils literal"><em><span class="pre">key</span></em><span class="pre">,</span> <em><span class="pre">format</span></em><span class="pre">,</span></code> <code class="code docutils literal"><span class="pre">{</span></code><code class="samp docutils literal"><em><span class="pre">field_number</span></em><span class="pre">,</span> <em><span class="pre">value</span></em></code><code class="code docutils literal"><span class="pre">}...)</span></code>,
which updates a tuple in a space.</p>
<p>Parameters: briefly: <code class="docutils literal"><span class="pre">format</span></code> indicates the type of update operation such as '<code class="docutils literal"><span class="pre">=</span></code>'
for 'assign new value', <code class="docutils literal"><span class="pre">field_number</span></code> indicates the field number to change such
as 2 for field number 2, <code class="docutils literal"><span class="pre">value</span></code> indicates the string which operates on the field such
as 'B' for a new assignable value = 'B'.</p>
<p>For details: see the description for <code class="docutils literal"><span class="pre">format</span></code>, <code class="docutils literal"><span class="pre">field_number</span></code>, and <code class="docutils literal"><span class="pre">value</span></code> in
the section <a class="reference internal" href="singlehtml.html#box-space-update"><span class="std std-ref">box.space.space-name:update{key, format, {field_number, value}...)</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">new tuple</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">tuple</td>
</tr>
</tbody>
</table>
<p>In the following example, a tuple named <code class="docutils literal"><span class="pre">t</span></code> is created and then its second field is
updated to equal 'B'.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">Fld#1&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#2&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#3&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#4&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#5&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span><span class="p">:</span><span class="n">update</span><span class="p">({{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">}})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;Fld#1&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;B&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;Fld#3&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;Fld#4&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;Fld#5&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<div class="section" id="example">
<h6>3.4.5.1. Пример<a class="headerlink" href="#example" title="Ссылка на этот заголовок">¶</a></h6>
<p>This function will illustrate how to convert tuples to/from Lua tables and
lists of scalars:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">tuple</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="n">scalar1</span><span class="p">,</span> <span class="n">scalar2</span><span class="p">,</span> <span class="o">...</span> <span class="n">scalar_n</span><span class="p">})</span> <span class="c1">-- scalars to tuple</span>
<span class="n">lua_table</span> <span class="o">=</span> <span class="p">{</span><span class="n">tuple</span><span class="p">:</span><span class="nb">unpack</span><span class="p">()}</span>                            <span class="c1">-- tuple to Lua table</span>
<span class="n">scalar1</span><span class="p">,</span> <span class="n">scalar2</span><span class="p">,</span> <span class="o">...</span> <span class="n">scalar_n</span> <span class="o">=</span> <span class="n">tuple</span><span class="p">:</span><span class="nb">unpack</span><span class="p">()</span>         <span class="c1">-- tuple to scalars</span>
<span class="n">tuple</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">lua_table</span><span class="p">)</span>                        <span class="c1">-- Lua table to tuple</span>
</pre></div>
</div>
<p>Then it will find the field that contains 'b', remove that field from the tuple,
and display how many bytes remain in the tuple. The function uses Tarantool
<code class="docutils literal"><span class="pre">box.tuple</span></code> functions <code class="docutils literal"><span class="pre">new()</span></code>, <code class="docutils literal"><span class="pre">unpack()</span></code>, <code class="docutils literal"><span class="pre">find()</span></code>, <code class="docutils literal"><span class="pre">transform()</span></code>,
<code class="docutils literal"><span class="pre">bsize()</span></code>.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">example</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">tuple1</span><span class="p">,</span> <span class="n">tuple2</span><span class="p">,</span> <span class="n">lua_table_1</span><span class="p">,</span> <span class="n">scalar1</span><span class="p">,</span> <span class="n">scalar2</span><span class="p">,</span> <span class="n">scalar3</span><span class="p">,</span> <span class="n">field_number</span>
  <span class="kd">local</span> <span class="n">luatable1</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">tuple1</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="s1">&#39;</span><span class="s">a&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">b&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">c&#39;</span><span class="p">})</span>
  <span class="n">luatable1</span> <span class="o">=</span> <span class="p">{</span><span class="n">tuple1</span><span class="p">:</span><span class="nb">unpack</span><span class="p">()}</span>
  <span class="n">scalar1</span><span class="p">,</span> <span class="n">scalar2</span><span class="p">,</span> <span class="n">scalar3</span> <span class="o">=</span> <span class="n">tuple1</span><span class="p">:</span><span class="nb">unpack</span><span class="p">()</span>
  <span class="n">tuple2</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">luatable1</span><span class="p">)</span>
  <span class="n">field_number</span> <span class="o">=</span> <span class="n">tuple2</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">b&#39;</span><span class="p">)</span>
  <span class="n">tuple2</span> <span class="o">=</span> <span class="n">tuple2</span><span class="p">:</span><span class="n">transform</span><span class="p">(</span><span class="n">field_number</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="s1">&#39;</span><span class="s">tuple2 = &#39;</span> <span class="p">,</span> <span class="n">tuple2</span> <span class="p">,</span> <span class="s1">&#39;</span><span class="s"> # of bytes = &#39;</span> <span class="p">,</span> <span class="n">tuple2</span><span class="p">:</span><span class="n">bsize</span><span class="p">()</span>
<span class="k">end</span>
</pre></div>
</div>
<p>... And here is what happens when one invokes the function:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">example</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tuple2 =</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="s">&#39;a&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;c&#39;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;</span><span class="nv"> </span><span class="s">#</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">bytes</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">&#39;</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
</div>
<span id="document-book/box/box_introspection"></span><div class="section" id="server-introspection">
<h5>3.4.6. Просмотр состояния сервера<a class="headerlink" href="#server-introspection" title="Ссылка на этот заголовок">¶</a></h5>
<div class="section" id="lua-module.box.cfg">
<span id="submodule-box-cfg"></span><span id="box-introspection-box-cfg"></span><h6>3.4.6.1. Submodule <cite>box.cfg</cite><a class="headerlink" href="#lua-module.box.cfg" title="Ссылка на этот заголовок">¶</a></h6>
<p>The <code class="docutils literal"><span class="pre">box.cfg</span></code> submodule is for administrators to specify all the server
configuration parameters; the full description of the parameters is in
section <a class="reference internal" href="singlehtml.html#index-book-cfg"><span class="std std-ref">book-cfg</span></a>. Use <code class="docutils literal"><span class="pre">box.cfg</span></code> without braces to get read-only
access to those parameters.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">snapshot_count</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">6</span>
  <span class="l l-Scalar l-Scalar-Plain">too_long_threshold</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0.5</span>
  <span class="l l-Scalar l-Scalar-Plain">slab_alloc_factor</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1.1</span>
  <span class="l l-Scalar l-Scalar-Plain">slab_alloc_maximal</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1048576</span>
  <span class="l l-Scalar l-Scalar-Plain">background</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class="l l-Scalar l-Scalar-Plain">&lt;...&gt;</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="section" id="lua-module.box.info">
<span id="submodule-box-info"></span><h6>3.4.6.2. Submodule <cite>box.info</cite><a class="headerlink" href="#lua-module.box.info" title="Ссылка на этот заголовок">¶</a></h6>
<p>The <code class="docutils literal"><span class="pre">box.info</span></code> submodule provides access to information about server variables.
Some important ones:</p>
<ul class="simple">
<li><strong>server.uuid</strong> holds the unique identifier of the server. This value is also
in the <a class="reference internal" href="singlehtml.html#box-space-cluster"><span class="std std-ref">box.space._cluster</span></a> system space.</li>
<li><strong>pid</strong> is the process ID of the server. This value is also shown by the
<a class="reference internal" href="singlehtml.html#tarantool-build"><span class="std std-ref">tarantool</span></a> module.</li>
<li><strong>version</strong> is the Tarantool version. This value is also shown by
<a class="reference internal" href="singlehtml.html#index-tarantool-version"><span class="std std-ref">tarantool --version</span></a>.</li>
<li><strong>uptime</strong> is the number of seconds since the server started.</li>
</ul>
<span class="target" id="box-introspection-box-info"></span><dl class="function">
<dt id="lua-функция.box.info">
<em class="property"> </em><code class="descclassname">box.</code><code class="descname">info</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.box.info" title="Ссылка на это определение">¶</a></dt>
<dd><p>Since <code class="docutils literal"><span class="pre">box.info</span></code> contents are dynamic, it's not possible to iterate over
keys with the Lua <code class="docutils literal"><span class="pre">pairs()</span></code> function. For this purpose, <code class="docutils literal"><span class="pre">box.info()</span></code>
builds and returns a Lua table with all keys and values provided in the
submodule.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">keys and values in the submodule.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">table</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">info</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">server</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">lsn</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">158</span>
    <span class="l l-Scalar l-Scalar-Plain">ro</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
    <span class="l l-Scalar l-Scalar-Plain">uuid</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">a2684219-b2b1-4334-88ab-50b0722283fd</span>
    <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1.7.0-1216-g73f7154</span>
  <span class="l l-Scalar l-Scalar-Plain">pid</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">12932</span>
  <span class="l l-Scalar l-Scalar-Plain">status</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">running</span>
  <span class="l l-Scalar l-Scalar-Plain">vclock</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">158</span>
  <span class="l l-Scalar l-Scalar-Plain">replication</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">status</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">off</span>
  <span class="l l-Scalar l-Scalar-Plain">uptime</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">908</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">pid</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">12932</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">status</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">running</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">uptime</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1065</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">version</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1.7.0-66-g9093daa</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="lua-module.box.slab">
<span id="submodule-box-slab"></span><h6>3.4.6.3. Submodule <cite>box.slab</cite><a class="headerlink" href="#lua-module.box.slab" title="Ссылка на этот заголовок">¶</a></h6>
<p>The <code class="docutils literal"><span class="pre">box.slab</span></code> submodule provides access to slab allocator statistics. The
slab allocator is the main allocator used to store tuples. This can be used
to monitor the total memory use and memory fragmentation.</p>
<p>The display of slabs is broken down by the slab size -- 64-byte, 136-byte,
and so on. The example omits the slabs which are empty. The example display
is saying that: there are 16 items stored in the 64-byte slab (and 16*64=102
so bytes_used = 1024); there is 1 item stored in the 136-byte slab
(and 136*1=136 so bytes_used = 136); the arena_used value is the total of all
the bytes_used values (1024+136 = 1160); the arena_size value is the arena_used
value plus the total of all the bytes_free values (1160+4193200+4194088 = 8388448).
The arena_size and arena_used values are the amount of the % of
<a class="reference internal" href="singlehtml.html#cfg-storage-slab-alloc-arena"><span class="std std-ref">slab_alloc_arena</span></a> that is already distributed to the slab allocator.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">slab</span><span class="p">.</span><span class="n">info</span><span class="p">().</span><span class="n">arena_used</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">4194304</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">slab</span><span class="p">.</span><span class="n">info</span><span class="p">().</span><span class="n">arena_size</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">104857600</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">slab</span><span class="p">.</span><span class="n">stats</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mem_free</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">16248</span>
    <span class="l l-Scalar l-Scalar-Plain">mem_used</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">48</span>
    <span class="l l-Scalar l-Scalar-Plain">item_count</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
    <span class="l l-Scalar l-Scalar-Plain">item_size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">24</span>
    <span class="l l-Scalar l-Scalar-Plain">slab_count</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="l l-Scalar l-Scalar-Plain">slab_size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">16384</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mem_free</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">15736</span>
    <span class="l l-Scalar l-Scalar-Plain">mem_used</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">560</span>
    <span class="l l-Scalar l-Scalar-Plain">item_count</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">14</span>
    <span class="l l-Scalar l-Scalar-Plain">item_size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">40</span>
    <span class="l l-Scalar l-Scalar-Plain">slab_count</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="l l-Scalar l-Scalar-Plain">slab_size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">16384</span>
    <span class="l l-Scalar l-Scalar-Plain">&lt;...&gt;</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">slab</span><span class="p">.</span><span class="n">stats</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mem_free</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">15736</span>
  <span class="l l-Scalar l-Scalar-Plain">mem_used</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">560</span>
  <span class="l l-Scalar l-Scalar-Plain">item_count</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">14</span>
  <span class="l l-Scalar l-Scalar-Plain">item_size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">40</span>
  <span class="l l-Scalar l-Scalar-Plain">slab_count</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="l l-Scalar l-Scalar-Plain">slab_size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">16384</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="section" id="submodule-box-stat">
<span id="box-introspection-box-stat"></span><h6>3.4.6.4. Submodule <cite>box.stat</cite><a class="headerlink" href="#submodule-box-stat" title="Ссылка на этот заголовок">¶</a></h6>
<p>The <code class="docutils literal"><span class="pre">box.stat</span></code> submodule provides access to request and network statistics.
Show the average number of requests per second, and the total number of
requests since startup, broken down by request type and network events statistics.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">stat</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">net</span><span class="p">)</span> <span class="c1">-- virtual tables</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">table</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">table</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">stat</span><span class="p">,</span> <span class="n">box</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">net</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">net</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[]</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">stat</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DELETE</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1873949</span>
    <span class="l l-Scalar l-Scalar-Plain">rps</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">123</span>
  <span class="l l-Scalar l-Scalar-Plain">SELECT</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1237723</span>
    <span class="l l-Scalar l-Scalar-Plain">rps</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">4099</span>
  <span class="l l-Scalar l-Scalar-Plain">INSERT</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="l l-Scalar l-Scalar-Plain">rps</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">EVAL</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="l l-Scalar l-Scalar-Plain">rps</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">CALL</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="l l-Scalar l-Scalar-Plain">rps</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">REPLACE</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1239123</span>
    <span class="l l-Scalar l-Scalar-Plain">rps</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">7849</span>
  <span class="l l-Scalar l-Scalar-Plain">UPSERT</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="l l-Scalar l-Scalar-Plain">rps</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">AUTH</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="l l-Scalar l-Scalar-Plain">rps</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">ERROR</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="l l-Scalar l-Scalar-Plain">rps</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">UPDATE</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="l l-Scalar l-Scalar-Plain">rps</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">stat</span><span class="p">().</span><span class="n">DELETE</span> <span class="c1">-- a selected item of the table</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">rps</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">net</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SENT</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="l l-Scalar l-Scalar-Plain">rps</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">EVENTS</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
    <span class="l l-Scalar l-Scalar-Plain">rps</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">LOCKS</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">6</span>
    <span class="l l-Scalar l-Scalar-Plain">rps</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">RECEIVED</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="l l-Scalar l-Scalar-Plain">rps</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
</div>
<span id="document-book/box/admin"></span><div class="section" id="administrative-requests">
<h5>3.4.7. Служебные запросы<a class="headerlink" href="#administrative-requests" title="Ссылка на этот заголовок">¶</a></h5>
<p>To learn which functions are considered to be administrative, type <code class="docutils literal"><span class="pre">help()</span></code>.
A reference description also follows below:</p>
<span class="target" id="admin-snapshot"></span><dl class="function">
<dt id="lua-функция.box.snapshot">
<em class="property"> </em><code class="descclassname">box.</code><code class="descname">snapshot</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.box.snapshot" title="Ссылка на это определение">¶</a></dt>
<dd><p>Take a snapshot of all data and store it in <a class="reference internal" href="singlehtml.html#cfg-basic-snap-dir"><span class="std std-ref">snap_dir</span></a><code class="samp docutils literal"><span class="pre">/</span><em><span class="pre">&lt;latest-lsn&gt;</span></em><span class="pre">.snap</span></code>.
To take a snapshot, Tarantool first enters the delayed garbage collection
mode for all data. In this mode, tuples which were allocated before the
snapshot has started are not freed until the snapshot has finished. To
preserve consistency of the primary key, used to iterate over tuples, a
copy-on-write technique is employed. If the master process changes part
of a primary key, the corresponding process page is split, and the snapshot
process obtains an old copy of the page.
In effect, the snapshot process uses multi-version concurrency control
in order to avoid copying changes which are superseded while it is running.</p>
<p>Since a snapshot is written
sequentially, one can expect a very high write performance (averaging to
80MB/second on modern disks), which means an average database instance gets
saved in a matter of minutes. Note: as long as there are any changes to
the parent index memory through concurrent updates, there are going to be
page splits, and therefore one needs to have some extra free memory to run
this command. 10% of <a class="reference internal" href="singlehtml.html#cfg-storage-slab-alloc-arena"><span class="std std-ref">slab_alloc_arena</span></a> is, on average, sufficient.
This statement waits until a snapshot is taken and returns operation result.</p>
<p>Change Notice: prior to Tarantool version 1.6.6, the snapshot process caused
a fork, which could cause occasional latency spikes. Starting with
Tarantool version 1.6.6, the snapshot process creates a consistent
read view and writes this view to the snapshot file from a separate thread.</p>
<p>Although box.snapshot() does not cause a fork, there is a separate fiber
which may produce snapshots at regular intervals -- see the discussion of
the <a class="reference internal" href="singlehtml.html#book-cfg-snapshot-daemon"><span class="std std-ref">snapshot daemon</span></a>.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">version</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1.7.0-1216-g73f7154</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">snapshot</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ok</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">snapshot</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">can&#39;t save snapshot, errno 17 (File exists)</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Taking a snapshot does not cause the server to start a new write-ahead log.
Once a snapshot is taken, old WALs can be deleted as long as all replicas
are up to date. But the WAL which was current at the time <code class="docutils literal"><span class="pre">box.snapshot()</span></code>
started must be kept for recovery, since it still contains log records
written after the start of <code class="docutils literal"><span class="pre">box.snapshot()</span></code>.</p>
<p>An alternative way to save a snapshot is to send the server SIGUSR1 UNIX
signal. While this approach could be handy, it is not recommended for use
in automation: a signal provides no way to find out whether the snapshot
was taken successfully or not.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.coredump">
<em class="property"> </em><code class="descname">coredump</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.coredump" title="Ссылка на это определение">¶</a></dt>
<dd><p>Fork and dump a core. Since Tarantool stores all tuples in memory, it can
take some time. Mainly useful for debugging.</p>
</dd></dl>

</div>
<span id="document-book/box/atomic"></span><div class="section" id="atomic-execution">
<span id="atomic-atomic-execution"></span><h5>3.4.8. Атомарные операции<a class="headerlink" href="#atomic-execution" title="Ссылка на этот заголовок">¶</a></h5>
<p>In several places in this manual it's been noted that Lua processes occur in
fibers on a single thread. That is why there can be a guarantee of execution
atomicity. That requires emphasis.</p>
<div class="section" id="cooperative-multitasking-environment">
<span id="atomic-cooperative-multitasking"></span><h6>3.4.8.1. Среда взаимной многозадачности<a class="headerlink" href="#cooperative-multitasking-environment" title="Ссылка на этот заголовок">¶</a></h6>
<p>Tarantool uses cooperative multitasking: unless a running fiber deliberately
yields control, it is not preempted by some other fiber. But a running fiber
will deliberately yield when it encounters a &quot;yield point&quot;: an explicit
<cite>yield()</cite> request, or an implicit yield due to an operating-system call. Any
system call which can block will be performed asynchronously, and any running
fiber which must wait for a system call will be preempted so that another
ready-to-run fiber takes its place and becomes the new running fiber. This model
makes all programmatic locks unnecessary: cooperative multitasking ensures that
there will be no concurrency around a resource, no race conditions, and
no memory consistency issues.</p>
<p>When requests are small, for example simple UPDATE or INSERT or DELETE or SELECT,
fiber scheduling is fair: it takes only a little time to process the request,
schedule a disk write, and yield to a fiber serving the next client.</p>
<p>However, a function might perform complex computations or might be written in
such a way that yields do not occur for a long time. This can lead to unfair
scheduling, when a single client throttles the rest of the system, or to
apparent stalls in request processing. Avoiding this situation is the
responsibility of the function's author. For the default memtx storage engine
some of the box calls, including the data-change requests
<a class="reference internal" href="singlehtml.html#box-space-insert"><span class="std std-ref">box.space...insert</span></a> or
<a class="reference internal" href="singlehtml.html#box-space-update"><span class="std std-ref">box.space...update</span></a> or
<a class="reference internal" href="singlehtml.html#box-space-delete"><span class="std std-ref">box.space...delete</span></a>, will usually cause yielding;
however, <a class="reference internal" href="singlehtml.html#box-space-select"><span class="std std-ref">box.space...select</span></a> will not. A fuller
description will appear in section
<a class="reference internal" href="#atomic-the-implicit-yield-rules"><span class="std std-ref">The Implicit Yield Rules</span></a>.</p>
<p>Note re storage engine: vinyl has different rules:
insert or update or delete will very rarely cause
a yield, but select can cause a yield.</p>
<p>In the absence of transactions, any function that contains yield points may see
changes in the database state caused by fibers that preempt. Then the only safe
atomic functions for memtx databases would be functions which contain only one
database request, or functions which contain a select request followed by a
data-change request.</p>
<p>At this point an objection could arise: &quot;It's good that a single data-change
request will commit and yield, but surely there are times when multiple
data-change requests must happen without yielding.&quot; The standard example is the
money-transfer, where $1 is withdrawn from account #1 and deposited into
account #2. If something interrupted after the withdrawal, then the institution
would be out of balance. For such cases, the <code class="docutils literal"><span class="pre">begin</span> <span class="pre">...</span> <span class="pre">commit|rollback</span></code>
block was designed.</p>
<span class="target" id="atomic-box-begin"></span><dl class="function">
<dt id="lua-функция.box.begin">
<em class="property"> </em><code class="descclassname">box.</code><code class="descname">begin</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.box.begin" title="Ссылка на это определение">¶</a></dt>
<dd><p>Begin the transaction. Disable implicit yields until the transaction ends.
Signal that writes to the write-ahead log will be deferred until the transaction ends.
In effect the fiber which executes <code class="docutils literal"><span class="pre">box.begin()</span></code> is starting an &quot;active
multi-request transaction&quot;, blocking all other fibers.</p>
</dd></dl>

<span class="target" id="atomic-box-commit"></span><dl class="function">
<dt id="lua-функция.box.commit">
<em class="property"> </em><code class="descclassname">box.</code><code class="descname">commit</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.box.commit" title="Ссылка на это определение">¶</a></dt>
<dd><p>End the transaction, and make all its data-change
operations permanent.</p>
</dd></dl>

<span class="target" id="atomic-box-rollback"></span><dl class="function">
<dt id="lua-функция.box.rollback">
<em class="property"> </em><code class="descclassname">box.</code><code class="descname">rollback</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.box.rollback" title="Ссылка на это определение">¶</a></dt>
<dd><p>End the transaction, but cancel all its data-change
operations. An explicit call to functions outside <code class="docutils literal"><span class="pre">box.space</span></code> that always
yield, such as <code class="docutils literal"><span class="pre">fiber.yield</span></code> or <code class="docutils literal"><span class="pre">fiber.sleep</span></code>, will have the same effect.</p>
</dd></dl>

<p>The <strong>requests in a transaction must be sent to the server as a single block</strong>.
It is not enough to enclose them between <code class="docutils literal"><span class="pre">begin</span></code> and <code class="docutils literal"><span class="pre">commit</span></code> or <code class="docutils literal"><span class="pre">rollback</span></code>.
To ensure they are sent as a single block: put them in a function, or put them all
on one line, or use a delimiter so that multi-line requests are handled together.</p>
<p><strong>All database operations in a transaction should use the same storage engine</strong>.
It is not safe to access tuple sets that are defined with <code class="docutils literal"><span class="pre">{engine='vinyl'}</span></code>
and also access tuple sets that are defined with <code class="docutils literal"><span class="pre">{engine='memtx'}</span></code>,
in the same transaction.</p>
</div>
<div class="section" id="example">
<h6>3.4.8.2. Пример<a class="headerlink" href="#example" title="Ссылка на этот заголовок">¶</a></h6>
<p>Assuming that in tuple set 'tester' there are tuples in which the third field
represents a positive dollar amount ... Start a transaction, withdraw from tuple#1,
deposit in tuple#2, and end the transaction, making its effects permanent.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">txn_example</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount_of_money</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="n">box</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">-&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">amount_of_money</span><span class="p">}})</span>
<span class="gp">         &gt; </span>  <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="n">to</span><span class="p">,</span>   <span class="p">{{</span><span class="s1">&#39;</span><span class="s">+&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">amount_of_money</span><span class="p">}})</span>
<span class="gp">         &gt; </span>  <span class="n">box</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="s2">&quot;</span><span class="s">ok&quot;</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">txn_example</span><span class="p">({</span><span class="mi">999</span><span class="p">},</span> <span class="p">{</span><span class="mi">1000</span><span class="p">},</span> <span class="mf">1.00</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&quot;ok&quot;</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="section" id="the-implicit-yield-rules">
<span id="atomic-the-implicit-yield-rules"></span><h6>3.4.8.3. Правила неявной передачи управления<a class="headerlink" href="#the-implicit-yield-rules" title="Ссылка на этот заголовок">¶</a></h6>
<p>The only explicit yield requests are <a class="reference internal" href="singlehtml.html#fiber-sleep"><span class="std std-ref">fiber.sleep()</span></a> and
<a class="reference internal" href="singlehtml.html#fiber-yield"><span class="std std-ref">fiber.yield()</span></a>, but many other requests &quot;imply&quot; yields
because Tarantool is designed to avoid blocking.</p>
<p>The implicit yield requests are: <a class="reference internal" href="singlehtml.html#box-space-insert"><span class="std std-ref">insert</span></a>
<a class="reference internal" href="singlehtml.html#box-space-replace"><span class="std std-ref">replace</span></a> <a class="reference internal" href="singlehtml.html#box-space-update"><span class="std std-ref">update</span></a>
<a class="reference internal" href="singlehtml.html#box-space-upsert"><span class="std std-ref">upsert</span></a> <a class="reference internal" href="singlehtml.html#box-space-delete"><span class="std std-ref">delete</span></a> (the
&quot;data-change&quot; requests), and functions in module <a class="reference internal" href="singlehtml.html#fio-section"><span class="std std-ref">fio</span></a>,
<a class="reference internal" href="singlehtml.html#net-box-module"><span class="std std-ref">net_box</span></a>, <a class="reference internal" href="singlehtml.html#console-module"><span class="std std-ref">console</span></a>, or
<a class="reference internal" href="singlehtml.html#socket-module"><span class="std std-ref">socket</span></a> (the &quot;os&quot; and &quot;network&quot; requests).</p>
<p>Note re storage engine: vinyl causes <a class="reference internal" href="singlehtml.html#box-space-select"><span class="std std-ref">select</span></a>
to be an implicit yield request, but data-change requests may not be.</p>
<p>The yield occurs just before a blocking syscall, such as a write to the
Write-Ahead Log (WAL) or a network message reception.</p>
<p>Implicit yield requests are disabled by <a class="reference internal" href="#atomic-box-begin"><span class="std std-ref">box.begin</span></a>,
and enabled again by <a class="reference internal" href="#atomic-box-commit"><span class="std std-ref">commit</span></a>. Therefore the sequence</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="n">begin</span>
<span class="n">implicit</span> <span class="k">yield</span> <span class="n">request</span> <span class="c1">#1</span>
<span class="n">implicit</span> <span class="k">yield</span> <span class="n">request</span> <span class="c1">#2</span>
<span class="n">implicit</span> <span class="k">yield</span> <span class="n">request</span> <span class="c1">#3</span>
<span class="n">commit</span>
</pre></div>
</div>
<p>will not cause implicit yield until the commit occurs (specifically: just before
the writes to the WAL, which are delayed until commit time). The commit request
is not itself an implicit yield request, it only enables yields caused by
earlier implicit yield requests.</p>
<p>Despite their resemblance to implicit yield requests,
<a class="reference internal" href="singlehtml.html#box-space-truncate"><span class="std std-ref">truncate</span></a> and <a class="reference internal" href="singlehtml.html#box-space-drop"><span class="std std-ref">drop</span></a> do not
cause implicit yield. Despite their resemblance to functions of the fio module,
functions of the <a class="reference internal" href="singlehtml.html#os-module"><span class="std std-ref">os</span></a> module do not cause implicit yield.
Despite its resemblance to commit, <a class="reference internal" href="#atomic-box-rollback"><span class="std std-ref">rollback</span></a> does
not enable yields.</p>
<p>If <a class="reference internal" href="singlehtml.html#cfg-binary-logging-snapshots-wal-mode"><span class="std std-ref">wal_mode</span></a> = 'none', then
implicit yielding is disabled, because there are no writes to the WAL.</p>
<p>If a task is interactive -- sending requests to the server and receiving
responses -- then it involves network IO, and therefore there is an implicit
yield, even if the request that is sent to the server is not itself an implicit
yield request. Therefore the sequence</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="n">select</span>
<span class="n">select</span>
<span class="n">select</span>
</pre></div>
</div>
<p>causes blocking if it is inside a function or Lua program being executed on the
server, but causes yielding if it is done as a series of transmissions from a
client, including a client which operates via telnet, via one of the connectors,
or via the MySQL and PostgreSQL rocks, or via the interactive mode when
<a class="reference internal" href="singlehtml.html#administration-using-tarantool-as-a-client"><span class="std std-ref">&quot;Using tarantool as a client&quot;</span></a>.</p>
<p>After a fiber has yielded and then has regained control, it immediately issues
<a class="reference internal" href="singlehtml.html#fiber-testcancel"><span class="std std-ref">testcancel</span></a>.</p>
</div>
</div>
<span id="document-book/box/authentication"></span><div class="section" id="access-control">
<span id="authentication"></span><h5>3.4.9. Ограничение доступа<a class="headerlink" href="#access-control" title="Ссылка на этот заголовок">¶</a></h5>
<p>Understanding the details of security is primarily an issue for administrators,
but ordinary users should at least skim this section so that they will have an
idea of how Tarantool makes it possible for administrators to prevent
unauthorized access to the database and to certain functions.</p>
<p>Briefly: there is a method to guarantee with password checks that users really
are who they say they are (&quot;authentication&quot;). There is a _user space where user
names and password-hashes are stored. There are functions for saying that
certain users are allowed to do certain things (&quot;privileges&quot;). There is a _priv
space where privileges are stored. Whenever a user tries to do an operation,
there is a check whether the user has the privilege to do the operation
(&quot;access control&quot;).</p>
<div class="section" id="passwords">
<h6>3.4.9.1. Passwords<a class="headerlink" href="#passwords" title="Ссылка на этот заголовок">¶</a></h6>
<p>Each user may have a password. The password is any alphanumeric string.
Administrators should advise users to choose long unobvious passwords, but it
is ultimately up to the users to choose or change their own passwords.</p>
<p>Tarantool passwords are stored in the _user space with a <a class="reference external" href="https://en.wikipedia.org/wiki/Cryptographic_hash">Cryptographic hash function</a>
so that, if the password is 'x', the stored hashed-password is a long string
like '<code class="docutils literal"><span class="pre">lL3OvhkIPOKh+Vn9Avlkx69M/Ck=</span></code>'. When a client connects to a Tarantool
server, the server sends a random <a class="reference external" href="https://en.wikipedia.org/wiki/Salt_%28cryptography%29">Salt Value</a> which the client must mix with the
hashed-password before sending to the server. Thus the original value 'x' is
never stored anywhere except in the user's head, and the hashed value is never
passed down a network wire except when mixed with a random salt. This system
prevents malicious onlookers from finding passwords by snooping in the log
files or snooping on the wire. It is the same system that <a class="reference external" href="http://dev.mysql.com/doc/refman/4.1/en/password-hashing.html">MySQL introduced
several years ago</a> which has proved adequate for medium-security installations.
Nevertheless administrators should warn users that no system is foolproof against
determined long-term attacks, so passwords should be guarded and changed occasionally.</p>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">To get the hash-password of a string 'X', say
<code class="docutils literal"><span class="pre">box.schema.user.password('X')</span></code>. To see more about the details of the
algorithm for the purpose of writing a new client application, read the
<a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.7/src/scramble.h">scramble.h</a> header file.</p>
</div>
</div>
<div class="section" id="users-and-the-user-space">
<span id="authentication-users"></span><h6>3.4.9.2. Users and the _user space<a class="headerlink" href="#users-and-the-user-space" title="Ссылка на этот заголовок">¶</a></h6>
<p>The fields in the _user space are:</p>
<ul class="simple">
<li>the numeric id of the tuple</li>
<li>the numeric id of the tuple's creator</li>
<li>the user name</li>
<li>the type</li>
<li>optional password</li>
</ul>
<p>There are four special tuples in the _user space: 'guest', 'admin', 'public', and 'replication'.</p>
<div class="table container">
<table border="1" class="left-align-column-1 right-align-column-2 left-align-column-3 left-align-column-4 docutils">
<colgroup>
<col width="16%" />
<col width="5%" />
<col width="8%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">ID</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>guest</td>
<td>0</td>
<td>user</td>
<td>Default when connecting remotely. Usually an untrusted
user with few privileges.</td>
</tr>
<tr class="row-odd"><td>admin</td>
<td>1</td>
<td>user</td>
<td>Default when using <code class="docutils literal"><span class="pre">tarantool</span></code> as a console. Usually
an administrative user with all privileges.</td>
</tr>
<tr class="row-even"><td>public</td>
<td>2</td>
<td>role</td>
<td>Not a user in the usual sense. Described later in
section <a class="reference internal" href="#roles">Roles</a>.</td>
</tr>
<tr class="row-odd"><td>replication</td>
<td>3</td>
<td>role</td>
<td>Not a user in the usual sense. Described later in
section <a class="reference internal" href="#roles">Roles</a>.</td>
</tr>
</tbody>
</table>
</div>
<p>To select a row from the _user space, use <code class="docutils literal"><span class="pre">box.space._user:select</span></code>. For
example, here is what happens with a select for user id = 0, which is the
'guest' user, which by default has no password:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_user</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span> <span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;guest&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;user&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>To change tuples in the _user space, do not use ordinary <code class="docutils literal"><span class="pre">box.space</span></code>
functions for insert or update or delete - the _user space is special so
there are special functions which have appropriate error checking.</p>
<p>To create a new user, say:</p>
<pre class="highlight literal-block">
box.schema.user.create(<em>user-name</em>)
box.schema.user.create(<em>user-name</em>, {if_not_exists = true})
box.schema.user.create(<em>user-name</em>, {password = <em>password</em>}).
</pre>
<p>The <code class="samp docutils literal"><span class="pre">password=</span><em><span class="pre">password</span></em></code> specification is good because in a <a class="reference internal" href="singlehtml.html#index-uri"><span class="std std-ref">URI</span></a> (Uniform Resource Identifier) it is
usually illegal to include a user-name without a password.</p>
<p>To change the user's password, say:</p>
<pre class="highlight literal-block">
-- To change the current user's password
box.schema.user.passwd(<em>password</em>)

-- To change a different user's password
box.schema.user.passwd(<em>user-name</em>, <em>password</em>)
</pre>
<p>(Usually it is only the admin user who can change a different user's password.)</p>
<p>To drop a user, say:</p>
<pre class="highlight literal-block">
box.schema.user.drop(<em>user-name</em>).
</pre>
<p>To check whether a user exists, say:</p>
<pre class="highlight literal-block">
box.schema.user.exists(<em>user-name</em>)
</pre>
<p>which returns true or false.</p>
<p>To find what privileges a user has, say:</p>
<pre class="highlight literal-block">
box.schema.user.info(<em>user-name</em>)
</pre>
<p><strong>Example:</strong></p>
<p>Here is a session which creates a new user with a strong password, selects a
tuple in the _user space, and then drops the user.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">JeanMartin&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">Iwtso_6_os$$&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_user</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">name</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">JeanMartin&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">17</span><span class="p p-Indicator">,</span> <span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;JeanMartin&#39;</span><span class="p p-Indicator">,</span> <span class="s">&#39;user&#39;</span><span class="p p-Indicator">,</span> <span class="p p-Indicator">{</span><span class="s">&#39;chap-sha1&#39;</span><span class="p p-Indicator">:</span> <span class="s">&#39;t3xjUpQdrt857O+YRvGbMY5py8Q=&#39;</span><span class="p p-Indicator">}]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">JeanMartin&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">The maximum number of users is 32.</p>
</div>
</div>
<div class="section" id="privileges-and-the-priv-space">
<span id="authentication-privileges"></span><h6>3.4.9.3. Privileges and the _priv space<a class="headerlink" href="#privileges-and-the-priv-space" title="Ссылка на этот заголовок">¶</a></h6>
<p>The fields in the _priv space are:</p>
<ul class="simple">
<li>the numeric id of the user who gave the privilege (&quot;grantor_id&quot;),</li>
<li>the numeric id of the user who received the privilege (&quot;grantee_id&quot;),</li>
<li>the type of object - &quot;space&quot; or &quot;function&quot; or &quot;universe&quot;,</li>
<li>the numeric id of the object,</li>
<li>the type of operation - &quot;read&quot; = 1, or &quot;write&quot; = 2, or &quot;execute&quot; = 4, or a
combination such as &quot;read,write,execute&quot;.</li>
</ul>
<p>The function for granting a privilege is:</p>
<pre class="highlight literal-block">
box.schema.user.grant(<em>grantee</em>, <em>operation</em>, <em>object-type</em>, <em>object-name*[, *options</em>])
-- OR
box.schema.user.grant(<em>grantee</em>, <em>operation</em>, 'universe' [, nil, <em>options</em>])
</pre>
<p>where 'universe' means 'all objects', and the optional grant-option can be:</p>
<ul class="simple">
<li><code class="samp docutils literal"><span class="pre">grantor=</span><em><span class="pre">grantor_name_or_id</span></em></code> - string or number, for custom grantor</li>
<li><code class="samp docutils literal"><span class="pre">if_not_exists=true|false</span></code> - bool, do not throw error if user already has the privilege</li>
</ul>
<p>The function for revoking a privilege is:</p>
<pre class="highlight literal-block">
box.schema.user.revoke(<em>grantee</em>, <em>operation</em>, <em>object-type</em>, <em>object-name*[, *options</em>])
box.schema.user.revoke(<em>grantee</em>, <em>operation</em>, 'universe'[, nil, <em>options</em>])
</pre>
<p>where 'universe' means 'all objects', and the optional grant-option can be:</p>
<ul class="simple">
<li><code class="samp docutils literal"><span class="pre">if_not_exists=true|false</span></code> - bool, do not throw error if user already lacks the privilege</li>
</ul>
<p>For example, here is a session where the admin user gave the guest user the
privilege to read from a space named <code class="docutils literal"><span class="pre">space55</span></code>, and then took the privilege away:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">guest&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space55&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">guest&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space55&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">Generally privileges are granted or revoked by the owner of the object
(the user who created it), or by the 'admin' user.
Before dropping any objects or users, steps should be taken to ensure
that all their associated privileges have been revoked.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">Only the 'admin' user can grant privileges for the 'universe'.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">Only the creator of a space can drop, alter, or truncate the space.
Only the creator of a user can change a different user's password.</p>
</div>
</div>
<div class="section" id="functions-and-the-func-space">
<span id="authentication-funcs"></span><h6>3.4.9.4. Functions and the _func space<a class="headerlink" href="#functions-and-the-func-space" title="Ссылка на этот заголовок">¶</a></h6>
<p>The fields in the _func space are:</p>
<ul class="simple">
<li>the numeric function id, a number,</li>
<li>the function name</li>
<li>flag</li>
<li>possibly a language name.</li>
</ul>
<p>The _func space does not include the function's body. One continues to
create Lua functions in the usual way, by saying
&quot;<code class="samp docutils literal"><span class="pre">function</span> <em><span class="pre">function_name</span></em> <span class="pre">()</span> <span class="pre">...</span> <span class="pre">end</span></code>&quot;, without adding anything in the
_func space. The _func space only exists for storing function tuples so
that their names can be used within grant/revoke functions.</p>
<p>The function for creating a _func tuple is:</p>
<pre class="highlight literal-block">
box.schema.func.create(<em>function-name</em> [, <em>options</em>])
</pre>
<p>The possible options are:</p>
<ul class="simple">
<li><code class="samp docutils literal"><span class="pre">if_not_exists</span> <span class="pre">=</span> <em><span class="pre">true|false</span></em></code> - default = false,</li>
<li><code class="samp docutils literal"><span class="pre">setuid</span> <span class="pre">=</span> <em><span class="pre">true|false</span></em></code> - default = false,</li>
<li><code class="samp docutils literal"><span class="pre">language</span> <span class="pre">=</span> <em><span class="pre">'LUA'|'C'</span></em></code> - default = 'LUA'.</li>
</ul>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">f&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">language</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">C&#39;</span><span class="p">,</span> <span class="n">setuid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">})</span>
</pre></div>
</div>
<p>Specifying <code class="code docutils literal"><span class="pre">if_not_exists=false</span></code> would cause <code class="docutils literal"><span class="pre">error:</span> <span class="pre">Function</span> <span class="pre">'...'</span> <span class="pre">already</span>
<span class="pre">exists</span></code> if the _func tuple already exists.</p>
<p>Specifying <code class="code docutils literal"><span class="pre">setuid=true</span></code> would cause the setuid flag (the fourth field in
the _func tuple) to have a value meaning &quot;true&quot;, and the effect of that is that
the function's caller is treated as the function's creator, with full privileges.
The setuid behavior does not apply for users who connect via <code class="code docutils literal"><span class="pre">console.connect</span></code>.</p>
<p>Specifying <code class="code docutils literal"><span class="pre">language='C'</span></code> would cause the language field (the fifth field
in the _func tuple) to have a value 'C', which means the function was written in
C. Tarantool functions are normally written in Lua but can be written in C as well.</p>
<p>The function for dropping a _func tuple is:</p>
<pre class="highlight literal-block">
box.schema.func.drop(<em>function-name</em>)
</pre>
<p>The function for checking whether a _func tuple exists is:</p>
<pre class="highlight literal-block">
box.schema.func.exists(<em>function-name</em>)
</pre>
<p>In the following example, a function named 'f7' is created, then it is put in
the _func space, then it is used in a <code class="docutils literal"><span class="pre">box.schema.user.grant</span></code> function,
then it is dropped:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">f7</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">uid</span><span class="p">()</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">f7&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">guest&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">function&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">f7&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">guest&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">function&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">f7&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">f7&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="section" id="box-session-and-security">
<h6>3.4.9.5. <code class="docutils literal"><span class="pre">box.session</span></code> and security<a class="headerlink" href="#box-session-and-security" title="Ссылка на этот заголовок">¶</a></h6>
<p>After a connection has taken place, the user has access to a &quot;session&quot; object
which has several functions. The ones which are of interest for security
purposes are:</p>
<pre class="highlight literal-block">
box.session.uid()         -- returns the id of the current user
box.session.user()        -- returns the name of the current user
box.session.su(<em>user-name</em>) -- allows changing current user to 'user-name'
</pre>
<p>If a user types requests directly on the Tarantool server in its
<a class="reference internal" href="singlehtml.html#administration-using-tarantool-as-a-client"><span class="std std-ref">interactive mode</span></a>,
or if a user connects to the <a class="reference internal" href="singlehtml.html#administration-admin-ports"><span class="std std-ref">admin port</span></a>,
then the user by default is 'admin' and has many privileges.
If a user connects from an application program via one of the <a class="reference internal" href="singlehtml.html#index-box-connectors"><span class="std std-ref">connectors</span></a>, then
the user by default is 'guest' and has few privileges. Typically an admin user
will set up and configure objects, then grant privileges to appropriate non-admin
users. Typically a guest user will use <code class="docutils literal"><span class="pre">box.session.su()</span></code> to change into a non-generic
user to whom admin has granted more than the default privileges. For example,
admin might say:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_user</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">123456</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">manager&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">user&#39;</span><span class="p">}</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">manager&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">_space&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">manager&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">payroll&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>and later a guest user, who wishes to see the payroll, might say:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">su</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">manager&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">payroll</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="s1">&#39;</span><span class="s">Jones&#39;</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="roles">
<span id="authentication-roles"></span><h6>3.4.9.6. Roles<a class="headerlink" href="#roles" title="Ссылка на этот заголовок">¶</a></h6>
<p>A role is a container for privileges which can be granted to regular users.
Instead of granting and revoking individual privileges, one can put all the
privileges in a role and then grant or revoke the role. Role information is
in the _user space but the third field - the type field - is 'role' rather
than 'user'.</p>
<p id="authentication-rep-role">If a role R1 is granted a privilege X, and user U1 is granted a privilege
&quot;role R1&quot;, then user U1 in effect has privilege X. Then if a role R2 is
granted a privilege Y, and role R1 is granted a privilege &quot;role R2&quot;,
then user U1 in effect has both privilege X and privilege Y. In other words,
a user gets all the privileges that are granted to a user's roles, directly
or indirectly.</p>
<span class="target" id="lua-module.box.schema.role"></span><dl class="function">
<dt id="lua-функция.box.schema.role.create">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">create</code><big>(</big><em>role-name</em><span class="optional">[</span>, <em>{if_not_exists=true}</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.create" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create a new role.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.role.grant">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">grant</code><big>(</big><em>role-name</em>, <em>privilege</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.grant" title="Ссылка на это определение">¶</a></dt>
<dd><p>Put a privilege in a role.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.role.revoke">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">revoke</code><big>(</big><em>role-name</em>, <em>privilege</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.revoke" title="Ссылка на это определение">¶</a></dt>
<dd><p>Take a privilege out of a role.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.role.drop">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">drop</code><big>(</big><em>role-name</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.drop" title="Ссылка на это определение">¶</a></dt>
<dd><p>Drop a role.</p>
</dd></dl>

<dl class="function">
<dt>
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">grant</code><big>(</big><em>role-name</em>, <em>'execute'</em>, <em>'role'</em>, <em>role-name</em><big>)</big></dt>
<dd><p>Grant a role to a role.</p>
</dd></dl>

<dl class="function">
<dt>
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">revoke</code><big>(</big><em>role-name</em>, <em>'execute'</em>, <em>'role'</em>, <em>role-name</em><big>)</big></dt>
<dd><p>Revoke a role from a role.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.role.exists">
<em class="property"> </em><code class="descclassname">box.schema.role.</code><code class="descname">exists</code><big>(</big><em>role-name</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.role.exists" title="Ссылка на это определение">¶</a></dt>
<dd><p>Check whether a role exists.
Returns (type = boolean) true if role-name identifies a role, otherwise false.</p>
</dd></dl>

<span class="target" id="lua-module.box.schema.user"></span><dl class="function">
<dt id="lua-функция.box.schema.user.grant">
<em class="property"> </em><code class="descclassname">box.schema.user.</code><code class="descname">grant</code><big>(</big><em>user-name</em>, <em>'execute'</em>, <em>'role'</em>, <em>role-name</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.user.grant" title="Ссылка на это определение">¶</a></dt>
<dd><p>Grant a role to a user.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.schema.user.revoke">
<em class="property"> </em><code class="descclassname">box.schema.user.</code><code class="descname">revoke</code><big>(</big><em>user-name</em>, <em>'execute'</em>, <em>'role'</em>, <em>role-name</em><big>)</big><a class="headerlink" href="#lua-функция.box.schema.user.revoke" title="Ссылка на это определение">¶</a></dt>
<dd><p>Revoke a role from a user.</p>
</dd></dl>

<p>There are two predefined roles. The first predefined role, named 'public', is
automatically assigned to new users when they are created with
<code class="samp docutils literal"><span class="pre">box.schema.user.create(</span><em><span class="pre">user-name</span></em><span class="pre">)</span></code> - Therefore a convenient way to
grant 'read' on space 't' to every user that will ever exist is:
<code class="code docutils literal"><span class="pre">box.schema.role.grant('public','read','space','t')</span></code>. The second
predefined role, named 'replication', can be assigned by the 'admin' user to
users who need to use replication features.</p>
</div>
<div class="section" id="example-showing-a-role-within-a-role">
<h6>3.4.9.7. Example showing a role within a role<a class="headerlink" href="#example-showing-a-role-within-a-role" title="Ссылка на этот заголовок">¶</a></h6>
<p>In this example, a new user named U1 will insert a new tuple into a new space
named T, and will succeed even though user U1 has no direct privilege to do
such an insert -- that privilege is inherited from role R1, which in turn
inherits from role R2.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- This example will work for a user with many privileges, such as &#39;admin&#39;</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">T&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="c1">-- Create a user U1 so that later it&#39;s possible to say box.session.su(&#39;U1&#39;)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">U1&#39;</span><span class="p">)</span>
<span class="c1">-- Create two roles, R1 and R2</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">R1&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">R2&#39;</span><span class="p">)</span>
<span class="c1">-- Grant role R2 to role R1 and role R1 to U1 (order doesn&#39;t matter)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">R1&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">role&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">R2&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">U1&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">role&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">R1&#39;</span><span class="p">)</span>
<span class="c1">-- Grant read and execute privileges to R2 (but not to R1 and not to U1)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">R2&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">read,write&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">T&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">role</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">R2&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">universe&#39;</span><span class="p">)</span>
<span class="c1">-- Use box.session.su to say &quot;now become user U1&quot;</span>
<span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">su</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">U1&#39;</span><span class="p">)</span>
<span class="c1">-- Next insert succeeds because U1 in effect has write privilege on T</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<span id="document-book/box/triggers"></span><div class="section" id="triggers">
<span id="triggers-box-triggers"></span><h5>3.4.10. Триггеры<a class="headerlink" href="#triggers" title="Ссылка на этот заголовок">¶</a></h5>
<p>Triggers, also known as callbacks, are functions which the server executes when
certain events happen. Currently the main types of triggers are <a class="reference internal" href="#connection-triggers">connection triggers</a>,
which are executed when a session begins or ends, and <a class="reference internal" href="#replace-triggers">replace triggers</a> which are
for database events.</p>
<p>All triggers have the following characteristics:</p>
<ul class="simple">
<li>They associate a <cite>function</cite> with an <cite>event</cite>. The request to &quot;define a trigger&quot;
consists of passing the name of the trigger's function to one of the
&quot;<code class="samp docutils literal"><span class="pre">on_</span><em><span class="pre">event-name</span></em><span class="pre">()</span></code>&quot; functions: <code class="code docutils literal"><span class="pre">on_connect()</span></code>, <code class="code docutils literal"><span class="pre">on_auth()</span></code>,
<code class="code docutils literal"><span class="pre">on_disconnect()</span></code>, or <code class="code docutils literal"><span class="pre">on_replace()</span></code>.</li>
<li>They are <cite>defined by any user</cite>. There are no privilege requirements for defining
triggers.</li>
<li>They are called <cite>after</cite> the event. They are not called if the event ends
prematurely due to an error. (Exception: <code class="code docutils literal"><span class="pre">on_auth()</span></code> is called before the event.)</li>
<li>They are in <cite>server memory</cite>. They are not stored in the database. Triggers
disappear when the server is shut down. If there is a requirement to make
them permanent, then the function definitions and trigger settings should
be part of an initialization script.</li>
<li>They have <cite>low overhead</cite>. If a trigger is not defined, then the overhead is
minimal: merely a pointer dereference and check. If a trigger is defined,
then its overhead is equivalent to the overhead of calling a stored procedure.</li>
<li>They can be <cite>multiple</cite> for one event. Triggers are executed in the reverse
order that they were defined in.</li>
<li>They must work <cite>within the event context</cite>. If the function contains requests
which normally could not occur immediately after the event but before the
return from the event, effects are undefined. For example, putting
<code class="docutils literal"><span class="pre">os.exit()</span></code> or <code class="docutils literal"><span class="pre">box.rollback()</span></code> in a trigger function would be bringing in requests
outside the event context.</li>
<li>They are <cite>replaceable</cite>. The request to &quot;redefine a trigger&quot; consists of passing
the names of a new trigger function and an old trigger function to one of the
&quot;on <cite>event-name</cite> ...&quot; functions.</li>
</ul>
<div class="section" id="connection-triggers">
<h6>3.4.10.1. Connection triggers<a class="headerlink" href="#connection-triggers" title="Ссылка на этот заголовок">¶</a></h6>
<dl class="function">
<dt id="lua-функция.box.session.on_connect">
<em class="property"> </em><code class="descclassname">box.session.</code><code class="descname">on_connect</code><big>(</big><em>trigger-function</em><span class="optional">[</span>, <em>old-trigger-function-name</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.session.on_connect" title="Ссылка на это определение">¶</a></dt>
<dd><p>Define a trigger for execution when a new session is created due to an event
such as <a class="reference internal" href="singlehtml.html#console-connect"><span class="std std-ref">console.connect</span></a>. The trigger function will be the first thing
executed after a new session is created. If the trigger fails by raising an
error, the error is sent to the client and the connection is closed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>trigger-function</strong> (<em>function</em>) -- function which will become the trigger function</li>
<li><strong>old-trigger-function-name</strong> (<em>function</em>) -- existing trigger function which will be replaced by trigger-function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil or function list</p>
</td>
</tr>
</tbody>
</table>
<p>If the parameters are (nil, old-trigger-function-name), then the old trigger is deleted.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">f</span> <span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_connect</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Предупреждение</p>
<p class="last">If a trigger always results in an error, it may become impossible to
connect to the server to reset it.</p>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.session.on_disconnect">
<em class="property"> </em><code class="descclassname">box.session.</code><code class="descname">on_disconnect</code><big>(</big><em>trigger-function</em><span class="optional">[</span>, <em>old-trigger-function-name</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.session.on_disconnect" title="Ссылка на это определение">¶</a></dt>
<dd><p>Define a trigger for execution after a client has disconnected. If the trigger
function causes an error, the error is logged but otherwise is ignored. The
trigger is invoked while the session associated with the client still exists
and can access session properties, such as box.session.id.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>trigger-function</strong> (<em>function</em>) -- function which will become the trigger function</li>
<li><strong>old-trigger-function-name</strong> (<em>function</em>) -- existing trigger function which will be replaced by trigger-function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil or function list</p>
</td>
</tr>
</tbody>
</table>
<p>If the parameters are (nil, old-trigger-function-name), then the old trigger is deleted.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">f</span> <span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_disconnect</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<div class="section" id="example">
<h7>3.4.10.1.1. Пример<a class="headerlink" href="#example" title="Ссылка на этот заголовок">¶</a></h7>
<p>After the following series of requests, the server will write a message
using the <a class="reference internal" href="singlehtml.html#log"><span class="std std-ref">log</span></a> module whenever any user connects or disconnects.</p>
<div class="highlight-lua_tarantool"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">log_connect</span> <span class="p">()</span>
  <span class="kd">local</span> <span class="n">log</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">log&#39;</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">m</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">Connection. user=&#39;</span> <span class="o">..</span> <span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">user</span><span class="p">()</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> id=&#39;</span> <span class="o">..</span> <span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">id</span><span class="p">()</span>
  <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="k">end</span>
<span class="k">function</span> <span class="nf">log_disconnect</span> <span class="p">()</span>
  <span class="kd">local</span> <span class="n">log</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">log&#39;</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">m</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">Disconnection. user=&#39;</span> <span class="o">..</span> <span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">user</span><span class="p">()</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> id=&#39;</span> <span class="o">..</span> <span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">id</span><span class="p">()</span>
  <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_connect</span><span class="p">(</span><span class="n">log_connect</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_disconnect</span><span class="p">(</span><span class="n">log_disconnect</span><span class="p">)</span>
</pre></div>
</div>
<p>Here is what might appear in the log file in a typical installation:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">13</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">34.444</span> <span class="p">[</span><span class="mi">11360</span><span class="p">]</span> <span class="n">main</span><span class="o">/</span><span class="mi">103</span><span class="o">/</span><span class="n">iproto</span> <span class="n">I</span><span class="o">&gt;</span>
    <span class="n">Connection</span><span class="p">.</span> <span class="n">user</span><span class="o">=</span><span class="n">guest</span> <span class="n">id</span><span class="o">=</span><span class="mi">3</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">13</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mf">19.289</span> <span class="p">[</span><span class="mi">11360</span><span class="p">]</span> <span class="n">main</span><span class="o">/</span><span class="mi">103</span><span class="o">/</span><span class="n">iproto</span> <span class="n">I</span><span class="o">&gt;</span>
    <span class="n">Disconnection</span><span class="p">.</span> <span class="n">user</span><span class="o">=</span><span class="n">guest</span> <span class="n">id</span><span class="o">=</span><span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="authentication-triggers">
<span id="triggers-authentication-triggers"></span><h6>3.4.10.2. Authentication triggers<a class="headerlink" href="#authentication-triggers" title="Ссылка на этот заголовок">¶</a></h6>
<dl class="function">
<dt id="lua-функция.box.session.on_auth">
<em class="property"> </em><code class="descclassname">box.session.</code><code class="descname">on_auth</code><big>(</big><em>trigger-function</em><span class="optional">[</span>, <em>old-trigger-function-name</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.session.on_auth" title="Ссылка на это определение">¶</a></dt>
<dd><p>Define a trigger for execution during authentication.</p>
<p>The on_auth trigger function is invoked in these circumstances:
(1) The <a class="reference internal" href="singlehtml.html#console-connect"><span class="std std-ref">console.connect</span></a> function includes an authentication check for all users except 'guest';
for this case the on_auth trigger function is invoked after the on_connect trigger function,
if and only if the connection has succeeded so far.
(2) The binary protocol has a separate <a class="reference internal" href="singlehtml.html#box-protocol-authentication"><span class="std std-ref">authentication packet</span></a> --
for this case, connection and authentication are considered to be separate steps.</p>
<p>Unlike other trigger types, on_auth trigger functions are invoked <cite>before</cite>
the event. Therefore a trigger function like <code class="code docutils literal"><span class="pre">function</span> <span class="pre">auth_function</span> <span class="pre">()</span> <span class="pre">v</span> <span class="pre">=</span> <span class="pre">box.session.user();</span> <span class="pre">end</span></code>
will set <code class="code docutils literal"><span class="pre">v</span></code> to &quot;guest&quot;, the user name before the authentication is done.
To get the user name after the authentication is done, use the special syntax:
<code class="code docutils literal"><span class="pre">function</span> <span class="pre">auth_function</span> <span class="pre">(user_name)</span> <span class="pre">v</span> <span class="pre">=</span> <span class="pre">user_name;</span> <span class="pre">end</span></code></p>
<p>If the trigger fails by raising an
error, the error is sent to the client and the connection is closed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>trigger-function</strong> (<em>function</em>) -- function which will become the trigger function</li>
<li><strong>old-trigger-function-name</strong> (<em>function</em>) -- existing trigger function which will be replaced by trigger-function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil</p>
</td>
</tr>
</tbody>
</table>
<p>If the parameters are (nil, old-trigger-function-name), then the old trigger is deleted.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">f</span> <span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_auth</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="lua-module.box.space">
<span id="replace-triggers"></span><h6>3.4.10.3. Replace triggers<a class="headerlink" href="#lua-module.box.space" title="Ссылка на этот заголовок">¶</a></h6>
<dl class="class">
<dt id="lua-объект.box.space.space_object">
<em class="property">объект </em><code class="descclassname">box.space.</code><code class="descname">space_object</code><a class="headerlink" href="#lua-объект.box.space.space_object" title="Ссылка на это определение">¶</a></dt>
<dd><dl class="function">
<dt id="lua-функция.space_object.on_replace">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">on_replace</code><big>(</big><em>trigger-function</em><span class="optional">[</span>, <em>old-trigger-function-name</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.space_object.on_replace" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create a &quot;<code class="docutils literal"><span class="pre">replace</span> <span class="pre">trigger</span></code>&quot;. The <code class="docutils literal"><span class="pre">function-name</span></code> will be executed whenever
a <code class="docutils literal"><span class="pre">replace()</span></code> or <code class="docutils literal"><span class="pre">insert()</span></code> or <code class="docutils literal"><span class="pre">update()</span></code> or <code class="docutils literal"><span class="pre">upsert()</span></code> or <code class="docutils literal"><span class="pre">delete()</span></code> happens to a
tuple in <code class="docutils literal"><span class="pre">&lt;space-name&gt;</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>trigger-function</strong> (<em>function</em>) -- function which will become the trigger function</li>
<li><strong>old-trigger-function-name</strong> (<em>function</em>) -- existing trigger function which will be replaced by trigger-function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil or function list</p>
</td>
</tr>
</tbody>
</table>
<p>If the parameters are (nil, old-trigger-function-name), then the old trigger is deleted.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">f</span> <span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">X</span><span class="p">:</span><span class="n">on_replace</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.space_object.run_triggers">
<em class="property"> </em><code class="descclassname">space_object:</code><code class="descname">run_triggers</code><big>(</big><em>true|false</em><big>)</big><a class="headerlink" href="#lua-функция.space_object.run_triggers" title="Ссылка на это определение">¶</a></dt>
<dd><p>At the time that a trigger is defined, it is automatically enabled - that
is, it will be executed. Replace triggers can be disabled with
<code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:run_triggers(false)</span></code> and re-enabled with
<code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:run_triggers(true)</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">nil</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">X</span><span class="p">:</span><span class="n">run_triggers</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<div class="section" id="id1">
<h7>3.4.10.3.1. Пример<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h7>
<p>The following series of requests will create a space, create an index, create
a function which increments a counter, create a trigger, do two inserts, drop
the space, and display the counter value - which is 2, because the function
is executed once after each insert.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">space53&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
<span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">replace_trigger</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">replace_counter</span> <span class="o">=</span> <span class="n">replace_counter</span> <span class="o">+</span> <span class="mi">1</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">on_replace</span><span class="p">(</span><span class="n">replace_trigger</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">replace_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">First replace&#39;</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Second replace&#39;</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">drop</span><span class="p">()</span>
<span class="gp">tarantool&gt; </span><span class="n">replace_counter</span>
</pre></div>
</div>
</div>
<div class="section" id="another-example">
<h7>3.4.10.3.2. Another Example<a class="headerlink" href="#another-example" title="Ссылка на этот заголовок">¶</a></h7>
<p>The following series of requests will associate an existing function named F
with an existing space named T, associate the function a second time with the
same space (so it will be called twice), disable all triggers of T, and delete
each trigger by replacing with <code class="docutils literal"><span class="pre">nil</span></code>.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">:</span><span class="n">on_replace</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">:</span><span class="n">on_replace</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">:</span><span class="n">run_triggers</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">:</span><span class="n">on_replace</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">T</span><span class="p">:</span><span class="n">on_replace</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="getting-a-list-of-triggers">
<h6>3.4.10.4. Getting a list of triggers<a class="headerlink" href="#getting-a-list-of-triggers" title="Ссылка на этот заголовок">¶</a></h6>
<p>The code <code class="code docutils literal"><span class="pre">on_connect()</span></code> -- with no arguments --
returns a table of all connect-trigger functions;
<code class="code docutils literal"><span class="pre">on_auth()</span></code> returns all authentication-trigger functions;
<code class="code docutils literal"><span class="pre">on_disconnect()</span></code> returns all disconnect-trigger functions;
<code class="code docutils literal"><span class="pre">on_replace()</span></code> returns all replace-trigger functions.
In the following example a user finds that there are
three functions associated with <code class="code docutils literal"><span class="pre">on_connect</span></code>
triggers, and executes the third function, which happens to
contain the line &quot;print('function #3')&quot;.
Then it deletes the third trigger.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_connect</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="s">&#39;function:</span><span class="nv"> </span><span class="s">0x416ab6f8&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;function:</span><span class="nv"> </span><span class="s">0x416ab6f8&#39;</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;function:</span><span class="nv"> </span><span class="s">0x416ad800&#39;</span>
<span class="nn">...</span>

<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_connect</span><span class="p">()[</span><span class="mi">3</span><span class="p">]()</span>
<span class="go">function #3</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_connect</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_connect</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
</div>
<span id="document-book/box/limitations"></span><div class="section" id="limitations">
<h5>3.4.11. Ограничения<a class="headerlink" href="#limitations" title="Ссылка на этот заголовок">¶</a></h5>
<p id="limitations-fields-in-index"><strong>Number of parts in an index</strong></p>
<blockquote>
<div>For TREE or HASH indexes, the maximum
is 255 (<code class="docutils literal"><span class="pre">box.schema.INDEX_PART_MAX</span></code>). For RTREE indexes, the
maximum is 1 but the field is an ARRAY. For BITSET indexes, the maximum is 1.</div></blockquote>
<p id="limitations-indexes-in-space"><strong>Number of indexes in a space</strong></p>
<blockquote>
<div>128 (<code class="docutils literal"><span class="pre">box.schema.INDEX_MAX</span></code>).</div></blockquote>
<p id="limitations-fields-in-tuple"><strong>Number of fields in a tuple</strong></p>
<blockquote>
<div>The theoretical maximum is 2147483647 (<code class="docutils literal"><span class="pre">box.schema.FIELD_MAX</span></code>). The
practical maximum is whatever is specified by the space's
<a class="reference internal" href="singlehtml.html#box-space-field-count"><span class="std std-ref">field_count</span></a>
member, or the maximum tuple length.</div></blockquote>
<p id="limitations-bytes-in-tuple"><strong>Number of bytes in a tuple</strong></p>
<blockquote>
<div>By default the value of <a class="reference internal" href="singlehtml.html#cfg-storage-slab-alloc-maximal"><span class="std std-ref">slab_alloc_maximal</span></a>
is 1048576, and the maximum tuple length is approximately one quarter of that:
approximately 262,000 bytes. To increase it, when starting the server,
specify a larger value. For example
<code class="code docutils literal"><span class="pre">box.cfg{slab_alloc_maximal=2*1048576}</span></code>.</div></blockquote>
<p id="limitations-bytes-in-index-key"><strong>Number of bytes in an index key</strong></p>
<blockquote>
<div>If a field in a tuple can contain a million bytes, then the index key
can contain a million bytes, so the maximum is determined by factors
such as <a class="reference internal" href="#limitations-bytes-in-tuple"><span class="std std-ref">Number of bytes in a tuple</span></a>,
not by the index support.</div></blockquote>
<p id="limitations-number-of-spaces"><strong>Number of spaces</strong></p>
<blockquote>
<div>The theoretical maximum is 2147483647 (<code class="docutils literal"><span class="pre">box.schema.SPACE_MAX</span></code>).</div></blockquote>
<p id="limitations-number-of-connections"><strong>Number of connections</strong></p>
<blockquote>
<div>The practical limit is the number of file descriptors that one can set
with the operating system.</div></blockquote>
<p id="limitations-space-size"><strong>Space size</strong></p>
<blockquote>
<div>The total maximum size for all spaces is in effect set by
<a class="reference internal" href="singlehtml.html#cfg-storage-slab-alloc-arena"><span class="std std-ref">slab_alloc_arena</span></a>, which in turn
is limited by the total available memory.</div></blockquote>
<p id="limitations-update-ops"><strong>Update operations count</strong></p>
<blockquote>
<div>The maximum number of operations that can be in a single update
is 4000 (<code class="docutils literal"><span class="pre">BOX_UPDATE_OP_CNT_MAX</span></code>).</div></blockquote>
<p id="limitations-users-and-roles"><strong>Number of users and roles</strong></p>
<blockquote>
<div>32 (BOX_USER_MAX).</div></blockquote>
<p id="limitations-length"><strong>Length of an index name or space name or user name</strong></p>
<blockquote>
<div>32 (<code class="docutils literal"><span class="pre">box.schema.NAME_MAX</span></code>).</div></blockquote>
<p id="limitations-replicas"><strong>Number of replicas in a cluster</strong></p>
<blockquote>
<div>32 (<code class="docutils literal"><span class="pre">box.schema.REPLICA_MAX</span></code>).</div></blockquote>
<p id="limitations-vinyl">For additional limitations which apply only to the vinyl
storage engine, see section
<a class="reference internal" href="singlehtml.html#vinyl-diff"><span class="std std-ref">Differences between memtx and vinyl</span></a>.</p>
</div>
<span id="document-book/box/vinyl_diff"></span><div class="section" id="differences-between-memtx-and-vinyl-storage-engines">
<span id="vinyl-diff"></span><h5>3.4.12. Различия между движками memtx и vinyl<a class="headerlink" href="#differences-between-memtx-and-vinyl-storage-engines" title="Ссылка на этот заголовок">¶</a></h5>
<p>The primary difference between memtx and vinyl is that memtx is an &quot;in-memory&quot;
engine while vinyl is an &quot;on-disk&quot; engine. An in-memory storage engine is
generally faster, and the memtx engine is justifiably the default for Tarantool,
but there are two situations where an on-disk engine such as vinyl would be
preferable:</p>
<ol class="arabic simple">
<li>when the database is larger than the available memory and adding more
memory is not a realistic option;</li>
<li>when the server frequently goes down due to errors or a simple desire to
save power -- bringing the server back up and restoring a memtx database
into memory takes time.</li>
</ol>
<p>Here are behavior differences which affect programmers. All of these differences
have been noted elsewhere in sentences that begin with the words
&quot;Note re storage engine: vinyl&quot;.</p>
<p>With memtx, the index type can be TREE or HASH or RTREE or BITSET. <br />
With vinyl, the only index type is TREE.</p>
<p>With memtx, <a class="reference internal" href="singlehtml.html#box-space-create-index"><span class="std std-ref">create_index</span></a> can be done at any time. <br />
With vinyl, secondary indexes must be created before tuples are inserted.</p>
<p>With memtx, for index searches, <code class="docutils literal"><span class="pre">nil</span></code> is considered to be equal to any scalar. <br />
With vinyl, <code class="docutils literal"><span class="pre">nil</span></code> or missing parts are not allowed.</p>
<p>With memtx, temporary spaces are supported. <br />
With vinyl, they are not.</p>
<p>With memtx, the <a class="reference internal" href="singlehtml.html#box-index-alter"><span class="std std-ref">alter()</span></a> and <a class="reference internal" href="singlehtml.html#box-space-len"><span class="std std-ref">len()</span></a>
and <a class="reference internal" href="singlehtml.html#box-index-random"><span class="std std-ref">random()</span></a> and <a class="reference internal" href="singlehtml.html#box-space-auto-increment"><span class="std std-ref">auto_increment()</span></a>
and <a class="reference internal" href="singlehtml.html#box-space-truncate"><span class="std std-ref">truncate()</span></a> functions are supported. <br />
With vinyl, they are not.</p>
<p>With memtx, the <a class="reference internal" href="singlehtml.html#box-index-count"><span class="std std-ref">count()</span></a> function takes a constant
amount of time. <br />
With vinyl, it takes a variable amount of time depending on index size.</p>
<p>With memtx, delete will return deleted tuple, if any. <br />
With vinyl, delete will always return nil.</p>
<p>It was explained <a class="reference internal" href="singlehtml.html#index-yields-must-happen"><span class="std std-ref">earlier</span></a> that memtx does not
&quot;yield&quot; on a select request, it yields only on data-change requests. However,
vinyl does yield on a select request, or on an equivalent such as <code class="docutils literal"><span class="pre">get()</span></code> or
<code class="docutils literal"><span class="pre">pairs()</span></code>. This has significance for <a class="reference internal" href="singlehtml.html#atomic-cooperative-multitasking"><span class="std std-ref">cooperative multitasking</span></a>.</p>
<p>For more about vinyl, see Appendix D <a class="reference internal" href="singlehtml.html#index-vinyl"><span class="std std-ref">vinyl</span></a>.</p>
</div>
</div>
</div>
</div>
<span id="document-book/replication/index"></span><div class="section" id="replication">
<span id="index-box-replication"></span><h3>4. Репликация<a class="headerlink" href="#replication" title="Ссылка на этот заголовок">¶</a></h3>
<p>Механизм репликации позволяет сразу многим Tarantool-серверам работать с копиями одних и тех же баз данных. При этом все базы остаются в синхронизированном состоянии благодаря тому, что каждый сервер может сообщать другим серверам о совершенных им изменениях. Сервера, которые работают над одними и теми же базами, представляют собой &quot;кластер&quot;. У каждого сервера в кластере есть числовой идентификатор (server id), уникальный в рамках кластера.</p>
<p>Чтобы настроить репликацию, необходимо настроить главные сервера (master), которые первыми обрабатывают запросы на изменение данных, затем настроить сервера-реплики (replica), которые копируют к себе запросы на изменение данных с главных серверов, и прописать процедуры для восстановления после сбоя.</p>
<div class="section" id="replication-architecture">
<h4>4.1. Архитектура механизма репликации<a class="headerlink" href="#replication-architecture" title="Ссылка на этот заголовок">¶</a></h4>
<p>Чтобы знать о всех изменениях на стороне главного сервера, каждая реплика непрерывно опрашивает главный сервер на предмет обновлений в его WAL-файле (write ahead log) и применяет эти обновления на своей стороне. Каждая запись в WAL-файле представляет собой один запрос на изменение данных (например, INSERT, UPDATE или DELETE) и присвоенный данной записи номер (LSN = log sequence number). Номера присваиваются в порядке возрастания. По сути, репликация в Tarantool'е является построчной: все команды на изменение данных полностью детерминированы, и каждая такая команда относится только к одному кортежу.</p>
<p>Вызовы хранимых Lua-процедур фиксируются не в WAL-файле, а в журнале событий (event log). Таким образом гарантируется, что не детерминированное поведение логики на Lua не приведет к рассинхронизации реплицированных данных.</p>
</div>
<div class="section" id="setting-up-the-master">
<h4>4.2. Настройка главного сервера<a class="headerlink" href="#setting-up-the-master" title="Ссылка на этот заголовок">¶</a></h4>
<p>Чтобы настроить возможность установки соединения для реплик, на стороне главного сервера требуется лишь указать значение для параметра &quot;<a class="reference internal" href="singlehtml.html#cfg-basic-listen"><span class="std std-ref">listen</span></a>&quot; в init-запросе <code class="docutils literal"><span class="pre">box.cfg</span></code>. Например, <code class="docutils literal"><span class="pre">box.cfg{listen=3301}</span></code>. Когда URI для прослушивания задан, главный сервер готов принимать запросы на соединение от любого количества реплик. Каждая реплика при этом находится в некотором <a class="reference internal" href="#index-monitoring-replica-actions"><span class="std std-ref">статусе репликации</span></a>.</p>
</div>
<div class="section" id="setting-up-a-replica">
<h4>4.3. Настройка сервера-реплики<a class="headerlink" href="#setting-up-a-replica" title="Ссылка на этот заголовок">¶</a></h4>
<p>Каждому Tarantool-серверу необходим корректный файл со статическим снимком данных (.snap-файл). Файл-снимок создается на сервере при первом запросе <code class="docutils literal"><span class="pre">box.cfg</span></code>. Если при первом таком запросе на сервере не определен источник репликации (replication source), то сервер стартует в режиме главного сервера и создает для себя новый кластер с новым уникальными UUID. Если же источник репликации при первом <code class="docutils literal"><span class="pre">box.cfg</span></code>-запросе определен, то сервер стартует в режиме реплики, а файл-снимок и информация о кластере берутся из WAL-файлов на главном сервере. Поэтому при настройке репликации нужно указать параметр <a class="reference internal" href="singlehtml.html#cfg-replication-replication-source"><span class="std std-ref">replication_source</span></a> в запросе <code class="docutils literal"><span class="pre">box.cfg</span></code>. При первом соединении с главным сервером сервер-реплика включается в состав кластера. В дальнейшем такая реплика общается только с главным сервером из данного кластера.</p>
<p>После установки соединения с главным сервером реплика запрашивает у него все изменения, чьи LSN-номера в WAL-файле больше номера последнего локального изменения на реплике. Поэтому WAL-файлы на главном сервере нужно хранить до тех пор, пока все реплики не применят изменения из этих WAL-файлов на своей стороне. Состояние реплики можно &quot;обнулить&quot;, удалив все файлы репликации (.snap-файл со снимком и .xlog-файлы с записями WAL) и запустив сервер снова. Реплика при этом возьмет все кортежи с главного сервера и придет в синхронизированное состояние. Обратите внимание, что такая процедура &quot;обнуления&quot; сработает, только если на главном сервере будут доступны все нужные WAL-файлы.</p>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">Параметры репликации можно менять на лету, что позволяет назначать реплику на роль главного сервера и наоборот. Для этого используется запрос <a class="reference internal" href="singlehtml.html#box-introspection-box-cfg"><span class="std std-ref">box.cfg</span></a>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">Реплика не берет настройки конфигурации с главного сервера, например настройки запуска <a class="reference internal" href="singlehtml.html#book-cfg-snapshot-daemon"><span class="std std-ref">фоновой программы для работы со снимками</span></a> на главном сервере. Чтобы получить те же настройки на реплике, нужно задать их явным образом.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">Репликация требует настройки привилегий. Привилегии для доступа к пространствам можно задать напрямую для пользователя, под чьим именем запущен сервер-реплика. Но обычно привилегии на доступ к пространствам задаются с помощью <a class="reference internal" href="singlehtml.html#authentication-rep-role"><span class="std std-ref">роли</span></a>, которая затем присваивается пользователю, под чьим именем запущен сервер-реплика.</p>
</div>
</div>
<div class="section" id="recovering-from-a-degraded-state">
<h4>4.4. Восстановление после сбоя<a class="headerlink" href="#recovering-from-a-degraded-state" title="Ссылка на этот заголовок">¶</a></h4>
<p>&quot;Сбой&quot; — это ситуация, когда главный сервер становится недоступен вследствие проблем с оборудованием, сетевых неполадок или программной ошибки. У реплики нет способа автоматически обнаружить, что связь с главным сервером утеряна насовсем, поскольку причины сбоя и окружение, в котором развернута репликация, могут быть очень разными. Поэтому обнаруживать сбой должен человек.</p>
<p>Но когда сбой уже обнаружен, процедура восстановления проста. Сначала нужно назначить одну из реплик на роль нового главного сервера, задав параметр <span class="ccode">box.cfg{... listen=</span><span class="ccodei">URI &lt;index-uri&gt;</span><span class="ccode">}</span>. Затем, если на прежнем главном сервере остались изменения, которые не успели примениться на выбранной реплике перед сбоем, нужно применить эти изменения вручную.</p>
</div>
<div class="section" id="instructions-for-quick-startup-of-a-new-two-server-simple-cluster">
<h4>4.5. Инструкции по быстрому запуску простого кластера из двух серверов с нуля<a class="headerlink" href="#instructions-for-quick-startup-of-a-new-two-server-simple-cluster" title="Ссылка на этот заголовок">¶</a></h4>
<p>Шаг 1. Запустите первый сервер со следующими настройками:</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="n">box</span><span class="o">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span> <span class="o">=</span> <span class="o">*</span><span class="n">uri</span><span class="c1">#1*}</span>
<span class="o">--</span> <span class="n">в</span> <span class="n">этом</span> <span class="n">запросе</span> <span class="n">можно</span> <span class="n">задать</span> <span class="n">больше</span> <span class="n">ограничений</span>
<span class="n">box</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;guest&#39;</span><span class="p">,</span> <span class="s1">&#39;read,write,execute&#39;</span><span class="p">,</span> <span class="s1">&#39;universe&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
</pre></div>
</div>
<p>... Итак, создался новый кластер.</p>
<p>Шаг 2. На втором сервере проверьте пути, по которым будут храниться файлы репликации. Эти пути задаются в параметрах <a class="reference internal" href="singlehtml.html#cfg-basic-snap-dir"><span class="std std-ref">snap_dir</span></a> (для .snap-файлов) и <a class="reference internal" href="singlehtml.html#cfg-basic-wal-dir"><span class="std std-ref">wal_dir</span></a> (для .xlog-файлов). В указанных директориях должно быть пусто, чтобы не случилось конфликта с теми начальными данными, что придут с первого сервера, когда второй сервер присоединится к кластеру.</p>
<p>Step 3. Запустите второй сервер со следующими настройками:</p>
<pre class="highlight literal-block">
box.cfg{
  listen = <em>uri#2</em>,
  replication_source = <em>uri#1</em>
}
</pre>
<p>... где <code class="docutils literal"><span class="pre">uri#1</span></code> = <a class="reference internal" href="singlehtml.html#index-uri"><span class="std std-ref">URI</span></a>, на котором включено прослушивание у первого сервера.</p>
<p>Вот и всё.</p>
<p>В описанной выше конфигурации первый сервер выполняет роль &quot;главного&quot;, а второй служит &quot;репликой&quot;. Далее все изменения, происходящие на стороне главного сервера, будут доступны с реплики. Простой кластер из двух серверов, где главный сервер запущен на одном компьютере, а сервер-реплика — на другом, встречается очень часто и обладает двумя важными преимуществами: FAILOVER (т.е. отказоустойчивость, поскольку в случае отключения главного сервера его место может занять сервер-реплика) и LOAD BALANCING (т.е. балансировка нагрузки, поскольку клиенты могут обращаться с SELECT-запросами как к главному серверу, так и к реплике). При необходимости в настройках реплики можно задать параметр <a class="reference internal" href="singlehtml.html#cfg-basic-read-only"><span class="std std-ref">read_only = true</span></a>.</p>
</div>
<div class="section" id="monitoring-a-replica-s-actions">
<span id="index-monitoring-replica-actions"></span><h4>4.6. Мониторинг действий реплики<a class="headerlink" href="#monitoring-a-replica-s-actions" title="Ссылка на этот заголовок">¶</a></h4>
<p>В пакете <a class="reference internal" href="singlehtml.html#box-introspection-box-info"><span class="std std-ref">box.info</span></a> есть поле <code class="code docutils literal"><span class="pre">box.info.replication.status</span></code>, которое отражает статус репликации для данной реплики: &quot;off&quot;, &quot;stopped&quot;, &quot;connecting&quot;, &quot;auth&quot;, &quot;follow&quot; или &quot;disconnected&quot;. <br /> Если реплика имеет статус &quot;follow&quot;, то можно получить уточняющую информацию из еще двух полей: <br /> <code class="code docutils literal"><span class="pre">box.info.replication.idle</span></code> = время (в секундах), которое реплика провела в состоянии бездействия, <br /> <code class="code docutils literal"><span class="pre">box.info.replication.lag</span></code> = время (в секундах), на которое реплика отстает от главного сервера.</p>
<p>В <a class="reference internal" href="singlehtml.html#log"><span class="std std-ref">журнале</span></a> ведется запись о действиях, связанных с репликацией. Если главный сервер запущен со следующими настройками:</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="n">box</span><span class="o">.</span><span class="n">cfg</span><span class="p">{</span>
  <span class="o">&lt;...&gt;</span><span class="p">,</span>
  <span class="n">logger</span> <span class="o">=</span> <span class="o">*</span><span class="n">имя_файла_для_ведения_журнала</span><span class="o">*</span><span class="p">,</span>
  <span class="o">&lt;...&gt;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>то на каждую установку/потерю соединения реплики с главным сервером в журнале будут появляться строчки со словом &quot;relay&quot;.</p>
</div>
<div class="section" id="preventing-duplicate-actions">
<span id="index-preventing-duplicate-actions"></span><h4>4.7. Предотвращение дублирующихся действий<a class="headerlink" href="#preventing-duplicate-actions" title="Ссылка на этот заголовок">¶</a></h4>
<p>Предположим, что реплика пытается сделать нечто, что уже было сделано на главном сервере. Например: <br /> <code class="code docutils literal"><span class="pre">box.schema.space.create('X')</span></code> <br /> Это приведет к ошибке &quot;Space X exists&quot; (&quot;Пространство X уже существует&quot;). В данном частном случае можно скорректировать инструкцию следующим образом: <br /> <code class="code docutils literal"><span class="pre">box.schema.space.create('X',</span> <span class="pre">{if_not_exists=true})</span></code> <br /> Но существует и более общее решение: использовать метод <code class="samp docutils literal"><span class="pre">box.once(</span><em><span class="pre">key</span></em><span class="pre">,</span> <em><span class="pre">function</span></em><span class="pre">)</span></code>. Если <code class="code docutils literal"><span class="pre">box.once()</span></code> был вызван ранее с тем же значением параметра <code class="samp docutils literal"><em><span class="pre">key</span></em></code>, то функция <code class="samp docutils literal"><em><span class="pre">function</span></em></code> игнорируется; в противном случае функция <code class="samp docutils literal"><em><span class="pre">function</span></em></code> будет выполнена. Поэтому действия, которые должны совершаться только один раз за время текущей сессии репликации, нужно помещать в функцию и вызывать ее с помощью метода <code class="code docutils literal"><span class="pre">box.once()</span></code>. Например:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">f</span><span class="p">()</span>
  <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">X&#39;</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">box</span><span class="p">.</span><span class="n">once</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">space_creator&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="master-master-replication">
<h4>4.8. Репликация по схеме master-master<a class="headerlink" href="#master-master-replication" title="Ссылка на этот заголовок">¶</a></h4>
<p>В случае настройки репликации по схеме master-replica изменения на главном сервере доступны для просмотра с реплики, но не наоборот, потому как главный сервер в такой схеме указан в качестве единственного источника репликации. В случае схемы master-master (иногда ее также называет multi-master) просмотр изменений возможен в любом направлении. В простом случае (master-master с двумя серверами) на первом сервере нужно задать следующие настройки:</p>
<pre class="highlight literal-block">
box.cfg{ replication_source = <em>uri#2</em> }
</pre>
<p>Этот запрос можно выполнить в любой момент, т.к. параметр <a class="reference internal" href="singlehtml.html#cfg-replication-replication-source"><span class="std std-ref">replication_source</span></a> можно задавать на ходу.</p>
<p>В данном примере оба сервера являются одновременно и &quot;главными&quot;, и &quot;репликами&quot;. Поэтому каждое изменение, которое случается на одном сервере, становится доступно для просмотра с другого сервера. Отказоустойчивость в такой конфигурации сохраняется, а возможности по балансировке нагрузки становятся еще шире (теперь клиенты могут обращаться к обоим серверам со всеми типами запросов — как на чтение данных, так и на изменение).</p>
<p>Если две операции над одним и тем же кортежем производятся &quot;параллельно&quot; (а это может потребовать много времени, поскольку репликация — это асинхронный процесс), причем одна из операций — это <code class="docutils literal"><span class="pre">delete</span></code>, а вторая — <code class="docutils literal"><span class="pre">replace</span></code>, то существует вероятность, что данные на серверах станут различаться.</p>
</div>
<div class="section" id="all-the-what-if-questions">
<h4>4.9. Ответы на вопросы &quot;Что если?&quot;<a class="headerlink" href="#all-the-what-if-questions" title="Ссылка на этот заголовок">¶</a></h4>
<p>Вопрос: Что если в кластере вида master-master более двух серверов? <br /> Ответ: На каждом сервере нужно задать параметр <a class="reference internal" href="singlehtml.html#cfg-replication-replication-source"><span class="std std-ref">replication_source</span></a> и указать в нем все остальные сервера. Например, для сервера #3 настройки будут следующими: <br /> <span class="ccode">box.cfg{</span> <br /> &nbsp; &nbsp; &nbsp; <span class="ccode">replication_source = {</span><span class="ccodei">uri#1, uri#2</span><span class="ccode">}</span> <br /> <span class="ccode">}</span></p>
<p>Вопрос: Что если какой-то сервер нужно убрать из кластера? <br /> Ответ: Для реплики — выполните запрос <code class="docutils literal"><span class="pre">box.cfg{}</span></code>, указав пустой источник репликации: <br /> <code class="docutils literal"><span class="pre">box.cfg{replication_source=''}</span></code></p>
<p>Вопрос: Что если какой-то сервер вдруг выбывает из кластера? <br /> Ответ: Остальные сервера продолжают работать. Если выбывший сервер снова возвращается в кластер, то он получит информацию о всех изменениях, которые произошли на остальных серверах за время его отсутствия.</p>
<p>Вопрос: Что если два сервера совершают изменения, связанные с одним и тем же кортежем? <br /> Ответ: Применятся последние из совершенных изменений. Для примера предположим, что сервер #1 меняет некоторый кортеж, а затем сервер #2 меняет тот же кортеж. В данном случае изменения сервера #2 затрут изменения сервера #1. Чтобы отслеживать, кто был последним, в Tarantool'е используются <a class="reference external" href="https://en.wikipedia.org/wiki/Vector_clock">векторные часы</a>.</p>
<p>Вопрос: Что если оба сервера выполняют вставку одного и того же кортежа? <br /> Ответ: Если главный сервер попытается вставить кортеж, который уже был вставлен на реплике, то это будет пример серьезной ошибки. Репликация остановится, и ее придется перезапускать в ручную.</p>
<p>Вопрос: Что если главный сервер становится недоступен и пользователям приходится переключаться реплику? <br /> Ответ: Реплика получает сообщение, что связь потеряна. Теперь реплика должна начать работать независимо. Для этого ей нужно задать пустой источник репликации, выполнив на стороне реплики запрос <code class="docutils literal"><span class="pre">box.cfg{replication_source=''}</span></code>.</p>
<p>Вопрос: Что если нужно посмотреть, к какому кластеру принадлежит данный сервер? <br /> Ответ: Идентификатором кластера является UUID, который генерируется при первом запуске главного сервера. Данный UUID хранится в системном пространстве <a class="reference internal" href="singlehtml.html#box-space-schema"><span class="std std-ref">box.space._schema</span></a>. Чтобы посмотреть UUID кластера, введите запрос <code class="docutils literal"><span class="pre">box.space._schema:select{'cluster'}</span></code></p>
<p>Вопрос: Что если нужно посмотреть, какие сервера входят в кластер? <br /> Ответ: У каждого сервера есть универсальный идентификатор — это его UUID в поле <code class="docutils literal"><span class="pre">box.info.server.uuid</span></code>. Также у сервера есть его порядковый идентификатор в кластере — это номер в поле <code class="docutils literal"><span class="pre">box.info.server.id</span></code>. Чтобы увидеть номера всех серверов в кластере, введите запрос: <code class="docutils literal"><span class="pre">box.space._cluster:select{}</span></code>. Данный запрос возвращает таблицу со всеми кортежами вида {server.id, server.uuid} для всех серверов, что когда-либо входили в данный кластер.</p>
<p>Вопрос: Что если какой-то из файлов репликации на реплике поврежден или удален? <br /> Ответ: Нужно остановить сервер, удалить все файлы, относящиеся к базе данных (это файлы с расширениями &quot;snap&quot;, &quot;xlog&quot; и &quot;.inprogress&quot;), снова запустить сервер и ввести запрос <code class="docutils literal"><span class="pre">box.cfg{...replication_source=...}</span></code>, чтобы восстановить соединение с главным сервером и загрузить данные с него.</p>
<p>Вопрос: Что если при репликации возникают вопросы, связанные с безопасностью? <br /> Ответ: Чтобы предотвратить появление несанкционированных источников репликации, нужно задать пароль для каждого пользователя, у которого есть привилегии доступа к соответствующим пространствам, а также для каждого пользователя, у которого настроена <a class="reference internal" href="singlehtml.html#authentication-rep-role"><span class="std std-ref">репликационная роль</span></a>. Заметьте, что <a class="reference internal" href="singlehtml.html#index-uri"><span class="std std-ref">URI</span></a> для параметра <a class="reference internal" href="singlehtml.html#cfg-replication-replication-source"><span class="std std-ref">replication_source</span></a> теперь нужно всегда указывать в полном виде: <br /> <code class="docutils literal"><span class="pre">replication_source='username:password&#64;host:port'</span></code></p>
<p>Вопрос: Что если продвинутые пользователи хотят глубже разобраться с тем, как работает репликация? <br /> Ответ: См. информацию о запуске сервера с репликацией в Приложении B. <a class="reference internal" href="singlehtml.html#b-internals-replication"><span class="std std-ref">Детали реализации</span></a>.</p>
</div>
<div class="section" id="hands-on-replication-tutorial">
<h4>4.10. Практическое руководство по репликации<a class="headerlink" href="#hands-on-replication-tutorial" title="Ссылка на этот заголовок">¶</a></h4>
<p>Ниже приводятся пошаговые инструкции, которые помогут вам получить практический опыт администрирования кластера, а именно опыт создания кластера и добавления реплики.</p>
<p>Запустите два терминала, каждый в своем окне, и расположите их рядом на экране. (Далее в примерах оба терминала показаны в виде закладок. Щелкните на заголовок закладки — &quot;Terminal #1&quot; или &quot;Terminal #2&quot;, — чтобы увидеть вывод на соответствующем терминале.)</p>
<div class="b-block-wrapper-doc container">
<div class="b-doc-catalog container" id="catalog-1">
<ul class="b-tab_switcher">
    <li class="b-tab_switcher-item">
        <a href="#terminal-1-1" class="b-tab_switcher-item-url p-active">Terminal #1</a>
    </li>
    <li class="b-tab_switcher-item">
        <a href="#terminal-1-2" class="b-tab_switcher-item-url">Terminal #2</a>
    </li>
</ul></div>
<div class="b-documentation-tab-content container" id="catalog-1-content">
<div class="b-documentation-tab container" id="terminal-1-1">
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span>
</pre></div>
</div>
</div>
<div class="b-documentation-tab container" id="terminal-1-2">
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span>
</pre></div>
</div>
</div>
</div>
</div>
<p>В первом терминале (Terminal #1) выполните следующие команды:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="c1"># Terminal 1</span>
<span class="gp">$</span> mkdir -p ~/tarantool_test_node_1
<span class="gp">$</span> <span class="nb">cd</span> ~/tarantool_test_node_1
<span class="gp">$</span> rm -R ~/tarantool_test_node_1/*
<span class="gp">$</span> ~/tarantool/src/tarantool
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span> <span class="o">=</span> <span class="mi">3301</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">replicator&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">password&#39;</span><span class="p">})</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">replicator&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">role&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">replication&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_cluster</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>В результате были заданы настройки нового кластера, а на экране был выведен UUID текущего сервера. Теперь вывод на экране выглядит следующим образом (за тем исключением, что UUID у вас будут другие):</p>
<div class="b-block-wrapper-doc container">
<div class="b-doc-catalog container" id="catalog-2">
<ul class="b-tab_switcher">
    <li class="b-tab_switcher-item">
        <a href="#terminal-2-1" class="b-tab_switcher-item-url p-active">Terminal #1</a>
    </li>
    <li class="b-tab_switcher-item">
        <a href="#terminal-2-2" class="b-tab_switcher-item-url">Terminal #2</a>
    </li>
</ul></div>
<div class="b-documentation-tab-content container" id="catalog-2-content">
<div class="b-documentation-tab container" id="terminal-2-1">
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="c1"># Terminal 1</span>
<span class="gp">$</span> mkdir -p ~/tarantool_test_node_1
<span class="gp">$</span> <span class="nb">cd</span> ~/tarantool_test_node_1
<span class="gp">$</span> rm -R ./*
<span class="gp">$</span> ~/tarantool/src/tarantool
<span class="gp">$</span> ~/tarantool/src/tarantool: version 1.7.0-1724-g033ed69
<span class="go">type &#39;help&#39; for interactive help</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span> <span class="o">=</span> <span class="mi">3301</span><span class="p">}</span>
<span class="go">&lt;... ...&gt;</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">replicator&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">password&#39;</span><span class="p">})</span>
<span class="go">&lt;...&gt; I&gt; creating ./00000000000000000000.xlog.inprogress&#39;</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">replicator&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">role&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">replication&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_cluster</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;6190d919-1133-4452-b123-beca0b178b32&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="b-documentation-tab container" id="terminal-2-2">
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span>
</pre></div>
</div>
</div>
</div>
</div>
<p>Во втором терминале (Terminal #2) выполните следующие команды:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="c1"># Terminal 2</span>
<span class="gp">$</span> mkdir -p ~/tarantool_test_node_2
<span class="gp">$</span> <span class="nb">cd</span> ~/tarantool_test_node_2
<span class="gp">$</span> rm -R ~/tarantool_test_node_2/*
<span class="gp">$</span> ~/tarantool/src/tarantool
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">listen</span> <span class="o">=</span> <span class="mi">3302</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">replication_source</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">replicator:password@localhost:3301&#39;</span>
<span class="gp">         &gt; </span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_cluster</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>В результате были заданы настройки сервера-реплики. На экране первого терминала (Terminal #1) появились сообщения с подтверждениями, что реплика установила соединение с главным сервером и что содержимое WAL-файла было отправлено на реплику. На экране второго терминала (Terminal #2) появились сообщения о том, что репликация начинается, а также там были выведены UUID из системного пространства _cluster (один из них совпадает с UUID в первом терминале, поскольку оба сервера входят в общий кластер).</p>
<div class="b-block-wrapper-doc container">
<div class="b-doc-catalog container" id="catalog-3">
<ul class="b-tab_switcher">
    <li class="b-tab_switcher-item">
        <a href="#terminal-3-1" class="b-tab_switcher-item-url p-active">Terminal #1</a>
    </li>
    <li class="b-tab_switcher-item">
        <a href="#terminal-3-2" class="b-tab_switcher-item-url">Terminal #2</a>
    </li>
</ul></div>
<div class="b-documentation-tab-content container" id="catalog-3-content">
<div class="b-documentation-tab container" id="terminal-3-1">
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="c1"># Terminal 1</span>
<span class="gp">$</span> mkdir -p ~/tarantool_test_node_1
<span class="go">&lt;... ...&gt;</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_cluster</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;6190d919-1133-4452-b123-beca0b178b32&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/101/main I&gt; recovery start</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/101/main I&gt; recovering from `./00000000000000000000.snap&#39;</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/101/main I&gt; snapshot sent</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/101/main I&gt; recover from `./00000000000000000000.xlog&#39;</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/101/main recovery.cc:211 W&gt; file</span>
<span class="go">      `./00000000000000000000.xlog` wasn&#39;t correctly closed</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/102/main I&gt; recover from `./00000000000000000000.xlog&#39;</span>
</pre></div>
</div>
</div>
<div class="b-documentation-tab container" id="terminal-3-2">
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="c1"># Terminal 2</span>
<span class="gp">$</span> mkdir -p ~/tarantool_test_node_2
<span class="gp">$</span> <span class="nb">cd</span> ~/tarantool_test_node_2
<span class="gp">$</span> rm -R ./*
<span class="gp">$</span> ~/tarantool/src/tarantool
<span class="go">/home/username/tarantool/src/tarantool: version 1.7.0-1724-g033ed69</span>
<span class="go">type &#39;help&#39; for interactive help</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">listen</span> <span class="o">=</span> <span class="mi">3302</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">replication_source</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">replicator:password@localhost:3301&#39;</span>
<span class="gp">         &gt; </span><span class="p">}</span>
<span class="go">&lt;...&gt;</span>
<span class="go">&lt;...&gt; [11243] main/101/interactive I&gt; mapping 1073741824 bytes for tuple arena...</span>
<span class="go">&lt;...&gt; [11243] main/101/interactive C&gt; starting replication from localhost:3301</span>
<span class="go">&lt;...&gt; [11243] main/102/applier/localhost:3301 I&gt; connected to 1.7.0 at 127.0.0.1:3301</span>
<span class="go">&lt;...&gt; [11243] main/102/applier/localhost:3301 I&gt; authenticated</span>
<span class="go">&lt;...&gt; [11243] main/102/applier/localhost:3301 I&gt; downloading a snapshot from 127.0.0.1:3301</span>
<span class="go">&lt;...&gt; [11243] main/102/applier/localhost:3301 I&gt; done</span>
<span class="go">&lt;...&gt; [11243] snapshot/101/main I&gt; creating `./00000000000000000000.snap.inprogress&#39;</span>
<span class="go">&lt;...&gt; [11243] snapshot/101/main I&gt; saving snapshot `./00000000000000000000.snap.inprogress&#39;</span>
<span class="go">&lt;...&gt; [11243] snapshot/101/main I&gt; done</span>
<span class="go">&lt;...&gt; [11243] iproto I&gt; binary: started</span>
<span class="go">&lt;...&gt; [11243] iproto I&gt; binary: bound to 0.0.0.0:3302</span>
<span class="go">&lt;...&gt; [11243] wal/101/main I&gt; creating `./00000000000000000000.xlog.inprogress&#39;</span>
<span class="go">&lt;...&gt; [11243] main/101/interactive I&gt; ready to accept requests</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_cluster</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="go">- - [1, &#39;6190d919-1133-4452-b123-beca0b178b32&#39;]</span>
<span class="go">  - [2, &#39;236230b8-af3e-406b-b709-15a60b44c20c&#39;]</span>
<span class="go">...</span>
</pre></div>
</div>
</div>
</div>
</div>
<p>В первом терминале (Terminal #1) выполните следующие запросы:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tuple inserted on Terminal #1&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>Теперь вывод на экране выглядит следующим образом:</p>
<div class="b-block-wrapper-doc container">
<div class="b-doc-catalog container" id="catalog-4">
<ul class="b-tab_switcher">
    <li class="b-tab_switcher-item">
        <a href="#terminal-4-1" class="b-tab_switcher-item-url p-active">Terminal #1</a>
    </li>
    <li class="b-tab_switcher-item">
        <a href="#terminal-4-2" class="b-tab_switcher-item-url">Terminal #2</a>
    </li>
</ul></div>
<div class="b-documentation-tab-content container" id="catalog-4-content">
<div class="b-documentation-tab container" id="terminal-4-1">
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">&lt;... ...&gt;</span>
<span class="go">tarantool&gt;</span>
<span class="go">tarantool&gt;</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/101/main I&gt; recovery start</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/101/main I&gt; recovering from `./00000000000000000000.snap&#39;</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/101/main I&gt; snapshot sent</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/101/main I&gt; recover from `./00000000000000000000.xlog&#39;</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/101/main recovery.cc:211 W&gt; file</span>
<span class="go">      `./00000000000000000000.xlog` wasn&#39;t correctly closed</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/102/main I&gt; recover from `./00000000000000000000.xlog&#39;</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tuple inserted on Terminal #1&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#1&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="b-documentation-tab container" id="terminal-4-2">
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="c1"># Terminal 2</span>
<span class="gp">$</span> mkdir -p ~/tarantool_test_node_2
<span class="gp">$</span> <span class="nb">cd</span> ~/tarantool_test_node_2
<span class="gp">$</span> rm -R ./*
<span class="gp">$</span> ~/tarantool/src/tarantool
<span class="go">/home/username/tarantool/src/tarantool: version 1.7.0-1724-g033ed69</span>
<span class="go">type &#39;help&#39; for interactive help</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">listen</span> <span class="o">=</span> <span class="mi">3302</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">replication_source</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">replicator:password@localhost:3301&#39;</span>
<span class="gp">         &gt; </span><span class="p">}</span>
<span class="go">&lt;...&gt;</span>
<span class="go">&lt;...&gt; [11243] main/101/interactive I&gt; mapping 1073741824 bytes for tuple arena...</span>
<span class="go">&lt;...&gt; [11243] main/101/interactive C&gt; starting replication from localhost:3301</span>
<span class="go">&lt;...&gt; [11243] main/102/applier/localhost:3301 I&gt; connected to 1.7.0 at 127.0.0.1:3301</span>
<span class="go">&lt;...&gt; [11243] main/102/applier/localhost:3301 I&gt; authenticated</span>
<span class="go">&lt;...&gt; [11243] main/102/applier/localhost:3301 I&gt; downloading a snapshot from 127.0.0.1:3301</span>
<span class="go">&lt;...&gt; [11243] main/102/applier/localhost:3301 I&gt; done</span>
<span class="go">&lt;...&gt; [11243] snapshot/101/main I&gt; creating `./00000000000000000000.snap.inprogress&#39;</span>
<span class="go">&lt;...&gt; [11243] snapshot/101/main I&gt; saving snapshot `./00000000000000000000.snap.inprogress&#39;</span>
<span class="go">&lt;...&gt; [11243] snapshot/101/main I&gt; done</span>
<span class="go">&lt;...&gt; [11243] iproto I&gt; binary: started</span>
<span class="go">&lt;...&gt; [11243] iproto I&gt; binary: bound to 0.0.0.0:3302</span>
<span class="go">&lt;...&gt; [11243] wal/101/main I&gt; creating `./00000000000000000000.xlog.inprogress&#39;</span>
<span class="go">&lt;...&gt; [11243] main/101/interactive I&gt; ready to accept requests</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_cluster</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="go">- - [1, &#39;6190d919-1133-4452-b123-beca0b178b32&#39;]</span>
<span class="go">  - [2, &#39;236230b8-af3e-406b-b709-15a60b44c20c&#39;]</span>
<span class="go">...</span>
</pre></div>
</div>
</div>
</div>
</div>
<p>В первом терминале успешно отработали операции CREATE и INSERT. Но во втором терминале ничего не произошло.</p>
<p>Во втором терминале (Terminal #2) выполните следующие запросы:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tuple inserted on Terminal #2&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>Теперь вывод на экране выглядит следующим образом:</p>
<div class="b-block-wrapper-doc container">
<div class="b-doc-catalog container" id="catalog-5">
<ul class="b-tab_switcher">
    <li class="b-tab_switcher-item">
        <a href="#terminal-5-1" class="b-tab_switcher-item-url p-active">Terminal #1</a>
    </li>
    <li class="b-tab_switcher-item">
        <a href="#terminal-5-2" class="b-tab_switcher-item-url">Terminal #2</a>
    </li>
</ul></div>
<div class="b-documentation-tab-content container" id="catalog-5-content">
<div class="b-documentation-tab container" id="terminal-5-1">
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">&lt;... ...&gt;</span>
<span class="go">tarantool&gt;</span>
<span class="go">tarantool&gt;</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/101/main I&gt; recovery start</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/101/main I&gt; recovering from `./00000000000000000000.snap&#39;</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/101/main I&gt; snapshot sent</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/101/main I&gt; recover from `./00000000000000000000.xlog&#39;</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/101/main recovery.cc:211 W&gt; file</span>
<span class="go">      `./00000000000000000000.xlog` wasn&#39;t correctly closed</span>
<span class="go">&lt;...&gt; [11031] relay/127.0.0.1:58734/102/main I&gt; recover from `./00000000000000000000.xlog&#39;</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tuple inserted on Terminal #1&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#1&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="b-documentation-tab container" id="terminal-5-2">
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">&lt;... ...&gt;</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">_cluster</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="go">- - [1, &#39;6190d919-1133-4452-b123-beca0b178b32&#39;]</span>
<span class="go">  - [2, &#39;236230b8-af3e-406b-b709-15a60b44c20c&#39;]</span>
<span class="go">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#1&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tuple inserted on Terminal #2&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#2&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
</div>
</div>
<p>Во втором терминале успешно отработали операции SELECT и INSERT. Но в первом терминале ничего не произошло.</p>
<p>В первом терминале (Terminal #1) выполните следующие запросы и команды:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> os.exit<span class="o">()</span>
<span class="gp">$</span> ls -l ~/tarantool_test_node_1
<span class="gp">$</span> ls -l ~/tarantool_test_node_2
</pre></div>
</div>
<p>Теперь Tarantool-сервер в первом терминале остановлен. В окне второго терминала появились сообщения об этом событии. С помощью команд <code class="docutils literal"><span class="pre">ls</span> <span class="pre">-l</span></code> мы убедились, что на обоих серверах создались файлы-снимки с одинаковыми размерами, поскольку там содержатся одни и те же кортежи.</p>
<div class="b-block-wrapper-doc container">
<div class="b-doc-catalog container" id="catalog-6">
<ul class="b-tab_switcher">
    <li class="b-tab_switcher-item">
        <a href="#terminal-6-1" class="b-tab_switcher-item-url p-active">Terminal #1</a>
    </li>
    <li class="b-tab_switcher-item">
        <a href="#terminal-6-2" class="b-tab_switcher-item-url">Terminal #2</a>
    </li>
</ul></div>
<div class="b-documentation-tab-content container" id="catalog-6-content">
<div class="b-documentation-tab container" id="terminal-6-1">
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">&lt;... ...&gt;</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tuple inserted on Terminal #1&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#1&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">$</span> ls -l ~/tarantool_test_node_1
<span class="gp">tarantool&gt; </span><span class="nb">os.exit</span><span class="p">()</span>
<span class="go">total 8</span>
<span class="go">-rw-rw-r-- 1  4925 May  5 11:12 00000000000000000000.snap</span>
<span class="go">-rw-rw-r-- 1   634 May  5 11:45 00000000000000000000.xlog</span>
<span class="gp">$</span> ls -l ~/tarantool_test_node_2/
<span class="go">total 8</span>
<span class="go">-rw-rw-r-- 1  4925 May  5 11:20 00000000000000000000.snap</span>
<span class="go">-rw-rw-r-- 1   704 May  5 11:38 00000000000000000000.xlog</span>
<span class="go">$</span>
</pre></div>
</div>
</div>
<div class="b-documentation-tab container" id="terminal-6-2">
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">&lt;... ...&gt;</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#1&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tuple inserted on Terminal #2&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#2&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
<span class="go">&lt;...&gt; [25579] main/103/replica/localhost:3301 I&gt; can&#39;t read row</span>
<span class="go">&lt;...&gt; [25579] main/103/replica/localhost:3301 !&gt; SystemError</span>
<span class="go">  unexpected EOF when reading from socket,</span>
<span class="go">  called on fd 10, aka 127.0.0.1:50884, peer of 127.0.0.1:3301: Broken pipe</span>
<span class="go">&lt;...&gt; [25579] main/103/replica/localhost:3301 I&gt; will retry every 1 second</span>
</pre></div>
</div>
</div>
</div>
</div>
<p>Во втором терминале (Terminal #2) проигнорируйте сообщения об ошибках и выполните следующие запросы:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Another&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>Теперь вывод на экране выглядит следующим образом (сообщения об ошибках мы не приводим):</p>
<div class="b-block-wrapper-doc container">
<div class="b-doc-catalog container" id="catalog-7">
<ul class="b-tab_switcher">
    <li class="b-tab_switcher-item">
        <a href="#terminal-7-1" class="b-tab_switcher-item-url p-active">Terminal #1</a>
    </li>
    <li class="b-tab_switcher-item">
        <a href="#terminal-7-2" class="b-tab_switcher-item-url">Terminal #2</a>
    </li>
</ul></div>
<div class="b-documentation-tab-content container" id="catalog-7-content">
<div class="b-documentation-tab container" id="terminal-7-1">
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">&lt;... ...&gt;</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tuple inserted on Terminal #1&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#1&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">$</span> ls -l ~/tarantool_test_node_1
<span class="gp">tarantool&gt; </span><span class="nb">os.exit</span><span class="p">()</span>
<span class="go">total 8</span>
<span class="go">-rw-rw-r-- 1  4925 May  5 11:12 00000000000000000000.snap</span>
<span class="go">-rw-rw-r-- 1   634 May  5 11:45 00000000000000000000.xlog</span>
<span class="gp">$</span> ls -l ~/tarantool_test_node_2/
<span class="go">total 8</span>
<span class="go">-rw-rw-r-- 1  4925 May  5 11:20 00000000000000000000.snap</span>
<span class="go">-rw-rw-r-- 1   704 May  5 11:38 00000000000000000000.xlog</span>
<span class="go">$</span>
</pre></div>
</div>
</div>
<div class="b-documentation-tab container" id="terminal-7-2">
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">&lt;... ...&gt;</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tuple inserted on Terminal #2&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#2&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
<span class="go">&lt;...&gt; [11243] main/105/applier/localhost:3301 I&gt; can&#39;t read row</span>
<span class="go">&lt;...&gt; [11243] main/105/applier/localhost:3301 coio.cc:352 !&gt; SystemError</span>
<span class="go">  unexpected EOF when reading from socket,</span>
<span class="go">  called on fd 6, aka 127.0.0.1:58734, peer of 127.0.0.1:3301: Broken pipe</span>
<span class="go">&lt;...&gt; [11243] main/105/applier/localhost:3301 I&gt; will retry every 1 second</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#1&#39;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#2&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Another&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span> <span class="s">&#39;Another&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
</div>
</div>
<p>Запросы SELECT и INSERT во втором терминале отработали несмотря на то, что сервер в первом терминале остановлен.</p>
<p>В первом терминале (Terminal #1) выполните следующие запросы:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">$</span> ~/tarantool/src/tarantool
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span> <span class="o">=</span> <span class="mi">3301</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Теперь вывод на экране выглядит следующим образом:</p>
<div class="b-block-wrapper-doc container">
<div class="b-doc-catalog container" id="catalog-8">
<ul class="b-tab_switcher">
    <li class="b-tab_switcher-item">
        <a href="#terminal-8-1" class="b-tab_switcher-item-url p-active">Terminal #1</a>
    </li>
    <li class="b-tab_switcher-item">
        <a href="#terminal-8-2" class="b-tab_switcher-item-url">Terminal #2</a>
    </li>
</ul></div>
<div class="b-documentation-tab-content container" id="catalog-8-content">
<div class="b-documentation-tab container" id="terminal-8-1">
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">&lt;... ...&gt;</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tuple inserted on Terminal #1&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#1&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">$</span> ls -l ~/tarantool_test_node_1
<span class="gp">tarantool&gt; </span><span class="nb">os.exit</span><span class="p">()</span>
<span class="go">total 8</span>
<span class="go">-rw-rw-r-- 1  4925 May  5 11:12 00000000000000000000.snap</span>
<span class="go">-rw-rw-r-- 1   634 May  5 11:45 00000000000000000000.xlog</span>
<span class="gp">$</span> ls -l ~/tarantool_test_node_2/
<span class="go">total 8</span>
<span class="go">-rw-rw-r-- 1  4925 May  5 11:20 00000000000000000000.snap</span>
<span class="go">-rw-rw-r-- 1   704 May  5 11:38 00000000000000000000.xlog</span>
<span class="gp">$</span> ~/tarantool/src/tarantool
<span class="go">&lt;...&gt;</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span> <span class="o">=</span> <span class="mi">3301</span><span class="p">}</span>
<span class="go">&lt;...&gt; [22612] main/101/interactive I&gt; ready to accept requests</span>
<span class="go">&lt;... ...&gt;</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="go">- - [1, &#39;Tuple inserted on Terminal #1&#39;]</span>
<span class="go">...</span>
</pre></div>
</div>
</div>
<div class="b-documentation-tab container" id="terminal-8-2">
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">&lt;... ...&gt;</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tuple inserted on Terminal #2&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#2&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
<span class="go">&lt;...&gt; [25579] main/103/replica/localhost:3301 I&gt; can&#39;t read row</span>
<span class="go">&lt;...&gt; [25579] main/103/replica/localhost:3301 !&gt; SystemError</span>
<span class="go">  unexpected EOF when reading from socket,</span>
<span class="go">  called on fd 10, aka 127.0.0.1:50884, peer of 127.0.0.1:3301: Broken pipe</span>
<span class="go">&lt;...&gt; [25579] main/103/replica/localhost:3301 I&gt; will retry every 1 second</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#1&#39;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#2&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Another&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span> <span class="s">&#39;Another&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="go">&lt;...&gt; [11243] main/105/applier/localhost:3301 I&gt; connected to 1.7.0 at 127.0.0.1:3301</span>
<span class="go">&lt;...&gt; [11243] main/105/applier/localhost:3301 I&gt; authenticated</span>
</pre></div>
</div>
</div>
</div>
</div>
<p>Главный сервер снова установил соединение с кластером и НЕ обнаружил изменения, сделанные репликой за время его недоступности. Это и не удивительно: мы же не просили реплику выступать в качестве источника репликации.</p>
<p>В первом терминале (Terminal #1) введите:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">replication_source</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">replicator:password@localhost:3302&#39;</span>
<span class="gp">         &gt; </span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Теперь вывод на экране выглядит следующим образом:</p>
<div class="b-block-wrapper-doc container">
<div class="b-doc-catalog container" id="catalog-9">
<ul class="b-tab_switcher">
    <li class="b-tab_switcher-item">
        <a href="#terminal-9-1" class="b-tab_switcher-item-url p-active">Terminal #1</a>
    </li>
    <li class="b-tab_switcher-item">
        <a href="#terminal-9-2" class="b-tab_switcher-item-url">Terminal #2</a>
    </li>
</ul></div>
<div class="b-documentation-tab-content container" id="catalog-9-content">
<div class="b-documentation-tab container" id="terminal-9-1">
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">&lt;... ...&gt;</span>
<span class="gp">$</span> ~/tarantool/src/tarantool
<span class="go">&lt;...&gt;</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span> <span class="o">=</span> <span class="mi">3301</span><span class="p">}</span>
<span class="go">&lt;...&gt; [22612] main/101/interactive I&gt; ready to accept requests</span>
<span class="go">&lt;... ...&gt;</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#1&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">replication_source</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">replicator:password@localhost:3302&#39;</span>
<span class="gp">         &gt; </span><span class="p">}</span>
<span class="go">[28987] main/101/interactive C&gt; starting replication from localhost:3302</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="go">[22612] main/101/interactive C&gt; starting replication from localhost:3302</span>
<span class="go">[22612] main/101/interactive I&gt; set &#39;replication_source&#39; configuration</span>
<span class="go">        option to &quot;replicator:password@localhost:3302&quot;</span>
<span class="go">[22612] main/104/applier/localhost:3302 I&gt; connected to 1.7.0 at 127.0.0.1:3302</span>
<span class="go">[22612] main/104/applier/localhost:3302 I&gt; authenticated</span>
<span class="go">[22612] wal/101/main I&gt; creating `./00000000000000000008.xlog.inprogress&#39;</span>
<span class="go">[22612] relay/127.0.0.1:33510/102/main I&gt; done `./00000000000000000000.xlog&#39;</span>
<span class="go">[22612] relay/127.0.0.1:33510/102/main I&gt; recover from `./00000000000000000008.xlog&#39;</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#1&#39;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#2&#39;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span> <span class="s">&#39;Another&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="b-documentation-tab container" id="terminal-9-2">
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">&lt;... ...&gt;</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Tuple inserted on Terminal #2&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#2&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
<span class="go">&lt;...&gt; [25579] main/103/replica/localhost:3301 I&gt; can&#39;t read row</span>
<span class="go">&lt;...&gt; [25579] main/103/replica/localhost:3301 !&gt; SystemError</span>
<span class="go">  unexpected EOF when reading from socket,</span>
<span class="go">  called on fd 10, aka 127.0.0.1:50884, peer of 127.0.0.1:3301: Broken pipe</span>
<span class="go">&lt;...&gt; [25579] main/103/replica/localhost:3301 I&gt; will retry every 1 second</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#1&#39;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">inserted</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">Terminal</span><span class="nv"> </span><span class="s">#2&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Another&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span> <span class="s">&#39;Another&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="go">&lt;...&gt; [11243] main/105/applier/localhost:3301 I&gt; connected to 1.7.0 at 127.0.0.1:3301</span>
<span class="go">&lt;...&gt; [11243] main/105/applier/localhost:3301 I&gt; authenticated</span>
<span class="go">tarantool&gt;</span>
<span class="go">&lt;...&gt; [11243] relay/127.0.0.1:36150/101/main I&gt; recover from `./00000000000000000000.xlog&#39;</span>
<span class="go">&lt;...&gt; [11243] relay/127.0.0.1:36150/101/main recovery.cc:211 W&gt; file</span>
<span class="go">     `./00000000000000000000.xlog` wasn&#39;t correctly closed</span>
<span class="go">&lt;...&gt; [11243] relay/127.0.0.1:36150/102/main I&gt; recover from `./00000000000000000000.xlog&#39;</span>
</pre></div>
</div>
</div>
</div>
<script>
    register_replication_tab(1);
    register_replication_tab(2);
    register_replication_tab(3);
    register_replication_tab(4);
    register_replication_tab(5);
    register_replication_tab(6);
    register_replication_tab(7);
    register_replication_tab(8);
    register_replication_tab(9);
</script></div>
<p>Тут мы видим, что оба сервера снова синхронизовались и что каждый из них видит те записи, которые сделал другой.</p>
<p>Чтобы удалить все тестовые данные, выполните &quot;<code class="docutils literal"><span class="pre">os.exit()</span></code>&quot; на обоих терминалах, а затем на каждом из них выполните следующие команды:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> ~
<span class="gp">$</span> rm -R ~/tarantool_test_node_1
<span class="gp">$</span> rm -R ~/tarantool_test_node_2
</pre></div>
</div>
</div>
</div>
<span id="document-book/configuration/index"></span><div class="section" id="configuration-reference">
<span id="index-book-cfg"></span><h3>5. Справочник по конфигурированию<a class="headerlink" href="#configuration-reference" title="Ссылка на этот заголовок">¶</a></h3>
<p>В этой главе приводится справочная информация о конфигурационных параметрах, которые можно передавать в командной строке или указывать в файле инициализации.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#command-options" id="id1">Опции командной строки</a></li>
<li><a class="reference internal" href="#uri" id="id2">Универсальный код ресурса (URI)</a></li>
<li><a class="reference internal" href="#initialization-file" id="id3">Файл инициализации</a></li>
<li><a class="reference internal" href="#configuration-parameters" id="id4">Параметры конфигурации</a><ul>
<li><a class="reference internal" href="#basic-parameters" id="id5">Основные параметры</a></li>
<li><a class="reference internal" href="#configuring-the-storage" id="id6">Настройка хранилища данных</a></li>
<li><a class="reference internal" href="#snapshot-daemon" id="id7">Фоновая программа для работы со снимками</a></li>
<li><a class="reference internal" href="#binary-logging-and-snapshots" id="id8">Журналирование и снимки в бинарном формате</a></li>
<li><a class="reference internal" href="#replication" id="id9">Репликация</a></li>
<li><a class="reference internal" href="#networking" id="id10">Работа с сетевыми соединениями</a></li>
<li><a class="reference internal" href="#logging" id="id11">Запись в журнал</a></li>
</ul>
</li>
<li><a class="reference internal" href="#local-hot-standby" id="id12">Режим горячего резервирования</a></li>
</ul>
</div>
<p>Для запуска Tarantool-сервера нужно ввести одну из следующих команд:</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span>$ **tarantool**
# ИЛИ
$ **tarantool** *опции*
# ИЛИ
$ **tarantool** *файл-инициализации-на-lua* **[** *аргументы* **]**
</pre></div>
</div>
<div class="section" id="command-options">
<h4><a class="toc-backref" href="#id1">5.1. Опции командной строки</a><a class="headerlink" href="#command-options" title="Ссылка на этот заголовок">¶</a></h4>
<dl class="option">
<dt id="cmdoption-h">
<span id="cmdoption--help"></span><code class="descname">-h</code><code class="descclassname"></code><code class="descclassname">, </code><code class="descname">--help</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-h" title="Ссылка на это определение">¶</a></dt>
<dd><p>Вывести на экран список всех опций командной строки с комментариями.</p>
</dd></dl>

<span class="target" id="index-tarantool-version"></span><dl class="option">
<dt id="cmdoption-V">
<span id="cmdoption--version"></span><code class="descname">-V</code><code class="descclassname"></code><code class="descclassname">, </code><code class="descname">--version</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-V" title="Ссылка на это определение">¶</a></dt>
<dd><p>Вывести на экран имя продукта и номер версии, например:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ./tarantool --version
<span class="go">Tarantool 1.7.0-1216-g73f7154</span>
<span class="go">Target: Linux-x86_64-Debug</span>
<span class="go">...</span>
</pre></div>
</div>
<p>В нашем примере:</p>
<p>&quot;Tarantool&quot; — это имя асинхронной сетевой программной среды.</p>
<p>Номер версии составлен по стандартной схеме из 3 частей: <code class="docutils literal"><span class="pre">&lt;major&gt;-&lt;minor&gt;-&lt;patch&gt;</span></code>, где <code class="docutils literal"><span class="pre">&lt;major&gt;</span></code> изменяется очень редко, <code class="docutils literal"><span class="pre">&lt;minor&gt;</span></code> увеличивается на каждый стабильный релиз (milestone) и свидетельствует о возможных несовместимостях с предыдущими версиями, а <code class="docutils literal"><span class="pre">&lt;patch&gt;</span></code> указывает количество релизов с доработками с момента текущего стабильного релиза (milestone'а). Для сборок, не предназначенных для релиза, здесь могут быть добавлены также номер и SHA1-код коммита, которые указывают, насколько сильно текущая сборка отличается от предыдущего релиза.</p>
<p>&quot;Target&quot; — это платформа, на которой была сделана данная сборка Tarantool'а. За этой строчкой может следовать информация для данной платформы.</p>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">Идентификатор версии (version id) в Tarantool'е получают с помощью команды <a class="reference external" href="http://www.kernel.org/pub/software/scm/git/docs/git-describe.html">git describe</a>. По этому идентификатору можно в любой момент извлечь соответствующие исходные файлы из <a class="reference external" href="http://github.com/tarantool/tarantool.git">git-репозитория</a>.</p>
</div>
</dd></dl>

</div>
<div class="section" id="uri">
<span id="index-uri"></span><h4><a class="toc-backref" href="#id2">5.2. Универсальный код ресурса (URI)</a><a class="headerlink" href="#uri" title="Ссылка на этот заголовок">¶</a></h4>
<p>Некоторые функции и параметры конфигурации в Tarantool'е зависят от универсального кода доступа (URI = Universal Resource Identifier). Формат URI-строки аналогичен <a class="reference external" href="http://en.wikipedia.org/wiki/URI_scheme#Generic_syntax">общепринятому синтаксису URI-схемы</a> и может содержать (перечисляем по порядку) имя пользователя для входа в систему, пароль, имя или IP-адрес хоста, номер порта. Обязательным параметром является только номер порта. Пароль обязателен, если указано имя пользователя (за исключением имени 'guest'). Таким образом, синтаксис URI формально выглядит так: <code class="docutils literal"><span class="pre">[host:]port</span></code> или <code class="docutils literal"><span class="pre">[username:password&#64;]host:port</span></code>. Если не указан <code class="docutils literal"><span class="pre">host</span></code>, то значением по умолчанию является  '0.0.0.0' (т.е. любой адрес формата IPv4) или '[::]'  (т.е. любой адрес формата IPv6) на локальной машине. Если не указаны <code class="docutils literal"><span class="pre">username:password</span></code>, то значением по умолчанию является 'guest'. Вот несколько примеров:</p>
<blockquote>
<div><div class="table container">
<table border="1" class="left-align-column-1 left-align-column-2 docutils">
<colgroup>
<col width="49%" />
<col width="51%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">Часть URI</p>
</th>
<th class="head"><p class="first last">Пример</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>port</td>
<td>3301</td>
</tr>
<tr class="row-odd"><td>host:port</td>
<td>127.0.0.1:3301</td>
</tr>
<tr class="row-even"><td>username:password&#64;host:port</td>
<td>notguest:sesame&#64;mail.ru:3301</td>
</tr>
</tbody>
</table>
</div>
</div></blockquote>
<p>В некоторых случаях вместо URI можно указывать сокет домена Unix, например &quot;unix/:/tmp/unix_domain_socket.sock&quot; или просто &quot;/tmp/unix_domain_socket.sock&quot;.</p>
<p>См. также <a class="reference internal" href="singlehtml.html#e-cookbook-uri-parse"><span class="std std-ref">Appendix E: Cookbook</span></a>, где приводится вариант реализации для парсинга URI-адресов.</p>
</div>
<div class="section" id="initialization-file">
<span id="index-init-label"></span><h4><a class="toc-backref" href="#id3">5.3. Файл инициализации</a><a class="headerlink" href="#initialization-file" title="Ссылка на этот заголовок">¶</a></h4>
<p>Если в команде запуска Tarantool'а указан <cite>файл инициализации на языке Lua</cite>, то запуск начинается с вызова Lua-программы из файла с именем &quot;<code class="docutils literal"><span class="pre">script.lua</span></code>&quot;. Эта Lua-программа может принимать дальнейшие аргументы, указанные в командной строке, или использовать функции операционной системы, такие как <code class="docutils literal"><span class="pre">getenv()</span></code>. Если после запуска Tarantool'а предполагается использовать сервер баз данных или требуется открыть порты на прослушивание, то Lua-программа почти всегда начинается с вызова <code class="docutils literal"><span class="pre">box.cfg()</span></code>. Для примера возьмем файл <code class="docutils literal"><span class="pre">script.lua</span></code>, который содержит следующие строки:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>
<span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span>
    <span class="n">listen</span>              <span class="o">=</span> <span class="nb">os.getenv</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">LISTEN_URI&quot;</span><span class="p">),</span>
    <span class="n">slab_alloc_arena</span>    <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">pid_file</span>            <span class="o">=</span> <span class="s2">&quot;</span><span class="s">tarantool.pid&quot;</span><span class="p">,</span>
    <span class="n">rows_per_wal</span>        <span class="o">=</span> <span class="mi">50</span>
<span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Starting &#39;</span><span class="p">,</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p>Далее предположим, что системная переменная LISTEN_URI содержит значение 3301, а вызов командной строки таков: <code class="docutils literal"><span class="pre">~/tarantool/src/tarantool</span> <span class="pre">script.lua</span> <span class="pre">ARG</span></code>. Вывод на экране в таком случае будет выглядеть следующим образом:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">export</span> <span class="nv">LISTEN_URI</span><span class="o">=</span>3301
<span class="gp">$</span> ~/tarantool/src/tarantool script.lua ARG
<span class="go">... main/101/script.lua C&gt; version 1.7.0-1216-g73f7154</span>
<span class="go">... main/101/script.lua C&gt; log level 5</span>
<span class="go">... main/101/script.lua I&gt; mapping 107374184 bytes for a shared arena...</span>
<span class="go">... main/101/script.lua I&gt; recovery start</span>
<span class="go">... main/101/script.lua I&gt; recovering from &#39;./00000000000000000000.snap&#39;</span>
<span class="go">... main/101/script.lua I&gt; primary: bound to 0.0.0.0:3301</span>
<span class="go">... main/102/leave_local_hot_standby I&gt; ready to accept requests</span>
<span class="go">Starting  ARG</span>
<span class="go">... main C&gt; entering the event loop</span>
</pre></div>
</div>
<p>Если после инициализации вам понадобится запустить интерактивную Tarantool-сессию на том же терминале, то это можно сделать с помощью команды <a class="reference internal" href="singlehtml.html#console-start"><span class="std std-ref">console.start()</span></a>.</p>
</div>
<div class="section" id="configuration-parameters">
<span id="index-snapshot-daemon"></span><span id="index-wal-mode"></span><span id="index-wal-dir"></span><span id="index-snap-dir"></span><span id="index-replication-source"></span><span id="index-slab-alloc-arena"></span><span id="index-replication-port"></span><span id="index-local-hot-standby"></span><h4><a class="toc-backref" href="#id4">5.4. Параметры конфигурации</a><a class="headerlink" href="#configuration-parameters" title="Ссылка на этот заголовок">¶</a></h4>
<p>Параметры конфигурации задаются следующим образом: <br /> <code class="extsamp docutils literal"><strong><span class="pre">box.cfg</span></strong><span class="pre">{[</span><em><span class="pre">key</span> <span class="pre">=</span> <span class="pre">value</span></em> <span class="pre">[,</span> <em><span class="pre">key</span> <span class="pre">=</span> <span class="pre">value</span> <span class="pre">...</span></em><span class="pre">]]}</span></code></p>
<p>Поскольку вызов <code class="docutils literal"><span class="pre">box.cfg</span></code> может содержать много параметров конфигурации, причем некоторые параметры (например, адреса директорий) могут со временем меняться, то имеет смысл хранить <code class="docutils literal"><span class="pre">box.cfg</span></code> в отдельном Lua-файле. Обычно это Lua-файл для инициализации, который указывается в командной строке при запуске Tarantool'а.</p>
<p>Большинство параметров конфигурации служат для настройки выделения ресурсов и открытия портов, а также для задания поведение базы данных. Все параметры являются необязательными. Некоторые параметры являются динамическими, т.е. их можно менять во время исполнения с помощью повторного вызова <code class="docutils literal"><span class="pre">box.cfg{}</span></code>.</p>
<p>Для просмотра все не нулевых значений параметров, введите <code class="docutils literal"><span class="pre">box.cfg</span></code> (без фигурных скобок). Для просмотра значения определенного параметра, например адреса для прослушивания, введите <code class="docutils literal"><span class="pre">box.cfg.listen</span></code>.</p>
<p>В следующих разделах описаны все параметры, которые служат для настройки основных операций, хранения, создания статических снимков данных, репликации, работы с сетевыми соединениями и журналирования.</p>
<div class="section" id="basic-parameters">
<h5><a class="toc-backref" href="#id5">5.4.1. Основные параметры</a><a class="headerlink" href="#basic-parameters" title="Ссылка на этот заголовок">¶</a></h5>
<dl class="confval">
<dt id="confval-background">
<code class="descname">background</code><a class="headerlink" href="#confval-background" title="Ссылка на это определение">¶</a></dt>
<dd><p>Запустить Tarantool-сервер в фоновом режиме. При этом нужно задать не нулевые значения для параметров <a class="reference internal" href="#cfg-logging-logger"><span class="std std-ref">logger</span></a> и <a class="reference internal" href="#cfg-basic-pid-file"><span class="std std-ref">pid_file</span></a>.</p>
<p>Тип значения: boolean <br /> По умолчанию: false <br /> Динамический: нет <br /></p>
</dd></dl>

<dl class="confval">
<dt id="confval-coredump">
<code class="descname">coredump</code><a class="headerlink" href="#confval-coredump" title="Ссылка на это определение">¶</a></dt>
<dd><p>Параметр устарел. Не используйте его.</p>
<p>Тип значения: boolean <br /> По умолчанию: false <br /> Динамический: нет <br /></p>
</dd></dl>

<span class="target" id="cfg-basic-custom-proc-title"></span><dl class="confval">
<dt id="confval-custom_proc_title">
<code class="descname">custom_proc_title</code><a class="headerlink" href="#confval-custom_proc_title" title="Ссылка на это определение">¶</a></dt>
<dd><p>Добавить указанную строку к <a class="reference internal" href="singlehtml.html#administration-proctitle"><span class="std std-ref">заголовку процесса</span></a> Tarantool-сервера (заголовок процесса выводится в колонке COMMAND в ответ на команды <code class="samp docutils literal"><span class="pre">ps</span> <span class="pre">-ef</span></code> и <code class="samp docutils literal"><span class="pre">top</span> <span class="pre">-c</span></code>).</p>
<p>Например, информация о процессе Tarantool-сервера, которая выводится по команде <code class="samp docutils literal"><span class="pre">ps</span> <span class="pre">-ef</span></code>, обычно имеет следующий вид:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ps -ef <span class="p">|</span> grep tarantool
<span class="go">1000     14939 14188  1 10:53 pts/2    00:00:13 tarantool &lt;running&gt;</span>
</pre></div>
</div>
<p>Однако, если в конфигурации указан параметр <code class="docutils literal"><span class="pre">custom_proc_title='sessions'</span></code>, то информация в выводе <code class="samp docutils literal"><span class="pre">ps</span> <span class="pre">-ef</span></code> будет другой:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ps -ef <span class="p">|</span> grep tarantool
<span class="go">1000     14939 14188  1 10:53 pts/2    00:00:16 tarantool &lt;running&gt;: sessions</span>
</pre></div>
</div>
<p>Тип значения: string <br /> По умолчанию: null <br /> Динамический: да <br /></p>
</dd></dl>

<span class="target" id="cfg-basic-listen"></span><dl class="confval">
<dt id="confval-listen">
<code class="descname">listen</code><a class="headerlink" href="#confval-listen" title="Ссылка на это определение">¶</a></dt>
<dd><p>Номер порта для чтения/записи данных, либо <a class="reference internal" href="#index-uri"><span class="std std-ref">URI-строка</span></a> (URI = Universal Resource Identifier). Значения по умолчанию у данного параметра нет, поэтому он <strong>обязателен</strong>, если у клиентов должна быть возможность устанавливать соединение с Tarantool-сервером по портам, не являющимся <a class="reference internal" href="singlehtml.html#administration-admin-ports"><span class="std std-ref">“портами для администрирования”</span></a>. Соединения через <code class="samp docutils literal"><span class="pre">listen=</span><em><span class="pre">URI</span></em></code> иногда называют соединениями по &quot;бинарному протоколу&quot; или по &quot;главному порту&quot;.</p>
<p>Стандартное значение — это 3301. Порт для прослушивания можно задавать также для <a class="reference internal" href="#book-cfg-local-hot-standby"><span class="std std-ref">режима горячего резервирования</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">Сервер-реплика принимает запросы на соединение на этом же порту. Реплика принимает только запросы на чтение, пока ей не будет назначена роль главного сервера.</p>
</div>
<p>Тип значения: integer или string <br /> По умолчанию: null <br /> Динамический: да <br /></p>
</dd></dl>

<span class="target" id="cfg-basic-pid-file"></span><dl class="confval">
<dt id="confval-pid_file">
<code class="descname">pid_file</code><a class="headerlink" href="#confval-pid_file" title="Ссылка на это определение">¶</a></dt>
<dd><p>Сохранить идентификатор процесса в указанный файл. Путь можно указывать относительно рабочей директории (<a class="reference internal" href="#cfg-basic-work-dir"><span class="std std-ref">work_dir</span></a>). Стандартное значение — это “<code class="file docutils literal"><span class="pre">tarantool.pid</span></code>”.</p>
<p>Тип значения: string <br /> По умолчанию: null <br /> Динамический: нет <br /></p>
</dd></dl>

<span class="target" id="cfg-basic-read-only"></span><dl class="confval">
<dt id="confval-read_only">
<code class="descname">read_only</code><a class="headerlink" href="#confval-read_only" title="Ссылка на это определение">¶</a></dt>
<dd><p>Перевести сервер в режим &quot;доступен только на чтение&quot;. После установки этого параметра Tarantool-сервер будет возвращать ошибку ER_READONLY на все запросы на изменение данных.</p>
<p>Тип значения: boolean <br /> По умолчанию: false <br /> Динамический: да <br /></p>
</dd></dl>

<span class="target" id="cfg-basic-snap-dir"></span><dl class="confval">
<dt id="confval-snap_dir">
<code class="descname">snap_dir</code><a class="headerlink" href="#confval-snap_dir" title="Ссылка на это определение">¶</a></dt>
<dd><p>Директория для хранения статических снимков данных (.snap-файлов). Путь можно указывать относительно рабочей директории (<a class="reference internal" href="#cfg-basic-work-dir"><span class="std std-ref">work_dir</span></a>). Если этот параметр не задан, то по умолчанию используется рабочая директория (work_dir). См. также <a class="reference internal" href="#cfg-basic-wal-dir"><span class="std std-ref">wal_dir</span></a>.</p>
<p>Тип значения: string <br /> По умолчанию: &quot;.&quot; <br /> Динамический: нет <br /></p>
</dd></dl>

<span class="target" id="cfg-basic-vinyl-dir"></span><dl class="confval">
<dt id="confval-vinyl_dir">
<code class="descname">vinyl_dir</code><a class="headerlink" href="#confval-vinyl_dir" title="Ссылка на это определение">¶</a></dt>
<dd><p>Директория для хранения файлов и поддиректорий движка vinyl. Путь можно указывать относительно рабочей директории (<a class="reference internal" href="#cfg-basic-work-dir"><span class="std std-ref">work_dir</span></a>). Если этот параметр не задан, то по умолчанию используется рабочая директория (work_dir).</p>
<p>Тип значения: string <br /> По умолчанию: &quot;.&quot; <br /> Динамический: нет <br /></p>
</dd></dl>

<dl class="confval">
<dt id="confval-username">
<code class="descname">username</code><a class="headerlink" href="#confval-username" title="Ссылка на это определение">¶</a></dt>
<dd><p>UNIX-имя пользователя, на которое нужно переключиться после запуска.</p>
<p>Тип значения: string <br /> По умолчанию: null <br /> Динамический: нет <br /></p>
</dd></dl>

<span class="target" id="cfg-basic-wal-dir"></span><dl class="confval">
<dt id="confval-wal_dir">
<code class="descname">wal_dir</code><a class="headerlink" href="#confval-wal_dir" title="Ссылка на это определение">¶</a></dt>
<dd><p>Директория для хранения журналов упреждающей записи (.xlog-файлов). Путь можно указывать относительно рабочей директории (<a class="reference internal" href="#cfg-basic-work-dir"><span class="std std-ref">work_dir</span></a>). Иногда используют разные пути к wal_dir и <a class="reference internal" href="#cfg-basic-snap-dir"><span class="std std-ref">snap_dir</span></a>,  чтобы .xlog-файлы и .snap-файлы можно было хранить на разных дисках. Если этот параметр не задан, то по умолчанию используется рабочая директория (work_dir).</p>
<p>Тип значения: string <br /> По умолчанию: &quot;.&quot; <br /> Динамический: нет <br /></p>
</dd></dl>

<span class="target" id="cfg-basic-work-dir"></span><dl class="confval">
<dt id="confval-work_dir">
<code class="descname">work_dir</code><a class="headerlink" href="#confval-work_dir" title="Ссылка на это определение">¶</a></dt>
<dd><p>Директория для хранения рабочих файлов базы данных. После запуска сервер переключается на work_dir с помощью <em class="manpage">chdir(2)</em>. Путь можно указывать относительно текущей директории. Если этот параметр не задан, то по умолчанию используется текущая директория. Относительно work_dir можно указывать другие параметры. Например, если задать <br /> <span class="ccode">box.cfg{work_dir='/home/user/A',wal_dir='B',snap_dir='C'}</span> <br /> то .xlog-файлы будут храниться в директории /home/user/A/B, .snap-файлы — в директории /home/user/A/C, а все прочие файлы и поддиректории — в рабочей директории /home/user/A.</p>
<p>Тип значения: string <br /> По умолчанию: null <br /> Динамический: нет <br /></p>
</dd></dl>

</div>
<div class="section" id="configuring-the-storage">
<h5><a class="toc-backref" href="#id6">5.4.2. Настройка хранилища данных</a><a class="headerlink" href="#configuring-the-storage" title="Ссылка на этот заголовок">¶</a></h5>
<span class="target" id="cfg-storage-slab-alloc-arena"></span><dl class="confval">
<dt id="confval-slab_alloc_arena">
<code class="descname">slab_alloc_arena</code><a class="headerlink" href="#confval-slab_alloc_arena" title="Ссылка на это определение">¶</a></dt>
<dd><p>Объем памяти (в гигабайтах), который Tarantool выделяет для хранения кортежей. Когда этот объем памяти оказывается занят, Tarantool-сервер начинает выдавать ошибку <code class="xref std std-errcode docutils literal"><span class="pre">ER_MEMORY_ISSUE</span></code> на запросы INSERT и UPDATE. Данное ограничение относится только к хранению кортежей: для хранения индексов и информации об установленных соединениях Tarantool-сервер использует дополнительную память. Таким образом, в зависимости от конкретной конфигурации и нагрузки, фактическое превышение расхода памяти у Tarantool-сервера может составлять до 20% от указанного здесь значения.</p>
<p>Тип значения: float <br /> По умолчанию: 1.0 <br /> Динамический: нет <br /></p>
</dd></dl>

<span class="target" id="cfg-storage-slab-alloc-factor"></span><dl class="confval">
<dt id="confval-slab_alloc_factor">
<code class="descname">slab_alloc_factor</code><a class="headerlink" href="#confval-slab_alloc_factor" title="Ссылка на это определение">¶</a></dt>
<dd><p>Данный параметр используется в качестве множителя при вычислении размера фрагментов памяти, выделяемых для хранения кортежей. В некоторых случаях (в зависимости от общего объема памяти и разброса по размеру кортежей) вы можете снизить объем выделенной памяти, задав меньшее значение множителя.</p>
<p>Тип значения: float <br /> По умолчанию: 1.1 <br /> Динамический: нет <br /></p>
</dd></dl>

<span class="target" id="cfg-storage-slab-alloc-maximal"></span><dl class="confval">
<dt id="confval-slab_alloc_maximal">
<code class="descname">slab_alloc_maximal</code><a class="headerlink" href="#confval-slab_alloc_maximal" title="Ссылка на это определение">¶</a></dt>
<dd><p>Максимально возможный размер фрагмента памяти, выделяемого для одного кортежа. Можно задать больший размер, если необходимо хранить кортежи большого размера.</p>
<p>Тип значения: integer <br /> По умолчанию: 1048576 <br /> Динамический: нет <br /></p>
</dd></dl>

<span class="target" id="cfg-storage-slab-alloc-minimal"></span><dl class="confval">
<dt id="confval-slab_alloc_minimal">
<code class="descname">slab_alloc_minimal</code><a class="headerlink" href="#confval-slab_alloc_minimal" title="Ссылка на это определение">¶</a></dt>
<dd><p>Минимально возможный размер фрагмента памяти, выделяемого для одного кортежа. Можно задать меньший размер, если большинство кортежей в базе имеют очень маленький размер. Значение может лежать в интервале от 8 до 1048280 включительно.</p>
<p>Тип значения: integer <br /> По умолчанию: 16 <br /> Динамический: нет <br /></p>
</dd></dl>

<span class="target" id="cfg-storage-vinyl"></span><dl class="confval">
<dt id="confval-vinyl">
<code class="descname">vinyl</code><a class="headerlink" href="#confval-vinyl" title="Ссылка на это определение">¶</a></dt>
<dd><p>Пользовательские значения параметров для движка vinyl можно задать с помощью запроса следующего вида:</p>
<pre class="highlight literal-block">
vinyl = {
  run_age_wm = <em>number</em>,
  run_age_period = <em>number of seconds</em>,
  memory_limit = <em>number of gigabytes</em>,
  compact_wm = <em>number</em>,
  threads = <em>number</em>,
  run_age = <em>number</em>,
  run_prio = <em>number</em>,
}
</pre>
<p>В будущем этот способ может быть пересмотрен.</p>
<p>Значения по умолчанию:</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="n">vinyl</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">run_age_wm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">run_age_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">memory_limit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">compact_wm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
  <span class="n">threads</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
  <span class="n">run_age</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">run_prio</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="snapshot-daemon">
<span id="book-cfg-snapshot-daemon"></span><h5><a class="toc-backref" href="#id7">5.4.3. Фоновая программа для работы со снимками</a><a class="headerlink" href="#snapshot-daemon" title="Ссылка на этот заголовок">¶</a></h5>
<blockquote>
<div><p>Фоновая программа для работы со снимками (snapshot daemon) — это постоянно запущенный файбер. Он может срабатывать через заданные промежутки времени, создавая новые файлы-снимки (.snap-файлы) и удаляя старые. При удалении файла-снимка удаляются также все WAL-файлы (.xlog), которые старше удаленного файла-снимка и содержат информацию, которая была в удаленном снимке.</p>
<p>Параметры <a class="reference internal" href="#cfg-snapshot-daemon-snapshot-period"><span class="std std-ref">snapshot_period</span></a> и <a class="reference internal" href="#cfg-snapshot-daemon-snapshot-count"><span class="std std-ref">snapshot_count</span></a> указывают длину интервалов для срабатывания фоновой программы и количество сделанных файлов-снимков, после которого можно удалять самый старый снимок.</p>
</div></blockquote>
<span class="target" id="cfg-snapshot-daemon-snapshot-period"></span><dl class="confval">
<dt id="confval-snapshot_period">
<code class="descname">snapshot_period</code><a class="headerlink" href="#confval-snapshot_period" title="Ссылка на это определение">¶</a></dt>
<dd><p>Интервал (в секундах) между срабатываниями фоновой программы. Если значение <code class="docutils literal"><span class="pre">snapshot_period</span></code> больше нуля, а также имели место какие-либо изменения в базе, то фоновая программа будет каждые <code class="docutils literal"><span class="pre">snapshot_period</span></code> секунд вызывать метод <a class="reference internal" href="singlehtml.html#admin-snapshot"><span class="std std-ref">box.snapshot</span></a>, и при каждом таком вызове будет создаваться новый снимок.</p>
<p>Например, в результате запроса <code class="docutils literal"><span class="pre">box.cfg{snapshot_period=3600}</span></code> фоновая программа будет раз в час создавать новый снимок.</p>
<p>Тип значения: integer <br /> По умолчанию: 0 <br /> Динамический: да <br /></p>
</dd></dl>

<span class="target" id="cfg-snapshot-daemon-snapshot-count"></span><dl class="confval">
<dt id="confval-snapshot_count">
<code class="descname">snapshot_count</code><a class="headerlink" href="#confval-snapshot_count" title="Ссылка на это определение">¶</a></dt>
<dd><p>Максимальное количество снимков в директории <cite>snap_dir</cite>, после которого фоновая программа может удалять самые старые снимки. Если значение <cite>snapshot_count</cite> равно нулю, то фоновая программа не занимается удалением старых снимков. Например, в результате следующего запроса:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span>
    <span class="n">snapshot_period</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">,</span>
    <span class="n">snapshot_count</span>  <span class="o">=</span> <span class="mi">10</span>
<span class="p">}</span>
</pre></div>
</div>
<p>фоновая программа будет раз в час создавать новый снимок до тех пор, пока не создаст 10 снимков. После создания 11-го снимка фоновая программа удалит самый старый снимок и все связанные с ним WAL-файлы.</p>
<p>Тип значения: integer <br /> По умолчанию: 6 <br /> Динамический: да <br /></p>
</dd></dl>

</div>
<div class="section" id="binary-logging-and-snapshots">
<h5><a class="toc-backref" href="#id8">5.4.4. Журналирование и снимки в бинарном формате</a><a class="headerlink" href="#binary-logging-and-snapshots" title="Ссылка на этот заголовок">¶</a></h5>
<blockquote>
<div><a class="reference internal" href="#cfg-binary-logging-snapshots-panic-on-snap-error"><span class="std std-ref">panic_on_snap_error</span></a>, <br />
<a class="reference internal" href="#cfg-binary-logging-snapshots-panic-on-wal-error"><span class="std std-ref">panic_on_wal_error</span></a>, <br />
<a class="reference internal" href="#cfg-binary-logging-snapshots-rows-per-wal"><span class="std std-ref">rows_per_wal</span></a>, <br />
<a class="reference internal" href="#cfg-binary-logging-snapshots-snap-io-rate-limit"><span class="std std-ref">snap_io_rate_limit</span></a>, <br />
<a class="reference internal" href="#cfg-binary-logging-snapshots-wal-mode"><span class="std std-ref">wal_mode</span></a>, <br />
<a class="reference internal" href="#cfg-binary-logging-snapshots-wal-dir-rescan-delay"><span class="std std-ref">wal_dir_rescan_delay</span></a> <br /></div></blockquote>
<span class="target" id="cfg-binary-logging-snapshots-panic-on-snap-error"></span><dl class="confval">
<dt id="confval-panic_on_snap_error">
<code class="descname">panic_on_snap_error</code><a class="headerlink" href="#confval-panic_on_snap_error" title="Ссылка на это определение">¶</a></dt>
<dd><p>Прервать исполнение, если при чтении файла-снимка возникает ошибка (на этапе запуска Tarantool-сервера).</p>
<p>Тип значения: boolean <br /> По умолчанию: true <br /> Динамический: нет <br /></p>
</dd></dl>

<span class="target" id="cfg-binary-logging-snapshots-panic-on-wal-error"></span><dl class="confval">
<dt id="confval-panic_on_wal_error">
<code class="descname">panic_on_wal_error</code><a class="headerlink" href="#confval-panic_on_wal_error" title="Ссылка на это определение">¶</a></dt>
<dd><p>Прервать исполнение, если при чтении WAL-файла возникает ошибка (на этапе запуска Tarantool-сервера, либо на этапе первого запроса данных со стороны реплики).</p>
<p>Тип значения: boolean <br /> По умолчанию: true <br /> Динамический: да <br /></p>
</dd></dl>

<span class="target" id="cfg-binary-logging-snapshots-rows-per-wal"></span><dl class="confval">
<dt id="confval-rows_per_wal">
<code class="descname">rows_per_wal</code><a class="headerlink" href="#confval-rows_per_wal" title="Ссылка на это определение">¶</a></dt>
<dd><p>Максимальное количество записей, которые можно хранить в одном WAL-файле. Когда это ограничение достигнуто, то Tarantool создает новый WAL-файл и называет его по LSN-номеру первой записи в новом файле (<code class="samp docutils literal"><em><span class="pre">&lt;lsn-номер-первой-записи&gt;</span></em><span class="pre">.xlog</span></code>). Это может пригодиться при простой организации создания резервных копий с помощью rsync.</p>
<p>Тип значения: integer <br /> По умолчанию: 500000 <br /> Динамический: нет <br /></p>
</dd></dl>

<span class="target" id="cfg-binary-logging-snapshots-snap-io-rate-limit"></span><dl class="confval">
<dt id="confval-snap_io_rate_limit">
<code class="descname">snap_io_rate_limit</code><a class="headerlink" href="#confval-snap_io_rate_limit" title="Ссылка на это определение">¶</a></dt>
<dd><p>Уменьшить падение производительности на запросах INSERT/UPDATE/DELETE во время отработки <a class="reference internal" href="singlehtml.html#admin-snapshot"><span class="std std-ref">box.snapshot</span></a> с помощью ограничения на максимальное количество мегабайт, которое может записываться на диск в секунду. С той же целью можно развести директории <a class="reference internal" href="#cfg-basic-wal-dir"><span class="std std-ref">wal_dir</span></a> и <a class="reference internal" href="#cfg-basic-snap-dir"><span class="std std-ref">snap_dir</span></a> по разным адресам и сохранять снимки на другом диске.</p>
<p>Тип значения: float <br /> По умолчанию: null <br /> Динамический: <strong>да</strong> <br /></p>
</dd></dl>

<span class="target" id="cfg-binary-logging-snapshots-wal-mode"></span><dl class="confval">
<dt id="confval-wal_mode">
<code class="descname">wal_mode</code><a class="headerlink" href="#confval-wal_mode" title="Ссылка на это определение">¶</a></dt>
<dd><p>Задать режим синхронизации между файберами, WAL-файлом и диском:</p>
<ul class="simple">
<li><p class="first"><code class="docutils literal"><span class="pre">none</span></code>: запись в WAL-файл не ведется;</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">write</span></code>: файберы ждут, пока их данные будут записаны в WAL-файл (без <em class="manpage">fsync(2)</em>);</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">fsync</span></code>: файберы ожидают свои данные, <em class="manpage">fsync(2)</em> происходит после каждого вызова <em class="manpage">write(2)</em>;</p>
</li>
</ul>
<p>Тип значения: string <br /> По умолчанию: &quot;write&quot; <br /> Динамический: <strong>да</strong> <br /></p>
</dd></dl>

<span class="target" id="cfg-binary-logging-snapshots-wal-dir-rescan-delay"></span><dl class="confval">
<dt id="confval-wal_dir_rescan_delay">
<code class="descname">wal_dir_rescan_delay</code><a class="headerlink" href="#confval-wal_dir_rescan_delay" title="Ссылка на это определение">¶</a></dt>
<dd><p>Количество секунд между периодическим сканированием директории с WAL-файлами на предмет наличия изменений в WAL-файлах, которые следует синхронизировать в рамках репликации или режима горячей готовности.</p>
<p>Тип значения: float <br /> По умолчанию: 2 <br /> Динамический: нет <br /></p>
</dd></dl>

</div>
<div class="section" id="replication">
<h5><a class="toc-backref" href="#id9">5.4.5. Репликация</a><a class="headerlink" href="#replication" title="Ссылка на этот заголовок">¶</a></h5>
<span class="target" id="cfg-replication-replication-source"></span><dl class="confval">
<dt id="confval-replication_source">
<code class="descname">replication_source</code><a class="headerlink" href="#confval-replication_source" title="Ссылка на это определение">¶</a></dt>
<dd><p>Источник репликации. Если в параметре <cite>replication_source</cite> указана не пустая строка, то такой Tarantool-сервер считается <a class="reference internal" href="singlehtml.html#index-box-replication"><span class="std std-ref">репликой</span></a>. Сервер-реплика будет пытаться установить соединение с главным сервером, чей адрес указан в параметре <cite>replication_source</cite> в виде <a class="reference internal" href="#index-uri"><span class="std std-ref">URI</span></a> (Universal Resource Identifier), например <code class="samp docutils literal"><em><span class="pre">konstantin</span></em><span class="pre">:</span><em><span class="pre">secret_password</span></em><span class="pre">&#64;</span><em><span class="pre">tarantool.org</span></em><span class="pre">:</span><em><span class="pre">3301</span></em></code>.</p>
<p>Если в кластере более одного источника репликации, то следует указать массив из URI, например <br /> <code class="samp docutils literal"><span class="pre">box.cfg{replication_source</span> <span class="pre">=</span> <span class="pre">{</span></code><span class="ccodei">uri#1,uri#2</span><span class="ccode">}}</span> <br /></p>
<p>Если один из URI соответствует текущем серверу — т.е. тому, на котором сейчас выполняется запрос <cite>box.cfg{}</cite>, — то такой источник игнорируется. Таким образом, можно использовать одни и те же значения <cite>replication_source</cite> на многих серверах.</p>
<p>Имя пользователя по умолчанию — ‘guest’. Сервер-реплика не принимает запросы на изменение данных на порту для прослушивания (параметр <a class="reference internal" href="#cfg-basic-listen"><span class="std std-ref">listen</span></a>). Параметр <cite>replication_source</cite> является динамическим: чтобы перевести реплику в режим главного сервера, нужно только задать пустую строку в <cite>replication_source</cite> и выполнить запрос <code class="code docutils literal"><span class="pre">box.cfg{replication_source=</span></code><code class="samp docutils literal"><em><span class="pre">new-value</span></em></code><code class="code docutils literal"><span class="pre">}</span></code>.</p>
<p>Тип значения: string <br /> По умолчанию: null <br /> Динамический: <strong>yes</strong> <br /></p>
</dd></dl>

</div>
<div class="section" id="networking">
<h5><a class="toc-backref" href="#id10">5.4.6. Работа с сетевыми соединениями</a><a class="headerlink" href="#networking" title="Ссылка на этот заголовок">¶</a></h5>
<blockquote>
<div><a class="reference internal" href="#cfg-networking-io-collect-interval"><span class="std std-ref">io_collect_interval</span></a>, <br />
<a class="reference internal" href="#cfg-networking-readahead"><span class="std std-ref">readahead</span></a>  <br /></div></blockquote>
<span class="target" id="cfg-networking-io-collect-interval"></span><dl class="confval">
<dt id="confval-io_collect_interval">
<code class="descname">io_collect_interval</code><a class="headerlink" href="#confval-io_collect_interval" title="Ссылка на это определение">¶</a></dt>
<dd><p>Между итерациями основного цикла Tarantool-сервер уходит в спящий режим на <cite>io_collect_interval</cite> секунд. Этот параметр можно использовать для ограничения нагрузки на процессор в том случае, когда количество клиентских соединений очень велико, но запросы от них приходят нечасто (например, от каждого соединения приходит всего несколько запросов в секунду).</p>
<p>Тип значения: float <br /> По умолчанию: null <br /> Динамический: <strong>да</strong> <br /></p>
</dd></dl>

<span class="target" id="cfg-networking-readahead"></span><dl class="confval">
<dt id="confval-readahead">
<code class="descname">readahead</code><a class="headerlink" href="#confval-readahead" title="Ссылка на это определение">¶</a></dt>
<dd><p>Размер буфера предварительного чтения на каждое клиентское соединение. Чем больше размер буфера, тем больше памяти будет потреблять каждое активное соединение и тем больше запросов можно будет зачитать из системного буфера за один системный вызов. Общее правило для определения оптимального размера буфера таково: буфер должен вмещать по крайней мере несколько десятков запросов. Поэтому, если средний размер кортежа в запросе у вас большой, например несколько кило- или даже мегабайт, то размер буфера предварительного чтения следует увеличить. Если вы не используете пакетную обработку запросов, то лучше оставить размер буфера по умолчанию.</p>
<p>Тип значения: integer <br /> По умолчанию: 16320 <br /> Динамический: <strong>да</strong> <br /></p>
</dd></dl>

</div>
<div class="section" id="logging">
<h5><a class="toc-backref" href="#id11">5.4.7. Запись в журнал</a><a class="headerlink" href="#logging" title="Ссылка на этот заголовок">¶</a></h5>
<span class="target" id="cfg-logging-log-level"></span><dl class="confval">
<dt id="confval-log_level">
<code class="descname">log_level</code><a class="headerlink" href="#confval-log_level" title="Ссылка на это определение">¶</a></dt>
<dd><p>Уровень детализации при записи в журнал. Всего есть шесть уровней:</p>
<ul class="simple">
<li>1 – <code class="docutils literal"><span class="pre">SYSERROR</span></code></li>
<li>2 – <code class="docutils literal"><span class="pre">ERROR</span></code></li>
<li>3 – <code class="docutils literal"><span class="pre">CRITICAL</span></code></li>
<li>4 – <code class="docutils literal"><span class="pre">WARNING</span></code></li>
<li>5 – <code class="docutils literal"><span class="pre">INFO</span></code></li>
<li>6 – <code class="docutils literal"><span class="pre">DEBUG</span></code></li>
</ul>
<p>С помощью настройки уровня детализации можно включать журналирование всех классов событий выше или ниже указанного уровня. По умолчанию Tarantool выводит свой журнал в стандартный поток ошибок (<code class="docutils literal"><span class="pre">stderr</span></code>), но вывод ошибок можно настроить с помощью параметра <a class="reference internal" href="#cfg-logging-logger"><span class="std std-ref">logger</span></a>.</p>
<p>Тип значения: integer <br /> По умолчанию: 5 <br /> Динамический: <strong>да</strong> <br /></p>
</dd></dl>

<span class="target" id="cfg-logging-logger"></span><dl class="confval">
<dt id="confval-logger">
<code class="descname">logger</code><a class="headerlink" href="#confval-logger" title="Ссылка на это определение">¶</a></dt>
<dd><p>По умолчанию Tarantool выводит свой журнал в стандартный поток ошибок ( <code class="docutils literal"><span class="pre">stderr</span></code>). С помощью данного параметра вывод ошибок можно перенастроить на вывод в файл, в программный канал (pipe) или в системный регистратор (system logger).</p>
<p>Пример настроек:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">tarantool.log&#39;</span><span class="p">}</span>
<span class="c1">-- or</span>
<span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">file: tarantool.log&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>В результате в Tarantool-директории, используемой по умолчанию, будет открыт на запись файл <code class="docutils literal"><span class="pre">tarantool.log</span></code>. Если префикс в значении параметра <code class="docutils literal"><span class="pre">logger</span></code> не указан или же указан префикс &quot;file:&quot;, то дальнейшая строка интерпретируется как путь к файлу.</p>
<p>Пример настроек:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">| cronolog tarantool.log&#39;</span><span class="p">}</span>
<span class="c1">-- или</span>
<span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">pipe: cronolog tarantool.log&#39;</span><span class="p">}</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>В результате при запуске Tarantool-сервера будет также запущена программа <code class="docutils literal"><span class="pre">cronolog</span></code>, и все сообщения для журнала буду пересылаться на стандартный ввод (<code class="docutils literal"><span class="pre">stdin</span></code>) программы  <code class="docutils literal"><span class="pre">cronolog</span></code>. Если значение параметра <code class="docutils literal"><span class="pre">logger</span></code> начинается с символа '|' или с префикса &quot;pipe:&quot;, то дальнейшая строка интерпретируется как <a class="reference external" href="https://en.wikipedia.org/wiki/Pipeline_%28Unix%29">Unix-конвейер</a>.</p>
<p>Пример настроек:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">syslog:identity=tarantool&#39;</span><span class="p">}</span>
<span class="c1">-- или</span>
<span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">syslog:facility=user&#39;</span><span class="p">}</span>
<span class="c1">-- или</span>
<span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">syslog:identity=tarantool,facility=user&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>Если значение параметра <code class="docutils literal"><span class="pre">logger</span></code> начинается с префикса &quot;syslog:&quot;, то дальнейшая строка интерпретируется как сообщение для программы <a class="reference external" href="http://www.rfc-base.org/txt/rfc-5424.txt">syslogd</a>, которая обычно запущена в фоновом режиме на любой Unix-платформе. В этой строке можно задать значения <code class="docutils literal"><span class="pre">identity</span></code>, <code class="docutils literal"><span class="pre">facility</span></code> или оба эти значения сразу. В качестве <code class="docutils literal"><span class="pre">identity</span></code> может быть задана любая строка (значение по умолчанию — <code class="docutils literal"><span class="pre">tarantool</span></code>), которая будет использоваться как префикс перед всеми сообщениями в журнале. В качестве <code class="docutils literal"><span class="pre">facility</span></code> задается аббревиатура имени одного из типов ПО в программе <a class="reference external" href="https://en.wikipedia.org/wiki/Syslog">syslog</a> (значение по умолчанию — <code class="docutils literal"><span class="pre">user</span></code>), которая указывает программе <code class="docutils literal"><span class="pre">syslogd</span></code>, куда/кому передавать сообщения.</p>
<p>Возможные значения <code class="docutils literal"><span class="pre">facility</span></code>: auth, authpriv, cron, daemon, ftp, kern, lpr, mail, news, security, syslog, user, uucp, local0, local1, local2, local3, local4, local5, local6, local7.</p>
<p>На данный момент значение``facility`` игнорируется, но в будущем оно будет использоваться.</p>
<p>При записи сообщений в файл Tarantool переоткрывает файл с журналом на каждый SIGHUP. Если журнал является программой, то ее pid-идентификатор сохраняется в переменной <a class="reference internal" href="singlehtml.html#log-logger-pid"><span class="std std-ref">log.logger_pid</span></a>. Для ротации журнала нужно послать сигнал программе с этим pid-идентификатором.</p>
<p>Тип значения: string <br /> По умолчанию: null <br /> Динамический: нет <br /></p>
</dd></dl>

<span class="target" id="cfg-logging-logger-nonblock"></span><dl class="confval">
<dt id="confval-logger_nonblock">
<code class="descname">logger_nonblock</code><a class="headerlink" href="#confval-logger_nonblock" title="Ссылка на это определение">¶</a></dt>
<dd><p>Если в значении параметра <code class="docutils literal"><span class="pre">logger_nonblock</span></code> указано true, то Tarantool не блокирует файл с журналом на запись, и если очередь на запись в ядре оказывается переполнена, то последующие сообщения от Tarantool'а не попадают в очередь и теряются, пока очередь не очистится. Если в параметре <a class="reference internal" href="#cfg-logging-log-level"><span class="std std-ref">log_level</span></a> указан высокий уровень детализации и Tarantool отправляет в очередь на запись много сообщений для журнала, то можно увеличить скорость записи в журнал, выставив значение параметра <code class="docutils literal"><span class="pre">logger_nonblock</span></code> в <cite>true</cite> и пожертвовав некоторым количеством сообщений, которые при этом могут быть потеряны.</p>
<p>Тип значения: boolean <br /> По умолчанию: true <br /> Динамический: нет <br /></p>
</dd></dl>

<span class="target" id="cfg-logging-too-long-threshold"></span><dl class="confval">
<dt id="confval-too_long_threshold">
<code class="descname">too_long_threshold</code><a class="headerlink" href="#confval-too_long_threshold" title="Ссылка на это определение">¶</a></dt>
<dd><p>Если обработка запроса занимает больше времени, чем указано в этом параметре (в секундах), то в журнал добавляется предупредительная запись. Это происходит, только если уровень детализации, указанный в параметре <a class="reference internal" href="#cfg-logging-log-level"><span class="std std-ref">log_level</span></a>, выше или равен 4 (WARNING).</p>
<p>Тип значения: float <br /> По умолчанию: 0.5 <br /> Динамический: <strong>да</strong> <br /></p>
</dd></dl>

<p id="cfg-logging-logging-example"><strong>Пример работы с журналом:</strong></p>
<p>В этом примере мы покажем, как работает ротация журнала, т.е. что происходит, когда настроена запись в журнал и используются сигналы для архивирования записей.</p>
<p>Запустите два отдельных терминала, Terminal #1 и Terminal #2.</p>
<p>В первом терминале (Terminal #1): запустим интерактивную Tarantool-сессию, настроим запись сообщений в журнал <cite>Log_file</cite>, а затем запишем в журнал сообщение &quot;Log Line #1&quot;:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">logger</span><span class="o">=</span><span class="s1">&#39;</span><span class="s">Log_file&#39;</span><span class="p">}</span>
<span class="n">log</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">log&#39;</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Log Line #1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Во втором терминале (Terminal #2): с помощью команды <code class="docutils literal"><span class="pre">mv</span></code> переименуем файл журнала в <cite>Log_file.bak</cite>. В результате следующее сообщение будет записано уже в файл <cite>Log_file.bak</cite>. <br /></p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="n">mv</span> <span class="n">Log_file</span> <span class="n">Log_file</span><span class="o">.</span><span class="n">bak</span>
</pre></div>
</div>
<p>В первом терминале (Terminal #1): запишем в журнал сообщение &quot;Log Line #2&quot;. <br /></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Log Line #2&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Во втором терминале (Terminal #2): с помощью команды <code class="docutils literal"><span class="pre">ps</span></code> выясним идентификатор процесса Tarantool-сервера.</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="n">ps</span> <span class="o">-</span><span class="n">A</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">tarantool</span>
</pre></div>
</div>
<p>Во втором терминале (Terminal #2): с помощью команды <code class="docutils literal"><span class="pre">kill</span> <span class="pre">-HUP</span></code> пошлем Tarantool-серверу SIGHUP-сигнал.</p>
<pre class="highlight literal-block">
kill -HUP <em>process_id</em>
</pre>
<p>В первом терминале (Terminal #1): запишем в журнал сообщение &quot;Log Line #3&quot;.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Log Line #3&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Во втором терминале (Terminal #2): с помощью команды <code class="docutils literal"><span class="pre">less</span></code> просмотрим содержимое файлов. Для файла <cite>Log_file.bak</cite> будут выведены следующие строки (если вы выполняете этот пример у себя, то отличаться должны только дата и время):</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span> <span class="mi">15</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mf">06.373</span> <span class="p">[</span><span class="mi">27469</span><span class="p">]</span> <span class="n">main</span><span class="o">/</span><span class="mi">101</span><span class="o">/</span><span class="n">interactive</span> <span class="n">I</span><span class="o">&gt;</span> <span class="n">Log</span> <span class="n">Line</span> <span class="c1">#1`</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span> <span class="mi">15</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mf">25.973</span> <span class="p">[</span><span class="mi">27469</span><span class="p">]</span> <span class="n">main</span><span class="o">/</span><span class="mi">101</span><span class="o">/</span><span class="n">interactive</span> <span class="n">I</span><span class="o">&gt;</span> <span class="n">Log</span> <span class="n">Line</span> <span class="c1">#2`</span>
</pre></div>
</div>
<p>а для журнала <cite>Log_file</cite> вывод будет следующим:</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="n">log</span> <span class="n">file</span> <span class="n">has</span> <span class="n">been</span> <span class="n">reopened</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">30</span> <span class="mi">15</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mf">32.629</span> <span class="p">[</span><span class="mi">27469</span><span class="p">]</span> <span class="n">main</span><span class="o">/</span><span class="mi">101</span><span class="o">/</span><span class="n">interactive</span> <span class="n">I</span><span class="o">&gt;</span> <span class="n">Log</span> <span class="n">Line</span> <span class="c1">#3</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="local-hot-standby">
<span id="book-cfg-local-hot-standby"></span><h4><a class="toc-backref" href="#id12">5.5. Режим горячего резервирования</a><a class="headerlink" href="#local-hot-standby" title="Ссылка на этот заголовок">¶</a></h4>
<p>Режим горячего резервирования позволяет организовать восстановление после сбоя простым образом, без настройки репликации. Для этого запустите на том же компьютере второй экземпляр Tarantool-сервера с теми же настройками <a class="reference internal" href="singlehtml.html#box-introspection-box-cfg"><span class="std std-ref">box.cfg</span></a>, включая директории и не нулевые URI-адреса. В случае успеха должно появиться предупреждение:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>W&gt; primary: [URI] is already in use, will retry binding after [n] seconds
</pre></div>
</div>
<p>Это означает, что второй экземпляр готов заменить первый, если тот выйдет из строя.</p>
<p>Режим горячего резервирования подразумевает, что на одном компьютере запущены два экземпляра Tarantool-сервера с одинаковой конфигурацией. Первый запущенный экземпляр является &quot;главным&quot; (primary), а второй — &quot;резервным&quot; (standby). Резервный экземпляр при запуске попытается установить соединение на порту для прослушивания, но у него не получится это сделать, поскольку адрес уже занят главным экземпляром. Таким образом, резервный экземпляр повторяет в цикле следующие действия: зачитывает данные из WAL-файла, который обновляется главным экземпляром (и благодаря этому оба экземпляра всегда синхронизированы между собой) и пытается установить соединение на порту для прослушивания. Если по какой-либо причине главный сервер выходит из строя, то порт для прослушивания освобождается, резервный экземпляр устанавливает на нем соединение и становится главным. Таким образом, время недоступности в случае сбоя оказывается почти незаметным.</p>
<p>При использовании горячего резервирования (значение параметра <code class="docutils literal"><span class="pre">local_hot_standby</span></code> равно &quot;true&quot;) значение параметра <code class="docutils literal"><span class="pre">wal_mode</span></code> не должно быть равно &quot;none&quot;.</p>
</div>
</div>
<span id="document-book/administration"></span><div class="section" id="server-administration">
<h3>6. Администрирование серверной части<a class="headerlink" href="#server-administration" title="Ссылка на этот заголовок">¶</a></h3>
<p>Типичные задачи администрирования серверной части включают в себя запуск и остановку сервера, перезагрузку настроек, создание снимков, ротацию логов.</p>
<div class="section" id="server-signal-handling">
<h4>6.1. Обработка сигналов от сервера<a class="headerlink" href="#server-signal-handling" title="Ссылка на этот заголовок">¶</a></h4>
<p>Во время основного цикла Tarantool-сервер обрабатывает следующие сигналы:</p>
<dl class="glossary docutils">
<dt id="term-sighup">SIGHUP</dt>
<dd><p class="first last">может привести к ротации лога, см. <a class="reference internal" href="singlehtml.html#cfg-logging-logging-example"><span class="std std-ref">пример в разделе &quot;Запись в журнал&quot;</span></a>.</p>
</dd>
<dt id="term-sigusr1">SIGUSR1</dt>
<dd><p class="first last">может привести к сохранению снимка, см. описание функции <a class="reference internal" href="singlehtml.html#admin-snapshot"><span class="std std-ref">box.snapshot</span></a>.</p>
</dd>
<dt id="term-sigterm">SIGTERM</dt>
<dd><p class="first last">может привести к корректному завершению работы (с предварительным сохранением всех данных).</p>
</dd>
<dt id="term-sigint">SIGINT</dt>
<dd><p class="first last">(или &quot;прерывание с клавиатуры&quot;) может привести к корректному завершению работы (с предварительным сохранением всех данных).</p>
</dd>
<dt id="term-sigkill">SIGKILL</dt>
<dd><p class="first last">приводит к аварийному завершению работы (с возможной потерей данных).</p>
</dd>
</dl>
<p>Действие других сигналов определяется операционной системой. Все сигналы, кроме SIGKILL, могут быть проигнорированы, особенно если Tarantool-сервер выполняет длительную процедуру, которая позволяет вернуться к главному циклу.</p>
</div>
<div class="section" id="process-title">
<span id="administration-proctitle"></span><h4>6.2. Название процесса<a class="headerlink" href="#process-title" title="Ссылка на этот заголовок">¶</a></h4>
<p>Операционные системы Linux и FreeBSD позволяют запущенному процессу менять его название (title), в котором изначально содержится имя программы (name). Tarantool использует эту возможность, чтобы упростить работу системного администратора, например посмотреть, какие службы запущены на хосте, их статус и т.д.</p>
<p>Название процесса Tarantool-сервера состоит из следующих частей:</p>
<p><code class="extsamp docutils literal"><strong><span class="pre">имя_программы</span></strong> <span class="pre">[</span><strong><span class="pre">имя_файла_инициализации</span></strong><span class="pre">]</span> <strong><span class="pre">&lt;имя_роли&gt;</span></strong> <span class="pre">[</span><strong><span class="pre">название_процесса</span></strong><span class="pre">]</span></code></p>
<ul class="simple">
<li><p class="first"><strong>имя_программы</strong> — это, как правило, &quot;tarantool&quot;.</p>
</li>
<li><p class="first"><strong>имя_файла_инициализации</strong> — это имя  <a class="reference internal" href="singlehtml.html#index-init-label"><span class="std std-ref">файла инициализации на Lua</span></a>, если этот файл был указан при запуске.</p>
</li>
<li><p class="first"><strong>имя_роли</strong> — это может быть один из следующих вариантов:</p>
<ul>
<li><p class="first">&quot;running&quot; (узел находится в режиме &quot;готов к принятию запросов&quot;),</p>
</li>
<li><p class="first">&quot;loading&quot; (узел, который загружает данные из ранее сохраненного снимка и WAL-файла),</p>
</li>
<li><p class="first">&quot;orphan&quot; (узел не входит в состав кластера),</p>
</li>
<li><p class="first">&quot;hot_standby&quot; (см. раздел про <a class="reference internal" href="singlehtml.html#book-cfg-local-hot-standby"><span class="std std-ref">режим горячего резервирования (local hot standby)</span></a>), либо</p>
</li>
<li><p class="first">&quot;dumper&quot; + process-id (идет сохранение снимка).</p>
</li>
</ul>
</li>
<li><p class="first"><strong>название_процесса</strong> — это необязательное название Tarantool-процесса в системе, которое берется из конфигурационного параметра <a class="reference internal" href="singlehtml.html#cfg-basic-custom-proc-title"><span class="std std-ref">custom_proc_title</span></a>, если он указан.</p>
</li>
</ul>
<p>Например:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ps -AF <span class="p">|</span> grep tarantool
<span class="go">1000     17337 16716  1 91362  6916   0 11:07 pts/5    00:00:13 tarantool script.lua &lt;running&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="using-tarantool-as-a-client">
<span id="administration-using-tarantool-as-a-client"></span><h4>6.3. Использование tarantool в качестве клиента<a class="headerlink" href="#using-tarantool-as-a-client" title="Ссылка на этот заголовок">¶</a></h4>
<p>Если <strong class="program">tarantool</strong> запущен без <a class="reference internal" href="singlehtml.html#index-init-label"><span class="std std-ref">файла инициализации</span></a>, или же в файле инициализации указана функция <a class="reference internal" href="singlehtml.html#console-start"><span class="std std-ref">console.start()</span></a>, то <strong class="program">tarantool</strong> стартует в интерактивном режиме: он выводит приглашение командной строки (&quot;<code class="docutils literal"><span class="pre">tarantool&gt;</span></code>&quot;), и запросы можно вводить прямо в консоли. В таком режиме <strong class="program">tarantool</strong> можно использовать в качестве клиента для удаленного сервера.</p>
<p>В этом разделе описаны синтаксические правила для ввода запросов в консоли Tarantool'а, с примечаниями и примерами. Другие клиентские программы могут иметь схожие параметры и синтаксис запросов. Некоторые сведения из этого раздела дублируются в главе <a class="reference internal" href="singlehtml.html#index-book-cfg"><span class="std std-ref">Справочник по конфигурированию</span></a>.</p>
<div class="section" id="conventions-used-in-this-section">
<h5>6.3.1. Условные обозначения, используемые в этом разделе<a class="headerlink" href="#conventions-used-in-this-section" title="Ссылка на этот заголовок">¶</a></h5>
<p>Токены — это последовательности символов, которые рассматриваются как синтаксические единицы в рамках запроса. Квадратные скобки [ и ] используются для обозначения необязательных токенов. Три точки в строке ... означают, что предыдущие токены могут повторяться. Вертикальная черта | означает, что предыдущие и последующие токены являются взаимоисключающими альтернативами.</p>
</div>
<div class="section" id="options-when-starting-client-from-the-command-line">
<h5>6.3.2. Параметры запуска клиента из командной строки<a class="headerlink" href="#options-when-starting-client-from-the-command-line" title="Ссылка на этот заголовок">¶</a></h5>
<p>Общий вид:</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span>$ tarantool
ИЛИ
$ tarantool опции
ИЛИ
$ tarantool файл-инициализации-на-lua [ аргументы ]
</pre></div>
</div>
<p><em>файл-инициализации-на-lua</em> — это любой скрипт, содержащий логику инициализации. Код из этого файла выполняется при запуске Tarantool'а.  Например: <code class="samp docutils literal"><span class="pre">init.lua</span></code>. <br /> Примечания: При использовании скрипта, Tarantool не выводит приглашение командной строки. Скрипт должен содержать конфигурационные настройки, в т.ч. <code class="samp docutils literal"><span class="pre">box.cfg</span><em><span class="pre">...listen=...</span></em></code> или <code class="samp docutils literal"><span class="pre">box.listen(...)</span></code>, чтобы внешние программы могли установить соединение с Tarantool-сервером на одном из указанных портов.</p>
<p><em>Опция</em> — это одно из следующих значений (указаны в алфавитном порядке, по полному имени опции):</p>
<dl class="option">
<dt id="cmdoption-tarantool-?">
<span id="cmdoption-tarantool-h"></span><span id="cmdoption-tarantool--help"></span><code class="descname">-?</code><code class="descclassname"></code><code class="descclassname">, </code><code class="descname">-h</code><code class="descclassname"></code><code class="descclassname">, </code><code class="descname">--help</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-tarantool-?" title="Ссылка на это определение">¶</a></dt>
<dd><p>Tarantool-клиент выводит краткую справку, включая список всех параметров. Например: <code class="samp docutils literal"><span class="pre">tarantool</span> <span class="pre">--help</span></code>. Вывод останавливается после показа справки.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-tarantool-V">
<span id="cmdoption-tarantool--version"></span><code class="descname">-V</code><code class="descclassname"></code><code class="descclassname">, </code><code class="descname">--version</code><code class="descclassname"></code><a class="headerlink" href="#cmdoption-tarantool-V" title="Ссылка на это определение">¶</a></dt>
<dd><p>Tarantool-клиент выводит свой номер версии. Например: <code class="samp docutils literal"><span class="pre">tarantool</span> <span class="pre">--version</span></code>. Вывод останавливается после показа номера версии.</p>
</dd></dl>

</div>
<div class="section" id="tokens-requests-and-special-key-combinations">
<h5>6.3.3. Токены, запросы и специальные комбинации клавиш<a class="headerlink" href="#tokens-requests-and-special-key-combinations" title="Ссылка на этот заголовок">¶</a></h5>
<p>Идентификатором процедуры может быть любая последовательность букв, цифр и/или подчеркиваний, которая отвечает правилам именования идентификаторов в Lua. Термин &quot;идентификаторы процедур&quot; также применяют к именам функций. <br /> Примечание: в случае с именами функций регистр имеет значение, поэтому <code class="docutils literal"><span class="pre">insert</span></code> и <code class="docutils literal"><span class="pre">Insert</span></code> — это не одно и то же.</p>
<p>Строковым литералом может быть любая последовательность из нуля и более символов, которая заключена в <em>одинарные кавычки</em>. <em>Двойные кавычки</em> также допустимы, но предпочтительным вариантом являются одинарные кавычки. А <em>двойные квадратные скобки</em> нужны для многострочных литералов (см. <a class="reference external" href="http://www.lua.org/pil/2.4.html">документацию по языку Lua</a>). <br /> Например: 'Hello, world', 'A', [[A\B!]].</p>
<p>Числовым литералом может быть любая последовательность символов, состоящая из одной и более цифр с необязательным знаком + или - в начале. В состав больших числовых литералов, а также числовых литералов с плавающей точкой может входить десятичный разделитель (запятая или точка), символы для экспоненциального представления и суффиксы. <br /> Например: 500, -500, 5e2, 500.1, 5LL, 5ULL.</p>
<p>Однобайтовым символом может быть запятая, открывающая или закрывающая круглая скобка, а также арифметический оператор. <br /> Например: * , ( ).</p>
<p>Токены должны разделяться одним или бОльшим количеством пробелов. Исключением являются однобайтовые токены и строковые литералы — вокруг них пробелы не нужны.</p>
</div>
<div class="section" id="requests">
<span id="administration-setting-delimiter"></span><h5>6.3.4. Запросы<a class="headerlink" href="#requests" title="Ссылка на этот заголовок">¶</a></h5>
<p>Запросы вводятся после приглашения командной строки, когда Tarantool работает в интерактивном режиме. (Приглашение — это слово tarantool и знак &quot;больше&quot;, вот так: <code class="samp docutils literal"><span class="pre">tarantool&gt;</span></code>). Маркером конца запроса по умолчанию является перевод строки.</p>
<p>Для ввода многострочных запросов можно задать другой маркер конца запроса. Для этого введите команду следующего вида: <code class="samp docutils literal"><span class="pre">console</span> <span class="pre">=</span> <span class="pre">require('console');</span> <span class="pre">console.delimiter(</span><em><span class="pre">новый-маркер</span></em><span class="pre">)</span></code>. В качестве нового маркера укажите строковый литерал в одинарных кавычках. После этого вам нужно будет вводить указанный маркер в конце каждого запроса, потому что Tarantool перестанет интерпретировать перевод строки как конец запроса. Чтобы вернуться к обычному режиму, введите: <code class="samp docutils literal"><span class="pre">console.delimiter('')</span><em><span class="pre">string-literal</span></em></code>. Как правило, задавать свой маркер нет необходимости, поскольку Tarantool сам распознает, что запрос введен не полностью (скажем, когда Tarantool не встречает слова <code class="samp docutils literal"><span class="pre">end</span></code> в объявлении функции). Например:</p>
<div class="highlight-lua_tarantool"><div class="highlight"><pre><span></span><span class="n">console</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">console&#39;</span><span class="p">);</span> <span class="n">console</span><span class="p">.</span><span class="n">delimiter</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">!&#39;</span><span class="p">)</span>
<span class="k">function</span> <span class="nf">f</span> <span class="p">()</span>
  <span class="n">statement_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">a&#39;</span>
  <span class="n">statement_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">b&#39;</span>
<span class="k">end</span><span class="p">!</span>
<span class="n">console</span><span class="p">.</span><span class="n">delimiter</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">&#39;</span><span class="p">)!</span>
</pre></div>
</div>
<p>См. также <a class="reference internal" href="singlehtml.html#box-protocol-iproto-protocol"><span class="std std-ref">описание формата клиентских запросов</span></a> в виде аннотированных BNF-диаграмм (Backus-Naur Form).</p>
<p>Работая в  <em>интерактивном</em> режиме, Tarantool-сервер принимает введенные запросы и выводит результаты. Запросы, как правило, вводит пользователь. Вот пример интерактивной пользовательской сессии:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">$</span> tarantool
<span class="go">[ здесь tarantool выводит приветствие и номер версии ]</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span> <span class="o">=</span> <span class="mi">3301</span><span class="p">}</span>
<span class="go">[ здесь tarantool выводит свои текущие настройки ]</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="go">[ здесь tarantool может вывести сообщение о том,</span>
<span class="go">  что идет обработка запроса ]</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">s</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">hash&#39;</span><span class="p">,</span> <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">My first tuple&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;My</span><span class="nv"> </span><span class="s">first</span><span class="nv"> </span><span class="s">tuple&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;My</span><span class="nv"> </span><span class="s">first</span><span class="nv"> </span><span class="s">tuple&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">drop</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="nb">os.exit</span><span class="p">()</span>
<span class="go">2014-04-30 10:28:00.886 [20436] main/101/spawner I&gt; Exiting: master shutdown</span>
<span class="go">$</span>
</pre></div>
</div>
<p>Пояснения к приведенному выше примеру:</p>
<ul class="simple">
<li><p class="first">На многие запросы Tarantool возвращает типизированные объекты. В ответ на запрос <code class="samp docutils literal"><span class="pre">box.cfg</span><em><span class="pre">listen=3301</span></em></code> Tarantool выведет результат на экран. Если в запросе задано, что его результат должен быть записан в некоторую переменную, например <code class="samp docutils literal"><span class="pre">c</span> <span class="pre">=</span> <span class="pre">box.cfg</span><em><span class="pre">listen=3301</span></em></code>, то в таком случае вывода результата на экран не происходит.</p>
</li>
<li><p class="first">Вывод объекта в Tarantool'е всегда начинается со строки &quot;<code class="docutils literal"><span class="pre">---</span></code>&quot; и заканчивается строкой &quot;<code class="docutils literal"><span class="pre">...</span></code>&quot;.</p>
</li>
<li><p class="first">По запросу на вставку данных возвращается объект типа кортеж (tuple), и в этом случае перед выводом будет стоять одиночное тире ('<code class="docutils literal"><span class="pre">-</span></code>'). А по запросу на выборку данных возвращается объект типа таблица кортежей (table of tuples), и в этом случае перед выводом будут стоять два тире ('<code class="docutils literal"><span class="pre">-</span> <span class="pre">-</span></code>').</p>
</li>
</ul>
</div>
</div>
<div class="section" id="utility-tarantoolctl">
<span id="administration-tarantoolctl"></span><h4>6.4. Утилита tarantoolctl<a class="headerlink" href="#utility-tarantoolctl" title="Ссылка на этот заголовок">¶</a></h4>
<p>С помощью программы <strong class="program">tarantoolctl</strong> вы можете задать буквально следующее: &quot;с помощью стандартных системных механизмов запустить экземпляр Tarantool-сервера, который должен исполнить такую-то пользовательскую программу на Lua, выделив для нее пространство на диске&quot;. Если Tarantool установлен из пакета для Debian или Red Hat, то путь к скрипту <strong class="program">tarantoolctl</strong> будет <code class="file docutils literal"><span class="pre">/usr/bin/tarantoolctl</span></code> или <code class="file docutils literal"><span class="pre">/usr/local/bin/tarantoolctl</span></code>. Этот скрипт решает задачи запуска, остановки, ротации журналов, авторизации в консоли и проверки статуса.</p>
<p>Об использовании <strong class="program">tarantoolctl</strong> в качестве клиента читайте далее в разделе <a class="reference internal" href="#administration-tarantoolctl-connect"><span class="std std-ref">Утилита tarantoolctl connect</span></a>.</p>
<div class="section" id="configuration-for-tarantoolctl">
<h5>6.4.1. Конфигурирование tarantoolctl<a class="headerlink" href="#configuration-for-tarantoolctl" title="Ссылка на этот заголовок">¶</a></h5>
<p>Скрипт <strong class="program">tarantoolctl</strong> сначала проверяет наличие файла конфигурации в текущей директории (<code class="file docutils literal"><span class="pre">$PWD/.tarantoolctl</span></code>). Если не находит, то проверяет домашнюю директорию текущего пользователя (<code class="file docutils literal"><span class="pre">$HOME/.config/tarantool/tarantool</span></code>). Если опять не находит, то проверяет директорию, указанную в переменной SYSCONFDIR (обычно это <code class="file docutils literal"><span class="pre">/etc/sysconfig/tarantool</span></code>, но на разных платформах этот путь может различаться). Большинство параметров <strong class="program">tarantoolctl</strong> аналогичны тем, что задаются в запросе <code class="samp docutils literal"><span class="pre">box.cfg</span><em><span class="pre">...</span></em></code>; однако <strong class="program">tarantoolctl</strong> меняет значение некоторых параметров, дописывая к ним имя приложения. Далее приводится копия файла <code class="file docutils literal"><span class="pre">usr/local/etc/default/tarantool</span></code>, где для всех параметров указаны их значения по умолчанию:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">default_cfg</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">pid_file</span>   <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/var/run/tarantool&quot;</span><span class="p">,</span>
    <span class="n">wal_dir</span>    <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/var/lib/tarantool&quot;</span><span class="p">,</span>
    <span class="n">snap_dir</span>   <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/var/lib/tarantool&quot;</span><span class="p">,</span>
    <span class="n">vinyl_dir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/var/lib/tarantool&quot;</span><span class="p">,</span>
    <span class="n">logger</span>     <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/var/log/tarantool&quot;</span><span class="p">,</span>
    <span class="n">username</span>   <span class="o">=</span> <span class="s2">&quot;</span><span class="s">tarantool&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">instance_dir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/etc/tarantool/instances.enabled&quot;</span>
</pre></div>
</div>
<p>Комментарии к параметрам в приведенном выше скрипте:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">pid_file</span></code></dt>
<dd><p class="first last">Директория, где хранятся pid-файл и socket-файл. Скрипт <strong class="program">tarantoolctl</strong> добавляет &quot;<code class="samp docutils literal"><span class="pre">/</span><em><span class="pre">instance-name</span></em></code>&quot; к имени директории.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">wal_dir</span></code></dt>
<dd><p class="first last">Директория, где хранятся <code class="file docutils literal"><span class="pre">*.xlog</span></code>-файлы. Скрипт <strong class="program">tarantoolctl</strong> добавляет &quot;<code class="samp docutils literal"><span class="pre">/</span><em><span class="pre">instance-name</span></em></code>&quot; к имени директории.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">snap_dir</span></code></dt>
<dd><p class="first last">Директория, где хранятся <code class="file docutils literal"><span class="pre">*.snap</span></code>-файлы. Скрипт <strong class="program">tarantoolctl</strong> добавляет &quot;<code class="samp docutils literal"><span class="pre">/</span><em><span class="pre">instance-name</span></em></code>&quot; к имени директории.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">vinyl_dir</span></code></dt>
<dd><p class="first last">Директория, где хранятся файлы движка vinyl. Скрипт <strong class="program">tarantoolctl</strong> добавляет &quot;<code class="samp docutils literal"><span class="pre">/</span><em><span class="pre">instance-name</span></em></code>&quot; к имени директории.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">logger</span></code></dt>
<dd><p class="first last">Директория, где хранятся файлы журнала с сообщениями от Tarantool-приложений. Скрипт <strong class="program">tarantoolctl</strong> добавляет &quot;<code class="samp docutils literal"><span class="pre">/</span><em><span class="pre">instance-name</span></em></code>&quot; к имени директории.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">username</span></code></dt>
<dd><p class="first last">Имя пользователя, из-под которого запущен Tarantool-сервер. Это имя пользователя в операционной системе, а не в Tarantool-клиенте.</p>
</dd>
<dt><code class="docutils literal"><span class="pre">instance_dir</span></code></dt>
<dd><p class="first last">Имя директории, где хранятся исходные файлы всех Tarantool-приложений для данного хоста. Пользователю, который пишет приложение для <strong class="program">tarantoolctl</strong>, нужно положить исходный код своего приложения в эту директорию или настроить симлинк. Далее для примеров в этом разделе мы используем Tarantool-приложение с именем <code class="docutils literal"><span class="pre">my_app</span></code>, и его исходный код должен лежать в файле <code class="samp docutils literal"><em><span class="pre">instance_dir</span></em><span class="pre">/my_app.lua</span></code>.</p>
</dd>
</dl>
</div>
<div class="section" id="commands-for-tarantoolctl">
<h5>6.4.2. Команды для tarantoolctl<a class="headerlink" href="#commands-for-tarantoolctl" title="Ссылка на этот заголовок">¶</a></h5>
<p>Команды для <strong class="program">tarantoolctl</strong> имеют вид <code class="samp docutils literal"><span class="pre">tarantoolctl</span> <em><span class="pre">операция</span></em> <em><span class="pre">имя_приложения</span></em></code>. В качестве <em>операции</em> можно указать одно из следующих значений: start, stop, enter, logrotate, status, eval.</p>
<dl class="option">
<dt id="cmdoption-tarantoolctl-arg-start">
<code class="descname">start</code><code class="descclassname"> &lt;application&gt;</code><a class="headerlink" href="#cmdoption-tarantoolctl-arg-start" title="Ссылка на это определение">¶</a></dt>
<dd><p>Запустить приложение с именем <em>&lt;application&gt;</em></p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-tarantoolctl-arg-stop">
<code class="descname">stop</code><code class="descclassname"> &lt;application&gt;</code><a class="headerlink" href="#cmdoption-tarantoolctl-arg-stop" title="Ссылка на это определение">¶</a></dt>
<dd><p>Остановить приложение</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-tarantoolctl-arg-enter">
<code class="descname">enter</code><code class="descclassname"> &lt;application&gt;</code><a class="headerlink" href="#cmdoption-tarantoolctl-arg-enter" title="Ссылка на это определение">¶</a></dt>
<dd><p>Вывести консоль для управления приложением</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-tarantoolctl-arg-logrotate">
<code class="descname">logrotate</code><code class="descclassname"> &lt;application&gt;</code><a class="headerlink" href="#cmdoption-tarantoolctl-arg-logrotate" title="Ссылка на это определение">¶</a></dt>
<dd><p>Произвести ротацию журналов указанного приложения (создать новые, удалить старые)</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-tarantoolctl-arg-status">
<code class="descname">status</code><code class="descclassname"> &lt;application&gt;</code><a class="headerlink" href="#cmdoption-tarantoolctl-arg-status" title="Ссылка на это определение">¶</a></dt>
<dd><p>Проверить статус приложения</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-tarantoolctl-arg-eval">
<code class="descname">eval</code><code class="descclassname"> &lt;application&gt; &lt;scriptname&gt;</code><a class="headerlink" href="#cmdoption-tarantoolctl-arg-eval" title="Ссылка на это определение">¶</a></dt>
<dd><p>Выполнить код из файла <em>&lt;scriptname&gt;</em> от имени запущенного экземпляра приложения <em>&lt;application&gt;</em></p>
</dd></dl>

</div>
<div class="section" id="typical-code-snippets-for-tarantoolctl">
<h5>6.4.3. Примеры кода для tarantoolctl<a class="headerlink" href="#typical-code-snippets-for-tarantoolctl" title="Ссылка на этот заголовок">¶</a></h5>
<p>Проверить, запущено ли приложение <code class="docutils literal"><span class="pre">my_app</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="k">if</span> tarantoolctl status my_app<span class="p">;</span> <span class="k">then</span>
...
<span class="k">fi</span>
</pre></div>
</div>
<p>Выполнить инструкции из файла <code class="file docutils literal"><span class="pre">init.d</span></code> во время запуска приложения:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="o">(</span>каждый файл в директории instance_dir<span class="o">)</span>:
    tarantoolctl start <span class="sb">`</span>basename $ file .lua<span class="sb">`</span>
</pre></div>
</div>
<p>Указать файл конфигурации для ротации журнала, например:</p>
<pre class="highlight literal-block">
/path/to/tarantool/*.log {
    daily
    size 512k
    missingok
    rotate 10
    compress
    delaycompress
    create 0640 tarantool adm
    postrotate
        /path/to/tarantoolctl logrotate <cite>basename $ 1 .log</cite>
    endscript
}
</pre>
</div>
<div class="section" id="a-detailed-example-for-tarantoolctl">
<h5>6.4.4. Подробный пример для tarantoolctl<a class="headerlink" href="#a-detailed-example-for-tarantoolctl" title="Ссылка на этот заголовок">¶</a></h5>
<p>В этом примере мы создадим временную директорию, в которой <strong class="program">tarantoolctl</strong> сможет запускать и мониторить некое долго работающее приложение.</p>
<p>Итак, наши исходные условия: нам известен пароль root-пользователя; компьютер используется только для тестирования; Tarantool-сервер настроен и готов к запуску, но пока еще не запущен ;программа <strong class="program">tarantoolctl</strong> установлена в пользовательском окружении; пока не существует директории с именем <code class="file docutils literal"><span class="pre">tarantool_test</span></code>.</p>
<p>Создадим директорию с именем <code class="file docutils literal"><span class="pre">/tarantool_test</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> sudo mkdir /tarantool_test
</pre></div>
</div>
<p>Отредактируем файл <code class="file docutils literal"><span class="pre">/usr/local/etc/default/tarantool</span></code>. Для этого нам сначала может понадобиться выполнить команду <code class="samp docutils literal"><span class="pre">sudo</span> <span class="pre">mkdir</span> <span class="pre">/usr/local/etc/default</span></code>. Указанный файл будет содержать следующие настройки:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">default_cfg</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">pid_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/tarantool_test/my_app.pid&quot;</span><span class="p">,</span>
    <span class="n">wal_dir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/tarantool_test&quot;</span><span class="p">,</span>
    <span class="n">snap_dir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/tarantool_test&quot;</span><span class="p">,</span>
    <span class="n">vinyl_dir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/tarantool_test&quot;</span><span class="p">,</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/tarantool_test/log&quot;</span><span class="p">,</span>
    <span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">tarantool&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">instance_dir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">/tarantool_test&quot;</span>
</pre></div>
</div>
<p>Создадим файл <code class="file docutils literal"><span class="pre">/tarantool_test/my_app.lua</span></code> для приложения <code class="docutils literal"><span class="pre">my_app</span></code>:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span> <span class="o">=</span> <span class="mi">3301</span><span class="p">}</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">passwd</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Gx5!&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">guest&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">read,write,execute&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">universe&#39;</span><span class="p">)</span>
<span class="n">fiber</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fiber&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,{})</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">do</span>
    <span class="n">fiber</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">insert &#39;</span> <span class="o">..</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">my_app tuple&#39;</span><span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>
<p>С помощью <strong class="program">tarantoolctl</strong> запустим наше приложение...</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> /tarantool_test
<span class="gp">$</span> sudo tarantoolctl start my_app
</pre></div>
</div>
<p>... и получим сообщения о том, что экземпляр нашего приложения запущен. Затем скажем:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ls -l /tarantool_test/my_app
</pre></div>
</div>
<p>... и увидим <code class="file docutils literal"><span class="pre">.snap</span></code>-файл и <code class="file docutils literal"><span class="pre">.xlog</span></code>-файл. Затем скажем:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> sudo less /tarantool_test/log/my_app.log
</pre></div>
</div>
<p>... и увидим содержимое файла журнала для приложения <code class="docutils literal"><span class="pre">my_app</span></code>, в т.ч. сообщения об ошибках, если они были. Затем скажем:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> /tarantool_test
<span class="gp">$</span> <span class="c1"># допустим, что &#39;tarantool&#39; запускает Tarantool-сервер</span>
<span class="gp">$</span> sudo tarantool
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{}</span>
<span class="gp">tarantool&gt; </span><span class="n">console</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">console&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">console</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">localhost:3301&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">GE&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>... и увидим те несколько кортежей, которые создало приложение <code class="docutils literal"><span class="pre">my_app</span></code>.</p>
<p>Всё. Теперь остановим приложение <code class="docutils literal"><span class="pre">my_app</span></code>. Единственный корректный способ — это использовать <strong class="program">tarantoolctl</strong>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> sudo tarantoolctl stop my_app
</pre></div>
</div>
<p>Почистим систему после тестирования. Приведем содержимое файла <code class="file docutils literal"><span class="pre">/usr/local/etc/default/tarantool</span></code> к исходному виду и удалим нашу тестовую директорию:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> /
<span class="gp">$</span> sudo rm -R tarantool_test
</pre></div>
</div>
</div>
</div>
<div class="section" id="utility-tarantoolctl-connect">
<span id="administration-tarantoolctl-connect"></span><h4>6.5. Утилита tarantoolctl connect<a class="headerlink" href="#utility-tarantoolctl-connect" title="Ссылка на этот заголовок">¶</a></h4>
<p>Утилита <strong class="program">tarantoolctl connect</strong> является клиентской программой. Вы можете использовать ее, чтобы устанавливать соединение с Tarantool-сервером и передавать запросы.</p>
<p>Для запуска этой утилиты введите:</p>
<pre class="highlight literal-block">
tarantoolctl connect <em>URI</em>
</pre>
<p>Формат URI описан <a class="reference internal" href="singlehtml.html#index-uri"><span class="std std-ref">тут</span></a>.</p>
<p>Например:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> tarantoolctl connect username:password@127.0.0.1:3306
</pre></div>
</div>
<p>Вместо <strong class="program">tarantoolctl connect</strong> вы можете использовать модули <a class="reference internal" href="singlehtml.html#console-module"><span class="std std-ref">console</span></a> или <a class="reference internal" href="singlehtml.html#net-box-module"><span class="std std-ref">net.box</span></a> из библиотеки Tarantool'а. Еще одна альтернатива — это написать клиентскую программу под любой из существующих Tarantool-коннекторов. Но для большинства примеров в текущей документации мы используем <strong class="program">tarantoolctl connect</strong> или <a class="reference internal" href="#administration-using-tarantool-as-a-client"><span class="std std-ref">Tarantool-сервер в качестве клиента</span></a>.</p>
<p>Всё, что написано о поведении <a class="reference internal" href="singlehtml.html#console-connect"><span class="std std-ref">console.connect()</span></a>, в большинстве случаев верно и для <strong class="program">tarantoolctl connect</strong>. Например, <a class="reference internal" href="singlehtml.html#triggers-authentication-triggers"><span class="std std-ref">триггер аутентификации</span></a> активируется при каждом запуске и завершении программы <strong class="program">tarantoolctl connect</strong>.</p>
</div>
<div class="section" id="admin-ports">
<span id="administration-admin-ports"></span><h4>6.6. Порты для администрирования<a class="headerlink" href="#admin-ports" title="Ссылка на этот заголовок">¶</a></h4>
<p>Термины &quot;порт для администрирования&quot;, &quot;консоль для администрирования&quot;, &quot;текстовый протокол&quot; относятся к установке соединения с помощью <a class="reference internal" href="singlehtml.html#console-listen"><span class="std std-ref">console.listen(...)</span></a> для ввода запросов от администраторов.</p>
<p>Термины &quot;бинарный порт&quot;, &quot;бинарный протокол&quot;, &quot;первичный порт&quot; относятся к другому виду соединения — тому, что устанавливается с помощью параметра <a class="reference internal" href="singlehtml.html#cfg-basic-listen"><span class="std std-ref">box.cfg{listen=...}</span></a> и предназначено для ввода запросов от любых пользователей.</p>
<p>Для обычных соединений с Tarantool-сервером должен использоваться бинарный протокол. А порты для администрирования нужны для особых случаев, когда повышены требования к безопасности.</p>
<p>При установке соединение через порт для администрирования:</p>
<ul class="simple">
<li><p class="first">Пароль не требуется</p>
</li>
<li><p class="first">Пользователь автоматически получает привилегии администратора.</p>
</li>
</ul>
<p>Поэтому порты для администрирования следует настраивать очень осторожно. Если это TCP-порт, то он должен быть открыть только для определенного IP-адреса. В идеале мы рекомендуем вовсе не использовать TCP-порты. Вместо них лучше настроить доменный Unix-сокет, который требует настройки прав доступа к серверной машине. Тогда типичная настройка порта для администрирования будет выглядеть следующим образом:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">console.listen(&#39;/var/lib/tarantool/socket_name.sock&#39;)</span>
</pre></div>
</div>
<p>а типичный <a class="reference internal" href="singlehtml.html#index-uri"><span class="std std-ref">URI</span></a> для соединения будет таким:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>admin:any_string@/var/lib/tarantool/socket_name.sock
</pre></div>
</div>
<p>Это в том случае, если у сервера (listener'а) есть привилегии на запись в файл <code class="file docutils literal"><span class="pre">/var/lib/tarantool</span></code>, а на стороне клиента (connector'а) есть привилегии на чтение из того же файла. Аналогично можно установить соединение и задать настройки с помощью <a class="reference internal" href="#administration-tarantoolctl"><span class="std std-ref">tarantoolctl</span></a>.</p>
<p>Если не задан пароль администратора, который можно сообщить пользователям, а порты для администрирования настроены с ограничением доступа по IP либо через сокеты, то запросы, требующие привилегий администратора, можно делать только локально, где вопросы безопасности и мониторинга регулируются с помощью средств Unix-системы.</p>
<p>В целях дополнительной безопасности некоторые запросы на портах для администрирования запрещены. Например, <a class="reference internal" href="singlehtml.html#net-box-eval"><span class="std std-ref">conn:eval</span></a> вернет сообщение об ошибке <code class="docutils literal"><span class="pre">-</span> <span class="pre">error:</span> <span class="pre">console</span> <span class="pre">does</span> <span class="pre">not</span> <span class="pre">support</span> <span class="pre">this</span> <span class="pre">request</span> <span class="pre">type</span></code>, поскольку запрос <code class="docutils literal"><span class="pre">conn:eval</span></code> должен осуществляться в рамках бинарного протокола.</p>
<p>Если вопросы безопасности на портах для администрирования неактуальны, то стать пользователем с правами администратора можно, <a class="reference internal" href="#administration-using-tarantool-as-a-client"><span class="std std-ref">используя Tarantool-сервер в качестве клиента</span></a> или указав администраторский пароль при установке соединения по бинарному протоколу.</p>
<p>Выяснить, является ли некий TCP-порт портом для администрирования, можно с помощью <strong class="program">telnet</strong>. Например:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> telnet <span class="m">0</span> 3303
<span class="go">Trying 0.0.0.0...</span>
<span class="go">Connected to 0.</span>
<span class="go">Escape character is &#39;^]&#39;.</span>
<span class="go">Tarantool 1.7.1-70-gbc479ad (Lua console)</span>
<span class="go">type &#39;help&#39; for interactive help</span>
</pre></div>
</div>
<p>В этом примере в ответе от сервера нет слова &quot;binary&quot; и есть слова &quot;Lua console&quot;. Это значит, что мы установили соединение на порту для администрирования и можем вводить администраторские запросы на этом терминале.</p>
</div>
<div class="section" id="system-specific-administration-notes">
<h4>6.7. Заметки по администрированию для разных платформ<a class="headerlink" href="#system-specific-administration-notes" title="Ссылка на этот заголовок">¶</a></h4>
<p>В этом разделе приводится информация по проблемам и особенностям, которые относятся только к конкретным платформам. Например, к определенным версиям Linux-систем.</p>
<div class="section" id="debian-gnu-linux-and-ubuntu">
<h5>6.7.1. Debian GNU/Linux and Ubuntu<a class="headerlink" href="#debian-gnu-linux-and-ubuntu" title="Ссылка на этот заголовок">¶</a></h5>
<p>Настройка конкретного экземпляра Tarantool-сервера:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> ln -s /etc/tarantool/instances.available/*instance-name.cfg* /etc/tarantool/instances.enabled/
</pre></div>
</div>
<p>Запуск всех экземпляров:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> service tarantool start
</pre></div>
</div>
<p>Остановка всех экземпляров:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> service tarantool stop
</pre></div>
</div>
<p>Запуск/остановка конкретного экземпляра:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> service tarantool-instance-name start/stop
</pre></div>
</div>
</div>
<div class="section" id="fedora-rhel-centos">
<h5>6.7.2. Fedora, RHEL, CentOS<a class="headerlink" href="#fedora-rhel-centos" title="Ссылка на этот заголовок">¶</a></h5>
<p>Известных воспроизводящихся дефектов для данных платформ нет. Если вы столкнулись с плавающим дефектом, посмотрите описания проблем на странице <a class="reference external" href="http://github.com/tarantool/tarantool/issues">http://github.com/tarantool/tarantool/issues</a>, введя в строке поиска слово &quot;RHEL&quot;, &quot;CentOS&quot;, &quot;Fedora&quot; или &quot;Red Hat&quot;.</p>
</div>
<div class="section" id="freebsd">
<h5>6.7.3. FreeBSD<a class="headerlink" href="#freebsd" title="Ссылка на этот заголовок">¶</a></h5>
<p>Известных воспроизводящихся дефектов для данной платформы нет. Если вы столкнулись с плавающим дефектом, посмотрите описания проблем на странице <a class="reference external" href="http://github.com/tarantool/tarantool/issues">http://github.com/tarantool/tarantool/issues</a>, введя в строке поиска слово &quot;FreeBSD&quot;.</p>
</div>
<div class="section" id="mac-os-x">
<h5>6.7.4. Mac OS X<a class="headerlink" href="#mac-os-x" title="Ссылка на этот заголовок">¶</a></h5>
<p>Известных воспроизводящихся дефектов для данных платформ нет. Если вы столкнулись с плавающим дефектом, посмотрите описания проблем на странице <a class="reference external" href="http://github.com/tarantool/tarantool/issues">http://github.com/tarantool/tarantool/issues</a>, введя в строке поиска слово &quot;OS X&quot;.</p>
</div>
</div>
<div class="section" id="notes-for-systemd-users">
<h4>6.8. Заметки для пользователей systemd<a class="headerlink" href="#notes-for-systemd-users" title="Ссылка на этот заголовок">¶</a></h4>
<p>Tarantool полностью поддерживает работу с <strong class="program">systemd</strong> как со средством для управления экземплярами и контроля за фоновыми программами базы данных.</p>
<div class="section" id="instance-management">
<h5>6.8.1. Управление экземплярами<a class="headerlink" href="#instance-management" title="Ссылка на этот заголовок">¶</a></h5>
<p>В архитектуре Tarantool'а заложена возможность запуска сразу многих экземпляров Tarantool-сервера на одной машине. С помощью <code class="samp docutils literal"><span class="pre">systemctl</span> <em><span class="pre">start|stop|restart|status</span></em> <span class="pre">tarantool&#64;$</span><em><span class="pre">MYAPP</span></em></code> можно управлять базами данных и Lua-приложениями.</p>
<div class="section" id="creating-instances">
<h6>6.8.1.1. Создание экземпляров<a class="headerlink" href="#creating-instances" title="Ссылка на этот заголовок">¶</a></h6>
<p>Задайте все настройки в виде Lua-скрипта и поместите их в файл <code class="file docutils literal"><span class="pre">/etc/tarantool/instances.available/$</span><em><span class="pre">MYAPP</span></em><span class="pre">.lua</span></code>:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span> <span class="o">=</span> <span class="mi">3313</span><span class="p">}</span>
<span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">myappcode&#39;</span><span class="p">).</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>(это пример минимально достаточной конфигурации).</p>
<p>Также вы можете посмотреть пример Lua-скрипт в файле <code class="file docutils literal"><span class="pre">example.lua</span></code>, который входит в состав дистрибутива Tarantool'а и содержит значения всех опций.</p>
</div>
<div class="section" id="starting-instances">
<h6>6.8.1.2. Запуск экземпляров<a class="headerlink" href="#starting-instances" title="Ссылка на этот заголовок">¶</a></h6>
<p>Для запуска экземпляра <code class="docutils literal"><span class="pre">${MYAPP}</span></code> выполните команду <code class="samp docutils literal"><span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">tarantool&#64;$</span><em><span class="pre">MYAPP</span></em></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> systemctl start tarantool@example
<span class="gp">$</span> ps axuf<span class="p">|</span>grep exampl<span class="o">[</span>e<span class="o">]</span>
<span class="go">taranto+  5350  1.3  0.3 1448872 7736 ?        Ssl  20:05   0:28 tarantool example.lua &lt;running&gt;</span>
</pre></div>
</div>
<p>(здесь и далее мы приводим примеры консольного вывода для Fedora).</p>
<p>Для автоматической загрузки экземпляра <code class="docutils literal"><span class="pre">${MYAPP}</span></code> во время запуска всей системы используйте команду <code class="samp docutils literal"><span class="pre">systemctl</span> <span class="pre">enable</span> <span class="pre">tarantool&#64;$</span><em><span class="pre">MYAPP</span></em></code>.</p>
</div>
<div class="section" id="monitoring-instances">
<h6>6.8.1.3. Мониторинг экземпляров<a class="headerlink" href="#monitoring-instances" title="Ссылка на этот заголовок">¶</a></h6>
<p>Для проверки информации об экземпляре <code class="docutils literal"><span class="pre">${MYAPP}</span></code> выполните команду <code class="samp docutils literal"><span class="pre">systemctl</span> <span class="pre">status</span> <span class="pre">tarantool&#64;$</span><em><span class="pre">MYAPP</span></em></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> systemctl status tarantool@example
<span class="go">tarantool@example.service - Tarantool Database Server</span>
<span class="go">Loaded: loaded (/etc/systemd/system/tarantool@.service; disabled; vendor preset: disabled)</span>
<span class="go">Active: active (running)</span>
<span class="go">Docs: man:tarantool(1)</span>
<span class="go">Process: 5346 ExecStart=/usr/bin/tarantoolctl start %I (code=exited, status=0/SUCCESS)</span>
<span class="go">Main PID: 5350 (tarantool)</span>
<span class="go">Tasks: 11 (limit: 512)</span>
<span class="go">CGroup: /system.slice/system-tarantool.slice/tarantool@example.service</span>
<span class="go">+ 5350 tarantool example.lua &lt;running&gt;</span>
</pre></div>
</div>
<p>Для проверки журнала загрузки выполните команду <code class="samp docutils literal"><span class="pre">journalctl</span> <span class="pre">-u</span> <span class="pre">tarantool&#64;$</span><em><span class="pre">MYAPP</span></em></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> journalctl -u tarantool@example -n 5
<span class="go">-- Logs begin at Fri 2016-01-08 12:21:53 MSK, end at Thu 2016-01-21 21:17:47 MSK. --</span>
<span class="go">Jan 21 21:17:47 localhost.localdomain systemd[1]: Stopped Tarantool Database Server.</span>
<span class="go">Jan 21 21:17:47 localhost.localdomain systemd[1]: Starting Tarantool Database Server...</span>
<span class="go">Jan 21 21:17:47 localhost.localdomain tarantoolctl[5969]: /usr/bin/tarantoolctl: Found example.lua in /etc/tarantool/instances.available</span>
<span class="go">Jan 21 21:17:47 localhost.localdomain tarantoolctl[5969]: /usr/bin/tarantoolctl: Starting instance...</span>
<span class="go">Jan 21 21:17:47 localhost.localdomain systemd[1]: Started Tarantool Database Server</span>
</pre></div>
</div>
</div>
<div class="section" id="attaching-to-instances">
<h6>6.8.1.4. Подсоединение к экземплярам<a class="headerlink" href="#attaching-to-instances" title="Ссылка на этот заголовок">¶</a></h6>
<p>Вы можете подсоединиться к запущенному экземпляру Tarantool-сервера и выполнить некий Lua-скрипт с помощью утилиты <strong class="program">tarantoolctl</strong>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> tarantoolctl enter example
<span class="go">/bin/tarantoolctl: Found example.lua in /etc/tarantool/instances.available</span>
<span class="go">/bin/tarantoolctl: Connecting to /var/run/tarantool/example.control</span>
<span class="go">/bin/tarantoolctl: connected to unix/:/var/run/tarantool/example.control</span>
<span class="go">unix/:/var/run/tarantool/example.control&gt; 1 + 1</span>
<span class="go">---</span>
<span class="go">- 2</span>
<span class="go">...</span>
<span class="go">unix/:/var/run/tarantool/example.control&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="checking-logs">
<h6>6.8.1.5. Проверка журнала<a class="headerlink" href="#checking-logs" title="Ссылка на этот заголовок">¶</a></h6>
<p>Tarantool ведет записи о важных событиях в файле <code class="file docutils literal"><span class="pre">/var/log/tarantool/$</span><em><span class="pre">MYAPP</span></em><span class="pre">.log</span></code>.</p>
<p>Давайте запишем что-нибудь в файл журнала:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> tarantoolctl enter example
<span class="go">/bin/tarantoolctl: Found example.lua in /etc/tarantool/instances.available</span>
<span class="go">/bin/tarantoolctl: Connecting to /var/run/tarantool/example.control</span>
<span class="go">/bin/tarantoolctl: connected to unix/:/var/run/tarantool/example.control</span>
<span class="go">unix/:/var/run/tarantool/example.control&gt; require(&#39;log&#39;).info(&quot;Hello for README.systemd readers&quot;)</span>
<span class="go">---</span>
<span class="go">...</span>
</pre></div>
</div>
<p>Затем проверим содержимое журнала:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> tail /var/log/tarantool/example.log
<span class="go">2016-01-21 21:09:45.982 [5914] iproto I&gt; binary: started</span>
<span class="go">2016-01-21 21:09:45.982 [5914] iproto I&gt; binary: bound to 0.0.0.0:3301</span>
<span class="go">2016-01-21 21:09:45.983 [5914] main/101/tarantoolctl I&gt; ready to accept requests</span>
<span class="go">2016-01-21 21:09:45.983 [5914] main/101/example I&gt; Run console at /var/run/tarantool/example.control</span>
<span class="go">2016-01-21 21:09:45.984 [5914] main/101/example I&gt; tcp_server: remove dead UNIX socket: /var/run/tarantool/example.control</span>
<span class="go">2016-01-21 21:09:45.984 [5914] main/104/console/unix/:/var/run/tarant I&gt; started</span>
<span class="go">2016-01-21 21:09:45.985 [5914] main C&gt; entering the event loop</span>
<span class="go">2016-01-21 21:14:43.320 [5914] main/105/console/unix/: I&gt; client unix/: connected</span>
<span class="go">2016-01-21 21:15:07.115 [5914] main/105/console/unix/: I&gt; Hello for README.systemd readers</span>
<span class="go">2016-01-21 21:15:09.250 [5914] main/105/console/unix/: I&gt; client unix/: disconnected</span>
</pre></div>
</div>
<p>Для ротации журнала нужно установить программу <strong class="program">logrotate</strong>. Настройки для ротации можно задать в файле <code class="file docutils literal"><span class="pre">/etc/logrotate.d/tarantool</span></code>.</p>
</div>
<div class="section" id="stopping-instances">
<h6>6.8.1.6. Остановка экземпляров<a class="headerlink" href="#stopping-instances" title="Ссылка на этот заголовок">¶</a></h6>
<p>Для просмотра информации о запущенном экземпляре <code class="docutils literal"><span class="pre">${MYAPP}</span></code> выполните команду <code class="samp docutils literal"><span class="pre">systemctl</span> <span class="pre">stop</span> <span class="pre">tarantool&#64;$</span><em><span class="pre">MYAPP</span></em></code>.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> systemctl stop tarantool@example
</pre></div>
</div>
</div>
</div>
<div class="section" id="daemon-supervision">
<h5>6.8.2. Контроль за фоновыми программами<a class="headerlink" href="#daemon-supervision" title="Ссылка на этот заголовок">¶</a></h5>
<p>Если какой-либо экземпляр Tarantool-сервера выходит из строя, <strong class="program">systemd</strong> автоматически перезапускает его.</p>
<p>Давайте попробуем вывести из строя один экземпляр:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> systemctl status tarantool@example<span class="p">|</span>grep PID
<span class="go">Main PID: 5885 (tarantool)</span>
<span class="gp">$</span> tarantoolctl enter example
<span class="go">/bin/tarantoolctl: Found example.lua in /etc/tarantool/instances.available</span>
<span class="go">/bin/tarantoolctl: Connecting to /var/run/tarantool/example.control</span>
<span class="go">/bin/tarantoolctl: connected to unix/:/var/run/tarantool/example.control</span>
<span class="go">unix/:/var/run/tarantool/example.control&gt; os.exit(-1)</span>
<span class="go">/bin/tarantoolctl: unix/:/var/run/tarantool/example.control: Remote host closed connection</span>
</pre></div>
</div>
<p>А теперь убедимся, что <strong class="program">systemd</strong> перезапустила его:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> systemctl status tarantool@example<span class="p">|</span>grep PID
<span class="go">Main PID: 5914 (tarantool)</span>
</pre></div>
</div>
<p>И под конец проверим содержимое журнала загрузки:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> journalctl -u tarantool@example -n 8
<span class="go">-- Logs begin at Fri 2016-01-08 12:21:53 MSK, end at Thu 2016-01-21 21:09:45 MSK. --</span>
<span class="go">Jan 21 21:09:45 localhost.localdomain systemd[1]: tarantool@example.service: Unit entered failed state.</span>
<span class="go">Jan 21 21:09:45 localhost.localdomain systemd[1]: tarantool@example.service: Failed with result &#39;exit-code&#39;.</span>
<span class="go">Jan 21 21:09:45 localhost.localdomain systemd[1]: tarantool@example.service: Service hold-off time over, scheduling restart.</span>
<span class="go">Jan 21 21:09:45 localhost.localdomain systemd[1]: Stopped Tarantool Database Server.</span>
<span class="go">Jan 21 21:09:45 localhost.localdomain systemd[1]: Starting Tarantool Database Server...</span>
<span class="go">Jan 21 21:09:45 localhost.localdomain tarantoolctl[5910]: /usr/bin/tarantoolctl: Found example.lua in /etc/tarantool/instances.available</span>
<span class="go">Jan 21 21:09:45 localhost.localdomain tarantoolctl[5910]: /usr/bin/tarantoolctl: Starting instance...</span>
<span class="go">Jan 21 21:09:45 localhost.localdomain systemd[1]: Started Tarantool Database Server.</span>
</pre></div>
</div>
</div>
<div class="section" id="customizing-the-service-file">
<h5>6.8.3. Правка настроек сервисного файла<a class="headerlink" href="#customizing-the-service-file" title="Ссылка на этот заголовок">¶</a></h5>
<p>Пожалуйста, не редактируйте файл <code class="file docutils literal"><span class="pre">tarantool&#64;.service</span></code> по месту, поскольку все ваши изменения будут перезаписаны при последующих обновлениях Tarantool'а. Мы рекомендуем скопировать этот файл в <code class="file docutils literal"><span class="pre">/etc/systemd/system</span></code> и править настройки уже в копии. Либо вы можете создать поддиректорию с именем <code class="file docutils literal"><span class="pre">unit.d/</span></code> в директории <code class="file docutils literal"><span class="pre">/etc/systemd/system</span></code> и положить туда drop-in файл с именем <code class="file docutils literal"><span class="pre">name.conf</span></code>, в котором будут указаны только те настройки, которые нужно поменять. См. подробности в <code class="docutils literal"><span class="pre">systemd.unit(5)</span></code>.</p>
</div>
<div class="section" id="debugging">
<h5>6.8.4. Отладка<a class="headerlink" href="#debugging" title="Ссылка на этот заголовок">¶</a></h5>
<p>При аварийном завершении Tarantool-сервера, <strong class="program">coredumpctl</strong> автоматически сохраняет дампы памяти (core dumps) и трассировку стека (stack traces). Вот как работает этот механизм:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="c1"># !!! ВНИМАНИЕ: никогда не делайте этого</span>
<span class="gp">  #</span> в условиях промышленной эксплуатации !!!
<span class="gp">$</span> tarantoolctl enter example
<span class="go">/bin/tarantoolctl: Found example.lua in /etc/tarantool/instances.available</span>
<span class="go">/bin/tarantoolctl: Connecting to /var/run/tarantool/example.control</span>
<span class="go">/bin/tarantoolctl: connected to unix/:/var/run/tarantool/example.control</span>
<span class="go">unix/:/var/run/tarantool/example.control&gt; require(&#39;ffi&#39;).cast(&#39;char *&#39;, 0)[0] = 48</span>
<span class="go">/bin/tarantoolctl: unix/:/var/run/tarantool/example.control: Remote host closed connection</span>
</pre></div>
</div>
<p>Введем <code class="samp docutils literal"><span class="pre">coredumpctl</span> <span class="pre">list</span> <span class="pre">/usr/bin/tarantool</span></code>, чтобы получить отчет о последних аварийных завершениях Tarantool-демона:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> coredumpctl list /usr/bin/tarantool
<span class="go">MTIME                            PID   UID   GID SIG PRESENT EXE</span>
<span class="go">Sat 2016-01-23 15:21:24 MSK   20681  1000  1000   6   /usr/bin/tarantool</span>
<span class="go">Sat 2016-01-23 15:51:56 MSK   21035   995   992   6   /usr/bin/tarantool</span>
</pre></div>
</div>
<p>Чтобы получить трассировку стека и прочую полезную информацию, введем <code class="samp docutils literal"><span class="pre">coredumpctl</span> <span class="pre">info</span> <span class="pre">&lt;pid&gt;</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> coredumpctl info 21035
<span class="go">          PID: 21035 (tarantool)</span>
<span class="go">          UID: 995 (tarantool)</span>
<span class="go">          GID: 992 (tarantool)</span>
<span class="go">       Signal: 6 (ABRT)</span>
<span class="go">    Timestamp: Sat 2016-01-23 15:51:42 MSK (4h 36min ago)</span>
<span class="go"> Command Line: tarantool example.lua &lt;running&gt;</span>
<span class="go">   Executable: /usr/bin/tarantool</span>
<span class="go">Control Group: /system.slice/system-tarantool.slice/tarantool@example.service</span>
<span class="go">         Unit: tarantool@example.service</span>
<span class="go">        Slice: system-tarantool.slice</span>
<span class="go">      Boot ID: 7c686e2ef4dc4e3ea59122757e3067e2</span>
<span class="go">   Machine ID: a4a878729c654c7093dc6693f6a8e5ee</span>
<span class="go">     Hostname: localhost.localdomain</span>
<span class="go">      Message: Process 21035 (tarantool) of user 995 dumped core.</span>

<span class="go">               Stack trace of thread 21035:</span>
<span class="gp">               #</span><span class="m">0</span>  0x00007f84993aa618 raise <span class="o">(</span>libc.so.6<span class="o">)</span>
<span class="gp">               #</span><span class="m">1</span>  0x00007f84993ac21a abort <span class="o">(</span>libc.so.6<span class="o">)</span>
<span class="gp">               #</span><span class="m">2</span>  0x0000560d0a9e9233 _ZL12sig_fatal_cbi <span class="o">(</span>tarantool<span class="o">)</span>
<span class="gp">               #</span><span class="m">3</span>  0x00007f849a211220 __restore_rt <span class="o">(</span>libpthread.so.0<span class="o">)</span>
<span class="gp">               #</span><span class="m">4</span>  0x0000560d0aaa5d9d lj_cconv_ct_ct <span class="o">(</span>tarantool<span class="o">)</span>
<span class="gp">               #</span><span class="m">5</span>  0x0000560d0aaa687f lj_cconv_ct_tv <span class="o">(</span>tarantool<span class="o">)</span>
<span class="gp">               #</span><span class="m">6</span>  0x0000560d0aaabe33 lj_cf_ffi_meta___newindex <span class="o">(</span>tarantool<span class="o">)</span>
<span class="gp">               #</span><span class="m">7</span>  0x0000560d0aaae2f7 lj_BC_FUNCC <span class="o">(</span>tarantool<span class="o">)</span>
<span class="gp">               #</span><span class="m">8</span>  0x0000560d0aa9aabd lua_pcall <span class="o">(</span>tarantool<span class="o">)</span>
<span class="gp">               #</span><span class="m">9</span>  0x0000560d0aa71400 lbox_call <span class="o">(</span>tarantool<span class="o">)</span>
<span class="gp">               #</span><span class="m">10</span> 0x0000560d0aa6ce36 lua_fiber_run_f <span class="o">(</span>tarantool<span class="o">)</span>
<span class="gp">               #</span><span class="m">11</span> 0x0000560d0a9e8d0c _ZL16fiber_cxx_invokePFiP13__va_list_tagES0_ <span class="o">(</span>tarantool<span class="o">)</span>
<span class="gp">               #</span><span class="m">12</span> 0x0000560d0aa7b255 fiber_loop <span class="o">(</span>tarantool<span class="o">)</span>
<span class="gp">               #</span><span class="m">13</span> 0x0000560d0ab38ed1 coro_init <span class="o">(</span>tarantool<span class="o">)</span>
<span class="go">               ...</span>
</pre></div>
</div>
<p>Теперь введем <code class="samp docutils literal"><span class="pre">coredumpctl</span> <span class="pre">-o</span> <span class="pre">filename.core</span> <span class="pre">info</span> <span class="pre">&lt;pid&gt;</span></code>, чтобы сохранить дамп памяти в отдельный файл.</p>
<p>Далее с помощью команды <code class="samp docutils literal"><span class="pre">coredumpctl</span> <span class="pre">gdb</span> <span class="pre">&lt;pid&gt;</span></code> запустим отладчик <strong class="program">gdb</strong> и подадим сохраненный дамп памяти ему на вход.</p>
<p>Мы очень рекомендуем установить пакет <code class="docutils literal"><span class="pre">tarantool-debuginfo</span></code>, чтобы сделать отладку средствами <strong class="program">gdb</strong> более эффективной. Например:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> dnf debuginfo-install tarantool
</pre></div>
</div>
<p>С помощью <strong class="program">gdb</strong> вы можете узнать, какие еще <code class="docutils literal"><span class="pre">debuginfo</span></code>-пакеты нужно установить:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="c1"># gdb -p &lt;pid&gt;</span>
<span class="go">...</span>
<span class="go">Missing separate debuginfos, use: dnf debuginfo-install</span>
<span class="go">glibc-2.22.90-26.fc24.x86_64 krb5-libs-1.14-12.fc24.x86_64</span>
<span class="go">libgcc-5.3.1-3.fc24.x86_64 libgomp-5.3.1-3.fc24.x86_64</span>
<span class="go">libselinux-2.4-6.fc24.x86_64 libstdc++-5.3.1-3.fc24.x86_64</span>
<span class="go">libyaml-0.1.6-7.fc23.x86_64 ncurses-libs-6.0-1.20150810.fc24.x86_64</span>
<span class="go">openssl-libs-1.0.2e-3.fc24.x86_64</span>
</pre></div>
</div>
<p>В трассировке стека используются символические имена, даже если у вас не установлен пакет <code class="docutils literal"><span class="pre">tarantool-debuginfo</span></code>.</p>
<p>Дополнительно см. документацию по вашей Linux-системе.</p>
</div>
<div class="section" id="precautions">
<h5>6.8.5. Особые указания<a class="headerlink" href="#precautions" title="Ссылка на этот заголовок">¶</a></h5>
<ul class="simple">
<li><p class="first">Пожалуйста, не используйте <code class="docutils literal"><span class="pre">tarantoolctl</span> <span class="pre">{start,stop,restart}</span></code> для управления экземплярами, которые были запущены с помощью <strong class="program">systemd</strong>. Но вы можете использовать <strong class="program">tarantoolctl</strong> для запуска/остановки экземпляров в ваших локальных директориях (например, <code class="file docutils literal"><span class="pre">$</span><em><span class="pre">HOME</span></em></code>), что не требует пользовательских прав уровня <code class="docutils literal"><span class="pre">ROOT</span></code>.</p>
</li>
<li><p class="first">Утилита <strong class="program">tarantoolctl</strong> уже настроена так, чтобы корректно работать с <strong class="program">systemd</strong>. Пожалуйста, не меняйте общесистемные настройки для <strong class="program">tarantoolctl</strong>, такие как пути, настройки прав для директорий и имена пользователей, т.к. это может привести к неожиданным проблемам.</p>
</li>
<li><p class="first">Поддержкой скриптов для <strong class="program">systemd</strong> занимается команда разработки Tarantool'а (<a class="reference external" href="http://tarantool.org">http://tarantool.org</a>). Если у вас возникли проблемы при работе Tarantool'а с <strong class="program">systemd</strong>, то мы просим сообщать об этом нашей команде (<a class="reference external" href="https://github.com/tarantool/tarantool/issues/">https://github.com/tarantool/tarantool/issues/</a>), а не разработчикам вашего Linux-дистрибутива.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="updating-tarantool-in-production">
<h4>6.9. Обновление Tarantool'а в условиях эксплуатации<a class="headerlink" href="#updating-tarantool-in-production" title="Ссылка на этот заголовок">¶</a></h4>
<p>Во-первых, вынесите всю бизнес-логику своего приложения в отдельный Tarantool-модуль на языке Lua так, чтобы все нужные функции были доступны для вызова извне (CALL).</p>
<p>Вот пример такого модуля, файл <code class="file docutils literal"><span class="pre">/usr/share/tarantool/myapp.lua</span></code>:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="k">function</span> <span class="nf">start</span><span class="p">()</span>
  <span class="c1">-- Initial version</span>
  <span class="n">box</span><span class="p">.</span><span class="n">once</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">myapp:.1.0&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
  <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">somedata&quot;</span><span class="p">)</span>
  <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">somedata</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">primary&quot;</span><span class="p">)</span>
  <span class="o">...</span>

  <span class="c1">-- migration code from 1.0 to 1.1</span>
  <span class="n">box</span><span class="p">.</span><span class="n">once</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">myapp:.v1.1&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
  <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">somedata</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">primary</span><span class="p">:</span><span class="n">alter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
  <span class="o">...</span>

  <span class="c1">-- migration code from 1.1 to 1.2</span>
  <span class="n">box</span><span class="p">.</span><span class="n">once</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">myapp:.v1.2&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
  <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">somedata</span><span class="p">.</span><span class="n">space</span><span class="p">:</span><span class="n">alter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
  <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">somedata</span><span class="p">:</span><span class="n">insert</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
  <span class="o">...</span>
<span class="k">end</span>

<span class="c1">-- start some background fibers if you need</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">stop</span><span class="p">()</span>
  <span class="c1">-- stop all background fibers and cleanup resources</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">api_for_call</span><span class="p">(</span><span class="n">xxx</span><span class="p">)</span>
  <span class="c1">-- do some business</span>
<span class="k">end</span>

<span class="k">return</span> <span class="p">{</span>
  <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
  <span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span><span class="p">;</span>
  <span class="n">api_for_call</span> <span class="o">=</span> <span class="n">api_for_call</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Поддержка этого файла лежит на стороне разработчиков приложения. А команда разработки Tarantool'а со своей стороны предлагает шаблоны, для того чтобы вы могли <a class="reference external" href="https://github.com/tarantool/modulekit">создать у себя deb/rpm-сборку</a>, а также утилиты для быстрого <a class="reference external" href="https://github.com/tarantool/build">создания сборок под разные платформы</a>. Если понадобится, вы можете разбить приложения на отдельные файлы и/или модули.</p>
<p>Во вторых, положите скрипт инициализации в директорию <code class="file docutils literal"><span class="pre">/etc/tarantool/instances.available</span></code>.</p>
<p>Вот пример такого скрипта, файл <code class="file docutils literal"><span class="pre">/etc/tarantool/instances.available/myappcfg.lua</span></code>:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="n">box</span><span class="p">.</span><span class="n">cfg</span> <span class="p">{</span>
  <span class="n">listen</span> <span class="o">=</span> <span class="mi">3301</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="n">myapp</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="k">then</span>
  <span class="c1">-- hot code reload using tarantoolctl or dofile()</span>

  <span class="c1">-- unload old application</span>
  <span class="n">myapp</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
  <span class="c1">-- clear cache for loaded modules and dependencies</span>
  <span class="nb">package.loaded</span><span class="p">[</span><span class="s1">&#39;</span><span class="s">myapp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span>
  <span class="nb">package.loaded</span><span class="p">[</span><span class="s1">&#39;</span><span class="s">somedep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">;</span> <span class="c1">-- dependency of &#39;myapp&#39;</span>
<span class="k">end</span>

<span class="c1">-- load a new version of app and all dependencies</span>
<span class="n">myapp</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">myapp&#39;</span><span class="p">).</span><span class="n">start</span><span class="p">({</span><span class="n">some</span> <span class="n">app</span> <span class="n">options</span> <span class="n">controlled</span> <span class="n">by</span> <span class="n">sysadmins</span><span class="p">})</span>
</pre></div>
</div>
<p>Более детальный пример (со всеми настройками) содержится в файле <code class="file docutils literal"><span class="pre">example.lua</span></code>, который входит в состав дистрибутива Tarantool'а.</p>
<p>Этот скрипт инициализации по сути является конфигурационным файлом. Его поддержкой должны заниматься системные администраторы, в то время как разработчики только предоставляют им шаблон.</p>
<p>Теперь обновите файл с вашим приложением в директории <code class="file docutils literal"><span class="pre">/usr/share/tarantool</span></code>. Замените старую версию файла (например, <code class="file docutils literal"><span class="pre">/usr/share/tarantool/myapp.lua</span></code>) и вручную загрузите скрипт инициализации <code class="file docutils literal"><span class="pre">myappcfg.lua</span></code> с помощью утилиты <strong class="program">tarantoolctl</strong>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> tarantoolctl <span class="nb">eval</span> /etc/tarantool/instance.enabled/myappcfg.lua
</pre></div>
</div>
<p>После этого вам нужно вручную очистить кеш модулей <code class="docutils literal"><span class="pre">package.loaded</span></code>.</p>
<p>Чтобы создать deb/rpm-сборку, вы можете добавить инструкцию <code class="docutils literal"><span class="pre">tarantoolctl</span> <span class="pre">eval</span></code> прямо в спецификацию Tarantool'а в файле <code class="file docutils literal"><span class="pre">RPM.spec</span></code> и в директории <code class="file docutils literal"><span class="pre">/debian</span></code>.</p>
<p>В итоге клиенты делают вызов (CALL) функции <code class="docutils literal"><span class="pre">myapp.api_for_call</span></code> и других функций из API.</p>
<p>Если вы используете <code class="docutils literal"><span class="pre">tarantool-http</span></code>, то запускать бинарный протокол не нужно.</p>
</div>
<div class="section" id="backups">
<h4>6.10. Резервное копирование<a class="headerlink" href="#backups" title="Ссылка на этот заголовок">¶</a></h4>
<p>При выборе конкретной процедуры для резервного копирования базы данных нужно учитывать следующие требования: насколько актуальной должна быть копия, можно ли временно отключать других пользователей, а также нужна ли оптимизация размера копии (чтобы копия занимала меньше места на диске) или скорости самой процедуры (чтобы процедура занимала меньше времени). Выбирать можно из нескольких вариантов в диапазоне от &quot;простого и холодного&quot; до &quot;трудного и горячего&quot;.</p>
<p><strong>&quot;Холодное&quot; резервирование</strong></p>
<p>Суть процедуры: последний созданный Tarantool'ом файл-снимок является резервной копией всей базы; а WAL-файлы, созданные следом, являются инкрементными копиями. Поэтому вся процедура резервирования сводится к копированию последнего файла-снимка и последующих WAL-файлов.</p>
<ol class="arabic simple">
<li><p class="first">Временно запретите всем пользователям делать записи в базе. Для этого можно остановить Tarantool-сервер, либо ввести запрос <code class="docutils literal"><span class="pre">box.cfg{read_only=true}</span></code> и убедиться, что все обращения на запись завершились (для этого можно использовать <strong class="program">fsync</strong>).</p>
</li>
<li><p class="first">Если вы хотите создать резеврную копию для всей базы целиком, введите запрос <code class="samp docutils literal"><span class="pre">box.snapshot()</span></code>.</p>
</li>
<li><p class="first">С помощью <strong class="program">tar</strong> создайте сжатую (насколько это можно) копию последнего <code class="file docutils literal"><span class="pre">.snap</span></code>-файла и последующих <code class="file docutils literal"><span class="pre">.xlog</span></code>-файлов из директорий <a class="reference internal" href="singlehtml.html#cfg-basic-snap-dir"><span class="std std-ref">snap_dir</span></a> и <a class="reference internal" href="singlehtml.html#cfg-basic-wal-dir"><span class="std std-ref">wal_dir</span></a>.</p>
</li>
<li><p class="first">Если того требуют правила безопасности, зашифруйте получившийся <code class="file docutils literal"><span class="pre">tar</span></code>-файл.</p>
</li>
<li><p class="first">Скопируйте <code class="file docutils literal"><span class="pre">tar</span></code>-файл в надежное место.</p>
</li>
</ol>
<p>... В дальнейшем вы сможете восстановить базу данных, просто взяв этот <code class="file docutils literal"><span class="pre">tar</span></code>-файл и разархивировав его содержимое в директории <code class="docutils literal"><span class="pre">snap_dir</span></code> и <code class="docutils literal"><span class="pre">wal_dir</span></code>.</p>
<p><strong>Постоянное удаленное резервирование</strong></p>
<p>Суть процедуры: для резервирования (а также для балансирования нагрузки) можно использовать <a class="reference internal" href="singlehtml.html#index-box-replication"><span class="std std-ref">репликацию</span></a>. Процедура резервирования в рамках репликационного кластера сводится к тому, чтобы держать все реплики в актуальном состоянии и периодически делать с них &quot;холодные&quot; копии. Поскольку во время снятия копии с какой-либо одной реплики все остальные реплики продолжают синхронизироваться с главным сервером, то эта процедура несколько отличается от описанной выше процедуры &quot;холодного&quot; резервирования. Регулярное резервирование в кластере можно настроить с помощью планировщика <strong class="program">cron</strong> или Tarantool-файбера.</p>
<p><strong>&quot;Горячее&quot; резервирование</strong></p>
<p>Суть процедуры: по ходу работы системы нужно сохранять записи об изменениях, сделанных со времени последнего &quot;холодного&quot; резервирования.</p>
<p>Для этого вам понадобится специальная утилита для копирования частей файлов (например, <a class="reference external" href="https://en.wikipedia.org/wiki/rsync">rsync</a>), которая позволит удаленно и на постоянной основе копировать только изменившиеся части файлов-снимков и WAL-файлов, а не все эти файлы целиком.</p>
<p>Вы можете взять и обычную утилиту (для копирования файлов целиком), но тогда вам придется создавать файлы-снимки и WAL-файлы на каждое изменение, чтобы нужно было копировать только новые файлы.</p>
<p>Примечание про движок: при организации резервирования для баз данных на движке vinyl понадобятся дополнительные действия.</p>
</div>
<div class="section" id="upgrades">
<h4>6.11. Обновление Tarantool'а<a class="headerlink" href="#upgrades" title="Ссылка на этот заголовок">¶</a></h4>
<p>Эта информация полезна в том случае, если у вас есть база данных, работающая на какой-либо старой версии Tarantool'а, а теперь вы установили Tarantool новой версии. В этом случае выполните запрос <code class="samp docutils literal"><span class="pre">box.schema.upgrade()</span></code>.</p>
<p>Например, вот что происходит, если выполнить запрос <code class="samp docutils literal"><span class="pre">box.schema.upgrade()</span></code> для базы, созданной в начале 2015 года (для примера показана лишь малая часть выводимых сообщений):</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">upgrade</span><span class="p">()</span>
<span class="go">alter index primary on _space set options to {&quot;unique&quot;:true}, parts to [[0,&quot;unsigned&quot;]]</span>
<span class="go">alter space _schema set options to {}</span>
<span class="go">create view _vindex...</span>
<span class="go">grant read access to &#39;public&#39; role for _vindex view</span>
<span class="go">set schema version to 1.7.0</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
</div>
<span id="document-book/connectors/index"></span><div class="section" id="connectors">
<span id="index-box-connectors"></span><h3>7. Коннекторы<a class="headerlink" href="#connectors" title="Ссылка на этот заголовок">¶</a></h3>
<p>В этой главе описаны API для различных языков программирования.</p>
<div class="section" id="protocol">
<h4>7.1. Протокол<a class="headerlink" href="#protocol" title="Ссылка на этот заголовок">¶</a></h4>
<p>Бинарный протокол для передачи данных в Tarantool'е был разработан с учетом потребностей асинхронного ввода-вывода. Основная его задача — облегчить интеграцию Tarantool'а с клиентскими приложениями. Клиентский запрос в Tarantool-протоколе начинается с бинарного заголовка переменной длины. В заголовке указывается идентификатор и тип запроса, идентификатор сервера, номер записи в журнале и т.д.</p>
<p>Также в заголовке обязательно указывается длина запроса, что облегчает обработку данных. Ответ на запрос посылается по мере готовности. В заголовке ответа указывается тот же идентификатор и тип запроса, что и в изначальном запросе. По идентификатору можно легко соотнести запрос с ответом, даже если ответ был получен не в порядке отсылки запросов.</p>
<p>Вдаваться в тонкости реализации Tarantool-протокола нужно только при разработке нового коннектора для Tarantool'а — см. <a class="reference internal" href="singlehtml.html#box-protocol-iproto-protocol"><span class="std std-ref">полное описание бинарного протокола в Tarantool'е</span></a> в виде аннотированных BNF-диаграмм (Backus-Naur Form). В остальных случаях достаточно взять уже существующий коннектор для нужного вам языка программирования. Такие коннекторы позволяют легко хранить структуры данных из разных языков в формате Tarantool'а.</p>
</div>
<div class="section" id="packet-example">
<h4>7.2. Пример пакета данных<a class="headerlink" href="#packet-example" title="Ссылка на этот заголовок">¶</a></h4>
<p>С помощью Tarantool API клиентские программы могут посылать в адрес Tarantool-сервера пакеты с запросами и получать на них ответы. Вот пример исходящего пакета, который будет сформирован для запроса <code class="code docutils literal"><span class="pre">box.space[513]:insert{'A',</span> <span class="pre">'BB'}</span></code>. Описания компонентов запроса (в виде BNF-диаграмм) вы найдете на странице о <a class="reference internal" href="singlehtml.html#box-protocol-iproto-protocol"><span class="std std-ref">бинарном протоколе в Tarantool'е</span></a>.</p>
<blockquote>
<div><div class="table container">
<table border="1" class="left-align-column-1 right-align-column-2 right-align-column-3 right-align-column-4 docutils">
<colgroup>
<col width="48%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><p class="first last">Компонент</p>
</th>
<th class="head"><p class="first last">Байт #0</p>
</th>
<th class="head"><p class="first last">Байт #1</p>
</th>
<th class="head"><p class="first last">Байт #2</p>
</th>
<th class="head"><p class="first last">Байт #3</p>
</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><p class="first last">код для вставки</p>
</td>
<td>02</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td><p class="first last">остаток заголовка</p>
</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="row-even"><td><p class="first last">число из 2 цифр: ID пространства</p>
</td>
<td>cd</td>
<td>02</td>
<td>01</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td><p class="first last">код для кортежа</p>
</td>
<td>21</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td><p class="first last">число из 1 цифры: количество полей = 2</p>
</td>
<td>92</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td><p class="first last">строка из 1 символа: поле[1]</p>
</td>
<td>a1</td>
<td>41</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td><p class="first last">строка из 2 символов: поле[2]</p>
</td>
<td>a2</td>
<td>42</td>
<td>42</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
</div>
</div></blockquote>
<p>Теперь получившийся пакет можно послать Tarantool-серверу и затем проинтерпретировать полученный ответ (описания компонентов ответа вы найдете на той же странице о <a class="reference internal" href="singlehtml.html#box-protocol-iproto-protocol"><span class="std std-ref">бинарном протоколе в Tarantool'е</span></a>). Но более простым и верным способом будет вызвать процедуру, которая за вас сформирует готовый пакет с заданными параметрами. Что-то вроде <code class="samp docutils literal"><span class="pre">response=tarantool_routine(&quot;insert&quot;,513,&quot;A&quot;,&quot;B&quot;);</span></code>. Для этого в Tarantool'е существуют API для Perl, Python, PHP и других программных языков.</p>
</div>
<div class="section" id="setting-up-the-server-for-connector-examples">
<span id="index-connector-setting"></span><h4>7.3. Настройка окружения для примеров работы с коннекторами<a class="headerlink" href="#setting-up-the-server-for-connector-examples" title="Ссылка на этот заголовок">¶</a></h4>
<p>В этой главе приводятся примеры того, как можно установить соединение с Tarantool-сервером с помощью коннекторов для языков Perl, PHP, Python и C. Обратите внимание, что в примерах исходного кода указаны фиксированные значения для элементов тестового окружения, поэтому для корректной работы всех примеров нужно соблюсти следующие условия:</p>
<ul class="simple">
<li><p class="first">Tarantool-сервер запущен на локальной машине (<code class="docutils literal"><span class="pre">localhost</span> <span class="pre">=</span> <span class="pre">127.0.0.1</span></code>), а прослушивание для него настроено на порту 3301 (<code class="samp docutils literal"><span class="pre">box.cfg.listen</span> <span class="pre">=</span> <span class="pre">'3301'</span></code>),</p>
</li>
<li><p class="first">в базе есть пространство <code class="docutils literal"><span class="pre">examples</span></code> с идентификатором 999 (<code class="samp docutils literal"><span class="pre">box.space.examples.id</span> <span class="pre">=</span> <span class="pre">999</span></code>) и у него есть первичный индекс, построенный по ключу числового типа (<code class="samp docutils literal"><span class="pre">box.space[999].index[0].parts[1].type</span> <span class="pre">=</span> <span class="pre">&quot;unsigned&quot;</span></code>),</p>
</li>
<li><p class="first">для пользователя 'guest' настроены привилегии на чтение и запись.</p>
</li>
</ul>
<p>Такое тестовое окружение легко настроить, запустив Tarantool-сервер локально и выполнив следующие запросы:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span><span class="o">=</span><span class="mi">3301</span><span class="p">}</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">examples&#39;</span><span class="p">,{</span><span class="n">id</span><span class="o">=</span><span class="mi">999</span><span class="p">})</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">examples</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">hash&#39;</span><span class="p">,</span> <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">guest&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">read,write&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">examples&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">guest&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">read&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">space&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">_space&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="java">
<h4>7.4. Java<a class="headerlink" href="#java" title="Ссылка на этот заголовок">¶</a></h4>
<p>См. <a class="reference external" href="http://github.com/tarantool/tarantool-java/">http://github.com/tarantool/tarantool-java/</a>.</p>
</div>
<div class="section" id="go">
<h4>7.5. Go<a class="headerlink" href="#go" title="Ссылка на этот заголовок">¶</a></h4>
<p>См. <a class="reference external" href="https://github.com/mialinx/go-tarantool">https://github.com/mialinx/go-tarantool</a>.</p>
</div>
<div class="section" id="r">
<h4>7.6. R<a class="headerlink" href="#r" title="Ссылка на этот заголовок">¶</a></h4>
<p>См. <a class="reference external" href="https://github.com/thekvs/tarantoolr">https://github.com/thekvs/tarantoolr</a>.</p>
</div>
<div class="section" id="perl">
<h4>7.7. Perl<a class="headerlink" href="#perl" title="Ссылка на этот заголовок">¶</a></h4>
<p>Наиболее популярным Tarantool-коннектором для языка Perl является <a class="reference external" href="http://search.cpan.org/~unera/DR-Tarantool/">DR::Tarantool</a>. Он устанавливается отдельно от Tarantool'а, например с помощью <strong class="program">cpan</strong> (см. <a class="reference external" href="https://en.wikipedia.org/wiki/Cpan">CPAN, the Comprehensive Perl Archive Network</a>), и требует предварительной установки еще несколько зависимых модулей. Вот пример установки этого коннектора под Ubuntu:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> sudo cpan install AnyEvent
<span class="gp">$</span> sudo cpan install Devel::GlobalDestruction
<span class="gp">$</span> sudo cpan install Coro
<span class="gp">$</span> sudo cpan install Test::Pod
<span class="gp">$</span> sudo cpan install Test::Spelling
<span class="gp">$</span> sudo cpan install PAR::Dist
<span class="gp">$</span> sudo cpan install List::MoreUtils
<span class="gp">$</span> sudo cpan install DR::Tarantool
</pre></div>
</div>
<p>Далее приводится пример полноценной программы на языке Perl, которая осуществляет вставку кортежа <code class="docutils literal"><span class="pre">[99999,'BB']</span></code> в пространство <code class="docutils literal"><span class="pre">space[999]</span></code> с помощью Tarantool API для языка Perl. Перед запуском данной программы проверьте, что ваше тестовое окружение настроено так, как <a class="reference internal" href="#index-connector-setting"><span class="std std-ref">описано выше</span></a> (у Tarantool-сервера задан порт для прослушивания и в базе создано пространство <code class="docutils literal"><span class="pre">examples</span></code>). Чтобы запустить тестовую программу, сохраните ее исходный код в файл с именем <code class="file docutils literal"><span class="pre">example.pl</span></code> и выполните команду <code class="samp docutils literal"><span class="pre">perl</span> <span class="pre">example.pl</span></code>. Программа установит соединение, используя указанное в ней описание пространства, откроет сокет для соединения с Tarantool-сервером по адресу <code class="docutils literal"><span class="pre">localhost:3301</span></code>, пошлет INSERT-запрос, а затем — если всё хорошо — закончит работу без каких-либо сообщений. Если окажется, что Tarantool-сервер не запущен на прослушивание по указанному адресу, то программа выдаст сообщение об ошибке “Connection refused”.</p>
<div class="highlight-perl"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/perl</span>
<span class="k">use</span> <span class="nn">DR::</span><span class="n">Tarantool</span> <span class="s">&#39;:constant&#39;</span><span class="p">,</span> <span class="s">&#39;tarantool&#39;</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">DR::</span><span class="n">Tarantool</span> <span class="s">&#39;:all&#39;</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">DR::Tarantool::MsgPack::</span><span class="n">SyncClient</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$tnt</span> <span class="o">=</span> <span class="nn">DR::Tarantool::MsgPack::</span><span class="n">SyncClient</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span>
  <span class="n">host</span>    <span class="o">=&gt;</span> <span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span>                      <span class="c1"># поиск Tarantool-сервера по адресу localhost</span>
  <span class="n">port</span>    <span class="o">=&gt;</span> <span class="mi">3301</span><span class="p">,</span>                             <span class="c1"># на порту 3301</span>
  <span class="n">user</span>    <span class="o">=&gt;</span> <span class="s">&#39;guest&#39;</span><span class="p">,</span>                          <span class="c1"># имя пользователя; здесь же можно добавить &#39;password=&gt;...&#39;</span>

  <span class="n">spaces</span>  <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="mi">999</span> <span class="o">=&gt;</span> <span class="p">{</span>                                   <span class="c1"># определение пространства space[999] ...</span>
      <span class="n">name</span> <span class="o">=&gt;</span> <span class="s">&#39;examples&#39;</span><span class="p">,</span>                      <span class="c1"># имя пространства space[999] = &#39;examples&#39;</span>
      <span class="n">default_type</span> <span class="o">=&gt;</span> <span class="s">&#39;STR&#39;</span><span class="p">,</span>                   <span class="c1"># если тип поля в space[999] не задан, то = &#39;STR&#39;</span>
      <span class="n">fields</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="p">{</span>                            <span class="c1"># определение полей в пространстве space[999] ...</span>
          <span class="n">name</span> <span class="o">=&gt;</span> <span class="s">&#39;field1&#39;</span><span class="p">,</span> <span class="n">type</span> <span class="o">=&gt;</span> <span class="s">&#39;NUM&#39;</span> <span class="p">}</span> <span class="p">],</span> <span class="c1"># имя поля space[999].field[1]=&#39;field1&#39;, тип =&#39;NUM&#39;</span>
      <span class="n">indexes</span> <span class="o">=&gt;</span> <span class="p">{</span>                             <span class="c1"># определение индексов пространства space[999] ...</span>
        <span class="mi">0</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="n">name</span> <span class="o">=&gt;</span> <span class="s">&#39;primary&#39;</span><span class="p">,</span> <span class="n">fields</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s">&#39;field1&#39;</span> <span class="p">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">);</span>

<span class="nv">$tnt</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;examples&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="mi">99999</span><span class="p">,</span> <span class="s">&#39;BB&#39;</span> <span class="p">]);</span>
</pre></div>
</div>
<p>Из-за существующих ограничений в языке Perl, вместо полей типа 'string' и 'unsigned' в тестовой программе указаны поля типа 'STR' и 'NUM'.</p>
<p>В этой программе мы привели пример использования лишь одного запроса. Для полноценной работы с Tarantool'ом с помощью Perl API, пожалуйста, обратитесь к документации из <a class="reference external" href="http://search.cpan.org/~unera/DR-Tarantool/">CPAN-репозитория DR::Tarantool</a>.</p>
</div>
<div class="section" id="php">
<h4>7.8. PHP<a class="headerlink" href="#php" title="Ссылка на этот заголовок">¶</a></h4>
<p>Tarantool-коннектор для языка PHP называется <a class="reference external" href="https://github.com/tarantool/tarantool-php">tarantool-php</a>. Он устанавливается отдельно от Tarantool'а с помощью <strong class="program">git</strong> и требует предварительной установки еще несколько зависимых модулей. Вот пример установки этого коннектора под Ubuntu:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> sudo apt-get install php5-cli
<span class="gp">$</span> sudo apt-get install php5-dev
<span class="gp">$</span> sudo apt-get install php-pear
<span class="gp">$</span> <span class="nb">cd</span> ~
<span class="gp">$</span> git clone https://github.com/tarantool/tarantool-php.git
<span class="gp">$</span> <span class="nb">cd</span> tarantool-php
<span class="gp">$</span> phpize
<span class="gp">$</span> ./configure
<span class="gp">$</span> make
<span class="gp">$</span> <span class="c1"># make install is optional</span>
</pre></div>
</div>
<p>После отработки всех команд будет создан файл с именем <code class="file docutils literal"><span class="pre">~/tarantool-php/modules/tarantool.so</span></code>. PHP увидит его, только если в файле инициализации <code class="file docutils literal"><span class="pre">php.ini</span></code> есть строка вида <code class="samp docutils literal"><span class="pre">extension=./tarantool.so</span></code>, либо если при запуске PHP вы укажете опцию <code class="samp docutils literal"><span class="pre">-d</span> <span class="pre">extension=~/tarantool-php/modules/tarantool.so</span></code>.</p>
<p>Далее приводится пример полноценной программы на языке PHP, которая осуществляет вставку кортежа <code class="docutils literal"><span class="pre">[99999,'BB']</span></code> в пространство <code class="docutils literal"><span class="pre">examples</span></code> с помощью Tarantool API для языка PHP. Перед запуском данной программы проверьте, что ваше тестовое окружение настроено так, как <a class="reference internal" href="#index-connector-setting"><span class="std std-ref">описано выше</span></a> (у Tarantool-сервера задан порт для прослушивания и в базе создано пространство <code class="docutils literal"><span class="pre">examples</span></code>). Чтобы запустить тестовую программу, сохраните ее исходный код в файл с именем <code class="file docutils literal"><span class="pre">example.php</span></code> и выполните команду <code class="samp docutils literal"><span class="pre">php</span> <span class="pre">-d</span> <span class="pre">extension=~/tarantool-php/modules/tarantool.so</span> <span class="pre">example.php</span></code>. Программа откроет сокет для соединения с Tarantool-сервером по адресу <code class="docutils literal"><span class="pre">localhost:3301</span></code>, пошлет INSERT-запрос, а затем — если всё хорошо — выдаст сообщение &quot;Insert succeeded&quot;. Если окажется, что такой кортеж уже существует, то программа выдаст сообщение об ошибке “Duplicate key exists in unique index 'primary' in space 'examples'”.</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
<span class="nv">$tarantool</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Tarantool</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">3301</span><span class="p">);</span>

<span class="k">try</span> <span class="p">{</span>
    <span class="nv">$tarantool</span><span class="o">-&gt;</span><span class="na">insert</span><span class="p">(</span><span class="s1">&#39;examples&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="mi">99999</span><span class="p">,</span> <span class="s1">&#39;BB&#39;</span><span class="p">));</span>
    <span class="k">echo</span> <span class="s2">&quot;Insert succeeded</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;Exception: &quot;</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>В этой программе мы привели пример использования лишь одного запроса. Для полноценной работы с Tarantool'ом с помощью PHP API, пожалуйста, обратитесь к документации из <a class="reference external" href="https://github.com/tarantool/tarantool-php">проекта tarantool-php на GitHub</a>.</p>
</div>
<div class="section" id="python">
<h4>7.9. Python<a class="headerlink" href="#python" title="Ссылка на этот заголовок">¶</a></h4>
<p>Далее приводится пример полноценной программы на языке Python, которая осуществляет вставку кортежа <code class="docutils literal"><span class="pre">[99999,'Value','Value']</span></code> в пространство <code class="docutils literal"><span class="pre">examples</span></code> с помощью высокоуровневого Tarantool API для языка Python.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>
<span class="kn">from</span> <span class="nn">tarantool</span> <span class="kn">import</span> <span class="n">Connection</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">3301</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s2">&quot;examples&quot;</span><span class="p">,(</span><span class="mi">99999</span><span class="p">,</span><span class="s1">&#39;Value&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">))</span>
<span class="k">print</span> <span class="n">result</span>
</pre></div>
</div>
<p>Перед запуском данной программы проверьте, что ваше тестовое окружение настроено так, как <a class="reference internal" href="#index-connector-setting"><span class="std std-ref">описано выше</span></a> (у Tarantool-сервера задан порт для прослушивания и в базе создано пространство <code class="docutils literal"><span class="pre">examples</span></code>), и установите коннектор <code class="docutils literal"><span class="pre">tarantool-python</span></code>. Для установки коннектора воспользуйтесь либо командой <code class="samp docutils literal"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">tarantool&gt;0.4</span></code> (для установки в директорию <code class="file docutils literal"><span class="pre">/usr</span></code>; вам потребуются права уровня  <strong>root</strong>), либо командой <code class="samp docutils literal"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">tarantool&gt;0.4</span> <span class="pre">--user</span></code> (для установки в директорию <code class="file docutils literal"><span class="pre">~</span></code>, т.е. в используемую по умолчанию директорию текущего пользователя). Чтобы запустить тестовую программу, сохраните ее исходный код в файл с именем <code class="file docutils literal"><span class="pre">example.py</span></code> и выполните команду <code class="samp docutils literal"><span class="pre">python</span> <span class="pre">example.py</span></code>. Программа установит соединение с Tarantool-сервером, пошлет запрос и не сгенерирует никакого исключения, если всё прошло хорошо. Если окажется, что такой кортеж уже существует, то программа сгенерирует исключение <code class="samp docutils literal"><span class="pre">tarantool.error.DatabaseError:</span> <span class="pre">(3,</span> <span class="pre">&quot;Duplicate</span> <span class="pre">key</span> <span class="pre">exists</span> <span class="pre">in</span> <span class="pre">unique</span> <span class="pre">index</span> <span class="pre">'primary'</span> <span class="pre">in</span> <span class="pre">space</span> <span class="pre">'examples'&quot;)</span></code>.</p>
<p>В этой программе мы привели пример использования лишь одного запроса. Для полноценной работы с Tarantool'ом с помощью Python API, пожалуйста, обратитесь к документации из <a class="reference external" href="http://github.com/tarantool/tarantool-python">проекта tarantool-python на GitHub</a>. А на странице <a class="reference external" href="https://github.com/tarantool/queue-python">проекта queue-python на GitHub</a> вы сможете найти примеры использования Python API для работы с <a class="reference external" href="https://github.com/tarantool/queue">очередями сообщений в Tarantool'е</a>.</p>
</div>
<div class="section" id="c">
<h4>7.10. C<a class="headerlink" href="#c" title="Ссылка на этот заголовок">¶</a></h4>
<p>В этом разделе даны два примера использования высокоуровневого API для Tarantool'а и языка C.</p>
<div class="section" id="example-1">
<h5>7.10.1. Пример 1<a class="headerlink" href="#example-1" title="Ссылка на этот заголовок">¶</a></h5>
<p>Далее приводится пример полноценной программы на языке C, которая осуществляет вставку кортежа <code class="docutils literal"><span class="pre">[99999,'B']</span></code> в пространство <code class="docutils literal"><span class="pre">examples</span></code> с помощью высокоуровневого Tarantool API для языка C.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;tarantool/tarantool.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;tarantool/tnt_net.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;tarantool/tnt_opt.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">struct</span> <span class="n">tnt_stream</span> <span class="o">*</span><span class="n">tnt</span> <span class="o">=</span> <span class="n">tnt_net</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>          <span class="cm">/* См. ниже = НАСТРОЙКА */</span>
   <span class="n">tnt_set</span><span class="p">(</span><span class="n">tnt</span><span class="p">,</span> <span class="n">TNT_OPT_URI</span><span class="p">,</span> <span class="s">&quot;localhost:3301&quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">tnt_connect</span><span class="p">(</span><span class="n">tnt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>                      <span class="cm">/* См. ниже = СОЕДИНЕНИЕ */</span>
       <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Connection refused</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
       <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">struct</span> <span class="n">tnt_stream</span> <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">tnt_object</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>     <span class="cm">/* См. ниже = СОЗДАНИЕ ЗАПРОСА */</span>
   <span class="n">tnt_object_format</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span> <span class="s">&quot;[%d%s]&quot;</span><span class="p">,</span> <span class="mi">99999</span><span class="p">,</span> <span class="s">&quot;B&quot;</span><span class="p">);</span>
   <span class="n">tnt_insert</span><span class="p">(</span><span class="n">tnt</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span> <span class="n">tuple</span><span class="p">);</span>                     <span class="cm">/* См. ниже = ОТПРАВКА ЗАПРОСА */</span>
   <span class="n">tnt_flush</span><span class="p">(</span><span class="n">tnt</span><span class="p">);</span>
   <span class="k">struct</span> <span class="n">tnt_reply</span> <span class="n">reply</span><span class="p">;</span>  <span class="n">tnt_reply_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span> <span class="cm">/* См. ниже = ПОЛУЧЕНИЕ ОТВЕТА */</span>
   <span class="n">tnt</span><span class="o">-&gt;</span><span class="n">read_reply</span><span class="p">(</span><span class="n">tnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="n">code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Insert failed %lu.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reply</span><span class="p">.</span><span class="n">code</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="n">tnt_close</span><span class="p">(</span><span class="n">tnt</span><span class="p">);</span>                                  <span class="cm">/* См. ниже = ЗАВЕРШЕНИЕ */</span>
   <span class="n">tnt_stream_free</span><span class="p">(</span><span class="n">tuple</span><span class="p">);</span>
   <span class="n">tnt_stream_free</span><span class="p">(</span><span class="n">tnt</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Скопируйте исходный код программы в файл с именем <code class="file docutils literal"><span class="pre">example.c</span></code> и установите коннектор <code class="docutils literal"><span class="pre">tarantool-c</span></code>. Вот один из способов установки <code class="docutils literal"><span class="pre">tarantool-c</span></code> (под Ubuntu):</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> git clone git://github.com/tarantool/tarantool-c.git ~/tarantool-c
<span class="gp">$</span> <span class="nb">cd</span> ~/tarantool-c
<span class="gp">$</span> git submodule init
<span class="gp">$</span> git submodule update
<span class="gp">$</span> cmake .
<span class="gp">$</span> make
<span class="gp">$</span> make install
</pre></div>
</div>
<p>Чтобы скомпилировать и слинковать тестовую программу, выполните следующую команду:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="c1"># иногда это необходимо:</span>
<span class="gp">$</span> <span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/usr/local/lib
<span class="gp">$</span> gcc -o example example.c -ltarantool
</pre></div>
</div>
<p>Перед запуском программы проверьте, что ваше тестовое окружение настроено так, как <a class="reference internal" href="#index-connector-setting"><span class="std std-ref">описано выше</span></a> (у Tarantool-сервера задан порт для прослушивания и в базе создано пространство <code class="docutils literal"><span class="pre">examples</span></code>). Чтобы запустить тестовую программу, выполните команду <code class="samp docutils literal"><span class="pre">./example</span></code>. Программа установит соединение с Tarantool-сервером и пошлет запрос. Если окажется, что Tarantool-сервер не запущен на прослушивание по указанному адресу, то программа выдаст сообщение об ошибке “Connection refused”. А если не пройдет INSERT-запрос, то программа выдаст сообщение &quot;Insert failed&quot; и код ошибки (все коды ошибок в Tarantool'е см. в исходном файле <a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.7/src/box/errcode.h">/src/box/errcode.h</a>).</p>
<p>Далее следуют примечания, на которые мы ссылались в комментариях к исходному коду тестовой программы.</p>
<p><strong>НАСТРОЙКА:</strong> Настройка начинается с создания потока (<code class="docutils literal"><span class="pre">tnt_stream</span></code>).</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">tnt_stream</span> <span class="o">*</span><span class="n">tnt</span> <span class="o">=</span> <span class="n">tnt_net</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">tnt_set</span><span class="p">(</span><span class="n">tnt</span><span class="p">,</span> <span class="n">TNT_OPT_URI</span><span class="p">,</span> <span class="s">&quot;localhost:3301&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>В нашей тестовой программе поток назван <code class="docutils literal"><span class="pre">tnt</span></code>. Перед установкой соединения нужно задать ряд настроечных опций. Самая важная из них — TNT_OPT_URI. Для этой опции указана URI-строка <code class="docutils literal"><span class="pre">localhost:3301</span></code>, т.е. адрес, по которому должно быть настроено прослушивание на стороне Tarantool-сервера.</p>
<p>Описание функции:</p>
<pre class="highlight literal-block">
<cite>struct tnt_stream *tnt_net(struct tnt_stream *s)</cite>
<cite>int tnt_set(struct tnt_stream *s, int option, variant option-value)</cite>
</pre>
<p><strong>СОЕДИНЕНИЕ:</strong> Теперь когда мы создали поток с именем <code class="docutils literal"><span class="pre">tnt</span></code> и связали его с конкретным URI, наша программа может устанавливать соединение с Tarantool-сервером.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">tnt_connect</span><span class="p">(</span><span class="n">tnt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
   <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Connection refused</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
</pre></div>
</div>
<p>Описание функции:</p>
<pre class="highlight literal-block">
int tnt_connect(struct tnt_stream *s)
</pre>
<p>Попытка соединения может и не удаться, например если Tarantool-сервер не запущен или в URI-строке указан неверный пароль. В случае неудачи функция <code class="docutils literal"><span class="pre">tnt_connect()</span></code> вернет -1.</p>
<p><strong>СОЗДАНИЕ ЗАПРОСА:</strong> В большинстве запросов требуется передавать структурированные данные, например содержимое кортежа.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">tnt_stream</span> <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">tnt_object</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="n">tnt_object_format</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span> <span class="s">&quot;[%d%s]&quot;</span><span class="p">,</span> <span class="mi">99999</span><span class="p">,</span> <span class="s">&quot;B&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>В данной программе мы используем запрос INSERT, а кортеж содержит целое число и строку.  Это простой набор значений без каких-либо вложенных структур или массивов. И передаваемые значения мы можем указать самым простым образом — аналогично тому, как это сделано в стандартной C-функции <code class="docutils literal"><span class="pre">printf()</span></code>: <code class="docutils literal"><span class="pre">%d</span></code> для обозначения целого числа, <code class="docutils literal"><span class="pre">%s</span></code> для обозначения строки, затем числовое значение, затем указатель на строковое значение.</p>
<p>Описание функции:</p>
<pre class="highlight literal-block">
ssize_t tnt_object_format(struct tnt_stream *s, const char *fmt, ...)
</pre>
<p><strong>ОТПРАВКА ЗАПРОСА:</strong> Отправка запросов на изменение данных в базе делается аналогично тому, как это делается в Tarantool-библиотеке <code class="docutils literal"><span class="pre">box</span></code>.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">tnt_insert</span><span class="p">(</span><span class="n">tnt</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span> <span class="n">tuple</span><span class="p">);</span>
<span class="n">tnt_flush</span><span class="p">(</span><span class="n">tnt</span><span class="p">);</span>
</pre></div>
</div>
<p>В данной программе мы делаем INSERT-запрос. В этом запросе мы передаем поток <code class="docutils literal"><span class="pre">tnt</span></code>, который ранее использовали для установки соединения, и поток <code class="code docutils literal"><span class="pre">tuple</span></code>, который также ранее настроили с помощью функции <a class="reference external" href="http://tarantool.github.io/tarantool-c/msgpackobject.html#c.tnt_object_format" title="(в tarantool-c v1.0)"><code class="docutils literal"><span class="pre">tnt_object_format()</span></code></a>.</p>
<p>Описание функции:</p>
<pre class="highlight literal-block">
ssize_t tnt_insert(struct tnt_stream *s, uint32_t space, struct tnt_stream *tuple)
ssize_t tnt_replace(struct tnt_stream *s, uint32_t space, struct tnt_stream *tuple)
ssize_t tnt_select(struct tnt_stream *s, uint32_t space, uint32_t index,
                   uint32_t limit, uint32_t offset, uint8_t iterator,
                   struct tnt_stream *key)
ssize_t tnt_update(struct tnt_stream *s, uint32_t space, uint32_t index,
                   struct tnt_stream *key, struct tnt_stream *ops)
</pre>
<p><strong>ПОЛУЧЕНИЕ ОТВЕТА:</strong> На большинство запросов клиент получает ответ, который содержит информацию о том, был ли данный запрос успешно выполнен, а также содержит набор кортежей.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">tnt_reply</span> <span class="n">reply</span><span class="p">;</span>  <span class="n">tnt_reply_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
<span class="n">tnt</span><span class="o">-&gt;</span><span class="n">read_reply</span><span class="p">(</span><span class="n">tnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="n">code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
   <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Insert failed %lu.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reply</span><span class="p">.</span><span class="n">code</span><span class="p">);</span> <span class="p">}</span>
</pre></div>
</div>
<p>Данная программа проверяет, был ли запрос выполнен успешно, но никак не интерпретирует оставшуюся часть ответа.</p>
<p>Описание функции:</p>
<pre class="highlight literal-block">
struct tnt_reply *tnt_reply_init(struct tnt_reply *r)
tnt-&gt;read_reply(struct tnt_stream *s, struct tnt_reply *r)
void tnt_reply_free(struct tnt_reply *r)
</pre>
<p><strong>ЗАВЕРШЕНИЕ:</strong> По окончании сессии нам нужно закрыть соединение, созданное с помощью функции <a class="reference external" href="http://tarantool.github.io/tarantool-c/connection.html#c.tnt_connect" title="(в tarantool-c v1.0)"><code class="docutils literal"><span class="pre">tnt_connect()</span></code></a>, и удалить объекты, созданные на этапе настройки.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">tnt_close</span><span class="p">(</span><span class="n">tnt</span><span class="p">);</span>
<span class="n">tnt_stream_free</span><span class="p">(</span><span class="n">tuple</span><span class="p">);</span>
<span class="n">tnt_stream_free</span><span class="p">(</span><span class="n">tnt</span><span class="p">);</span>
</pre></div>
</div>
<p>Описание функции:</p>
<pre class="highlight literal-block">
void tnt_close(struct tnt_stream *s)
void tnt_stream_free(struct tnt_stream *s)
</pre>
</div>
<div class="section" id="example-2">
<h5>7.10.2. Пример 2<a class="headerlink" href="#example-2" title="Ссылка на этот заголовок">¶</a></h5>
<p>Далее приводится еще один пример полноценной программы на языке C, которая осуществляет выборку по индекс-ключу <code class="docutils literal"><span class="pre">[99999]</span></code> из пространства <code class="docutils literal"><span class="pre">examples</span></code> с помощью высокоуровневого Tarantool API для языка C. Для вывода результатов в этой программе используются функции из библиотеки <a class="reference external" href="http://rtsisyk.github.io/msgpuck/">MsgPuck</a>. Эти функции нужны для декодирования массивов значений в формате <a class="reference external" href="https://en.wikipedia.org/wiki/MessagePack">MessagePack</a>.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;tarantool/tarantool.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;tarantool/tnt_net.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;tarantool/tnt_opt.h&gt;</span><span class="cp"></span>

<span class="cp">#define MP_SOURCE 1</span>
<span class="cp">#include</span> <span class="cpf">&lt;msgpuck.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">tnt_stream</span> <span class="o">*</span><span class="n">tnt</span> <span class="o">=</span> <span class="n">tnt_net</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="n">tnt_set</span><span class="p">(</span><span class="n">tnt</span><span class="p">,</span> <span class="n">TNT_OPT_URI</span><span class="p">,</span> <span class="s">&quot;localhost:3301&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tnt_connect</span><span class="p">(</span><span class="n">tnt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Connection refused</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">struct</span> <span class="n">tnt_stream</span> <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">tnt_object</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="n">tnt_object_format</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span> <span class="s">&quot;[%d]&quot;</span><span class="p">,</span> <span class="mi">99999</span><span class="p">);</span> <span class="cm">/* кортеж tuple = ключ для поиска */</span>
    <span class="n">tnt_select</span><span class="p">(</span><span class="n">tnt</span><span class="p">,</span> <span class="mi">999</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tuple</span><span class="p">);</span>
    <span class="n">tnt_flush</span><span class="p">(</span><span class="n">tnt</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">tnt_reply</span> <span class="n">reply</span><span class="p">;</span> <span class="n">tnt_reply_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
    <span class="n">tnt</span><span class="o">-&gt;</span><span class="n">read_reply</span><span class="p">(</span><span class="n">tnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="n">code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Select failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">char</span> <span class="n">field_type</span><span class="p">;</span>
    <span class="n">field_type</span> <span class="o">=</span> <span class="n">mp_typeof</span><span class="p">(</span><span class="o">*</span><span class="n">reply</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">field_type</span> <span class="o">!=</span> <span class="n">MP_ARRAY</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;no tuple array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">row_count</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">tuple_count</span> <span class="o">=</span> <span class="n">mp_decode_array</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;tuple count=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tuple_count</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tuple_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">field_type</span> <span class="o">=</span> <span class="n">mp_typeof</span><span class="p">(</span><span class="o">*</span><span class="n">reply</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">field_type</span> <span class="o">!=</span> <span class="n">MP_ARRAY</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;no field array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="kt">uint32_t</span> <span class="n">field_count</span> <span class="o">=</span> <span class="n">mp_decode_array</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;  field count=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">field_count</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">field_count</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">field_type</span> <span class="o">=</span> <span class="n">mp_typeof</span><span class="p">(</span><span class="o">*</span><span class="n">reply</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">field_type</span> <span class="o">==</span> <span class="n">MP_UINT</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">uint64_t</span> <span class="n">num_value</span> <span class="o">=</span> <span class="n">mp_decode_uint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;    value=%lu.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num_value</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">field_type</span> <span class="o">==</span> <span class="n">MP_STR</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str_value</span><span class="p">;</span>
                <span class="kt">uint32_t</span> <span class="n">str_value_length</span><span class="p">;</span>
                <span class="n">str_value</span> <span class="o">=</span> <span class="n">mp_decode_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">str_value_length</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;    value=%.*s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str_value_length</span><span class="p">,</span> <span class="n">str_value</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;wrong field type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">tnt_close</span><span class="p">(</span><span class="n">tnt</span><span class="p">);</span>
    <span class="n">tnt_stream_free</span><span class="p">(</span><span class="n">tuple</span><span class="p">);</span>
    <span class="n">tnt_stream_free</span><span class="p">(</span><span class="n">tnt</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Аналогично первому примеру, сохраните исходный код программы в файле с именем <code class="file docutils literal"><span class="pre">example2.c</span></code>.</p>
<p>Чтобы скомпилировать и слинковать тестовую программу, выполните следующую команду:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> gcc -o example2 example2.c -ltarantool
</pre></div>
</div>
<p>Для запуска программы выполните команду <code class="samp docutils literal"><span class="pre">./example2</span></code>.</p>
<p>В этих двух программах мы привели пример использования лишь двух запросов. Для полноценной работы с Tarantool'ом с помощью C API, пожалуйста, обратитесь к документации из <a class="reference external" href="http://github.com/tarantool/tarantool-c">проекта tarantool-c на GitHub</a>.</p>
</div>
</div>
<div class="section" id="interpreting-function-return-values">
<h4>7.11. Интерпретация возвращаемых значений<a class="headerlink" href="#interpreting-function-return-values" title="Ссылка на этот заголовок">¶</a></h4>
<p>При работе с любым Tarantool-коннектором функции, вызванные с помощью Tarantool'а, возвращают значения в формате MsgPack. Если функция была вызвана через API коннектора, то формат возвращаемых значений будет следующим: скалярные значения возвращаются в виде кортежей (сначала идет идентификатор типа из формата MsgPack, а затем идет значение); все прочие (не скалярные) значения возвращаются в виде групп кортежей (сначала идет идентификатор массива в формате MsgPack, а затем идут скалярные значения). Но если функция была вызвана в рамках бинарного протокола (с помощью команды <code class="docutils literal"><span class="pre">eval</span></code>), а не через API коннектора, то подобных изменений формата возвращаемых значений не происходит.</p>
<p>Далее приводится пример создания Lua-функции. Поскольку эту функцию будет вызывать внешний пользователь 'guest', то нужно настроить привилегии на исполнение с помощью <code class="docutils literal"><span class="pre">grant</span></code>. Эта функция возвращает пустой массив, строку-скаляр, два логических значения и короткое целое число. Значение будут теми же, что описаны в разделе про MsgPack в таблице <a class="reference internal" href="singlehtml.html#msgpack-common-types-and-msgpack-encodings"><span class="std std-ref">Стандартные типы в MsgPack-кодировке</span></a>.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span><span class="o">=</span><span class="mi">3301</span><span class="p">}</span>
<span class="go">2016-03-03 18:45:52.802 [27381] main/101/interactive I&gt; ready to accept requests</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">f</span><span class="p">()</span> <span class="k">return</span> <span class="p">{},</span><span class="s1">&#39;</span><span class="s">a&#39;</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span><span class="mi">127</span><span class="p">;</span> <span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">f&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">guest&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">execute&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">function&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">f&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Далее идет пример программы на C, из который мы вызываем эту Lua-функцию. Хотя в примере использован код на C, результат будет одинаковым, на каком бы языке ни была написана вызываемая программа: Perl, PHP, Python, Go или Java.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;tarantool/tarantool.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;tarantool/tnt_net.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;tarantool/tnt_opt.h&gt;</span><span class="cp"></span>
<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">tnt_stream</span> <span class="o">*</span><span class="n">tnt</span> <span class="o">=</span> <span class="n">tnt_net</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>            <span class="cm">/* НАСТРОЙКА */</span>
  <span class="n">tnt_set</span><span class="p">(</span><span class="n">tnt</span><span class="p">,</span> <span class="n">TNT_OPT_URI</span><span class="p">,</span> <span class="s">&quot;localhost:3301&quot;</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">tnt_connect</span><span class="p">(</span><span class="n">tnt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>                        <span class="cm">/* СОЕДИНЕНИЕ */</span>
       <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Connection refused</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
       <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">struct</span> <span class="n">tnt_stream</span> <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">tnt_object</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>       <span class="cm">/* СОЗДАНИЕ ЗАПРОСА */</span>
   <span class="k">struct</span> <span class="n">tnt_stream</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">tnt_object</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
   <span class="n">tnt_object_add_array</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
   <span class="k">struct</span> <span class="n">tnt_request</span> <span class="o">*</span><span class="n">req1</span> <span class="o">=</span> <span class="n">tnt_request_call</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span> <span class="cm">/* ВЫЗОВ function f() */</span>
   <span class="n">tnt_request_set_funcz</span><span class="p">(</span><span class="n">req1</span><span class="p">,</span> <span class="s">&quot;f&quot;</span><span class="p">);</span>
   <span class="n">tnt_request_set_tuple</span><span class="p">(</span><span class="n">req1</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
   <span class="kt">uint64_t</span> <span class="n">sync1</span> <span class="o">=</span> <span class="n">tnt_request_compile</span><span class="p">(</span><span class="n">tnt</span><span class="p">,</span> <span class="n">req1</span><span class="p">);</span>
   <span class="n">tnt_flush</span><span class="p">(</span><span class="n">tnt</span><span class="p">);</span>                                    <span class="cm">/* ОТПРАВКА ЗАПРОСА */</span>
   <span class="k">struct</span> <span class="n">tnt_reply</span> <span class="n">reply</span><span class="p">;</span>  <span class="n">tnt_reply_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>   <span class="cm">/* ПОЛУЧЕНИЕ ОТВЕТА */</span>
   <span class="n">tnt</span><span class="o">-&gt;</span><span class="n">read_reply</span><span class="p">(</span><span class="n">tnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="n">code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Call failed %lu.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reply</span><span class="p">.</span><span class="n">code</span><span class="p">);</span>
     <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">reply</span><span class="p">.</span><span class="n">data</span><span class="p">;</span><span class="cm">/* ВЫВОД ОТВЕТА */</span>
   <span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">reply</span><span class="p">.</span><span class="n">data_end</span><span class="p">)</span>
   <span class="p">{</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%x &quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
     <span class="o">++</span><span class="n">p</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
   <span class="n">tnt_close</span><span class="p">(</span><span class="n">tnt</span><span class="p">);</span>                                    <span class="cm">/* ЗАВЕРШЕНИЕ */</span>
   <span class="n">tnt_stream_free</span><span class="p">(</span><span class="n">tuple</span><span class="p">);</span>
   <span class="n">tnt_stream_free</span><span class="p">(</span><span class="n">tnt</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>По завершении программа выведет на экран следующие значения:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">dd 0 0 0 5 90 91 a1 61 91 c2 91 c3 91 7f</span>
</pre></div>
</div>
<p>Первые пять байт — <code class="docutils literal"><span class="pre">dd</span> <span class="pre">0</span> <span class="pre">0</span> <span class="pre">0</span> <span class="pre">5</span></code> — это фрагмент данных в формате MsgPack, означающий &quot;32-битный заголовок массива со значением 5&quot; (см. <a class="reference external" href="http://github.com/msgpack/msgpack/blob/master/spec.md">спецификацию на формат MsgPack</a>). Остальные значения описаны в таблице <a class="reference internal" href="singlehtml.html#msgpack-common-types-and-msgpack-encodings"><span class="std std-ref">Стандартные типы в MsgPack-кодировке</span></a>.</p>
</div>
</div>
<span id="document-book/modules"></span><div class="section" id="modules">
<span id="id1"></span><h3>8. Модули<a class="headerlink" href="#modules" title="Ссылка на этот заголовок">¶</a></h3>
<p>Возможности Tarantool'а можно расширять с помощью модулей. В языке Lua их называют &quot;rocks&quot;. Если вы незнакомы с языком Lua, то мы рекомендуем пройти <a class="reference external" href="http://lua-users.org/wiki/ModulesTutorial">краткий обучающий курс по Lua</a>, прежде чем читать эту главу.</p>
<div class="section" id="installing-an-existing-module">
<h4>8.1. Установка существующего модуля<a class="headerlink" href="#installing-an-existing-module" title="Ссылка на этот заголовок">¶</a></h4>
<p>Модули, созданные командой Tarantool'а и членами сообщества разработчиков, выложены на <a class="reference external" href="http://rocks.tarantool.org">rocks.tarantool.org</a>. Про некоторые из этих модулей — <a class="reference internal" href="singlehtml.html#expirationd-module"><span class="std std-ref">expirationd</span></a>, <a class="reference internal" href="singlehtml.html#dbms-modules-mysql-example"><span class="std std-ref">mysql</span></a>, <a class="reference internal" href="singlehtml.html#dbms-modules-postgresql-example"><span class="std std-ref">postgresql</span></a>, <a class="reference internal" href="singlehtml.html#shard-module"><span class="std std-ref">shard</span></a> -- подробнее говорится в других разделах текущей документации.</p>
<p><strong>Шаг 1:</strong> Установите LuaRocks. Общее описание того, как установить LuaRocks в Unix-системе, приводится в <a class="reference external" href="http://luarocks.org/#quick-start">кратком руководстве по LuaRocks</a>. Например, установить LuaRocks в Ubuntu можно следующей командой:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> sudo apt-get install luarocks
</pre></div>
</div>
<p><strong>Шаг 2:</strong> Добавьте репозиторий Tarantool'а в список rocks-серверов. Для этого добавьте <a class="reference external" href="http://rocks.tarantool.org">rocks.tarantool.org</a> в файл <code class="file docutils literal"><span class="pre">.luarocks/config.lua</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> mkdir ~/.luarocks
<span class="gp">$</span> <span class="nb">echo</span> <span class="s2">&quot;rocks_servers = {[[http://rocks.tarantool.org/]]}&quot;</span> &gt;&gt; ~/.luarocks/config.lua
</pre></div>
</div>
<p>Теперь можно:</p>
<ul>
<li><p class="first">искать существующие модули в общем репозитории</p>
<pre class="highlight literal-block">
$ luarocks search <em>module-name</em>
</pre>
</li>
<li><p class="first">добавлять новые модули в свой локальный репозиторий</p>
<pre class="highlight literal-block">
$ luarocks install <em>module-name</em> --local
</pre>
</li>
<li><p class="first">загружать любой модуль для Tarantool'а с помощью <code class="docutils literal"><span class="pre">require</span></code></p>
<pre class="highlight literal-block">
tarantool&gt; <em>local-name</em> = require('<em>module-name</em>')
</pre>
</li>
</ul>
<p>(вот почему многие примеры в этой документации начинаются с вызова <code class="docutils literal"><span class="pre">require</span></code>.)</p>
<p>Далее на странице <a class="reference external" href="https://github.com/tarantool/rocks">репозитория &quot;tarantool/rocks&quot; на GitHub</a> вы можете посмотреть примеры модулей и инструкции по добавлению собственных модулей в общий репозиторий.</p>
</div>
<div class="section" id="creating-a-new-lua-module-locally">
<h4>8.2. Создание нового модуля на языке Lua<a class="headerlink" href="#creating-a-new-lua-module-locally" title="Ссылка на этот заголовок">¶</a></h4>
<p>Для примера создадим новый Lua-файл с именем <code class="file docutils literal"><span class="pre">mymodule.lua</span></code>, в котором опишем экспортируемую функцию с некоторым именем, а затем с помощью Tarantool'а загрузим и просмотрим наш новый модуль и вызовем описанную в нем функцию.</p>
<p>Lua-файл в нашем примере будет таким:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- mymodule - простейший Lua-модуль для Tarantool&#39;а</span>
<span class="kd">local</span> <span class="n">exports</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">exports</span><span class="p">.</span><span class="n">myfun</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Hello&#39;</span><span class="p">,</span> <span class="n">input_string</span><span class="p">)</span>
<span class="k">end</span>
<span class="k">return</span> <span class="n">exports</span>
</pre></div>
</div>
<p>Для загрузки и просмотра модуля, а также вызова описанной в нем функции, выполним следующие команды:</p>
<pre class="highlight literal-block">
tarantool&gt; <strong>mymodule = require('mymodule')</strong>
---
...

tarantool&gt; <strong>mymodule</strong>
---
- myfun: 'function: 0x405edf20'
...

tarantool&gt; <strong>mymodule.myfun(os.getenv('USER'))</strong>
Hello world
---
...
</pre>
</div>
<div class="section" id="creating-a-new-c-c-module-locally">
<span id="modules-example-c"></span><h4>8.3. Создание нового модуля на языке C/C++<a class="headerlink" href="#creating-a-new-c-c-module-locally" title="Ссылка на этот заголовок">¶</a></h4>
<p>Для примера создадим новый C-файл с именем <code class="file docutils literal"><span class="pre">mymodule.c</span></code>, в котором опишем экспортируемую функцию с некоторым именем, а затем с помощью Tarantool'а загрузим и просмотрим наш новый модуль и вызовем описанную в нем функцию.</p>
<p>Обратите внимание, что для корректной работы требуется заранее установить модуль <code class="docutils literal"><span class="pre">tarantool-dev</span></code>.</p>
<p>C-файл в нашем примере будет таким:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cm">/* mycmodule - простейший C-модуль для Tarantool&#39;а */</span>
<span class="cp">#include</span> <span class="cpf">&lt;lua.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;lauxlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;lualib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;tarantool.h&gt;</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">myfun</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;Usage: myfun(name)&quot;</span><span class="p">);</span>

    <span class="cm">/* Get first argument */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="cm">/* Push one result to Lua stack */</span>
    <span class="n">lua_pushfstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;Hello, %s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* the function returns one result */</span>
<span class="p">}</span>

<span class="n">LUA_API</span> <span class="kt">int</span>
<span class="nf">luaopen_mycmodule</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">luaL_reg</span> <span class="n">reg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span> <span class="s">&quot;myfun&quot;</span><span class="p">,</span> <span class="n">myfun</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
    <span class="p">};</span>
    <span class="n">luaL_register</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;mycmodule&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>С помощью <strong class="program">gcc</strong> скомпилируем наш код в виде shared-библиотеки (без префикса &quot;lib&quot;), а затем просмотрим ее содержимое с помощью <strong class="program">ls</strong>:</p>
<pre class="highlight literal-block">
$ <strong>gcc mycmodule.c -shared -fPIC -I/usr/include/tarantool -o mycmodule.so</strong>
$ <strong>ls mycmodule.so -l</strong>
-rwxr-xr-x 1 roman roman 7272 Jun  3 16:51 mycmodule.so
</pre>
<p>Для автоматизации сборки рекомендуется использовать <a class="reference external" href="https://github.com/tarantool/modulekit">CMake-скрипты для Tarantool'а</a>.</p>
<p>Для загрузки и просмотра модуля, а также вызова описанной в нем функции, выполним следующие команды:</p>
<pre class="highlight literal-block">
tarantool&gt; <strong>myсmodule = require('myсmodule')</strong>
---
...
tarantool&gt; <strong>myсmodule</strong>
---
- myfun: 'function: 0x4100ec98'
...
tarantool&gt; <strong>mycmodule.myfun(os.getenv('USER'))</strong>
---
- Hello, world
...
</pre>
<p>Вы можете аналогичным образом создавать модули на C++ при условии, что в их коде не будут выбрасываться исключения.</p>
</div>
<div class="section" id="creating-a-mixed-lua-c-module-locally">
<h4>8.4. Создание нового модуля на смеси языков Lua/C<a class="headerlink" href="#creating-a-mixed-lua-c-module-locally" title="Ссылка на этот заголовок">¶</a></h4>
<ol class="arabic simple">
<li><p class="first">Создайте новый Lua-модуль и назовите его, например, <code class="docutils literal"><span class="pre">myfunmodule</span></code>.</p>
</li>
<li><p class="first">Создайте (вложенный) модуль на C и назовите его, например, <code class="docutils literal"><span class="pre">myfunmodule.internal</span></code>.</p>
</li>
<li><p class="first">Загрузите новый C-модуль из Lua-кода с помощью <code class="samp docutils literal"><span class="pre">require('myfunmodule.internal')</span></code>, а затем сделайте для него обертку или вызывайте его функции напрямую.</p>
</li>
</ol>
<p>Примеры модулей на смеси языков Lua/C можно посмотреть в <a class="reference external" href="https://github.com/tarantool/http">репозитории &quot;tarantool/http&quot; на GitHub</a>.</p>
</div>
<div class="section" id="tips-for-special-situations">
<h4>8.5. Примечания для особых случаев<a class="headerlink" href="#tips-for-special-situations" title="Ссылка на этот заголовок">¶</a></h4>
<ul>
<li><p class="first">В среде Lua все загруженные модули кешируются в таблице <code class="docutils literal"><span class="pre">package.loaded</span></code>. Чтобы перегрузить какой-либо модуль с диска, укажите для его ключа значение <cite>nil</cite>:</p>
<pre class="highlight literal-block">
tarantool&gt; package.loaded['<em>modulename</em>'] = nil
</pre>
</li>
<li><p class="first">Для поиска <code class="file docutils literal"><span class="pre">.lua</span></code>-модулей используйте команду <code class="docutils literal"><span class="pre">package.path</span></code>, а для поиска бинарных модулей на C используйте команду <code class="docutils literal"><span class="pre">package.cpath</span></code>.</p>
<pre class="highlight literal-block">
tarantool&gt; <strong>package.path</strong>
---
- ./?.lua;./?/init.lua;/home/roman/.luarocks/share/lua/5.1/?.lua;/home/roma
n/.luarocks/share/lua/5.1/?/init.lua;/home/roman/.luarocks/share/lua/?.lua;
/home/roman/.luarocks/share/lua/?/init.lua;/usr/share/tarantool/?.lua;/usr/
share/tarantool/?/init.lua;./?.lua;/usr/local/share/luajit-2.0.3/?.lua;/usr
/local/share/lua/5.1/?.lua;/usr/local/share/lua/5.1/?/init.lua
...
tarantool&gt; <strong>package.cpath</strong>
---
- ./?.so;/home/roman/.luarocks/lib/lua/5.1/?.so;/home/roman/.luarocks/lib/l
ua/?.so;/usr/lib/tarantool/?.so;./?.so;/usr/local/lib/lua/5.1/?.so;/usr/loc
al/lib/lua/5.1/loadall.so
...
</pre>
<p>Знаки вопроса стоят вместо имени модуля, которое было указано ранее при вызове <code class="extsamp docutils literal"><span class="pre">require('</span><em><span class="pre">имя_модуля</span></em><span class="pre">')</span></code>.</p>
</li>
<li><p class="first">Для просмотра внутреннего состояния прямо изнутри Lua-модуля используйте <code class="samp docutils literal"><span class="pre">state</span></code> и соответствующую локальную переменную в рамках модуля:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- mymodule</span>
<span class="kd">local</span> <span class="n">exports</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kd">local</span> <span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">exports</span><span class="p">.</span><span class="n">myfun</span> <span class="o">=</span> <span class="k">function</span><span class="p">()</span>
    <span class="n">state</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">42</span> <span class="c1">-- используем state</span>
<span class="k">end</span>
<span class="k">return</span> <span class="n">exports</span>
</pre></div>
</div>
</li>
<li><p class="first">Обратите внимание, что в текущей документации в примерах Lua-кода используются <em>локальные</em> переменные. Будьте аккуратны, если в своих модулях вы будете использовать <em>глобальные</em> переменные, поскольку пользователи ваших модулей могут не знать об этих переменных.</p>
</li>
</ul>
</div>
</div>
<span id="document-book/app/a_errcodes"></span><div class="section" id="appendix-a-list-of-error-codes">
<h3>9. Приложение A. Коды ошибок<a class="headerlink" href="#appendix-a-list-of-error-codes" title="Ссылка на этот заголовок">¶</a></h3>
<p>In the current version of the binary protocol, error message, which is normally
more descriptive than error code, is not present in server response. The actual
message may contain a file name, a detailed reason or operating system error code.
All such messages, however, are logged in the error log. Below follow only general
descriptions of some popular codes. A complete list of errors can be found in file
<a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.7/src/box/errcode.h">errcode.h</a> in the source tree.</p>
<blockquote>
<div><div class="table container">
<p><strong>List of error codes</strong></p>
<table border="1" class="left-align-column-1 left-align-column-2 docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>ER_NONMASTER</td>
<td>Can't modify data on a replication slave.</td>
</tr>
<tr class="row-even"><td>ER_ILLEGAL_PARAMS</td>
<td>Illegal parameters. Malformed protocol
message.</td>
</tr>
<tr class="row-odd"><td>ER_MEMORY_ISSUE</td>
<td>Out of memory:
<a class="reference internal" href="singlehtml.html#cfg-storage-slab-alloc-arena"><span class="std std-ref">slab_alloc_arena</span></a>
limit has been reached.</td>
</tr>
<tr class="row-even"><td>ER_WAL_IO</td>
<td>Failed to write to disk. May mean: failed
to record a change in the
write-ahead log. Some sort of disk error.</td>
</tr>
<tr class="row-odd"><td>ER_KEY_PART_COUNT</td>
<td>Key part count is not the same as
index part count</td>
</tr>
<tr class="row-even"><td>ER_NO_SUCH_SPACE</td>
<td>The specified space does not exist.</td>
</tr>
<tr class="row-odd"><td>ER_NO_SUCH_INDEX</td>
<td>The specified index in the specified
space does not exist.</td>
</tr>
<tr class="row-even"><td>ER_PROC_LUA</td>
<td>An error occurred inside a Lua procedure.</td>
</tr>
<tr class="row-odd"><td>ER_FIBER_STACK</td>
<td>The recursion limit was reached when
creating a new fiber. This usually
indicates that a stored procedure is
recursively invoking itself too often.</td>
</tr>
<tr class="row-even"><td>ER_UPDATE_FIELD</td>
<td>An error occurred during update of a
field.</td>
</tr>
<tr class="row-odd"><td>ER_TUPLE_FOUND</td>
<td>A duplicate key exists in a unique
index.</td>
</tr>
</tbody>
</table>
</div>
</div></blockquote>
</div>
<span id="document-book/app/b_internals"></span><div class="section" id="appendix-b-internals">
<span id="b-internals"></span><h3>10. Приложение B. Детали реализации<a class="headerlink" href="#appendix-b-internals" title="Ссылка на этот заголовок">¶</a></h3>
<p>This section is for advanced users or users who wish to
know more about how the Tarantool program works. The
discussion here is technical but generalized.
The ultimate authority is the code.</p>
<div class="section" id="data-persistence-and-the-wal-file-format">
<h4>10.1. Сохранность данных и формат WAL-файла<a class="headerlink" href="#data-persistence-and-the-wal-file-format" title="Ссылка на этот заголовок">¶</a></h4>
<p>To maintain data persistence, Tarantool writes each data change request (INSERT,
UPDATE, DELETE, REPLACE) into a write-ahead log (WAL) file in the
<a class="reference internal" href="singlehtml.html#cfg-basic-wal-dir"><span class="std std-ref">wal_dir</span></a> directory. A new WAL file is created for every
<a class="reference internal" href="singlehtml.html#cfg-binary-logging-snapshots-rows-per-wal"><span class="std std-ref">rows_per_wal</span></a> records. Each data change request gets
assigned a continuously growing 64-bit log sequence number. The name of the WAL
file is based on the log sequence number of the first record in the file, plus
an extension <code class="docutils literal"><span class="pre">.xlog</span></code>.</p>
<p>Apart from a log sequence number and the data change request (its format is the
same as in the binary protocol and is described in <a class="reference external" href="http://tarantool.org/doc/dev_guide/box-protocol.html">doc/dev_guide/box-protocol.html</a>),
each WAL record contains a header, some metadata, and then the data formatted
according to <a class="reference external" href="https://en.wikipedia.org/wiki/MessagePack">msgpack</a> rules. For example this is what the WAL file looks like
after the first INSERT request (&quot;s:insert({1})&quot;) for the introductory sandbox
exercise &quot;<a class="reference internal" href="singlehtml.html#user-guide-getting-started-first-database"><span class="std std-ref">Starting Tarantool and making your first database</span></a> “.
On the left are the hexadecimal bytes that one would see with:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> hexdump 00000000000000000000.xlog
</pre></div>
</div>
<p>and on the right are comments.</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>Hex dump of WAL file       Comment
--------------------       -------
58 4c 4f 47 0a             File header: &quot;XLOG\n&quot;
30 2e 31 32 0a             File header: &quot;0.12\n&quot; = version
...                        (not shown = more header + tuples for system spaces)
d5 ba 0b ab                Magic row marker always = 0xab0bbad5 if version 0.12
19 00                      Length, not including length of header, = 25 bytes
ce 16 a4 38 6f             Record header: previous crc32, current crc32,
a7 cc 73 7f 00 00 66 39
84                         msgpack code meaning &quot;Map of 4 elements&quot; follows
00 02                         element#1: tag=request type, value=0x02=IPROTO_INSERT
02 01                         element#2: tag=server id, value=0x01
03 04                         element#3: tag=lsn, value=0x04
04 cb 41 d4 e2 2f 62 fd d5 d4 element#4: tag=timestamp, value=an 8-byte &quot;Double&quot;
82                         msgpack code meaning &quot;map of 2 elements&quot; follows
10 cd 02 00                   element#1: tag=space id, value=512, big byte first
21 91 01                      element#2: tag=tuple, value=1-element fixed array={1}
</pre></div>
</div>
<p>Tarantool processes requests atomically: a change is either accepted and recorded
in the WAL, or discarded completely. Let's clarify how this happens, using the
REPLACE request as an example:</p>
<ol class="arabic simple">
<li>The server attempts to locate the original tuple by primary key. If found, a
reference to the tuple is retained for later use.</li>
<li>The new tuple is validated. If for example it does not contain an indexed
field, or it has an indexed field whose type does not match the type
according to the index definition, the change is aborted.</li>
<li>The new tuple replaces the old tuple in all existing indexes.</li>
<li>A message is sent to WAL writer running in a separate thread, requesting that
the change be recorded in the WAL. The server switches to work on the next
request until the write is acknowledged.</li>
<li>On success, a confirmation is sent to the client. On failure, a rollback
procedure is begun. During the rollback procedure, the transaction processor
rolls back all changes to the database which occurred after the first failed
change, from latest to oldest, up to the first failed change. All rolled back
requests are aborted with <code class="xref std std-errcode docutils literal"><span class="pre">ER_WAL_IO</span></code> error. No new
change is applied while rollback is in progress. When the rollback procedure
is finished, the server restarts the processing pipeline.</li>
</ol>
<p>One advantage of the described algorithm is that complete request pipelining is
achieved, even for requests on the same value of the primary key. As a result,
database performance doesn't degrade even if all requests refer to the same
key in the same space.</p>
<p>The transaction processor thread communicates with the WAL writer thread using
asynchronous (yet reliable) messaging; the transaction processor thread, not
being blocked on WAL tasks, continues to handle requests quickly even at high
volumes of disk I/O. A response to a request is sent as soon as it is ready,
even if there were earlier incomplete requests on the same connection. In
particular, SELECT performance, even for SELECTs running on a connection packed
with UPDATEs and DELETEs, remains unaffected by disk load.</p>
<p>The WAL writer employs a number of durability modes, as defined in configuration
variable <a class="reference internal" href="singlehtml.html#index-wal-mode"><span class="std std-ref">wal_mode</span></a>. It is possible to turn the write-ahead
log completely off, by setting <a class="reference internal" href="singlehtml.html#cfg-binary-logging-snapshots-wal-mode"><span class="std std-ref">wal_mode</span></a> to <em>none</em>. Even
without the write-ahead log it's still possible to take a persistent copy of the
entire data set with the <a class="reference internal" href="singlehtml.html#admin-snapshot"><span class="std std-ref">box.snapshot()</span></a> request.</p>
<p>An .xlog file always contains changes based on the primary key.
Even if the client requested an update or delete using
a secondary key, the record in the .xlog file will contain the primary key.</p>
</div>
<div class="section" id="the-snapshot-file-format">
<h4>10.2. Формат статического файла-снимка<a class="headerlink" href="#the-snapshot-file-format" title="Ссылка на этот заголовок">¶</a></h4>
<p>The format of a snapshot .snap file is nearly the same as the format of a WAL .xlog file.
However, the snapshot header differs: it contains the server's global unique identifier
and the snapshot file's position in history, relative to earlier snapshot files.
Also, the content differs: an .xlog file may contain records for any data-change
requests (inserts, updates, upserts, and deletes), a .snap file may only contain records
of inserts to memtx spaces.</p>
<p>Primarily, the .snap file's records are ordered by space id. Therefore the records of
system spaces, such as _schema and _space and _index and _func and _priv and _cluster,
will be at the start of the .snap file, before the records of any spaces
that were created by users.</p>
<p>Secondarily, the .snap file's records are ordered by primary key within space id.</p>
</div>
<div class="section" id="the-recovery-process">
<h4>10.3. Процесс восстановления<a class="headerlink" href="#the-recovery-process" title="Ссылка на этот заголовок">¶</a></h4>
<p>The recovery process begins when box.cfg{} happens for the
first time after the Tarantool server starts.</p>
<p>The recovery process must recover the databases
as of the moment when the server was last shut down. For this it may
use the latest snapshot file and any WAL files that were written
after the snapshot. One complicating factor is that Tarantool
has two engines -- the memtx data must be reconstructed entirely
from the snapshot and the WAL files, while the vinyl data will
be on disk but might require updating around the time of a checkpoint.
(When a snapshot happens, Tarantool tells the vinyl engine to
make a checkpoint, and the snapshot operation is rolled back if
anything goes wrong, so vinyl's checkpoint is at least as fresh
as the snapshot file.)</p>
<dl class="docutils">
<dt>Step 1</dt>
<dd>Read the configuration parameters in the <code class="docutils literal"><span class="pre">box.cfg{}</span></code> request.
Parameters which affect recovery may include <a class="reference internal" href="singlehtml.html#cfg-basic-work-dir"><span class="std std-ref">work_dir</span></a>,
<a class="reference internal" href="singlehtml.html#cfg-basic-wal-dir"><span class="std std-ref">wal_dir</span></a>, <a class="reference internal" href="singlehtml.html#cfg-basic-snap-dir"><span class="std std-ref">snap_dir</span></a>, <a class="reference internal" href="singlehtml.html#cfg-basic-vinyl-dir"><span class="std std-ref">vinyl_dir</span></a>,
<a class="reference internal" href="singlehtml.html#cfg-binary-logging-snapshots-panic-on-snap-error"><span class="std std-ref">panic_on_snap_error</span></a>,
and <a class="reference internal" href="singlehtml.html#cfg-binary-logging-snapshots-panic-on-wal-error"><span class="std std-ref">panic_on_wal_error</span></a>.</dd>
<dt>Step 2</dt>
<dd>Find the latest snapshot file. Use its data to reconstruct the in-memory
databases. Instruct the vinyl engine to recover to the latest checkpoint.</dd>
</dl>
<p>There are actually two variations of the reconstruction procedure for the memtx
databases, depending whether the recovery process is &quot;default&quot;.</p>
<p>If it is default (<code class="docutils literal"><span class="pre">panic_on_snap_error</span></code> is <code class="docutils literal"><span class="pre">true</span></code> and <code class="docutils literal"><span class="pre">panic_on_wal_error</span></code>
is <code class="docutils literal"><span class="pre">true</span></code>), memtx can read data in the snapshot with all indexes disabled.
First, all tuples are read into memory. Then, primary keys are built in bulk,
taking advantage of the fact that the data is already sorted by primary key
within each space.</p>
<p>If it is not default (<code class="docutils literal"><span class="pre">panic_on_snap_error</span></code> is <code class="docutils literal"><span class="pre">false</span></code> or <code class="docutils literal"><span class="pre">panic_on_wal_error</span></code>
is <code class="docutils literal"><span class="pre">false</span></code>), Tarantool performs additional checking. Indexes are enabled at
the start, and tuples are added one by one. This means that any unique-key
constraint violations will be caught, and any duplicates will be skipped.
Normally there will be no constraint violations or duplicates, so these checks
are only made if an error has occurred.</p>
<dl class="docutils">
<dt>Step 2</dt>
<dd>Find the WAL file that was made at the time of, or after, the snapshot file.
Read its log entries until the log-entry LSN is greater than the LSN of the
snapshot, or greater than the LSN of the vinyl checkpoint. This is the
recovery process's &quot;start position&quot;; it matches the current state of the engines.</dd>
<dt>Step 3</dt>
<dd>Redo the log entries, from the start position to the end of the WAL. The
engine skips a redo instruction if it is older than the engine's checkpoint.</dd>
<dt>Step 4</dt>
<dd>For the memtx engine, re-create all secondary indexes.</dd>
</dl>
</div>
<div class="section" id="server-startup-with-replication">
<span id="b-internals-replication"></span><h4>10.4. Запуск сервера с репликацией<a class="headerlink" href="#server-startup-with-replication" title="Ссылка на этот заголовок">¶</a></h4>
<p>In addition to the recovery process described above, the server must take
additional steps and precautions if <a class="reference internal" href="singlehtml.html#index-box-replication"><span class="std std-ref">replication</span></a> is
enabled.</p>
<p>Once again the startup procedure is initiated by the <code class="docutils literal"><span class="pre">box.cfg{}</span></code> request.
One of the box.cfg parameters may be <a class="reference internal" href="singlehtml.html#cfg-replication-replication-source"><span class="std std-ref">replication_source</span></a>. We will
refer to this server, which is starting up due to box.cfg, as the &quot;local&quot; server
to distinguish it from the other servers in a cluster, which we will refer to as
&quot;distant&quot; servers.</p>
<p><em>If there is no snapshot .snap file and replication_source is empty</em>: <br />
then the local server assumes it is an unreplicated &quot;standalone&quot; server, or is
the first server of a new replication cluster. It will generate new UUIDs for
itself and for the cluster. The server UUID is stored in the _cluster space; the
cluster UUID is stored in the _schema space. Since a snapshot contains all the
data in all the spaces, that means the local server's snapshot will contain the
server UUID and the cluster UUID. Therefore, when the local server restarts on
later occasions, it will be able to recover these UUIDs when it reads the .snap
file.</p>
<p><em>If there is no snapshot .snap file and replication_source is not empty
and the _cluster space contains no other server UUIDs</em>: <br />
then the local server assumes it is not a standalone server, but is not yet part
of a cluster. It must now join the cluster. It will send its server UUID to the
first distant server which is listed in replication_source, which will act as a
master. This is called the &quot;join request&quot;. When a distant server receives a join
request, it will send back:</p>
<ol class="arabic simple">
<li>the distant server's cluster UUID,</li>
<li>the contents of the distant server's .snap file. <br />
When the local server receives this information, it puts the cluster UUID in
its _schema space, puts the distant server's UUID and connection information
in its _cluster space, and makes a snapshot containing all the data sent by
the distant server. Then, if the local server has data in its WAL .xlog
files, it sends that data to the distant server. The distant server will
receive this and update its own copy of the data, and add the local server's
UUID to its _cluster space.</li>
</ol>
<p><em>If there is no snapshot .snap file and replication_source is not empty
and the _cluster space contains other server UUIDs</em>: <br />
then the local server assumes it is not a standalone server, and is already part
of a cluster. It will send its server UUID and cluster UUID to all the distant
servers which are listed in replication_source. This is called the &quot;on-connect
handshake&quot;. When a distant server receives an on-connect handshake: <br /></p>
<ol class="arabic simple">
<li>the distant server compares its own copy of the cluster UUID to the one in
the on-connect handshake. If there is no match, then the handshake fails and
the local server will display an error.</li>
<li>the distant server looks for a record of the connecting instance in its
_cluster space. If there is none, then the handshake fails. <br />
Otherwise the handshake is successful. The distant server will read any new
information from its own .snap and .xlog files, and send the new requests to
the local server.</li>
</ol>
<p>In the end ... the local server knows what cluster it belongs to, the distant
server knows that the local server is a member of the cluster, and both servers
have the same database contents.</p>
<p><em>If there is a snapshot file and replication source is not empty</em>: <br />
first the local server goes through the recovery process described in the
previous section, using its own .snap and .xlog files. Then it sends a
&quot;subscribe&quot; request to all the other servers of the cluster. The subscribe
request contains the server vector clock. The vector clock has a collection of
pairs 'server id, lsn' for every server in the _cluster system space. Each
distant server, upon receiving a subscribe request, will read its .xlog files'
requests and send them to the local server if (lsn of .xlog file request) is
greater than (lsn of the vector clock in the subscribe request). After all the
other servers of the cluster have responded to the local server's subscribe
request, the server startup is complete.</p>
<p>The following temporary limitations apply for version 1.7:</p>
<ul class="simple">
<li>The URIs in replication_source should all be in the same order on all servers.
This is not mandatory but is an aid to consistency.</li>
<li>The servers of a cluster should be started up at slightly different times.
This is not mandatory but prevents a situation where each server is waiting
for the other server to be ready.</li>
<li>The maximum number of entries in the _cluster space is 32. Tuples for
out-of-date replicas are not automatically re-used, so if this 32-replica
limit is reached, users may have to reorganize the _cluster space manually.</li>
</ul>
</div>
</div>
<span id="document-book/app/c_lua_tutorial"></span><div class="section" id="appendix-c-lua-tutorials">
<h3>11. Приложение C. Учебные примеры на языке Lua<a class="headerlink" href="#appendix-c-lua-tutorials" title="Ссылка на этот заголовок">¶</a></h3>
<p>There are three tutorials:
<a class="reference internal" href="#c-lua-tutorial-insert-one-million-tuples"><span class="std std-ref">Insert one million tuples with a Lua stored procedure</span></a>,
<a class="reference internal" href="#c-lua-tutorial-sum-a-json-field"><span class="std std-ref">Sum a JSON field for all tuples</span></a>,
<a class="reference internal" href="#c-lua-tutorial-indexed-pattern-search"><span class="std std-ref">Indexed pattern search</span></a>.</p>
<div class="section" id="insert-one-million-tuples-with-a-lua-stored-procedure">
<span id="c-lua-tutorial-insert-one-million-tuples"></span><h4>11.1. Вставка 1 млн кортежей с помощью хранимой процедуры на языке Lua<a class="headerlink" href="#insert-one-million-tuples-with-a-lua-stored-procedure" title="Ссылка на этот заголовок">¶</a></h4>
<p>This is an exercise assignment: “Insert one million tuples. Each tuple should
have a constantly-increasing numeric primary-key field and a random alphabetic
10-character string field.”</p>
<p>The purpose of the exercise is to show what Lua functions look like inside
Tarantool. It will be necessary to employ the Lua math library, the Lua string
library, the Tarantool box library, the Tarantool box.tuple library, loops, and
concatenations. It should be easy to follow even for a person who has not used
either Lua or Tarantool before. The only requirement is a knowledge of how other
programming languages work and a memory of the first two chapters of this manual.
But for better understanding, follow the comments and the links, which point to
the Lua manual or to elsewhere in this Tarantool manual. To further enhance
learning, type the statements in with the tarantool client while reading along.</p>
<div class="section" id="configure">
<h5>11.1.1. Configure<a class="headerlink" href="#configure" title="Ссылка на этот заголовок">¶</a></h5>
<p>We are going to use the &quot;tarantool_sandbox&quot; that was created in section
<a class="reference internal" href="singlehtml.html#user-guide-getting-started-first-database"><span class="std std-ref">first database</span></a>. So there is a single space, and a numeric primary key,
and a running tarantool server which also serves as a client.</p>
</div>
<div class="section" id="delimiter">
<h5>11.1.2. Delimiter<a class="headerlink" href="#delimiter" title="Ссылка на этот заголовок">¶</a></h5>
<p>In earlier versions of Tarantool, multi-line functions had to be
enclosed within &quot;delimiters&quot;. They are no longer necessary, and
so they will not be used in this tutorial. However, they are still
supported. Users who wish to use delimiters, or users of
older versions of Tarantool, should check the syntax description for
<a class="reference internal" href="singlehtml.html#administration-setting-delimiter"><span class="std std-ref">declaring a delimiter</span></a> before proceeding.</p>
</div>
<div class="section" id="create-a-function-that-returns-a-string">
<h5>11.1.3. Create a function that returns a string<a class="headerlink" href="#create-a-function-that-returns-a-string" title="Ссылка на этот заголовок">¶</a></h5>
<p>We will start by making a function that returns a fixed string, “Hello world”.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">string_function</span><span class="p">()</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="s">hello world&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The word &quot;<code class="docutils literal"><span class="pre">function</span></code>&quot; is a Lua keyword -- we're about to go into Lua. The
function name is string_function. The function has one executable statement,
<code class="docutils literal"><span class="pre">return</span> <span class="pre">&quot;hello</span> <span class="pre">world&quot;</span></code>. The string &quot;hello world&quot; is enclosed in double quotes
here, although Lua doesn't care -- one could use single quotes instead. The
word &quot;<code class="docutils literal"><span class="pre">end</span></code>&quot; means “this is the end of the Lua function declaration.”
To confirm that the function works, we can say</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">string_function</span><span class="p">()</span>
</pre></div>
</div>
<p>Sending <code class="docutils literal"><span class="pre">function-name()</span></code> means “invoke the Lua function.” The effect is
that the string which the function returns will end up on the screen.</p>
<p>For more about Lua strings see Lua manual <a class="reference external" href="http://www.lua.org/pil/2.4.html">chapter 2.4 &quot;Strings&quot;</a> . For more
about functions see Lua manual <a class="reference external" href="http://www.lua.org/pil/5.html">chapter 5 &quot;Functions&quot;</a>.</p>
<p>Теперь вывод на экране выглядит следующим образом:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">string_funciton</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="s2">&quot;</span><span class="s">hello world&quot;</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">string_function</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hello world</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="create-a-function-that-calls-another-function-and-sets-a-variable">
<h5>11.1.4. Create a function that calls another function and sets a variable<a class="headerlink" href="#create-a-function-that-calls-another-function-and-sets-a-variable" title="Ссылка на этот заголовок">¶</a></h5>
<p>Now that <code class="docutils literal"><span class="pre">string_function</span></code> exists, we can invoke it from another
function.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">string_value</span>
  <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">string_value</span>
<span class="k">end</span>
</pre></div>
</div>
<p>We begin by declaring a variable &quot;<code class="docutils literal"><span class="pre">string_value</span></code>&quot;. The word &quot;<code class="docutils literal"><span class="pre">local</span></code>&quot;
means that string_value appears only in <code class="docutils literal"><span class="pre">main_function</span></code>. If we didn't use
&quot;<code class="docutils literal"><span class="pre">local</span></code>&quot; then <code class="docutils literal"><span class="pre">string_value</span></code> would be visible everywhere - even by other
users using other clients connected to this server! Sometimes that's a very
desirable feature for inter-client communication, but not this time.</p>
<p>Then we assign a value to <code class="docutils literal"><span class="pre">string_value</span></code>, namely, the result of
<code class="docutils literal"><span class="pre">string_function()</span></code>. Soon we will invoke <code class="docutils literal"><span class="pre">main_function()</span></code> to check that it
got the value.</p>
<p>For more about Lua variables see Lua manual <a class="reference external" href="http://www.lua.org/pil/4.2.html">chapter 4.2 &quot;Local Variables and Blocks&quot;</a> .</p>
<p>Теперь вывод на экране выглядит следующим образом:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">string_value</span>
<span class="gp">         &gt; </span>  <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="n">string_value</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">main_function</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hello world</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="modify-the-function-so-it-returns-a-one-letter-random-string">
<h5>11.1.5. Modify the function so it returns a one-letter random string<a class="headerlink" href="#modify-the-function-so-it-returns-a-one-letter-random-string" title="Ссылка на этот заголовок">¶</a></h5>
<p>Now that it's a bit clearer how to make a variable, we can change
<code class="docutils literal"><span class="pre">string_function()</span></code> so that, instead of returning a fixed literal
'Hello world&quot;, it returns a random letter between 'A' and 'Z'.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">string_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">random_number</span>
  <span class="kd">local</span> <span class="n">random_string</span>
  <span class="n">random_number</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
  <span class="n">random_string</span> <span class="o">=</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">random_number</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">random_string</span>
<span class="k">end</span>
</pre></div>
</div>
<p>It is not necessary to destroy the old <code class="docutils literal"><span class="pre">string_function()</span></code> contents, they're
simply overwritten. The first assignment invokes a random-number function
in Lua's math library; the parameters mean “the number must be an integer
between 65 and 90.” The second assignment invokes an integer-to-character
function in Lua's string library; the parameter is the code point of the
character. Luckily the ASCII value of 'A' is 65 and the ASCII value of 'Z'
is 90 so the result will always be a letter between A and Z.</p>
<p>For more about Lua math-library functions see Lua users &quot;<a class="reference external" href="http://lua-users.org/wiki/MathLibraryTutorial">Math Library Tutorial</a>&quot;.
For more about Lua string-library functions see Lua users &quot;<a class="reference external" href="http://lua-users.org/wiki/StringLibraryTutorial">String Library Tutorial</a>&quot; .</p>
<p>Once again the <code class="docutils literal"><span class="pre">string_function()</span></code> can be invoked from main_function() which
can be invoked with <code class="docutils literal"><span class="pre">main_function()</span></code>.</p>
<p>Теперь вывод на экране выглядит следующим образом:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">string_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">random_number</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">random_string</span>
<span class="gp">         &gt; </span>  <span class="n">random_number</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="n">random_string</span> <span class="o">=</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">random_number</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="n">random_string</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">main_function</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">C</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
<p>... Well, actually it won't always look like this because <code class="docutils literal"><span class="pre">math.random()</span></code>
produces random numbers. But for the illustration purposes it won't matter
what the random string values are.</p>
</div>
<div class="section" id="modify-the-function-so-it-returns-a-ten-letter-random-string">
<h5>11.1.6. Modify the function so it returns a ten-letter random string<a class="headerlink" href="#modify-the-function-so-it-returns-a-ten-letter-random-string" title="Ссылка на этот заголовок">¶</a></h5>
<p>Now that it's clear how to produce one-letter random strings, we can reach our
goal of producing a ten-letter string by concatenating ten one-letter strings,
in a loop.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">string_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">random_number</span>
  <span class="kd">local</span> <span class="n">random_string</span>
  <span class="n">random_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
  <span class="k">for</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
    <span class="n">random_number</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
    <span class="n">random_string</span> <span class="o">=</span> <span class="n">random_string</span> <span class="o">..</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">random_number</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="n">random_string</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The words &quot;for x = 1,10,1&quot; mean “start with x equals 1, loop until x equals 10,
increment x by 1 for each iteration.” The symbol &quot;..&quot; means &quot;concatenate&quot;, that
is, add the string on the right of the &quot;..&quot; sign to the string on the left of
the &quot;..&quot; sign. Since we start by saying that random_string is &quot;&quot; (a blank
string), the end result is that random_string has 10 random letters. Once
again the <code class="docutils literal"><span class="pre">string_function()</span></code> can be invoked from <code class="docutils literal"><span class="pre">main_function()</span></code> which
can be invoked with <code class="docutils literal"><span class="pre">main_function()</span></code>.</p>
<p>For more about Lua loops see Lua manual <a class="reference external" href="http://www.lua.org/pil/4.3.4.html">chapter 4.3.4 &quot;Numeric for&quot;</a>.</p>
<p>Теперь вывод на экране выглядит следующим образом:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">string_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">random_number</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">random_string</span>
<span class="gp">         &gt; </span>  <span class="n">random_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
<span class="gp">         &gt; </span>  <span class="k">for</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
<span class="gp">         &gt; </span>    <span class="n">random_number</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
<span class="gp">         &gt; </span>    <span class="n">random_string</span> <span class="o">=</span> <span class="n">random_string</span> <span class="o">..</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">random_number</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="k">end</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="n">random_string</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">main_function</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;ZUDJBHKEFM&#39;</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="make-a-tuple-out-of-a-number-and-a-string">
<h5>11.1.7. Make a tuple out of a number and a string<a class="headerlink" href="#make-a-tuple-out-of-a-number-and-a-string" title="Ссылка на этот заголовок">¶</a></h5>
<p>Now that it's clear how to make a 10-letter random string, it's possible to
make a tuple that contains a number and a 10-letter random string, by invoking
a function in Tarantool's library of Lua functions.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">string_value</span><span class="p">,</span> <span class="n">t</span>
  <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="n">string_value</span><span class="p">})</span>
  <span class="k">return</span> <span class="n">t</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Once this is done, t will be the value of a new tuple which has two fields.
The first field is numeric: 1. The second field is a random string. Once again
the <code class="docutils literal"><span class="pre">string_function()</span></code> can be invoked from <code class="docutils literal"><span class="pre">main_function()</span></code> which can be
invoked with  <code class="docutils literal"><span class="pre">main_function()</span></code>.</p>
<p>См. также примеры кортежей в разделе про вложенный модуль <a class="reference internal" href="singlehtml.html#box-tuple"><span class="std std-ref">box.tuple</span></a>.</p>
<p>Теперь вывод на экране выглядит следующим образом:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
<span class="gp">         &gt; </span><span class="kd">local</span> <span class="n">string_value</span><span class="p">,</span> <span class="n">t</span>
<span class="gp">         &gt; </span><span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
<span class="gp">         &gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="n">string_value</span><span class="p">})</span>
<span class="gp">         &gt; </span><span class="k">return</span> <span class="n">t</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">main_function</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;PNPZPCOOKA&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="modify-main-function-to-insert-a-tuple-into-the-database">
<h5>11.1.8. Modify main_function to insert a tuple into the database<a class="headerlink" href="#modify-main-function-to-insert-a-tuple-into-the-database" title="Ссылка на этот заголовок">¶</a></h5>
<p>Now that it's clear how to make a tuple that contains a number and a 10-letter
random string, the only trick remaining is putting that tuple into tester.
Remember that tester is the first space that was defined in the sandbox, so
it's like a database table.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">string_value</span><span class="p">,</span> <span class="n">t</span>
  <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span><span class="n">string_value</span><span class="p">})</span>
  <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The new line here is <code class="docutils literal"><span class="pre">box.space.tester:replace(t)</span></code>. The name contains
'tester' because the insertion is going to be to tester. The second parameter
is the tuple value. To be perfectly correct we could have said
<code class="docutils literal"><span class="pre">box.space.tester:insert(t)</span></code> here, rather than <code class="docutils literal"><span class="pre">box.space.tester:replace(t)</span></code>,
but &quot;replace&quot; means “insert even if there is already a tuple whose primary-key
value is a duplicate”, and that makes it easier to re-run the exercise even if
the sandbox database isn't empty. Once this is done, tester will contain a tuple
with two fields. The first field will be 1. The second field will be a random
10-letter string. Once again the <code class="docutils literal"><span class="pre">string_function(</span></code>) can be invoked from
<code class="docutils literal"><span class="pre">main_function()</span></code> which can be invoked with <code class="docutils literal"><span class="pre">main_function()</span></code>. But
<code class="docutils literal"><span class="pre">main_function()</span></code> won't tell the whole story, because it does not return t, it
only puts t into the database. To confirm that something got inserted, we'll use
a SELECT request.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">main_function</span><span class="p">()</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
<p>For more about Tarantool insert and replace calls, see Tarantool manual section
<a class="reference internal" href="singlehtml.html#box-space"><span class="std std-ref">Submodule box.space</span></a>.</p>
<p>Теперь вывод на экране выглядит следующим образом:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">string_value</span><span class="p">,</span> <span class="n">t</span>
<span class="gp">         &gt; </span>  <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span><span class="n">string_value</span><span class="p">})</span>
<span class="gp">         &gt; </span>  <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">main_function</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;EUJYVEECIL&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="modify-main-function-to-insert-a-million-tuples-into-the-database">
<h5>11.1.9. Modify main_function to insert a million tuples into the database<a class="headerlink" href="#modify-main-function-to-insert-a-million-tuples-into-the-database" title="Ссылка на этот заголовок">¶</a></h5>
<p>Now that it's clear how to insert one tuple into the database, it's no big deal
to figure out how to scale up: instead of inserting with a literal value = 1
for the primary key, insert with a variable value = between 1 and 1 million, in
a loop. Since we already saw how to loop, that's a simple thing. The only extra
wrinkle that we add here is a timing function.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">string_value</span><span class="p">,</span> <span class="n">t</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1000000</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
    <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="n">i</span><span class="p">,</span><span class="n">string_value</span><span class="p">})</span>
    <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="nb">os.clock</span><span class="p">()</span>
<span class="n">main_function</span><span class="p">()</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="nb">os.clock</span><span class="p">()</span>
<span class="s1">&#39;</span><span class="s">insert done in &#39;</span> <span class="o">..</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> seconds&#39;</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="singlehtml.html#os-clock"><span class="std std-ref">os.clock()</span></a> function will return the number of CPU seconds since the
start. Therefore, by getting start_time = number of seconds just before the
inserting, and then getting end_time = number of seconds just after the
inserting, we can calculate (end_time - start_time) = elapsed time in seconds.
We will display that value by putting it in a request without any assignments,
which causes Tarantool to send the value to the client, which prints it. (Lua's
answer to the C <code class="docutils literal"><span class="pre">printf()</span></code> function, which is <code class="docutils literal"><span class="pre">print()</span></code>, will also work.)</p>
<p>For more on Lua <code class="docutils literal"><span class="pre">os.clock()</span></code> see Lua manual <a class="reference external" href="http://www.lua.org/pil/22.1.html">chapter 22.1 &quot;Date and Time&quot;</a>.
For more on Lua print() see Lua manual <a class="reference external" href="http://www.lua.org/pil/5.html">chapter 5 &quot;Functions&quot;</a>.</p>
<p>Since this is the grand finale, we will redo the final versions of all the
necessary requests: the request that
created <code class="docutils literal"><span class="pre">string_function()</span></code>, the request that created <code class="docutils literal"><span class="pre">main_function()</span></code>,
and the request that invokes <code class="docutils literal"><span class="pre">main_function()</span></code>.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">string_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">random_number</span>
  <span class="kd">local</span> <span class="n">random_string</span>
  <span class="n">random_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
  <span class="k">for</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
    <span class="n">random_number</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
    <span class="n">random_string</span> <span class="o">=</span> <span class="n">random_string</span> <span class="o">..</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">random_number</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="n">random_string</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">string_value</span><span class="p">,</span> <span class="n">t</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1000000</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
    <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="n">i</span><span class="p">,</span><span class="n">string_value</span><span class="p">})</span>
    <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="nb">os.clock</span><span class="p">()</span>
<span class="n">main_function</span><span class="p">()</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="nb">os.clock</span><span class="p">()</span>
<span class="s1">&#39;</span><span class="s">insert done in &#39;</span> <span class="o">..</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> seconds&#39;</span>
</pre></div>
</div>
<p>Теперь вывод на экране выглядит следующим образом:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">string_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">random_number</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">random_string</span>
<span class="gp">         &gt; </span>  <span class="n">random_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
<span class="gp">         &gt; </span>  <span class="k">for</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
<span class="gp">         &gt; </span>    <span class="n">random_number</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
<span class="gp">         &gt; </span>    <span class="n">random_string</span> <span class="o">=</span> <span class="n">random_string</span> <span class="o">..</span> <span class="nb">string.char</span><span class="p">(</span><span class="n">random_number</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="k">end</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="n">random_string</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">main_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">string_value</span><span class="p">,</span> <span class="n">t</span>
<span class="gp">         &gt; </span>  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1000000</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
<span class="gp">         &gt; </span>    <span class="n">string_value</span> <span class="o">=</span> <span class="n">string_function</span><span class="p">()</span>
<span class="gp">         &gt; </span>    <span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">tuple</span><span class="p">.</span><span class="n">new</span><span class="p">({</span><span class="n">i</span><span class="p">,</span><span class="n">string_value</span><span class="p">})</span>
<span class="gp">         &gt; </span>    <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="k">end</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">start_time</span> <span class="o">=</span> <span class="nb">os.clock</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">main_function</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">end_time</span> <span class="o">=</span> <span class="nb">os.clock</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="s1">&#39;</span><span class="s">insert done in &#39;</span> <span class="o">..</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> seconds&#39;</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">insert done in 37.62 seconds</span>
<span class="nn">...</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
<p>What has been shown is that Lua functions are quite expressive (in fact one can
do more with Tarantool's Lua stored procedures than one can do with stored
procedures in some SQL DBMSs), and that it's straightforward to combine
Lua-library functions and Tarantool-library functions.</p>
<p>What has also been shown is that inserting a million tuples took 37 seconds. The
host computer was a Linux laptop. By changing <a class="reference internal" href="singlehtml.html#cfg-binary-logging-snapshots-wal-mode"><span class="std std-ref">wal_mode</span></a> to 'none' before
running the test, one can reduce the elapsed time to 4 seconds.</p>
</div>
</div>
<div class="section" id="sum-a-json-field-for-all-tuples">
<span id="c-lua-tutorial-sum-a-json-field"></span><h4>11.2. Подсчет суммы по JSON-полям во всех кортежах<a class="headerlink" href="#sum-a-json-field-for-all-tuples" title="Ссылка на этот заголовок">¶</a></h4>
<p>This is an exercise assignment: “Assume that inside every tuple there is a
string formatted as JSON. Inside that string there is a JSON numeric field.
For each tuple, find the numeric field's value and add it to a 'sum' variable.
At end, return the 'sum' variable.” The purpose of the exercise is to get
experience in one way to read and process tuples.</p>
<div class="highlight-lua"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">json</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">json&#39;</span><span class="p">)</span>
<span class="k">function</span> <span class="nf">sum_json_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sum</span><span class="p">,</span> <span class="n">field_value</span><span class="p">,</span> <span class="n">is_valid_json</span><span class="p">,</span> <span class="n">lua_table</span>
  <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span> <span class="k">in</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">pairs</span><span class="p">()</span> <span class="k">do</span>
    <span class="n">is_valid_json</span><span class="p">,</span> <span class="n">lua_table</span> <span class="o">=</span> <span class="nb">pcall</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">decode</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">is_valid_json</span> <span class="k">then</span>
      <span class="n">field_value</span> <span class="o">=</span> <span class="n">lua_table</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
      <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">field_value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">number&quot;</span> <span class="k">then</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">+</span> <span class="n">field_value</span> <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="n">sum</span>
<span class="k">end</span>
</pre></div>
</td></tr></table></div>
<p><strong>LINE 3: WHY &quot;LOCAL&quot;.</strong> This line declares all the variables that will be used in
the function. Actually it's not necessary to declare all variables at the start,
and in a long function it would be better to declare variables just before using
them. In fact it's not even necessary to declare variables at all, but an
undeclared variable is &quot;global&quot;. That's not desirable for any of the variables
that are declared in line 1, because all of them are for use only within the function.</p>
<p><strong>LINE 5: WHY &quot;PAIRS()&quot;.</strong> Our job is to go through all the rows and there are two
ways to do it: with <a class="reference internal" href="singlehtml.html#box-space-pairs"><span class="std std-ref">box.space.space_object:pairs()</span></a> or with
<code class="docutils literal"><span class="pre">variable</span> <span class="pre">=</span> <span class="pre">select(...)</span></code> followed by <code class="samp docutils literal"><span class="pre">for</span> <span class="pre">i,</span> <em><span class="pre">n</span></em><span class="pre">,</span> <span class="pre">1</span> <span class="pre">do</span> <em><span class="pre">some-function</span></em><span class="pre">(variable[i])</span> <span class="pre">end</span></code>.
We preferred <code class="docutils literal"><span class="pre">pairs()</span></code> for this example.</p>
<p><strong>LINE 5: START THE MAIN LOOP.</strong> Everything inside this &quot;<code class="docutils literal"><span class="pre">for</span></code>&quot; loop will be
repeated as long as there is another index key. A tuple is fetched and can be
referenced with variable <code class="code docutils literal"><span class="pre">t</span></code>.</p>
<p><strong>LINE 6: WHY &quot;PCALL&quot;.</strong> If we simply said <code class="docutils literal"><span class="pre">lua_table</span> <span class="pre">=</span> <span class="pre">json.decode(t[2]))</span></code>, then
the function would abort with an error if it encountered something wrong with the
JSON string - a missing colon, for example. By putting the function inside &quot;<code class="docutils literal"><span class="pre">pcall</span></code>&quot;
(<a class="reference external" href="http://www.lua.org/pil/8.4.html">protected call</a>), we're saying: we want to intercept that sort of error, so if
there's a problem just set <code class="docutils literal"><span class="pre">is_valid_json</span> <span class="pre">=</span> <span class="pre">false</span></code> and we will know what to do
about it later.</p>
<p><strong>LINE 6: MEANING.</strong> The function is <a class="reference internal" href="singlehtml.html#json-decode"><span class="std std-ref">json.decode</span></a> which means decode a JSON
string, and the parameter is t[2] which is a reference to a JSON string. There's
a bit of hard coding here, we're assuming that the second field in the tuple is
where the JSON string was inserted. For example, we're assuming a tuple looks like</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="mi">444</span>
<span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="s1">&#39;{&quot;Hello&quot;: &quot;world&quot;, &quot;Quantity&quot;: 15}&#39;</span>
</pre></div>
</div>
<p>meaning that the tuple's first field, the primary key field, is a number while
the tuple's second field, the JSON string, is a string. Thus the entire statement
means &quot;decode <code class="docutils literal"><span class="pre">t[2]</span></code> (the tuple's second field) as a JSON string; if there's an
error set <code class="docutils literal"><span class="pre">is_valid_json</span> <span class="pre">=</span> <span class="pre">false</span></code>; if there's no error set <code class="docutils literal"><span class="pre">is_valid_json</span> <span class="pre">=</span> <span class="pre">true</span></code> and
set <code class="docutils literal"><span class="pre">lua_table</span> <span class="pre">=</span></code> a Lua table which has the decoded string&quot;.</p>
<p><strong>LINE 8.</strong> At last we are ready to get the JSON field value from the Lua table that
came from the JSON string. The value in field_name, which is the parameter for the
whole function, must be a name of a JSON field. For example, inside the JSON string
<code class="docutils literal"><span class="pre">'{&quot;Hello&quot;:</span> <span class="pre">&quot;world&quot;,</span> <span class="pre">&quot;Quantity&quot;:</span> <span class="pre">15}'</span></code>, there are two JSON fields: &quot;Hello&quot; and
&quot;Quantity&quot;. If the whole function is invoked with <code class="docutils literal"><span class="pre">sum_json_field(&quot;Quantity&quot;)</span></code>,
then <code class="docutils literal"><span class="pre">field_value</span> <span class="pre">=</span> <span class="pre">lua_table[field_name]</span></code> is effectively the same as
<code class="docutils literal"><span class="pre">field_value</span> <span class="pre">=</span> <span class="pre">lua_table[&quot;Quantity&quot;]</span></code> or even <code class="docutils literal"><span class="pre">field_value</span> <span class="pre">=</span> <span class="pre">lua_table.Quantity</span></code>.
Those are just three different ways of saying: for the Quantity field in the Lua table,
get the value and put it in variable <code class="code docutils literal"><span class="pre">field_value</span></code>.</p>
<p><strong>LINE 9: WHY &quot;IF&quot;.</strong> Suppose that the JSON string is well formed but the JSON field
is not a number, or is missing. In that case, the function would be aborted when
there was an attempt to add it to the sum. By first checking
<code class="docutils literal"><span class="pre">type(field_value)</span> <span class="pre">==</span> <span class="pre">&quot;number&quot;</span></code>, we avoid that abortion. Anyone who knows that
the database is in perfect shape can skip this kind of thing.</p>
<p>And the function is complete. Time to test it. Starting with an empty database,
defined the same way as the sandbox database that was introduced in
<a class="reference internal" href="singlehtml.html#user-guide-getting-started-first-database"><span class="std std-ref">first database</span></a>,</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- if tester is left over from some previous test, destroy it</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">drop</span><span class="p">()</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
</pre></div>
</div>
<p>then add some tuples where the first field is a number and the second
field is a string.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">444</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">{&quot;Item&quot;: &quot;widget&quot;, &quot;Quantity&quot;: 15}&#39;</span><span class="p">}</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">445</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">{&quot;Item&quot;: &quot;widget&quot;, &quot;Quantity&quot;: 7}&#39;</span><span class="p">}</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">446</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">{&quot;Item&quot;: &quot;golf club&quot;, &quot;Quantity&quot;: &quot;sunshine&quot;}&#39;</span><span class="p">}</span>
<span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">447</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">{&quot;Item&quot;: &quot;waffle iron&quot;, &quot;Quantit&quot;: 3}&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>Since this is a test, there are deliberate errors. The &quot;golf club&quot; and the
&quot;waffle iron&quot; do not have numeric Quantity fields, so must be ignored.
Therefore the real sum of the Quantity field in the JSON strings should be:
15 + 7 = 22.</p>
<p>Invoke the function with <code class="docutils literal"><span class="pre">sum_json_field(&quot;Quantity&quot;)</span></code>.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">sum_json_field</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Quantity&quot;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">22</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>It works. We'll just leave, as exercises for future improvement, the possibility
that the &quot;hard coding&quot; assumptions could be removed, that there might have to be
an overflow check if some field values are huge, and that the function should
contain a &quot;yield&quot; instruction if the count of tuples is huge.</p>
</div>
<div class="section" id="indexed-pattern-search">
<span id="c-lua-tutorial-indexed-pattern-search"></span><h4>11.3. Индексированный поиск по шаблонам<a class="headerlink" href="#indexed-pattern-search" title="Ссылка на этот заголовок">¶</a></h4>
<p>Here is a generic function which takes a field identifier
and a search pattern, and returns all tuples that match. <br />
* The field must be the first field of a TREE index. <br />
* The function will use <a class="reference external" href="http://www.lua.org/manual/5.2/manual.html#6.4.1">Lua pattern matching</a>,
which allows &quot;magic characters&quot; in regular expressions. <br />
* The initial characters in the pattern, as far as the
first magic character, will be used as an index search key.
For each tuple that is found via the index, there will be
a match of the whole pattern. <br />
* To be <a class="reference internal" href="singlehtml.html#atomic-cooperative-multitasking"><span class="std std-ref">cooperative</span></a>, the function should yield after every
10 tuples, unless there is a reason to delay yielding. <br />
With this function, we can take advantage of Tarantool's indexes
for speed, and take advantage of Lua's pattern matching for flexibility.
It does everything that an SQL &quot;LIKE&quot; search can do, and far more.</p>
<p>Read the following Lua code to see how it works.
The comments that begin with &quot;SEE NOTE ...&quot; refer to long
explanations that follow the code.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">indexed_pattern_search</span><span class="p">(</span><span class="n">space_name</span><span class="p">,</span> <span class="n">field_no</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
  <span class="c1">-- SEE NOTE #1 &quot;FIND AN APPROPRIATE INDEX&quot;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Error: Failed to find the specified space&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
  <span class="k">end</span>
  <span class="kd">local</span> <span class="n">index_no</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">INDEX_MAX</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">].</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span> <span class="k">break</span> <span class="k">end</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">].</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">TREE&quot;</span>
        <span class="ow">and</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">].</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fieldno</span> <span class="o">==</span> <span class="n">field_no</span>
        <span class="ow">and</span> <span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">].</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">scalar&quot;</span>
        <span class="ow">or</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">].</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">string&quot;</span><span class="p">))</span> <span class="k">then</span>
      <span class="n">index_no</span> <span class="o">=</span> <span class="n">i</span>
      <span class="k">break</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">index_no</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Error: Failed to find an appropriate index&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
  <span class="k">end</span>
  <span class="c1">-- SEE NOTE #2 &quot;DERIVE INDEX SEARCH KEY FROM PATTERN&quot;</span>
  <span class="kd">local</span> <span class="n">index_search_key</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
  <span class="kd">local</span> <span class="n">index_search_key_length</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">local</span> <span class="n">last_character</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
  <span class="kd">local</span> <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
  <span class="kd">local</span> <span class="n">c2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nb">string.len</span><span class="p">(</span><span class="n">pattern</span><span class="p">),</span><span class="mi">1</span> <span class="k">do</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">string.sub</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">last_character</span> <span class="o">~=</span> <span class="s2">&quot;</span><span class="s">%&quot;</span><span class="p">)</span> <span class="k">then</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="s">^&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">$&quot;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">(&quot;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">)&quot;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">.&quot;</span>
                   <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">[&quot;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">]&quot;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">*&quot;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">+&quot;</span>
                   <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">-&quot;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">?&quot;</span><span class="p">)</span> <span class="k">then</span>
        <span class="k">break</span>
      <span class="k">end</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">%&quot;</span><span class="p">)</span> <span class="k">then</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="nb">string.sub</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">string.match</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">%p&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span> <span class="k">break</span> <span class="k">end</span>
        <span class="n">index_search_key</span> <span class="o">=</span> <span class="n">index_search_key</span> <span class="o">..</span> <span class="n">c2</span>
      <span class="k">else</span>
        <span class="n">index_search_key</span> <span class="o">=</span> <span class="n">index_search_key</span> <span class="o">..</span> <span class="n">c</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">last_character</span> <span class="o">=</span> <span class="n">c</span>
  <span class="k">end</span>
  <span class="n">index_search_key_length</span> <span class="o">=</span> <span class="nb">string.len</span><span class="p">(</span><span class="n">index_search_key</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">index_search_key_length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Error: index search key &quot;</span> <span class="o">..</span> <span class="n">index_search_key</span> <span class="o">..</span> <span class="s2">&quot;</span><span class="s"> is too short&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
  <span class="k">end</span>
  <span class="c1">-- SEE NOTE #3 &quot;OUTER LOOP: INITIATE&quot;</span>
  <span class="kd">local</span> <span class="n">result_set</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="kd">local</span> <span class="n">number_of_tuples_in_result_set</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">local</span> <span class="n">previous_tuple_field</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">&quot;</span>
  <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
    <span class="kd">local</span> <span class="n">number_of_tuples_since_last_yield</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kd">local</span> <span class="n">is_time_for_a_yield</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="c1">-- SEE NOTE #4 &quot;INNER LOOP: ITERATOR&quot;</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">tuple</span> <span class="k">in</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_name</span><span class="p">].</span><span class="n">index</span><span class="p">[</span><span class="n">index_no</span><span class="p">]:</span>
    <span class="nb">pairs</span><span class="p">(</span><span class="n">index_search_key</span><span class="p">,{</span><span class="n">iterator</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">GE</span><span class="p">})</span> <span class="k">do</span>
      <span class="c1">-- SEE NOTE #5 &quot;INNER LOOP: BREAK IF INDEX KEY IS TOO GREAT&quot;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">string.sub</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="n">field_no</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">index_search_key_length</span><span class="p">)</span>
      <span class="o">&gt;</span> <span class="n">index_search_key</span><span class="p">)</span> <span class="k">then</span>
        <span class="k">break</span>
      <span class="k">end</span>
      <span class="c1">-- SEE NOTE #6 &quot;INNER LOOP: BREAK AFTER EVERY 10 TUPLES -- MAYBE&quot;</span>
      <span class="n">number_of_tuples_since_last_yield</span> <span class="o">=</span> <span class="n">number_of_tuples_since_last_yield</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">number_of_tuples_since_last_yield</span> <span class="o">&gt;=</span> <span class="mi">10</span>
          <span class="ow">and</span> <span class="n">tuple</span><span class="p">[</span><span class="n">field_no</span><span class="p">]</span> <span class="o">~=</span> <span class="n">previous_tuple_field</span><span class="p">)</span> <span class="k">then</span>
        <span class="n">index_search_key</span> <span class="o">=</span> <span class="n">tuple</span><span class="p">[</span><span class="n">field_no</span><span class="p">]</span>
        <span class="n">is_time_for_a_yield</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="k">break</span>
        <span class="k">end</span>
      <span class="n">previous_tuple_field</span> <span class="o">=</span> <span class="n">tuple</span><span class="p">[</span><span class="n">field_no</span><span class="p">]</span>
      <span class="c1">-- SEE NOTE #7 &quot;INNER LOOP: ADD TO RESULT SET IF PATTERN MATCHES&quot;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">string.match</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="n">field_no</span><span class="p">],</span> <span class="n">pattern</span><span class="p">)</span> <span class="o">~=</span> <span class="kc">nil</span><span class="p">)</span> <span class="k">then</span>
        <span class="n">number_of_tuples_in_result_set</span> <span class="o">=</span> <span class="n">number_of_tuples_in_result_set</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">result_set</span><span class="p">[</span><span class="n">number_of_tuples_in_result_set</span><span class="p">]</span> <span class="o">=</span> <span class="n">tuple</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="c1">-- SEE NOTE #8 &quot;OUTER LOOP: BREAK, OR YIELD AND CONTINUE&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_time_for_a_yield</span> <span class="o">~=</span> <span class="kc">true</span><span class="p">)</span> <span class="k">then</span>
      <span class="k">break</span>
    <span class="k">end</span>
    <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fiber&#39;</span><span class="p">).</span><span class="n">yield</span><span class="p">()</span>
  <span class="k">end</span>
  <span class="k">return</span> <span class="n">result_set</span>
<span class="k">end</span>
</pre></div>
</div>
<p>NOTE #1 &quot;FIND AN APPROPRIATE INDEX&quot; <br />
The caller has passed space_name (a string) and field_no (a number).
The requirements are: <br />
(a) index type must be &quot;TREE&quot; because for other index types
(HASH, BITSET, RTREE) a search with iterator=GE
will not return strings in order by string value; <br />
(b) field_no must be the first index part; <br />
(c) the field must contain strings, because for other data types
(such as &quot;unsigned&quot;) pattern searches are not possible; <br />
If these requirements are not met by any index, then
print an error message and return nil.</p>
<p>NOTE #2 &quot;DERIVE INDEX SEARCH KEY FROM PATTERN&quot; <br />
The caller has passed pattern (a string).
The index search key will be
the characters in the pattern as far as the first magic character.
Lua's magic characters are % ^ $ ( ) . [ ] * + - ?.
For example, if the pattern is &quot;ABC.E&quot;, the period is a magic
character and therefore the index search key will be &quot;ABC&quot;.
But there is a complication ... If we see &quot;%&quot; followed by a punctuation
character, that punctuation character is &quot;escaped&quot; so
remove the &quot;%&quot; when making the index search key. For example, if the
pattern is &quot;AB%$E&quot;, the dollar sign is escaped and therefore
the index search key will be &quot;AB$E&quot;.
Finally there is a check that the index search key length
must be at least three -- this is an arbitrary number, and in
fact zero would be okay, but short index search keys will cause
long search times.</p>
<p>NOTE #3 -- &quot;OUTER LOOP: INITIATE&quot; <br />
The function's job is to return a result set,
just as box.space.select would. We will fill
it within an outer loop that contains an inner
loop. The outer loop's job is to execute the inner
loop, and possibly yield, until the search ends.
The inner loop's job is to find tuples via the index, and put
them in the result set if they match the pattern.</p>
<p>NOTE #4 &quot;INNER LOOP: ITERATOR&quot; <br />
The for loop here is using pairs(), see the
<a class="reference internal" href="singlehtml.html#box-index-index-pairs"><span class="std std-ref">explanation of what index iterators are</span></a>.
Within the inner loop,
there will be a local variable named &quot;tuple&quot; which contains
the latest tuple found via the index search key.</p>
<p>NOTE #5 &quot;INNER LOOP: BREAK IF INDEX KEY IS TOO GREAT&quot; <br />
The iterator is GE (Greater or Equal), and we must be
more specific: if the search index key has N characters,
then the leftmost N characters of the result's index field
must not be greater than the search index key. For example,
if the search index key is 'ABC', then 'ABCDE' is
a potential match, but 'ABD' is a signal that
no more matches are possible.</p>
<p>NOTE #6 &quot;INNER LOOP: BREAK AFTER EVERY 10 TUPLES -- MAYBE&quot; <br />
This chunk of code is for cooperative multitasking.
The number 10 is arbitrary, and usually a larger number would be okay.
The simple rule would be &quot;after checking 10 tuples, yield,
and then resume the search (that is, do the inner loop again)
starting after the last value that was found&quot;. However, if
the index is non-unique or if there is more than one field
in the index, then we might have duplicates -- for example
{&quot;ABC&quot;,1}, {&quot;ABC&quot;, 2}, {&quot;ABC&quot;, 3}&quot; -- and it would be difficult
to decide which &quot;ABC&quot; tuple to resume with. Therefore, if
the result's index field is the same as the previous
result's index field, there is no break.</p>
<p>NOTE #7 &quot;INNER LOOP: ADD TO RESULT SET IF PATTERN MATCHES&quot; <br />
Compare the result's index field to the entire pattern.
For example, suppose that the caller passed pattern &quot;ABC.E&quot;
and there is an indexed field containing &quot;ABCDE&quot;.
Therefore the initial index search key is &quot;ABC&quot;.
Therefore a tuple containing an indexed field with &quot;ABCDE&quot;
will be found by the iterator, because &quot;ABCDE&quot; &gt; &quot;ABC&quot;.
In that case string.match will return a value which is not nil.
Therefore this tuple can be added to the result set.</p>
<p>NOTE #8 &quot;OUTER LOOP: BREAK, OR YIELD AND CONTINUE&quot; <br />
There are three conditions which will cause a break from
the inner loop: (1) the for loop ends naturally because
there are no more index keys which are greater than or
equal to the index search key, (2) the index key is too
great as described in NOTE #5, (3) it is time for a yield
as described in NOTE #6. If condition (1) or condition (2)
is true, then there is nothing more to do, the outer loop
ends too. If and only if condition (3) is true, the
outer loop must yield and then continue. If it does
continue, then the inner loop -- the iterator search --
will happen again with a new value for the index search key.</p>
<p>Например:</p>
<p>Start tarantool, cut and paste the code for function indexed_pattern_search,
and try the following: <br />
<span class="ccodeb">box.space.t:drop()</span> <br />
<span class="ccodeb">box.schema.space.create('t')</span> <br />
<span class="ccodeb">box.space.t:create_index('primary',{})</span> <br />
<span class="ccodeb">box.space.t:create_index('secondary',{unique=false,parts={2,'string',3,'string'}})</span> <br />
<span class="ccodeb">box.space.t:insert{1,'A','a'}</span> <br />
<span class="ccodeb">box.space.t:insert{2,'AB',''}</span> <br />
<span class="ccodeb">box.space.t:insert{3,'ABC','a'}</span> <br />
<span class="ccodeb">box.space.t:insert{4,'ABCD',''}</span> <br />
<span class="ccodeb">box.space.t:insert{5,'ABCDE','a'}</span> <br />
<span class="ccodeb">box.space.t:insert{6,'ABCDE',''}</span> <br />
<span class="ccodeb">box.space.t:insert{7,'ABCDEF','a'}</span> <br />
<span class="ccodeb">box.space.t:insert{8,'ABCDF',''}</span> <br />
<span class="ccodeb">indexed_pattern_search(&quot;t&quot;, 2, &quot;ABC.E.&quot;)</span> <br />
The result will be: <br />
<span class="ccode">tarantool&gt;</span> <span class="ccodeb">indexed_pattern_search(&quot;t&quot;, 2, &quot;ABC.E.&quot;)</span> <br />
<span class="ccode">---</span> <br />
<span class="ccode">- - [7, 'ABCDEF', 'a']</span> <br />
<span class="ccode">...</span> <br /></p>
</div>
</div>
<span id="document-book/app/d_vinyl/index"></span><div class="section" id="appendix-d-vinyl">
<span id="index-vinyl"></span><h3>12. Приложение D. Vinyl<a class="headerlink" href="#appendix-d-vinyl" title="Ссылка на этот заголовок">¶</a></h3>
<div class="section" id="introduction">
<h4>12.1. Введение<a class="headerlink" href="#introduction" title="Ссылка на этот заголовок">¶</a></h4>
<p>Vinyl's features are:</p>
<ul class="simple">
<li>Full ACID compliance</li>
<li>Multi-Version Concurrency Control (MVCC)</li>
<li>Pure Append-Only</li>
<li>Multi-threaded (Client access and Engine scalability)</li>
<li>Multi-databases support (Single environment and WAL)</li>
<li>Multi-Statement and Single-Statement Transactions (Snapshot Isolation (SI), multi-databases)</li>
<li>Asynchronous or synchronous transaction execution (Callback triggered versus blocking)</li>
<li>Separate storage formats: key-value (Default), or document (Keys are part of value)</li>
<li>Update without read</li>
<li>Consistent Cursors</li>
<li>Prefix search</li>
<li>Point-in-Time Snapshots</li>
<li>Versional database creation and asynchronous shutdown/drop</li>
<li>Asynchronous Online/Hot Backup</li>
<li>Compression (Per region, both lz4 and zstd are supported)</li>
<li>Metadata Compression (By default)</li>
<li>Key Compression (Compress key duplicates, including suffixes)</li>
<li>Easy to use (Minimalist API)</li>
<li>Easy to integrate (Native support of using as storage engine)</li>
<li>Easy to write bindings (Very FFI-friendly, API designed to be stable in future)</li>
<li>Easy to build in (Amalgamated, compiles into two C files)</li>
<li>Event loop friendly</li>
<li>Zero-Configuration (Tuned by default)</li>
<li>Implemented as a small library <strong>written in C</strong> with zero dependencies</li>
<li>BSD Licensed</li>
</ul>
<p>It is appropriate for databases that cannot fit in memory, where access via secondary keys is not required.</p>
<p>In vinyl terminology:</p>
<ul class="simple">
<li>There is one <strong>Environment</strong>.</li>
<li>An Environment has N <strong>Databases</strong> - a vinyl database is like a Tarantool <cite>space</cite>.</li>
<li>A Database has N <strong>Ranges</strong>.</li>
<li>A Range has one <strong>Range File</strong>.</li>
<li>A Range File has N <strong>Runs</strong>.</li>
<li>A Run has N <strong>Regions</strong> - a vinyl Region is like a B-tree <cite>page</cite>.</li>
<li>A Region has <strong>keys</strong> and <strong>values</strong> - a vinyl key-value is like a Tarantool <cite>tuple</cite>.</li>
</ul>
<p>A key and its associated value are together, so when one accesses a key one gets
the whole tuple. In other words, in vinyl the data is stored in the index. There
are up to two in-memory copies of an index, as well as the copy in the Range File.</p>
<p>For operations that insert or update tuples - called Set operations in vinyl -
vinyl makes changes to in-memory copies of the index, and writes to Tarantool's
Write-ahead Log. A scheduler assigns tasks to multiple background threads for
transferring index data from memory to disk, and for reorganizing Runs. To
support transactions, Set operations can be delayed until an explicit commit. If
multiple users access the same tuples simultaneously, the concurrency control
method is <a class="reference external" href="https://en.wikipedia.org/wiki/Multiversion_concurrency_control">MVCC</a> and the isolation level is <a class="reference external" href="https://en.wikipedia.org/wiki/Snapshot_isolation">Snapshot</a>.</p>
<p>Formally, in terms of disk accesses, vinyl has the following algorithmic complexity:</p>
<ul class="simple">
<li><strong>Set</strong> - the worst case is O(<em>1</em>) append-only key writes to the Write-Ahead
Log + in-memory Range index searches + in-memory index inserts</li>
<li><strong>Delete</strong> - the worst case is O(<em>1</em>) key writes and in-memory index inserts
(the same as <strong>Set</strong>)</li>
<li><strong>Get</strong> - the worst case is <a class="reference external" href="https://en.wikipedia.org/wiki/Amortized_analysis">amortized</a> O(<em>max_run_count_per_node</em>)
random Region reads from a single Range file, which itself does in-memory index
search + in-memory Region search</li>
<li><strong>Range</strong> - queries, the worst case of full Database scan is amortized
O(<em>total_Region_count</em>) + in-memory key-index searches for each Range</li>
</ul>
</div>
<div class="section" id="under-the-hood">
<h4>12.2. А что там &quot;под капотом&quot;?<a class="headerlink" href="#under-the-hood" title="Ссылка на этот заголовок">¶</a></h4>
<p>In this section, to illustrate internals, we will discuss this example:</p>
<ol class="arabic simple">
<li>filling an empty database with one million tuples (we'll call them &quot;keys&quot; to
emphasize the indexed nature)</li>
<li>reading all stored tuples in the original order.</li>
</ol>
<div class="section" id="inserting-the-first-200-000-keys">
<h5>12.2.1. Inserting the first 200.000 keys<a class="headerlink" href="#inserting-the-first-200-000-keys" title="Ссылка на этот заголовок">¶</a></h5>
<p>During the first 200,000 Set operations, inserted keys first go to the
in-memory index. To maintain persistence, information about each Set
operation is written to Tarantool's Write-ahead Log.</p>
<img alt="i1.png" class="align-center" src="_images/i1.png" />
<p>At this point we have keys in an in-memory index
and records in the Write-ahead Log.</p>
</div>
<div class="section" id="inserting-the-next-300-000-keys">
<h5>12.2.2. Inserting the next 300.000 keys<a class="headerlink" href="#inserting-the-next-300-000-keys" title="Ссылка на этот заголовок">¶</a></h5>
<p>As the in-memory index becomes too large for available memory, the index must be
copied from memory to disk. The on-disk copy of the in-memory index is called a
Run. To save the Run, a new file is created, the Range File. We will call
it <strong>db file</strong> for this example.</p>
<p>The scheduler wakes a worker thread in the background, a Run Creation Thread.
The thread creates a second in-memory index. If there are Set operations taking
place while the thread is working, their contention effect will be small because
they will operate on the second in-memory index.</p>
<img alt="i2.png" class="align-center" src="_images/i2.png" />
<p>When the Run Creation Thread finishes the task, the first in-memory index is
freed.</p>
<img alt="i3.png" class="align-center" src="_images/i3.png" />
</div>
<div class="section" id="inserting-the-next-200-000-keys">
<h5>12.2.3. Inserting the next 200.000 keys<a class="headerlink" href="#inserting-the-next-200-000-keys" title="Ссылка на этот заголовок">¶</a></h5>
<p>Several times, the in-memory index becomes too large and a Run Creation
Thread transfers the keys to a Run. The Runs have been appended to the
end of db file. The number of created Runs becomes large.</p>
<img alt="i4.png" class="align-center" src="_images/i4.png" />
<p>There is a user-settable maximum number of Runs per Range. When the number of
Runs reaches this maximum, the vinyl scheduler wakes a <strong>Compaction Thread</strong>
for the db file. The Compaction Thread merges the keys in all the Runs, and
creates one or more new db files.</p>
<img alt="i5.png" class="align-center" src="_images/i5.png" />
<p>Now there are multiple pairs of in-memory indexes, and each pair has an
associated db file. The combination of the in-memory indexes and the db file is
called a <strong>Range</strong>, and the db file is called a <strong>Range File</strong>.</p>
<img alt="i6.png" class="align-center" src="_images/i6.png" />
<p>Thus the contents of a Range are: a range of sorted key values, stored in Runs
of a Range File and (when necessary) in memory. Since the ranges do not overlap,
each Range can be handled independently. Therefore, while one of the background
threads is working on Range 1, another background thread can be working on Range 2,
without contention. That means that all the background operations (Run Creation,
Compaction, Garbage Collection, and Backup) can take place in parallel on multiple
threads.</p>
<p>The foregoing explanation will now be repeated with different wording.</p>
<p>Before the Compaction there was one Range, which was created automatically when
the Database was initialized. The Range had:</p>
<ol class="loweralpha simple">
<li>an in-memory index with some keys in it,</li>
<li>a Range File with several Runs,</li>
<li>a Write-Ahead Log file recording the Set operations, in the order they happened.</li>
</ol>
<p>The number of Runs became too big, so the vinyl scheduler starts the
Compaction Thread and creates two new Ranges.</p>
<img alt="i7.png" class="align-center" src="_images/i7.png" />
<p>So, each of the two new Range Files contains half of the keys that were in the
original Range. The Range's in-memory indexes are split in the same way.</p>
<p>After the splitting, vinyl must take into account that: while the Compaction
was going on in the background, there might have been more Set operations taking
place in parallel. These Set operations would have changed one of the in-memory
indexes, and these changes too will be merged.</p>
<p>When the Compaction Thread finishes, the original Range is deleted, and
information about the new Ranges is inserted into an in-memory <strong>Range Index</strong>.</p>
<img alt="i8.png" class="align-center" src="_images/i8.png" />
<p>This Range Index is used for all Set operations and all searches. Since the Range
Index has the minimum and maximum key values that are in each Range, it is
straightforward to scan it to find what Range would contain a particular key value.</p>
<img alt="i9.png" class="align-center" src="_images/i9.png" />
</div>
<div class="section" id="inserting-the-last-300-000-keys">
<h5>12.2.4. Inserting the last 300.000 keys<a class="headerlink" href="#inserting-the-last-300-000-keys" title="Ссылка на этот заголовок">¶</a></h5>
<p>The final 300,000 Set operations take place; the background threads continue to
create new Runs and do more Compactions. After the millionth insertion, the
Database has four Ranges.</p>
<img alt="i10.png" class="align-center" src="_images/i10.png" />
<p>The inserting is done. Now, because the words &quot;memory&quot; and &quot;disk&quot; have appeared
in this explanation several times, here are a few words about how vinyl is
designed to use these resources most efficiently:</p>
<ul class="simple">
<li>If there is more memory available, then Run Creation and Compaction will be
less frequent, and there will be fewer disk accesses.</li>
<li>The best vinyl performance will occur if there is no setting of a memory limit,
but this must be balanced against other considerations, such as requirements
for the memtx storage engine. If there is a setting of a memory limit, the
vinyl scheduler will give priority to the Ranges that have the largest
in-memory indexes, so that the largest memory blocks are freed first.</li>
<li>To make the most of hard drives and Flash, vinyl will delay operations that
require disk access (except the writing of the Write-ahead Log which is
specially tunable), so that the accesses are done in large sequential blocks.</li>
<li>Overwriting does not occur; vinyl is an &quot;append-only&quot; engine.</li>
</ul>
</div>
<div class="section" id="reading-million-keys">
<h5>12.2.5. Reading million keys<a class="headerlink" href="#reading-million-keys" title="Ссылка на этот заголовок">¶</a></h5>
<p>We will now start to read the million rows in the order that they were inserted,
which was random.</p>
<img alt="i12.png" class="align-center" src="_images/i12.png" />
<p>During the Get (search), vinyl first finds the correct Range by looking in the
Range Index. Then it searches the Range's first in-memory index, and/or the Range's
second in-memory index, and/or each Run of the Range, starting from the end of
the Range File.</p>
<p>Remember that a Run is divided into Regions, which are like what would be
called &quot;pages&quot; or &quot;blocks&quot; in a B-tree. For each Run, there is a list of the
Regions and their minimum/maximum key values - the Region Index - as well as
some metadata.</p>
<img alt="i13.png" class="align-center" src="_images/i13.png" />
<p>Region Indexes are loaded into memory when the Database is opened. Since the
Database's Range Index and the Region Indexes are normally in-memory, searching
and retrieving a tuple might require only zero or one disk accesses. However,
when memory is limited and there are many Runs, search time may rise.
For each additional Run there is a possible additional disk access during a
search. Also, it is impossible to maintain memory limits without doing a Run
Creation process, because new Set operations might occur more quickly than the
Compaction process can run.</p>
<img alt="i14.png" class="align-center" src="_images/i14.png" />
<p>Vinyl is read optimized. It is very likely that the most recently created
Runs (hot data) will be in the file system cache. The scheduler will give
priority to the Ranges which have the largest in-memory indexes and the most
Runs.</p>
<p>The scheduler may also try to arrange that a Range will have only one Run,
which will ensure the average number of disk seeks for each search is O(<em>1</em>).</p>
</div>
</div>
</div>
<span id="document-book/app/e_cookbook"></span><div class="section" id="appendix-e-cookbook">
<h3>13. Приложение E. Готовые рецепты<a class="headerlink" href="#appendix-e-cookbook" title="Ссылка на этот заголовок">¶</a></h3>
<p>These are contributions of Lua programs for some frequent or tricky situations.</p>
<p>Any of the programs can be executed by copying the code into a .lua file,
and then entering <code class="samp docutils literal"><span class="pre">chmod</span> <span class="pre">+x</span> <span class="pre">./</span><em><span class="pre">program-name</span></em><span class="pre">.lua</span></code>
and <code class="samp docutils literal"><span class="pre">./</span><em><span class="pre">program-name</span></em><span class="pre">.lua</span></code> on the terminal.
As is usual for Tarantool/Lua programs, the first line is a &quot;hashbang&quot; <br />
#!/usr/bin/env tarantool <br />
This runs the Tarantool Lua application server, which should be on the
execution path.</p>
<p>Use freely.</p>
<p><strong>hello_world.lua</strong></p>
<p>The standard example of a simple program.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Hello, World!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>console_start.lua</strong></p>
<p>Use <a class="reference internal" href="singlehtml.html#box-once"><span class="std std-ref">box.once()</span></a> to initialize a database
(creating spaces) if this is the first time the server has been run.
Then use <a class="reference internal" href="singlehtml.html#console-start"><span class="std std-ref">console.start()</span></a> to start interactive mode.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="c1">-- Configure database</span>
<span class="n">box</span><span class="p">.</span><span class="n">cfg</span> <span class="p">{</span>
    <span class="n">listen</span> <span class="o">=</span> <span class="mi">3313</span>
<span class="p">}</span>

<span class="n">box</span><span class="p">.</span><span class="n">once</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">bootstrap&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">()</span>
    <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tweedledum&#39;</span><span class="p">)</span>
    <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tweedledum</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span>
        <span class="p">{</span> <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">TREE&#39;</span><span class="p">,</span> <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
<span class="k">end</span><span class="p">)</span>

<span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">console&#39;</span><span class="p">).</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>fio_read.lua</strong></p>
<p>Use the <a class="reference internal" href="singlehtml.html#fio-module"><span class="std std-ref">fio module</span></a> to open, read, and close a file.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">fio</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fio&#39;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">errno</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">errno&#39;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fio</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">/tmp/xxxx.txt&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;</span><span class="s">O_RDONLY&#39;</span> <span class="p">})</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">f</span> <span class="k">then</span>
    <span class="nb">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Failed to open file: &quot;</span><span class="o">..</span><span class="n">errno</span><span class="p">.</span><span class="n">strerror</span><span class="p">())</span>
<span class="k">end</span>
<span class="kd">local</span> <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
<span class="n">f</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>fio_write.lua</strong></p>
<p>Use the <a class="reference internal" href="singlehtml.html#fio-module"><span class="std std-ref">fio module</span></a> to open, write, and close a file.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">fio</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fio&#39;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">errno</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">errno&#39;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fio</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">/tmp/xxxx.txt&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;</span><span class="s">O_CREAT&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">O_WRONLY&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">O_APPEND&#39;</span><span class="p">},</span>
    <span class="nb">tonumber</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">0666&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">f</span> <span class="k">then</span>
    <span class="nb">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Failed to open file: &quot;</span><span class="o">..</span><span class="n">errno</span><span class="p">.</span><span class="n">strerror</span><span class="p">())</span>
<span class="k">end</span>
<span class="n">f</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Hello</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">f</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p id="e-cookbook-ffi-printf"><strong>ffi_printf.lua</strong></p>
<p>Use the <a class="reference external" href="http://luajit.org/ext_ffi.html">LuaJIT ffi library</a> to call a C built-in function: printf().
(For help understanding ffi, see the <a class="reference external" href="http://luajit.org/ext_ffi_tutorial.html">FFI tutorial</a>.)</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">ffi</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">ffi&#39;</span><span class="p">)</span>
<span class="n">ffi</span><span class="p">.</span><span class="n">cdef</span><span class="s">[[</span>
<span class="s">    int printf(const char *format, ...);</span>
<span class="s">]]</span>

<span class="n">ffi</span><span class="p">.</span><span class="n">C</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Hello, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">os.getenv</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">USER&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p><strong>ffi_gettimeofday.lua</strong></p>
<p>Use the <a class="reference external" href="http://luajit.org/ext_ffi.html">LuaJIT ffi library</a> to call a C function: gettimeofday().
This delivers time with millisecond precision, unlike the time function in
Tarantool's <a class="reference internal" href="singlehtml.html#clock-module"><span class="std std-ref">clock module</span></a>.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">ffi</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">ffi&#39;</span><span class="p">)</span>
<span class="n">ffi</span><span class="p">.</span><span class="n">cdef</span><span class="s">[[</span>
<span class="s">    typedef long time_t;</span>
<span class="s">    typedef struct timeval {</span>
<span class="s">    time_t tv_sec;</span>
<span class="s">    time_t tv_usec;</span>
<span class="s">} timeval;</span>
<span class="s">    int gettimeofday(struct timeval *t, void *tzp);</span>
<span class="s">]]</span>

<span class="kd">local</span> <span class="n">timeval_buf</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">timeval&quot;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">now</span> <span class="o">=</span> <span class="k">function</span><span class="p">()</span>
    <span class="n">ffi</span><span class="p">.</span><span class="n">C</span><span class="p">.</span><span class="n">gettimeofday</span><span class="p">(</span><span class="n">timeval_buf</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tonumber</span><span class="p">(</span><span class="n">timeval_buf</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="p">(</span><span class="n">timeval_buf</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">))</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>ffi_zlib.lua</strong></p>
<p>Use the <a class="reference external" href="http://luajit.org/ext_ffi.html">LuaJIT ffi library</a> to call a C library function.
(For help understanding ffi, see the <a class="reference external" href="http://luajit.org/ext_ffi_tutorial.html">FFI tutorial</a>.)</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">ffi</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">ffi&quot;</span><span class="p">)</span>
<span class="n">ffi</span><span class="p">.</span><span class="n">cdef</span><span class="s">[[</span>
<span class="s">    unsigned long compressBound(unsigned long sourceLen);</span>
<span class="s">    int compress2(uint8_t *dest, unsigned long *destLen,</span>
<span class="s">    const uint8_t *source, unsigned long sourceLen, int level);</span>
<span class="s">    int uncompress(uint8_t *dest, unsigned long *destLen,</span>
<span class="s">    const uint8_t *source, unsigned long sourceLen);</span>
<span class="s">]]</span>
<span class="kd">local</span> <span class="n">zlib</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">ffi</span><span class="p">.</span><span class="n">os</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">Windows&quot;</span> <span class="ow">and</span> <span class="s2">&quot;</span><span class="s">zlib1&quot;</span> <span class="ow">or</span> <span class="s2">&quot;</span><span class="s">z&quot;</span><span class="p">)</span>

<span class="c1">-- Lua wrapper for compress2()</span>
<span class="kd">local</span> <span class="k">function</span> <span class="nf">compress</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">n</span> <span class="o">=</span> <span class="n">zlib</span><span class="p">.</span><span class="n">compressBound</span><span class="p">(</span><span class="o">#</span><span class="n">txt</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">uint8_t[?]&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">buflen</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">unsigned long[1]&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">zlib</span><span class="p">.</span><span class="n">compress2</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="o">#</span><span class="n">txt</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
    <span class="nb">assert</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="p">.</span><span class="n">string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">end</span>

<span class="c1">-- Lua wrapper for uncompress</span>
<span class="kd">local</span> <span class="k">function</span> <span class="nf">uncompress</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">uint8_t[?]&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">buflen</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">unsigned long[1]&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">res</span> <span class="o">=</span> <span class="n">zlib</span><span class="p">.</span><span class="n">uncompress</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="o">#</span><span class="n">comp</span><span class="p">)</span>
    <span class="nb">assert</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ffi</span><span class="p">.</span><span class="n">string</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="k">end</span>

<span class="c1">-- Simple test code.</span>
<span class="kd">local</span> <span class="n">txt</span> <span class="o">=</span> <span class="nb">string.rep</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">abcd&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Uncompressed size: &quot;</span><span class="p">,</span> <span class="o">#</span><span class="n">txt</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">c</span> <span class="o">=</span> <span class="n">compress</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Compressed size: &quot;</span><span class="p">,</span> <span class="o">#</span><span class="n">c</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">txt2</span> <span class="o">=</span> <span class="n">uncompress</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">#</span><span class="n">txt</span><span class="p">)</span>
<span class="nb">assert</span><span class="p">(</span><span class="n">txt2</span> <span class="o">==</span> <span class="n">txt</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>ffi_meta.lua</strong></p>
<p>Use the <a class="reference external" href="http://luajit.org/ext_ffi.html">LuaJIT ffi library</a> to
access a C object via a metamethod (a method which is defined with
a metatable).</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">ffi</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">ffi&quot;</span><span class="p">)</span>
<span class="n">ffi</span><span class="p">.</span><span class="n">cdef</span><span class="s">[[</span>
<span class="s">typedef struct { double x, y; } point_t;</span>
<span class="s">]]</span>

<span class="kd">local</span> <span class="n">point</span>
<span class="kd">local</span> <span class="n">mt</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">__add</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">return</span> <span class="n">point</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">b</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">b</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
  <span class="n">__len</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">return</span> <span class="nb">math.sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">a</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span>
  <span class="n">__index</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">area</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">a</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">a</span><span class="p">.</span><span class="n">y</span> <span class="k">end</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">}</span>
<span class="n">point</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">metatype</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">point_t&quot;</span><span class="p">,</span> <span class="n">mt</span><span class="p">)</span>

<span class="kd">local</span> <span class="n">a</span> <span class="o">=</span> <span class="n">point</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>  <span class="c1">--&gt; 3  4</span>
<span class="nb">print</span><span class="p">(</span><span class="o">#</span><span class="n">a</span><span class="p">)</span>        <span class="c1">--&gt; 5</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">:</span><span class="n">area</span><span class="p">())</span>  <span class="c1">--&gt; 25</span>
<span class="kd">local</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">point</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="o">#</span><span class="n">b</span><span class="p">)</span>        <span class="c1">--&gt; 12.5</span>
</pre></div>
</div>
<p><strong>print_arrays.lua</strong></p>
<p>Create Lua tables, and print them.
Notice that for the 'array' table the iterator function
is ipairs(), while for the 'map' table the iterator function
is pairs(). (<cite>ipairs()</cite> is faster than <cite>pairs()</cite>, but pairs()
is recommended for map-like tables or mixed tables.)
The display will look like:
&quot;1 Apple | 2 Orange | 3 Grapefruit | 4 Banana | k3 v3 | k1 v1 | k2 v2&quot;.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="n">array</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;</span><span class="s">Apple&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Orange&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Grapefruit&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Banana&#39;</span><span class="p">}</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="k">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="k">do</span> <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">end</span>

<span class="n">map</span> <span class="o">=</span> <span class="p">{</span> <span class="n">k1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">v1&#39;</span><span class="p">,</span> <span class="n">k2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">v2&#39;</span><span class="p">,</span> <span class="n">k3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">v3&#39;</span> <span class="p">}</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">map</span><span class="p">)</span> <span class="k">do</span> <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">end</span>
</pre></div>
</div>
<p><strong>count_array.lua</strong></p>
<p>Use the '#' operator to get the number of items in an array-like Lua table.
This operation has O(log(N)) complexity.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="n">array</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">}</span>
<span class="nb">print</span><span class="p">(</span><span class="o">#</span><span class="n">array</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>count_array_with_nils.lua</strong></p>
<p>Missing elements in arrays, which Lua treats a &quot;nil&quot;s,
cause the simple &quot;#&quot; operator to deliver improper results.
The &quot;print(#t)&quot; instruction will print &quot;4&quot;;
the &quot;print(counter)&quot; instruction will print &quot;3&quot;;
the &quot;print(max)&quot; instruction will print &quot;10&quot;.
Other table functions, such as table.sort(), will
also misbehave when &quot;nils&quot; are present.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">t</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
<span class="nb">print</span><span class="p">(</span><span class="o">#</span><span class="n">t</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">do</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">end</span>
<span class="nb">print</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">do</span> <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="n">max</span> <span class="k">then</span> <span class="n">max</span> <span class="o">=</span> <span class="n">k</span> <span class="k">end</span> <span class="k">end</span>
<span class="nb">print</span><span class="p">(</span><span class="n">max</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>count_array_with_nulls.lua</strong></p>
<p>Use explicit <code class="docutils literal"><span class="pre">NULL</span></code> values to avoid the problems caused by Lua's
nil == missing value behavior. Although <code class="code docutils literal"><span class="pre">json.NULL</span> <span class="pre">==</span> <span class="pre">nil</span></code> is
<code class="code docutils literal"><span class="pre">true</span></code>, all the print instructions in this program will print
the correct value: 10.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">json</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">json&#39;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">NULL</span><span class="p">;</span> <span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">NULL</span><span class="p">;</span>
<span class="n">t</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">t</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">NULL</span><span class="p">;</span> <span class="n">t</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">NULL</span><span class="p">;</span>
<span class="n">t</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">t</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">NULL</span><span class="p">;</span> <span class="n">t</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">NULL</span><span class="p">;</span>
<span class="n">t</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">NULL</span>
<span class="n">t</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
<span class="nb">print</span><span class="p">(</span><span class="o">#</span><span class="n">t</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">do</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">end</span>
<span class="nb">print</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">do</span> <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="n">max</span> <span class="k">then</span> <span class="n">max</span> <span class="o">=</span> <span class="n">k</span> <span class="k">end</span> <span class="k">end</span>
<span class="nb">print</span><span class="p">(</span><span class="n">max</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>count_map.lua</strong></p>
<p>Get the number of elements in a map-like table.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">map</span> <span class="o">=</span> <span class="p">{</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">20</span> <span class="p">}</span>
<span class="kd">local</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">map</span><span class="p">)</span> <span class="k">do</span> <span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="k">end</span>
<span class="nb">print</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>swap.lua</strong></p>
<p>Use a Lua peculiarity to swap two variables without needing a third variable.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
<span class="kd">local</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p id="e-cookbook-uri-parse"><strong>uri.lua</strong></p>
<p>Use built-in function <code class="code docutils literal"><span class="pre">uri_parse</span></code> to see what is in a <cite>URI &lt;configuration-uri&gt;</cite>:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">uri</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">uri&#39;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">r</span><span class="o">=</span> <span class="n">uri</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">scheme://login:password@host:service:/path1/path2/path3?q1=v1&amp;q2=v2#fragment&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">r.password=&#39;</span><span class="p">,</span><span class="n">r</span><span class="p">.</span><span class="n">password</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">r.path=&#39;</span><span class="p">,</span><span class="n">r</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">r.scheme&#39;</span><span class="p">,</span><span class="n">r</span><span class="p">.</span><span class="n">scheme</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">r.login=&#39;</span><span class="p">,</span><span class="n">r</span><span class="p">.</span><span class="n">login</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">r.query=&#39;</span><span class="p">,</span><span class="n">r</span><span class="p">.</span><span class="n">query</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">r.service=&#39;</span><span class="p">,</span><span class="n">r</span><span class="p">.</span><span class="n">service</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">r.fragment=&#39;</span><span class="p">,</span><span class="n">r</span><span class="p">.</span><span class="n">fragment</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">r.host=&#39;</span><span class="p">,</span><span class="n">r</span><span class="p">.</span><span class="n">host</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>class.lua</strong></p>
<p>Create a class, create a metatable for the class, create an instance of the class.
Another illustration is at <a class="reference external" href="http://lua-users.org/wiki/LuaClassesWithMetatable">http://lua-users.org/wiki/LuaClassesWithMetatable</a>.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="c1">-- define class objects</span>
<span class="kd">local</span> <span class="n">myclass_somemethod</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">test 1&#39;</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">myclass_someothermethod</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">test 2&#39;</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">myclass_tostring</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="s">MyClass &lt;&#39;</span><span class="o">..</span><span class="n">self</span><span class="p">.</span><span class="n">data</span><span class="o">..</span><span class="s1">&#39;</span><span class="s">&gt;&#39;</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">myclass_mt</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">__tostring</span> <span class="o">=</span> <span class="n">myclass_tostring</span><span class="p">;</span>
    <span class="n">__index</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">somemethod</span> <span class="o">=</span> <span class="n">myclass_somemethod</span><span class="p">;</span>
        <span class="n">someothermethod</span> <span class="o">=</span> <span class="n">myclass_someothermethod</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">-- create a new object of myclass</span>
<span class="kd">local</span> <span class="n">object</span> <span class="o">=</span> <span class="nb">setmetatable</span><span class="p">({</span> <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">data&#39;</span><span class="p">},</span> <span class="n">myclass_mt</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">object</span><span class="p">:</span><span class="n">somemethod</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">object</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>garbage.lua</strong></p>
<p>Force Lua <a class="reference external" href="https://www.lua.org/manual/5.1/manual.html#2.10">garbage collection</a>
with the <a class="reference external" href="https://www.lua.org/manual/5.1/manual.html#pdf-collectgarbage">collectgarbage function</a>.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="nb">collectgarbage</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">collect&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>fiber_producer_and_consumer.lua</strong></p>
<p>Start one fiber for producer and one fiber for consumer.
Use <a class="reference internal" href="singlehtml.html#fiber-ipc-channel"><span class="std std-ref">fiber.channel()</span></a> to exchange data and synchronize.
One can tweak the channel size (<code class="code docutils literal"><span class="pre">ch_size</span></code> in the program code)
to control the number of simultaneous tasks waiting for processing.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">fiber</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fiber&#39;</span><span class="p">)</span>
<span class="kd">local</span> <span class="k">function</span> <span class="nf">consumer_loop</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="c1">-- initialize consumer synchronously or raise an error()</span>
    <span class="n">fiber</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">-- allow fiber.create() to continue</span>
    <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">data</span> <span class="o">=</span> <span class="n">ch</span><span class="p">:</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
            <span class="k">break</span>
        <span class="k">end</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">consumed&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">fiber</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="nb">math.random</span><span class="p">())</span> <span class="c1">-- simulate some work</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">producer_loop</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="c1">-- initialize consumer synchronously or raise an error()</span>
    <span class="n">fiber</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">-- allow fiber.create() to continue</span>
    <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">data</span> <span class="o">=</span> <span class="nb">math.random</span><span class="p">()</span>
        <span class="n">ch</span><span class="p">:</span><span class="n">put</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">produced&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">start</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">consumer_n</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="kd">local</span> <span class="n">producer_n</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1">-- Create a channel</span>
    <span class="kd">local</span> <span class="n">ch_size</span> <span class="o">=</span> <span class="nb">math.max</span><span class="p">(</span><span class="n">consumer_n</span><span class="p">,</span> <span class="n">producer_n</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">fiber</span><span class="p">.</span><span class="n">channel</span><span class="p">(</span><span class="n">ch_size</span><span class="p">)</span>

    <span class="c1">-- Start consumers</span>
    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">consumer_n</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
        <span class="n">fiber</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">consumer_loop</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="c1">-- Start producers</span>
    <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">producer_n</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span>
        <span class="n">fiber</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">producer_loop</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">start</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">started&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>socket_tcpconnect.lua</strong></p>
<p>Use <a class="reference internal" href="singlehtml.html#socket-tcp-connect"><span class="std std-ref">socket.tcp_connect()</span></a>
to connect to a remote host via TCP.
Display the connection details and the result of a GET request.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">s</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">socket&#39;</span><span class="p">).</span><span class="n">tcp_connect</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">google.com&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="n">peer</span><span class="p">().</span><span class="n">host</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="n">peer</span><span class="p">().</span><span class="n">family</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="n">peer</span><span class="p">().</span><span class="nb">type</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="n">peer</span><span class="p">().</span><span class="n">protocol</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="n">peer</span><span class="p">().</span><span class="n">port</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">GET / HTTP/1.0</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>socket_tcp_echo.lua</strong></p>
<p>Use <a class="reference internal" href="singlehtml.html#socket-tcp-connect"><span class="std std-ref">socket.tcp_connect()</span></a>
to set up a simple TCP server, by creating
a function that handles requests and echos them,
and passing the function to
<a class="reference internal" href="singlehtml.html#socket-tcp-server"><span class="std std-ref">socket.tcp_server()</span></a>.
This program has been used to test with 100,000 clients,
with each client getting a separate fiber.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">handler</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">peer</span><span class="p">)</span>
    <span class="n">s</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Welcome to test server, &quot;</span> <span class="o">..</span> <span class="n">peer</span><span class="p">.</span><span class="n">host</span> <span class="o">..</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">line</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
            <span class="k">break</span> <span class="c1">-- error or eof</span>
        <span class="k">end</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">pong: &quot;</span><span class="o">..</span><span class="n">line</span><span class="p">)</span> <span class="k">then</span>
            <span class="k">break</span> <span class="c1">-- error or eof</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">server</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">socket&#39;</span><span class="p">).</span><span class="n">tcp_server</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">localhost&#39;</span><span class="p">,</span> <span class="mi">3311</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>getaddrinfo.lua</strong></p>
<p>Use <a class="reference internal" href="singlehtml.html#socket-getaddrinfo"><span class="std std-ref">socket.getaddrinfo()</span></a> to perform
non-blocking DNS resolution, getting both the AF_INET6 and AF_INET
information for 'google.com'.
This technique is not always necessary for tcp connections because
<a class="reference internal" href="singlehtml.html#socket-tcp-connect"><span class="std std-ref">socket.tcp_connect()</span></a>
performs <cite>socket.getaddrinfo</cite> under the hood,
before trying to connect to the first available address.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">s</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">socket&#39;</span><span class="p">).</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">google.com&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">http&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">SOCK_STREAM&#39;</span> <span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">host=&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">host</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">family=&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">family</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">type=&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nb">type</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">protocol=&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">protocol</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">port=&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">port</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">host=&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">host</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">family=&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">family</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">type=&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nb">type</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">protocol=&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">protocol</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">port=&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">port</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>socket_udp_echo.lua</strong></p>
<p>Tarantool does not currently have a <cite>udp_server</cite> function,
therefore socket_udp_echo.lua is more complicated than
socket_tcp_echo.lua.
It can be implemented with sockets and fibers.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">socket</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">socket&#39;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">errno</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">errno&#39;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">fiber</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fiber&#39;</span><span class="p">)</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">udp_server_loop</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
    <span class="n">fiber</span><span class="p">.</span><span class="n">name</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">udp_server&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
        <span class="c1">-- try to read a datagram first</span>
        <span class="kd">local</span> <span class="n">msg</span><span class="p">,</span> <span class="n">peer</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">recvfrom</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">&quot;</span> <span class="k">then</span>
            <span class="c1">-- socket was closed via s:close()</span>
            <span class="k">break</span>
        <span class="k">elseif</span> <span class="n">msg</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="k">then</span>
            <span class="c1">-- got a new datagram</span>
            <span class="n">handler</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span><span class="n">errno</span><span class="p">()</span> <span class="o">==</span> <span class="n">errno</span><span class="p">.</span><span class="n">EAGAIN</span> <span class="ow">or</span> <span class="n">s</span><span class="p">:</span><span class="n">errno</span><span class="p">()</span> <span class="o">==</span> <span class="n">errno</span><span class="p">.</span><span class="n">EINTR</span> <span class="k">then</span>
                <span class="c1">-- socket is not ready</span>
                <span class="n">s</span><span class="p">:</span><span class="n">readable</span><span class="p">()</span> <span class="c1">-- yield, epoll will wake us when new data arrives</span>
            <span class="k">else</span>
                <span class="c1">-- socket error</span>
                <span class="kd">local</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="nb">error</span><span class="p">()</span>
                <span class="n">s</span><span class="p">:</span><span class="n">close</span><span class="p">()</span> <span class="c1">-- save resources and don&#39;t wait GC</span>
                <span class="nb">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Socket error: &quot;</span> <span class="o">..</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">udp_server</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">AF_INET&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">SOCK_DGRAM&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span> <span class="k">then</span>
        <span class="k">return</span> <span class="kc">nil</span> <span class="c1">-- check errno:strerror()</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span><span class="n">bind</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="k">then</span>
        <span class="kd">local</span> <span class="n">e</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">errno</span><span class="p">()</span> <span class="c1">-- save errno</span>
        <span class="n">s</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
        <span class="n">errno</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1">-- restore errno</span>
        <span class="k">return</span> <span class="kc">nil</span> <span class="c1">-- check errno:strerror()</span>
    <span class="k">end</span>

    <span class="n">fiber</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">udp_server_loop</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span> <span class="c1">-- start a new background fiber</span>
    <span class="k">return</span> <span class="n">s</span>
<span class="k">end</span>
</pre></div>
</div>
<p>A function for a client that connects to this server could
look something like this ...</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="k">function</span> <span class="nf">handler</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
    <span class="c1">-- You don&#39;t have to wait until socket is ready to send UDP</span>
    <span class="c1">-- s:writable()</span>
    <span class="n">s</span><span class="p">:</span><span class="n">sendto</span><span class="p">(</span><span class="n">peer</span><span class="p">.</span><span class="n">host</span><span class="p">,</span> <span class="n">peer</span><span class="p">.</span><span class="n">port</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">Pong: &quot;</span> <span class="o">..</span> <span class="n">msg</span><span class="p">)</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">server</span> <span class="o">=</span> <span class="n">udp_server</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">3548</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">server</span> <span class="k">then</span>
    <span class="nb">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Failed to bind: &#39;</span> <span class="o">..</span> <span class="n">errno</span><span class="p">.</span><span class="n">strerror</span><span class="p">())</span>
<span class="k">end</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Started&#39;</span><span class="p">)</span>

<span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">console&#39;</span><span class="p">).</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>http_get.lua</strong></p>
<p>Use the <a class="reference external" href="https://github.com/tarantool/http/">http</a> <a class="reference external" href="http://rocks.tarantool.org/">rock</a> (which must first be installed)
to get data via HTTP.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">http_client</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">http.client&#39;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">json</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">json&#39;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">r</span> <span class="o">=</span> <span class="n">http_client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">http://api.openweathermap.org/data/2.5/weather?q=Oakland,us&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">status</span> <span class="o">~=</span> <span class="mi">200</span> <span class="k">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Failed to get weather forecast &#39;</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">reason</span><span class="p">)</span>
    <span class="k">return</span>
<span class="k">end</span>
<span class="kd">local</span> <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Oakland wind speed: &#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">wind</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>http_send.lua</strong></p>
<p>Use the <a class="reference external" href="https://github.com/tarantool/http/">http</a> <a class="reference external" href="http://rocks.tarantool.org/">rock</a> (which must first be installed)
to send data via HTTP.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="n">http_client</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">http.client&#39;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">json</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">json&#39;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span> <span class="n">Key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">Value&#39;</span><span class="p">})</span>
<span class="kd">local</span> <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="n">Token</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">xxxx&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;</span><span class="s">X-Secret-Value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span> <span class="p">}</span>
<span class="kd">local</span> <span class="n">r</span> <span class="o">=</span> <span class="n">http_client</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">http://localhost:8081&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="p">{</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="p">})</span>
<span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span> <span class="k">then</span>
    <span class="nb">print</span> <span class="s1">&#39;</span><span class="s">Success&#39;</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>http_server.lua</strong></p>
<p>Use the <a class="reference external" href="https://github.com/tarantool/http/">http</a> <a class="reference external" href="http://rocks.tarantool.org/">rock</a> (which must first be installed)
to turn Tarantool into a web server.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">handler</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">:</span><span class="n">render</span><span class="p">{</span> <span class="n">json</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="s1">&#39;</span><span class="s">Your-IP-Is&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">peer</span><span class="p">.</span><span class="n">host</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">server</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">http.server&#39;</span><span class="p">).</span><span class="n">new</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span> <span class="c1">-- listen *:8080</span>
<span class="n">server</span><span class="p">:</span><span class="n">route</span><span class="p">({</span> <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">/&#39;</span> <span class="p">},</span> <span class="n">handler</span><span class="p">)</span>
<span class="n">server</span><span class="p">:</span><span class="n">start</span><span class="p">()</span>
<span class="c1">-- connect to localhost:8080 and see json</span>
</pre></div>
</div>
<p><strong>http_generate_html.lua</strong></p>
<p>Use the <a class="reference external" href="https://github.com/tarantool/http/">http</a> <cite>rock</cite> (which must first be installed)
to generate HTML pages from templates.
The <a class="reference external" href="https://github.com/tarantool/http/">http</a> <a class="reference external" href="http://rocks.tarantool.org/">rock</a> has a fairly simple template engine which allows execution
of regular Lua code inside text blocks (like PHP). Therefore there is no need
to learn new languages in order to write templates.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/env tarantool</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">handler</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">fruits</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;</span><span class="s">Apple&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Orange&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Grapefruit&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Banana&#39;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">:</span><span class="n">render</span><span class="p">{</span> <span class="n">fruits</span> <span class="o">=</span> <span class="n">fruits</span> <span class="p">}</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">server</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">http.server&#39;</span><span class="p">).</span><span class="n">new</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span> <span class="c1">-- nil means &#39;*&#39;</span>
<span class="n">server</span><span class="p">:</span><span class="n">route</span><span class="p">({</span> <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">/&#39;</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">index.html.lua&#39;</span> <span class="p">},</span> <span class="n">handler</span><span class="p">)</span>
<span class="n">server</span><span class="p">:</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>An &quot;HTML&quot; file for this server, including Lua, could look like this
(it would produce &quot;1 Apple | 2 Orange | 3 Grapefruit | 4 Banana&quot;).</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>&lt;html&gt;
&lt;body&gt;
    &lt;table <span class="nv">border</span><span class="o">=</span><span class="s2">&quot;1&quot;</span>&gt;
        % <span class="k">for</span> i,v in pairs<span class="o">(</span>fruits<span class="o">)</span> <span class="k">do</span>
        &lt;tr&gt;
            &lt;td&gt;&lt;%<span class="o">=</span> i %&gt;&lt;/td&gt;
            &lt;td&gt;&lt;%<span class="o">=</span> v %&gt;&lt;/td&gt;
        &lt;/tr&gt;
        % end
    &lt;/table&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
</div>
<span id="document-book/app/f_c_tutorial"></span><div class="section" id="appendix-f-c-tutorial">
<h3>14. Приложение F. Учебные примеры на языке C<a class="headerlink" href="#appendix-f-c-tutorial" title="Ссылка на этот заголовок">¶</a></h3>
<p>There is one C tutorial:
<a class="reference internal" href="#f-c-tutorial-c-stored-procedures"><span class="std std-ref">C stored procedures</span></a>.</p>
<div class="section" id="c-stored-procedures">
<span id="f-c-tutorial-c-stored-procedures"></span><h4>14.1. Работа с хранимыми процедурами на языке C<a class="headerlink" href="#c-stored-procedures" title="Ссылка на этот заголовок">¶</a></h4>
<p>Tarantool can call C code with <a class="reference internal" href="singlehtml.html#modules-example-c"><span class="std std-ref">modules</span></a>,
or with <a class="reference internal" href="singlehtml.html#e-cookbook-ffi-printf"><span class="std std-ref">ffi</span></a>,
or with C stored procedures.
This tutorial only is about the third option, C stored procedures.
In fact the routines are always &quot;C functions&quot; but the phrase
&quot;stored procedure&quot; is commonly used for historical reasons.</p>
<p>In this tutorial, which can be followed by anyone with a Tarantool
development package and a C compiler, there are three tasks.
The first -- <code class="code docutils literal"><span class="pre">easy.c</span></code> -- prints &quot;hello world&quot;.
The second -- <code class="code docutils literal"><span class="pre">harder.c</span></code> -- decodes a passed parameter value.
The third -- <code class="code docutils literal"><span class="pre">hardest.c</span></code> -- uses the C API to do DBMS work.</p>
<p>After following the instructions, and seeing that the results
are what is described here, users should feel confident about
writing their own stored procedures.</p>
<p><strong>Подготовка</strong></p>
<p>Check that these items exist on the computer: <br />
* Tarantool 1.7 <br />
* A gcc compiler, any modern version should work <br />
* &quot;module.h&quot; <br />
* &quot;msgpuck.h&quot; <br /></p>
<p>The &quot;module.h&quot; file will exist if Tarantool 1.7 was installed from source.
Otherwise Tarantool's &quot;developer&quot; package must be installed.
For example on Ubuntu say <br />
<code class="code docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">tarantool-dev</span></code> <br />
or on Fedora say <br />
<code class="code docutils literal"><span class="pre">dnf</span> <span class="pre">-y</span> <span class="pre">install</span> <span class="pre">tarantool-devel</span></code></p>
<p>The &quot;msgpuck.h&quot; file will exist if Tarantool 1.7 was installed from source.
Otherwise the &quot;msgpuck&quot; package must be installed from
<a class="reference external" href="https://github.com/rtsisyk/msgpuck">https://github.com/rtsisyk/msgpuck</a>.</p>
<p>Both module.h and msgpuck.h must be on the include path for the C compiler to see them.
For example, if module.h address is /usr/local/include/tarantool/module.h,
and msgpuck.h address is /usr/local/include/msgpuck/msgpuck.h,
and they are not currently on the include path, say <br />
<code class="code docutils literal"><span class="pre">export</span> <span class="pre">CPATH=/usr/local/include/tarantool:/usr/local/include/msgpuck</span></code></p>
<p>Requests will be done using tarantool as a <a class="reference internal" href="singlehtml.html#administration-using-tarantool-as-a-client"><span class="std std-ref">client</span></a>.
Start tarantool, and enter these requests.</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>box.cfg{listen=3306}
box.schema.space.create(&#39;capi_test&#39;)
box.space.capi_test:create_index(&#39;primary&#39;)
net_box = require(&#39;net.box&#39;)
capi_connection = net_box:new(3306)
</pre></div>
</div>
<p>In plainer language: create a space named capi_test,
and make a connection to self named capi_connection.</p>
<p>Leave the client running. It will be necessary to enter more requests later.</p>
<p><strong>easy.c</strong></p>
<p>Start another shell. Change directory (cd) so that it is
the same as the directory that the client is running on.</p>
<p>Create a file. Name it easy.c. Put these six lines in it.</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>#include &quot;module.h&quot;
int easy(box_function_ctx_t *ctx, const char *args, const char *args_end)
{
  printf(&quot;hello world\n&quot;);
  return 0;
}
</pre></div>
</div>
<p>Compile the program, producing a library file named easy.so: <br />
<code class="code docutils literal"><span class="pre">gcc</span> <span class="pre">-shared</span> <span class="pre">-o</span> <span class="pre">easy.so</span> <span class="pre">-fPIC</span> <span class="pre">easy.c</span></code></p>
<p>Теперь вернитесь в клиентский терминал и выполните следующие запросы:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>box.schema.func.create(&#39;easy&#39;, {language = &#39;C&#39;})
box.schema.user.grant(&#39;guest&#39;, &#39;execute&#39;, &#39;function&#39;, &#39;easy&#39;)
capi_connection:call(&#39;easy&#39;)
</pre></div>
</div>
<p>If these requests appear unfamiliar,
re-read the descriptions of
<a class="reference internal" href="singlehtml.html#box-schema-func-create"><span class="std std-ref">box.schema.func.create</span></a>
and <a class="reference internal" href="singlehtml.html#box-schema-user-grant"><span class="std std-ref">box.schema.user.grant</span></a>
and <a class="reference internal" href="singlehtml.html#net-box-call"><span class="std std-ref">conn:call</span></a>.</p>
<p>The function that matters is capi_connection:call('easy').</p>
<p>Its first job is to find the 'easy' function, which should
be easy because by default Tarantool looks on the current
directory for a file named easy.so.</p>
<p>Its second job is to call the 'easy' function.
Since the easy() function in easy.c begins with <code class="code docutils literal"><span class="pre">printf(&quot;hello</span> <span class="pre">world\n&quot;)</span></code>,
the words &quot;hello world&quot; will appear on the screen.</p>
<p>Its third job is to check that the call was successful.
Since the easy() function in easy.c ends with <code class="code docutils literal"><span class="pre">return</span> <span class="pre">0</span></code>,
there is no error message to display and the request is over.</p>
<p>Вывод на экране будет выглядеть следующим образом:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>tarantool&gt; capi_connection:call(&#39;easy&#39;)
hello world
---
- []
...
</pre></div>
</div>
<p>Conclusion: calling a C function is easy.</p>
<p><strong>harder.c</strong></p>
<p>Go back to the shell where the easy.c program was created.</p>
<p>Create a file. Name it harder.c. Put these 17 lines in it:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>#include &quot;module.h&quot;
#include &quot;msgpuck.h&quot;
int harder(box_function_ctx_t *ctx, const char *args, const char *args_end)
{
  uint32_t arg_count = mp_decode_array(&amp;args);
  printf(&quot;arg_count = %d\n&quot;, arg_count);
  uint32_t field_count = mp_decode_array(&amp;args);
  printf(&quot;field_count = %d\n&quot;, field_count);
  uint32_t val;
  int i;
  for (i = 0; i &lt; field_count; ++i)
  {
    val = mp_decode_uint(&amp;args);
    printf(&quot;val=%d.\n&quot;, val);
  }
  return 0;
}
</pre></div>
</div>
<p>Compile the program, producing a library file named harder.so: <br />
<code class="code docutils literal"><span class="pre">gcc</span> <span class="pre">-shared</span> <span class="pre">-o</span> <span class="pre">harder.so</span> <span class="pre">-fPIC</span> <span class="pre">harder.c</span></code></p>
<p>Теперь вернитесь в клиентский терминал и выполните следующие запросы:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>box.schema.func.create(&#39;harder&#39;, {language = &#39;C&#39;})
box.schema.user.grant(&#39;guest&#39;, &#39;execute&#39;, &#39;function&#39;, &#39;harder&#39;)
passable_table = {}
table.insert(passable_table, 1)
table.insert(passable_table, 2)
table.insert(passable_table, 3)
capi_connection:call(&#39;harder&#39;, passable_table)
</pre></div>
</div>
<p>This time the call is passing a Lua table (passable_table)
to the harder() function. The harder() function will see it,
it's in the <code class="code docutils literal"><span class="pre">char</span> <span class="pre">*args</span></code> parameter.</p>
<p>At this point the harder() function will start using functions
defined in msgpuck.h, which are documented in
<a class="reference external" href="http://rtsisyk.github.io/msgpuck">http://rtsisyk.github.io/msgpuck</a>.
The routines that begin with &quot;mp&quot; are msgpuck functions that
handle data formatted according to the <a class="reference external" href="http://msgpack.org/">MsgPack</a> specification.
Passes and returns are always done with this format so
one must become acquainted with msgpuck
to become proficient with the C API.</p>
<p>For now, though, it's enough to know that mp_decode_array()
returns the number of elements in an array, and mp_decode_uint
returns an unsigned integer, from <code class="code docutils literal"><span class="pre">args</span></code>. And there's a side
effect: when the decoding finishes, <code class="code docutils literal"><span class="pre">args</span></code> has changed
and is now pointing to the next element.</p>
<p>Therefore the first displayed line will be &quot;arg_count = 1&quot;
because there was only one item passed: passable_table. <br />
The second displayed line will be &quot;field_count = 3&quot;
because there are three items in the table. <br />
The next three lines will be &quot;1&quot; and &quot;2&quot; and &quot;3&quot;
because those are the values in the items in the table.</p>
<p>Теперь вывод на экране выглядит следующим образом:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>tarantool&gt; capi_connection:call(&#39;harder&#39;, passable_table)
arg_count = 1
field_count = 3
val=1.
val=2.
val=3.
---
- []
...
</pre></div>
</div>
<p>Conclusion: decoding parameter values passed to a
C function is not easy at first, but there are routines
to do the job, and they're documented, and there aren't
very many of them.</p>
<p><strong>hardest.c</strong></p>
<p>Go back to the shell where the easy.c
and the harder.c programs were created.</p>
<p>Create a file. Name it hardest.c. Put these 13 lines in it:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>#include &quot;module.h&quot;
#include &quot;msgpuck.h&quot;
int hardest(box_function_ctx_t *ctx, const char *args, const char *args_end)
{
  uint32_t space_id = box_space_id_by_name(&quot;capi_test&quot;, strlen(&quot;capi_test&quot;));
  char tuple[1024];
  char *tuple_pointer = tuple;
  tuple_pointer = mp_encode_array(tuple_pointer, 2);
  tuple_pointer = mp_encode_uint(tuple_pointer, 10000);
  tuple_pointer = mp_encode_str(tuple_pointer, &quot;String 2&quot;, 8);
  int n = box_insert(space_id, tuple, tuple_pointer, NULL);
  return n;
}
</pre></div>
</div>
<p>Compile the program, producing a library file named hardest.so: <br />
<code class="code docutils literal"><span class="pre">gcc</span> <span class="pre">-shared</span> <span class="pre">-o</span> <span class="pre">hardest.so</span> <span class="pre">-fPIC</span> <span class="pre">hardest.c</span></code></p>
<p>Теперь вернитесь в клиентский терминал и выполните следующие запросы:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>box.schema.func.create(&#39;hardest&#39;, {language = &quot;C&quot;})
box.schema.user.grant(&#39;guest&#39;, &#39;execute&#39;, &#39;function&#39;, &#39;hardest&#39;)
box.schema.user.grant(&#39;guest&#39;, &#39;read,write&#39;, &#39;space&#39;, &#39;capi_test&#39;)
capi_connection:call(&#39;hardest&#39;)
</pre></div>
</div>
<p>This time the C function is doing three things:
(1) finding the numeric identifier of the &quot;capi_test&quot; space
by calling box_space_id_by_name(); <br />
(2) formatting a tuple using more msgpuck.h functions; <br />
(3) inserting a row using box_insert.</p>
<p>Now, still on the client, execute this request: <br />
<code class="code docutils literal"><span class="pre">box.space.capi_test:select()</span></code></p>
<p>Вывод на экране будет выглядеть следующим образом:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>tarantool&gt; box.space.capi_test:select()
---
- - [10000, &#39;String 2&#39;]
...
</pre></div>
</div>
<p>This proves that the hardest() function succeeded, but
where did box_space_id_by_name() and box_insert() come from?
Answer: the C API. The whole C API is documented <a class="reference internal" href="singlehtml.html#index-c-api-reference"><span class="std std-ref">here</span></a>.
The function box_space_id_by_name() is documented <a class="reference internal" href="singlehtml.html#box-box-space-id-by-name"><span class="std std-ref">here</span></a>.
The function box_insert() is documented <a class="reference internal" href="singlehtml.html#box-box-insert"><span class="std std-ref">here</span></a>.</p>
<p>Conclusion: the long description of the C API is
there for a good reason.
All of the functions in it can be called from C functions
which are called from Lua.
So C &quot;stored procedures&quot; have full access to the database.</p>
<p><strong>Cleaning up</strong></p>
<p>Get rid of each of the function tuples with <a class="reference internal" href="singlehtml.html#box-schema-func-drop"><span class="std std-ref">box.schema.func.drop</span></a>,
and get rid of the capi_test space with <a class="reference internal" href="singlehtml.html#box-space-drop"><span class="std std-ref">box.schema.capi_test:drop()</span></a>,
and remove the .c and .so files that were created for this
tutorial.</p>
<p><strong>An example in the test suite</strong></p>
<p>Download the source code of Tarantool. Look in a subdirectory
<code class="code docutils literal"><span class="pre">test/box</span></code>. Notice that there is a file named
<code class="code docutils literal"><span class="pre">tuple_bench.test.lua</span></code> and another file named
<code class="code docutils literal"><span class="pre">tuple_bench.c</span></code>. Examine the Lua file and observe
that it is calling a function in the C file, using the
same techniques that this tutorial has shown.</p>
<p>Conclusion: parts of the standard test suite
use C stored procedures, and they must work,
because releases don't happen if Tarantool doesn't pass the tests.</p>
</div>
</div>
<span id="document-book/app/g_changes"></span><div class="section" id="appendix-g-version-specific-changes">
<h3>15. Приложение G. Версионные изменения<a class="headerlink" href="#appendix-g-version-specific-changes" title="Ссылка на этот заголовок">¶</a></h3>
<p>Здесь собрана информация о существенных изменениях, которые произошли в конкретных версиях Tarantool'а.</p>
<p>Более мелкие изменения и исправления дефектов указаны в отчетах о <a class="reference external" href="https://github.com/tarantool/tarantool/milestones?state=closed">выпущенных стабильных релизах (milestone = closed)</a> на GitHub.</p>
<div class="section" id="changes-in-tarantool-version-1-7">
<h4>15.1. Изменения в версии Tarantool 1.7<a class="headerlink" href="#changes-in-tarantool-version-1-7" title="Ссылка на этот заголовок">¶</a></h4>
<p>Дисковый движок, который в более ранних версиях Tarantool'а назывался <cite>sophia</cite> и <cite>phia</cite>, заменен новым движком под названием <cite>vinyl</cite>.</p>
<p>Добавлены новые типы индексируемых полей.</p>
<p>Обновлена версия LuaJIT.</p>
<p>У кластера репликации появилась возможность самонастройки, что существенно упрощает настройку нового кластера.</p>
<p>Функция <code class="docutils literal"><span class="pre">space_object:inc()</span></code> объявлена устаревшей.</p>
<p>Функция <code class="docutils literal"><span class="pre">space_object:dec()</span></code> объявлена устаревшей.</p>
</div>
</div>
</div>
</div>
<span id="document-reference_lua/index"></span><div class="section" id="lua-reference">
<h2>Справочник по Lua API<a class="headerlink" href="#lua-reference" title="Ссылка на этот заголовок">¶</a></h2>
<div class="toctree-wrapper compound" id="list-of-lua-modules">
<span id="document-reference_lua/box"></span><div class="section" id="module-box">
<h3>Module <cite>box</cite><a class="headerlink" href="#module-box" title="Ссылка на этот заголовок">¶</a></h3>
<p>The contents of the <code class="docutils literal"><span class="pre">box</span></code> library can be inspected at runtime
with <code class="docutils literal"><span class="pre">box</span></code>, with no arguments. The submodules inside the box library are:
<code class="docutils literal"><span class="pre">box.schema</span></code>, <code class="docutils literal"><span class="pre">box.tuple</span></code>, <code class="docutils literal"><span class="pre">box.space</span></code>, <code class="docutils literal"><span class="pre">box.index</span></code>,
<code class="docutils literal"><span class="pre">box.cfg</span></code>, <code class="docutils literal"><span class="pre">box.info</span></code>, <code class="docutils literal"><span class="pre">box.slab</span></code>, <code class="docutils literal"><span class="pre">box.stat</span></code>.
Every submodule contains one or more Lua functions. A few submodules contain
members as well as functions. The functions allow data definition (create
alter drop), data manipulation (insert delete update upsert select replace), and
introspection (inspecting contents of spaces, accessing server configuration).</p>
<div class="toctree-wrapper compound">
</div>
</div>
<span id="document-reference_lua/clock"></span><div class="section" id="module-clock">
<span id="clock-module"></span><h3>Модуль <cite>clock</cite><a class="headerlink" href="#module-clock" title="Ссылка на этот заголовок">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">clock</span></code> module returns time values derived from
the Posix / C <a class="reference external" href="http://pubs.opengroup.org/onlinepubs/9699919799/functions/clock_getres.html">CLOCK_GETTIME</a> function or equivalent.
Most functions in the module return a number of seconds;
functions whose names end in &quot;64&quot; return a 64-bit number of nanoseconds.</p>
<span class="target" id="lua-module.clock"></span><dl class="function">
<dt id="lua-функция.clock.time">
<em class="property"> </em><code class="descclassname">clock.</code><code class="descname">time</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.clock.time" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.clock.time64">
<em class="property"> </em><code class="descclassname">clock.</code><code class="descname">time64</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.clock.time64" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.clock.realtime">
<em class="property"> </em><code class="descclassname">clock.</code><code class="descname">realtime</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.clock.realtime" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.clock.realtime64">
<em class="property"> </em><code class="descclassname">clock.</code><code class="descname">realtime64</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.clock.realtime64" title="Ссылка на это определение">¶</a></dt>
<dd><p>The wall clock time. Derived from C function clock_gettime(CLOCK_REALTIME).
This is the best function for knowing what the official time is,
as determined by the system administrator.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">seconds or nanoseconds since epoch (1970-01-01 00:00:00), adjusted.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">number or number64</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- This will print an approximate number of years since 1970.</span>
<span class="n">clock</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">clock&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="mi">365</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">))</span>
</pre></div>
</div>
<p>See also <a class="reference internal" href="singlehtml.html#fiber-time64"><span class="std std-ref">fiber.time64</span></a> and <a class="reference internal" href="singlehtml.html#os-clock"><span class="std std-ref">os.clock()</span></a>.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.clock.monotonic">
<em class="property"> </em><code class="descclassname">clock.</code><code class="descname">monotonic</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.clock.monotonic" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.clock.monotonic64">
<em class="property"> </em><code class="descclassname">clock.</code><code class="descname">monotonic64</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.clock.monotonic64" title="Ссылка на это определение">¶</a></dt>
<dd><p>The monotonic time. Derived from C function clock_gettime(CLOCK_MONOTONIC).
Monotonic time is similar to wall clock time but is not affected by changes
to or from daylight saving time, or by changes done by a user.
This is the best function to use with benchmarks that need to calculate elapsed time.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">seconds or nanoseconds since the last time that the computer was booted.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">number or number64</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- This will print nanoseconds since the start.</span>
<span class="n">clock</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">clock&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">monotonic64</span><span class="p">())</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.clock.proc">
<em class="property"> </em><code class="descclassname">clock.</code><code class="descname">proc</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.clock.proc" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.clock.proc64">
<em class="property"> </em><code class="descclassname">clock.</code><code class="descname">proc64</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.clock.proc64" title="Ссылка на это определение">¶</a></dt>
<dd><p>The processor time. Derived from C function clock_gettime(CLOCK_PROCESS_CPUTIME_ID).
This is the best function to use with benchmarks that need to calculate
how much time has been spent within a CPU.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">seconds or nanoseconds since processor start.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">number or number64</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- This will print nanoseconds in the CPU since the start.</span>
<span class="n">clock</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">clock&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">proc64</span><span class="p">())</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.clock.thread">
<em class="property"> </em><code class="descclassname">clock.</code><code class="descname">thread</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.clock.thread" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.clock.thread64">
<em class="property"> </em><code class="descclassname">clock.</code><code class="descname">thread64</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.clock.thread64" title="Ссылка на это определение">¶</a></dt>
<dd><p>The thread time. Derived from C function clock_gettime(CLOCK_THREAD_CPUTIME_ID).
This is the best function to use with benchmarks that need to calculate
how much time has been spent within a thread within a CPU.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">seconds or nanoseconds since thread start.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">number or number64</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- This will print seconds in the thread since the start.</span>
<span class="n">clock</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">clock&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">thread64</span><span class="p">())</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.clock.bench">
<em class="property"> </em><code class="descclassname">clock.</code><code class="descname">bench</code><big>(</big><em>function</em><span class="optional">[</span>, <em>function parameters ...</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.clock.bench" title="Ссылка на это определение">¶</a></dt>
<dd><p>The time that a function takes within a processor.
This function uses clock.proc(), therefore it calculates elapsed CPU time.
Therefore it is not useful for showing actual elapsed time.</p>
<p>Parameters:</p>
<ul class="simple">
<li><code class="samp docutils literal"><em><span class="pre">function</span></em></code> = function or function reference;</li>
<li><code class="samp docutils literal"><em><span class="pre">function</span> <span class="pre">parameters</span></em></code> = whatever values are required by the function.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">table. first element = seconds of CPU time; second element = whatever the function returns.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">table</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- Benchmark a function which sleeps 10 seconds.</span>
<span class="c1">-- NB: bench() will not calculate sleep time.</span>
<span class="c1">-- So the returned value will be {a number less than 10, 88}.</span>
<span class="n">clock</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">clock&#39;</span><span class="p">)</span>
<span class="n">fiber</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fiber&#39;</span><span class="p">)</span>
<span class="k">function</span> <span class="nf">f</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
  <span class="n">fiber</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
  <span class="k">return</span> <span class="mi">88</span>
<span class="k">end</span>
<span class="n">clock</span><span class="p">.</span><span class="n">bench</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</div>
<span id="document-reference_lua/console"></span><div class="section" id="module-console">
<span id="console-module"></span><h3>Модуль <cite>console</cite><a class="headerlink" href="#module-console" title="Ссылка на этот заголовок">¶</a></h3>
<p>The console module allows one Tarantool server to access another Tarantool
server, and allows one Tarantool server to start listening on an <a class="reference internal" href="singlehtml.html#administration-admin-ports"><span class="std std-ref">admin port</span></a>.</p>
<span class="target" id="lua-module.console"></span><span class="target" id="console-connect"></span><dl class="function">
<dt id="lua-функция.console.connect">
<em class="property"> </em><code class="descclassname">console.</code><code class="descname">connect</code><big>(</big><em>uri</em><big>)</big><a class="headerlink" href="#lua-функция.console.connect" title="Ссылка на это определение">¶</a></dt>
<dd><p>Connect to the server at <a class="reference internal" href="singlehtml.html#index-uri"><span class="std std-ref">URI</span></a>, change the prompt from '<code class="samp docutils literal"><span class="pre">tarantool&gt;</span></code>' to
'<code class="samp docutils literal"><em><span class="pre">uri</span></em><span class="pre">&gt;</span></code>', and act henceforth as a client until the user ends the
session or types <code class="code docutils literal"><span class="pre">control-D</span></code>.</p>
<p>The console.connect function allows one Tarantool server, in interactive
mode, to access another Tarantool server. Subsequent
requests will appear to be handled locally, but in reality the requests
are being sent to the remote server and the local server is acting as a
client. Once connection is successful, the prompt will change and
subsequent requests are sent to, and executed on, the remote server.
Results are displayed on the local server. To return to local mode,
enter <code class="code docutils literal"><span class="pre">control-D</span></code>.</p>
<p>If the Tarantool server at <code class="samp docutils literal"><span class="pre">uri</span></code> requires authentication, the
connection might look something like:
<code class="code docutils literal"><span class="pre">console.connect('admin:secretpassword&#64;distanthost.com:3301')</span></code>.</p>
<p>There are no restrictions on the types of requests that can be entered,
except those which are due to privilege restrictions -- by default the
login to the remote server is done with user name = 'guest'. The remote
server could allow for this by granting at least one privilege:
<code class="code docutils literal"><span class="pre">box.schema.user.grant('guest','execute','universe')</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>uri</strong> (<em>string</em>) -- the URI of the remote server</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil</p>
</td>
</tr>
</tbody>
</table>
<p>Possible errors: the connection will fail if the target Tarantool server
was not initiated with <code class="code docutils literal"><span class="pre">box.cfg{listen=...}</span></code>.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">console</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">console&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">console</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">198.18.44.44:3301&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">198.18.44.44:3301&gt; </span><span class="c1">-- prompt is telling us that server is remote</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="console-listen"></span><dl class="function">
<dt id="lua-функция.console.listen">
<em class="property"> </em><code class="descclassname">console.</code><code class="descname">listen</code><big>(</big><em>uri</em><big>)</big><a class="headerlink" href="#lua-функция.console.listen" title="Ссылка на это определение">¶</a></dt>
<dd><p>Listen on <a class="reference internal" href="singlehtml.html#index-uri"><span class="std std-ref">URI</span></a>. The primary way of listening for incoming requests
is via the connection-information string, or URI, specified in <code class="code docutils literal"><span class="pre">box.cfg{listen=...}</span></code>.
The alternative way of listening is via the URI
specified in <code class="code docutils literal"><span class="pre">console.listen(...)</span></code>. This alternative way is called
&quot;administrative&quot; or simply <a class="reference internal" href="singlehtml.html#administration-admin-ports"><span class="std std-ref">&quot;admin port&quot;</span></a>.
The listening is usually over a local host with a Unix domain socket.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>uri</strong> (<em>string</em>) -- the URI of the local server</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>The &quot;admin&quot; address is the URI to listen on.
It has no default value, so it must be specified if
connections will occur via an admin port.
The parameter is expressed with URI = Universal Resource
Identifier format, for example &quot;/tmpdir/unix_domain_socket.sock&quot;, or a
numeric TCP port. Connections are often made with telnet.
A typical port value is 3313.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">console</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">console&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">console</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">unix/:/tmp/X.sock&#39;</span><span class="p">)</span>
<span class="go">... main/103/console/unix/:/tmp/X I&gt; started</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">fd</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">6</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">host</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">unix/</span>
    <span class="l l-Scalar l-Scalar-Plain">family</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">AF_UNIX</span>
    <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">SOCK_STREAM</span>
    <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/X.sock</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="console-start"></span><dl class="function">
<dt id="lua-функция.console.start">
<em class="property"> </em><code class="descclassname">console.</code><code class="descname">start</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.console.start" title="Ссылка на это определение">¶</a></dt>
<dd><p>Start the console on the current interactive terminal.</p>
<p><strong>Example:</strong></p>
<p>A special use of <code class="docutils literal"><span class="pre">console.start()</span></code> is with
<a class="reference internal" href="singlehtml.html#index-init-label"><span class="std std-ref">initialization files</span></a>.
Normally, if one starts the tarantool server with
<code class="samp docutils literal"><span class="pre">tarantool</span> <em><span class="pre">initialization</span> <span class="pre">file</span></em></code>
there is no console. This can be remedied by adding
these lines at the end of the initialization file:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">console</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">console&#39;</span><span class="p">)</span>
<span class="n">console</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="console-ac"></span><dl class="function">
<dt id="lua-функция.console.ac">
<em class="property"> </em><code class="descclassname">console.</code><code class="descname">ac</code><big>(</big><span class="optional">[</span><em>true|false</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.console.ac" title="Ссылка на это определение">¶</a></dt>
<dd><p>Set the auto-completion flag. If auto-completion is <cite>true</cite>,
and the user is using tarantool as a client, then hitting
the TAB key may cause tarantool to complete a word automatically.
The default auto-completion value is <cite>true</cite>.</p>
</dd></dl>

</div>
<span id="document-reference_lua/crypto"></span><div class="section" id="lua-module.crypto.cipher">
<span id="module-crypto"></span><span id="crypto"></span><h3>Модуль <cite>crypto</cite><a class="headerlink" href="#lua-module.crypto.cipher" title="Ссылка на этот заголовок">¶</a></h3>
<p>&quot;Crypto&quot; is short for &quot;Cryptography&quot;, which generally refers to the production
of a digest value from a function (usually a <a class="reference external" href="https://en.wikipedia.org/wiki/Cryptographic_hash_function">Cryptographic hash function</a>),
applied against a string. Tarantool's crypto module supports ten types of
cryptographic hash functions (<a class="reference external" href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Data_Encryption_Standard">DES</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Payment_Card_Industry_Data_Security_Standard">DSS</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Md4">MD4</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Md5">MD5</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/MDC-2">MDC2</a>, <a class="reference external" href="http://homes.esat.kuleuven.be/~bosselae/ripemd160.html">RIPEMD</a>,
<a class="reference external" href="https://en.wikipedia.org/wiki/Sha-0">SHA-0</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Sha-1">SHA-1</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Sha-2">SHA-2</a>). Some of the crypto functionality is also present in the
<a class="reference internal" href="singlehtml.html#digest"><span class="std std-ref">Модуль digest</span></a> module. The functions in crypto are:</p>
<dl class="varfunc">
<dt id="lua-varfunc.crypto.cipher.{aes128|aes192|aes256|des}.{cbc|cfb|ecb|ofb}.encrypt">
<em class="property"> </em><code class="descclassname">crypto.cipher.</code><code class="descname">{aes128|aes192|aes256|des}.{cbc|cfb|ecb|ofb}.encrypt</code><big>(</big><em>string</em>, <em>key</em>, <em>initialization_vector</em><big>)</big><a class="headerlink" href="#lua-varfunc.crypto.cipher.{aes128|aes192|aes256|des}.{cbc|cfb|ecb|ofb}.encrypt" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-varfunc.crypto.cipher.{aes128|aes192|aes256|des}.{cbc|cfb|ecb|ofb}.decrypt">
<em class="property"> </em><code class="descclassname">crypto.cipher.</code><code class="descname">{aes128|aes192|aes256|des}.{cbc|cfb|ecb|ofb}.decrypt</code><big>(</big><em>string</em>, <em>key</em>, <em>initialization_vector</em><big>)</big><a class="headerlink" href="#lua-varfunc.crypto.cipher.{aes128|aes192|aes256|des}.{cbc|cfb|ecb|ofb}.decrypt" title="Ссылка на это определение">¶</a></dt>
<dd><p>Pass or return a cipher derived from the string, key, and (optionally,
sometimes) initialization vector. The four choices of algorithms:</p>
<ul class="simple">
<li>aes128 - aes-128 (with 192-bit binary strings using AES)</li>
<li>aes192 - aes-192 (with 192-bit binary strings using AES)</li>
<li>aes256 - aes-256 (with 256-bit binary strings using AES)</li>
<li>des    - des (with 56-bit binary strings using DES, though DES is not
recommended)</li>
</ul>
<p>Four choices of block cipher modes are also available:</p>
<ul class="simple">
<li>cbc - Cipher Block Chaining</li>
<li>cfb - Cipher Feedback</li>
<li>ecb - Electronic Codebook</li>
<li>ofb - Output Feedback</li>
</ul>
<p>For more information on, read article about <a class="reference external" href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation">Encryption Modes</a></p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher</span><span class="p">.</span><span class="n">aes192</span><span class="p">.</span><span class="n">cbc</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">key&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">initialization&#39;</span><span class="p">)</span>
<span class="n">crypto</span><span class="p">.</span><span class="n">cipher</span><span class="p">.</span><span class="n">aes256</span><span class="p">.</span><span class="n">ecb</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">key&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">initialization&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="lua-module.crypto.digest"></span><dl class="varfunc">
<dt id="lua-varfunc.crypto.digest.{dss|dss1|md4|md5|mdc2|ripemd160}">
<em class="property"> </em><code class="descclassname">crypto.digest.</code><code class="descname">{dss|dss1|md4|md5|mdc2|ripemd160}</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-varfunc.crypto.digest.{dss|dss1|md4|md5|mdc2|ripemd160}" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-varfunc.crypto.digest.{sha|sha1|sha224|sha256|sha384|sha512}">
<em class="property"> </em><code class="descclassname">crypto.digest.</code><code class="descname">{sha|sha1|sha224|sha256|sha384|sha512}</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-varfunc.crypto.digest.{sha|sha1|sha224|sha256|sha384|sha512}" title="Ссылка на это определение">¶</a></dt>
<dd><p>Pass or return a digest derived from the string. The twelve choices of
algorithms:</p>
<ul class="simple">
<li>dss - dss (using DSS)</li>
<li>dss1 - dss (using DSS-1)</li>
<li>md4 - md4 (with 128-bit binary strings using MD4)</li>
<li>md5 - md5 (with 128-bit binary strings using MD5)</li>
<li>mdc2 - mdc2 (using MDC2)</li>
<li>ripemd160 -</li>
<li>sha - sha (with 160-bit binary strings using SHA-0)</li>
<li>sha1 - sha-1 (with 160-bit binary strings using SHA-1)</li>
<li>sha224 - sha-224 (with 224-bit binary strings using SHA-2)</li>
<li>sha256 - sha-256 (with 256-bit binary strings using SHA-2)</li>
<li>sha384 - sha-384 (with 384-bit binary strings using SHA-2)</li>
<li>sha512 - sha-512(with 512-bit binary strings using SHA-2).</li>
</ul>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">crypto</span><span class="p">.</span><span class="n">digest</span><span class="p">.</span><span class="n">md4</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span>
<span class="n">crypto</span><span class="p">.</span><span class="n">digest</span><span class="p">.</span><span class="n">sha512</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<div class="section" id="incremental-methods-in-the-crypto-module">
<h4>Incremental methods in the crypto module<a class="headerlink" href="#incremental-methods-in-the-crypto-module" title="Ссылка на этот заголовок">¶</a></h4>
<p>Suppose that a digest is done for a string 'A', then a new part 'B' is appended
to the string, then a new digest is required. The new digest could be recomputed
for the whole string 'AB', but it is faster to take what was computed before for
'A' and apply changes based on the new part 'B'. This is called multi-step or
&quot;incremental&quot; digesting, which Tarantool supports for all crypto functions..</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">crypto</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">crypto&#39;</span><span class="p">)</span>

<span class="c1">-- print aes-192 digest of &#39;AB&#39;, with one step, then incrementally</span>
<span class="nb">print</span><span class="p">(</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher</span><span class="p">.</span><span class="n">aes192</span><span class="p">.</span><span class="n">cbc</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">AB&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">key&#39;</span><span class="p">))</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">crypto</span><span class="p">.</span><span class="n">cipher</span><span class="p">.</span><span class="n">aes192</span><span class="p">.</span><span class="n">cbc</span><span class="p">.</span><span class="n">encrypt</span><span class="p">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">c</span><span class="p">:</span><span class="n">init</span><span class="p">()</span>
<span class="n">c</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">A&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">key&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">key&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="n">result</span><span class="p">())</span>
<span class="n">c</span><span class="p">:</span><span class="n">free</span><span class="p">()</span>

<span class="c1">-- print sha-256 digest of &#39;AB&#39;, with one step, then incrementally</span>
<span class="nb">print</span><span class="p">(</span><span class="n">crypto</span><span class="p">.</span><span class="n">digest</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">AB&#39;</span><span class="p">))</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">crypto</span><span class="p">.</span><span class="n">digest</span><span class="p">.</span><span class="n">sha256</span><span class="p">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">c</span><span class="p">:</span><span class="n">init</span><span class="p">()</span>
<span class="n">c</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">A&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="n">result</span><span class="p">())</span>
<span class="n">c</span><span class="p">:</span><span class="n">free</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="getting-the-same-results-from-digest-and-crypto-modules">
<h4>Getting the same results from digest and crypto modules<a class="headerlink" href="#getting-the-same-results-from-digest-and-crypto-modules" title="Ссылка на этот заголовок">¶</a></h4>
<p>The following functions are equivalent. For example, the <code class="docutils literal"><span class="pre">digest</span></code> function and
the <code class="docutils literal"><span class="pre">crypto</span></code> function will both produce the same result.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher</span><span class="p">.</span><span class="n">aes256</span><span class="p">.</span><span class="n">cbc</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">key&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">digest</span><span class="p">.</span><span class="n">aes256cbc</span><span class="p">.</span><span class="n">encrypt</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">key&#39;</span><span class="p">)</span>
<span class="n">crypto</span><span class="p">.</span><span class="n">digest</span><span class="p">.</span><span class="n">md4</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">digest</span><span class="p">.</span><span class="n">md4</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span>
<span class="n">crypto</span><span class="p">.</span><span class="n">digest</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">digest</span><span class="p">.</span><span class="n">md5</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span>
<span class="n">crypto</span><span class="p">.</span><span class="n">digest</span><span class="p">.</span><span class="n">sha</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">digest</span><span class="p">.</span><span class="n">sha</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span>
<span class="n">crypto</span><span class="p">.</span><span class="n">digest</span><span class="p">.</span><span class="n">sha1</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">digest</span><span class="p">.</span><span class="n">sha1</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span>
<span class="n">crypto</span><span class="p">.</span><span class="n">digest</span><span class="p">.</span><span class="n">sha224</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">digest</span><span class="p">.</span><span class="n">sha224</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span>
<span class="n">crypto</span><span class="p">.</span><span class="n">digest</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">digest</span><span class="p">.</span><span class="n">sha256</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span>
<span class="n">crypto</span><span class="p">.</span><span class="n">digest</span><span class="p">.</span><span class="n">sha384</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">digest</span><span class="p">.</span><span class="n">sha384</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span>
<span class="n">crypto</span><span class="p">.</span><span class="n">digest</span><span class="p">.</span><span class="n">sha512</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">digest</span><span class="p">.</span><span class="n">sha512</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<span id="document-reference_lua/csv"></span><div class="section" id="lua-module.csv">
<span id="module-csv"></span><h3>Module <cite>csv</cite><a class="headerlink" href="#lua-module.csv" title="Ссылка на этот заголовок">¶</a></h3>
<p>The csv module handles records formatted according to Comma-Separated-Values
(CSV) rules.</p>
<p>The default formatting rules are:</p>
<ul class="simple">
<li>Lua <a class="reference external" href="http://www.lua.org/pil/2.4.html">escape sequences</a> such as \n or \10 are legal within strings but not
within files,</li>
<li>Commas designate end-of-field,</li>
<li>Line feeds, or line feeds plus carriage returns, designate end-of-record,</li>
<li>Leading or trailing spaces are ignored,</li>
<li>Quote marks may enclose fields or parts of fields,</li>
<li>When enclosed by quote marks, commas and line feeds and spaces are treated
as ordinary characters, and a pair of quote marks &quot;&quot; is treated as a single
quote mark.</li>
</ul>
<p id="csv-options">The possible options which can be passed to csv functions are:</p>
<ul class="simple">
<li><code class="samp docutils literal"><span class="pre">delimiter</span> <span class="pre">=</span> <em><span class="pre">string</span></em></code> -- single-byte character to designate end-of-field, default = comma</li>
<li><code class="samp docutils literal"><span class="pre">quote_char</span> <span class="pre">=</span> <em><span class="pre">string</span></em></code> -- single-byte character to designate encloser of string, default = quote mark</li>
<li><code class="samp docutils literal"><span class="pre">chunk-size</span> <span class="pre">=</span> <em><span class="pre">number</span></em></code> -- number of characters to read at once (usually for file-IO efficiency), default = 4096</li>
<li><code class="samp docutils literal"><span class="pre">skip_head_lines</span> <span class="pre">=</span> <em><span class="pre">number</span></em></code> -- number of lines to skip at the start (usually for a header), default 0</li>
</ul>
<span class="target" id="csv-load"></span><dl class="function">
<dt id="lua-функция.csv.load">
<em class="property"> </em><code class="descclassname">csv.</code><code class="descname">load</code><big>(</big><em>readable</em><span class="optional">[</span>, <em>{options}</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.csv.load" title="Ссылка на это определение">¶</a></dt>
<dd><p>Get CSV-formatted input from <code class="docutils literal"><span class="pre">readable</span></code> and return a table as output.
Usually <code class="docutils literal"><span class="pre">readable</span></code> is either a string or a file opened for reading.
Usually <code class="samp docutils literal"><em><span class="pre">options</span></em></code> is not specified.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>readable</strong> (<em>object</em>) -- a string, or any object which has a read() method,
formatted according to the CSV rules</li>
<li><strong>options</strong> (<em>table</em>) -- see <a class="reference internal" href="#csv-options"><span class="std std-ref">above</span></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">loaded_value</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">table</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<p>Readable string has 3 fields, field#2 has comma and space so use quote marks:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">csv</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">csv&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">csv</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">a,&quot;b,c &quot;,d&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">a</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;b,c</span><span class="nv"> </span><span class="s">&#39;</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">d</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Readable string contains 2-byte character = Cyrillic Letter Palochka:
(This displays a palochka if and only if character set = UTF-8.)</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">csv</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">a</span><span class="se">\\</span><span class="s">211</span><span class="se">\\</span><span class="s">128b&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">a\211\128b</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Semicolon instead of comma for the delimiter:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">csv</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">a,b;c,d&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">;&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">a,b</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">c,d</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Readable file <code class="file docutils literal"><span class="pre">./file.csv</span></code> contains two CSV records.
Explanation of fio is in section <a class="reference internal" href="singlehtml.html#fio-section"><span class="std std-ref">fio</span></a>.
Source CSV file and example respectively:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="c1">-- input in file.csv is:</span>
<span class="gp">tarantool&gt; </span><span class="c1">-- a,&quot;b,c &quot;,d</span>
<span class="gp">tarantool&gt; </span><span class="c1">-- a\\211\\128b</span>
<span class="gp">tarantool&gt; </span><span class="n">fio</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fio&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">fio</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">./file.csv&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;</span><span class="s">O_RDONLY&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">csv</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">{</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">a</span>
    <span class="p p-Indicator">-</span> <span class="s">&#39;b,c</span><span class="nv"> </span><span class="s">&#39;</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">d</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">a\\211\\128b</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">f</span><span class="p">:</span><span class="n">close</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="csv-dump"></span><dl class="function">
<dt id="lua-функция.csv.dump">
<em class="property"> </em><code class="descclassname">csv.</code><code class="descname">dump</code><big>(</big><em>csv-table</em><span class="optional">[</span>, <em>options</em>, <em>writable</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.csv.dump" title="Ссылка на это определение">¶</a></dt>
<dd><p>Get table input from <code class="docutils literal"><span class="pre">csv-table</span></code> and return a CSV-formatted string as output.
Or, get table input from <code class="docutils literal"><span class="pre">csv-table</span></code> and put the output in <code class="docutils literal"><span class="pre">writable</span></code>.
Usually <code class="samp docutils literal"><em><span class="pre">options</span></em></code> is not specified.
Usually <code class="docutils literal"><span class="pre">writable</span></code>, if specified, is a file opened for writing.
<a class="reference internal" href="#csv-dump"><span class="std std-ref">csv.dump()</span></a> is the reverse of <a class="reference internal" href="#csv-load"><span class="std std-ref">csv.load()</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>csv-table</strong> (<em>table</em>) -- a table which can be formatted according to the CSV rules.</li>
<li><strong>options</strong> (<em>table</em>) -- optional. see <a class="reference internal" href="#csv-options"><span class="std std-ref">above</span></a></li>
<li><strong>writable</strong> (<em>object</em>) -- any object which has a write() method</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">dumped_value</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">string, which is written to <code class="docutils literal"><span class="pre">writable</span></code> if specified</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<p>CSV-table has 3 fields, field#2 has &quot;,&quot; so result has quote marks</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">csv</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">csv&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">csv</span><span class="p">.</span><span class="n">dump</span><span class="p">({</span><span class="s1">&#39;</span><span class="s">a&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">b,c &#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">d&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;a,&quot;b,c</span><span class="nv"> </span><span class="s">&quot;,d</span>

<span class="s">&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Round Trip: from string to table and back to string</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">csv_table</span> <span class="o">=</span> <span class="n">csv</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">a,b,c&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">csv</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">csv_table</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;a,b,c</span>

<span class="s">&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="csv-iterate"></span><dl class="function">
<dt id="lua-функция.csv.iterate">
<em class="property"> </em><code class="descclassname">csv.</code><code class="descname">iterate</code><big>(</big><em>input</em>, <em>{options}</em><big>)</big><a class="headerlink" href="#lua-функция.csv.iterate" title="Ссылка на это определение">¶</a></dt>
<dd><p>Form a Lua iterator function for going through CSV records
one field at a time.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>csv-table</strong> (<em>table</em>) -- a table which can be formatted according to the CSV rules.</li>
<li><strong>options</strong> (<em>table</em>) -- see <a class="reference internal" href="#csv-options"><span class="std std-ref">above</span></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">Lua iterator function</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">iterator function</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<p><a class="reference internal" href="#csv-iterate"><span class="std std-ref">csv.iterate()</span></a> is the low level of <a class="reference internal" href="#csv-load"><span class="std std-ref">csv.load()</span></a> and <a class="reference internal" href="#csv-dump"><span class="std std-ref">csv.dump()</span></a>.
To illustrate that, here is a function which is the same as the <a class="reference internal" href="#csv-load"><span class="std std-ref">csv.load()</span></a>
function, as seen in <a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.7/src/lua/csv.lua">the Tarantool source code</a>.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="nb">load</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">readable</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="n">opts</span> <span class="o">=</span> <span class="n">opts</span> <span class="ow">or</span> <span class="p">{}</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">         &gt; </span>  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tup</span> <span class="k">in</span> <span class="n">csv</span><span class="p">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">readable</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="k">do</span>
<span class="gp">         &gt; </span>    <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tup</span>
<span class="gp">         &gt; </span>  <span class="k">end</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="n">result</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="nb">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">a,b,c&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">a</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">b</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">c</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

</div>
<span id="document-reference_lua/digest"></span><div class="section" id="lua-module.digest">
<span id="module-digest"></span><span id="digest"></span><h3>Модуль <cite>digest</cite><a class="headerlink" href="#lua-module.digest" title="Ссылка на этот заголовок">¶</a></h3>
<p>A &quot;digest&quot; is a value which is returned by a function (usually a
<a class="reference external" href="https://en.wikipedia.org/wiki/Cryptographic_hash_function">Cryptographic hash function</a>), applied against a string. Tarantool's digest
module supports several types of cryptographic hash functions (<a class="reference external" href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Md4">MD4</a>,
<a class="reference external" href="https://en.wikipedia.org/wiki/Md5">MD5</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Sha-0">SHA-0</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Sha-1">SHA-1</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/Sha-2">SHA-2</a>) as well as a checksum function (<a class="reference external" href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check">CRC32</a>), two
functions for <a class="reference external" href="https://en.wikipedia.org/wiki/Base64">base64</a>, and two non-cryptographic hash functions (<a class="reference external" href="https://code.google.com/p/guava-libraries/wiki/HashingExplained">guava</a>, <a class="reference external" href="https://en.wikipedia.org/wiki/MurmurHash">murmur</a>).
Some of the digest functionality is also present in the <a class="reference internal" href="singlehtml.html#crypto"><span class="std std-ref">crypto</span></a>
module.</p>
<p>The functions in digest are:</p>
<dl class="function">
<dt id="lua-функция.digest.aes256cbc.encrypt">
<em class="property"> </em><code class="descclassname">digest.aes256cbc.</code><code class="descname">encrypt</code><big>(</big><em>string</em>, <em>key</em>, <em>iv</em><big>)</big><a class="headerlink" href="#lua-функция.digest.aes256cbc.encrypt" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.digest.aes256cbc.decrypt">
<em class="property"> </em><code class="descclassname">digest.aes256cbc.</code><code class="descname">decrypt</code><big>(</big><em>string</em>, <em>key</em>, <em>iv</em><big>)</big><a class="headerlink" href="#lua-функция.digest.aes256cbc.decrypt" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 256-bit binary string = digest made with AES.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.md4">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">md4</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.md4" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 128-bit binary string = digest made with MD4.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.md4_hex">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">md4_hex</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.md4_hex" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 32-byte string = hexadecimal of a digest calculated with md4.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.md5">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">md5</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.md5" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 128-bit binary string = digest made with MD5.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.md5_hex">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">md5_hex</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.md5_hex" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 32-byte string = hexadecimal of a digest calculated with md5.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.sha">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">sha</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.sha" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 160-bit binary string = digest made with SHA-0.|br|
Not recommended.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.sha_hex">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">sha_hex</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.sha_hex" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 40-byte string = hexadecimal of a digest calculated with sha.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.sha1">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">sha1</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.sha1" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 160-bit binary string = digest made with SHA-1.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.sha1_hex">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">sha1_hex</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.sha1_hex" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 40-byte string = hexadecimal of a digest calculated with sha1.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.sha224">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">sha224</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.sha224" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 224-bit binary string = digest made with SHA-2.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.sha224_hex">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">sha224_hex</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.sha224_hex" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 56-byte string = hexadecimal of a digest calculated with sha224.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.sha256">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">sha256</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.sha256" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 256-bit binary string =  digest made with SHA-2.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.sha256_hex">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">sha256_hex</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.sha256_hex" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 64-byte string = hexadecimal of a digest calculated with sha256.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.sha384">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">sha384</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.sha384" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 384-bit binary string =  digest made with SHA-2.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.sha384_hex">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">sha384_hex</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.sha384_hex" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 96-byte string = hexadecimal of a digest calculated with sha384.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.sha512">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">sha512</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.sha512" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 512-bit binary tring = digest made with SHA-2.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.sha512_hex">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">sha512_hex</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.sha512_hex" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 128-byte string = hexadecimal of a digest calculated with sha512.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.base64_encode">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">base64_encode</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.base64_encode" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns base64 encoding from a regular string.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.base64_decode">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">base64_decode</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.base64_decode" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns a regular string from a base64 encoding.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.urandom">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">urandom</code><big>(</big><em>integer</em><big>)</big><a class="headerlink" href="#lua-функция.digest.urandom" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns array of random bytes with length = integer.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.crc32">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">crc32</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.crc32" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 32-bit checksum made with CRC32.</p>
<p>The crc32 and crc32_update functions use the <a class="reference external" href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check#Standards_and_common_use">CRC-32C (Castagnoli)</a>
polynomial value: <code class="docutils literal"><span class="pre">0x1EDC6F41</span></code> / <code class="docutils literal"><span class="pre">4812730177</span></code>. If it is necessary to be
compatible with other checksum functions in other programming languages,
ensure that the other functions use the same polynomial value.</p>
<p>For example, in Python, install the <code class="docutils literal"><span class="pre">crcmod</span></code> package and say:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">crcmod</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fun</span> <span class="o">=</span> <span class="n">crcmod</span><span class="o">.</span><span class="n">mkCrcFun</span><span class="p">(</span><span class="s1">&#39;4812730177&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fun</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
<span class="go">3304160206L</span>
</pre></div>
</div>
<p>In Perl, install the <code class="docutils literal"><span class="pre">Digest::CRC</span></code> module and run the following code:</p>
<div class="highlight-perl"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nn">Digest::</span><span class="n">CRC</span><span class="p">;</span>
<span class="nv">$d</span> <span class="o">=</span> <span class="nn">Digest::</span><span class="n">CRC</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="n">width</span> <span class="o">=&gt;</span> <span class="mi">32</span><span class="p">,</span> <span class="n">poly</span> <span class="o">=&gt;</span> <span class="mh">0x1EDC6F41</span><span class="p">,</span> <span class="n">init</span> <span class="o">=&gt;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="n">refin</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">refout</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="nv">$d</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;string&#39;</span><span class="p">);</span>
<span class="k">print</span> <span class="nv">$d</span><span class="o">-&gt;</span><span class="n">digest</span><span class="p">;</span>
</pre></div>
</div>
<p>(the expected output is 3304160206).</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.crc32.new">
<em class="property"> </em><code class="descclassname">digest.crc32.</code><code class="descname">new</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.digest.crc32.new" title="Ссылка на это определение">¶</a></dt>
<dd><p>Initiates incremental crc32.
See <a class="reference internal" href="#digest-incremental-digests"><span class="std std-ref">incremental methods</span></a> notes.</p>
</dd></dl>

<span class="target" id="digest-guava"></span><dl class="function">
<dt id="lua-функция.digest.guava">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">guava</code><big>(</big><em>state</em>, <em>bucket</em><big>)</big><a class="headerlink" href="#lua-функция.digest.guava" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns a number made with consistent hash.</p>
<p>The guava function uses the <a class="reference external" href="https://en.wikipedia.org/wiki/Consistent_hashing">Consistent Hashing</a> algorithm of the Google
guava library. The first parameter should be a hash code; the second
parameter should be the number of buckets; the returned value will be an
integer between 0 and the number of buckets. For example,</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">digest</span><span class="p">.</span><span class="n">guava</span><span class="p">(</span><span class="mi">10863919174838991</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">8</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.murmur">
<em class="property"> </em><code class="descclassname">digest.</code><code class="descname">murmur</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.digest.murmur" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns 32-bit binary string = digest made with MurmurHash.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.digest.murmur.new">
<em class="property"> </em><code class="descclassname">digest.murmur.</code><code class="descname">new</code><big>(</big><span class="optional">[</span><em>seed</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.digest.murmur.new" title="Ссылка на это определение">¶</a></dt>
<dd><p>Initiates incremental MurmurHash.
See <a class="reference internal" href="#digest-incremental-digests"><span class="std std-ref">incremental methods</span></a> notes.</p>
</dd></dl>

<div class="section" id="incremental-methods-in-the-digest-module">
<span id="digest-incremental-digests"></span><h4>Incremental methods in the digest module<a class="headerlink" href="#incremental-methods-in-the-digest-module" title="Ссылка на этот заголовок">¶</a></h4>
<p>Suppose that a digest is done for a string 'A', then a new part 'B' is appended
to the string, then a new digest is required. The new digest could be recomputed
for the whole string 'AB', but it is faster to take what was computed before for
'A' and apply changes based on the new part 'B'. This is called multi-step or
&quot;incremental&quot; digesting, which Tarantool supports with crc32 and with murmur...</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">digest</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">digest&#39;</span><span class="p">)</span>

<span class="c1">-- print crc32 of &#39;AB&#39;, with one step, then incrementally</span>
<span class="nb">print</span><span class="p">(</span><span class="n">digest</span><span class="p">.</span><span class="n">crc32</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">AB&#39;</span><span class="p">))</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">digest</span><span class="p">.</span><span class="n">crc32</span><span class="p">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">c</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">A&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="n">result</span><span class="p">())</span>

<span class="c1">-- print murmur hash of &#39;AB&#39;, with one step, then incrementally</span>
<span class="nb">print</span><span class="p">(</span><span class="n">digest</span><span class="p">.</span><span class="n">murmur</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">AB&#39;</span><span class="p">))</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">digest</span><span class="p">.</span><span class="n">murmur</span><span class="p">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">m</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">A&#39;</span><span class="p">)</span>
<span class="n">m</span><span class="p">:</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">:</span><span class="n">result</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Ссылка на этот заголовок">¶</a></h4>
<p>In the following example, the user creates two functions, <code class="docutils literal"><span class="pre">password_insert()</span></code>
which inserts a <a class="reference external" href="https://en.wikipedia.org/wiki/Sha-1">SHA-1</a> digest of the word &quot;<strong>^S^e^c^ret Wordpass</strong>&quot; into a tuple
set, and <code class="docutils literal"><span class="pre">password_check()</span></code> which requires input of a password.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">digest</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">digest&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">password_insert</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1234</span><span class="p">,</span> <span class="n">digest</span><span class="p">.</span><span class="n">sha1</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">^S^e^c^ret Wordpass&#39;</span><span class="p">)}</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="s1">&#39;</span><span class="s">OK&#39;</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">password_check</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">t</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">12345</span><span class="p">}</span>
<span class="gp">         &gt; </span>  <span class="k">if</span> <span class="n">digest</span><span class="p">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="o">==</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">then</span>
<span class="gp">         &gt; </span>    <span class="k">return</span> <span class="s1">&#39;</span><span class="s">Password is valid&#39;</span>
<span class="gp">         &gt; </span>  <span class="k">else</span>
<span class="gp">         &gt; </span>    <span class="k">return</span> <span class="s1">&#39;</span><span class="s">Password is not valid&#39;</span>
<span class="gp">         &gt; </span>  <span class="k">end</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">password_insert</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;OK&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>If a later user calls the <code class="docutils literal"><span class="pre">password_check()</span></code> function and enters
the wrong password, the result is an error.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">password_insert</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">Secret Password&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;Password</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">valid&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
</div>
<span id="document-reference_lua/box_error"></span><div class="section" id="lua-module.box.error">
<span id="submodule-box-error"></span><h3>Вложенный модуль <cite>box.error</cite><a class="headerlink" href="#lua-module.box.error" title="Ссылка на этот заголовок">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">box.error</span></code> function is for raising an error. The difference between this
function and Lua's built-in <code class="docutils literal"><span class="pre">error()</span></code> function is that when the error reaches
the client, its error code is preserved. In contrast, a Lua error would always
be presented to the client as <code class="xref std std-errcode docutils literal"><span class="pre">ER_PROC_LUA</span></code>.</p>
<dl class="function">
<dt id="lua-функция.box.error">
<em class="property"> </em><code class="descclassname">box.</code><code class="descname">error</code><big>(</big><em>reason=string</em><span class="optional">[</span>, <em>code=number</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.error" title="Ссылка на это определение">¶</a></dt>
<dd><p>When called with a Lua-table argument, the code and reason have any
user-desired values. The result will be those values.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>code</strong> (<em>integer</em>) -- </li>
<li><strong>reason</strong> (<em>string</em>) -- </li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt>
<em class="property"> </em><code class="descclassname">box.</code><code class="descname">error</code><big>(</big><big>)</big></dt>
<dd><p>When called without arguments, <code class="docutils literal"><span class="pre">box.error()</span></code> re-throws whatever the last
error was.</p>
</dd></dl>

<dl class="function">
<dt>
<em class="property"> </em><code class="descclassname">box.</code><code class="descname">error</code><big>(</big><em>code</em>, <em>errtext</em><span class="optional">[</span>, <em>errtext ...</em><span class="optional">]</span><big>)</big></dt>
<dd><p>Emulate a request error, with text based on one of the pre-defined Tarantool
errors defined in the file <a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.7/src/box/errcode.h">errcode.h</a> in
the source tree. Lua constants which correspond to those Tarantool errors are
defined as members of <code class="docutils literal"><span class="pre">box.error</span></code>, for example <code class="docutils literal"><span class="pre">box.error.NO_SUCH_USER</span> <span class="pre">==</span> <span class="pre">45</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>code</strong> (<em>number</em>) -- number of a pre-defined error</li>
<li><strong>errtext(s)</strong> (<em>string</em>) -- part of the message which will accompany the error</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>For example:</p>
<p>the <code class="docutils literal"><span class="pre">NO_SUCH_USER</span></code> message is &quot;<code class="docutils literal"><span class="pre">User</span> <span class="pre">'%s'</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">found</span></code>&quot; -- it includes
one &quot;<code class="docutils literal"><span class="pre">%s</span></code>&quot; component which will be replaced with errtext. Thus a call to
<code class="docutils literal"><span class="pre">box.error(box.error.NO_SUCH_USER,</span> <span class="pre">'joe')</span></code> or <code class="docutils literal"><span class="pre">box.error(45,</span> <span class="pre">'joe')</span></code>
will result in an error with the accompanying message
&quot;<code class="docutils literal"><span class="pre">User</span> <span class="pre">'joe'</span> <span class="pre">is</span> <span class="pre">not</span> <span class="pre">found</span></code>&quot;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Except:</th><td class="field-body">whatever is specified in errcode-number.</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">error</span><span class="p">{</span><span class="n">code</span> <span class="o">=</span> <span class="mi">555</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">Arbitrary message&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Arbitrary message</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">error</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Arbitrary message</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="n">box</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">FUNCTION_ACCESS_DENIED</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">A&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">C&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">A access denied for user &#39;B&#39; to function &#39;C&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.error.last">
<em class="property"> </em><code class="descclassname">box.error.</code><code class="descname">last</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.box.error.last" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns a description of the last error, as a Lua table
with five members: &quot;line&quot; (number) Tarantool source file line number,
&quot;code&quot; (number) error's number,
&quot;type&quot;, (string) error's C++ class,
&quot;message&quot; (string) error's message,
&quot;file&quot; (string) Tarantool source file.
Additionally, if the error is a system error (for example due to a
failure in socket or file io), there may be a sixth member:
&quot;errno&quot; (number) C standard error number.</p>
<p>rtype: table</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.box.error.clear">
<em class="property"> </em><code class="descclassname">box.error.</code><code class="descname">clear</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.box.error.clear" title="Ссылка на это определение">¶</a></dt>
<dd><p>Clears the record of errors, so functions like <cite>box.error()</cite>
or <cite>box.error.last()</cite> will have no effect.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">error</span><span class="p">{</span><span class="n">code</span> <span class="o">=</span> <span class="mi">555</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">Arbitrary message&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Arbitrary message</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">#&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Invalid identifier &#39;#&#39; (expected letters, digits or an underscore)</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">last</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">line</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">278</span>
  <span class="l l-Scalar l-Scalar-Plain">code</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">70</span>
  <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ClientError</span>
  <span class="l l-Scalar l-Scalar-Plain">message</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Invalid identifier &#39;#&#39; (expected letters, digits or an underscore)</span>
  <span class="l l-Scalar l-Scalar-Plain">file</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/buildd/tarantool-1.7.0.252.g1654e31~precise/src/box/key_def.cc</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">last</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

</div>
<span id="document-reference_lua/fiber"></span><div class="section" id="module-fiber">
<h3>Модуль <cite>fiber</cite><a class="headerlink" href="#module-fiber" title="Ссылка на этот заголовок">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">fiber</span></code> module allows for creating, running and managing <em>fibers</em>.</p>
<p>A fiber is a set of instructions which are executed with cooperative
multitasking. Fibers managed by the fiber module are associated with
a user-supplied function called the <em>fiber function</em>.
A fiber has three possible states: <strong>running</strong>, <strong>suspended</strong> or <strong>dead</strong>.
When a fiber is created with <a class="reference internal" href="#fiber-create"><span class="std std-ref">fiber.create()</span></a>, it is running.
When a fiber yields control with <a class="reference internal" href="#fiber-sleep"><span class="std std-ref">fiber.sleep()</span></a>, it is suspended.
When a fiber ends (because the fiber function ends), it is dead.</p>
<p>All fibers are part of the fiber registry. This registry can be searched
with <a class="reference internal" href="#fiber-find"><span class="std std-ref">fiber.find()</span></a> - via fiber id (fid), which is a numeric
identifier.</p>
<p>A runaway fiber can be stopped with <a class="reference internal" href="#fiber-object-cancel"><span class="std std-ref">fiber_object.cancel</span></a>.
However, <a class="reference internal" href="#fiber-object-cancel"><span class="std std-ref">fiber_object.cancel</span></a> is advisory — it works
only if the runaway fiber calls <a class="reference internal" href="#fiber-testcancel"><span class="std std-ref">fiber.testcancel()</span></a>
occasionally. Most <code class="docutils literal"><span class="pre">box.*</span></code> functions, such as
<a class="reference internal" href="singlehtml.html#box-space-delete"><span class="std std-ref">box.space...delete()</span></a> or
<a class="reference internal" href="singlehtml.html#box-space-update"><span class="std std-ref">box.space...update()</span></a>, do call
<a class="reference internal" href="#fiber-testcancel"><span class="std std-ref">fiber.testcancel()</span></a> but
<a class="reference internal" href="singlehtml.html#box-space-select"><span class="std std-ref">box.space...select{}</span></a> does not. In practice, a runaway
fiber can only become unresponsive if it does many computations and does not
check whether it has been cancelled.</p>
<p>The other potential problem comes from fibers which never get scheduled, because
they are not subscribed to any events, or because no relevant events occur. Such
morphing fibers can be killed with <a class="reference internal" href="#fiber-kill"><span class="std std-ref">fiber.kill()</span></a> at any time,
since <a class="reference internal" href="#fiber-kill"><span class="std std-ref">fiber.kill()</span></a> sends an asynchronous wakeup event to the
fiber, and <a class="reference internal" href="#fiber-testcancel"><span class="std std-ref">fiber.testcancel()</span></a> is checked whenever such
a wakeup event occurs.</p>
<p>Like all Lua objects, dead fibers are garbage collected. The garbage collector
frees pool allocator memory owned by the fiber, resets all fiber data, and
returns the fiber (now called a fiber carcass) to the fiber pool. The carcass
can be reused when another fiber is created.</p>
<p>A fiber has all the features of a Lua <a class="reference external" href="http://www.lua.org/pil/contents.html#9">coroutine</a> and all the programming
concepts that apply for Lua coroutines will apply for fibers as well. However,
Tarantool has made some enhancements for fibers and has used fibers internally.
So, although use of coroutines is possible and supported, use of fibers is
recommended.</p>
<span class="target" id="lua-module.fiber"></span><span class="target" id="fiber-create"></span><dl class="function">
<dt id="lua-функция.fiber.create">
<em class="property"> </em><code class="descclassname">fiber.</code><code class="descname">create</code><big>(</big><em>function</em><span class="optional">[</span>, <em>function-arguments</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.fiber.create" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create and start a fiber. The fiber is created and begins to run immediately.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>function</strong> -- the function to be associated with the fiber</li>
<li><strong>function-arguments</strong> -- what will be passed to function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">created fiber object</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">userdata</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fiber&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">function_name</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">fiber</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">fiber_object</span> <span class="o">=</span> <span class="n">fiber</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="fiber-self"></span><dl class="function">
<dt id="lua-функция.fiber.self">
<em class="property"> </em><code class="descclassname">fiber.</code><code class="descname">self</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.fiber.self" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">fiber object for the currently scheduled fiber.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">userdata</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span><span class="p">.</span><span class="n">self</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">status</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">running</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">interactive</span>
  <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">101</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="fiber-find"></span><dl class="function">
<dt id="lua-функция.fiber.find">
<em class="property"> </em><code class="descclassname">fiber.</code><code class="descname">find</code><big>(</big><em>id</em><big>)</big><a class="headerlink" href="#lua-функция.fiber.find" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>id</strong> -- numeric identifier of the fiber.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">fiber object for the specified fiber.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">userdata</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">status</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">running</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">interactive</span>
  <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">101</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="fiber-sleep"></span><dl class="function">
<dt id="lua-функция.fiber.sleep">
<em class="property"> </em><code class="descclassname">fiber.</code><code class="descname">sleep</code><big>(</big><em>time</em><big>)</big><a class="headerlink" href="#lua-функция.fiber.sleep" title="Ссылка на это определение">¶</a></dt>
<dd><p>Yield control to the transaction processor thread and sleep for the specified number
of seconds. Only the current fiber can be made to sleep.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>time</strong> -- number of seconds to sleep.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="fiber-yield"></span><dl class="function">
<dt id="lua-функция.fiber.yield">
<em class="property"> </em><code class="descclassname">fiber.</code><code class="descname">yield</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.fiber.yield" title="Ссылка на это определение">¶</a></dt>
<dd><p>Yield control to the scheduler. Equivalent to <a class="reference internal" href="#fiber-sleep"><span class="std std-ref">fiber.sleep(0)</span></a>.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span><span class="p">.</span><span class="n">yield</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="fiber-status"></span><dl class="function">
<dt id="lua-функция.fiber.status">
<em class="property"> </em><code class="descclassname">fiber.</code><code class="descname">status</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.fiber.status" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the status of the current fiber.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the status of <code class="docutils literal"><span class="pre">fiber</span></code>. One of: “dead”, “suspended”, or “running”.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">string</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span><span class="p">.</span><span class="n">status</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">running</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="fiber-info"></span><dl class="function">
<dt id="lua-функция.fiber.info">
<em class="property"> </em><code class="descclassname">fiber.</code><code class="descname">info</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.fiber.info" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return information about all fibers.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">number of context switches, backtrace, id, total memory, used
memory, name for each fiber.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">table</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span><span class="p">.</span><span class="n">info</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">101</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">csw</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">7</span>
    <span class="l l-Scalar l-Scalar-Plain">backtrace</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[]</span>
    <span class="l l-Scalar l-Scalar-Plain">fid</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">101</span>
    <span class="l l-Scalar l-Scalar-Plain">memory</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">total</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">65776</span>
      <span class="l l-Scalar l-Scalar-Plain">used</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">interactive</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="fiber-kill"></span><dl class="function">
<dt id="lua-функция.fiber.kill">
<em class="property"> </em><code class="descclassname">fiber.</code><code class="descname">kill</code><big>(</big><em>id</em><big>)</big><a class="headerlink" href="#lua-функция.fiber.kill" title="Ссылка на это определение">¶</a></dt>
<dd><p>Locate a fiber by its numeric id and cancel it. In other words,
<a class="reference internal" href="#fiber-kill"><span class="std std-ref">fiber.kill()</span></a> combines <a class="reference internal" href="#fiber-find"><span class="std std-ref">fiber.find()</span></a> and
<a class="reference internal" href="#fiber-object-cancel"><span class="std std-ref">fiber_object:cancel()</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>id</strong> -- the id of the fiber to be cancelled.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Exception:</th><td class="field-body"><p class="first last">the specified fiber does not exist or cancel is not permitted.</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span><span class="p">.</span><span class="n">kill</span><span class="p">(</span><span class="n">fiber</span><span class="p">.</span><span class="n">id</span><span class="p">())</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">fiber is cancelled</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="fiber-testcancel"></span><dl class="function">
<dt id="lua-функция.fiber.testcancel">
<em class="property"> </em><code class="descclassname">fiber.</code><code class="descname">testcancel</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.fiber.testcancel" title="Ссылка на это определение">¶</a></dt>
<dd><p>Check if the current fiber has been cancelled
and throw an exception if this is the case.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span><span class="p">.</span><span class="n">testcancel</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">fiber is cancelled</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="class">
<dt id="lua-объект.fiber.fiber_object">
<em class="property">объект </em><code class="descclassname">fiber.</code><code class="descname">fiber_object</code><a class="headerlink" href="#lua-объект.fiber.fiber_object" title="Ссылка на это определение">¶</a></dt>
<dd><span class="target" id="fiber-object-id"></span><dl class="method">
<dt id="lua-функция.fiber_object.id">
<em class="property"> </em><code class="descclassname">fiber_object:</code><code class="descname">id</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.fiber_object.id" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>self</strong> -- fiber object, for example the fiber object returned
by <a class="reference internal" href="#fiber-create"><span class="std std-ref">fiber.create</span></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">id of the fiber.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">number</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber_object</span> <span class="o">=</span> <span class="n">fiber</span><span class="p">.</span><span class="n">self</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">fiber_object</span><span class="p">:</span><span class="n">id</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">101</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="fiber-object-name-get"></span><dl class="method">
<dt id="lua-функция.fiber_object.name">
<em class="property"> </em><code class="descclassname">fiber_object:</code><code class="descname">name</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.fiber_object.name" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>self</strong> -- fiber object, for example the fiber object returned
by <a class="reference internal" href="#fiber-create"><span class="std std-ref">fiber.create</span></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">name of the fiber.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">string</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span><span class="p">.</span><span class="n">self</span><span class="p">():</span><span class="n">name</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">interactive</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="fiber-object-name-set"></span><dl class="method">
<dt>
<em class="property"> </em><code class="descclassname">fiber_object:</code><code class="descname">name</code><big>(</big><em>name</em><big>)</big></dt>
<dd><p>Change the fiber name. By default the Tarantool server's
interactive-mode fiber is named 'interactive' and new
fibers created due to <a class="reference internal" href="#fiber-create"><span class="std std-ref">fiber.create</span></a> are named 'lua'.
Giving fibers distinct names makes it easier to
distinguish them when using <a class="reference internal" href="#fiber-info"><span class="std std-ref">fiber.info</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>self</strong> -- fiber object, for example the fiber
object returned by <a class="reference internal" href="#fiber-create"><span class="std std-ref">fiber.create</span></a></li>
<li><strong>name</strong> (<em>string</em>) -- the new name of the fiber.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span><span class="p">.</span><span class="n">self</span><span class="p">():</span><span class="n">name</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">non-interactive&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="fiber-object-status"></span><dl class="method">
<dt id="lua-функция.fiber_object.status">
<em class="property"> </em><code class="descclassname">fiber_object:</code><code class="descname">status</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.fiber_object.status" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the status of the specified fiber.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>self</strong> -- fiber object, for example the fiber object returned by
<a class="reference internal" href="#fiber-create"><span class="std std-ref">fiber.create</span></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">the status of fiber. One of: “dead”, “suspended”, or “running”.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">string</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span><span class="p">.</span><span class="n">self</span><span class="p">():</span><span class="n">status</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">running</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="fiber-object-cancel"></span><dl class="method">
<dt id="lua-функция.fiber_object.cancel">
<em class="property"> </em><code class="descclassname">fiber_object:</code><code class="descname">cancel</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.fiber_object.cancel" title="Ссылка на это определение">¶</a></dt>
<dd><p>Cancel a fiber. Running and suspended fibers can be cancelled.
After a fiber has been cancelled, attempts to operate on it will
cause errors, for example <a class="reference internal" href="#fiber-object-id"><span class="std std-ref">fiber_object:id()</span></a>
will cause <code class="docutils literal"><span class="pre">error:</span> <span class="pre">the</span> <span class="pre">fiber</span> <span class="pre">is</span> <span class="pre">dead</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>self</strong> -- fiber object, for example the fiber
object returned by <a class="reference internal" href="#fiber-create"><span class="std std-ref">fiber.create</span></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil</p>
</td>
</tr>
</tbody>
</table>
<p>Possible errors: cancel is not permitted for the specified fiber object.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span><span class="p">.</span><span class="n">self</span><span class="p">():</span><span class="n">cancel</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">fiber is cancelled</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="fiber-object-storage"></span><dl class="data">
<dt id="lua-данные.fiber_object.storage">
<em class="property"> </em><code class="descclassname">fiber_object:</code><code class="descname">storage</code><a class="headerlink" href="#lua-данные.fiber_object.storage" title="Ссылка на это определение">¶</a></dt>
<dd><p>Local storage within the fiber. The storage can contain any number of
named values, subject to memory limitations. Naming may be done with
<code class="samp docutils literal"><em><span class="pre">fiber_object</span></em><span class="pre">.storage.</span><em><span class="pre">name</span></em></code> or <code class="samp docutils literal"><span class="pre">fiber_object}.storage['</span><em><span class="pre">name</span></em><span class="pre">'].</span></code>
or with a number <code class="samp docutils literal"><em><span class="pre">fiber_object</span></em><span class="pre">.storage[</span><em><span class="pre">number</span></em><span class="pre">]</span></code>.
Values may be either numbers or strings. The storage is garbage-collected
when <code class="samp docutils literal"><em><span class="pre">fiber_object</span></em><span class="pre">:cancel()</span></code> happens.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fiber&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">f</span> <span class="p">()</span> <span class="n">fiber</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> <span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">fiber_function</span> <span class="o">=</span> <span class="n">fiber</span><span class="p">:</span><span class="n">create</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="s">&#39;[string</span><span class="nv"> </span><span class="s">&quot;fiber_function</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">fiber:create(f)&quot;]:1:</span><span class="nv"> </span><span class="s">fiber.create(function,</span><span class="nv"> </span><span class="s">...):</span>
    <span class="s">bad</span><span class="nv"> </span><span class="s">arguments&#39;</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">fiber_function</span> <span class="o">=</span> <span class="n">fiber</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">fiber_function</span><span class="p">.</span><span class="n">storage</span><span class="p">.</span><span class="n">str1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">string&#39;</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">fiber_function</span><span class="p">.</span><span class="n">storage</span><span class="p">[</span><span class="s1">&#39;</span><span class="s">str1&#39;</span><span class="p">]</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">fiber_function</span><span class="p">:</span><span class="n">cancel</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">fiber_function</span><span class="p">.</span><span class="n">storage</span><span class="p">[</span><span class="s1">&#39;</span><span class="s">str1&#39;</span><span class="p">]</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="s">&#39;[string</span><span class="nv"> </span><span class="s">&quot;return</span><span class="nv"> </span><span class="s">fiber_function.storage[</span><span class="se">&#39;&#39;</span><span class="s">str1</span><span class="se">&#39;&#39;</span><span class="s">]&quot;]:1:</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">fiber</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">dead&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>See also <a class="reference internal" href="singlehtml.html#box-session-storage"><span class="std std-ref">box.session.storage</span></a>.</p>
</dd></dl>

</dd></dl>

<span class="target" id="fiber-time"></span><dl class="function">
<dt id="lua-функция.fiber.time">
<em class="property"> </em><code class="descclassname">fiber.</code><code class="descname">time</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.fiber.time" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">current system time (in seconds since the epoch) as a Lua
number. The time is taken from the event loop clock,
which makes this call very cheap, but still useful for
constructing artificial tuple keys.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">num</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<blockquote>
<div><div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span><span class="p">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">fiber</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1448466279.2415</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1448466279.2415</span>
<span class="nn">...</span>
</pre></div>
</div>
</div></blockquote>
</dd></dl>

<span class="target" id="fiber-time64"></span><dl class="function">
<dt id="lua-функция.fiber.time64">
<em class="property"> </em><code class="descclassname">fiber.</code><code class="descname">time64</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.fiber.time64" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">current system time (in microseconds since the epoch)
as a 64-bit integer. The time is taken from the event
loop clock.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">num</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span><span class="p">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">fiber</span><span class="p">.</span><span class="n">time64</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1448466351.2708</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1448466351270762</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<div class="section" id="example-of-fiber-use">
<h4>Example Of Fiber Use<a class="headerlink" href="#example-of-fiber-use" title="Ссылка на этот заголовок">¶</a></h4>
<p>Make the function which will be associated with the fiber. This function
contains an infinite loop (<code class="docutils literal"><span class="pre">while</span> <span class="pre">0</span> <span class="pre">==</span> <span class="pre">0</span></code> is always true). Each iteration
of the loop adds 1 to a global variable named gvar, then goes to sleep for
2 seconds. The sleep causes an implicit <a class="reference internal" href="#fiber-yield"><span class="std std-ref">fiber.yield()</span></a>.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fiber&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">function_x</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">gvar</span> <span class="o">=</span> <span class="mi">0</span>
<span class="gp">         &gt; </span>  <span class="k">while</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">do</span>
<span class="gp">         &gt; </span>    <span class="n">gvar</span> <span class="o">=</span> <span class="n">gvar</span> <span class="o">+</span> <span class="mi">1</span>
<span class="gp">         &gt; </span>    <span class="n">fiber</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="k">end</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Make a fiber, associate function_x with the fiber, and start function_x.
It will immediately &quot;detach&quot; so it will be running independently of the caller.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">gvar</span> <span class="o">=</span> <span class="mi">0</span>

<span class="gp">tarantool&gt; </span><span class="n">fiber_of_x</span> <span class="o">=</span> <span class="n">fiber</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">function_x</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Get the id of the fiber (fid), to be used in later displays.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fid</span> <span class="o">=</span> <span class="n">fiber_of_x</span><span class="p">:</span><span class="n">id</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Pause for a while, while the detached function runs. Then ... Display the fiber
id, the fiber status, and gvar (gvar will have gone up a bit depending how long
the pause lasted). The status is suspended because the fiber spends almost all
its time sleeping or yielding.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">#&#39;</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">. &#39;</span><span class="p">,</span> <span class="n">fiber_of_x</span><span class="p">:</span><span class="n">status</span><span class="p">(),</span> <span class="s1">&#39;</span><span class="s">. gvar=&#39;</span><span class="p">,</span> <span class="n">gvar</span><span class="p">)</span>
<span class="go"># 102 .  suspended . gvar= 399</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Pause for a while, while the detached function runs. Then ... Cancel the fiber.
Then, once again ... Display the fiber id, the fiber status, and gvar (gvar
will have gone up a bit more depending how long the pause lasted). This time
the status is dead because the cancel worked.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fiber_of_x</span><span class="p">:</span><span class="n">cancel</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">#&#39;</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">. &#39;</span><span class="p">,</span> <span class="n">fiber_of_x</span><span class="p">:</span><span class="n">status</span><span class="p">(),</span> <span class="s1">&#39;</span><span class="s">. gvar=&#39;</span><span class="p">,</span> <span class="n">gvar</span><span class="p">)</span>
<span class="go"># 102 .  dead . gvar= 421</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
</div>
<span id="document-reference_lua/fiber_ipc"></span><div class="section" id="submodule-fiber-ipc">
<h3>Модуль <cite>fiber-ipc</cite><a class="headerlink" href="#submodule-fiber-ipc" title="Ссылка на этот заголовок">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">fiber-ipc</span></code> submodule allows sending and receiving messages between
different processes. The words &quot;different processes&quot; in this context
mean different connections, different sessions, or different fibers.</p>
<p>Call <code class="docutils literal"><span class="pre">fiber.channel()</span></code> to allocate space and get a channel object,
which will be called channel for examples in this section. Call the
other <code class="docutils literal"><span class="pre">fiber-ipc</span></code> routines, via channel, to send messages, receive
messages, or check ipc status. Message exchange is synchronous. The
channel is garbage collected when no one is using it, as with any
other Lua object. Use object-oriented syntax, for example
<code class="docutils literal"><span class="pre">channel:put(message)</span></code> rather than <code class="docutils literal"><span class="pre">fiber.channel.put(message)</span></code>.</p>
<span class="target" id="lua-module.fiber"></span><span class="target" id="fiber-ipc-channel"></span><dl class="function">
<dt id="lua-функция.fiber.channel">
<em class="property"> </em><code class="descclassname">fiber.</code><code class="descname">channel</code><big>(</big><span class="optional">[</span><em>capacity</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.fiber.channel" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create a new communication channel.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>capacity</strong> (<em>int</em>) -- positive integer as great as the maximum number of
slots (spaces for <code class="docutils literal"><span class="pre">get</span></code> or <code class="docutils literal"><span class="pre">put</span></code> messages)
that might be pending at any given time.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">new channel.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">userdata</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="class">
<dt id="lua-объект.fiber.channel_object">
<em class="property">объект </em><code class="descclassname">fiber.</code><code class="descname">channel_object</code><a class="headerlink" href="#lua-объект.fiber.channel_object" title="Ссылка на это определение">¶</a></dt>
<dd><dl class="method">
<dt id="lua-функция.channel_object.put">
<em class="property"> </em><code class="descclassname">channel_object:</code><code class="descname">put</code><big>(</big><em>message</em><span class="optional">[</span>, <em>timeout</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.channel_object.put" title="Ссылка на это определение">¶</a></dt>
<dd><p>Send a message using a channel. If the channel is full,
<code class="docutils literal"><span class="pre">channel:put()</span></code> blocks until there is a free slot in the channel.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>message</strong> (<em>lua_object</em>) -- </li>
<li><strong>timeout</strong> -- </li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">If timeout is provided, and the channel doesn't become empty for
the duration of the timeout, <code class="docutils literal"><span class="pre">channel:put()</span></code> returns false.
Otherwise it returns true.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="lua-функция.channel_object.close">
<em class="property"> </em><code class="descclassname">channel_object:</code><code class="descname">close</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.channel_object.close" title="Ссылка на это определение">¶</a></dt>
<dd><p>Close the channel. All waiters in the channel will be woken up.
All following <code class="docutils literal"><span class="pre">channel:put()</span></code> or <code class="docutils literal"><span class="pre">channel:get()</span></code> operations will
return an error (<code class="docutils literal"><span class="pre">nil</span></code>).</p>
</dd></dl>

<dl class="method">
<dt id="lua-функция.channel_object.get">
<em class="property"> </em><code class="descclassname">channel_object:</code><code class="descname">get</code><big>(</big><span class="optional">[</span><em>timeout</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.channel_object.get" title="Ссылка на это определение">¶</a></dt>
<dd><p>Fetch a message from a channel. If the channel is empty,
<code class="docutils literal"><span class="pre">channel:get()</span></code> blocks until there is a message.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>timeout</strong> -- </li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">the value placed on the channel by an earlier
<code class="docutils literal"><span class="pre">channel:put()</span></code>.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">lua_object</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="lua-функция.channel_object.is_empty">
<em class="property"> </em><code class="descclassname">channel_object:</code><code class="descname">is_empty</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.channel_object.is_empty" title="Ссылка на это определение">¶</a></dt>
<dd><p>Check whether the specified channel is empty (has no messages).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">true if the specified channel is empty</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">boolean</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="lua-функция.channel_object.count">
<em class="property"> </em><code class="descclassname">channel_object:</code><code class="descname">count</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.channel_object.count" title="Ссылка на это определение">¶</a></dt>
<dd><p>Find out how many messages are on the channel. The answer is 0 if the channel is empty.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the number of messages.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">number</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="lua-функция.channel_object.is_full">
<em class="property"> </em><code class="descclassname">channel_object:</code><code class="descname">is_full</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.channel_object.is_full" title="Ссылка на это определение">¶</a></dt>
<dd><p>Check whether the specified channel is full.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">true if the specified channel is full (has no room for a new message).</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">boolean</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="lua-функция.channel_object.has_readers">
<em class="property"> </em><code class="descclassname">channel_object:</code><code class="descname">has_readers</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.channel_object.has_readers" title="Ссылка на это определение">¶</a></dt>
<dd><p>Check whether the specified channel is empty and has readers waiting for
a message (because they have issued <code class="docutils literal"><span class="pre">channel:get()</span></code> and then blocked).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">true if blocked users are waiting. Otherwise false.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">boolean</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="lua-функция.channel_object.has_writers">
<em class="property"> </em><code class="descclassname">channel_object:</code><code class="descname">has_writers</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.channel_object.has_writers" title="Ссылка на это определение">¶</a></dt>
<dd><p>Check whether the specified channel is full and has writers waiting
(because they have issued <code class="docutils literal"><span class="pre">channel:put()</span></code> and then blocked due to lack of room).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">true if blocked users are waiting. Otherwise false.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">boolean</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="lua-функция.channel_object.is_closed">
<em class="property"> </em><code class="descclassname">channel_object:</code><code class="descname">is_closed</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.channel_object.is_closed" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">true if the specified channel is already closed. Otherwise false.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">boolean</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Ссылка на этот заголовок">¶</a></h4>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">fiber</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fiber&#39;</span><span class="p">)</span>
<span class="n">channel</span> <span class="o">=</span> <span class="n">fiber</span><span class="p">.</span><span class="n">channel</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">function</span> <span class="nf">consumer_fiber</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
        <span class="kd">local</span> <span class="n">task</span> <span class="o">=</span> <span class="n">channel</span><span class="p">:</span><span class="n">get</span><span class="p">()</span>
        <span class="o">...</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">consumer2_fiber</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
        <span class="c1">-- 10 seconds</span>
        <span class="kd">local</span> <span class="n">task</span> <span class="o">=</span> <span class="n">channel</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="k">then</span>
            <span class="o">...</span>
        <span class="k">else</span>
            <span class="c1">-- timeout</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">producer_fiber</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="o">...</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="o">...</span><span class="p">}</span>
        <span class="o">...</span>
        <span class="k">if</span> <span class="n">channel</span><span class="p">:</span><span class="n">is_empty</span><span class="p">()</span> <span class="k">then</span>
            <span class="c1">-- channel is empty</span>
        <span class="k">end</span>

        <span class="k">if</span> <span class="n">channel</span><span class="p">:</span><span class="n">is_full</span><span class="p">()</span> <span class="k">then</span>
            <span class="c1">-- channel is full</span>
        <span class="k">end</span>

        <span class="o">...</span>
        <span class="k">if</span> <span class="n">channel</span><span class="p">:</span><span class="n">has_readers</span><span class="p">()</span> <span class="k">then</span>
            <span class="c1">-- there are some fibers</span>
            <span class="c1">-- that are waiting for data</span>
        <span class="k">end</span>
        <span class="o">...</span>

        <span class="k">if</span> <span class="n">channel</span><span class="p">:</span><span class="n">has_writers</span><span class="p">()</span> <span class="k">then</span>
            <span class="c1">-- there are some fibers</span>
            <span class="c1">-- that are waiting for readers</span>
        <span class="k">end</span>
        <span class="n">channel</span><span class="p">:</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">producer2_fiber</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="o">...</span><span class="nb">select</span><span class="p">{</span><span class="o">...</span><span class="p">}</span>
        <span class="c1">-- 10 seconds</span>
        <span class="k">if</span> <span class="n">channel</span><span class="p">:</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">then</span>
            <span class="o">...</span>
        <span class="k">else</span>
            <span class="c1">-- timeout</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<span id="document-reference_lua/fio"></span><div class="section" id="module-fio">
<span id="fio-module"></span><h3>Module <cite>fio</cite><a class="headerlink" href="#module-fio" title="Ссылка на этот заголовок">¶</a></h3>
<p id="fio-section">Tarantool supports file input/output with an API that is similar to POSIX
syscalls. All operations are performed asynchronously. Multiple fibers can
access the same file simultaneously.</p>
<span class="target" id="lua-module.fio"></span><div class="section" id="common-pathname-manipulations">
<h4>Common pathname manipulations<a class="headerlink" href="#common-pathname-manipulations" title="Ссылка на этот заголовок">¶</a></h4>
<dl class="function">
<dt id="lua-функция.fio.pathjoin">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">pathjoin</code><big>(</big><em>partial-string</em><span class="optional">[</span>, <em>partial-string ...</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.fio.pathjoin" title="Ссылка на это определение">¶</a></dt>
<dd><p>Concatenate partial string, separated by '/' to form a path name.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>partial-string</strong> (<em>string</em>) -- one or more strings to be concatenated.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">path name</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">string</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">pathjoin</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">/etc&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">default&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">myfile&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/etc/default/myfile</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.fio.basename">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">basename</code><big>(</big><em>path-name</em><span class="optional">[</span>, <em>suffix</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.fio.basename" title="Ссылка на это определение">¶</a></dt>
<dd><p>Given a full path name, remove all but the final part (the file name).
Also remove the suffix, if it is passed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>path-name</strong> (<em>string</em>) -- path name</li>
<li><strong>suffix</strong> (<em>string</em>) -- suffix</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">file name</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">string</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<blockquote>
<div><div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">/path/to/my.lua&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">.lua&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">my</span>
<span class="nn">...</span>
</pre></div>
</div>
</div></blockquote>
</dd></dl>

<dl class="function">
<dt id="lua-функция.fio.dirname">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">dirname</code><big>(</big><em>path-name</em><big>)</big><a class="headerlink" href="#lua-функция.fio.dirname" title="Ссылка на это определение">¶</a></dt>
<dd><p>Given a full path name, remove the final part (the file name).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>path-name</strong> (<em>string</em>) -- path name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">directory name, that is, path name except for file name.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">string</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<blockquote>
<div><div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">path/to/my.lua&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;path/to/&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
</div></blockquote>
</dd></dl>

</div>
<div class="section" id="common-file-manipulations">
<h4>Common file manipulations<a class="headerlink" href="#common-file-manipulations" title="Ссылка на этот заголовок">¶</a></h4>
<dl class="function">
<dt id="lua-функция.fio.umask">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">umask</code><big>(</big><em>mask-bits</em><big>)</big><a class="headerlink" href="#lua-функция.fio.umask" title="Ссылка на это определение">¶</a></dt>
<dd><p>Set the mask bits used when creating files or directories. For a detailed
description type &quot;man 2 umask&quot;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>mask-bits</strong> (<em>number</em>) -- mask bits.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">previous mask bits.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">number</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<blockquote>
<div><div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">umask</span><span class="p">(</span><span class="nb">tonumber</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">755&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">493</span>
<span class="nn">...</span>
</pre></div>
</div>
</div></blockquote>
</dd></dl>

<dl class="function">
<dt id="lua-функция.fio.lstat">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">lstat</code><big>(</big><em>path-name</em><big>)</big><a class="headerlink" href="#lua-функция.fio.lstat" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.fio.stat">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">stat</code><big>(</big><em>path-name</em><big>)</big><a class="headerlink" href="#lua-функция.fio.stat" title="Ссылка на это определение">¶</a></dt>
<dd><p>Returns information about a file object. For details type &quot;man 2 lstat&quot; or
&quot;man 2 stat&quot;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>path-name</strong> (<em>string</em>) -- path name of file.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">fields which describe the file's block size, creation time, size,
and other attributes.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">table</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<blockquote>
<div><div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">lstat</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">/etc&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">inode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1048577</span>
  <span class="l l-Scalar l-Scalar-Plain">rdev</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">12288</span>
  <span class="l l-Scalar l-Scalar-Plain">atime</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1421340698</span>
  <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">16877</span>
  <span class="l l-Scalar l-Scalar-Plain">mtime</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1424615337</span>
  <span class="l l-Scalar l-Scalar-Plain">nlink</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">160</span>
  <span class="l l-Scalar l-Scalar-Plain">uid</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">blksize</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">4096</span>
  <span class="l l-Scalar l-Scalar-Plain">gid</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">ctime</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1424615337</span>
  <span class="l l-Scalar l-Scalar-Plain">dev</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2049</span>
  <span class="l l-Scalar l-Scalar-Plain">blocks</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">24</span>
<span class="nn">...</span>
</pre></div>
</div>
</div></blockquote>
</dd></dl>

<dl class="function">
<dt id="lua-функция.fio.mkdir">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">mkdir</code><big>(</big><em>path-name</em><span class="optional">[</span>, <em>mode</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.fio.mkdir" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.fio.rmdir">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">rmdir</code><big>(</big><em>path-name</em><big>)</big><a class="headerlink" href="#lua-функция.fio.rmdir" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create or delete a directory. For details type
&quot;man 2 mkdir&quot; or &quot;man 2 rmdir&quot;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>path-name</strong> (<em>string</em>) -- path of directory.</li>
<li><strong>mode</strong> (<em>number</em>) -- Mode bits can be passed as a number or as string
constants, for example ''<cite>S_IWUSR</cite>&quot;. Mode bits can be
combined by enclosing them in braces.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">true if success, false if failure.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">/etc&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.fio.glob">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">glob</code><big>(</big><em>path-name</em><big>)</big><a class="headerlink" href="#lua-функция.fio.glob" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return a list of files that match an input string. The list is constructed
with a single flag that controls the behavior of the function: GLOB_NOESCAPE.
For details type &quot;man 3 glob&quot;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>path-name</strong> (<em>string</em>) -- path-name, which may contain wildcard characters.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">list of files whose names match the input string</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">table</p>
</td>
</tr>
</tbody>
</table>
<p>Possible errors: nil.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">/etc/x*&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/etc/xdg</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/etc/xml</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/etc/xul-ext</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.fio.tempdir">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">tempdir</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.fio.tempdir" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the name of a directory that can be used to store temporary files.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">tempdir</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/lG31e7</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.fio.cwd">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">cwd</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.fio.cwd" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the name of the current working directory.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">cwd</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/home/username/tarantool_sandbox</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.fio.link">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">link</code><big>(</big><em>src</em>, <em>dst</em><big>)</big><a class="headerlink" href="#lua-функция.fio.link" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.fio.symlink">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">symlink</code><big>(</big><em>src</em>, <em>dst</em><big>)</big><a class="headerlink" href="#lua-функция.fio.symlink" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.fio.readlink">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">readlink</code><big>(</big><em>src</em><big>)</big><a class="headerlink" href="#lua-функция.fio.readlink" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.fio.unlink">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">unlink</code><big>(</big><em>src</em><big>)</big><a class="headerlink" href="#lua-функция.fio.unlink" title="Ссылка на это определение">¶</a></dt>
<dd><p>Functions to create and delete links. For details type &quot;man readlink&quot;,
&quot;man 2 link&quot;, &quot;man 2 symlink&quot;, &quot;man 2 unlink&quot;..</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>src</strong> (<em>string</em>) -- existing file name.</li>
<li><strong>dst</strong> (<em>string</em>) -- linked name.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last"><code class="docutils literal"><span class="pre">fio.link</span></code> and <code class="docutils literal"><span class="pre">fio.symlink</span></code> and <code class="docutils literal"><span class="pre">fio.unlink</span></code> return true if
success, false if failure. <code class="docutils literal"><span class="pre">fio.readlink</span></code> returns the link value
if success, nil if failure.</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">link</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">/home/username/tmp.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">/home/username/tmp.txt2&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">unlink</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">/home/username/tmp.txt2&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.fio.rename">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">rename</code><big>(</big><em>path-name</em>, <em>new-path-name</em><big>)</big><a class="headerlink" href="#lua-функция.fio.rename" title="Ссылка на это определение">¶</a></dt>
<dd><p>Rename a file or directory. For details type &quot;man 2 rename&quot;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>path-name</strong> (<em>string</em>) -- original name.</li>
<li><strong>new-path-name</strong> (<em>string</em>) -- new name.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">true if success, false if failure.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">/home/username/tmp.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">/home/username/tmp.txt2&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.fio.chown">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">chown</code><big>(</big><em>path-name</em>, <em>owner-user</em>, <em>owner-group</em><big>)</big><a class="headerlink" href="#lua-функция.fio.chown" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.fio.chmod">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">chmod</code><big>(</big><em>path-name</em>, <em>new-rights</em><big>)</big><a class="headerlink" href="#lua-функция.fio.chmod" title="Ссылка на это определение">¶</a></dt>
<dd><p>Manage the rights to file objects, or ownership of file objects.
For details type &quot;man 2 chown&quot; or &quot;man 2 chmod&quot;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>owner-user</strong> (<em>string</em>) -- new user uid.</li>
<li><strong>owner-group</strong> (<em>string</em>) -- new group uid.</li>
<li><strong>new-rights</strong> (<em>number</em>) -- new permissions</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">chmod</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">/home/username/tmp.txt&#39;</span><span class="p">,</span> <span class="nb">tonumber</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">0755&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">chown</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">/home/username/tmp.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">username&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">username&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.fio.truncate">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">truncate</code><big>(</big><em>path-name</em>, <em>new-size</em><big>)</big><a class="headerlink" href="#lua-функция.fio.truncate" title="Ссылка на это определение">¶</a></dt>
<dd><p>Reduce file size to a specified value. For details type &quot;man 2 truncate&quot;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>path-name</strong> (<em>string</em>) -- </li>
<li><strong>new-size</strong> (<em>number</em>) -- </li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">true if success, false if failure.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">truncate</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">/home/username/tmp.txt&#39;</span><span class="p">,</span> <span class="mi">99999</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.fio.sync">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">sync</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.fio.sync" title="Ссылка на это определение">¶</a></dt>
<dd><p>Ensure that changes are written to disk. For details type &quot;man 2 sync&quot;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">true if success, false if failure.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">boolean</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fio</span><span class="p">.</span><span class="n">sync</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.fio.open">
<em class="property"> </em><code class="descclassname">fio.</code><code class="descname">open</code><big>(</big><em>path-name</em><span class="optional">[</span>, <em>flags</em><span class="optional">[</span>, <em>mode</em><span class="optional">]</span><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.fio.open" title="Ссылка на это определение">¶</a></dt>
<dd><p>Open a file in preparation for reading or writing or seeking.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>path-name</strong> (<em>string</em>) -- </li>
<li><strong>flags</strong> (<em>number</em>) -- Flags can be passed as a number or as string
constants, for example '<code class="docutils literal"><span class="pre">O_RDONLY</span></code>',
'<code class="docutils literal"><span class="pre">O_WRONLY</span></code>', '<code class="docutils literal"><span class="pre">O_RDWR</span></code>'. Flags can be
combined by enclosing them in braces.</li>
<li><strong>mode</strong> (<em>number</em>) -- Mode bits can be passed as a number or as string
constants, for example ''<cite>S_IWUSR</cite>&quot;. Mode bits
are significant if flags include <cite>O_CREATE</cite> or
<cite>O_TMPFILE</cite>. Mode bits can be
combined by enclosing them in braces.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">file handle (later - fh)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">userdata</p>
</td>
</tr>
</tbody>
</table>
<p>Possible errors: nil.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fh</span> <span class="o">=</span> <span class="n">fio</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">/home/username/tmp.txt&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;</span><span class="s">O_RDWR&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">O_APPEND&#39;</span><span class="p">})</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">fh</span> <span class="c1">-- display file handle returned by fio.open</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">fh</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">11</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="class">
<dt id="lua-объект.fio.file-handle">
<em class="property">объект </em><code class="descclassname">fio.</code><code class="descname">file-handle</code><a class="headerlink" href="#lua-объект.fio.file-handle" title="Ссылка на это определение">¶</a></dt>
<dd><dl class="method">
<dt id="lua-функция.file-handle.close">
<em class="property"> </em><code class="descclassname">file-handle:</code><code class="descname">close</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.file-handle.close" title="Ссылка на это определение">¶</a></dt>
<dd><p>Close a file that was opened with <code class="docutils literal"><span class="pre">fio.open</span></code>. For details type &quot;man 2 close&quot;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>fh</strong> (<em>userdata</em>) -- file-handle as returned by <code class="docutils literal"><span class="pre">fio.open()</span></code>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">true if success, false on failure.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fh</span><span class="p">:</span><span class="n">close</span><span class="p">()</span> <span class="c1">-- where fh = file-handle</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.file-handle.pread">
<em class="property"> </em><code class="descclassname">file-handle:</code><code class="descname">pread</code><big>(</big><em>count</em>, <em>offset</em><big>)</big><a class="headerlink" href="#lua-функция.file-handle.pread" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.file-handle.pwrite">
<em class="property"> </em><code class="descclassname">file-handle:</code><code class="descname">pwrite</code><big>(</big><em>new-string</em>, <em>offset</em><big>)</big><a class="headerlink" href="#lua-функция.file-handle.pwrite" title="Ссылка на это определение">¶</a></dt>
<dd><p>Perform read/write random-access operation on a file, without affecting
the current seek position of the file.
For details type &quot;man 2 pread&quot; or &quot;man 2 pwrite&quot;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>fh</strong> (<em>userdata</em>) -- file-handle as returned by <code class="docutils literal"><span class="pre">fio.open()</span></code>.</li>
<li><strong>count</strong> (<em>number</em>) -- number of bytes to read</li>
<li><strong>new-string</strong> (<em>string</em>) -- value to write</li>
<li><strong>offset</strong> (<em>number</em>) -- offset within file where reading or writing begins</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last"><code class="docutils literal"><span class="pre">fh:pwrite</span></code> returns true if success, false if failure.
<code class="docutils literal"><span class="pre">fh:pread</span></code> returns the data that was read, or nil if failure.</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fh</span><span class="p">:</span><span class="n">pread</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
  <span class="no">elete from t8//</span>
  <span class="no">insert in</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.file-handle.read">
<em class="property"> </em><code class="descclassname">file-handle:</code><code class="descname">read</code><big>(</big><em>count</em><big>)</big><a class="headerlink" href="#lua-функция.file-handle.read" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.file-handle.write">
<em class="property"> </em><code class="descclassname">file-handle:</code><code class="descname">write</code><big>(</big><em>new-string</em><big>)</big><a class="headerlink" href="#lua-функция.file-handle.write" title="Ссылка на это определение">¶</a></dt>
<dd><p>Perform non-random-access read or write on a file. For details type
&quot;man 2 read&quot; or &quot;man 2 write&quot;.</p>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last"><code class="docutils literal"><span class="pre">fh:read</span></code> and <code class="docutils literal"><span class="pre">fh:write</span></code> affect the seek position within the
file, and this must be taken into account when working on the same
file from multiple fibers. It is possible to limit or prevent file
access from other fibers with <code class="docutils literal"><span class="pre">fiber.ipc</span></code>.</p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>fh</strong> (<em>userdata</em>) -- file-handle as returned by <code class="docutils literal"><span class="pre">fio.open()</span></code>.</li>
<li><strong>count</strong> (<em>number</em>) -- number of bytes to read</li>
<li><strong>new-string</strong> (<em>string</em>) -- value to write</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last"><code class="docutils literal"><span class="pre">fh:write</span></code> returns true if success, false if failure.
<code class="docutils literal"><span class="pre">fh:read</span></code> returns the data that was read, or nil if failure.</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fh</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">new data&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.file-handle.truncate">
<em class="property"> </em><code class="descclassname">file-handle:</code><code class="descname">truncate</code><big>(</big><em>new-size</em><big>)</big><a class="headerlink" href="#lua-функция.file-handle.truncate" title="Ссылка на это определение">¶</a></dt>
<dd><p>Change the size of an open file. Differs from <code class="docutils literal"><span class="pre">fio.truncate</span></code>, which
changes the size of a closed file.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>fh</strong> (<em>userdata</em>) -- file-handle as returned by <code class="docutils literal"><span class="pre">fio.open()</span></code>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">true if success, false if failure.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fh</span><span class="p">:</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.file-handle.seek">
<em class="property"> </em><code class="descclassname">file-handle:</code><code class="descname">seek</code><big>(</big><em>position</em><span class="optional">[</span>, <em>offset-from</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.file-handle.seek" title="Ссылка на это определение">¶</a></dt>
<dd><p>Shift position in the file to the specified position. For details type
&quot;man 2 seek&quot;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>fh</strong> (<em>userdata</em>) -- file-handle as returned by <code class="docutils literal"><span class="pre">fio.open()</span></code>.</li>
<li><strong>position</strong> (<em>number</em>) -- position to seek to</li>
<li><strong>offset-from</strong> (<em>string</em>) -- '<code class="docutils literal"><span class="pre">SEEK_END</span></code>' = end of file, '<code class="docutils literal"><span class="pre">SEEK_CUR</span></code>'
= current position, '<code class="docutils literal"><span class="pre">SEEK_SET</span></code>' = start of file.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">the new position if success</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">number</p>
</td>
</tr>
</tbody>
</table>
<p>Possible errors: nil.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fh</span><span class="p">:</span><span class="n">seek</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">SEEK_SET&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">20</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.file-handle.stat">
<em class="property"> </em><code class="descclassname">file-handle:</code><code class="descname">stat</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.file-handle.stat" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return statistics about an open file. This differs from <code class="docutils literal"><span class="pre">fio.stat</span></code>
which return statistics about a closed file. For details type &quot;man 2 stat&quot;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>fh</strong> (<em>userdata</em>) -- file-handle as returned by <code class="docutils literal"><span class="pre">fio.open()</span></code>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">details about the file.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">table</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fh</span><span class="p">:</span><span class="n">stat</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">inode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">729866</span>
  <span class="l l-Scalar l-Scalar-Plain">rdev</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="l l-Scalar l-Scalar-Plain">size</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
  <span class="l l-Scalar l-Scalar-Plain">atime</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">140942855</span>
  <span class="l l-Scalar l-Scalar-Plain">mode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">33261</span>
  <span class="l l-Scalar l-Scalar-Plain">mtime</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1409430660</span>
  <span class="l l-Scalar l-Scalar-Plain">nlink</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="l l-Scalar l-Scalar-Plain">uid</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1000</span>
  <span class="l l-Scalar l-Scalar-Plain">blksize</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">4096</span>
  <span class="l l-Scalar l-Scalar-Plain">gid</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1000</span>
  <span class="l l-Scalar l-Scalar-Plain">ctime</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1409430660</span>
  <span class="l l-Scalar l-Scalar-Plain">dev</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2049</span>
  <span class="l l-Scalar l-Scalar-Plain">blocks</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.file-handle.fsync">
<em class="property"> </em><code class="descclassname">file-handle:</code><code class="descname">fsync</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.file-handle.fsync" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.file-handle.fdatasync">
<em class="property"> </em><code class="descclassname">file-handle:</code><code class="descname">fdatasync</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.file-handle.fdatasync" title="Ссылка на это определение">¶</a></dt>
<dd><p>Ensure that file changes are written to disk, for an open file.
Compare <code class="docutils literal"><span class="pre">fio.sync</span></code>, which is for all files. For details type
&quot;man 2 fsync&quot; or &quot;man 2 fdatasync&quot;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>fh</strong> (<em>userdata</em>) -- file-handle as returned by <code class="docutils literal"><span class="pre">fio.open()</span></code>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">true if success, false if failure.</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fh</span><span class="p">:</span><span class="n">fsync</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
</div>
<span id="document-reference_lua/fun"></span><div class="section" id="module-fun">
<span id="fun-module"></span><h3>Module <cite>fun</cite><a class="headerlink" href="#module-fun" title="Ссылка на этот заголовок">¶</a></h3>
<p>Lua fun, also known as the Lua Functional Library, takes advantage
of the features of LuaJIT to help users create complex functions.
Inside the module are &quot;sequence processors&quot; such as
map, filter, reduce, zip -- they take a user-written function as
an argument and run it against every element in a sequence, which
can be faster or more convenient than a user-written loop.
Inside the module are &quot;generators&quot; such as range, tabulate, and
rands -- they return a bounded or boundless series of values.
Within the module are &quot;reducers&quot;, &quot;filters&quot;, &quot;composers&quot; ...
or, in short, all the important features found in languages like
Standard ML, Haskell, or Erlang.</p>
<p>The full documentation is <a class="reference external" href="http://rtsisyk.github.io/luafun">On the luafun section of github</a>.
However, the first chapter can be skipped because installation
is already done, it's inside Tarantool. All that is needed is the usual <code class="code docutils literal"><span class="pre">require</span></code> request.
After that, all the operations described in the
Lua fun manual will work, provided they are preceded by the
name returned by the <code class="code docutils literal"><span class="pre">require</span></code> request.
For example:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">fun</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fun&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="k">for</span> <span class="n">_k</span><span class="p">,</span> <span class="n">a</span> <span class="k">in</span> <span class="n">fun</span><span class="p">.</span><span class="n">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">do</span>
<span class="gp">         &gt; </span>  <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="go">1</span>
<span class="go">2</span>
<span class="go">3</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<span id="document-reference_lua/jit"></span><div class="section" id="lua-module.jit">
<span id="module-jit"></span><h3>Module <cite>jit</cite><a class="headerlink" href="#lua-module.jit" title="Ссылка на этот заголовок">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">jit</span></code> module has functions for tracing the LuaJIT Just-In-Time compiler's
progress, showing the byte-code or assembler output that the compiler produces,
and in general providing information about what LuaJIT does with Lua code.</p>
<dl class="function">
<dt id="lua-функция.jit.bc.dump">
<em class="property"> </em><code class="descclassname">jit.bc.</code><code class="descname">dump</code><big>(</big><em>function</em><big>)</big><a class="headerlink" href="#lua-функция.jit.bc.dump" title="Ссылка на это определение">¶</a></dt>
<dd><p>Prints the byte code of a function.</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">f</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">D&quot;</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">jit</span><span class="p">.</span><span class="n">bc</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
<p>For a list of available options, read <a class="reference external" href="https://github.com/tarantool/luajit/tree/master/src/jit/bc.lua">the source code of bc.lua</a>.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.jit.dis_x86.disass">
<em class="property"> </em><code class="descclassname">jit.dis_x86.</code><code class="descname">disass</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.jit.dis_x86.disass" title="Ссылка на это определение">¶</a></dt>
<dd><p>Prints the i386 assembler code of a string of bytes</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- Disassemble hexadecimal 97 which is the x86 code for xchg eax, edi</span>
<span class="n">jit</span><span class="p">.</span><span class="n">dis_x86</span><span class="p">.</span><span class="n">disass</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">\x97&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>For a list of available options, read <a class="reference external" href="https://github.com/tarantool/luajit/tree/master/src/jit/dis_x86.lua">the source code of dis_x86.lua</a>.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.jit.dis_x64.disass">
<em class="property"> </em><code class="descclassname">jit.dis_x64.</code><code class="descname">disass</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.jit.dis_x64.disass" title="Ссылка на это определение">¶</a></dt>
<dd><p>Prints the x86-64 assembler code of a string of bytes</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- Disassemble hexadecimal 97 which is the x86-64 code for xchg eax, edi</span>
<span class="n">jit</span><span class="p">.</span><span class="n">dis_x64</span><span class="p">.</span><span class="n">disass</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">\x97&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>For a list of available options, read <a class="reference external" href="https://github.com/tarantool/luajit/tree/master/src/jit/dis_x64.lua">the source code of dis_x64.lua</a>.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.jit.dump.on">
<em class="property"> </em><code class="descclassname">jit.dump.</code><code class="descname">on</code><big>(</big><em>option</em><span class="optional">[</span>, <em>output file</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.jit.dump.on" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.jit.dump.off">
<em class="property"> </em><code class="descclassname">jit.dump.</code><code class="descname">off</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.jit.dump.off" title="Ссылка на это определение">¶</a></dt>
<dd><p>Prints the intermediate or machine code of following Lua code</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- Show the machine code of a Lua &quot;for&quot; loop</span>
<span class="n">jit</span><span class="p">.</span><span class="n">dump</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">m&#39;</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1e6</span> <span class="k">do</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">i</span>
<span class="k">end</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">jit</span><span class="p">.</span><span class="n">dump</span><span class="p">.</span><span class="n">off</span><span class="p">()</span>
</pre></div>
</div>
<p>For a list of available options, read <a class="reference external" href="https://github.com/tarantool/luajit/tree/master/src/jit/dump.lua">the source code of dump.lua</a>.</p>
</dd></dl>

<dl class="function">
<dt id="lua-функция.jit.v.on">
<em class="property"> </em><code class="descclassname">jit.v.</code><code class="descname">on</code><big>(</big><em>option</em><span class="optional">[</span>, <em>output file</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.jit.v.on" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.jit.v.off">
<em class="property"> </em><code class="descclassname">jit.v.</code><code class="descname">off</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.jit.v.off" title="Ссылка на это определение">¶</a></dt>
<dd><p>Prints a trace of LuaJIT's progress compiling and interpreting code</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- Show what LuaJIT is doing for a Lua &quot;for&quot; loop</span>
<span class="n">jit</span><span class="p">.</span><span class="n">v</span><span class="p">.</span><span class="n">on</span><span class="p">()</span>
<span class="kd">local</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1e6</span> <span class="k">do</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">i</span>
<span class="k">end</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">jit</span><span class="p">.</span><span class="n">v</span><span class="p">.</span><span class="n">off</span><span class="p">()</span>
</pre></div>
</div>
<p>For a list of available options, read <a class="reference external" href="https://github.com/tarantool/luajit/tree/master/src/jit/v.lua">the source code of v.lua</a>.</p>
</dd></dl>

</div>
<span id="document-reference_lua/json"></span><div class="section" id="module-json">
<span id="json-module"></span><h3>Module <cite>json</cite><a class="headerlink" href="#module-json" title="Ссылка на этот заголовок">¶</a></h3>
<p>The json module provides JSON manipulation routines. It is based on the
<a class="reference external" href="http://www.kyne.com.au/~mark/software/lua-cjson.php">Lua-CJSON module by Mark Pulford</a>. For a complete manual on Lua-CJSON please read
<a class="reference external" href="http://www.kyne.com.au/~mark/software/lua-cjson-manual.html">the official documentation</a>.</p>
<span class="target" id="lua-module.json"></span><span class="target" id="json-encode"></span><dl class="function">
<dt id="lua-функция.json.encode">
<em class="property"> </em><code class="descclassname">json.</code><code class="descname">encode</code><big>(</big><em>lua-value</em><big>)</big><a class="headerlink" href="#lua-функция.json.encode" title="Ссылка на это определение">¶</a></dt>
<dd><p>Convert a Lua object to a JSON string.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>lua_value</strong> -- either a scalar value or a Lua table value.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">the original value reformatted as a JSON string.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">string</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">json</span><span class="o">=</span><span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">json&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;123&#39;</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span><span class="mi">123</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;[123]&#39;</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span><span class="mi">123</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">345</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;[123,234,345]&#39;</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span><span class="n">abc</span> <span class="o">=</span> <span class="mi">234</span><span class="p">,</span> <span class="n">cde</span> <span class="o">=</span> <span class="mi">345</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;{&quot;cde&quot;:345,&quot;abc&quot;:234}&#39;</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span><span class="n">hello</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;</span><span class="s">world&#39;</span><span class="p">}})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;{&quot;hello&quot;:[&quot;world&quot;]}&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="json-decode"></span><dl class="function">
<dt id="lua-функция.json.decode">
<em class="property"> </em><code class="descclassname">json.</code><code class="descname">decode</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.json.decode" title="Ссылка на это определение">¶</a></dt>
<dd><p>Convert a JSON string to a Lua object.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>string</strong> (<em>string</em>) -- a string formatted as JSON.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">the original contents formatted as a Lua table.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">table</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">json</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">json&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">json</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">123&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">123</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">json</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">[123, &quot;hello&quot;]&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">123</span><span class="p p-Indicator">,</span> <span class="s">&#39;hello&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">json</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">{&quot;hello&quot;: &quot;world&quot;}&#39;</span><span class="p">).</span><span class="n">hello</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">world</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="json-null"></span><dl class="data">
<dt id="lua-данные.json.NULL">
<em class="property"> </em><code class="descclassname">json.</code><code class="descname">NULL</code><a class="headerlink" href="#lua-данные.json.NULL" title="Ссылка на это определение">¶</a></dt>
<dd><p>A value comparable to Lua &quot;nil&quot; which may be useful as a placeholder in a tuple.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="go">-- When nil is assigned to a Lua-table field, the field is null</span>
<span class="gp">tarantool&gt; </span><span class="p">{</span><span class="kc">nil</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">a&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">b&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">a</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">b</span>
<span class="nn">...</span>
<span class="go">-- When json.NULL is assigned to a Lua-table field, the field is json.NULL</span>
<span class="gp">tarantool&gt; </span><span class="p">{</span><span class="n">json</span><span class="p">.</span><span class="n">NULL</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">a&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">b&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">a</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">b</span>
<span class="nn">...</span>
<span class="go">-- When json.NULL is assigned to a JSON field, the field is null</span>
<span class="gp">tarantool&gt; </span><span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span><span class="n">field2</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">NULL</span><span class="p">,</span> <span class="n">field1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">a&#39;</span><span class="p">,</span> <span class="n">field3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">c&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;{&quot;field2&quot;:null,&quot;field1&quot;:&quot;a&quot;,&quot;field3&quot;:&quot;c&quot;}&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<p>The JSON output structure can be specified with <code class="docutils literal"><span class="pre">__serialize</span></code>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">__serialize=&quot;seq&quot;</span></code> for an array</li>
<li><code class="docutils literal"><span class="pre">__serialize=&quot;map&quot;</span></code> for a map</li>
</ul>
<p>Serializing 'A' and 'B' with different <code class="docutils literal"><span class="pre">__serialize</span></code> values causes different results:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">setmetatable</span><span class="p">({</span><span class="s1">&#39;</span><span class="s">A&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">},</span> <span class="p">{</span> <span class="n">__serialize</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">seq&quot;</span><span class="p">}))</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;[&quot;A&quot;,&quot;B&quot;]&#39;</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">setmetatable</span><span class="p">({</span><span class="s1">&#39;</span><span class="s">A&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">},</span> <span class="p">{</span> <span class="n">__serialize</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">map&quot;</span><span class="p">}))</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;{&quot;1&quot;:&quot;A&quot;,&quot;2&quot;:&quot;B&quot;}&#39;</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span><span class="nb">setmetatable</span><span class="p">({</span><span class="n">f1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">A&#39;</span><span class="p">,</span> <span class="n">f2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">},</span> <span class="p">{</span> <span class="n">__serialize</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">map&quot;</span><span class="p">})})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;[{&quot;f2&quot;:&quot;B&quot;,&quot;f1&quot;:&quot;A&quot;}]&#39;</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span><span class="nb">setmetatable</span><span class="p">({</span><span class="n">f1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">A&#39;</span><span class="p">,</span> <span class="n">f2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">},</span> <span class="p">{</span> <span class="n">__serialize</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">seq&quot;</span><span class="p">})})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;[[]]&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
<div class="section" id="configuration-settings">
<span id="json-module-cfg"></span><h4>Configuration settings<a class="headerlink" href="#configuration-settings" title="Ссылка на этот заголовок">¶</a></h4>
<p>There are configuration settings which affect the way that Tarantool encodes
invalid numbers or types. They are all boolean <code class="docutils literal"><span class="pre">true</span></code>/<code class="docutils literal"><span class="pre">false</span></code> values</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">cfg.encode_invalid_numbers</span></code> - allow nan and inf (default is true)</li>
<li><code class="docutils literal"><span class="pre">cfg.encode_use_tostring</span></code> - use tostring for unrecognizable types (default is false)</li>
<li><code class="docutils literal"><span class="pre">cfg.encode_invalid_as_nil</span></code> - use null for all unrecognizable types (default is false)</li>
<li><code class="docutils literal"><span class="pre">cfg.encode_load_metatables</span></code> - load metatables (default is false)</li>
</ul>
<p>For example, the following code will interpret 0/0 (which is &quot;not a number&quot;)
and 1/0 (which is &quot;infinity&quot;) as special values rather than nulls or errors:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">json</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">json&#39;</span><span class="p">)</span>
<span class="n">json</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">encode_invalid_numbers</span> <span class="o">=</span> <span class="kc">true</span><span class="p">}</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">/</span><span class="mi">0</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">0</span>
<span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">})</span>
</pre></div>
</div>
<p>The result of the json.encode request will look like this:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">json</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;[1,nan,inf,2]</span>
<span class="s">...</span>
</pre></div>
</div>
<p>The same configuration settings exist for json, for
<a class="reference internal" href="singlehtml.html#msgpack-module"><span class="std std-ref">MsgPack</span></a>, and for <a class="reference internal" href="singlehtml.html#yaml-module"><span class="std std-ref">YAML</span></a>.
&gt;&gt;&gt;&gt;&gt;&gt;&gt; Fix every NOTE to be highlighted on site + JSON cfg rewritten</p>
</div>
</div>
<span id="document-reference_lua/log"></span><div class="section" id="lua-module.log">
<span id="module-log"></span><span id="log"></span><h3>Module <cite>log</cite><a class="headerlink" href="#lua-module.log" title="Ссылка на этот заголовок">¶</a></h3>
<p>The Tarantool server puts all diagnostic messages in a log file specified by
the <a class="reference internal" href="singlehtml.html#cfg-logging-logger"><span class="std std-ref">logger</span></a> configuration parameter. Diagnostic messages may be either
system-generated by the server's internal code, or user-generated with the
<code class="docutils literal"><span class="pre">log.log_level_function_name</span></code> function.</p>
<dl class="function">
<dt id="lua-функция.log.error">
<em class="property"> </em><code class="descclassname">log.</code><code class="descname">error</code><big>(</big><em>message</em><big>)</big><a class="headerlink" href="#lua-функция.log.error" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.log.warn">
<em class="property"> </em><code class="descclassname">log.</code><code class="descname">warn</code><big>(</big><em>message</em><big>)</big><a class="headerlink" href="#lua-функция.log.warn" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.log.info">
<em class="property"> </em><code class="descclassname">log.</code><code class="descname">info</code><big>(</big><em>message</em><big>)</big><a class="headerlink" href="#lua-функция.log.info" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.log.debug">
<em class="property"> </em><code class="descclassname">log.</code><code class="descname">debug</code><big>(</big><em>message</em><big>)</big><a class="headerlink" href="#lua-функция.log.debug" title="Ссылка на это определение">¶</a></dt>
<dd><p>Output a user-generated message to the <a class="reference internal" href="singlehtml.html#cfg-logging-logger"><span class="std std-ref">log file</span></a>, given
log_level_function_name = <code class="docutils literal"><span class="pre">error</span></code> or <code class="docutils literal"><span class="pre">warn</span></code> or <code class="docutils literal"><span class="pre">info</span></code> or <code class="docutils literal"><span class="pre">debug</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>message</strong> (<em>string</em>) -- The actual output will be a line containing the
current timestamp, a module name, 'E' or 'W' or
'I' or 'D' or 'R' depending on
<code class="docutils literal"><span class="pre">log_level_function_name</span></code>, and <code class="docutils literal"><span class="pre">message</span></code>.
Output will not occur if <code class="docutils literal"><span class="pre">log_level_function_name</span></code>
is for a type greater than <a class="reference internal" href="singlehtml.html#cfg-logging-log-level"><span class="std std-ref">log_level</span></a>.
Messages may contain C-style format specifiers
%d or %s, so <code class="samp docutils literal"><span class="pre">log.error('...%d...%s',</span><em><span class="pre">x</span></em><span class="pre">,</span><em><span class="pre">y</span></em><span class="pre">)</span></code>
will work if x is a number and y is a string.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="log-logger-pid"></span><dl class="function">
<dt id="lua-функция.log.logger_pid">
<em class="property"> </em><code class="descclassname">log.</code><code class="descname">logger_pid</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.log.logger_pid" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="lua-функция.log.rotate">
<em class="property"> </em><code class="descclassname">log.</code><code class="descname">rotate</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.log.rotate" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Ссылка на этот заголовок">¶</a></h4>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ ~/tarantool/src/tarantool
tarantool&gt; box.cfg<span class="o">{</span><span class="nv">log_level</span><span class="o">=</span>3, <span class="nv">logger</span><span class="o">=</span><span class="s1">&#39;tarantool.txt&#39;</span><span class="o">}</span>
tarantool&gt; <span class="nv">log</span> <span class="o">=</span> require<span class="o">(</span><span class="s1">&#39;log&#39;</span><span class="o">)</span>
tarantool&gt; log.error<span class="o">(</span><span class="s1">&#39;Error&#39;</span><span class="o">)</span>
tarantool&gt; log.info<span class="o">(</span><span class="s1">&#39;Info %s&#39;</span>, box.info.version<span class="o">)</span>
tarantool&gt; os.exit<span class="o">()</span>
$ less tarantool.txt
</pre></div>
</div>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="mf">2.</span><span class="o">..</span><span class="mi">0</span> <span class="p">[</span><span class="mi">5257</span><span class="p">]</span> <span class="n">main</span><span class="o">/</span><span class="mi">101</span><span class="o">/</span><span class="n">interactive</span> <span class="n">C</span><span class="o">&gt;</span> <span class="n">version</span> <span class="mf">1.7</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="mi">355</span><span class="o">-</span><span class="n">ga4f762d</span>
<span class="mf">2.</span><span class="o">..</span><span class="mi">1</span> <span class="p">[</span><span class="mi">5257</span><span class="p">]</span> <span class="n">main</span><span class="o">/</span><span class="mi">101</span><span class="o">/</span><span class="n">interactive</span> <span class="n">C</span><span class="o">&gt;</span> <span class="n">log</span> <span class="n">level</span> <span class="mi">3</span>
<span class="mf">2.</span><span class="o">..</span><span class="mi">1</span> <span class="p">[</span><span class="mi">5261</span><span class="p">]</span> <span class="n">main</span><span class="o">/</span><span class="mi">101</span><span class="o">/</span><span class="n">spawner</span> <span class="n">C</span><span class="o">&gt;</span> <span class="n">initialized</span>
<span class="mf">2.</span><span class="o">..</span><span class="mi">0</span> <span class="p">[</span><span class="mi">5257</span><span class="p">]</span> <span class="n">main</span><span class="o">/</span><span class="mi">101</span><span class="o">/</span><span class="n">interactive</span> <span class="p">[</span><span class="n">C</span><span class="p">]:</span><span class="o">-</span><span class="mi">1</span> <span class="n">E</span><span class="o">&gt;</span> <span class="n">Error</span>
</pre></div>
</div>
<p>The 'Error' line is visible in tarantool.txt preceded by the letter E.</p>
<p>The 'Info' line is not present because the log_level is 3.</p>
</div>
</div>
<span id="document-reference_lua/msgpack"></span><div class="section" id="module-msgpack">
<span id="msgpack-module"></span><h3>Модуль <cite>msgpack</cite><a class="headerlink" href="#module-msgpack" title="Ссылка на этот заголовок">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">msgpack</span></code> module takes strings in <a class="reference external" href="http://msgpack.org/">MsgPack</a> format and decodes them, or
takes a series of non-MsgPack values and encodes them.</p>
<span class="target" id="lua-module.msgpack"></span><dl class="function">
<dt id="lua-функция.msgpack.encode">
<em class="property"> </em><code class="descclassname">msgpack.</code><code class="descname">encode</code><big>(</big><em>lua_value</em><big>)</big><a class="headerlink" href="#lua-функция.msgpack.encode" title="Ссылка на это определение">¶</a></dt>
<dd><p>Convert a Lua object to a MsgPack string.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>lua_value</strong> -- either a scalar value or a Lua table value.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">the original value reformatted as a MsgPack string.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">string</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="lua-функция.msgpack.decode">
<em class="property"> </em><code class="descclassname">msgpack.</code><code class="descname">decode</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.msgpack.decode" title="Ссылка на это определение">¶</a></dt>
<dd><p>Convert a MsgPack string to a Lua object.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>string</strong> -- a string formatted as MsgPack.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li>the original contents formatted as a Lua table;</li>
<li>the number of bytes that were decoded.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body">table</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="msgpack-null"></span><dl class="data">
<dt id="lua-данные.msgpack.NULL">
<em class="property"> </em><code class="descclassname">msgpack.</code><code class="descname">NULL</code><a class="headerlink" href="#lua-данные.msgpack.NULL" title="Ссылка на это определение">¶</a></dt>
<dd><p>A value comparable to Lua &quot;nil&quot; which may be useful as a placeholder in a tuple.</p>
</dd></dl>

<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Ссылка на этот заголовок">¶</a></h4>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">msgpack</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">msgpack&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">msgpack</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span><span class="s1">&#39;</span><span class="s">a&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">b&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">})</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">z</span> <span class="o">=</span> <span class="n">msgpack</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">a</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">b</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">20</span><span class="p">,</span> <span class="n">msgpack</span><span class="p">.</span><span class="n">NULL</span><span class="p">,</span> <span class="mi">20</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">20</span><span class="p p-Indicator">,</span> <span class="nv">null</span><span class="p p-Indicator">,</span> <span class="nv">20</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>The MsgPack output structure can be specified with <code class="docutils literal"><span class="pre">__serialize</span></code>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">__serialize</span> <span class="pre">=</span> <span class="pre">&quot;seq&quot;</span> <span class="pre">or</span> <span class="pre">&quot;sequence&quot;</span></code> for an array</li>
<li><code class="docutils literal"><span class="pre">__serialize</span> <span class="pre">=</span> <span class="pre">&quot;map&quot;</span> <span class="pre">or</span> <span class="pre">&quot;mapping&quot;</span></code> for a map</li>
</ul>
<p>Serializing 'A' and 'B' with different <code class="docutils literal"><span class="pre">__serialize</span></code> values causes different
results. To show this, here is a routine which encodes <cite>{'A','B'}</cite> both as an
array and as a map, then displays each result in hexadecimal.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="nf">hexdump</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">&#39;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">bytes</span> <span class="k">do</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">..</span> <span class="nb">string.format</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">%x&quot;</span><span class="p">,</span> <span class="nb">string.byte</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> &#39;</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="k">end</span>

<span class="n">msgpack</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">msgpack&#39;</span><span class="p">)</span>
<span class="n">m1</span> <span class="o">=</span> <span class="n">msgpack</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">setmetatable</span><span class="p">({</span><span class="s1">&#39;</span><span class="s">A&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">},</span> <span class="p">{</span>
                             <span class="n">__serialize</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">seq&quot;</span>
                          <span class="p">}))</span>
<span class="n">m2</span> <span class="o">=</span> <span class="n">msgpack</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">setmetatable</span><span class="p">({</span><span class="s1">&#39;</span><span class="s">A&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">},</span> <span class="p">{</span>
                             <span class="n">__serialize</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">map&quot;</span>
                          <span class="p">}))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">array encoding: &#39;</span><span class="p">,</span> <span class="n">hexdump</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">map encoding: &#39;</span><span class="p">,</span> <span class="n">hexdump</span><span class="p">(</span><span class="n">m2</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Result:</strong></p>
<pre class="highlight literal-block">
<strong>array</strong> encoding: 92 a1 41 a1 42
<strong>map</strong> encoding:   82 01 a1 41 02 a1 42
</pre>
<p>The MsgPack <a class="reference external" href="http://github.com/msgpack/msgpack/blob/master/spec.md">Specification</a> page explains that the first encoding means:</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="n">fixarray</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">fixstr</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">fixstr</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;B&quot;</span>
</pre></div>
</div>
<p>and the second encoding means:</p>
<div class="highlight highlight-default"><div class="highlight"><pre><span></span><span class="n">fixmap</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">key</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">fixstr</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">fixstr</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;B&quot;</span><span class="o">.</span>
</pre></div>
</div>
<p>Here are examples for all the common types,
with the Lua-table representation on the left,
with the MsgPack format name and encoding on the right.</p>
<div class="table container" id="msgpack-common-types-and-msgpack-encodings">
<p><strong>Common Types and MsgPack Encodings</strong></p>
<table border="1" class="left-align-column-1 left-align-column-2 docutils">
<colgroup>
<col width="22%" />
<col width="78%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>{}</td>
<td>'fixmap' if metatable is 'map' = 80
otherwise 'fixarray' = 90</td>
</tr>
<tr class="row-even"><td>'a'</td>
<td>'fixstr' = a1 61</td>
</tr>
<tr class="row-odd"><td>false</td>
<td>'false' = c2</td>
</tr>
<tr class="row-even"><td>true</td>
<td>'true' = c3</td>
</tr>
<tr class="row-odd"><td>127</td>
<td>'positive fixint' = 7f</td>
</tr>
<tr class="row-even"><td>65535</td>
<td>'uint 16' = cd ff ff</td>
</tr>
<tr class="row-odd"><td>4294967295</td>
<td>'uint 32' = ce ff ff ff ff</td>
</tr>
<tr class="row-even"><td>nil</td>
<td>'nil' = c0</td>
</tr>
<tr class="row-odd"><td>msgpack.NULL</td>
<td>same as nil</td>
</tr>
<tr class="row-even"><td>[0] = 5</td>
<td>'fixmap(1)' + 'positive fixint' (for the key)
+ 'positive fixint' (for the value) = 81 00 05</td>
</tr>
<tr class="row-odd"><td>[0] = nil</td>
<td>'fixmap(0)' = 80 -- nil is not stored
when it is a missing map value</td>
</tr>
<tr class="row-even"><td>1.5</td>
<td>'float 64' = cb 3f f8 00 00 00 00 00 00</td>
</tr>
</tbody>
</table>
</div>
<p>Also, some MsgPack configuration settings for encoding can be changed, in the
same way that they can be changed for <a class="reference internal" href="singlehtml.html#json-module-cfg"><span class="std std-ref">JSON</span></a>.</p>
</div>
</div>
<span id="document-reference_lua/net_box"></span><div class="section" id="module-net-box">
<span id="net-box-module"></span><h3>Модуль <cite>net.box</cite><a class="headerlink" href="#module-net-box" title="Ссылка на этот заголовок">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">net.box</span></code> module contains connectors to remote database systems. One
variant, to be discussed later, is for connecting to MySQL or MariaDB or PostgreSQL —
that variant is the subject of the <a class="reference internal" href="singlehtml.html#dbms-modules"><span class="std std-ref">SQL DBMS modules</span></a> appendix.
In this section the subject is the built-in variant, <code class="docutils literal"><span class="pre">net.box</span></code>. This is for
connecting to tarantool servers via a network.</p>
<p>Call <code class="docutils literal"><span class="pre">require('net.box')</span></code> to get a <code class="docutils literal"><span class="pre">net.box</span></code> object, which will be called
<code class="docutils literal"><span class="pre">net_box</span></code> for examples in this section. Call <code class="docutils literal"><span class="pre">net_box.new()</span></code> to connect and
get a connection object, which will be called <code class="docutils literal"><span class="pre">conn</span></code> for examples in this section.
Call the other <code class="docutils literal"><span class="pre">net.box()</span></code> routines, passing <code class="docutils literal"><span class="pre">conn:</span></code>, to execute requests on
the remote box. Call <a class="reference internal" href="singlehtml.html#socket-close"><span class="std std-ref">conn:close</span></a> to disconnect.</p>
<p>All <code class="docutils literal"><span class="pre">net.box</span></code> methods are fiber-safe, that is, it is safe to share and use the
same connection object across multiple concurrent fibers. In fact, it's perhaps
the best programming practice with Tarantool. When multiple fibers use the same
connection, all requests are pipelined through the same network socket, but each
fiber gets back a correct response. Reducing the number of active sockets lowers
the overhead of system calls and increases the overall server performance. There
are, however, cases when a single connection is not enough — for example when it's
necessary to prioritize requests or to use different authentication ids.</p>
<span class="target" id="lua-module.net_box"></span><dl class="function">
<dt id="lua-функция.net_box.new">
<em class="property"> </em><code class="descclassname">net_box.</code><code class="descname">new</code><big>(</big><em>URI</em><span class="optional">[</span>, <em>{option[s]}</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.net_box.new" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create a new connection. The connection is established on demand, at the
time of the first request. It is re-established automatically after a
disconnect. The returned <code class="docutils literal"><span class="pre">conn</span></code> object supports methods for making remote
requests, such as select, update or delete.</p>
<p>For the local tarantool server there is a pre-created always-established
connection object named <code class="samp docutils literal"><em><span class="pre">net_box</span></em><span class="pre">.self</span></code>. Its purpose is to make polymorphic
use of the <code class="docutils literal"><span class="pre">net_box</span></code> API easier. Therefore <code class="samp docutils literal"><span class="pre">conn</span> <span class="pre">=</span> <em><span class="pre">net_box</span></em><span class="pre">.new('localhost:3301')</span></code>
can be replaced by <code class="samp docutils literal"><span class="pre">conn</span> <span class="pre">=</span> <em><span class="pre">net_box</span></em><span class="pre">.self</span></code>. However, there is an important
difference between the embedded connection and a remote one. With the
embedded connection, requests which do not modify data do not yield.
When using a remote connection, due to <a class="reference internal" href="singlehtml.html#atomic-the-implicit-yield-rules"><span class="std std-ref">the implicit rules</span></a>
any request can yield, and database
state may have changed by the time it regains control.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>URI</strong> (<em>string</em>) -- the <a class="reference internal" href="singlehtml.html#index-uri"><span class="std std-ref">URI</span></a> of the target for the connection</li>
<li><strong>options</strong> -- a possible option is <cite>wait_connect</cite></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">conn object</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">userdata</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">conn</span> <span class="o">=</span> <span class="n">net_box</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">localhost:3301&#39;</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">net_box</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">127.0.0.1:3306&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">wait_connect</span> <span class="o">=</span> <span class="kc">false</span><span class="p">})</span>
</pre></div>
</div>
</dd></dl>

<dl class="class">
<dt id="lua-объект.net_box.conn">
<em class="property">объект </em><code class="descclassname">net_box.</code><code class="descname">conn</code><a class="headerlink" href="#lua-объект.net_box.conn" title="Ссылка на это определение">¶</a></dt>
<dd><dl class="method">
<dt id="lua-функция.conn.ping">
<em class="property"> </em><code class="descclassname">conn:</code><code class="descname">ping</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.conn.ping" title="Ссылка на это определение">¶</a></dt>
<dd><p>Execute a PING command.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">true on success, false on error</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">boolean</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">net_box</span><span class="p">.</span><span class="n">self</span><span class="p">:</span><span class="n">ping</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.conn.wait_connected">
<em class="property"> </em><code class="descclassname">conn:</code><code class="descname">wait_connected</code><big>(</big><span class="optional">[</span><em>timeout</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.conn.wait_connected" title="Ссылка на это определение">¶</a></dt>
<dd><p>Wait for connection to be active or closed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>timeout</strong> (<em>number</em>) -- </li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">true when connected, false on failure.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">net_box</span><span class="p">.</span><span class="n">self</span><span class="p">:</span><span class="n">wait_connected</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.conn.is_connected">
<em class="property"> </em><code class="descclassname">conn:</code><code class="descname">is_connected</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.conn.is_connected" title="Ссылка на это определение">¶</a></dt>
<dd><p>Show whether connection is active or closed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">true if connected, false on failure.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">boolean</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">net_box</span><span class="p">.</span><span class="n">self</span><span class="p">:</span><span class="n">is_connected</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.conn.close">
<em class="property"> </em><code class="descclassname">conn:</code><code class="descname">close</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.conn.close" title="Ссылка на это определение">¶</a></dt>
<dd><p>Close a connection.</p>
<p>Connection objects are garbage collected just like any other objects in Lua, so
an explicit destruction is not mandatory. However, since close() is a system
call, it is good programming practice to close a connection explicitly when it
is no longer needed, to avoid lengthy stalls of the garbage collector.</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">conn</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt>
<code class="descname">conn.space.&lt;space-name&gt;:select{field-value, ...}</code></dt>
<dd><p><code class="samp docutils literal"><span class="pre">conn.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select</span></code><code class="code docutils literal"><span class="pre">{...}</span></code> is the remote-call equivalent
of the local call <code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select</span></code><code class="code docutils literal"><span class="pre">{...}</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Примечание</p>
<p class="last">due to <a class="reference internal" href="singlehtml.html#atomic-the-implicit-yield-rules"><span class="std std-ref">the implicit yield rules</span></a>
a local <code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select</span></code><code class="code docutils literal"><span class="pre">{...}</span></code> does
not yield, but a remote <code class="samp docutils literal"><span class="pre">conn.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select</span></code><code class="code docutils literal"><span class="pre">{...}</span></code>
call does yield, so global variables or database tuples data may
change when a remote <code class="samp docutils literal"><span class="pre">conn.space.</span><em><span class="pre">space-name</span></em><span class="pre">:select</span></code><code class="code docutils literal"><span class="pre">{...}</span></code>
occurs.</p>
</div>
</dd></dl>

<dl class="method">
<dt>
<code class="descname">conn.space.&lt;space-name&gt;:get{field-value, ...}</code></dt>
<dd><p><code class="samp docutils literal"><span class="pre">conn.space.</span><em><span class="pre">space-name</span></em><span class="pre">:get(...)</span></code> is the remote-call equivalent
of the local call <code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:get(...)</span></code>.</p>
</dd></dl>

<dl class="method">
<dt>
<code class="descname">conn.space.&lt;space-name&gt;:insert{field-value, ...}</code></dt>
<dd><p><code class="samp docutils literal"><span class="pre">conn.space.</span><em><span class="pre">space-name</span></em><span class="pre">:insert(...)</span></code> is the remote-call equivalent
of the local call <code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:insert(...)</span></code>.</p>
</dd></dl>

<dl class="method">
<dt>
<code class="descname">conn.space.&lt;space-name&gt;:replace{field-value, ...}</code></dt>
<dd><p><code class="samp docutils literal"><span class="pre">conn.space.</span><em><span class="pre">space-name</span></em><span class="pre">:replace(...)</span></code> is the remote-call equivalent
of the local call <code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:replace(...)</span></code>.</p>
</dd></dl>

<dl class="method">
<dt>
<code class="descname">conn.space.&lt;space-name&gt;:update{field-value, ...}</code></dt>
<dd><p><code class="samp docutils literal"><span class="pre">conn.space.</span><em><span class="pre">space-name</span></em><span class="pre">:update(...)</span></code> is the remote-call equivalent
of the local call <code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:update(...)</span></code>.</p>
</dd></dl>

<dl class="method">
<dt>
<code class="descname">conn.space.&lt;space-name&gt;:upsert{field-value, ...}</code></dt>
<dd><p><code class="samp docutils literal"><span class="pre">conn.space.</span><em><span class="pre">space-name</span></em><span class="pre">:upsert(...)</span></code> is the remote-call equivalent
of the local call <code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:upsert(...)</span></code>.</p>
</dd></dl>

<dl class="method">
<dt>
<code class="descname">conn.space.&lt;space-name&gt;:delete{field-value, ...}</code></dt>
<dd><p><code class="samp docutils literal"><span class="pre">conn.space.</span><em><span class="pre">space-name</span></em><span class="pre">:delete(...)</span></code> is the remote-call equivalent
of the local call <code class="samp docutils literal"><span class="pre">box.space.</span><em><span class="pre">space-name</span></em><span class="pre">:delete(...)</span></code>.</p>
</dd></dl>

<span class="target" id="net-box-call"></span><dl class="method">
<dt id="lua-функция.conn.call">
<em class="property"> </em><code class="descclassname">conn:</code><code class="descname">call</code><big>(</big><em>function-name</em><span class="optional">[</span>, <em>arguments</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.conn.call" title="Ссылка на это определение">¶</a></dt>
<dd><p><code class="docutils literal"><span class="pre">conn:call('func',</span> <span class="pre">'1',</span> <span class="pre">'2',</span> <span class="pre">'3')</span></code> is the remote-call equivalent of
<code class="docutils literal"><span class="pre">func('1',</span> <span class="pre">'2',</span> <span class="pre">'3')</span></code>. That is, <code class="docutils literal"><span class="pre">conn:call</span></code> is a remote
stored-procedure call.</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">conn</span><span class="p">:</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">function5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="net-box-eval"></span><dl class="method">
<dt id="lua-функция.conn.eval">
<em class="property"> </em><code class="descclassname">conn:</code><code class="descname">eval</code><big>(</big><em>Lua-string</em><big>)</big><a class="headerlink" href="#lua-функция.conn.eval" title="Ссылка на это определение">¶</a></dt>
<dd><p><code class="samp docutils literal"><span class="pre">conn:eval(</span><em><span class="pre">Lua-string</span></em><span class="pre">)</span></code> evaluates and executes the expression
in Lua-string, which may be any statement or series of statements.
An <a class="reference internal" href="singlehtml.html#authentication-privileges"><span class="std std-ref">execute privilege</span></a> is required; if
the user does not have it, an administrator may grant it with
<code class="samp docutils literal"><span class="pre">box.schema.user.grant(</span><em><span class="pre">username</span></em><span class="pre">,</span> <span class="pre">'execute',</span> <span class="pre">'universe')</span></code>.</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">conn</span><span class="p">:</span><span class="n">eval</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">return 5+5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.conn.timeout">
<em class="property"> </em><code class="descclassname">conn:</code><code class="descname">timeout</code><big>(</big><em>timeout</em><big>)</big><a class="headerlink" href="#lua-функция.conn.timeout" title="Ссылка на это определение">¶</a></dt>
<dd><p><code class="docutils literal"><span class="pre">timeout(...)</span></code> is a wrapper which sets a timeout for the request that
follows it.</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">conn</span><span class="p">:</span><span class="n">timeout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">).</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="mi">1</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">}})</span>
</pre></div>
</div>
<p>All remote calls support execution timeouts. Using a wrapper object makes
the remote connection API compatible with the local one, removing the need
for a separate <code class="docutils literal"><span class="pre">timeout</span></code> argument, which the local version would ignore. Once
a request is sent, it cannot be revoked from the remote server even if a
timeout expires: the timeout expiration only aborts the wait for the remote
server response, not the request itself.</p>
</dd></dl>

</dd></dl>

<div class="section" id="example-showing-use-of-most-of-the-net-box-methods">
<h4>Example showing use of most of the net.box methods<a class="headerlink" href="#example-showing-use-of-most-of-the-net-box-methods" title="Ссылка на этот заголовок">¶</a></h4>
<p>This example will work with the sandbox configuration described in the preface.
That is, there is a space named tester with a numeric primary key. Assume that
the database is nearly empty. Assume that the tarantool server is running on
<code class="docutils literal"><span class="pre">localhost</span> <span class="pre">127.0.0.1:3301</span></code>.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">net_box</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">net.box&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">example</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">conn</span><span class="p">,</span> <span class="n">wtuple</span>
<span class="gp">         &gt; </span>  <span class="k">if</span> <span class="n">net_box</span><span class="p">.</span><span class="n">self</span><span class="p">:</span><span class="n">ping</span><span class="p">()</span> <span class="k">then</span>
<span class="gp">         &gt; </span>    <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">self:ping() succeeded&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>    <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">  (no surprise -- self connection is pre-established)&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="k">end</span>
<span class="gp">         &gt; </span>  <span class="k">if</span> <span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">listen</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="s">3301&#39;</span> <span class="k">then</span>
<span class="gp">         &gt; </span>    <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">The local server listen address = 3301&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="k">else</span>
<span class="gp">         &gt; </span>    <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">The local server listen address is not 3301&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>    <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">(  (maybe box.cfg{...listen=&quot;3301&quot;...} was not stated)&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>    <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">(  (so connect will fail)&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="k">end</span>
<span class="gp">         &gt; </span>  <span class="n">conn</span> <span class="o">=</span> <span class="n">net_box</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">127.0.0.1:3301&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="n">conn</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">delete</span><span class="p">{</span><span class="mi">800</span><span class="p">}</span>
<span class="gp">         &gt; </span>  <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">conn delete done on tester.&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="n">conn</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">800</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">data&#39;</span><span class="p">}</span>
<span class="gp">         &gt; </span>  <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">conn insert done on tester, index 0&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">  primary key value = 800.&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="n">wtuple</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">800</span><span class="p">}</span>
<span class="gp">         &gt; </span>  <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">conn select done on tester, index 0&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">  number of fields = &#39;</span> <span class="o">..</span> <span class="o">#</span><span class="n">wtuple</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="n">conn</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">delete</span><span class="p">{</span><span class="mi">800</span><span class="p">}</span>
<span class="gp">         &gt; </span>  <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">conn delete done on tester&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="n">conn</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">{</span><span class="mi">800</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">New data&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Extra data&#39;</span><span class="p">}</span>
<span class="gp">         &gt; </span>  <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">conn:replace done on tester&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="n">conn</span><span class="p">:</span><span class="n">timeout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">).</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="mi">800</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Fld#1&#39;</span><span class="p">}})</span>
<span class="gp">         &gt; </span>  <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">conn update done on tester&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="n">conn</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="nb">table.insert</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">conn close done&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">ta</span> <span class="o">=</span> <span class="p">{}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">example</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">ta</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">self:ping() succeeded</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;</span><span class="nv">  </span><span class="s">(no</span><span class="nv"> </span><span class="s">surprise</span><span class="nv"> </span><span class="s">--</span><span class="nv"> </span><span class="s">self</span><span class="nv"> </span><span class="s">connection</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">pre-established)&#39;</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">The local server listen address = 3301</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">conn delete done on tester.</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">conn insert done on tester, index 0</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;</span><span class="nv">  </span><span class="s">primary</span><span class="nv"> </span><span class="s">key</span><span class="nv"> </span><span class="s">value</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">800.&#39;</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">conn select done on tester, index 0</span>
  <span class="p p-Indicator">-</span> <span class="s">&#39;</span><span class="nv">  </span><span class="s">number</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">fields</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">1&#39;</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">conn delete done on tester</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">conn:replace done on tester</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">conn update done on tester</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">conn close done</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
</div>
<span id="document-reference_lua/box_once"></span><div class="section" id="function-box-once">
<span id="box-once"></span><h3>Функция <cite>box.once</cite><a class="headerlink" href="#function-box-once" title="Ссылка на этот заголовок">¶</a></h3>
<dl class="function">
<dt id="lua-функция.box.once">
<em class="property"> </em><code class="descclassname">box.</code><code class="descname">once</code><big>(</big><em>key</em>, <em>function</em><span class="optional">[</span>, <em>...</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.box.once" title="Ссылка на это определение">¶</a></dt>
<dd><p>Execute a function, provided it has not been executed before. A passed value
is checked to see whether the function has already been executed. If it has
been executed before, nothing happens. If it has not been executed before,
the function is invoked. For an explanation why <code class="docutils literal"><span class="pre">box.once</span></code> is useful, see
the section <a class="reference internal" href="singlehtml.html#index-preventing-duplicate-actions"><span class="std std-ref">Preventing Duplicate Actions</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>key</strong> (<em>string</em>) -- a value that will be checked</li>
<li><strong>function</strong> (<em>function</em>) -- a function</li>
<li><strong>...</strong> -- arguments, that must be passed to function</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<span id="document-reference_lua/os"></span><div class="section" id="lua-module.os">
<span id="module-os"></span><span id="os-module"></span><h3>Module <cite>os</cite><a class="headerlink" href="#lua-module.os" title="Ссылка на этот заголовок">¶</a></h3>
<p>The os module contains the functions
<a class="reference internal" href="#os-execute"><span class="std std-ref">execute()</span></a>,
<a class="reference internal" href="#os-rename"><span class="std std-ref">rename()</span></a>,
<a class="reference internal" href="#os-getenv"><span class="std std-ref">getenv()</span></a>,
<a class="reference internal" href="#os-remove"><span class="std std-ref">remove()</span></a>,
<a class="reference internal" href="#os-date"><span class="std std-ref">date()</span></a>,
<a class="reference internal" href="#os-exit"><span class="std std-ref">exit()</span></a>,
<a class="reference internal" href="#os-time"><span class="std std-ref">time()</span></a>,
<a class="reference internal" href="#os-clock"><span class="std std-ref">clock()</span></a>,
<a class="reference internal" href="#os-tmpname"><span class="std std-ref">tmpname()</span></a>.
Most of these functions are described in the Lua manual
Chapter 22 <a class="reference external" href="https://www.lua.org/pil/contents.html#22">The Operating System Library</a>.</p>
<span class="target" id="os-execute"></span><dl class="function">
<dt id="lua-функция.os.execute">
<em class="property"> </em><code class="descclassname">os.</code><code class="descname">execute</code><big>(</big><em>shell-command</em><big>)</big><a class="headerlink" href="#lua-функция.os.execute" title="Ссылка на это определение">¶</a></dt>
<dd><p>Execute by passing to the shell.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>shell-command</strong> (<em>string</em>) -- what to execute.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="nb">os.execute</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">ls -l /usr&#39;</span><span class="p">)</span>
<span class="go">total 200</span>
<span class="go">drwxr-xr-x   2 root root 65536 Apr 22 15:49 bin</span>
<span class="go">drwxr-xr-x  59 root root 20480 Apr 18 07:58 include</span>
<span class="go">drwxr-xr-x 210 root root 65536 Apr 18 07:59 lib</span>
<span class="go">drwxr-xr-x  12 root root  4096 Apr 22 15:49 local</span>
<span class="go">drwxr-xr-x   2 root root 12288 Jan 31 09:50 sbin</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="os-rename"></span><dl class="function">
<dt id="lua-функция.os.rename">
<em class="property"> </em><code class="descclassname">os.</code><code class="descname">rename</code><big>(</big><em>old-name</em>, <em>new-name</em><big>)</big><a class="headerlink" href="#lua-функция.os.rename" title="Ссылка на это определение">¶</a></dt>
<dd><p>Rename a file or directory.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>old-name</strong> (<em>string</em>) -- name of existing file or directory,</li>
<li><strong>new-name</strong> (<em>string</em>) -- changed name of file or directory.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="nb">os.rename</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">local&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">foreign&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;local:</span><span class="nv"> </span><span class="s">No</span><span class="nv"> </span><span class="s">such</span><span class="nv"> </span><span class="s">file</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">directory&#39;</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="os-getenv"></span><dl class="function">
<dt id="lua-функция.os.getenv">
<em class="property"> </em><code class="descclassname">os.</code><code class="descname">getenv</code><big>(</big><em>variable-name</em><big>)</big><a class="headerlink" href="#lua-функция.os.getenv" title="Ссылка на это определение">¶</a></dt>
<dd><p>Get environment variable.</p>
<p>Parameters: (string) variable-name = environment variable name.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="nb">os.getenv</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">PATH&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/usr/local/sbin:/usr/local/bin:/usr/sbin</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="os-remove"></span><dl class="function">
<dt id="lua-функция.os.remove">
<em class="property"> </em><code class="descclassname">os.</code><code class="descname">remove</code><big>(</big><em>name</em><big>)</big><a class="headerlink" href="#lua-функция.os.remove" title="Ссылка на это определение">¶</a></dt>
<dd><p>Remove file or directory.</p>
<p>Parameters: (string) name = name of file or directory which will be removed.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="nb">os.remove</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">file&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="os-date"></span><dl class="function">
<dt id="lua-функция.os.date">
<em class="property"> </em><code class="descclassname">os.</code><code class="descname">date</code><big>(</big><em>format-string</em><span class="optional">[</span>, <em>time-since-epoch</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.os.date" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return a formatted date.</p>
<p>Parameters: (string) format-string = instructions; (string) time-since-epoch =
number of seconds since 1970-01-01. If time-since-epoch is omitted, it is assumed to be the current time.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="nb">os.date</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">%A %B %d&quot;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">Sunday April 24</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="os-exit"></span><dl class="function">
<dt id="lua-функция.os.exit">
<em class="property"> </em><code class="descclassname">os.</code><code class="descname">exit</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.os.exit" title="Ссылка на это определение">¶</a></dt>
<dd><p>Exit the program. If this is done on the server, then the server stops.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="nb">os.exit</span><span class="p">()</span>
<span class="go">user@user-shell:~/tarantool_sandbox$</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="os-time"></span><dl class="function">
<dt id="lua-функция.os.time">
<em class="property"> </em><code class="descclassname">os.</code><code class="descname">time</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.os.time" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the number of seconds since the epoch.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="nb">os.time</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1461516945</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="os-clock"></span><dl class="function">
<dt id="lua-функция.os.clock">
<em class="property"> </em><code class="descclassname">os.</code><code class="descname">clock</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.os.clock" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the number of CPU seconds since the program start.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="nb">os.clock</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">0.05</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="os-tmpname"></span><dl class="function">
<dt id="lua-функция.os.tmpname">
<em class="property"> </em><code class="descclassname">os.</code><code class="descname">tmpname</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.os.tmpname" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return a name for a temporary file.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="nb">os.tmpname</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/lua_7SW1m2</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

</div>
<span id="document-reference_lua/pickle"></span><div class="section" id="lua-module.pickle">
<span id="module-pickle"></span><h3>Модуль <cite>pickle</cite><a class="headerlink" href="#lua-module.pickle" title="Ссылка на этот заголовок">¶</a></h3>
<dl class="function">
<dt id="lua-функция.pickle.pack">
<em class="property"> </em><code class="descclassname">pickle.</code><code class="descname">pack</code><big>(</big><em>format</em>, <em>argument</em><span class="optional">[</span>, <em>argument ...</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.pickle.pack" title="Ссылка на это определение">¶</a></dt>
<dd><p>To use Tarantool binary protocol primitives from Lua, it's necessary to
convert Lua variables to binary format. The <code class="docutils literal"><span class="pre">pickle.pack()</span></code> helper
function is prototyped after Perl '<a class="reference external" href="http://perldoc.perl.org/functions/pack.html">pack</a>'.</p>
<div class="table container">
<p><strong>Format specifiers</strong></p>
<table border="1" class="left-align-column-2 docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>b, B</td>
<td>converts Lua variable to a 1-byte integer,
and stores the integer in the resulting string</td>
</tr>
<tr class="row-even"><td>s, S</td>
<td>converts Lua variable to a 2-byte integer, and
stores the integer in the resulting string,
low byte first</td>
</tr>
<tr class="row-odd"><td>i, I</td>
<td>converts Lua variable to a 4-byte integer, and
stores the integer in the resulting string, low
byte first</td>
</tr>
<tr class="row-even"><td>l, L</td>
<td>converts Lua variable to an 8-byte integer, and
stores the integer in the resulting string, low
byte first</td>
</tr>
<tr class="row-odd"><td>n</td>
<td>converts Lua variable to a 2-byte integer, and
stores the integer in the resulting string, big
endian,</td>
</tr>
<tr class="row-even"><td>N</td>
<td>converts Lua variable to a 4-byte integer, and
stores the integer in the resulting string, big</td>
</tr>
<tr class="row-odd"><td>q, Q</td>
<td>converts Lua variable to an 8-byte integer, and
stores the integer in the resulting string, big
endian,</td>
</tr>
<tr class="row-even"><td>f</td>
<td>converts Lua variable to a 4-byte float, and
stores the float in the resulting string</td>
</tr>
<tr class="row-odd"><td>d</td>
<td>converts Lua variable to a 8-byte double, and
stores the double in the resulting string</td>
</tr>
<tr class="row-even"><td>a, A</td>
<td>converts Lua variable to a sequence of bytes,
and stores the sequence in the resulting string</td>
</tr>
</tbody>
</table>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>format</strong> (<em>string</em>) -- string containing format specifiers</li>
<li><strong>argument(s)</strong> (<em>scalar-value</em>) -- scalar values to be formatted</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">a binary string containing all arguments,
packed according to the format specifiers.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">string</p>
</td>
</tr>
</tbody>
</table>
<p>Possible errors: unknown format specifier.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">pickle</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">pickle&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">hello world&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span> <span class="s">&#39;hello</span><span class="nv"> </span><span class="s">world&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">bye world&#39;</span><span class="p">}})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span> <span class="s">&#39;bye</span><span class="nv"> </span><span class="s">world&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="p">{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pickle</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">iiA&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">hello&#39;</span><span class="p">)}</span>
<span class="gp">         &gt; </span><span class="p">})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span> <span class="s">&quot;\0\0\0\0</span><span class="se">\x03</span><span class="s">\0\0\0hello&quot;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">=&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">}})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span> <span class="nv">4</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">+&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">}})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span> <span class="nv">8</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="mi">0</span><span class="p">},</span> <span class="p">{{</span><span class="s1">&#39;</span><span class="s">^&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">}})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span> <span class="nv">12</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.pickle.unpack">
<em class="property"> </em><code class="descclassname">pickle.</code><code class="descname">unpack</code><big>(</big><em>format</em>, <em>binary-string</em><big>)</big><a class="headerlink" href="#lua-функция.pickle.unpack" title="Ссылка на это определение">¶</a></dt>
<dd><p>Counterpart to <code class="docutils literal"><span class="pre">pickle.pack()</span></code>.
Warning: if format specifier 'A' is used, it must be the last item.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>format</strong> (<em>string</em>) -- </li>
<li><strong>binary-string</strong> (<em>string</em>) -- </li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">A list of strings or numbers.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">table</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">pickle</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">pickle&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">tuple</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">replace</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="nb">string.len</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">pickle</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">b&#39;</span><span class="p">,</span> <span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">48</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">pickle</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">bsi&#39;</span><span class="p">,</span> <span class="n">pickle</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">bsi&#39;</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">65535</span><span class="p">,</span> <span class="mi">4294967295</span><span class="p">))</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">255</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">65535</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">4294967295</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">pickle</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">ls&#39;</span><span class="p">,</span> <span class="n">pickle</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">ls&#39;</span><span class="p">,</span> <span class="n">tonumber64</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">18446744073709551615&#39;</span><span class="p">),</span> <span class="mi">65535</span><span class="p">))</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">num</span><span class="p">,</span> <span class="n">num64</span><span class="p">,</span> <span class="n">str</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">slA&#39;</span><span class="p">,</span> <span class="n">pickle</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">slA&#39;</span><span class="p">,</span> <span class="mi">666</span><span class="p">,</span>
<span class="gp">         &gt; </span><span class="n">tonumber64</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">666666666666666&#39;</span><span class="p">),</span> <span class="s1">&#39;</span><span class="s">string&#39;</span><span class="p">))</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

</div>
<span id="document-reference_lua/socket"></span><div class="section" id="module-socket">
<span id="socket-module"></span><h3>Модуль <cite>socket</cite><a class="headerlink" href="#module-socket" title="Ссылка на этот заголовок">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">socket</span></code> module allows exchanging data via BSD sockets with a local or
remote host in connection-oriented (TCP) or datagram-oriented (UDP) mode.
Semantics of the calls in the <code class="docutils literal"><span class="pre">socket</span></code> API closely follow semantics of the
corresponding POSIX calls. Function names and signatures are mostly compatible
with <a class="reference external" href="https://github.com/diegonehab/luasocket">luasocket</a>.</p>
<p>The functions for setting up and connecting are <code class="docutils literal"><span class="pre">socket</span></code>, <code class="docutils literal"><span class="pre">sysconnect</span></code>,
<code class="docutils literal"><span class="pre">tcp_connect</span></code>. The functions for sending data are <code class="docutils literal"><span class="pre">send</span></code>, <code class="docutils literal"><span class="pre">sendto</span></code>,
<code class="docutils literal"><span class="pre">write</span></code>, <code class="docutils literal"><span class="pre">syswrite</span></code>. The functions for receiving data are <code class="docutils literal"><span class="pre">recv</span></code>,
<code class="docutils literal"><span class="pre">recvfrom</span></code>, <code class="docutils literal"><span class="pre">read</span></code>. The functions for waiting before sending/receiving
data are <code class="docutils literal"><span class="pre">wait</span></code>, <code class="docutils literal"><span class="pre">readable</span></code>, <code class="docutils literal"><span class="pre">writable</span></code>. The functions for setting
flags are <code class="docutils literal"><span class="pre">nonblock</span></code>, <code class="docutils literal"><span class="pre">setsockopt</span></code>. The functions for stopping and
disconnecting are <code class="docutils literal"><span class="pre">shutdown</span></code>, <code class="docutils literal"><span class="pre">close</span></code>. The functions for error checking
are <code class="docutils literal"><span class="pre">errno</span></code>, <code class="docutils literal"><span class="pre">error</span></code>.</p>
<div class="table container">
<p><strong>Socket functions</strong></p>
<table border="1" class="left-align-column-2 docutils">
<colgroup>
<col width="20%" />
<col width="80%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Purposes</th>
<th class="head">Names</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>setup</td>
<td><a class="reference internal" href="#socket-socket"><span class="std std-ref">socket()</span></a></td>
</tr>
<tr class="row-odd"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-tcp-connect"><span class="std std-ref">socket.tcp_connect()</span></a></td>
</tr>
<tr class="row-even"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-tcp-server"><span class="std std-ref">socket.tcp_server()</span></a></td>
</tr>
<tr class="row-odd"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-sysconnect"><span class="std std-ref">socket_object:sysconnect()</span></a></td>
</tr>
<tr class="row-even"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-send"><span class="std std-ref">socket_object:send()</span></a></td>
</tr>
<tr class="row-odd"><td>sending</td>
<td><a class="reference internal" href="#socket-sendto"><span class="std std-ref">socket_object:sendto()</span></a></td>
</tr>
<tr class="row-even"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-send"><span class="std std-ref">socket_object:write()</span></a></td>
</tr>
<tr class="row-odd"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-syswrite"><span class="std std-ref">socket_object:syswrite()</span></a></td>
</tr>
<tr class="row-even"><td>receiving</td>
<td><a class="reference internal" href="#socket-recv"><span class="std std-ref">socket_object:recv()</span></a></td>
</tr>
<tr class="row-odd"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-recvfrom"><span class="std std-ref">socket_object:recvfrom()</span></a></td>
</tr>
<tr class="row-even"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-read"><span class="std std-ref">socket_object:read()</span></a></td>
</tr>
<tr class="row-odd"><td>flag setting</td>
<td><a class="reference internal" href="#socket-nonblock"><span class="std std-ref">socket_object:nonblock()</span></a></td>
</tr>
<tr class="row-even"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-setsockopt"><span class="std std-ref">socket_object:setsockopt()</span></a></td>
</tr>
<tr class="row-odd"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-linger"><span class="std std-ref">socket_object:linger()</span></a></td>
</tr>
<tr class="row-even"><td>client/server</td>
<td><a class="reference internal" href="#socket-listen"><span class="std std-ref">socket_object:listen()</span></a></td>
</tr>
<tr class="row-odd"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-accept"><span class="std std-ref">socket_object:accept()</span></a></td>
</tr>
<tr class="row-even"><td>teardown</td>
<td><a class="reference internal" href="#socket-shutdown"><span class="std std-ref">socket_object:shutdown()</span></a></td>
</tr>
<tr class="row-odd"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-close"><span class="std std-ref">socket_object:close()</span></a></td>
</tr>
<tr class="row-even"><td>error checking</td>
<td><a class="reference internal" href="#socket-error"><span class="std std-ref">socket_object:error()</span></a></td>
</tr>
<tr class="row-odd"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-error"><span class="std std-ref">socket_object:errno()</span></a></td>
</tr>
<tr class="row-even"><td>information</td>
<td><a class="reference internal" href="#socket-getaddrinfo"><span class="std std-ref">socket.getaddrinfo()</span></a></td>
</tr>
<tr class="row-odd"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-getsockopt"><span class="std std-ref">socket_object:getsockopt()</span></a></td>
</tr>
<tr class="row-even"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-peer"><span class="std std-ref">socket_object:peer()</span></a></td>
</tr>
<tr class="row-odd"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-name"><span class="std std-ref">socket_object:name()</span></a></td>
</tr>
<tr class="row-even"><td>state checking</td>
<td><a class="reference internal" href="#socket-readable"><span class="std std-ref">socket_object:readable()</span></a></td>
</tr>
<tr class="row-odd"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-writable"><span class="std std-ref">socket_object:writable()</span></a></td>
</tr>
<tr class="row-even"><td>&quot;&quot;</td>
<td><a class="reference internal" href="#socket-wait"><span class="std std-ref">socket_object:wait()</span></a></td>
</tr>
</tbody>
</table>
</div>
<p>Typically a socket session will begin with the setup functions, will set one
or more flags, will have a loop with sending and receiving functions, will
end with the teardown functions -- as an example at the end of this section
will show. Throughout, there may be error-checking and waiting functions for
synchronization. To prevent a fiber containing socket functions from &quot;blocking&quot;
other fibers, the <a class="reference internal" href="singlehtml.html#atomic-the-implicit-yield-rules"><span class="std std-ref">implicit yield rules</span></a>
will cause a yield so that other processes
may take over, as is the norm for cooperative multitasking.</p>
<p>For all examples in this section the socket name will be sock and
the function invocations will look like <code class="docutils literal"><span class="pre">sock:function_name(...)</span></code>.</p>
<span class="target" id="lua-module.socket"></span><span class="target" id="socket-socket"></span><dl class="function">
<dt id="lua-функция.socket.__call">
<em class="property"> </em><code class="descclassname">socket.</code><code class="descname">__call</code><big>(</big><em>domain</em>, <em>type</em>, <em>protocol</em><big>)</big><a class="headerlink" href="#lua-функция.socket.__call" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create a new TCP or UDP socket. The argument values
are the same as in the <a class="reference external" href="http://man7.org/linux/man-pages/man2/socket.2.html">Linux socket(2) man page</a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">an unconnected socket, or nil.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">userdata</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">socket</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">AF_INET&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">SOCK_STREAM&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">tcp&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="socket-tcp-connect"></span><dl class="function">
<dt id="lua-функция.socket.tcp_connect">
<em class="property"> </em><code class="descclassname">socket.</code><code class="descname">tcp_connect</code><big>(</big><em>host</em><span class="optional">[</span>, <em>port</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.socket.tcp_connect" title="Ссылка на это определение">¶</a></dt>
<dd><p>Connect a socket to a remote host.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>host</strong> (<em>string</em>) -- URL or IP address</li>
<li><strong>port</strong> (<em>number</em>) -- port number</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">a connected socket, if no error.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">userdata</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">tcp_connect</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">3301</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="socket-getaddrinfo"></span><dl class="function">
<dt id="lua-функция.socket.getaddrinfo">
<em class="property"> </em><code class="descclassname">socket.</code><code class="descname">getaddrinfo</code><big>(</big><em>host</em>, <em>type</em><span class="optional">[</span>, <em>{option-list}</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.socket.getaddrinfo" title="Ссылка на это определение">¶</a></dt>
<dd><p>The <code class="docutils literal"><span class="pre">socket.getaddrinfo()</span></code> function is useful for finding information
about a remote site so that the correct arguments for
<code class="docutils literal"><span class="pre">sock:sysconnect()</span></code> can be passed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">A table containing these fields: &quot;host&quot;, &quot;family&quot;, &quot;type&quot;, &quot;protocol&quot;, &quot;port&quot;.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">table</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<p><code class="docutils literal"><span class="pre">socket.getaddrinfo('tarantool.org',</span> <span class="pre">'http')</span></code> will return variable
information such as</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">host</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">188.93.56.70</span>
    <span class="l l-Scalar l-Scalar-Plain">family</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">AF_INET</span>
    <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">SOCK_STREAM</span>
    <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">tcp</span>
    <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">host</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">188.93.56.70</span>
    <span class="l l-Scalar l-Scalar-Plain">family</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">AF_INET</span>
    <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">SOCK_DGRAM</span>
    <span class="l l-Scalar l-Scalar-Plain">protocol</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">udp</span>
    <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="socket-tcp-server"></span><dl class="function">
<dt id="lua-функция.socket.tcp_server">
<em class="property"> </em><code class="descclassname">socket.</code><code class="descname">tcp_server</code><big>(</big><em>host</em>, <em>port</em>, <em>handler-function</em><big>)</big><a class="headerlink" href="#lua-функция.socket.tcp_server" title="Ссылка на это определение">¶</a></dt>
<dd><p>The <code class="docutils literal"><span class="pre">socket.tcp_server()</span></code> function makes Tarantool act as a server that
can accept connections. Usually the same objective
is accomplished with <code class="docutils literal"><span class="pre">box.cfg{listen=...)</span></code>.</p>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">socket</span><span class="p">.</span><span class="n">tcp_server</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">localhost&#39;</span><span class="p">,</span> <span class="mi">3302</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="k">end</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="class">
<dt id="lua-объект.socket.socket_object">
<em class="property">объект </em><code class="descclassname">socket.</code><code class="descname">socket_object</code><a class="headerlink" href="#lua-объект.socket.socket_object" title="Ссылка на это определение">¶</a></dt>
<dd><span class="target" id="socket-sysconnect"></span><dl class="method">
<dt id="lua-функция.socket_object.sysconnect">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">sysconnect</code><big>(</big><em>host</em>, <em>port</em><big>)</big><a class="headerlink" href="#lua-функция.socket_object.sysconnect" title="Ссылка на это определение">¶</a></dt>
<dd><p>Connect an existing socket to a remote host. The argument values are the same as
in tcp_connect().
The host must be an IP address.</p>
<dl class="docutils">
<dt>Parameters:</dt>
<dd><ul class="first last">
<li><dl class="first docutils">
<dt>Either:</dt>
<dd><ul class="first last simple">
<li>host - a string representation of an IPv4 address
or an IPv6 address;</li>
<li>port - a number.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Or:</dt>
<dd><ul class="first last simple">
<li>host - a string containing &quot;unix/&quot;;</li>
<li>port - a string containing a path to a unix socket.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Or:</dt>
<dd><ul class="first last simple">
<li>host - a number, 0 (zero), meaning &quot;all local
interfaces&quot;;</li>
<li>port - a number. If a port number is 0 (zero),
the socket will be bound to a random local port.</li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">the socket object value may change if sysconnect() succeeds.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">boolean</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">socket</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">socket&#39;</span><span class="p">)</span>
<span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">AF_INET&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">SOCK_STREAM&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">tcp&#39;</span><span class="p">)</span>
<span class="n">sock</span><span class="p">:</span><span class="n">sysconnect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3301</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="socket-send"></span><dl class="method">
<dt id="lua-функция.socket_object.send">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">send</code><big>(</big><em>data</em><big>)</big><a class="headerlink" href="#lua-функция.socket_object.send" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.socket_object.write">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">write</code><big>(</big><em>data</em><big>)</big><a class="headerlink" href="#lua-функция.socket_object.write" title="Ссылка на это определение">¶</a></dt>
<dd><p>Send data over a connected socket.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>data</strong> (<em>string</em>) -- </li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">the number of bytes sent.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">number</p>
</td>
</tr>
</tbody>
</table>
<p>Possible errors: nil on error.</p>
</dd></dl>

<span class="target" id="socket-syswrite"></span><dl class="method">
<dt id="lua-функция.socket_object.syswrite">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">syswrite</code><big>(</big><em>size</em><big>)</big><a class="headerlink" href="#lua-функция.socket_object.syswrite" title="Ссылка на это определение">¶</a></dt>
<dd><p>Write as much as possible data to the socket buffer if non-blocking.
Rarely used. For details see <a class="reference external" href="https://github.com/tarantool/tarantool/wiki/sockets%201.6">this description</a>.</p>
</dd></dl>

<span class="target" id="socket-recv"></span><dl class="method">
<dt id="lua-функция.socket_object.recv">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">recv</code><big>(</big><em>size</em><big>)</big><a class="headerlink" href="#lua-функция.socket_object.recv" title="Ссылка на это определение">¶</a></dt>
<dd><p>Read <code class="docutils literal"><span class="pre">size</span></code> bytes from a connected socket. An internal read-ahead
buffer is used to reduce the cost of this call.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>size</strong> (<em>integer</em>) -- </li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">a string of the requested length on success.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">string</p>
</td>
</tr>
</tbody>
</table>
<p>Possible errors: On error, returns an empty string, followed by status,
errno, errstr. In case the writing side has closed its
end, returns the remainder read from the socket (possibly
an empty string), followed by &quot;eof&quot; status.</p>
</dd></dl>

<span class="target" id="socket-read"></span><dl class="method">
<dt id="lua-функция.socket_object.read">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">read</code><big>(</big><em>limit</em><span class="optional">[</span>, <em>timeout</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.socket_object.read" title="Ссылка на это определение">¶</a></dt>
<dt>
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">read</code><big>(</big><em>delimiter</em><span class="optional">[</span>, <em>timeout</em><span class="optional">]</span><big>)</big></dt>
<dt>
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">read</code><big>(</big><em>{limit=limit}</em><span class="optional">[</span>, <em>timeout</em><span class="optional">]</span><big>)</big></dt>
<dt>
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">read</code><big>(</big><em>{delimiter=delimiter}</em><span class="optional">[</span>, <em>timeout</em><span class="optional">]</span><big>)</big></dt>
<dt>
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">read</code><big>(</big><em>{limit=limit</em>, <em>delimiter=delimiter}</em><span class="optional">[</span>, <em>timeout</em><span class="optional">]</span><big>)</big></dt>
<dd><p>Read from a connected socket until some condition is true, and return
the bytes that were read.
Reading goes on until <code class="docutils literal"><span class="pre">limit</span></code> bytes have been read, or a delimiter
has been read, or a timeout has expired.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>limit</strong> (<em>integer</em>) -- maximum number of bytes to read for
example 50 means &quot;stop after 50 bytes&quot;</li>
<li><strong>delimiter</strong> (<em>string</em>) -- separator for example
'?' means &quot;stop after a question mark&quot;</li>
<li><strong>timeout</strong> (<em>number</em>) -- maximum number of seconds to wait for
example 50 means &quot;stop after 50 seconds&quot;.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">an empty string if there is nothing more to read, or a nil
value if error, or a string up to <code class="docutils literal"><span class="pre">limit</span></code> bytes long,
which may include the bytes that matched the <code class="docutils literal"><span class="pre">delimiter</span></code>
expression.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">string</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="socket-sysread"></span><dl class="method">
<dt id="lua-функция.socket_object.sysread">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">sysread</code><big>(</big><em>size</em><big>)</big><a class="headerlink" href="#lua-функция.socket_object.sysread" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return all available data from the socket buffer if non-blocking.
Rarely used. For details see <a class="reference external" href="https://github.com/tarantool/tarantool/wiki/sockets%201.6">this description</a>.</p>
</dd></dl>

<span class="target" id="socket-bind"></span><dl class="method">
<dt id="lua-функция.socket_object.bind">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">bind</code><big>(</big><em>host</em><span class="optional">[</span>, <em>port</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.socket_object.bind" title="Ссылка на это определение">¶</a></dt>
<dd><p>Bind a socket to the given host/port. A UDP socket after binding
can be used to receive data (see <a class="reference internal" href="#socket-recvfrom"><span class="std std-ref">socket_object.recvfrom</span></a>).
A TCP socket can be used to accept new connections, after it has
been put in listen mode.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>host</strong> -- </li>
<li><strong>port</strong> -- </li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">a socket object on success</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">userdata</p>
</td>
</tr>
</tbody>
</table>
<p>Possible errors: Returns nil, status, errno, errstr on error.</p>
</dd></dl>

<span class="target" id="socket-listen"></span><dl class="method">
<dt id="lua-функция.socket_object.listen">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">listen</code><big>(</big><em>backlog</em><big>)</big><a class="headerlink" href="#lua-функция.socket_object.listen" title="Ссылка на это определение">¶</a></dt>
<dd><p>Start listening for incoming connections.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>backlog</strong> -- On Linux the listen <code class="docutils literal"><span class="pre">backlog</span></code> backlog may be from
/proc/sys/net/core/somaxconn, on BSD the backlog
may be <code class="docutils literal"><span class="pre">SOMAXCONN</span></code>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">true for success, false for error.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">boolean.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="socket-accept"></span><dl class="method">
<dt id="lua-функция.socket_object.accept">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">accept</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.socket_object.accept" title="Ссылка на это определение">¶</a></dt>
<dd><p>Accept a new client connection and create a new connected socket.
It is good practice to set the socket's blocking mode explicitly
after accepting.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">new socket if success.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">userdata</td>
</tr>
</tbody>
</table>
<p>Possible errors: nil.</p>
</dd></dl>

<span class="target" id="socket-sendto"></span><dl class="method">
<dt id="lua-функция.socket_object.sendto">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">sendto</code><big>(</big><em>host</em>, <em>port</em>, <em>data</em><big>)</big><a class="headerlink" href="#lua-функция.socket_object.sendto" title="Ссылка на это определение">¶</a></dt>
<dd><p>Send a message on a UDP socket to a specified host.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>host</strong> (<em>string</em>) -- </li>
<li><strong>port</strong> (<em>number</em>) -- </li>
<li><strong>data</strong> (<em>string</em>) -- </li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">the number of bytes sent.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">number</p>
</td>
</tr>
</tbody>
</table>
<p>Possible errors: on error, returns status, errno, errstr.</p>
</dd></dl>

<span class="target" id="socket-recvfrom"></span><dl class="method">
<dt id="lua-функция.socket_object.recvfrom">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">recvfrom</code><big>(</big><em>limit</em><big>)</big><a class="headerlink" href="#lua-функция.socket_object.recvfrom" title="Ссылка на это определение">¶</a></dt>
<dd><p>Receive a message on a UDP socket.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>limit</strong> (<em>integer</em>) -- </li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">message, a table containing &quot;host&quot;, &quot;family&quot; and &quot;port&quot; fields.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">string, table</p>
</td>
</tr>
</tbody>
</table>
<p>Possible errors: on error, returns status, errno, errstr.</p>
<p><strong>Example:</strong></p>
<p>After <code class="docutils literal"><span class="pre">message_content,</span> <span class="pre">message_sender</span> <span class="pre">=</span> <span class="pre">recvfrom(1)</span></code>
the value of <code class="docutils literal"><span class="pre">message_content</span></code> might be a string containing 'X' and
the value of <code class="docutils literal"><span class="pre">message_sender</span></code> might be a table containing</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">message_sender</span><span class="p">.</span><span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">18.44.0.1&#39;</span>
<span class="n">message_sender</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">AF_INET&#39;</span>
<span class="n">message_sender</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="mi">43065</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="socket-shutdown"></span><dl class="method">
<dt id="lua-функция.socket_object.shutdown">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">shutdown</code><big>(</big><em>how</em><big>)</big><a class="headerlink" href="#lua-функция.socket_object.shutdown" title="Ссылка на это определение">¶</a></dt>
<dd><p>Shutdown a reading end, a writing end, or both ends of a socket.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>how</strong> -- socket.SHUT_RD, socket.SHUT_WR, or socket.SHUT_RDWR.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">true or false.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="socket-close"></span><dl class="method">
<dt id="lua-функция.socket_object.close">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">close</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.socket_object.close" title="Ссылка на это определение">¶</a></dt>
<dd><p>Close (destroy) a socket. A closed socket should not be used any more.
A socket is closed automatically when its userdata is garbage collected by Lua.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">true on success, false on error. For example, if
sock is already closed, sock:close() returns false.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">boolean</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="socket-error"></span><dl class="method">
<dt id="lua-функция.socket_object.error">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">error</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.socket_object.error" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.socket_object.errno">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">errno</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.socket_object.errno" title="Ссылка на это определение">¶</a></dt>
<dd><p>Retrieve information about the last error that occurred on a socket, if any.
Errors do not cause throwing of exceptions so these functions are usually necessary.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">result for <code class="docutils literal"><span class="pre">sock:errno()</span></code>, result for <code class="docutils literal"><span class="pre">sock:error()</span></code>.
If there is no error, then <code class="docutils literal"><span class="pre">sock:errno()</span></code> will return 0 and <code class="docutils literal"><span class="pre">sock:error()</span></code>.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">number, string</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="socket-setsockopt"></span><dl class="method">
<dt id="lua-функция.socket_object.setsockopt">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">setsockopt</code><big>(</big><em>level</em>, <em>name</em>, <em>value</em><big>)</big><a class="headerlink" href="#lua-функция.socket_object.setsockopt" title="Ссылка на это определение">¶</a></dt>
<dd><p>Set socket flags. The argument values are the same as in the
<a class="reference external" href="http://man7.org/linux/man-pages/man2/setsockopt.2.html">Linux getsockopt(2) man page</a>.
The ones that Tarantool accepts are:</p>
<blockquote>
<div><ul class="simple">
<li>SO_ACCEPTCONN</li>
<li>SO_BINDTODEVICE</li>
<li>SO_BROADCAST</li>
<li>SO_DEBUG</li>
<li>SO_DOMAIN</li>
<li>SO_ERROR</li>
<li>SO_DONTROUTE</li>
<li>SO_KEEPALIVE</li>
<li>SO_MARK</li>
<li>SO_OOBINLINE</li>
<li>SO_PASSCRED</li>
<li>SO_PEERCRED</li>
<li>SO_PRIORITY</li>
<li>SO_PROTOCOL</li>
<li>SO_RCVBUF</li>
<li>SO_RCVBUFFORCE</li>
<li>SO_RCVLOWAT</li>
<li>SO_SNDLOWAT</li>
<li>SO_RCVTIMEO</li>
<li>SO_SNDTIMEO</li>
<li>SO_REUSEADDR</li>
<li>SO_SNDBUF</li>
<li>SO_SNDBUFFORCE</li>
<li>SO_TIMESTAMP</li>
<li>SO_TYPE</li>
</ul>
</div></blockquote>
<p>Setting SO_LINGER is done with <code class="docutils literal"><span class="pre">sock:linger(active)</span></code>.</p>
</dd></dl>

<span class="target" id="socket-getsockopt"></span><dl class="method">
<dt id="lua-функция.socket_object.getsockopt">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">getsockopt</code><big>(</big><em>level</em>, <em>name</em><big>)</big><a class="headerlink" href="#lua-функция.socket_object.getsockopt" title="Ссылка на это определение">¶</a></dt>
<dd><p>Get socket flags. For a list of possible flags see <code class="docutils literal"><span class="pre">sock:setsockopt()</span></code>.</p>
</dd></dl>

<span class="target" id="socket-linger"></span><dl class="method">
<dt id="lua-функция.socket_object.linger">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">linger</code><big>(</big><span class="optional">[</span><em>active</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.socket_object.linger" title="Ссылка на это определение">¶</a></dt>
<dd><p>Set or clear the SO_LINGER flag. For a description of the flag, see
the <a class="reference external" href="http://man7.org/linux/man-pages/man1/loginctl.1.html">Linux man page</a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>active</strong> (<em>boolean</em>) -- </li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">new active and timeout values.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="socket-nonblock"></span><dl class="method">
<dt id="lua-функция.socket_object.nonblock">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">nonblock</code><big>(</big><span class="optional">[</span><em>flag</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.socket_object.nonblock" title="Ссылка на это определение">¶</a></dt>
<dd><ul class="simple">
<li><code class="docutils literal"><span class="pre">sock:nonblock()</span></code> returns the current flag value.</li>
<li><code class="docutils literal"><span class="pre">sock:nonblock(false)</span></code> sets the flag to false and returns false.</li>
<li><code class="docutils literal"><span class="pre">sock:nonblock(true)</span></code> sets the flag to true and returns true.</li>
</ul>
<p>This function may be useful before invoking a function which might
otherwise block indefinitely.</p>
</dd></dl>

<span class="target" id="socket-readable"></span><dl class="method">
<dt id="lua-функция.socket_object.readable">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">readable</code><big>(</big><span class="optional">[</span><em>timeout</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.socket_object.readable" title="Ссылка на это определение">¶</a></dt>
<dd><p>Wait until something is readable, or until a timeout value expires.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">true if the socket is now readable, false if timeout expired;</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="socket-writable"></span><dl class="method">
<dt id="lua-функция.socket_object.writable">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">writable</code><big>(</big><span class="optional">[</span><em>timeout</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.socket_object.writable" title="Ссылка на это определение">¶</a></dt>
<dd><p>Wait until something is writable, or until a timeout value expires.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">true if the socket is now writable, false if timeout expired;</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="socket-wait"></span><dl class="method">
<dt id="lua-функция.socket_object.wait">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">wait</code><big>(</big><span class="optional">[</span><em>timeout</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.socket_object.wait" title="Ссылка на это определение">¶</a></dt>
<dd><p>Wait until something is either readable or writable, or until a timeout value expires.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">'R' if the socket is now readable, 'W' if the socket is now writable, 'RW' if the socket is now both readable and writable, '' (empty string) if timeout expired;</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="socket-name"></span><dl class="method">
<dt id="lua-функция.socket_object.name">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">name</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.socket_object.name" title="Ссылка на это определение">¶</a></dt>
<dd><p>The <code class="docutils literal"><span class="pre">sock:name()</span></code> function is used to get information about the
near side of the connection. If a socket was bound to <code class="docutils literal"><span class="pre">xyz.com:45</span></code>,
then <code class="docutils literal"><span class="pre">sock:name</span></code> will return information about <code class="docutils literal"><span class="pre">[host:xyz.com,</span> <span class="pre">port:45]</span></code>.
The equivalent POSIX function is <code class="docutils literal"><span class="pre">getsockname()</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">A table containing these fields: &quot;host&quot;, &quot;family&quot;, &quot;type&quot;, &quot;protocol&quot;, &quot;port&quot;.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">table</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="socket-peer"></span><dl class="method">
<dt id="lua-функция.socket_object.peer">
<em class="property"> </em><code class="descclassname">socket_object:</code><code class="descname">peer</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.socket_object.peer" title="Ссылка на это определение">¶</a></dt>
<dd><p>The <code class="docutils literal"><span class="pre">sock:peer()</span></code> function is used to get information about the far side of a connection.
If a TCP connection has been made to a distant host <code class="docutils literal"><span class="pre">tarantool.org:80</span></code>, <code class="docutils literal"><span class="pre">sock:peer()</span></code>
will return information about <code class="docutils literal"><span class="pre">[host:tarantool.org,</span> <span class="pre">port:80]</span></code>.
The equivalent POSIX function is <code class="docutils literal"><span class="pre">getpeername()</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">A table containing these fields: &quot;host&quot;, &quot;family&quot;, &quot;type&quot;, &quot;protocol&quot;, &quot;port&quot;.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">table</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Ссылка на этот заголовок">¶</a></h4>
<div class="section" id="use-of-a-tcp-socket-over-the-internet">
<h5>Use of a TCP socket over the Internet<a class="headerlink" href="#use-of-a-tcp-socket-over-the-internet" title="Ссылка на этот заголовок">¶</a></h5>
<p>In this example a connection is made over the internet between the Tarantool
server and tarantool.org, then an HTTP &quot;head&quot; message is sent, and a response
is received: &quot;<code class="docutils literal"><span class="pre">HTTP/1.1</span> <span class="pre">200</span> <span class="pre">OK</span></code>&quot;. This is not a useful way to communicate
with this particular site, but shows that the system works.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">socket</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">socket&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">tcp_connect</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tarantool.org&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">sock</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">table</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">sock</span><span class="p">:</span><span class="nb">error</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">sock</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">HEAD / HTTP/1.0rnHost: tarantool.orgrnrn&quot;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">sock</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&quot;HTTP/1.1</span><span class="nv"> </span><span class="s">200</span><span class="nv"> </span><span class="s">OKrn&quot;</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">sock</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="section" id="use-of-a-udp-socket-on-localhost">
<h5>Use of a UDP socket on localhost<a class="headerlink" href="#use-of-a-udp-socket-on-localhost" title="Ссылка на этот заголовок">¶</a></h5>
<p>Here is an example with datagrams. Set up two connections on 127.0.0.1
(localhost): <code class="docutils literal"><span class="pre">sock_1</span></code> and <code class="docutils literal"><span class="pre">sock_2</span></code>. Using <code class="docutils literal"><span class="pre">sock_2</span></code>, send a message
to <code class="docutils literal"><span class="pre">sock_1</span></code>. Using <code class="docutils literal"><span class="pre">sock_1</span></code>, receive a message. Display the received
message. Close both connections. <br /> This is not a useful way for a
computer to communicate with itself, but shows that the system works.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">socket</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">socket&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">sock_1</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">AF_INET&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">SOCK_DGRAM&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">udp&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">sock_1</span><span class="p">:</span><span class="n">bind</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">127.0.0.1&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">sock_2</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">AF_INET&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">SOCK_DGRAM&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">udp&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">sock_2</span><span class="p">:</span><span class="n">sendto</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">127.0.0.1&#39;</span><span class="p">,</span> <span class="n">sock_1</span><span class="p">:</span><span class="n">name</span><span class="p">().</span><span class="n">port</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">X&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">message</span> <span class="o">=</span> <span class="n">sock_1</span><span class="p">:</span><span class="n">recvfrom</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">message</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">X</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">sock_1</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">sock_2</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="section" id="use-tcp-server-to-accept-file-contents-sent-with-socat">
<h5>Use tcp_server to accept file contents sent with socat<a class="headerlink" href="#use-tcp-server-to-accept-file-contents-sent-with-socat" title="Ссылка на этот заголовок">¶</a></h5>
<p>Here is an example of the tcp_server function, reading
strings from the client and printing them. On the client
side, the Linux socat utility will be used to ship a
whole file for the tcp_server function to read.</p>
<p>Start two shells. The first shell will be the server.
The second shell will be the client.</p>
<p>On the first shell, start Tarantool and say:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{}</span>
<span class="n">socket</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">socket&#39;</span><span class="p">)</span>
<span class="n">socket</span><span class="p">.</span><span class="n">tcp_server</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">3302</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">true</span> <span class="k">do</span>
      <span class="kd">local</span> <span class="n">request</span>
      <span class="n">request</span> <span class="o">=</span> <span class="n">s</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="n">request</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">&quot;</span> <span class="ow">or</span> <span class="n">request</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
        <span class="k">break</span>
      <span class="k">end</span>
      <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span><span class="p">)</span>
</pre></div>
</div>
<p>The above code means: use <cite>tcp_server()</cite> to wait for a
connection from any host on port 3302. When it happens,
enter a loop that reads on the socket and prints what it
reads. The &quot;delimiter&quot; for the read function is &quot;\n&quot; so
each <cite>read()</cite> will read a string as far as the next line feed,
including the line feed.</p>
<p>On the second shell, create a file that contains a few
lines. The contents don't matter. Suppose the first line
contains A, the second line contains B, the third line
contains C. Call this file &quot;tmp.txt&quot;.</p>
<p>On the second shell, use the socat utility to ship the
tmp.txt file to the server's host and port:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> socat TCP:localhost:3302 ./tmp.txt
</pre></div>
</div>
<p>Now watch what happens on the first shell.
The strings &quot;A&quot;, &quot;B&quot;, &quot;C&quot; are printed.</p>
</div>
</div>
</div>
<span id="document-reference_lua/strict"></span><div class="section" id="lua-module.strict">
<span id="module-strict"></span><h3>Модуль <cite>strict</cite><a class="headerlink" href="#lua-module.strict" title="Ссылка на этот заголовок">¶</a></h3>
<p>The <code class="code docutils literal"><span class="pre">strict</span></code> module has functions for turning &quot;strict mode&quot; on or off.
When strict mode is on, an attempt to use an undeclared global variable will
cause an error. A global variable is considered &quot;undeclared&quot; if it has never
had a value assigned to it. Often this is an indication of a programming error.</p>
<p>By default strict mode is off, unless tarantool was built with the
<code class="docutils literal"><span class="pre">-DCMAKE_BUILD_TYPE=Debug</span></code> option -- see the description of build options
in section <a class="reference internal" href="singlehtml.html#building-from-source"><span class="std std-ref">building-from-source</span></a>.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">strict</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">strict&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">strict</span><span class="p">.</span><span class="n">on</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="c1">-- strict mode is on so this will cause an error</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">... variable &#39;&#39;b&#39;&#39; is not declared&#39;</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">strict</span><span class="p">.</span><span class="n">off</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="c1">-- strict mode is off so this will not cause an error</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<span id="document-reference_lua/tap"></span><div class="section" id="module-tap">
<h3>Module <cite>tap</cite><a class="headerlink" href="#module-tap" title="Ссылка на этот заголовок">¶</a></h3>
<p>The tap module streamlines the testing of other modules. It allows writing of
tests in the <a class="reference external" href="https://en.wikipedia.org/wiki/Test_Anything_Protocol">TAP protocol</a>. The results from the tests can be parsed by
standard TAP-analyzers so they can be passed to utilities such as <a class="reference external" href="https://metacpan.org/pod/distribution/Test-Harness/bin/prove">prove</a>. Thus
one can run tests and then use the results for statistics, decision-making, and so on.</p>
<span class="target" id="lua-module.tap"></span><dl class="function">
<dt id="lua-функция.tap.test">
<em class="property"> </em><code class="descclassname">tap.</code><code class="descname">test</code><big>(</big><em>test-name</em><big>)</big><a class="headerlink" href="#lua-функция.tap.test" title="Ссылка на это определение">¶</a></dt>
<dd><p>Initialize.</p>
<p>The result of <code class="docutils literal"><span class="pre">tap.test</span></code> is an object, which will be called taptest
in the rest of this discussion, which is necessary for
<code class="docutils literal"><span class="pre">taptest:plan()</span></code> and all the other methods.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>test-name</strong> (<em>string</em>) -- an arbitrary name to give for the test outputs.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">taptest</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">userdata</p>
</td>
</tr>
</tbody>
</table>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">tap</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tap&#39;</span><span class="p">)</span>
<span class="n">taptest</span> <span class="o">=</span> <span class="n">tap</span><span class="p">.</span><span class="n">test</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">test-name&#39;</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="class">
<dt id="lua-объект.tap.taptest">
<em class="property">объект </em><code class="descclassname">tap.</code><code class="descname">taptest</code><a class="headerlink" href="#lua-объект.tap.taptest" title="Ссылка на это определение">¶</a></dt>
<dd><dl class="method">
<dt id="lua-функция.taptest.plan">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">plan</code><big>(</big><em>count</em><big>)</big><a class="headerlink" href="#lua-функция.taptest.plan" title="Ссылка на это определение">¶</a></dt>
<dd><p>Indicate how many tests will be performed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>count</strong> (<em>number</em>) -- </li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="lua-функция.taptest.check">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">check</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.taptest.check" title="Ссылка на это определение">¶</a></dt>
<dd><p>Checks the number of tests performed. This check should only be done
after all planned tests are complete, so ordinarily <code class="docutils literal"><span class="pre">taptest:check()</span></code>
will only appear at the end of a script.</p>
<p>Will display <code class="docutils literal"><span class="pre">#</span> <span class="pre">bad</span> <span class="pre">plan:</span> <span class="pre">...</span></code> if the number of completed tests is not
equal to the number of tests specified by <code class="docutils literal"><span class="pre">taptest:plan(...)</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">nil</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="lua-функция.taptest.diag">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">diag</code><big>(</big><em>message</em><big>)</big><a class="headerlink" href="#lua-функция.taptest.diag" title="Ссылка на это определение">¶</a></dt>
<dd><p>Display a diagnostic message.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>message</strong> (<em>string</em>) -- the message to be displayed.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="lua-функция.taptest.ok">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">ok</code><big>(</big><em>condition</em>, <em>test-name</em><big>)</big><a class="headerlink" href="#lua-функция.taptest.ok" title="Ссылка на это определение">¶</a></dt>
<dd><p>This is a basic function which is used by other functions. Depending
on the value of <code class="docutils literal"><span class="pre">condition</span></code>, print 'ok' or 'not ok' along with
debugging information. Displays the message.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>condition</strong> (<em>boolean</em>) -- an expression which is true or false</li>
<li><strong>test-name</strong> (<em>string</em>) -- name of test</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">true or false.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">taptest</span><span class="p">:</span><span class="n">ok</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">x&#39;</span><span class="p">)</span>
<span class="go">ok - x</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">tap</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tap&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">taptest</span> <span class="o">=</span> <span class="n">tap</span><span class="p">.</span><span class="n">test</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">test-name&#39;</span><span class="p">)</span>
<span class="go">TAP version 13</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">taptest</span><span class="p">:</span><span class="n">ok</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">X&#39;</span><span class="p">)</span>
<span class="go">ok - X</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.taptest.fail">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">fail</code><big>(</big><em>test-name</em><big>)</big><a class="headerlink" href="#lua-функция.taptest.fail" title="Ссылка на это определение">¶</a></dt>
<dd><p><code class="docutils literal"><span class="pre">taptest:fail('x')</span></code> is equivalent to <code class="docutils literal"><span class="pre">taptest:ok(false,</span> <span class="pre">'x')</span></code>.
Displays the message.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>test-name</strong> (<em>string</em>) -- name of test</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">true or false.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="lua-функция.taptest.skip">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">skip</code><big>(</big><em>message</em><big>)</big><a class="headerlink" href="#lua-функция.taptest.skip" title="Ссылка на это определение">¶</a></dt>
<dd><p><code class="docutils literal"><span class="pre">taptest:skip('x')</span></code> is equivalent to
<code class="docutils literal"><span class="pre">taptest:ok(true,</span> <span class="pre">'x'</span> <span class="pre">..</span> <span class="pre">'#</span> <span class="pre">skip')</span></code>.
Displays the message.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>test-name</strong> (<em>string</em>) -- name of test</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">taptest</span><span class="p">:</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">message&#39;</span><span class="p">)</span>
<span class="go">ok - message # skip</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="method">
<dt id="lua-функция.taptest.is">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">is</code><big>(</big><em>got</em>, <em>expected</em>, <em>test-name</em><big>)</big><a class="headerlink" href="#lua-функция.taptest.is" title="Ссылка на это определение">¶</a></dt>
<dd><p>Check whether the first argument equals the second argument.
Displays extensive message if the result is false.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>got</strong> (<em>number</em>) -- actual result</li>
<li><strong>expected</strong> (<em>number</em>) -- expected result</li>
<li><strong>test-name</strong> (<em>string</em>) -- name of test</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">true or false.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="lua-функция.taptest.isnt">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">isnt</code><big>(</big><em>got</em>, <em>expected</em>, <em>test-name</em><big>)</big><a class="headerlink" href="#lua-функция.taptest.isnt" title="Ссылка на это определение">¶</a></dt>
<dd><p>This is the negation of <code class="docutils literal"><span class="pre">taptest:is(...)</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>got</strong> (<em>number</em>) -- actual result</li>
<li><strong>expected</strong> (<em>number</em>) -- expected result</li>
<li><strong>test-name</strong> (<em>string</em>) -- name of test</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">true or false.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="lua-функция.taptest.isnil">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">isnil</code><big>(</big><em>value</em>, <em>test-name</em><big>)</big><a class="headerlink" href="#lua-функция.taptest.isnil" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.taptest.isstring">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">isstring</code><big>(</big><em>value</em>, <em>test-name</em><big>)</big><a class="headerlink" href="#lua-функция.taptest.isstring" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.taptest.isnumber">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">isnumber</code><big>(</big><em>value</em>, <em>test-name</em><big>)</big><a class="headerlink" href="#lua-функция.taptest.isnumber" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.taptest.istable">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">istable</code><big>(</big><em>value</em>, <em>test-name</em><big>)</big><a class="headerlink" href="#lua-функция.taptest.istable" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.taptest.isboolean">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">isboolean</code><big>(</big><em>value</em>, <em>test-name</em><big>)</big><a class="headerlink" href="#lua-функция.taptest.isboolean" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.taptest.isudata">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">isudata</code><big>(</big><em>value</em>, <em>test-name</em><big>)</big><a class="headerlink" href="#lua-функция.taptest.isudata" title="Ссылка на это определение">¶</a></dt>
<dt id="lua-функция.taptest.iscdata">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">iscdata</code><big>(</big><em>value</em>, <em>test-name</em><big>)</big><a class="headerlink" href="#lua-функция.taptest.iscdata" title="Ссылка на это определение">¶</a></dt>
<dd><p>Test whether a value has a particular type. Displays a long message if
the value is not of the specified type.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>value</strong> (<em>lua-value</em>) -- </li>
<li><strong>test-name</strong> (<em>string</em>) -- name of test</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">true or false.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="lua-функция.taptest.is_deeply">
<em class="property"> </em><code class="descclassname">taptest:</code><code class="descname">is_deeply</code><big>(</big><em>got</em>, <em>expected</em>, <em>test-name</em><big>)</big><a class="headerlink" href="#lua-функция.taptest.is_deeply" title="Ссылка на это определение">¶</a></dt>
<dd><p>Recursive version of <code class="docutils literal"><span class="pre">taptest:is(...)</span></code>, which can be be used to
compare tables as well as scalar values.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body"><p class="first">true or false.</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first">boolean</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>got</strong> (<em>lua-value</em>) -- actual result</li>
<li><strong>expected</strong> (<em>lua-value</em>) -- expected result</li>
<li><strong>test-name</strong> (<em>string</em>) -- name of test</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Ссылка на этот заголовок">¶</a></h4>
<p>To run this example: put the script in a file named ./tap.lua, then make
tap.lua executable by saying <code class="docutils literal"><span class="pre">chmod</span> <span class="pre">a+x</span> <span class="pre">./tap.lua</span></code>, then execute using
Tarantool as a script processor by saying ./tap.lua.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="cp">#!/usr/bin/tarantool</span>
<span class="kd">local</span> <span class="n">tap</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tap&#39;</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">tap</span><span class="p">.</span><span class="n">test</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">my test name&quot;</span><span class="p">)</span>
<span class="n">test</span><span class="p">:</span><span class="n">plan</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">test</span><span class="p">:</span><span class="n">ok</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">2 * 2 is 4&quot;</span><span class="p">)</span>
<span class="n">test</span><span class="p">:</span><span class="n">test</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">some subtests for test2&quot;</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
    <span class="n">test</span><span class="p">:</span><span class="n">plan</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">test</span><span class="p">:</span><span class="n">is</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">2 + 2 is 4&quot;</span><span class="p">)</span>
    <span class="n">test</span><span class="p">:</span><span class="n">isnt</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">2 + 3 is not 4&quot;</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span>
<span class="n">test</span><span class="p">:</span><span class="n">check</span><span class="p">()</span>
</pre></div>
</div>
<p>The output from the above script will look approximately like this:</p>
<div class="highlight-tap"><div class="highlight"><pre><span></span><span class="nn">TAP version 13</span>
<span class="kd">1..2</span><span class="c"></span>
<span class="kr">ok</span> - 2 * 2 is 4
    # Some subtests for test2
    1..2
    ok - 2 + 2 is 4,
    ok - 2 + 3 is not 4
    # Some subtests for test2: end
<span class="kr">ok</span> - some subtests for test2
</pre></div>
</div>
</div>
</div>
<span id="document-reference_lua/tarantool"></span><div class="section" id="lua-module.tarantool">
<span id="module-tarantool"></span><h3>Модуль <cite>tarantool</cite><a class="headerlink" href="#lua-module.tarantool" title="Ссылка на этот заголовок">¶</a></h3>
<p>By saying <code class="docutils literal"><span class="pre">require('tarantool')</span></code>, one can answer some questions about how the
tarantool server was built, such as &quot;what flags were used&quot;, or &quot;what was the
version of the compiler&quot;.</p>
<p id="tarantool-build">Additionally one can see the uptime and the server version and the process id.
Those information items can also be accessed with <a class="reference internal" href="singlehtml.html#box-introspection-box-info"><span class="std std-ref">box.info</span></a> but use of
the tarantool module is recommended.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">tarantool</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tarantool&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">tarantool</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">target</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Linux-x86_64-RelWithDebInfo</span>
    <span class="l l-Scalar l-Scalar-Plain">options</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cmake . -DCMAKE_INSTALL_PREFIX=/usr -DENABLE_BACKTRACE=ON</span>
    <span class="l l-Scalar l-Scalar-Plain">mod_format</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">so</span>
    <span class="l l-Scalar l-Scalar-Plain">flags</span><span class="p p-Indicator">:</span> <span class="s">&#39;</span><span class="nv"> </span><span class="s">-fno-common</span><span class="nv"> </span><span class="s">-fno-omit-frame-pointer</span><span class="nv"> </span><span class="s">-fno-stack-protector</span><span class="nv"> </span><span class="s">-fexceptions</span>
      <span class="s">-funwind-tables</span><span class="nv"> </span><span class="s">-fopenmp</span><span class="nv"> </span><span class="s">-msse2</span><span class="nv"> </span><span class="s">-std=c11</span><span class="nv"> </span><span class="s">-Wall</span><span class="nv"> </span><span class="s">-Wextra</span><span class="nv"> </span><span class="s">-Wno-sign-compare</span><span class="nv"> </span><span class="s">-Wno-strict-aliasing</span>
      <span class="s">-fno-gnu89-inline&#39;</span>
    <span class="l l-Scalar l-Scalar-Plain">compiler</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/bin/x86_64-linux-gnu-gcc /usr/bin/x86_64-linux-gnu-g++</span>
  <span class="l l-Scalar l-Scalar-Plain">uptime</span><span class="p p-Indicator">:</span> <span class="s">&#39;function:</span><span class="nv"> </span><span class="s">0x408668e0&#39;</span>
  <span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1.7.0-66-g9093daa</span>
  <span class="l l-Scalar l-Scalar-Plain">pid</span><span class="p p-Indicator">:</span> <span class="s">&#39;function:</span><span class="nv"> </span><span class="s">0x40866900&#39;</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">tarantool</span><span class="p">.</span><span class="n">pid</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">30155</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">tarantool</span><span class="p">.</span><span class="n">uptime</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">108.64641499519</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<span id="document-reference_lua/uuid"></span><div class="section" id="module-uuid">
<h3>Module <cite>uuid</cite><a class="headerlink" href="#module-uuid" title="Ссылка на этот заголовок">¶</a></h3>
<p>A &quot;UUID&quot; is a <a class="reference external" href="https://en.wikipedia.org/wiki/Universally_unique_identifier">Universally unique identifier</a>. If an application requires that
a value be unique only within a single computer or on a single database, then a
simple counter is better than a UUID, because getting a UUID is time-consuming
(it requires a <a class="reference external" href="https://en.wikipedia.org/wiki/Syscall">syscall</a>). For clusters of computers, or widely distributed
applications, UUIDs are better.</p>
<p>The functions that can return a UUID are:</p>
<ul class="simple">
<li><a class="reference internal" href="#uuid-call"><span class="std std-ref">uuid()</span></a></li>
<li><a class="reference internal" href="#uuid-bin"><span class="std std-ref">uuid.bin()</span></a></li>
<li><a class="reference internal" href="#uuid-str"><span class="std std-ref">uuid.str()</span></a></li>
</ul>
<p>The functions that can convert between different types of UUID are:</p>
<ul class="simple">
<li><a class="reference internal" href="#uuid-object-bin"><span class="std std-ref">uuid_object:bin()</span></a></li>
<li><a class="reference internal" href="#uuid-object-str"><span class="std std-ref">uuid_object:str()</span></a></li>
<li><a class="reference internal" href="#uuid-fromstr"><span class="std std-ref">uuid.fromstr()</span></a></li>
<li><a class="reference internal" href="#uuid-frombin"><span class="std std-ref">uuid.frombin()</span></a></li>
</ul>
<p>The function that can determine whether a UUID is an all-zero value is:</p>
<ul class="simple">
<li><a class="reference internal" href="#uuid-isnil"><span class="std std-ref">uuid_object:isnil()</span></a></li>
</ul>
<span class="target" id="lua-module.uuid"></span><dl class="data">
<dt id="lua-данные.uuid.nil">
<em class="property"> </em><code class="descclassname">uuid.</code><code class="descname">nil</code><a class="headerlink" href="#lua-данные.uuid.nil" title="Ссылка на это определение">¶</a></dt>
<dd><p>A nil object</p>
</dd></dl>

<span class="target" id="uuid-call"></span><dl class="function">
<dt id="lua-функция.uuid.__call">
<em class="property"> </em><code class="descclassname">uuid.</code><code class="descname">__call</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.uuid.__call" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">a UUID</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">cdata</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="uuid-bin"></span><dl class="function">
<dt id="lua-функция.uuid.bin">
<em class="property"> </em><code class="descclassname">uuid.</code><code class="descname">bin</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.uuid.bin" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">a UUID</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">16-byte string</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="uuid-str"></span><dl class="function">
<dt id="lua-функция.uuid.str">
<em class="property"> </em><code class="descclassname">uuid.</code><code class="descname">str</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.uuid.str" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">a UUID</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">36-byte binary string</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="uuid-fromstr"></span><dl class="function">
<dt id="lua-функция.uuid.fromstr">
<em class="property"> </em><code class="descclassname">uuid.</code><code class="descname">fromstr</code><big>(</big><em>uuid_str</em><big>)</big><a class="headerlink" href="#lua-функция.uuid.fromstr" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>uuid_str</strong> -- UUID in 36-byte hexadecimal string</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">converted UUID</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">cdata</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="uuid-frombin"></span><dl class="function">
<dt id="lua-функция.uuid.frombin">
<em class="property"> </em><code class="descclassname">uuid.</code><code class="descname">frombin</code><big>(</big><em>uuid_bin</em><big>)</big><a class="headerlink" href="#lua-функция.uuid.frombin" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>uuid_str</strong> -- UUID in 16-byte binary string</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">converted UUID</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">cdata</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="class">
<dt id="lua-объект.uuid.uuid_object">
<em class="property">объект </em><code class="descclassname">uuid.</code><code class="descname">uuid_object</code><a class="headerlink" href="#lua-объект.uuid.uuid_object" title="Ссылка на это определение">¶</a></dt>
<dd><span class="target" id="uuid-object-bin"></span><dl class="method">
<dt id="lua-функция.uuid_object.bin">
<em class="property"> </em><code class="descclassname">uuid_object:</code><code class="descname">bin</code><big>(</big><span class="optional">[</span><em>byte-order</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.uuid_object.bin" title="Ссылка на это определение">¶</a></dt>
<dd><p><code class="docutils literal"><span class="pre">byte-order</span></code> can be one of next flags:</p>
<ul class="simple">
<li>'l' - little-endian,</li>
<li>'b' - big-endian,</li>
<li>'h' - endianness depends on host (default),</li>
<li>'n' - endianness depends on network</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>byte-order</strong> (<em>string</em>) -- one of <code class="docutils literal"><span class="pre">'l'</span></code>, <code class="docutils literal"><span class="pre">'b'</span></code>, <code class="docutils literal"><span class="pre">'h'</span></code> or <code class="docutils literal"><span class="pre">'n'</span></code>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">UUID converted from cdata input value.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">16-byte binary string</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="uuid-object-str"></span><dl class="method">
<dt id="lua-функция.uuid_object.str">
<em class="property"> </em><code class="descclassname">uuid_object:</code><code class="descname">str</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.uuid_object.str" title="Ссылка на это определение">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">UUID converted from cdata input value.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">36-byte hexadecimal string</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="uuid-isnil"></span><dl class="method">
<dt id="lua-функция.uuid_object.isnil">
<em class="property"> </em><code class="descclassname">uuid_object:</code><code class="descname">isnil</code><big>(</big><big>)</big><a class="headerlink" href="#lua-функция.uuid_object.isnil" title="Ссылка на это определение">¶</a></dt>
<dd><p>The all-zero UUID value can be expressed as uuid.NULL, or as
<code class="docutils literal"><span class="pre">uuid.fromstr('00000000-0000-0000-0000-000000000000')</span></code>.
The comparison with an all-zero value can also be expressed as
<code class="docutils literal"><span class="pre">uuid_with_type_cdata</span> <span class="pre">==</span> <span class="pre">uuid.NULL</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return:</th><td class="field-body">true if the value is all zero, otherwise false.</td>
</tr>
<tr class="field-even field"><th class="field-name">Rtype:</th><td class="field-body">bool</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Ссылка на этот заголовок">¶</a></h4>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">uuid</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">uuid&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">uuid</span><span class="p">(),</span> <span class="n">uuid</span><span class="p">.</span><span class="n">bin</span><span class="p">(),</span> <span class="n">uuid</span><span class="p">.</span><span class="n">str</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">16ffedc8-cbae-4f93-a05e-349f3ab70baa</span>
<span class="p p-Indicator">-</span> <span class="kt">!!binary</span> <span class="l l-Scalar l-Scalar-Plain">FvG+Vy1MfUC6kIyeM81DYw==</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">67c999d2-5dce-4e58-be16-ac1bcb93160f</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">uu</span> <span class="o">=</span> <span class="n">uuid</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="o">#</span><span class="n">uui</span><span class="p">:</span><span class="n">bin</span><span class="p">(),</span> <span class="o">#</span><span class="n">uu</span><span class="p">:</span><span class="n">str</span><span class="p">(),</span> <span class="nb">type</span><span class="p">(</span><span class="n">uu</span><span class="p">),</span> <span class="n">uu</span><span class="p">:</span><span class="n">isnil</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">16</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">36</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cdata</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
</div>
<span id="document-reference_lua/yaml"></span><div class="section" id="module-yaml">
<span id="yaml-module"></span><h3>Module <cite>yaml</cite><a class="headerlink" href="#module-yaml" title="Ссылка на этот заголовок">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">yaml</span></code> module takes strings in <a class="reference external" href="http://yaml.org/">YAML</a> format and decodes them, or takes a
series of non-YAML values and encodes them.</p>
<span class="target" id="lua-module.yaml"></span><dl class="function">
<dt id="lua-функция.yaml.encode">
<em class="property"> </em><code class="descclassname">yaml.</code><code class="descname">encode</code><big>(</big><em>lua_value</em><big>)</big><a class="headerlink" href="#lua-функция.yaml.encode" title="Ссылка на это определение">¶</a></dt>
<dd><p>Convert a Lua object to a YAML string.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>lua_value</strong> -- either a scalar value or a Lua table value.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">the original value reformatted as a YAML string.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">string</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="lua-функция.yaml.decode">
<em class="property"> </em><code class="descclassname">yaml.</code><code class="descname">decode</code><big>(</big><em>string</em><big>)</big><a class="headerlink" href="#lua-функция.yaml.decode" title="Ссылка на это определение">¶</a></dt>
<dd><p>Convert a YAML string to a Lua object.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>string</strong> -- a string formatted as YAML.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">the original contents formatted as a Lua table.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">table</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="yaml-null"></span><dl class="data">
<dt id="lua-данные.yaml.NULL">
<em class="property"> </em><code class="descclassname">yaml.</code><code class="descname">NULL</code><a class="headerlink" href="#lua-данные.yaml.NULL" title="Ссылка на это определение">¶</a></dt>
<dd><p>A value comparable to Lua &quot;nil&quot; which may be useful as a placeholder in a tuple.</p>
</dd></dl>

<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Ссылка на этот заголовок">¶</a></h4>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">yaml</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">yaml&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="n">yaml</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span><span class="s1">&#39;</span><span class="s">a&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">b&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">})</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">z</span> <span class="o">=</span> <span class="n">yaml</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">a</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">b</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="k">if</span> <span class="n">yaml</span><span class="p">.</span><span class="n">NULL</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">hi&#39;</span><span class="p">)</span> <span class="k">end</span>
<span class="go">hi</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>The <a class="reference external" href="http://yaml.org/spec/1.1/#id930798">YAML collection style</a> can be
specified with <code class="docutils literal"><span class="pre">__serialize</span></code>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">__serialize=&quot;sequence&quot;</span></code> for a Block Sequence array,</li>
<li><code class="docutils literal"><span class="pre">__serialize=&quot;seq&quot;</span></code> for a Flow Sequence array,</li>
<li><code class="docutils literal"><span class="pre">__serialize=&quot;mapping&quot;</span></code> for a Block Mapping map,</li>
<li><code class="docutils literal"><span class="pre">__serialize=&quot;map&quot;</span></code> for a Flow Mapping map.</li>
</ul>
<p>Serializing 'A' and 'B' with different <code class="docutils literal"><span class="pre">__serialize</span></code> values causes
different results:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">yaml</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">yaml&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">yaml</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">setmetatable</span><span class="p">({</span><span class="s1">&#39;</span><span class="s">A&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">B&#39;</span><span class="p">},</span> <span class="p">{</span> <span class="n">__serialize</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">sequence&quot;</span><span class="p">}))</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
  <span class="no">---</span>
  <span class="no">- A</span>
  <span class="no">- B</span>
  <span class="no">...</span>
<span class="nn">...</span>
<span class="l l-Scalar l-Scalar-Plain">tarantool&gt; yaml.encode(setmetatable({&#39;A&#39;, &#39;B&#39;}, { __serialize=&quot;seq&quot;}))</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
  <span class="no">---</span>
  <span class="no">[&#39;A&#39;, &#39;B&#39;]</span>
  <span class="no">...</span>
<span class="nn">...</span>
<span class="l l-Scalar l-Scalar-Plain">tarantool&gt; yaml.encode({setmetatable({f1 = &#39;A&#39;, f2 = &#39;B&#39;}, { __serialize=&quot;map&quot;})})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
  <span class="no">---</span>
  <span class="no">- {&#39;f2&#39;: &#39;B&#39;, &#39;f1&#39;: &#39;A&#39;}</span>
  <span class="no">...</span>
<span class="nn">...</span>
<span class="l l-Scalar l-Scalar-Plain">tarantool&gt; yaml.encode({setmetatable({f1 = &#39;A&#39;, f2 = &#39;B&#39;}, { __serialize=&quot;mapping&quot;})})</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">|</span>
  <span class="no">---</span>
  <span class="no">- f2: B</span>
    <span class="no">f1: A</span>
  <span class="no">...</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Also, some YAML configuration settings for encoding can be changed, in the
same way that they can be changed for <a class="reference internal" href="singlehtml.html#json-module-cfg"><span class="std std-ref">JSON</span></a>.</p>
</div>
</div>
<span id="document-reference_lua/other"></span><div class="section" id="miscellaneous">
<h3>Разное<a class="headerlink" href="#miscellaneous" title="Ссылка на этот заголовок">¶</a></h3>
<span class="target" id="other-tonumber64"></span><dl class="function">
<dt id="lua-функция.tonumber64">
<em class="property"> </em><code class="descname">tonumber64</code><big>(</big><em>value</em><big>)</big><a class="headerlink" href="#lua-функция.tonumber64" title="Ссылка на это определение">¶</a></dt>
<dd><p>Convert a string or a Lua number to a 64-bit integer. The result can be
used in arithmetic, and the arithmetic will be 64-bit integer arithmetic
rather than floating-point arithmetic. (Operations on an unconverted Lua
number use floating-point arithmetic.) The <code class="docutils literal"><span class="pre">tonumber64()</span></code> function is
added by Tarantool; the name is global.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="nb">type</span><span class="p">(</span><span class="mi">123456789012345</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">tonumber64</span><span class="p">(</span><span class="mi">123456789012345</span><span class="p">))</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">number</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">number</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">tonumber64</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">1000000000&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">^</span> <span class="mi">2</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">number</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">500000000</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">999999998</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">2000000000</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1000000002</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1000000000000000000</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="lua-функция.dostring">
<em class="property"> </em><code class="descname">dostring</code><big>(</big><em>lua-chunk-string</em><span class="optional">[</span>, <em>lua-chunk-string-argument ...</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.dostring" title="Ссылка на это определение">¶</a></dt>
<dd><p>Parse and execute an arbitrary chunk of Lua code. This function is mainly
useful to define and run Lua code without having to introduce changes to
the global Lua environment.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>lua-chunk-string</strong> (<em>string</em>) -- Lua code</li>
<li><strong>lua-chunk-string-argument</strong> (<em>lua-value</em>) -- zero or more scalar values
which will be appended to, or substitute for,
items in the Lua chunk.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">whatever is returned by the Lua code chunk.</p>
</td>
</tr>
</tbody>
</table>
<p>Possible errors: If there is a compilation error, it is raised as a Lua error.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">dostring</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">abc&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">error</span><span class="p p-Indicator">:</span> <span class="s">&#39;[string</span><span class="nv"> </span><span class="s">&quot;abc&quot;]:1:</span><span class="nv"> </span><span class="se">&#39;&#39;</span><span class="s">=</span><span class="se">&#39;&#39;</span><span class="nv"> </span><span class="s">expected</span><span class="nv"> </span><span class="s">near</span><span class="nv"> </span><span class="se">&#39;&#39;</span><span class="s">&lt;eof&gt;</span><span class="se">&#39;&#39;</span><span class="s">&#39;</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">dostring</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">return 1&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">dostring</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">return ...&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">hello&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">world&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hello</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">world</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">dostring</span><span class="p">(</span><span class="s">[[</span>
<span class="gp">         &gt; </span><span class="s">  local f = function(key)</span>
<span class="gp">         &gt; </span><span class="s">    local t = box.space.tester:select{key}</span>
<span class="gp">         &gt; </span><span class="s">    if t ~= nil then</span>
<span class="gp">         &gt; </span><span class="s">      return t[1]</span>
<span class="gp">         &gt; </span><span class="s">    else</span>
<span class="gp">         &gt; </span><span class="s">      return nil</span>
<span class="gp">         &gt; </span><span class="s">    end</span>
<span class="gp">         &gt; </span><span class="s">  end</span>
<span class="gp">         &gt; </span><span class="s">  return f(...)]]</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>
</div>
<span id="document-reference_rock/index"></span><div class="section" id="lua-rocks-reference">
<h2>Справочник по Lua rocks<a class="headerlink" href="#lua-rocks-reference" title="Ссылка на этот заголовок">¶</a></h2>
<p>A module is an optional library which enhances Tarantool functionality.</p>
<p>For examples of creating one's own module with Lua or C, see <a class="reference external" href="https://gist.github.com/rtsisyk/aa95cf9ed9bbb538ff80">this link</a>.</p>
<div class="toctree-wrapper compound" id="list-of-third-party-rocks">
<span id="document-reference_rock/dbms"></span><div class="section" id="sql-dbms-modules">
<span id="dbms-modules"></span><h3>Модули SQL СУБД<a class="headerlink" href="#sql-dbms-modules" title="Ссылка на этот заголовок">¶</a></h3>
<p>The discussion here in the reference is about incorporating and using two
modules that have already been created: the &quot;SQL DBMS rocks&quot; for MySQL and
PostgreSQL.</p>
<p>To call another DBMS from Tarantool, the essential requirements are: another
DBMS, and Tarantool. The module which connects Tarantool to another DBMS may
be called a &quot;connector&quot;. Within the module there is a shared library which
may be called a &quot;driver&quot;.</p>
<p>Tarantool supplies DBMS connector modules with the module manager for Lua,
LuaRocks. So the connector modules may be called &quot;rocks&quot;.</p>
<p>The Tarantool rocks allow for connecting to an SQL server and executing SQL
statements the same way that a MySQL or PostgreSQL client does. The SQL
statements are visible as Lua methods. Thus Tarantool can serve as a &quot;MySQL Lua
Connector&quot; or &quot;PostgreSQL Lua Connector&quot;, which would be useful even if that was
all Tarantool could do. But of course Tarantool is also a DBMS, so the module
also is useful for any operations, such as database copying and accelerating,
which work best when the application can work on both SQL and Tarantool inside
the same Lua routine.
The methods for connect/select/insert/etc. are similar to the ones in the
<a class="reference internal" href="singlehtml.html#net-box-module"><span class="std std-ref">net.box</span></a> module.</p>
<p>From a user's point of view the MySQL and PostgreSQL rocks are very similar, so
the following sections -- &quot;MySQL Example&quot; and &quot;PostgreSQL Example&quot; -- contain
some redundancy.</p>
<div class="section" id="mysql-example">
<span id="dbms-modules-mysql-example"></span><h4>MySQL Example<a class="headerlink" href="#mysql-example" title="Ссылка на этот заголовок">¶</a></h4>
<p>This example assumes that MySQL 5.5 or MySQL 5.6 or MySQL 5.7 has been installed.
Recent MariaDB versions will also work, the MariaDB C connector is used. The
package that matters most is the MySQL client developer package, typically named
something like libmysqlclient-dev. The file that matters most from this package
is libmysqlclient.so or a similar name. One can use <code class="docutils literal"><span class="pre">find</span></code> or <code class="docutils literal"><span class="pre">whereis</span></code> to
see what directories these files are installed in.</p>
<p>It will be necessary to install Tarantool's MySQL driver shared library, load
it, and use it to connect to a MySQL server. After that, one can pass any MySQL
statement to the server and receive results, including multiple result sets.</p>
<div class="section" id="installation">
<h5>Installation<a class="headerlink" href="#installation" title="Ссылка на этот заголовок">¶</a></h5>
<p>Check the instructions for <a class="reference internal" href="singlehtml.html#user-guide-getting-started-downloading-and-installing-a-binary-package"><span class="std std-ref">Downloading and installing a binary package</span></a>
that apply for the environment where tarantool was installed. In addition to
installing <code class="docutils literal"><span class="pre">tarantool</span></code>, install <code class="docutils literal"><span class="pre">tarantool-dev</span></code>. For example, on Ubuntu, add
the line</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo apt-get install tarantool-dev
</pre></div>
</div>
<p>Now, for the MySQL driver shared library, there are two ways to install:</p>
<div class="section" id="with-luarocks">
<h6>With LuaRocks<a class="headerlink" href="#with-luarocks" title="Ссылка на этот заголовок">¶</a></h6>
<p>Begin by installing luarocks and making sure that tarantool is among the
upstream servers, as in the instructions on <a class="reference external" href="http://rocks.tarantool.org/">rocks.tarantool.org</a>, the
Tarantool luarocks page. Now execute this:</p>
<pre class="highlight literal-block">
luarocks install mysql [MYSQL_LIBDIR = <em>path</em>]
                       [MYSQL_INCDIR = <em>path</em>]
                       [--local]
</pre>
<p>For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>luarocks install mysql <span class="nv">MYSQL_LIBDIR</span><span class="o">=</span>/usr/local/mysql/lib
</pre></div>
</div>
<p>See also <a class="reference internal" href="singlehtml.html#modules"><span class="std std-ref">Modules</span></a>.</p>
</div>
<div class="section" id="with-github">
<h6>With GitHub<a class="headerlink" href="#with-github" title="Ссылка на этот заголовок">¶</a></h6>
<p>Go the site <a class="reference external" href="https://github.com/tarantool/mysql">github.com/tarantool/mysql</a>. Follow the instructions there, saying:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>git clone https://github.com/tarantool/mysql.git
<span class="nb">cd</span> mysql <span class="o">&amp;&amp;</span> cmake . -DCMAKE_BUILD_TYPE<span class="o">=</span>RelWithDebInfo
make
make install
</pre></div>
</div>
<p>At this point it is a good idea to check that the installation produced a file
named <code class="docutils literal"><span class="pre">driver.so</span></code>, and to check that this file is on a directory that is
searched by the <code class="docutils literal"><span class="pre">require</span></code> request.</p>
</div>
</div>
<div class="section" id="connecting">
<h5>Connecting<a class="headerlink" href="#connecting" title="Ссылка на этот заголовок">¶</a></h5>
<p>Begin by making a <code class="docutils literal"><span class="pre">require</span></code> request for the mysql driver. We will assume that
the name is <code class="docutils literal"><span class="pre">mysql</span></code> in further examples.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">mysql</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">mysql&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, say:</p>
<pre class="highlight literal-block">
<em>connection_name</em> = mysql.connect(<em>connection options</em>)
</pre>
<p>The connection-options parameter is a table. Possible options are:</p>
<ul class="simple">
<li><code class="samp docutils literal"><span class="pre">host</span> <span class="pre">=</span> <em><span class="pre">host-name</span></em></code> - string, default value = 'localhost'</li>
<li><code class="samp docutils literal"><span class="pre">port</span> <span class="pre">=</span> <em><span class="pre">port-number</span></em></code> - number, default value = 3306</li>
<li><code class="samp docutils literal"><span class="pre">user</span> <span class="pre">=</span> <em><span class="pre">user-name</span></em></code> - string, default value is operating-system user name</li>
<li><code class="samp docutils literal"><span class="pre">password</span> <span class="pre">=</span> <em><span class="pre">password</span></em></code> - string, default value is blank</li>
<li><code class="samp docutils literal"><span class="pre">db</span> <span class="pre">=</span> <em><span class="pre">database-name</span></em></code> - string, default value is blank</li>
<li><code class="samp docutils literal"><span class="pre">raise</span> <span class="pre">=</span> <em><span class="pre">true|false</span></em></code> - boolean, default value is false</li>
</ul>
<p>The option names, except for <cite>raise</cite>, are similar to the names that MySQL's
mysql client uses, for details see the MySQL manual at
<a class="reference external" href="https://dev.mysql.com/doc/refman/5.6/en/connecting.html">dev.mysql.com/doc/refman/5.6/en/connecting.html</a>.
The <cite>raise</cite> option should be set to <span class="ccode">true</span> if errors should be
raised when encountered. To connect with a Unix socket rather than with TCP,
specify <code class="docutils literal"><span class="pre">host</span> <span class="pre">=</span> <span class="pre">'unix/'</span></code> and <code class="samp docutils literal"><span class="pre">port</span> <span class="pre">=</span> <em><span class="pre">socket-name</span></em></code>.</p>
<p>Example, using a table literal enclosed in {braces}:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">conn</span> <span class="o">=</span> <span class="n">mysql</span><span class="p">.</span><span class="n">connect</span><span class="p">({</span>
    <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">127.0.0.1&#39;</span><span class="p">,</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">3306</span><span class="p">,</span>
    <span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">p&#39;</span><span class="p">,</span>
    <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">p&#39;</span><span class="p">,</span>
    <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">test&#39;</span><span class="p">,</span>
    <span class="n">raise</span> <span class="o">=</span> <span class="kc">true</span>
<span class="p">})</span>
<span class="c1">-- OR</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">mysql</span><span class="p">.</span><span class="n">connect</span><span class="p">({</span>
    <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">unix/&#39;</span><span class="p">,</span>
    <span class="n">port</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">/var/run/mysqld/mysqld.sock&#39;</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Example, creating a function which sets each option in a separate line:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="c1">-- Connection function. Usage: conn = mysql_connect()</span>
<span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">mysql_connection</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">p</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">         &gt; </span>  <span class="n">p</span><span class="p">.</span><span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">widgets.com&#39;</span>
<span class="gp">         &gt; </span>  <span class="n">p</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">test&#39;</span>
<span class="gp">         &gt; </span>  <span class="n">conn</span> <span class="o">=</span> <span class="n">mysql</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="n">conn</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">conn</span> <span class="o">=</span> <span class="n">mysql_connect</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>We will assume that the name is 'conn' in further examples.</p>
</div>
<div class="section" id="how-to-ping">
<h5>How to ping<a class="headerlink" href="#how-to-ping" title="Ссылка на этот заголовок">¶</a></h5>
<p>To ensure that a connection is working, the request is:</p>
<pre class="highlight literal-block">
<em>connection-name</em>:ping()
</pre>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">conn</span><span class="p">:</span><span class="n">ping</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="section" id="executing-a-statement">
<h5>Executing a statement<a class="headerlink" href="#executing-a-statement" title="Ссылка на этот заголовок">¶</a></h5>
<p>For all MySQL statements, the request is:</p>
<pre class="highlight literal-block">
<em>connection-name</em>:execute(<em>sql-statement</em> [, <em>parameters</em>])
</pre>
<p>where <code class="docutils literal"><span class="pre">sql-statement</span></code> is a string, and the optional <code class="docutils literal"><span class="pre">parameters</span></code> are extra
values that can be plugged in to replace any question marks (&quot;?&quot;s) in the SQL
statement.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">conn</span><span class="p">:</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">select table_name from information_schema.tables&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">table_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ALL_PLUGINS</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">table_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">APPLICABLE_ROLES</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">table_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">CHARACTER_SETS</span>
  <span class="l l-Scalar l-Scalar-Plain">&lt;...&gt;</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">78</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="section" id="closing-connection">
<h5>Closing connection<a class="headerlink" href="#closing-connection" title="Ссылка на этот заголовок">¶</a></h5>
<p>To end a session that began with <code class="docutils literal"><span class="pre">mysql.connect</span></code>, the request is:</p>
<pre class="highlight literal-block">
<em>connection-name</em>:close()
</pre>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">conn</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>For further information, including examples of rarely-used requests, see the
README.md file at <a class="reference external" href="https://github.com/tarantool/mysql">github.com/tarantool/mysql</a>.</p>
</div>
<div class="section" id="example">
<h5>Example<a class="headerlink" href="#example" title="Ссылка на этот заголовок">¶</a></h5>
<p>The example was run on an Ubuntu 12.04 (&quot;precise&quot;) machine where tarantool had
been installed in a /usr subdirectory, and a copy of MySQL had been installed
on ~/mysql-5.5. The mysqld server is already running on the local host 127.0.0.1.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">export</span> <span class="nv">TMDIR</span><span class="o">=</span>~/mysql-5.5
<span class="gp">$</span> <span class="c1"># Check that the include subdirectory exists by looking</span>
<span class="gp">$</span> <span class="c1"># for .../include/mysql.h. (If this fails, there&#39;s a chance</span>
<span class="gp">$</span> <span class="c1"># that it&#39;s in .../include/mysql/mysql.h instead.)</span>
<span class="gp">$</span> <span class="o">[</span> -f <span class="nv">$TMDIR</span>/include/mysql.h <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;OK&quot;</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;Error&quot;</span>
<span class="go">OK</span>

<span class="gp">$</span> <span class="c1"># Check that the library subdirectory exists and has the</span>
<span class="gp">$</span> <span class="c1"># necessary .so file.</span>
<span class="gp">$</span> <span class="o">[</span> -f <span class="nv">$TMDIR</span>/lib/libmysqlclient.so <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;OK&quot;</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;Error&quot;</span>
<span class="go">OK</span>

<span class="gp">$</span> <span class="c1"># Check that the mysql client can connect using some factory</span>
<span class="gp">$</span> <span class="c1"># defaults: port = 3306, user = &#39;root&#39;, user password = &#39;&#39;,</span>
<span class="gp">$</span> <span class="c1"># database = &#39;test&#39;. These can be changed, provided one uses</span>
<span class="gp">$</span> <span class="c1"># the changed values in all places.</span>
<span class="gp">$</span> <span class="nv">$TMDIR</span>/bin/mysql --port<span class="o">=</span><span class="m">3306</span> -h 127.0.0.1 --user<span class="o">=</span>root <span class="se">\</span>
<span class="go">    --password= --database=test</span>
<span class="go">Welcome to the MySQL monitor.  Commands end with ; or \g.</span>
<span class="go">Your MySQL connection id is 25</span>
<span class="go">Server version: 5.5.35 MySQL Community Server (GPL)</span>
<span class="go">...</span>
<span class="go">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear ...</span>

<span class="gp">$</span> <span class="c1"># Insert a row in database test, and quit.</span>
<span class="go">mysql&gt; CREATE TABLE IF NOT EXISTS test (s1 INT, s2 VARCHAR(50));</span>
<span class="go">Query OK, 0 rows affected (0.13 sec)</span>
<span class="go">mysql&gt; INSERT INTO test.test VALUES (1,&#39;MySQL row&#39;);</span>
<span class="go">Query OK, 1 row affected (0.02 sec)</span>
<span class="go">mysql&gt; QUIT</span>
<span class="go">Bye</span>

<span class="gp">$</span> <span class="c1"># Install luarocks</span>
<span class="gp">$</span> sudo apt-get -y install luarocks <span class="p">|</span> grep -E <span class="s2">&quot;Setting up|already&quot;</span>
<span class="go">Setting up luarocks (2.0.8-2) ...</span>

<span class="gp">$</span> <span class="c1"># Set up the Tarantool rock list in ~/.luarocks,</span>
<span class="gp">$</span> <span class="c1"># following instructions at rocks.tarantool.org</span>
<span class="gp">$</span> mkdir ~/.luarocks
<span class="gp">$</span> <span class="nb">echo</span> <span class="s2">&quot;rocks_servers = {[[http://rocks.tarantool.org/]]}&quot;</span> &gt;&gt; <span class="se">\</span>
<span class="go">    ~/.luarocks/config.lua</span>

<span class="gp">$</span> <span class="c1"># Ensure that the next &quot;install&quot; will get files from Tarantool</span>
<span class="gp">$</span> <span class="c1"># master repository. The resultant display is normal for Ubuntu</span>
<span class="gp">$</span> <span class="c1"># 12.04 precise</span>
<span class="gp">$</span> cat /etc/apt/sources.list.d/tarantool.list
<span class="go">deb http://tarantool.org/dist/1.7/ubuntu/ precise main</span>
<span class="go">deb-src http://tarantool.org/dist/1.7/ubuntu/ precise main</span>

<span class="gp">$</span> <span class="c1"># Install tarantool-dev. The displayed line should show version = 1.6</span>
<span class="gp">$</span> sudo apt-get -y install tarantool-dev <span class="p">|</span> grep -E <span class="s2">&quot;Setting up|already&quot;</span>
<span class="go">Setting up tarantool-dev (1.6.6.222.g48b98bb~precise-1) ...</span>
<span class="gp">$</span>

<span class="gp">$</span> <span class="c1"># Use luarocks to install locally, that is, relative to $HOME</span>
<span class="gp">$</span> luarocks install mysql <span class="nv">MYSQL_LIBDIR</span><span class="o">=</span>/usr/local/mysql/lib --local
<span class="go">Installing http://rocks.tarantool.org/mysql-scm-1.rockspec...</span>
<span class="go">... (more info about building the Tarantool/MySQL driver appears here)</span>
<span class="go">mysql scm-1 is now built and installed in ~/.luarocks/</span>

<span class="gp">$</span> <span class="c1"># Ensure driver.so now has been created in a place</span>
<span class="gp">$</span> <span class="c1"># tarantool will look at</span>
<span class="gp">$</span> find ~/.luarocks -name <span class="s2">&quot;driver.so&quot;</span>
<span class="go">~/.luarocks/lib/lua/5.1/mysql/driver.so</span>

<span class="gp">$</span> <span class="c1"># Change directory to a directory which can be used for</span>
<span class="gp">$</span> <span class="c1"># temporary tests. For this example we assume that the name</span>
<span class="gp">$</span> <span class="c1"># of this directory is /home/pgulutzan/tarantool_sandbox.</span>
<span class="gp">$</span> <span class="c1"># (Change &quot;/home/pgulutzan&quot; to whatever is the user&#39;s actual</span>
<span class="gp">$</span> <span class="c1"># home directory for the machine that&#39;s used for this test.)</span>
<span class="gp">$</span> <span class="nb">cd</span> /home/pgulutzan/tarantool_sandbox

<span class="gp">$</span> <span class="c1"># Start the Tarantool server. Do not use a Lua initialization file.</span>

<span class="gp">$</span> tarantool
<span class="go">tarantool: version 1.7.0-222-g48b98bb</span>
<span class="go">type &#39;help&#39; for interactive help</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
<p>Configure tarantool and load mysql module. Make sure that tarantool doesn't
reply &quot;error&quot; for the call to &quot;require()&quot;.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{}</span>
<span class="go">...</span>
<span class="gp">tarantool&gt; </span><span class="n">mysql</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">mysql&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Create a Lua function that will connect to the MySQL server, (using some factory
default values for the port and user and password), retrieve one row, and
display the row. For explanations of the statement types used here, read the
Lua tutorial earlier in the Tarantool user manual.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">mysql_select</span> <span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">mysql</span><span class="p">.</span><span class="n">connect</span><span class="p">({</span>
<span class="gp">         &gt; </span>    <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">127.0.0.1&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>    <span class="n">port</span> <span class="o">=</span> <span class="mi">3306</span><span class="p">,</span>
<span class="gp">         &gt; </span>    <span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">root&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>    <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">test&#39;</span>
<span class="gp">         &gt; </span>  <span class="p">})</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">test</span> <span class="o">=</span> <span class="n">conn</span><span class="p">:</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">SELECT * FROM test WHERE s1 = 1&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">row</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">&#39;</span>
<span class="gp">         &gt; </span>  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="k">do</span>
<span class="gp">         &gt; </span>      <span class="n">row</span> <span class="o">=</span> <span class="n">row</span> <span class="o">..</span> <span class="n">card</span><span class="p">.</span><span class="n">s2</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> &#39;</span>
<span class="gp">         &gt; </span>      <span class="k">end</span>
<span class="gp">         &gt; </span>  <span class="n">conn</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="n">row</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">mysql_select</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;MySQL</span><span class="nv"> </span><span class="s">row</span><span class="nv"> </span><span class="s">&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Observe the result. It contains &quot;MySQL row&quot;. So this is the row that was inserted
into the MySQL database. And now it's been selected with the Tarantool client.</p>
</div>
</div>
<div class="section" id="postgresql-example">
<span id="dbms-modules-postgresql-example"></span><h4>PostgreSQL Example<a class="headerlink" href="#postgresql-example" title="Ссылка на этот заголовок">¶</a></h4>
<p>This example assumes that PostgreSQL 8 or PostgreSQL 9 has been installed. More
recent versions should also work. The package that matters most is the
PostgreSQL developer package, typically named something like libpq-dev. On
Ubuntu this can be installed with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo apt-get install libpq-dev
</pre></div>
</div>
<p>However, because not all platforms are alike, for this example the assumption
is that the user must check that the appropriate PostgreSQL files are present
and must explicitly state where they are when building the Tarantool/PostgreSQL
driver. One can use <code class="docutils literal"><span class="pre">find</span></code> or <code class="docutils literal"><span class="pre">whereis</span></code> to see what directories
PostgreSQL files are installed in.</p>
<p>It will be necessary to install Tarantool's PostgreSQL driver shared library,
load it, and use it to connect to a PostgreSQL server. After that, one can pass
any PostgreSQL statement to the server and receive results.</p>
<div class="section" id="id1">
<h5>Installation<a class="headerlink" href="#id1" title="Ссылка на этот заголовок">¶</a></h5>
<p>Check the instructions for
<a class="reference internal" href="singlehtml.html#user-guide-getting-started-downloading-and-installing-a-binary-package"><span class="std std-ref">Downloading and installing a binary package</span></a>
that apply for the environment where tarantool was installed. In addition to
installing <code class="docutils literal"><span class="pre">tarantool</span></code>, install <code class="docutils literal"><span class="pre">tarantool-dev</span></code>. For example, on Ubuntu, add
the line:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo apt-get install tarantool-dev
</pre></div>
</div>
<p>Now, for the PostgreSQL driver shared library, there are two ways to install:</p>
<div class="section" id="id2">
<h6>With LuaRocks<a class="headerlink" href="#id2" title="Ссылка на этот заголовок">¶</a></h6>
<p>Begin by installing luarocks and making sure that tarantool is among the upstream
servers, as in the instructions on <a class="reference external" href="http://rocks.tarantool.org/">rocks.tarantool.org</a>, the Tarantool luarocks
page. Now execute this:</p>
<pre class="highlight literal-block">
luarocks install pg [POSTGRESQL_LIBDIR = <em>path</em>]
                    [POSTGRESQL_INCDIR = <em>path</em>]
                    [--local]
</pre>
<p>For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>luarocks install pg <span class="nv">POSTGRESQL_LIBDIR</span><span class="o">=</span>/usr/local/postgresql/lib
</pre></div>
</div>
<p>See also <a class="reference internal" href="singlehtml.html#modules"><span class="std std-ref">Modules</span></a>.</p>
</div>
<div class="section" id="id3">
<h6>With GitHub<a class="headerlink" href="#id3" title="Ссылка на этот заголовок">¶</a></h6>
<p>Go the site <a class="reference external" href="https://github.com/tarantool/pg">github.com/tarantool/pg</a>. Follow the instructions there, saying:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>git clone https://github.com/tarantool/pg.git
<span class="nb">cd</span> pg <span class="o">&amp;&amp;</span> cmake . -DCMAKE_BUILD_TYPE<span class="o">=</span>RelWithDebInfo
make
make install
</pre></div>
</div>
<p>At this point it is a good idea to check that the installation produced a file
named <code class="docutils literal"><span class="pre">driver.so</span></code>, and to check that this file is on a directory that is
searched by the <code class="docutils literal"><span class="pre">require</span></code> request.</p>
</div>
</div>
<div class="section" id="id4">
<h5>Connecting<a class="headerlink" href="#id4" title="Ссылка на этот заголовок">¶</a></h5>
<p>Begin by making a <code class="docutils literal"><span class="pre">require</span></code> request for the pg driver. We will assume that the
name is <code class="docutils literal"><span class="pre">pg</span></code> in further examples.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">pg</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">pg&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, say:</p>
<pre class="highlight literal-block">
<em>connection_name</em> = pg.connect(<em>connection options</em>)
</pre>
<p>The connection-options parameter is a table. Possible options are:</p>
<ul class="simple">
<li><code class="samp docutils literal"><span class="pre">host</span> <span class="pre">=</span> <em><span class="pre">host-name</span></em></code> - string, default value = 'localhost'</li>
<li><code class="samp docutils literal"><span class="pre">port</span> <span class="pre">=</span> <em><span class="pre">port-number</span></em></code> - number, default value = 3306</li>
<li><code class="samp docutils literal"><span class="pre">user</span> <span class="pre">=</span> <em><span class="pre">user-name</span></em></code> - string, default value is operating-system user name</li>
<li><code class="samp docutils literal"><span class="pre">pass</span> <span class="pre">=</span> <em><span class="pre">password</span></em></code> or <code class="samp docutils literal"><span class="pre">password</span> <span class="pre">=</span> <em><span class="pre">password</span></em></code> - string, default value is blank</li>
<li><code class="samp docutils literal"><span class="pre">db</span> <span class="pre">=</span> <em><span class="pre">database-name</span></em></code> - string, default value is blank</li>
</ul>
<p>The names are similar to the names that PostgreSQL itself uses.</p>
<p>Example, using a table literal enclosed in {braces}:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">conn</span> <span class="o">=</span> <span class="n">pg</span><span class="p">.</span><span class="n">connect</span><span class="p">({</span>
    <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">127.0.0.1&#39;</span><span class="p">,</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
    <span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">p&#39;</span><span class="p">,</span>
    <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">p&#39;</span><span class="p">,</span>
    <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">test&#39;</span>
<span class="p">})</span>
</pre></div>
</div>
<p>Example, creating a function which sets each option in a separate line:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">pg_connect</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">p</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">         &gt; </span>  <span class="n">p</span><span class="p">.</span><span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">widgets.com&#39;</span>
<span class="gp">         &gt; </span>  <span class="n">p</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">test&#39;</span>
<span class="gp">         &gt; </span>  <span class="n">p</span><span class="p">.</span><span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">postgres&#39;</span>
<span class="gp">         &gt; </span>  <span class="n">p</span><span class="p">.</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">postgres&#39;</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">pg</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="n">conn</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">conn</span> <span class="o">=</span> <span class="n">pg_connect</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>We will assume that the name is 'conn' in further examples.</p>
</div>
<div class="section" id="id5">
<h5>How to ping<a class="headerlink" href="#id5" title="Ссылка на этот заголовок">¶</a></h5>
<p>To ensure that a connection is working, the request is:</p>
<pre class="highlight literal-block">
<em>connection-name</em>:ping()
</pre>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">conn</span><span class="p">:</span><span class="n">ping</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h5>Executing a statement<a class="headerlink" href="#id6" title="Ссылка на этот заголовок">¶</a></h5>
<p>For all PostgreSQL statements, the request is:</p>
<pre class="highlight literal-block">
<em>connection-name</em>:execute(<em>sql-statement</em> [, <em>parameters</em>])
</pre>
<p>where <code class="docutils literal"><span class="pre">sql-statement</span></code> is a string, and the optional <code class="docutils literal"><span class="pre">parameters</span></code>
are extra values that can be plugged in to replace any question marks (&quot;?&quot;s)
in the SQL statement.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">conn</span><span class="p">:</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">select tablename from pg_tables&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tablename</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">pg_statistic</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tablename</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">pg_type</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tablename</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">pg_authid</span>
  <span class="l l-Scalar l-Scalar-Plain">&lt;...&gt;</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h5>Closing connection<a class="headerlink" href="#id7" title="Ссылка на этот заголовок">¶</a></h5>
<p>To end a session that began with <code class="docutils literal"><span class="pre">pg.connect</span></code>, the request is:</p>
<pre class="highlight literal-block">
<em>connection-name</em>:close()
</pre>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">conn</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>For further information, including examples of rarely-used requests, see the
README.md file at <a class="reference external" href="https://github.com/tarantool/pg">github.com/tarantool/pg</a>.</p>
</div>
<div class="section" id="id8">
<h5>Example<a class="headerlink" href="#id8" title="Ссылка на этот заголовок">¶</a></h5>
<p>The example was run on an Ubuntu 12.04 (&quot;precise&quot;) machine where tarantool had
been installed in a /usr subdirectory, and a copy of PostgreSQL had been installed
on /usr. The PostgreSQL server is already running on the local host 127.0.0.1.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="c1"># Check that the include subdirectory exists</span>
<span class="gp">$</span> <span class="c1"># by looking for /usr/include/postgresql/libpq-fe-h.</span>
<span class="gp">$</span> <span class="o">[</span> -f /usr/include/postgresql/libpq-fe.h <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;OK&quot;</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;Error&quot;</span>
<span class="go">OK</span>

<span class="gp">$</span> <span class="c1"># Check that the library subdirectory exists and has the necessary .so file.</span>
<span class="gp">$</span> <span class="o">[</span> -f /usr/lib/x86_64-linux-gnu/libpq.so <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;OK&quot;</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&quot;Error&quot;</span>
<span class="go">OK</span>

<span class="gp">$</span> <span class="c1"># Check that the psql client can connect using some factory defaults:</span>
<span class="gp">$</span> <span class="c1"># port = 5432, user = &#39;postgres&#39;, user password = &#39;postgres&#39;,</span>
<span class="gp">$</span> <span class="c1"># database = &#39;postgres&#39;. These can be changed, provided one changes</span>
<span class="gp">$</span> <span class="c1"># them in all places. Insert a row in database postgres, and quit.</span>
<span class="gp">$</span> psql -h 127.0.0.1 -p <span class="m">5432</span> -U postgres -d postgres
<span class="go">Password for user postgres:</span>
<span class="go">psql (9.3.10)</span>
<span class="go">SSL connection (cipher: DHE-RSA-AES256-SHA, bits: 256)</span>
<span class="go">Type &quot;help&quot; for help.</span>

<span class="go">postgres=# CREATE TABLE test (s1 INT, s2 VARCHAR(50));</span>
<span class="go">CREATE TABLE</span>
<span class="go">postgres=# INSERT INTO test VALUES (1,&#39;PostgreSQL row&#39;);</span>
<span class="go">INSERT 0 1</span>
<span class="go">postgres=# \q</span>
<span class="gp">$</span>

<span class="gp">$</span> <span class="c1"># Install luarocks</span>
<span class="gp">$</span> sudo apt-get -y install luarocks <span class="p">|</span> grep -E <span class="s2">&quot;Setting up|already&quot;</span>
<span class="go">Setting up luarocks (2.0.8-2) ...</span>

<span class="gp">$</span> <span class="c1"># Set up the Tarantool rock list in ~/.luarocks,</span>
<span class="gp">$</span> <span class="c1"># following instructions at rocks.tarantool.org</span>
<span class="gp">$</span> mkdir ~/.luarocks
<span class="gp">$</span> <span class="nb">echo</span> <span class="s2">&quot;rocks_servers = {[[http://rocks.tarantool.org/]]}&quot;</span> &gt;&gt; <span class="se">\</span>
<span class="go">        ~/.luarocks/config.lua</span>

<span class="gp">$</span> <span class="c1"># Ensure that the next &quot;install&quot; will get files from Tarantool master</span>
<span class="gp">$</span> <span class="c1"># repository. The resultant display is normal for Ubuntu 12.04 precise</span>
<span class="gp">$</span> cat /etc/apt/sources.list.d/tarantool.list
<span class="go">deb http://tarantool.org/dist/1.7/ubuntu/ precise main</span>
<span class="go">deb-src http://tarantool.org/dist/1.7/ubuntu/ precise main</span>

<span class="gp">$</span> <span class="c1"># Install tarantool-dev. The displayed line should show version = 1.7</span>
<span class="gp">$</span> sudo apt-get -y install tarantool-dev <span class="p">|</span> grep -E <span class="s2">&quot;Setting up|already&quot;</span>
<span class="go">Setting up tarantool-dev (1.7.0.222.g48b98bb~precise-1) ...</span>
<span class="gp">$</span>

<span class="gp">$</span> <span class="c1"># Use luarocks to install locally, that is, relative to $HOME</span>
<span class="gp">$</span> luarocks install pg <span class="nv">POSTGRESQL_LIBDIR</span><span class="o">=</span>/usr/lib/x86_64-linux-gnu --local
<span class="go">Installing http://rocks.tarantool.org/pg-scm-1.rockspec...</span>
<span class="go">... (more info about building the Tarantool/PostgreSQL driver appears here)</span>
<span class="go">pg scm-1 is now built and installed in ~/.luarocks/</span>

<span class="gp">$</span> <span class="c1"># Ensure driver.so now has been created in a place</span>
<span class="gp">$</span> <span class="c1"># tarantool will look at</span>
<span class="gp">$</span> find ~/.luarocks -name <span class="s2">&quot;driver.so&quot;</span>
<span class="go">~/.luarocks/lib/lua/5.1/pg/driver.so</span>

<span class="gp">$</span> <span class="c1"># Change directory to a directory which can be used for</span>
<span class="gp">$</span> <span class="c1"># temporary tests. For this example we assume that the</span>
<span class="gp">$</span> <span class="c1"># name of this directory is $HOME/tarantool_sandbox.</span>
<span class="gp">$</span> <span class="c1"># (Change &quot;$HOME&quot; to whatever is the user&#39;s actual</span>
<span class="gp">$</span> <span class="c1"># home directory for the machine that&#39;s used for this test.)</span>
<span class="go">cd $HOME/tarantool_sandbox</span>

<span class="gp">$</span> <span class="c1"># Start the Tarantool server. Do not use a Lua initialization file.</span>

<span class="gp">$</span> tarantool
<span class="go">tarantool: version 1.7.0-412-g803b15c</span>
<span class="go">type &#39;help&#39; for interactive help</span>
<span class="go">tarantool&gt;</span>
</pre></div>
</div>
<p>Configure tarantool and load pg module. Make sure that tarantool doesn't
reply &quot;error&quot; for the call to &quot;require()&quot;.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{}</span>
<span class="go">...</span>
<span class="gp">tarantool&gt; </span><span class="n">pg</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">pg&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Create a Lua function that will connect to the PostgreSQL server, (using some
factory default values for the port and user and password), retrieve one row,
and display the row. For explanations of the statement types used here, read the
Lua tutorial earlier in the Tarantool user manual.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">pg_select</span> <span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">pg</span><span class="p">.</span><span class="n">connect</span><span class="p">({</span>
<span class="gp">         &gt; </span>    <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">127.0.0.1&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>    <span class="n">port</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">,</span>
<span class="gp">         &gt; </span>    <span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">postgres&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>    <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">postgres&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>    <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">postgres&#39;</span>
<span class="gp">         &gt; </span>  <span class="p">})</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">test</span> <span class="o">=</span> <span class="n">conn</span><span class="p">:</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">SELECT * FROM test WHERE s1 = 1&#39;</span><span class="p">)</span>
<span class="gp">         &gt; </span>  <span class="kd">local</span> <span class="n">row</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">&#39;</span>
<span class="gp">         &gt; </span>  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="k">do</span>
<span class="gp">         &gt; </span>      <span class="n">row</span> <span class="o">=</span> <span class="n">row</span> <span class="o">..</span> <span class="n">card</span><span class="p">.</span><span class="n">s2</span> <span class="o">..</span> <span class="s1">&#39;</span><span class="s"> &#39;</span>
<span class="gp">         &gt; </span>      <span class="k">end</span>
<span class="gp">         &gt; </span>  <span class="n">conn</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="k">return</span> <span class="n">row</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">pg_select</span><span class="p">()</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;PostgreSQL</span><span class="nv"> </span><span class="s">row</span><span class="nv"> </span><span class="s">&#39;</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Observe the result. It contains &quot;PostgreSQL row&quot;. So this is the row that was
inserted into the PostgreSQL database. And now it's been selected with the
Tarantool client.</p>
</div>
</div>
</div>
<span id="document-reference_rock/expirationd"></span><div class="section" id="module-expirationd">
<span id="expirationd-module"></span><h3>Модуль <cite>expirationd</cite><a class="headerlink" href="#module-expirationd" title="Ссылка на этот заголовок">¶</a></h3>
<p>For a commercial-grade example of a Lua rock that works with Tarantool, let us
look at expirationd, which Tarantool supplies on <a class="reference external" href="https://github.com/tarantool/expirationd/blob/master/expirationd.lua">GitHub</a> with an Artistic license.
The expirationd.lua program is lengthy (about 500 lines), so here we will only
highlight the matters that will be enhanced by studying the full source later.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">task</span><span class="p">.</span><span class="n">worker_fiber</span> <span class="o">=</span> <span class="n">fiber</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">worker_loop</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">expiration: task %q restarted&quot;</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">fiber</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">expirationd</span><span class="p">.</span><span class="n">constants</span><span class="p">.</span><span class="n">check_interval</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Whenever one hears &quot;daemon&quot; in Tarantool, one should suspect it's being done
with a <a class="reference internal" href="singlehtml.html#document-reference_lua/fiber"><span class="doc">fiber</span></a>. The program is making a fiber and
turning control over to it so it runs occasionally, goes to sleep, then comes
back for more.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tuple</span> <span class="k">in</span> <span class="n">scan_space</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="nb">pairs</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">ALL</span><span class="p">})</span> <span class="k">do</span>
<span class="o">...</span>
        <span class="k">if</span> <span class="n">task</span><span class="p">.</span><span class="n">is_tuple_expired</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">tuple</span><span class="p">)</span> <span class="k">then</span>
        <span class="n">task</span><span class="p">.</span><span class="n">expired_tuples_count</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">expired_tuples_count</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">task</span><span class="p">.</span><span class="n">process_expired_tuple</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">space_id</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">tuple</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>The &quot;for&quot; instruction can be translated as &quot;iterate through the index of the
space that is being scanned&quot;, and within it, if the tuple is &quot;expired&quot; (for
example, if the tuple has a timestamp field which is less than the current time),
process the tuple as an expired tuple.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="c1">-- default process_expired_tuple function</span>
<span class="kd">local</span> <span class="k">function</span> <span class="nf">default_tuple_drop</span><span class="p">(</span><span class="n">space_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">tuple</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">key</span> <span class="o">=</span> <span class="n">fun</span><span class="p">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">return</span> <span class="n">tuple</span><span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="n">fieldno</span><span class="p">]</span> <span class="k">end</span><span class="p">,</span>
        <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_id</span><span class="p">].</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">parts</span>
    <span class="p">):</span><span class="n">totable</span><span class="p">()</span>
    <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_id</span><span class="p">]:</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Ultimately the tuple-expiry process leads to <code class="docutils literal"><span class="pre">default_tuple_drop()</span></code>
which does a &quot;delete&quot; of a tuple from its original space.
First the fun <a class="reference internal" href="singlehtml.html#fun-module"><span class="std std-ref">fun</span></a> module is used,
specifically <a class="reference external" href="http://rtsisyk.github.io/luafun/transformations.html#fun.map">fun.map</a>.
Remembering that <span class="ccode">index[0]</span> is always the space's primary key,
and <span class="ccode">index[0].parts[</span><span class="ccodei">N</span><span class="ccode">].fieldno</span>
is always the field number for key part <span class="ccodei">N</span>,
fun.map() is creating a table from the primary-key values of the tuple.
The result of fun.map() is passed to <a class="reference internal" href="singlehtml.html#box-space-delete"><span class="std std-ref">space_object:delete()</span></a>.</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="kd">local</span> <span class="k">function</span> <span class="nf">expirationd_run_task</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">space_id</span><span class="p">,</span> <span class="n">is_tuple_expired</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>At this point, if the above explanation is worthwhile, it's clear that
<code class="docutils literal"><span class="pre">expirationd.lua</span></code> starts a background routine (fiber) which iterates through
all the tuples in a space, sleeps cooperatively so that other fibers can
operate at the same time, and - whenever it finds a tuple that has expired
- deletes it from this space. Now the
&quot;<code class="docutils literal"><span class="pre">expirationd_run_task()</span></code>&quot; function can be used
in a test which creates sample data, lets the
daemon run for a while, and prints results.</p>
<p>For those who like to see things run, here are the exact steps to get
expirationd through the test.</p>
<ol class="arabic simple">
<li>Get <code class="docutils literal"><span class="pre">expirationd.lua</span></code>. There are standard ways - it is after all part
of a <a class="reference external" href="https://luarocks.org/modules/rtsisyk/expirationd">standard rock</a>  - but for this purpose just copy the contents of
<a class="reference external" href="https://github.com/tarantool/expirationd/blob/master/expirationd.lua">expirationd.lua</a> to a default directory.</li>
<li>Start the Tarantool server as described before.</li>
<li>Execute these requests:</li>
</ol>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">fiber</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">fiber&#39;</span><span class="p">)</span>
<span class="n">expd</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">expirationd&#39;</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{}</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">expirationd_test&#39;</span><span class="p">)</span>
<span class="n">e</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">hash&#39;</span><span class="p">,</span> <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">unsigned&#39;</span><span class="p">}})</span>
<span class="n">e</span><span class="p">:</span><span class="n">replace</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="n">fiber</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">3</span><span class="p">}</span>
<span class="n">e</span><span class="p">:</span><span class="n">replace</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="n">fiber</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">30</span><span class="p">}</span>
<span class="k">function</span> <span class="nf">is_tuple_expired</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">tuple</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">fiber</span><span class="p">.</span><span class="n">time</span><span class="p">())</span> <span class="k">then</span> <span class="k">return</span> <span class="kc">true</span> <span class="k">end</span>
  <span class="k">return</span> <span class="kc">false</span>
  <span class="k">end</span>
<span class="n">expd</span><span class="p">.</span><span class="n">run_task</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">expirationd_test&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">is_tuple_expired</span><span class="p">)</span>
<span class="n">retval</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">fiber</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">expd</span><span class="p">.</span><span class="n">task_stats</span><span class="p">()</span>
<span class="n">fiber</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">expd</span><span class="p">.</span><span class="n">task_stats</span><span class="p">()</span>
<span class="n">expd</span><span class="p">.</span><span class="n">kill_task</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">expirationd_test&#39;</span><span class="p">)</span>
<span class="n">e</span><span class="p">:</span><span class="n">drop</span><span class="p">()</span>
<span class="nb">os.exit</span><span class="p">()</span>
</pre></div>
</div>
<p>The database-specific requests (<code class="docutils literal"><span class="pre">cfg</span></code>,
<a class="reference internal" href="singlehtml.html#box-schema-space-create"><span class="std std-ref">space.create</span></a>,
<a class="reference internal" href="singlehtml.html#box-space-create-index"><span class="std std-ref">create_index</span></a>)
should already be familiar.</p>
<p>The function which will be supplied to expirationd is
<span class="ccode">is_tuple_expired</span>, which is saying
&quot;if the second field of the tuple is less than the
<a class="reference internal" href="singlehtml.html#fiber-time"><span class="std std-ref">current time</span></a>  , then return true, otherwise return false&quot;.</p>
<p>The key for getting the rock rolling is
<code class="docutils literal"><span class="pre">expd</span> <span class="pre">=</span> <span class="pre">require('expirationd')</span></code>. The &quot;<code class="docutils literal"><span class="pre">require</span></code>&quot; function is what reads in
the program; it will appear in many later examples in this manual, when it's
necessary to get a module that's not part of the Tarantool kernel. After the
Lua variable expd has been assigned the value of the expirationd module, it's
possible to invoke the module's <code class="docutils literal"><span class="pre">run_task()</span></code> function.</p>
<p>After <a class="reference internal" href="singlehtml.html#fiber-sleep"><span class="std std-ref">sleeping</span></a> for two seconds, when the task has had time to do its iterations through the spaces,
<code class="docutils literal"><span class="pre">expd.task_stats()</span></code> will print out a report showing how many tuples have expired --
&quot;expired_count: 0&quot;.
After sleeping for two more seconds, <code class="docutils literal"><span class="pre">expd.task_stats()</span></code> will print out a report showing
how many tuples have expired --
&quot;expired_count: 1&quot;.
This shows that the is_tuple_expired() function eventually returned &quot;true&quot;
for one of the tuples, because its timestamp field was more than
three seconds old.</p>
<p>Of course, expirationd can be customized to do different things
by passing different parameters, which will be evident after looking in more detail
at the source code.</p>
</div>
<span id="document-reference_rock/shard"></span><div class="section" id="lua-module.shard">
<span id="module-shard"></span><span id="shard-module"></span><h3>Модуль <cite>shard</cite><a class="headerlink" href="#lua-module.shard" title="Ссылка на этот заголовок">¶</a></h3>
<p>With sharding, the tuples of a tuple set are distributed to multiple nodes,
with a Tarantool database server on each node. With this arrangement,
each server is handling only a subset of the total data,
so larger loads can be handled by simply adding more computers to a network.</p>
<p>The Tarantool shard module has facilities for creating shards,
as well as analogues for the data-manipulation functions of the box library
(select, insert, replace, update, delete).</p>
<p>First some terminology:</p>
<dl class="glossary docutils">
<dt id="term-consistent-hash"><strong>Consistent Hash</strong></dt>
<dd>The shard module distributes according to a hash algorithm, that is,
it applies a hash function to a tuple's primary-key value in order to
decide which shard the tuple belongs to. The hash function is <a class="reference external" href="https://en.wikipedia.org/wiki/Consistent_hashing">consistent</a>
so that changing the number of servers will not affect results for many
keys. The specific hash function that the shard module uses is
<a class="reference internal" href="singlehtml.html#digest-guava"><span class="std std-ref">digest.guava</span></a> in the <span class="ccodei">digest</span> module.</dd>
<dt id="term-queue"><strong>Queue</strong></dt>
<dd>A temporary list of recent update requests. Sometimes called &quot;batching&quot;.
Since updates to a sharded database can be slow, it may speed up
throughput to send requests to a queue rather than wait for the update
to finish on ever node. The shard module has functions for adding
requests to the queue, which it will process without further intervention.
Queuing is optional.</dd>
<dt id="term-redundancy"><strong>Redundancy</strong></dt>
<dd>The number of replicas in each shard.</dd>
<dt id="term-replica"><strong>Replica</strong></dt>
<dd>A complete copy of the data. The shard module handles both sharding
and replication. One shard can contain one or more replicas.
When a write occurs, the write is attempted on every replica in turn.
The shard module does not use the built-in replication feature.</dd>
<dt id="term-shard"><strong>Shard</strong></dt>
<dd>A subset of the tuples in the database partitioned according to the
value returned by the consistent hash function. Usually each shard
is on a separate node, or a separate set of nodes (for example if
redundancy = 3 then the shard will be on three nodes).</dd>
<dt id="term-zone"><strong>Zone</strong></dt>
<dd>A physical location where the nodes are closely connected, with
the same security and backup and access points. The simplest example
of a zone is a single computer with a single tarantool-server instance.
A shard's replicas should be in different zones.</dd>
</dl>
<p>The shard package is distributed separately from the main tarantool package.
To acquire it, do a separate install. For example on Ubuntu say:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo apt-get install tarantool-shard tarantool-pool
</pre></div>
</div>
<p>Or, download from github tarantool/shard and compile as described in the README.
Then, before using the module, say <code class="docutils literal"><span class="pre">shard</span> <span class="pre">=</span> <span class="pre">require('shard')</span></code></p>
<p>The most important function is:</p>
<pre class="highlight literal-block">
shard.init(<em>shard-configuration</em>)
</pre>
<p>This must be called for every shard.
The shard-configuration is a table with these fields:</p>
<ul class="simple">
<li>servers (a list of URIs of nodes and the zones the nodes are in)</li>
<li>login (the user name which applies for accessing via the shard module)</li>
<li>password (the password for the login)</li>
<li>redundancy (a number, minimum 1)</li>
<li>binary (a port number that this host is listening on, on the current host)
(distinguishable from the 'listen' port specified by box.cfg)</li>
</ul>
<p>Possible Errors: Redundancy should not be greater than the number of servers;
the servers must be alive; two replicas of the same shard should not be in the
same zone.</p>
<div class="section" id="example-shard-init-syntax-for-one-shard">
<h4>Example: shard.init syntax for one shard<a class="headerlink" href="#example-shard-init-syntax-for-one-shard" title="Ссылка на этот заголовок">¶</a></h4>
<p>The number of replicas per shard (redundancy) is 3.
The number of servers is 3.
The shard module will conclude that there is only one shard.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">servers</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">         &gt; </span>    <span class="p">{</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">localhost:33131&#39;</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">1&#39;</span> <span class="p">},</span>
<span class="gp">         &gt; </span>    <span class="p">{</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">localhost:33132&#39;</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">2&#39;</span> <span class="p">},</span>
<span class="gp">         &gt; </span>    <span class="p">{</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">localhost:33133&#39;</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">3&#39;</span> <span class="p">}</span>
<span class="gp">         &gt; </span>  <span class="p">},</span>
<span class="gp">         &gt; </span>  <span class="n">login</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">pass&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">redundancy</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">3&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">binary</span> <span class="o">=</span> <span class="mi">33131</span><span class="p">,</span>
<span class="gp">         &gt; </span><span class="p">}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">shard</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="section" id="example-shard-init-syntax-for-three-shards">
<h4>Example: shard.init syntax for three shards<a class="headerlink" href="#example-shard-init-syntax-for-three-shards" title="Ссылка на этот заголовок">¶</a></h4>
<p>This describes three shards. Each shard has two replicas. Since the number of
servers is 7, and the number of replicas per shard is 2, and dividing 7 / 2
leaves a remainder of 1, one of the servers will not be used. This is not
necessarily an error, because perhaps one of the servers in the list is not alive.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">servers</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">         &gt; </span>    <span class="p">{</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">host1:33131&#39;</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">1&#39;</span> <span class="p">},</span>
<span class="gp">         &gt; </span>    <span class="p">{</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">host2:33131&#39;</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">2&#39;</span> <span class="p">},</span>
<span class="gp">         &gt; </span>    <span class="p">{</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">host3:33131&#39;</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">3&#39;</span> <span class="p">},</span>
<span class="gp">         &gt; </span>    <span class="p">{</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">host4:33131&#39;</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">4&#39;</span> <span class="p">},</span>
<span class="gp">         &gt; </span>    <span class="p">{</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">host5:33131&#39;</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">5&#39;</span> <span class="p">},</span>
<span class="gp">         &gt; </span>    <span class="p">{</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">host6:33131&#39;</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">6&#39;</span> <span class="p">},</span>
<span class="gp">         &gt; </span>    <span class="p">{</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">host7:33131&#39;</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">7&#39;</span> <span class="p">}</span>
<span class="gp">         &gt; </span>  <span class="p">},</span>
<span class="gp">         &gt; </span>  <span class="n">login</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">pass&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">redundancy</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">2&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">binary</span> <span class="o">=</span> <span class="mi">33131</span><span class="p">,</span>
<span class="gp">         &gt; </span><span class="p">}</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">shard</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<pre class="highlight literal-block">
shard[<em>space-name</em>].insert{...}
shard[<em>space-name</em>].replace{...}
shard[<em>space-name</em>].delete{...}
shard[<em>space-name</em>].select{...}
shard[<em>space-name</em>].update{...}
shard[<em>space-name</em>].auto_increment{...}
</pre>
<p>Every data-access function in the box module has an analogue in the shard
module, so (for example) to insert in table T in a sharded database one simply
says <code class="docutils literal"><span class="pre">shard.T:insert{...}</span></code> instead of <code class="docutils literal"><span class="pre">box.space.T:insert{...}</span></code>.
A <code class="docutils literal"><span class="pre">shard.T:select{}</span></code> request without a primary key will search all shards.</p>
<pre class="highlight literal-block">
shard[<em>space-name</em>].q_insert{...}
shard[<em>space-name</em>].q_replace{...}
shard[<em>space-name</em>].q_delete{...}
shard[<em>space-name</em>].q_select{...}
shard[<em>space-name</em>].q_update{...}
shard[<em>space-name</em>].q_auto_increment{...}
</pre>
<p>Every queued data-access function has an analogue in the shard module. The user
must add an operation_id. The details of queued data-access functions, and of
maintenance-related functions, are on <a class="reference external" href="https://github.com/tarantool/shard">the shard section of github</a>.</p>
</div>
<div class="section" id="example-shard-minimal-configuration">
<h4>Example: Shard, Minimal Configuration<a class="headerlink" href="#example-shard-minimal-configuration" title="Ссылка на этот заголовок">¶</a></h4>
<p>There is only one shard, and that shard contains only one replica. So this isn't
illustrating the features of either replication or sharding, it's only
illustrating what the syntax is, and what the messages look like, that anyone
could duplicate in a minute or two with the magic of cut-and-paste.</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">$</span> mkdir ~/tarantool_sandbox_1
<span class="gp">$</span> <span class="nb">cd</span> ~/tarantool_sandbox_1
<span class="gp">$</span> rm -r *.snap
<span class="gp">$</span> rm -r *.xlog
<span class="gp">$</span> ~/tarantool-1.7/src/tarantool

<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span> <span class="o">=</span> <span class="mi">3301</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">passwd</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">admin&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">password&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">servers</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">         &gt; </span>      <span class="p">{</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">localhost:3301&#39;</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">1&#39;</span> <span class="p">},</span>
<span class="gp">         &gt; </span>  <span class="p">},</span>
<span class="gp">         &gt; </span>  <span class="n">login</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">admin&#39;</span><span class="p">;</span>
<span class="gp">         &gt; </span>  <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">password&#39;</span><span class="p">;</span>
<span class="gp">         &gt; </span>  <span class="n">redundancy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="gp">         &gt; </span>  <span class="n">binary</span> <span class="o">=</span> <span class="mi">3301</span><span class="p">;</span>
<span class="gp">         &gt; </span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">shard</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">shard&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">shard</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="c1">-- Now put something in ...</span>
<span class="gp">tarantool&gt; </span><span class="n">shard</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">Tuple #1&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>If one cuts and pastes the above, then the result,
showing only the requests and responses for shard.init
and shard.tester, should look approximately like this:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">shard</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="go">2015-08-09 ... I&gt; Sharding initialization started...</span>
<span class="go">2015-08-09 ... I&gt; establishing connection to cluster servers...</span>
<span class="go">2015-08-09 ... I&gt;  - localhost:3301 - connecting...</span>
<span class="go">2015-08-09 ... I&gt;  - localhost:3301 - connected</span>
<span class="go">2015-08-09 ... I&gt; connected to all servers</span>
<span class="go">2015-08-09 ... I&gt; started</span>
<span class="go">2015-08-09 ... I&gt; redundancy = 1</span>
<span class="go">2015-08-09 ... I&gt; Zone len=1 THERE</span>
<span class="go">2015-08-09 ... I&gt; Adding localhost:3301 to shard 1</span>
<span class="go">2015-08-09 ... I&gt; Zone len=1 THERE</span>
<span class="go">2015-08-09 ... I&gt; shards = 1</span>
<span class="go">2015-08-09 ... I&gt; Done</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="c1">-- Now put something in ...</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">shard</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">Tuple #1&#39;</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">#1&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
</div>
<div class="section" id="example-shard-scaling-out">
<h4>Example: Shard, Scaling Out<a class="headerlink" href="#example-shard-scaling-out" title="Ссылка на этот заголовок">¶</a></h4>
<p>There are two shards, and each shard contains one replica. This requires two
nodes. In real life the two nodes would be two computers, but for this
illustration the requirement is merely: start two shells, which we'll call
Terminal#1 and Terminal #2.</p>
<p>On Terminal #1, say:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">$</span> mkdir ~/tarantool_sandbox_1
<span class="gp">$</span> <span class="nb">cd</span> ~/tarantool_sandbox_1
<span class="gp">$</span> rm -r *.snap
<span class="gp">$</span> rm -r *.xlog
<span class="gp">$</span> ~/tarantool-1.7/src/tarantool

<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span> <span class="o">=</span> <span class="mi">3301</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">passwd</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">admin&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">password&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">console</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">console&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">servers</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">         &gt; </span>    <span class="p">{</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">localhost:3301&#39;</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">1&#39;</span> <span class="p">},</span>
<span class="gp">         &gt; </span>    <span class="p">{</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">localhost:3302&#39;</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">2&#39;</span> <span class="p">},</span>
<span class="gp">         &gt; </span>  <span class="p">},</span>
<span class="gp">         &gt; </span>  <span class="n">login</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">admin&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">password&#39;</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">redundancy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="gp">         &gt; </span>  <span class="n">binary</span> <span class="o">=</span> <span class="mi">3301</span><span class="p">,</span>
<span class="gp">         &gt; </span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">shard</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">shard&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">shard</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="c1">-- Now put something in ...</span>
<span class="gp">tarantool&gt; </span><span class="n">shard</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">insert</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;</span><span class="s">Tuple #1&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>On Terminal #2, say:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">$</span> mkdir ~/tarantool_sandbox_2
<span class="gp">$</span> <span class="nb">cd</span> ~/tarantool_sandbox_2
<span class="gp">$</span> rm -r *.snap
<span class="gp">$</span> rm -r *.xlog
<span class="gp">$</span> ~/tarantool-1.7/src/tarantool

<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span> <span class="o">=</span> <span class="mi">3302</span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tester&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">primary&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">passwd</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">admin&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">password&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">console</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">console&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">         &gt; </span>  <span class="n">servers</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">         &gt; </span>    <span class="p">{</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">localhost:3301&#39;</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">1&#39;</span> <span class="p">};</span>
<span class="gp">         &gt; </span>    <span class="p">{</span> <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">localhost:3302&#39;</span><span class="p">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">2&#39;</span> <span class="p">};</span>
<span class="gp">         &gt; </span>  <span class="p">};</span>
<span class="gp">         &gt; </span>  <span class="n">login</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">admin&#39;</span><span class="p">;</span>
<span class="gp">         &gt; </span>  <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">password&#39;</span><span class="p">;</span>
<span class="gp">         &gt; </span>  <span class="n">redundancy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="gp">         &gt; </span>  <span class="n">binary</span> <span class="o">=</span> <span class="mi">3302</span><span class="p">;</span>
<span class="gp">         &gt; </span><span class="p">}</span>
<span class="gp">tarantool&gt; </span><span class="n">shard</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">shard&#39;</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="n">shard</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<span class="gp">tarantool&gt; </span><span class="c1">-- Now get something out ...</span>
<span class="gp">tarantool&gt; </span><span class="n">shard</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
<p>What will appear on Terminal #1 is: a loop of error messages saying &quot;Connection
refused&quot; and &quot;server check failure&quot;. This is normal. It will go on until
Terminal #2 process starts.</p>
<p>What will appear on Terminal #2, at the end, should look like this:</p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">shard</span><span class="p">.</span><span class="n">tester</span><span class="p">:</span><span class="nb">select</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
<span class="nn">---</span>
<span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">-</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="s">&#39;Tuple</span><span class="nv"> </span><span class="s">#1&#39;</span><span class="p p-Indicator">]</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>This shows that what was inserted by Terminal #1 can be selected by Terminal #2,
via the shard module.</p>
<p>Details are on <a class="reference external" href="https://github.com/tarantool/shard">the shard section of github</a>.</p>
</div>
</div>
<span id="document-reference_rock/tdb"></span><div class="section" id="module-tdb">
<h3>Module <cite>tdb</cite><a class="headerlink" href="#module-tdb" title="Ссылка на этот заголовок">¶</a></h3>
<p>The Tarantool Debugger (abbreviation = tdb) can be used with any Lua program.
The operational features include: setting breakpoints, examining variables,
going forward one line at a time, backtracing, and showing information about
fibers. The display features include: using different colors for different
situations, including line numbers, and adding hints.</p>
<p>It is not supplied as part of the Tarantool repository; it must be installed
separately. Here is the usual way:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>git clone --recursive https://github.com/Sulverus/tdb
<span class="nb">cd</span> tdb
make
sudo make install <span class="nv">prefix</span><span class="o">=</span>/usr/share/tarantool/
</pre></div>
</div>
<p>To initiate tdb within a Lua program and set a breakpoint, edit the program to
include these lines:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">tdb</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tdb&#39;</span><span class="p">)</span>
<span class="n">tdb</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
<p>To start the debugging session, execute the Lua program. Execution will stop at
the breakpoint, and it will be possible to enter debugging commands.</p>
<div class="section" id="debugger-commands">
<h4>Debugger Commands<a class="headerlink" href="#debugger-commands" title="Ссылка на этот заголовок">¶</a></h4>
<dl class="docutils">
<dt><span class="ccodeb">bt</span></dt>
<dd>Backtrace -- show the stack (in red), with program/function names and line
numbers of whatever has been invoked to reach the current line.</dd>
<dt><span class="ccodeb">c</span></dt>
<dd>Continue till next breakpoint or till program ends.</dd>
<dt><span class="ccodeb">e</span></dt>
<dd>Enter evaluation mode. When the program is in evaluation mode, one can
execute certain Lua statements that would be valid in the context. This is
particularly useful for displaying the values of the program's variables.
Other debugger commands will not work until one exits evaluation mode by
typing <span class="ccodeb">-e</span>.</dd>
<dt><span class="ccodeb">-e</span></dt>
<dd>Exit evaluation mode.</dd>
<dt><span class="ccodeb">f</span></dt>
<dd>Display the fiber id, the program name, and the percentage of memory used,
as a table.</dd>
<dt><span class="ccodeb">n</span></dt>
<dd>Go to the next line, skipping over any function calls.</dd>
<dt><span class="ccodeb">globals</span></dt>
<dd>Display names of variables or functions which are defined as global.</dd>
<dt><span class="ccodeb">h</span></dt>
<dd>Display a list of debugger commands.</dd>
<dt><span class="ccodeb">locals</span></dt>
<dd>Display names and values of variables, for example the control variables of
a Lua &quot;for&quot; statement.</dd>
<dt><span class="ccodeb">q</span></dt>
<dd>Quit immediately.</dd>
</dl>
</div>
<div class="section" id="example-session">
<h4>Example Session<a class="headerlink" href="#example-session" title="Ссылка на этот заголовок">¶</a></h4>
<p>Put the following program in a default directory and call it &quot;example.lua&quot;:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">tdb</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">tdb&#39;</span><span class="p">)</span>
<span class="n">tdb</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">j</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">a&#39;</span> <span class="o">..</span> <span class="n">i</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">end of program&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now start Tarantool, using example.lua as the initialization file</p>
<pre class="highlight literal-block">
$ <span class="ccodeb">tarantool example.lua</span>
</pre>
<p>The screen should now look like this:</p>
<pre class="highlight literal-block">
$ <span class="ccodeb">tarantool example.lua</span>
<span class="ccodeblue">(TDB)</span>  <span class="ccodegreen">Tarantool debugger v.0.0.3. Type h for help</span>
example.lua
<span class="ccodeblue">(TDB)</span>  <span class="ccodegreen">[example.lua]</span>
<span class="ccodeblue">(TDB)</span>  <span class="ccode">3: i = 1</span>
<span class="ccodeblue">(TDB)&gt;</span>
</pre>
<p>Debugger prompts are blue, debugger hints and information
are green, and the current line -- line 3 of example.lua --
is the default color. Now enter six debugger commands:</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="n">n</span>  <span class="c1">-- go to next line</span>
<span class="n">n</span>  <span class="c1">-- go to next line</span>
<span class="n">e</span>  <span class="c1">-- enter evaluation mode</span>
<span class="n">j</span>  <span class="c1">-- display j</span>
<span class="o">-</span><span class="n">e</span> <span class="c1">-- exit evaluation mode</span>
<span class="n">q</span>  <span class="c1">-- quit</span>
</pre></div>
</div>
<p>The screen should now look like this:</p>
<pre class="highlight literal-block">
$ <span class="ccodeb">tarantool example.lua</span>
<span class="ccodeblue">(TDB)</span>  <span class="ccodegreen">Tarantool debugger v.0.0.3. Type h for help</span>
example.lua
<span class="ccodeblue">(TDB)</span>  <span class="ccodegreen">[example.lua]</span>
<span class="ccodeblue">(TDB)</span>  <span class="ccode">3: i = 1</span>
<span class="ccodeblue">(TDB)&gt;</span> n
<span class="ccodeblue">(TDB)</span>  <span class="ccode">4: j = 'a' .. i</span>
<span class="ccodeblue">(TDB)&gt;</span> n
<span class="ccodeblue">(TDB)</span>  <span class="ccode">5: print('end of program')</span>
<span class="ccodeblue">(TDB)&gt;</span> e
<span class="ccodeblue">(TDB)</span>  <span class="ccodegreen">Eval mode ON</span>
<span class="ccodeblue">(TDB)&gt;</span> j
j       a1
<span class="ccodeblue">(TDB)&gt;</span> -e
<span class="ccodeblue">(TDB)</span>  <span class="ccodegreen">Eval mode OFF</span>
<span class="ccodeblue">(TDB)&gt;</span> q
</pre>
<p>Another debugger example can be found <a class="reference external" href="https://github.com/sulverus/tdb">here</a>.</p>
</div>
</div>
</div>
</div>
<span id="document-reference_capi/index"></span><div class="section" id="c-api-reference">
<span id="index-c-api-reference"></span><h2>Справочник по C API<a class="headerlink" href="#c-api-reference" title="Ссылка на этот заголовок">¶</a></h2>
<div class="toctree-wrapper compound" id="list-of-c-api-headers">
<span id="document-reference_capi/box"></span><div class="section" id="module-box">
<h3>Модуль <cite>box</cite><a class="headerlink" href="#module-box" title="Ссылка на этот заголовок">¶</a></h3>
<dl class="type">
<dt id="c.box_function_ctx_t">
<code class="descname">box_function_ctx_t</code><a class="headerlink" href="#c.box_function_ctx_t" title="Ссылка на это определение">¶</a></dt>
<dd><p>Opaque structure passed to the stored C procedure</p>
</dd></dl>

<dl class="function">
<dt id="c.box_return_tuple">
int <code class="descname">box_return_tuple</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_function_ctx_t" title="box_function_ctx_t">box_function_ctx_t</a><em>&nbsp;*ctx</em>, <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;*tuple</em><big>)</big><a class="headerlink" href="#c.box_return_tuple" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return a tuple from stored C procedure.</p>
<p>Returned tuple is automatically reference counted by Tarantool.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>ctx</strong> (<em>box_funtion_ctx_t*</em>) -- an opaque structure passed to the stored C
procedure by Tarantool</li>
<li><strong>tuple</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t*</em></a>) -- a tuple to return</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">-1 on error (perhaps, out of memory; check
<a class="reference internal" href="singlehtml.html#c-api-error-box-error-last"><span class="std std-ref">box_error_last()</span></a>)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">0 otherwise</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="box-box-space-id-by-name"></span><dl class="function">
<dt id="c.box_space_id_by_name">
uint32_t <code class="descname">box_space_id_by_name</code><big>(</big>const char<em>&nbsp;*name</em>, uint32_t<em>&nbsp;len</em><big>)</big><a class="headerlink" href="#c.box_space_id_by_name" title="Ссылка на это определение">¶</a></dt>
<dd><p>Find space id by name.</p>
<p>This function performs SELECT request to _vspace system space.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>char* name</strong> (<em>const</em>) -- space name</li>
<li><strong>len</strong> (<em>uint32_t</em>) -- length of <code class="docutils literal"><span class="pre">name</span></code></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first"><code class="xref c c-macro docutils literal"><span class="pre">BOX_ID_NIL</span></code> on error or if not found (check
<a class="reference internal" href="singlehtml.html#c-api-error-box-error-last"><span class="std std-ref">box_error_last()</span></a>)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">space_id otherwise</p>
</td>
</tr>
</tbody>
</table>
<p>See also: <a class="reference internal" href="#c.box_index_id_by_name" title="box_index_id_by_name"><code class="xref c c-type docutils literal"><span class="pre">box_index_id_by_name</span></code></a></p>
</dd></dl>

<dl class="function">
<dt id="c.box_index_id_by_name">
uint32_t <code class="descname">box_index_id_by_name</code><big>(</big>uint32_t<em>&nbsp;space_id</em>, const char<em>&nbsp;*name</em>, uint32_t<em>&nbsp;len</em><big>)</big><a class="headerlink" href="#c.box_index_id_by_name" title="Ссылка на это определение">¶</a></dt>
<dd><p>Find index id by name.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>space_id</strong> (<em>uint32_t</em>) -- space identifier</li>
<li><strong>char*  name</strong> (<em>const</em>) -- index name</li>
<li><strong>len</strong> (<em>uint32_t</em>) -- length of <code class="docutils literal"><span class="pre">name</span></code></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first"><code class="xref c c-macro docutils literal"><span class="pre">BOX_ID_NIL</span></code> on error or if not found (check
<a class="reference internal" href="singlehtml.html#c-api-error-box-error-last"><span class="std std-ref">box_error_last()</span></a>)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">space_id otherwise</p>
</td>
</tr>
</tbody>
</table>
<p>This function performs SELECT request to _vindex system space.</p>
<p>See also: <a class="reference internal" href="#c.box_space_id_by_name" title="box_space_id_by_name"><code class="xref c c-type docutils literal"><span class="pre">box_space_id_by_name</span></code></a></p>
</dd></dl>

<span class="target" id="box-box-insert"></span><dl class="function">
<dt id="c.box_insert">
int <code class="descname">box_insert</code><big>(</big>uint32_t<em>&nbsp;space_id</em>, const char<em>&nbsp;*tuple</em>, const char<em>&nbsp;*tuple_end</em>, <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;**result</em><big>)</big><a class="headerlink" href="#c.box_insert" title="Ссылка на это определение">¶</a></dt>
<dd><p>Execute an INSERT/REPLACE request.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>space_id</strong> (<em>uint32_t</em>) -- space identifier</li>
<li><strong>char*     tuple</strong> (<em>const</em>) -- encoded tuple in MsgPack Array format ([ field1, field2, ...])</li>
<li><strong>char* tuple_end</strong> (<em>const</em>) -- end of a <code class="docutils literal"><span class="pre">tuple</span></code></li>
<li><strong>result</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t**</em></a>) -- output argument. Resulted tuple. Can be set to
NULL to discard result</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">-1 on error (check <a class="reference internal" href="singlehtml.html#c-api-error-box-error-last"><span class="std std-ref">box_error_last()</span></a>)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">0 otherwise</p>
</td>
</tr>
</tbody>
</table>
<p>See also <a class="reference internal" href="singlehtml.html#box-space-insert"><span class="std std-ref">space_object.insert()</span></a></p>
</dd></dl>

<dl class="function">
<dt id="c.box_replace">
int <code class="descname">box_replace</code><big>(</big>uint32_t<em>&nbsp;space_id</em>, const char<em>&nbsp;*tuple</em>, const char<em>&nbsp;*tuple_end</em>, <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;**result</em><big>)</big><a class="headerlink" href="#c.box_replace" title="Ссылка на это определение">¶</a></dt>
<dd><p>Execute an REPLACE request.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>space_id</strong> (<em>uint32_t</em>) -- space identifier</li>
<li><strong>char*     tuple</strong> (<em>const</em>) -- encoded tuple in MsgPack Array format ([ field1, field2, ...])</li>
<li><strong>char* tuple_end</strong> (<em>const</em>) -- end of a <code class="docutils literal"><span class="pre">tuple</span></code></li>
<li><strong>result</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t**</em></a>) -- output argument. Resulted tuple. Can be set to
NULL to discard result</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">-1 on error (check <a class="reference internal" href="singlehtml.html#c-api-error-box-error-last"><span class="std std-ref">box_error_last()</span></a>)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">0 otherwise</p>
</td>
</tr>
</tbody>
</table>
<p>See also <a class="reference internal" href="singlehtml.html#box-space-replace"><span class="std std-ref">space_object.replace()</span></a></p>
</dd></dl>

<dl class="function">
<dt id="c.box_delete">
int <code class="descname">box_delete</code><big>(</big>uint32_t<em>&nbsp;space_id</em>, uint32_t<em>&nbsp;index_id</em>, const char<em>&nbsp;*key</em>, const char<em>&nbsp;*key_end</em>, <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;**result</em><big>)</big><a class="headerlink" href="#c.box_delete" title="Ссылка на это определение">¶</a></dt>
<dd><p>Execute an DELETE request.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>space_id</strong> (<em>uint32_t</em>) -- space identifier</li>
<li><strong>index_id</strong> (<em>uint32_t</em>) -- index identifier</li>
<li><strong>char*      key</strong> (<em>const</em>) -- encoded key in MsgPack Array format ([ field1, field2, ...])</li>
<li><strong>char*  key_end</strong> (<em>const</em>) -- end of a <code class="docutils literal"><span class="pre">key</span></code></li>
<li><strong>result</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t**</em></a>) -- output argument. Result an old tuple. Can be
set to NULL to discard result</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">-1 on error (check <a class="reference internal" href="singlehtml.html#c-api-error-box-error-last"><span class="std std-ref">box_error_last()</span></a>)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">0 otherwise</p>
</td>
</tr>
</tbody>
</table>
<p>See also <a class="reference internal" href="singlehtml.html#box-space-delete"><span class="std std-ref">space_object.delete()</span></a></p>
</dd></dl>

<dl class="function">
<dt id="c.box_update">
int <code class="descname">box_update</code><big>(</big>uint32_t<em>&nbsp;space_id</em>, uint32_t<em>&nbsp;index_id</em>, const char<em>&nbsp;*key</em>, const char<em>&nbsp;*key_end</em>, const char<em>&nbsp;*ops</em>, const char<em>&nbsp;*ops_end</em>, int<em>&nbsp;index_base</em>, <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;**result</em><big>)</big><a class="headerlink" href="#c.box_update" title="Ссылка на это определение">¶</a></dt>
<dd><p>Execute an UPDATE request.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>space_id</strong> (<em>uint32_t</em>) -- space identifier</li>
<li><strong>index_id</strong> (<em>uint32_t</em>) -- index identifier</li>
<li><strong>char*      key</strong> (<em>const</em>) -- encoded key in MsgPack Array format ([ field1, field2, ...])</li>
<li><strong>char*  key_end</strong> (<em>const</em>) -- end of a <code class="docutils literal"><span class="pre">key</span></code></li>
<li><strong>char*      ops</strong> (<em>const</em>) -- encoded operations in MsgPack Arrat format, e.g.
<code class="docutils literal"><span class="pre">[[</span> <span class="pre">'=',</span> <span class="pre">field_id,</span>&nbsp; <span class="pre">value</span> <span class="pre">],</span> <span class="pre">['!',</span> <span class="pre">2,</span> <span class="pre">'xxx']]</span></code></li>
<li><strong>char*  ops_end</strong> (<em>const</em>) -- end of a <code class="docutils literal"><span class="pre">ops</span></code></li>
<li><strong>index_base</strong> (<em>int</em>) -- 0 if field_ids in update operation are zero-based
indexed (like C) or 1 if for one-based indexed
field ids (like Lua).</li>
<li><strong>result</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t**</em></a>) -- output argument. Result an old tuple. Can be
set to NULL to discard result</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">-1 on error (check <a class="reference internal" href="singlehtml.html#c-api-error-box-error-last"><span class="std std-ref">box_error_last()</span></a>)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">0 otherwise</p>
</td>
</tr>
</tbody>
</table>
<p>See also <a class="reference internal" href="singlehtml.html#box-space-update"><span class="std std-ref">space_object.update()</span></a></p>
</dd></dl>

<dl class="function">
<dt id="c.box_upsert">
int <code class="descname">box_upsert</code><big>(</big>uint32_t<em>&nbsp;space_id</em>, uint32_t<em>&nbsp;index_id</em>, const char<em>&nbsp;*tuple</em>, const char<em>&nbsp;*tuple_end</em>, const char<em>&nbsp;*ops</em>, const char<em>&nbsp;*ops_end</em>, int<em>&nbsp;index_base</em>, <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;**result</em><big>)</big><a class="headerlink" href="#c.box_upsert" title="Ссылка на это определение">¶</a></dt>
<dd><p>Execute an UPSERT request.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>space_id</strong> (<em>uint32_t</em>) -- space identifier</li>
<li><strong>index_id</strong> (<em>uint32_t</em>) -- index identifier</li>
<li><strong>char*     tuple</strong> (<em>const</em>) -- encoded tuple in MsgPack Array format ([ field1, field2, ...])</li>
<li><strong>char* tuple_end</strong> (<em>const</em>) -- end of a <code class="docutils literal"><span class="pre">tuple</span></code></li>
<li><strong>char*       ops</strong> (<em>const</em>) -- encoded operations in MsgPack Arrat format, e.g.
<code class="docutils literal"><span class="pre">[[</span> <span class="pre">'=',</span> <span class="pre">field_id,</span>&nbsp; <span class="pre">value</span> <span class="pre">],</span> <span class="pre">['!',</span> <span class="pre">2,</span> <span class="pre">'xxx']]</span></code></li>
<li><strong>char*   ops_end</strong> (<em>const</em>) -- end of a <code class="docutils literal"><span class="pre">ops</span></code></li>
<li><strong>index_base</strong> (<em>int</em>) -- 0 if field_ids in update operation are zero-based
indexed (like C) or 1 if for one-based indexed
field ids (like Lua).</li>
<li><strong>result</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t**</em></a>) -- output argument. Result an old tuple. Can be
set to NULL to discard result</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">-1 on error (check :<a class="reference internal" href="singlehtml.html#c-api-error-box-error-last"><span class="std std-ref">box_error_last()</span></a>)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">0 otherwise</p>
</td>
</tr>
</tbody>
</table>
<p>See also <a class="reference internal" href="singlehtml.html#box-space-upsert"><span class="std std-ref">space_object.upsert()</span></a></p>
</dd></dl>

</div>
<span id="document-reference_capi/clock"></span><div class="section" id="module-clock">
<h3>Модуль <cite>clock</cite><a class="headerlink" href="#module-clock" title="Ссылка на этот заголовок">¶</a></h3>
<dl class="function">
<dt id="c.clock_realtime">
double <code class="descname">clock_realtime</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.clock_realtime" title="Ссылка на это определение">¶</a></dt>
<dt id="c.clock_monotonic">
double <code class="descname">clock_monotonic</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.clock_monotonic" title="Ссылка на это определение">¶</a></dt>
<dt id="c.clock_process">
double <code class="descname">clock_process</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.clock_process" title="Ссылка на это определение">¶</a></dt>
<dt id="c.clock_thread">
double <code class="descname">clock_thread</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.clock_thread" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="c.clock_realtime64">
uint64_t <code class="descname">clock_realtime64</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.clock_realtime64" title="Ссылка на это определение">¶</a></dt>
<dt id="c.clock_monotonic64">
uint64_t <code class="descname">clock_monotonic64</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.clock_monotonic64" title="Ссылка на это определение">¶</a></dt>
<dt id="c.clock_process64">
uint64_t <code class="descname">clock_process64</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.clock_process64" title="Ссылка на это определение">¶</a></dt>
<dt id="c.clock_thread64">
uint64_t <code class="descname">clock_thread64</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.clock_thread64" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

</div>
<span id="document-reference_capi/coio"></span><div class="section" id="module-coio">
<h3>Модуль <cite>coio</cite><a class="headerlink" href="#module-coio" title="Ссылка на этот заголовок">¶</a></h3>
<dl class="enum">
<dt id="_CPPv210COIO_EVENT">
<em class="property">enum </em><code class="descclassname"></code><code class="descname">COIO_EVENT</code><a class="headerlink" href="#_CPPv210COIO_EVENT" title="Ссылка на это определение">¶</a></dt>
<dd><dl class="enumerator">
<dt id="_CPPv29COIO_READ">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">COIO_READ</code><a class="headerlink" href="#_CPPv29COIO_READ" title="Ссылка на это определение">¶</a></dt>
<dd><p>READ event</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv210COIO_WRITE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">COIO_WRITE</code><a class="headerlink" href="#_CPPv210COIO_WRITE" title="Ссылка на это определение">¶</a></dt>
<dd><p>WRITE event</p>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="c.coio_wait">
int <code class="descname">coio_wait</code><big>(</big>int<em>&nbsp;fd</em>, int<em>&nbsp;event</em>, double<em>&nbsp;timeout</em><big>)</big><a class="headerlink" href="#c.coio_wait" title="Ссылка на это определение">¶</a></dt>
<dd><p>Wait until READ or WRITE event on socket (<code class="docutils literal"><span class="pre">fd</span></code>). Yields.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>fd</strong> (<em>int</em>) -- non-blocking socket file description</li>
<li><strong>event</strong> (<em>int</em>) -- requested events to wait. Combination of
<code class="docutils literal"><span class="pre">COIO_READ</span> <span class="pre">|</span> <span class="pre">COIO_WRITE</span></code> bit flags.</li>
<li><strong>timeout</strong> (<em>double</em>) -- timeout in seconds.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">0 - timeout</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">&gt;0 - returned events. Combination of <code class="docutils literal"><span class="pre">TNT_IO_READ</span> <span class="pre">|</span> <span class="pre">TNT_IO_WRITE</span></code> bit flags.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.coio_call">
ssize_t <code class="descname">coio_call</code><big>(</big>ssize_t (<em>*func</em>)(va_list), ...<big>)</big><a class="headerlink" href="#c.coio_call" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create new eio task with specified function and arguments. Yield and wait
until the task is complete or a timeout occurs.</p>
<p>This function doesn't throw exceptions to avoid double error checking: in
most cases it's also necessary to check the return value of the called
function and perform necessary actions. If func sets errno, the errno is
preserved across the call.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body">-1 and <code class="docutils literal"><span class="pre">errno</span></code> = ENOMEM if failed to create a task</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body">the function return (<code class="docutils literal"><span class="pre">errno</span></code> is preserved).</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">openfile_cb</span><span class="p">(</span><span class="kt">va_list</span> <span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">coio_call</span><span class="p">(</span><span class="n">openfile_cb</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="s">&quot;/tmp/file&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">// handle errors.</span>
<span class="p">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="c.coio_getaddrinfo">
int <code class="descname">coio_getaddrinfo</code><big>(</big>const char<em>&nbsp;*host</em>, const char<em>&nbsp;*port</em>, const struct addrinfo<em>&nbsp;*hints</em>, struct addrinfo<em>&nbsp;**res</em>, double<em>&nbsp;timeout</em><big>)</big><a class="headerlink" href="#c.coio_getaddrinfo" title="Ссылка на это определение">¶</a></dt>
<dd><p>Fiber-friendly version of <em class="manpage">getaddrinfo(3)</em>.</p>
</dd></dl>

</div>
<span id="document-reference_capi/error"></span><div class="section" id="lua-module.capi_error">
<span id="module-error"></span><h3>Модуль <cite>error</cite><a class="headerlink" href="#lua-module.capi_error" title="Ссылка на этот заголовок">¶</a></h3>
<span class="target" id="capi-box-error-code"></span><dl class="enum">
<dt id="_CPPv214box_error_code">
<em class="property">enum </em><code class="descclassname"></code><code class="descname">box_error_code</code><a class="headerlink" href="#_CPPv214box_error_code" title="Ссылка на это определение">¶</a></dt>
<dd><dl class="enumerator">
<dt id="_CPPv210ER_UNKNOWN">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_UNKNOWN</code><a class="headerlink" href="#_CPPv210ER_UNKNOWN" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv217ER_ILLEGAL_PARAMS">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_ILLEGAL_PARAMS</code><a class="headerlink" href="#_CPPv217ER_ILLEGAL_PARAMS" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv215ER_MEMORY_ISSUE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_MEMORY_ISSUE</code><a class="headerlink" href="#_CPPv215ER_MEMORY_ISSUE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv214ER_TUPLE_FOUND">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_TUPLE_FOUND</code><a class="headerlink" href="#_CPPv214ER_TUPLE_FOUND" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv218ER_TUPLE_NOT_FOUND">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_TUPLE_NOT_FOUND</code><a class="headerlink" href="#_CPPv218ER_TUPLE_NOT_FOUND" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv214ER_UNSUPPORTED">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_UNSUPPORTED</code><a class="headerlink" href="#_CPPv214ER_UNSUPPORTED" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv212ER_NONMASTER">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_NONMASTER</code><a class="headerlink" href="#_CPPv212ER_NONMASTER" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv211ER_READONLY">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_READONLY</code><a class="headerlink" href="#_CPPv211ER_READONLY" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv212ER_INJECTION">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_INJECTION</code><a class="headerlink" href="#_CPPv212ER_INJECTION" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv215ER_CREATE_SPACE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_CREATE_SPACE</code><a class="headerlink" href="#_CPPv215ER_CREATE_SPACE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv215ER_SPACE_EXISTS">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_SPACE_EXISTS</code><a class="headerlink" href="#_CPPv215ER_SPACE_EXISTS" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv213ER_DROP_SPACE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_DROP_SPACE</code><a class="headerlink" href="#_CPPv213ER_DROP_SPACE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv214ER_ALTER_SPACE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_ALTER_SPACE</code><a class="headerlink" href="#_CPPv214ER_ALTER_SPACE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv213ER_INDEX_TYPE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_INDEX_TYPE</code><a class="headerlink" href="#_CPPv213ER_INDEX_TYPE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv215ER_MODIFY_INDEX">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_MODIFY_INDEX</code><a class="headerlink" href="#_CPPv215ER_MODIFY_INDEX" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv212ER_LAST_DROP">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_LAST_DROP</code><a class="headerlink" href="#_CPPv212ER_LAST_DROP" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv221ER_TUPLE_FORMAT_LIMIT">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_TUPLE_FORMAT_LIMIT</code><a class="headerlink" href="#_CPPv221ER_TUPLE_FORMAT_LIMIT" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv219ER_DROP_PRIMARY_KEY">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_DROP_PRIMARY_KEY</code><a class="headerlink" href="#_CPPv219ER_DROP_PRIMARY_KEY" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv216ER_KEY_PART_TYPE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_KEY_PART_TYPE</code><a class="headerlink" href="#_CPPv216ER_KEY_PART_TYPE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv214ER_EXACT_MATCH">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_EXACT_MATCH</code><a class="headerlink" href="#_CPPv214ER_EXACT_MATCH" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv218ER_INVALID_MSGPACK">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_INVALID_MSGPACK</code><a class="headerlink" href="#_CPPv218ER_INVALID_MSGPACK" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv211ER_PROC_RET">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_PROC_RET</code><a class="headerlink" href="#_CPPv211ER_PROC_RET" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv218ER_TUPLE_NOT_ARRAY">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_TUPLE_NOT_ARRAY</code><a class="headerlink" href="#_CPPv218ER_TUPLE_NOT_ARRAY" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv213ER_FIELD_TYPE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_FIELD_TYPE</code><a class="headerlink" href="#_CPPv213ER_FIELD_TYPE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv222ER_FIELD_TYPE_MISMATCH">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_FIELD_TYPE_MISMATCH</code><a class="headerlink" href="#_CPPv222ER_FIELD_TYPE_MISMATCH" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv29ER_SPLICE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_SPLICE</code><a class="headerlink" href="#_CPPv29ER_SPLICE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv211ER_ARG_TYPE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_ARG_TYPE</code><a class="headerlink" href="#_CPPv211ER_ARG_TYPE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv220ER_TUPLE_IS_TOO_LONG">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_TUPLE_IS_TOO_LONG</code><a class="headerlink" href="#_CPPv220ER_TUPLE_IS_TOO_LONG" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv220ER_UNKNOWN_UPDATE_OP">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_UNKNOWN_UPDATE_OP</code><a class="headerlink" href="#_CPPv220ER_UNKNOWN_UPDATE_OP" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv215ER_UPDATE_FIELD">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_UPDATE_FIELD</code><a class="headerlink" href="#_CPPv215ER_UPDATE_FIELD" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv214ER_FIBER_STACK">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_FIBER_STACK</code><a class="headerlink" href="#_CPPv214ER_FIBER_STACK" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv217ER_KEY_PART_COUNT">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_KEY_PART_COUNT</code><a class="headerlink" href="#_CPPv217ER_KEY_PART_COUNT" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv211ER_PROC_LUA">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_PROC_LUA</code><a class="headerlink" href="#_CPPv211ER_PROC_LUA" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv215ER_NO_SUCH_PROC">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_NO_SUCH_PROC</code><a class="headerlink" href="#_CPPv215ER_NO_SUCH_PROC" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv218ER_NO_SUCH_TRIGGER">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_NO_SUCH_TRIGGER</code><a class="headerlink" href="#_CPPv218ER_NO_SUCH_TRIGGER" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv216ER_NO_SUCH_INDEX">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_NO_SUCH_INDEX</code><a class="headerlink" href="#_CPPv216ER_NO_SUCH_INDEX" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv216ER_NO_SUCH_SPACE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_NO_SUCH_SPACE</code><a class="headerlink" href="#_CPPv216ER_NO_SUCH_SPACE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv216ER_NO_SUCH_FIELD">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_NO_SUCH_FIELD</code><a class="headerlink" href="#_CPPv216ER_NO_SUCH_FIELD" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv220ER_SPACE_FIELD_COUNT">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_SPACE_FIELD_COUNT</code><a class="headerlink" href="#_CPPv220ER_SPACE_FIELD_COUNT" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv220ER_INDEX_FIELD_COUNT">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_INDEX_FIELD_COUNT</code><a class="headerlink" href="#_CPPv220ER_INDEX_FIELD_COUNT" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv29ER_WAL_IO">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_WAL_IO</code><a class="headerlink" href="#_CPPv29ER_WAL_IO" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv222ER_MORE_THAN_ONE_TUPLE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_MORE_THAN_ONE_TUPLE</code><a class="headerlink" href="#_CPPv222ER_MORE_THAN_ONE_TUPLE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv216ER_ACCESS_DENIED">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_ACCESS_DENIED</code><a class="headerlink" href="#_CPPv216ER_ACCESS_DENIED" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv214ER_CREATE_USER">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_CREATE_USER</code><a class="headerlink" href="#_CPPv214ER_CREATE_USER" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv212ER_DROP_USER">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_DROP_USER</code><a class="headerlink" href="#_CPPv212ER_DROP_USER" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv215ER_NO_SUCH_USER">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_NO_SUCH_USER</code><a class="headerlink" href="#_CPPv215ER_NO_SUCH_USER" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv214ER_USER_EXISTS">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_USER_EXISTS</code><a class="headerlink" href="#_CPPv214ER_USER_EXISTS" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv220ER_PASSWORD_MISMATCH">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_PASSWORD_MISMATCH</code><a class="headerlink" href="#_CPPv220ER_PASSWORD_MISMATCH" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv223ER_UNKNOWN_REQUEST_TYPE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_UNKNOWN_REQUEST_TYPE</code><a class="headerlink" href="#_CPPv223ER_UNKNOWN_REQUEST_TYPE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv224ER_UNKNOWN_SCHEMA_OBJECT">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_UNKNOWN_SCHEMA_OBJECT</code><a class="headerlink" href="#_CPPv224ER_UNKNOWN_SCHEMA_OBJECT" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv218ER_CREATE_FUNCTION">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_CREATE_FUNCTION</code><a class="headerlink" href="#_CPPv218ER_CREATE_FUNCTION" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv219ER_NO_SUCH_FUNCTION">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_NO_SUCH_FUNCTION</code><a class="headerlink" href="#_CPPv219ER_NO_SUCH_FUNCTION" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv218ER_FUNCTION_EXISTS">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_FUNCTION_EXISTS</code><a class="headerlink" href="#_CPPv218ER_FUNCTION_EXISTS" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv225ER_FUNCTION_ACCESS_DENIED">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_FUNCTION_ACCESS_DENIED</code><a class="headerlink" href="#_CPPv225ER_FUNCTION_ACCESS_DENIED" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv215ER_FUNCTION_MAX">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_FUNCTION_MAX</code><a class="headerlink" href="#_CPPv215ER_FUNCTION_MAX" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv222ER_SPACE_ACCESS_DENIED">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_SPACE_ACCESS_DENIED</code><a class="headerlink" href="#_CPPv222ER_SPACE_ACCESS_DENIED" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv211ER_USER_MAX">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_USER_MAX</code><a class="headerlink" href="#_CPPv211ER_USER_MAX" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv217ER_NO_SUCH_ENGINE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_NO_SUCH_ENGINE</code><a class="headerlink" href="#_CPPv217ER_NO_SUCH_ENGINE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv213ER_RELOAD_CFG">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_RELOAD_CFG</code><a class="headerlink" href="#_CPPv213ER_RELOAD_CFG" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv26ER_CFG">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_CFG</code><a class="headerlink" href="#_CPPv26ER_CFG" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv29ER_SOPHIA">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_SOPHIA</code><a class="headerlink" href="#_CPPv29ER_SOPHIA" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv229ER_LOCAL_SERVER_IS_NOT_ACTIVE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_LOCAL_SERVER_IS_NOT_ACTIVE</code><a class="headerlink" href="#_CPPv229ER_LOCAL_SERVER_IS_NOT_ACTIVE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv217ER_UNKNOWN_SERVER">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_UNKNOWN_SERVER</code><a class="headerlink" href="#_CPPv217ER_UNKNOWN_SERVER" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv222ER_CLUSTER_ID_MISMATCH">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_CLUSTER_ID_MISMATCH</code><a class="headerlink" href="#_CPPv222ER_CLUSTER_ID_MISMATCH" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv215ER_INVALID_UUID">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_INVALID_UUID</code><a class="headerlink" href="#_CPPv215ER_INVALID_UUID" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv219ER_CLUSTER_ID_IS_RO">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_CLUSTER_ID_IS_RO</code><a class="headerlink" href="#_CPPv219ER_CLUSTER_ID_IS_RO" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv213ER_RESERVED66">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_RESERVED66</code><a class="headerlink" href="#_CPPv213ER_RESERVED66" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv224ER_SERVER_ID_IS_RESERVED">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_SERVER_ID_IS_RESERVED</code><a class="headerlink" href="#_CPPv224ER_SERVER_ID_IS_RESERVED" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv216ER_INVALID_ORDER">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_INVALID_ORDER</code><a class="headerlink" href="#_CPPv216ER_INVALID_ORDER" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv224ER_MISSING_REQUEST_FIELD">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_MISSING_REQUEST_FIELD</code><a class="headerlink" href="#_CPPv224ER_MISSING_REQUEST_FIELD" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv213ER_IDENTIFIER">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_IDENTIFIER</code><a class="headerlink" href="#_CPPv213ER_IDENTIFIER" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv216ER_DROP_FUNCTION">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_DROP_FUNCTION</code><a class="headerlink" href="#_CPPv216ER_DROP_FUNCTION" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv216ER_ITERATOR_TYPE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_ITERATOR_TYPE</code><a class="headerlink" href="#_CPPv216ER_ITERATOR_TYPE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv214ER_REPLICA_MAX">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_REPLICA_MAX</code><a class="headerlink" href="#_CPPv214ER_REPLICA_MAX" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv215ER_INVALID_XLOG">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_INVALID_XLOG</code><a class="headerlink" href="#_CPPv215ER_INVALID_XLOG" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv220ER_INVALID_XLOG_NAME">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_INVALID_XLOG_NAME</code><a class="headerlink" href="#_CPPv220ER_INVALID_XLOG_NAME" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv221ER_INVALID_XLOG_ORDER">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_INVALID_XLOG_ORDER</code><a class="headerlink" href="#_CPPv221ER_INVALID_XLOG_ORDER" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv216ER_NO_CONNECTION">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_NO_CONNECTION</code><a class="headerlink" href="#_CPPv216ER_NO_CONNECTION" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv210ER_TIMEOUT">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_TIMEOUT</code><a class="headerlink" href="#_CPPv210ER_TIMEOUT" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv221ER_ACTIVE_TRANSACTION">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_ACTIVE_TRANSACTION</code><a class="headerlink" href="#_CPPv221ER_ACTIVE_TRANSACTION" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv224ER_NO_ACTIVE_TRANSACTION">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_NO_ACTIVE_TRANSACTION</code><a class="headerlink" href="#_CPPv224ER_NO_ACTIVE_TRANSACTION" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv227ER_CROSS_ENGINE_TRANSACTION">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_CROSS_ENGINE_TRANSACTION</code><a class="headerlink" href="#_CPPv227ER_CROSS_ENGINE_TRANSACTION" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv215ER_NO_SUCH_ROLE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_NO_SUCH_ROLE</code><a class="headerlink" href="#_CPPv215ER_NO_SUCH_ROLE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv214ER_ROLE_EXISTS">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_ROLE_EXISTS</code><a class="headerlink" href="#_CPPv214ER_ROLE_EXISTS" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv214ER_CREATE_ROLE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_CREATE_ROLE</code><a class="headerlink" href="#_CPPv214ER_CREATE_ROLE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv215ER_INDEX_EXISTS">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_INDEX_EXISTS</code><a class="headerlink" href="#_CPPv215ER_INDEX_EXISTS" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv221ER_TUPLE_REF_OVERFLOW">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_TUPLE_REF_OVERFLOW</code><a class="headerlink" href="#_CPPv221ER_TUPLE_REF_OVERFLOW" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv212ER_ROLE_LOOP">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_ROLE_LOOP</code><a class="headerlink" href="#_CPPv212ER_ROLE_LOOP" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv28ER_GRANT">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_GRANT</code><a class="headerlink" href="#_CPPv28ER_GRANT" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv215ER_PRIV_GRANTED">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_PRIV_GRANTED</code><a class="headerlink" href="#_CPPv215ER_PRIV_GRANTED" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv215ER_ROLE_GRANTED">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_ROLE_GRANTED</code><a class="headerlink" href="#_CPPv215ER_ROLE_GRANTED" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv219ER_PRIV_NOT_GRANTED">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_PRIV_NOT_GRANTED</code><a class="headerlink" href="#_CPPv219ER_PRIV_NOT_GRANTED" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv219ER_ROLE_NOT_GRANTED">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_ROLE_NOT_GRANTED</code><a class="headerlink" href="#_CPPv219ER_ROLE_NOT_GRANTED" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv219ER_MISSING_SNAPSHOT">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_MISSING_SNAPSHOT</code><a class="headerlink" href="#_CPPv219ER_MISSING_SNAPSHOT" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv226ER_CANT_UPDATE_PRIMARY_KEY">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_CANT_UPDATE_PRIMARY_KEY</code><a class="headerlink" href="#_CPPv226ER_CANT_UPDATE_PRIMARY_KEY" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv226ER_UPDATE_INTEGER_OVERFLOW">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_UPDATE_INTEGER_OVERFLOW</code><a class="headerlink" href="#_CPPv226ER_UPDATE_INTEGER_OVERFLOW" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv222ER_GUEST_USER_PASSWORD">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_GUEST_USER_PASSWORD</code><a class="headerlink" href="#_CPPv222ER_GUEST_USER_PASSWORD" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv223ER_TRANSACTION_CONFLICT">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_TRANSACTION_CONFLICT</code><a class="headerlink" href="#_CPPv223ER_TRANSACTION_CONFLICT" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv224ER_UNSUPPORTED_ROLE_PRIV">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_UNSUPPORTED_ROLE_PRIV</code><a class="headerlink" href="#_CPPv224ER_UNSUPPORTED_ROLE_PRIV" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv216ER_LOAD_FUNCTION">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_LOAD_FUNCTION</code><a class="headerlink" href="#_CPPv216ER_LOAD_FUNCTION" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv220ER_FUNCTION_LANGUAGE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_FUNCTION_LANGUAGE</code><a class="headerlink" href="#_CPPv220ER_FUNCTION_LANGUAGE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv213ER_RTREE_RECT">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_RTREE_RECT</code><a class="headerlink" href="#_CPPv213ER_RTREE_RECT" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv29ER_PROC_C">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_PROC_C</code><a class="headerlink" href="#_CPPv29ER_PROC_C" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv236ER_UNKNOWN_RTREE_INDEX_DISTANCE_TYPE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_UNKNOWN_RTREE_INDEX_DISTANCE_TYPE</code><a class="headerlink" href="#_CPPv236ER_UNKNOWN_RTREE_INDEX_DISTANCE_TYPE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv211ER_PROTOCOL">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_PROTOCOL</code><a class="headerlink" href="#_CPPv211ER_PROTOCOL" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv230ER_UPSERT_UNIQUE_SECONDARY_KEY">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_UPSERT_UNIQUE_SECONDARY_KEY</code><a class="headerlink" href="#_CPPv230ER_UPSERT_UNIQUE_SECONDARY_KEY" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv221ER_WRONG_INDEX_RECORD">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_WRONG_INDEX_RECORD</code><a class="headerlink" href="#_CPPv221ER_WRONG_INDEX_RECORD" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv220ER_WRONG_INDEX_PARTS">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_WRONG_INDEX_PARTS</code><a class="headerlink" href="#_CPPv220ER_WRONG_INDEX_PARTS" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv222ER_WRONG_INDEX_OPTIONS">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_WRONG_INDEX_OPTIONS</code><a class="headerlink" href="#_CPPv222ER_WRONG_INDEX_OPTIONS" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv223ER_WRONG_SCHEMA_VERSION">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_WRONG_SCHEMA_VERSION</code><a class="headerlink" href="#_CPPv223ER_WRONG_SCHEMA_VERSION" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv217ER_SLAB_ALLOC_MAX">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_SLAB_ALLOC_MAX</code><a class="headerlink" href="#_CPPv217ER_SLAB_ALLOC_MAX" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv222ER_WRONG_SPACE_OPTIONS">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_WRONG_SPACE_OPTIONS</code><a class="headerlink" href="#_CPPv222ER_WRONG_SPACE_OPTIONS" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv228ER_UNSUPPORTED_INDEX_FEATURE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_UNSUPPORTED_INDEX_FEATURE</code><a class="headerlink" href="#_CPPv228ER_UNSUPPORTED_INDEX_FEATURE" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv213ER_VIEW_IS_RO">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ER_VIEW_IS_RO</code><a class="headerlink" href="#_CPPv213ER_VIEW_IS_RO" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv218box_error_code_MAX">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">box_error_code_MAX</code><a class="headerlink" href="#_CPPv218box_error_code_MAX" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<dl class="type">
<dt id="c.box_error_t">
<code class="descname">box_error_t</code><a class="headerlink" href="#c.box_error_t" title="Ссылка на это определение">¶</a></dt>
<dd><p>Error - contains information about error.</p>
</dd></dl>

<dl class="function">
<dt id="c.box_error_type">
const char * <code class="descname">box_error_type</code><big>(</big>const <a class="reference internal" href="singlehtml.html#c.box_error_t" title="box_error_t">box_error_t</a><em>&nbsp;*error</em><big>)</big><a class="headerlink" href="#c.box_error_type" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the error type, e.g. &quot;ClientError&quot;, &quot;SocketError&quot;, etc.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>error</strong> (<a class="reference internal" href="singlehtml.html#c.box_error_t" title="box_error_t"><em>box_error_t*</em></a>) -- error</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">not-null string</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_error_code">
uint32_t <code class="descname">box_error_code</code><big>(</big>const <a class="reference internal" href="singlehtml.html#c.box_error_t" title="box_error_t">box_error_t</a><em>&nbsp;*error</em><big>)</big><a class="headerlink" href="#c.box_error_code" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return IPROTO error code</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>error</strong> (<a class="reference internal" href="singlehtml.html#c.box_error_t" title="box_error_t"><em>box_error_t*</em></a>) -- error</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">enum <a class="reference internal" href="#capi-box-error-code"><span class="std std-ref">box_error_code</span></a></p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_error_message">
const char * <code class="descname">box_error_message</code><big>(</big>const <a class="reference internal" href="singlehtml.html#c.box_error_t" title="box_error_t">box_error_t</a><em>&nbsp;*error</em><big>)</big><a class="headerlink" href="#c.box_error_message" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the error message</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>error</strong> (<a class="reference internal" href="singlehtml.html#c.box_error_t" title="box_error_t"><em>box_error_t*</em></a>) -- error</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">not-null string</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="c-api-error-box-error-last"></span><dl class="function">
<dt id="c.box_error_last">
<a class="reference internal" href="singlehtml.html#c.box_error_t" title="box_error_t">box_error_t</a> * <code class="descname">box_error_last</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.box_error_last" title="Ссылка на это определение">¶</a></dt>
<dd><p>Get the information about the last API call error.</p>
<p>The Tarantool error handling works most like libc's errno. All API calls
return -1 or NULL in the event of error. An internal pointer to box_error_t
type is set by API functions to indicate what went wrong. This value is only
significant if API call failed (returned -1 or NULL).</p>
<p>Successful function can also touch the last error in some cases. You don't
have to clear the last error before calling API functions. The returned
object is valid only until next call to <strong>any</strong> API function.</p>
<p>You must set the last error using box_error_set() in your stored C procedures
if you want to return a custom error message. You can re-throw the last API
error to IPROTO client by keeping the current value and returning -1 to
Tarantool from your stored procedure.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body">last error</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_error_clear">
void <code class="descname">box_error_clear</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.box_error_clear" title="Ссылка на это определение">¶</a></dt>
<dd><p>Clear the last error.</p>
</dd></dl>

<dl class="function">
<dt id="c.box_error_set">
int <code class="descname">box_error_set</code><big>(</big>const char<em>&nbsp;*file</em>, unsigned<em>&nbsp;line</em>, uint32_t<em>&nbsp;code</em>, const char<em>&nbsp;*format</em>, ...<big>)</big><a class="headerlink" href="#c.box_error_set" title="Ссылка на это определение">¶</a></dt>
<dd><p>Set the last error.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>char* file</strong> (<em>const</em>) -- </li>
<li><strong>line</strong> (<em>unsigned</em>) -- </li>
<li><strong>code</strong> (<em>uint32_t</em>) -- IPROTO <a class="reference internal" href="#capi-box-error-code"><span class="std std-ref">error code</span></a></li>
<li><strong>char* format</strong> (<em>const</em>) -- </li>
<li><strong>...</strong> -- format arguments</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>See also: IPROTO <a class="reference internal" href="#capi-box-error-code"><span class="std std-ref">error code</span></a></p>
</dd></dl>

<dl class="macro">
<dt id="c.box_error_raise">
<code class="descname">box_error_raise</code><big>(</big>code, format, ...<big>)</big><a class="headerlink" href="#c.box_error_raise" title="Ссылка на это определение">¶</a></dt>
<dd><p>A backward-compatible API define.</p>
</dd></dl>

</div>
<span id="document-reference_capi/fiber"></span><div class="section" id="module-fiber">
<h3>Модуль <cite>fiber</cite><a class="headerlink" href="#module-fiber" title="Ссылка на этот заголовок">¶</a></h3>
<dl class="type">
<dt id="c.fiber">
struct <code class="descname">fiber</code><a class="headerlink" href="#c.fiber" title="Ссылка на это определение">¶</a></dt>
<dd><p>Fiber - contains information about fiber</p>
</dd></dl>

<dl class="function">
<dt id="c.fiber_new">
struct <a class="reference internal" href="singlehtml.html#c.fiber" title="fiber">fiber</a> *<code class="descname">fiber_new</code><big>(</big>const char<em>&nbsp;*name</em>, fiber_func<em>&nbsp;f</em><big>)</big><a class="headerlink" href="#c.fiber_new" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="type">
<dt id="c.fuber_func">
typedef int <code class="descname">(*fuber_func)</code><big>(</big>va_list<big>)</big><a class="headerlink" href="#c.fuber_func" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create a new fiber.</p>
<p>Takes a fiber from fiber cache, if it's not empty. Can fail only if there is
not enough memory for the fiber structure or fiber stack.</p>
<p>The created fiber automatically returns itself to the fiber cache when its
&quot;main&quot; function completes.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>char* name</strong> (<em>const</em>) -- string with fiber name</li>
<li><strong>f</strong> (<em>fiber_func</em>) -- func for run inside fiber</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>See also: <a class="reference internal" href="#c-api-fiber-fiber-start"><span class="std std-ref">fiber_start()</span></a></p>
</dd></dl>

<dl class="function">
<dt id="c.fiber_yield">
void <code class="descname">fiber_yield</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.fiber_yield" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return control to another fiber and wait until it'll be woken.</p>
<p>See also: <a class="reference internal" href="#c-api-fiber-fiber-wakeup"><span class="std std-ref">fiber_wakeup()</span></a></p>
</dd></dl>

<span class="target" id="c-api-fiber-fiber-start"></span><dl class="function">
<dt id="c.fiber_start">
void <code class="descname">fiber_start</code><big>(</big>struct <a class="reference internal" href="singlehtml.html#c.fiber" title="fiber">fiber</a><em>&nbsp;*callee</em>, ...<big>)</big><a class="headerlink" href="#c.fiber_start" title="Ссылка на это определение">¶</a></dt>
<dd><p>Start execution of created fiber.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>fiber* callee</strong> (<em>struct</em>) -- fiber to start</li>
<li><strong>...</strong> -- arguments to start the fiber with</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="c-api-fiber-fiber-wakeup"></span><dl class="function">
<dt id="c.fiber_wakeup">
void <code class="descname">fiber_wakeup</code><big>(</big>struct <a class="reference internal" href="singlehtml.html#c.fiber" title="fiber">fiber</a><em>&nbsp;*f</em><big>)</big><a class="headerlink" href="#c.fiber_wakeup" title="Ссылка на это определение">¶</a></dt>
<dd><p>Interrupt a synchronous wait of a fiber</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>fiber* f</strong> (<em>struct</em>) -- fiber to be woken up</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.fiber_cancel">
void <code class="descname">fiber_cancel</code><big>(</big>struct <a class="reference internal" href="singlehtml.html#c.fiber" title="fiber">fiber</a><em>&nbsp;*f</em><big>)</big><a class="headerlink" href="#c.fiber_cancel" title="Ссылка на это определение">¶</a></dt>
<dd><p>Cancel the subject fiber (set <code class="docutils literal"><span class="pre">FIBER_IS_CANCELLED</span></code> flag)</p>
<p>If target fiber's flag <code class="docutils literal"><span class="pre">FIBER_IS_CANCELLABLE</span></code> set, then it would be woken
up (maybe prematurely). Then current fiber yields until the target fiber is
dead (or is woken up by <a class="reference internal" href="#c-api-fiber-fiber-wakeup"><span class="std std-ref">fiber_wakeup()</span></a>).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>fiber* f</strong> (<em>struct</em>) -- fiber to be cancelled</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.fiber_set_cancellable">
bool <code class="descname">fiber_set_cancellable</code><big>(</big>bool<em>&nbsp;yesno</em><big>)</big><a class="headerlink" href="#c.fiber_set_cancellable" title="Ссылка на это определение">¶</a></dt>
<dd><p>Make it possible or not possible to wakeup the current fiber immediately
when it's cancelled.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>fiber* f</strong> (<em>struct</em>) -- fiber</li>
<li><strong>yesno</strong> (<em>bool</em>) -- status to set</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">previous state</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="c-api-fiber-fiber-set-joinable"></span><dl class="function">
<dt id="c.fiber_set_joinable">
void <code class="descname">fiber_set_joinable</code><big>(</big>struct <a class="reference internal" href="singlehtml.html#c.fiber" title="fiber">fiber</a><em>&nbsp;*fiber</em>, bool<em>&nbsp;yesno</em><big>)</big><a class="headerlink" href="#c.fiber_set_joinable" title="Ссылка на это определение">¶</a></dt>
<dd><p>Set fiber to be joinable (<code class="docutils literal"><span class="pre">false</span></code> by default).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>fiber* f</strong> (<em>struct</em>) -- fiber</li>
<li><strong>yesno</strong> (<em>bool</em>) -- status to set</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.fiber_join">
void <code class="descname">fiber_join</code><big>(</big>struct <a class="reference internal" href="singlehtml.html#c.fiber" title="fiber">fiber</a><em>&nbsp;*f</em><big>)</big><a class="headerlink" href="#c.fiber_join" title="Ссылка на это определение">¶</a></dt>
<dd><p>Wait until the fiber is dead and then move its execution status to the
caller. The fiber must not be detached.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>fiber* f</strong> (<em>struct</em>) -- fiber to be woken up</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Before: <code class="docutils literal"><span class="pre">FIBER_IS_JOINABLE</span></code> flag is set.</p>
<p>See also: <a class="reference internal" href="#c-api-fiber-fiber-set-joinable"><span class="std std-ref">fiber_set_joinable()</span></a></p>
</dd></dl>

<dl class="function">
<dt id="c.fiber_sleep">
void <code class="descname">fiber_sleep</code><big>(</big>double<em>&nbsp;s</em><big>)</big><a class="headerlink" href="#c.fiber_sleep" title="Ссылка на это определение">¶</a></dt>
<dd><p>Put the current fiber to sleep for at least 's' seconds.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>s</strong> (<em>double</em>) -- time to sleep</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Note: this is a cancellation point.</p>
<p>See also: <a class="reference internal" href="#c-api-fiber-fiber-is-cancelled"><span class="std std-ref">fiber_is_cancelled()</span></a></p>
</dd></dl>

<span class="target" id="c-api-fiber-fiber-is-cancelled"></span><dl class="function">
<dt id="c.fiber_is_cancelled">
bool <code class="descname">fiber_is_cancelled</code><big>(</big><big>)</big><a class="headerlink" href="#c.fiber_is_cancelled" title="Ссылка на это определение">¶</a></dt>
<dd><p>Check current fiber for cancellation (it must be checked manually).</p>
</dd></dl>

<dl class="function">
<dt id="c.fiber_time">
double <code class="descname">fiber_time</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.fiber_time" title="Ссылка на это определение">¶</a></dt>
<dd><p>Report loop begin time as double (cheap).</p>
</dd></dl>

<dl class="function">
<dt id="c.fiber_time64">
uint64_t <code class="descname">fiber_time64</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.fiber_time64" title="Ссылка на это определение">¶</a></dt>
<dd><p>Report loop begin time as 64-bit int.</p>
</dd></dl>

<dl class="function">
<dt id="c.fiber_reschedule">
void <code class="descname">fiber_reschedule</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.fiber_reschedule" title="Ссылка на это определение">¶</a></dt>
<dd><p>Reschedule fiber to end of event loop cycle.</p>
</dd></dl>

<dl class="type">
<dt id="c.slab_cache">
struct <code class="descname">slab_cache</code><a class="headerlink" href="#c.slab_cache" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="c.cord_slab_cache">
struct <a class="reference internal" href="singlehtml.html#c.slab_cache" title="slab_cache">slab_cache</a> *<code class="descname">cord_slab_cache</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.cord_slab_cache" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return slab_cache suitable to use with <code class="docutils literal"><span class="pre">tarantool/small</span></code> library</p>
</dd></dl>

</div>
<span id="document-reference_capi/box_index"></span><div class="section" id="module-index">
<h3>Модуль <cite>index</cite><a class="headerlink" href="#module-index" title="Ссылка на этот заголовок">¶</a></h3>
<dl class="type">
<dt id="c.box_iterator_t">
<code class="descname">box_iterator_t</code><a class="headerlink" href="#c.box_iterator_t" title="Ссылка на это определение">¶</a></dt>
<dd><p>A space iterator</p>
</dd></dl>

<span class="target" id="c-api-box-index-iterator-type"></span><dl class="enum">
<dt id="_CPPv213iterator_type">
<em class="property">enum </em><code class="descclassname"></code><code class="descname">iterator_type</code><a class="headerlink" href="#_CPPv213iterator_type" title="Ссылка на это определение">¶</a></dt>
<dd><p>Controls how to iterate over tuples in an index. Different index types
support different iterator types. For example, one can start iteration
from a particular value (request key) and then retrieve all tuples where
keys are greater or equal (= GE) to this key.</p>
<p>If iterator type is not supported by the selected index type, iterator
constructor must fail with ER_UNSUPPORTED. To be selectable for primary
key, an index must support at least ITER_EQ and ITER_GE types.</p>
<p>NULL value of request key corresponds to the first or last key in the index,
depending on iteration direction. (first key for GE and GT types, and last
key for LE and LT). Therefore, to iterate over all tuples in an index, one
can use ITER_GE or ITER_LE iteration types with start key equal to NULL.
For ITER_EQ, the key must not be NULL.</p>
<dl class="enumerator">
<dt id="_CPPv27ITER_EQ">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ITER_EQ</code><a class="headerlink" href="#_CPPv27ITER_EQ" title="Ссылка на это определение">¶</a></dt>
<dd><p>key == x ASC order</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv28ITER_REQ">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ITER_REQ</code><a class="headerlink" href="#_CPPv28ITER_REQ" title="Ссылка на это определение">¶</a></dt>
<dd><p>key == x DESC order</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv28ITER_ALL">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ITER_ALL</code><a class="headerlink" href="#_CPPv28ITER_ALL" title="Ссылка на это определение">¶</a></dt>
<dd><p>all tuples</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv27ITER_LT">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ITER_LT</code><a class="headerlink" href="#_CPPv27ITER_LT" title="Ссылка на это определение">¶</a></dt>
<dd><p>key &lt; x</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv27ITER_LE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ITER_LE</code><a class="headerlink" href="#_CPPv27ITER_LE" title="Ссылка на это определение">¶</a></dt>
<dd><p>key &lt;= x</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv27ITER_GE">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ITER_GE</code><a class="headerlink" href="#_CPPv27ITER_GE" title="Ссылка на это определение">¶</a></dt>
<dd><p>key &gt;= x</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv27ITER_GT">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ITER_GT</code><a class="headerlink" href="#_CPPv27ITER_GT" title="Ссылка на это определение">¶</a></dt>
<dd><p>key &gt; x</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv217ITER_BITS_ALL_SET">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ITER_BITS_ALL_SET</code><a class="headerlink" href="#_CPPv217ITER_BITS_ALL_SET" title="Ссылка на это определение">¶</a></dt>
<dd><p>all bits from x are set in key</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv217ITER_BITS_ANY_SET">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ITER_BITS_ANY_SET</code><a class="headerlink" href="#_CPPv217ITER_BITS_ANY_SET" title="Ссылка на это определение">¶</a></dt>
<dd><p>at least one x's bit is set</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv221ITER_BITS_ALL_NOT_SET">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ITER_BITS_ALL_NOT_SET</code><a class="headerlink" href="#_CPPv221ITER_BITS_ALL_NOT_SET" title="Ссылка на это определение">¶</a></dt>
<dd><p>all bits are not set</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv213ITER_OVERLAPS">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ITER_OVERLAPS</code><a class="headerlink" href="#_CPPv213ITER_OVERLAPS" title="Ссылка на это определение">¶</a></dt>
<dd><p>key overlaps x</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv213ITER_NEIGHBOR">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">ITER_NEIGHBOR</code><a class="headerlink" href="#_CPPv213ITER_NEIGHBOR" title="Ссылка на это определение">¶</a></dt>
<dd><p>tuples in distance ascending order from specified point</p>
</dd></dl>

</dd></dl>

<span class="target" id="c-api-box-index-box-index-iterator"></span><dl class="function">
<dt id="c.box_index_iterator">
<a class="reference internal" href="singlehtml.html#c.box_iterator_t" title="box_iterator_t">box_iterator_t</a> *<code class="descname">box_index_iterator</code><big>(</big>uint32_t<em>&nbsp;space_id</em>, uint32_t<em>&nbsp;index_id</em>, int<em>&nbsp;type</em>, const char<em>&nbsp;*key</em>, const char<em>&nbsp;*key_end</em><big>)</big><a class="headerlink" href="#c.box_index_iterator" title="Ссылка на это определение">¶</a></dt>
<dd><p>Allocate and initialize iterator for space_id, index_id.</p>
<p>The returned iterator must be destroyed by
<a class="reference internal" href="#c-api-box-index-box-iterator-free"><span class="std std-ref">box_iterator_free</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>space_id</strong> (<em>uint32_t</em>) -- space identifier</li>
<li><strong>index_id</strong> (<em>uint32_t</em>) -- index identifier</li>
<li><strong>type</strong> (<em>int</em>) -- <a class="reference internal" href="#c-api-box-index-iterator-type"><span class="std std-ref">iterator_type</span></a></li>
<li><strong>char*     key</strong> (<em>const</em>) -- encode key in MsgPack Array format ([part1, part2, ...])</li>
<li><strong>char* key_end</strong> (<em>const</em>) -- the end of encoded <code class="docutils literal"><span class="pre">key</span></code></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">NULL on error (check :ref:box_error_last`c_api-error-box_error_last&gt;`)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">iterator otherwise</p>
</td>
</tr>
</tbody>
</table>
<p>See also <a class="reference internal" href="#c-api-box-index-box-iterator-next"><span class="std std-ref">box_iterator_next</span></a>,
<a class="reference internal" href="#c-api-box-index-box-iterator-free"><span class="std std-ref">box_iterator_free</span></a></p>
</dd></dl>

<span class="target" id="c-api-box-index-box-iterator-next"></span><dl class="function">
<dt id="c.box_iterator_next">
int <code class="descname">box_iterator_next</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_iterator_t" title="box_iterator_t">box_iterator_t</a><em>&nbsp;*iterator</em>, <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;**result</em><big>)</big><a class="headerlink" href="#c.box_iterator_next" title="Ссылка на это определение">¶</a></dt>
<dd><p>Retrieve the next item from the <code class="docutils literal"><span class="pre">iterator</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>iterator</strong> (<a class="reference internal" href="singlehtml.html#c.box_iterator_t" title="box_iterator_t"><em>box_iterator_t*</em></a>) -- an iterator returned by
:ref:box_index_iterator`c_api-box_index-box_index_iterator&gt;`</li>
<li><strong>result</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t**</em></a>) -- output argument. result a tuple or NULL if
there is no more data.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">-1 on error (check :ref:box_error_last`c_api-error-box_error_last&gt;`)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">0 on success. The end of data is not an error.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="c-api-box-index-box-iterator-free"></span><dl class="function">
<dt id="c.box_iterator_free">
void <code class="descname">box_iterator_free</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_iterator_t" title="box_iterator_t">box_iterator_t</a><em>&nbsp;*iterator</em><big>)</big><a class="headerlink" href="#c.box_iterator_free" title="Ссылка на это определение">¶</a></dt>
<dd><p>Destroy and deallocate iterator.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>iterator</strong> (<a class="reference internal" href="singlehtml.html#c.box_iterator_t" title="box_iterator_t"><em>box_iterator_t*</em></a>) -- an iterator returned by
:ref:box_index_iterator`c_api-box_index-box_index_iterator&gt;`</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_index_len">
ssize_t <code class="descname">box_index_len</code><big>(</big>uint32_t<em>&nbsp;space_id</em>, uint32_t<em>&nbsp;index_id</em><big>)</big><a class="headerlink" href="#c.box_index_len" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the number of element in the index.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>space_id</strong> (<em>uint32_t</em>) -- space identifier</li>
<li><strong>index_id</strong> (<em>uint32_t</em>) -- index identifier</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">-1 on error (check :ref:box_error_last`c_api-error-box_error_last&gt;`)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">&gt;= 0 otherwise</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_index_bsize">
ssize_t <code class="descname">box_index_bsize</code><big>(</big>uint32_t<em>&nbsp;space_id</em>, uint32_t<em>&nbsp;index_id</em><big>)</big><a class="headerlink" href="#c.box_index_bsize" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the number of bytes used in memory by the index.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>space_id</strong> (<em>uint32_t</em>) -- space identifier</li>
<li><strong>index_id</strong> (<em>uint32_t</em>) -- index identifier</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">-1 on error (check :ref:box_error_last`c_api-error-box_error_last&gt;`)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">&gt;= 0 otherwise</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_index_random">
int <code class="descname">box_index_random</code><big>(</big>uint32_t<em>&nbsp;space_id</em>, uint32_t<em>&nbsp;index_id</em>, uint32_t<em>&nbsp;rnd</em>, <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;**result</em><big>)</big><a class="headerlink" href="#c.box_index_random" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return a random tuple from the index (useful for statistical analysis).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>space_id</strong> (<em>uint32_t</em>) -- space identifier</li>
<li><strong>index_id</strong> (<em>uint32_t</em>) -- index identifier</li>
<li><strong>rnd</strong> (<em>uint32_t</em>) -- random seed</li>
<li><strong>result</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t**</em></a>) -- output argument. result a tuple or NULL if
there is no tuples in space</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>See also: <a class="reference internal" href="singlehtml.html#box-index-random"><span class="std std-ref">index_object.random</span></a></p>
</dd></dl>

<dl class="function">
<dt id="c.box_index_get">
int <code class="descname">box_index_get</code><big>(</big>uint32_t<em>&nbsp;space_id</em>, uint32_t<em>&nbsp;index_id</em>, const char<em>&nbsp;*key</em>, const char<em>&nbsp;*key_end</em>, <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;**result</em><big>)</big><a class="headerlink" href="#c.box_index_get" title="Ссылка на это определение">¶</a></dt>
<dd><p>Get a tuple from index by the key.</p>
<p>Please note that this function works much more faster than
<a class="reference internal" href="singlehtml.html#box-index-select"><span class="std std-ref">index_object.select</span></a> or
<a class="reference internal" href="#c-api-box-index-box-index-iterator"><span class="std std-ref">box_index_iterator</span></a> +
<a class="reference internal" href="#c-api-box-index-box-iterator-next"><span class="std std-ref">box_iterator_next</span></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>space_id</strong> (<em>uint32_t</em>) -- space identifier</li>
<li><strong>index_id</strong> (<em>uint32_t</em>) -- index identifier</li>
<li><strong>char*      key</strong> (<em>const</em>) -- encode key in MsgPack Array format ([part1, part2, ...])</li>
<li><strong>char*  key_end</strong> (<em>const</em>) -- the end of encoded <code class="docutils literal"><span class="pre">key</span></code></li>
<li><strong>result</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t**</em></a>) -- output argument. result a tuple or NULL if
there is no tuples in space</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">-1 on error (check :ref:box_error_last`c_api-error-box_error_last&gt;`)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">0 on success</p>
</td>
</tr>
</tbody>
</table>
<p>See also: <code class="docutils literal"><span class="pre">index_object.get()</span></code></p>
</dd></dl>

<dl class="function">
<dt id="c.box_index_min">
int <code class="descname">box_index_min</code><big>(</big>uint32_t<em>&nbsp;space_id</em>, uint32_t<em>&nbsp;index_id</em>, const char<em>&nbsp;*key</em>, const char<em>&nbsp;*key_end</em>, <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;**result</em><big>)</big><a class="headerlink" href="#c.box_index_min" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return a first (minimal) tuple matched the provided key.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>space_id</strong> (<em>uint32_t</em>) -- space identifier</li>
<li><strong>index_id</strong> (<em>uint32_t</em>) -- index identifier</li>
<li><strong>char*      key</strong> (<em>const</em>) -- encode key in MsgPack Array format ([part1, part2, ...])</li>
<li><strong>char*  key_end</strong> (<em>const</em>) -- the end of encoded <code class="docutils literal"><span class="pre">key</span></code></li>
<li><strong>result</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t**</em></a>) -- output argument. result a tuple or NULL if
there is no tuples in space</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">-1 on error (check :ref:box_error_last()`c_api-error-box_error_last&gt;`)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">0 on success</p>
</td>
</tr>
</tbody>
</table>
<p>See also: <a class="reference internal" href="singlehtml.html#box-index-min"><span class="std std-ref">index_object.min()</span></a></p>
</dd></dl>

<dl class="function">
<dt id="c.box_index_max">
int <code class="descname">box_index_max</code><big>(</big>uint32_t<em>&nbsp;space_id</em>, uint32_t<em>&nbsp;index_id</em>, const char<em>&nbsp;*key</em>, const char<em>&nbsp;*key_end</em>, <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;**result</em><big>)</big><a class="headerlink" href="#c.box_index_max" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return a last (maximal) tuple matched the provided key.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>space_id</strong> (<em>uint32_t</em>) -- space identifier</li>
<li><strong>index_id</strong> (<em>uint32_t</em>) -- index identifier</li>
<li><strong>char*      key</strong> (<em>const</em>) -- encode key in MsgPack Array format ([part1, part2, ...])</li>
<li><strong>char*  key_end</strong> (<em>const</em>) -- the end of encoded <code class="docutils literal"><span class="pre">key</span></code></li>
<li><strong>result</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t**</em></a>) -- output argument. result a tuple or NULL if
there is no tuples in space</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">-1 on error (check :ref:box_error_last()`c_api-error-box_error_last&gt;`)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">0 on success</p>
</td>
</tr>
</tbody>
</table>
<p>See also: <a class="reference internal" href="singlehtml.html#box-index-max"><span class="std std-ref">index_object.max()</span></a></p>
</dd></dl>

<dl class="function">
<dt id="c.box_index_count">
ssize_t <code class="descname">box_index_count</code><big>(</big>uint32_t<em>&nbsp;space_id</em>, uint32_t<em>&nbsp;index_id</em>, int<em>&nbsp;type</em>, const char<em>&nbsp;*key</em>, const char<em>&nbsp;*key_end</em><big>)</big><a class="headerlink" href="#c.box_index_count" title="Ссылка на это определение">¶</a></dt>
<dd><p>Count the number of tuple matched the provided key.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>space_id</strong> (<em>uint32_t</em>) -- space identifier</li>
<li><strong>index_id</strong> (<em>uint32_t</em>) -- index identifier</li>
<li><strong>type</strong> (<em>int</em>) -- <a class="reference internal" href="#c-api-box-index-iterator-type"><span class="std std-ref">iterator_type</span></a></li>
<li><strong>char*     key</strong> (<em>const</em>) -- encode key in MsgPack Array format ([part1, part2, ...])</li>
<li><strong>char* key_end</strong> (<em>const</em>) -- the end of encoded <code class="docutils literal"><span class="pre">key</span></code></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">-1 on error (check :ref:box_error_last()`c_api-error-box_error_last&gt;`)</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">0 on success</p>
</td>
</tr>
</tbody>
</table>
<p>See also: <a class="reference internal" href="singlehtml.html#box-index-count"><span class="std std-ref">index_object.count()</span></a></p>
</dd></dl>

</div>
<span id="document-reference_capi/latch"></span><div class="section" id="module-latch">
<h3>Модуль <cite>latch</cite><a class="headerlink" href="#module-latch" title="Ссылка на этот заголовок">¶</a></h3>
<dl class="type">
<dt id="c.box_latch_t">
<code class="descname">box_latch_t</code><a class="headerlink" href="#c.box_latch_t" title="Ссылка на это определение">¶</a></dt>
<dd><p>A lock for cooperative multitasking environment</p>
</dd></dl>

<dl class="function">
<dt id="c.box_latch_new">
<a class="reference internal" href="singlehtml.html#c.box_latch_t" title="box_latch_t">box_latch_t</a> *<code class="descname">box_latch_new</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.box_latch_new" title="Ссылка на это определение">¶</a></dt>
<dd><p>Allocate and initialize the new latch.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body">allocated latch object</td>
</tr>
<tr class="field-even field"><th class="field-name">Тип результата:</th><td class="field-body">box_latch_t *</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_latch_delete">
void <code class="descname">box_latch_delete</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_latch_t" title="box_latch_t">box_latch_t</a><em>&nbsp;*latch</em><big>)</big><a class="headerlink" href="#c.box_latch_delete" title="Ссылка на это определение">¶</a></dt>
<dd><p>Destroy and free the latch.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>latch</strong> (<a class="reference internal" href="singlehtml.html#c.box_latch_t" title="box_latch_t"><em>box_latch_t*</em></a>) -- latch to destroy</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_latch_lock">
void <code class="descname">box_latch_lock</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_latch_t" title="box_latch_t">box_latch_t</a><em>&nbsp;*latch</em><big>)</big><a class="headerlink" href="#c.box_latch_lock" title="Ссылка на это определение">¶</a></dt>
<dd><p>Lock a latch. Waits indefinitely until the current fiber can gain access to
the latch.</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">param box_latch_t* latch:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body">latch to lock</td>
</tr>
</tbody>
</table>
</div></blockquote>
</dd></dl>

<dl class="function">
<dt id="c.box_latch_trylock">
int <code class="descname">box_latch_trylock</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_latch_t" title="box_latch_t">box_latch_t</a><em>&nbsp;*latch</em><big>)</big><a class="headerlink" href="#c.box_latch_trylock" title="Ссылка на это определение">¶</a></dt>
<dd><p>Try to lock a latch. Return immediately if the latch is locked.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>latch</strong> (<a class="reference internal" href="singlehtml.html#c.box_latch_t" title="box_latch_t"><em>box_latch_t*</em></a>) -- latch to lock</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">status of operation. 0 - success, 1 - latch is locked</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Тип результата:</th><td class="field-body"><p class="first last">int</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_latch_unlock">
void <code class="descname">box_latch_unlock</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_latch_t" title="box_latch_t">box_latch_t</a><em>&nbsp;*latch</em><big>)</big><a class="headerlink" href="#c.box_latch_unlock" title="Ссылка на это определение">¶</a></dt>
<dd><p>Unlock a latch. The fiber calling this function must own the latch.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>latch</strong> (<a class="reference internal" href="singlehtml.html#c.box_latch_t" title="box_latch_t"><em>box_latch_t*</em></a>) -- latch to unlock</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<span id="document-reference_capi/utils"></span><div class="section" id="module-lua-utils">
<h3>Модуль <cite>lua/utils</cite><a class="headerlink" href="#module-lua-utils" title="Ссылка на этот заголовок">¶</a></h3>
<span class="target" id="c-api-utils-lual-pushcdata"></span><dl class="function">
<dt id="c.luaL_pushcdata">
void *<code class="descname">luaL_pushcdata</code><big>(</big>struct lua_State<em>&nbsp;*L</em>, uint32_t<em>&nbsp;ctypeid</em><big>)</big><a class="headerlink" href="#c.luaL_pushcdata" title="Ссылка на это определение">¶</a></dt>
<dd><p>Push cdata of given <code class="docutils literal"><span class="pre">ctypeid</span></code> onto the stack.</p>
<p>CTypeID must be used from FFI at least once. Allocated memory returned
uninitialized. Only numbers and pointers are supported.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>L</strong> (<em>lua_State*</em>) -- Lua State</li>
<li><strong>ctypeid</strong> (<em>uint32_t</em>) -- FFI's CTypeID of this cdata</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">memory associated with this cdata</p>
</td>
</tr>
</tbody>
</table>
<p>See also: <a class="reference internal" href="#c-api-utils-lual-checkcdata"><span class="std std-ref">luaL_checkcdata()</span></a></p>
</dd></dl>

<span class="target" id="c-api-utils-lual-checkcdata"></span><dl class="function">
<dt id="c.luaL_checkcdata">
void *<code class="descname">luaL_checkcdata</code><big>(</big>struct lua_State<em>&nbsp;*L</em>, int<em>&nbsp;idx</em>, uint32_t<em>&nbsp;*ctypeid</em><big>)</big><a class="headerlink" href="#c.luaL_checkcdata" title="Ссылка на это определение">¶</a></dt>
<dd><p>Checks whether the function argument <code class="docutils literal"><span class="pre">idx</span></code> is a cdata</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>L</strong> (<em>lua_State*</em>) -- Lua State</li>
<li><strong>idx</strong> (<em>int</em>) -- stack index</li>
<li><strong>ctypeid</strong> (<em>uint32_t*</em>) -- output argument. FFI's CTypeID of returned cdata</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">memory associated with this cdata</p>
</td>
</tr>
</tbody>
</table>
<p>See also: <a class="reference internal" href="#c-api-utils-lual-pushcdata"><span class="std std-ref">luaL_pushcdata()</span></a></p>
</dd></dl>

<dl class="function">
<dt id="c.luaL_setcdatagc">
void <code class="descname">luaL_setcdatagc</code><big>(</big>struct lua_State<em>&nbsp;*L</em>, int<em>&nbsp;idx</em><big>)</big><a class="headerlink" href="#c.luaL_setcdatagc" title="Ссылка на это определение">¶</a></dt>
<dd><p>Sets finalizer function on a cdata object.</p>
<p>Equivalent to call <cite>ffi.gc(obj, function)</cite>. Finalizer function must be on
the top of the stack.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>L</strong> (<em>lua_State*</em>) -- Lua State</li>
<li><strong>idx</strong> (<em>int</em>) -- stack index</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.luaL_ctypeid">
uint32_t <code class="descname">luaL_ctypeid</code><big>(</big>struct lua_State<em>&nbsp;*L</em>, const char<em>&nbsp;*ctypename</em><big>)</big><a class="headerlink" href="#c.luaL_ctypeid" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return CTypeID (FFI) of given СDATA type</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>L</strong> (<em>lua_State*</em>) -- Lua State</li>
<li><strong>char* ctypename</strong> (<em>const</em>) -- C type name as string (e.g. &quot;struct request&quot;
or &quot;uint32_t&quot;)</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">CTypeID</p>
</td>
</tr>
</tbody>
</table>
<p>See also: <a class="reference internal" href="#c-api-utils-lual-pushcdata"><span class="std std-ref">luaL_pushcdata()</span></a>,
<a class="reference internal" href="#c-api-utils-lual-checkcdata"><span class="std std-ref">luaL_checkcdata()</span></a></p>
</dd></dl>

<dl class="function">
<dt id="c.luaL_cdef">
int <code class="descname">luaL_cdef</code><big>(</big>struct lua_State<em>&nbsp;*L</em>, const char<em>&nbsp;*ctypename</em><big>)</big><a class="headerlink" href="#c.luaL_cdef" title="Ссылка на это определение">¶</a></dt>
<dd><p>Declare symbols for FFI</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>L</strong> (<em>lua_State*</em>) -- Lua State</li>
<li><strong>char* ctypename</strong> (<em>const</em>) -- C definitions (e.g. &quot;struct stat&quot;)</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">0 on success</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last"><code class="docutils literal"><span class="pre">LUA_ERRRUN</span></code>, <code class="docutils literal"><span class="pre">LUA_ERRMEM`</span> <span class="pre">or</span> <span class="pre">``LUA_ERRERR</span></code> otherwise.</p>
</td>
</tr>
</tbody>
</table>
<p>See also: <code class="docutils literal"><span class="pre">ffi.cdef(def)</span></code></p>
</dd></dl>

<dl class="function">
<dt id="c.luaL_pushuint64">
void <code class="descname">luaL_pushuint64</code><big>(</big>struct lua_State<em>&nbsp;*L</em>, uint64_t<em>&nbsp;val</em><big>)</big><a class="headerlink" href="#c.luaL_pushuint64" title="Ссылка на это определение">¶</a></dt>
<dd><p>Push uint64_t onto the stack</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>L</strong> (<em>lua_State*</em>) -- Lua State</li>
<li><strong>val</strong> (<em>uint64_t</em>) -- value to push</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.luaL_pushint64">
void <code class="descname">luaL_pushint64</code><big>(</big>struct lua_State<em>&nbsp;*L</em>, int64_t<em>&nbsp;val</em><big>)</big><a class="headerlink" href="#c.luaL_pushint64" title="Ссылка на это определение">¶</a></dt>
<dd><p>Push int64_t onto the stack</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>L</strong> (<em>lua_State*</em>) -- Lua State</li>
<li><strong>val</strong> (<em>int64_t</em>) -- value to push</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.luaL_checkuint64">
uint64_t <code class="descname">luaL_checkuint64</code><big>(</big>struct lua_State<em>&nbsp;*L</em>, int<em>&nbsp;idx</em><big>)</big><a class="headerlink" href="#c.luaL_checkuint64" title="Ссылка на это определение">¶</a></dt>
<dd><p>Checks whether the argument idx is a uint64 or a convertable string and
returns this number.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Throws:</th><td class="field-body">error if the argument can't be converted</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.luaL_checkint64">
uint64_t <code class="descname">luaL_checkint64</code><big>(</big>struct lua_State<em>&nbsp;*L</em>, int<em>&nbsp;idx</em><big>)</big><a class="headerlink" href="#c.luaL_checkint64" title="Ссылка на это определение">¶</a></dt>
<dd><p>Checks whether the argument idx is a int64 or a convertable string and
returns this number.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Throws:</th><td class="field-body">error if the argument can't be converted</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.luaL_touint64">
uint64_t <code class="descname">luaL_touint64</code><big>(</big>struct lua_State<em>&nbsp;*L</em>, int<em>&nbsp;idx</em><big>)</big><a class="headerlink" href="#c.luaL_touint64" title="Ссылка на это определение">¶</a></dt>
<dd><p>Checks whether the argument idx is a uint64 or a convertable string and
returns this number.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body">the converted number or 0 of argument can't be converted</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.luaL_toint64">
int64_t <code class="descname">luaL_toint64</code><big>(</big>struct lua_State<em>&nbsp;*L</em>, int<em>&nbsp;idx</em><big>)</big><a class="headerlink" href="#c.luaL_toint64" title="Ссылка на это определение">¶</a></dt>
<dd><p>Checks whether the argument idx is a int64 or a convertable string and
returns this number.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body">the converted number or 0 of argument can't be converted</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<span id="document-reference_capi/say"></span><div class="section" id="module-say-logging">
<h3>Модуль <cite>say</cite> (логирование)<a class="headerlink" href="#module-say-logging" title="Ссылка на этот заголовок">¶</a></h3>
<span class="target" id="c-api-say-say-level"></span><dl class="enum">
<dt id="_CPPv29say_level">
<em class="property">enum </em><code class="descclassname"></code><code class="descname">say_level</code><a class="headerlink" href="#_CPPv29say_level" title="Ссылка на это определение">¶</a></dt>
<dd><dl class="enumerator">
<dt id="_CPPv27S_FATAL">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">S_FATAL</code><a class="headerlink" href="#_CPPv27S_FATAL" title="Ссылка на это определение">¶</a></dt>
<dd><p>do not use this value directly</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv210S_SYSERROR">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">S_SYSERROR</code><a class="headerlink" href="#_CPPv210S_SYSERROR" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv27S_ERROR">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">S_ERROR</code><a class="headerlink" href="#_CPPv27S_ERROR" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv26S_CRIT">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">S_CRIT</code><a class="headerlink" href="#_CPPv26S_CRIT" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv26S_WARN">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">S_WARN</code><a class="headerlink" href="#_CPPv26S_WARN" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv26S_INFO">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">S_INFO</code><a class="headerlink" href="#_CPPv26S_INFO" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="enumerator">
<dt id="_CPPv27S_DEBUG">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">S_DEBUG</code><a class="headerlink" href="#_CPPv27S_DEBUG" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<dl class="macro">
<dt id="c.say">
<code class="descname">say</code><big>(</big>level, format, ...<big>)</big><a class="headerlink" href="#c.say" title="Ссылка на это определение">¶</a></dt>
<dd><p>Format and print a message to Tarantool log file.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>level</strong> (<em>int</em>) -- <a class="reference internal" href="#c-api-say-say-level"><span class="std std-ref">log level</span></a></li>
<li><strong>char* format</strong> (<em>const</em>) -- <code class="docutils literal"><span class="pre">printf()</span></code>-like format string</li>
<li><strong>...</strong> -- format arguments</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>See also <em class="manpage">printf(3)</em>, <a class="reference internal" href="#c-api-say-say-level"><span class="std std-ref">say_level</span></a></p>
</dd></dl>

<dl class="macro">
<dt id="c.say_error">
<code class="descname">say_error</code><big>(</big>format, ...<big>)</big><a class="headerlink" href="#c.say_error" title="Ссылка на это определение">¶</a></dt>
<dt id="c.say_crit">
<code class="descname">say_crit</code><big>(</big>format, ...<big>)</big><a class="headerlink" href="#c.say_crit" title="Ссылка на это определение">¶</a></dt>
<dt id="c.say_warn">
<code class="descname">say_warn</code><big>(</big>format, ...<big>)</big><a class="headerlink" href="#c.say_warn" title="Ссылка на это определение">¶</a></dt>
<dt id="c.say_info">
<code class="descname">say_info</code><big>(</big>format, ...<big>)</big><a class="headerlink" href="#c.say_info" title="Ссылка на это определение">¶</a></dt>
<dt id="c.say_debug">
<code class="descname">say_debug</code><big>(</big>format, ...<big>)</big><a class="headerlink" href="#c.say_debug" title="Ссылка на это определение">¶</a></dt>
<dt id="c.say_syserror">
<code class="descname">say_syserror</code><big>(</big>format, ...<big>)</big><a class="headerlink" href="#c.say_syserror" title="Ссылка на это определение">¶</a></dt>
<dd><p>Format and print a message to Tarantool log file.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>char* format</strong> (<em>const</em>) -- <code class="docutils literal"><span class="pre">printf()</span></code>-like format string</li>
<li><strong>...</strong> -- format arguments</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>See also <em class="manpage">printf(3)</em>, <a class="reference internal" href="#c-api-say-say-level"><span class="std std-ref">say_level</span></a></p>
<p><strong>Example:</strong></p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">say_info</span><span class="p">(</span><span class="s">&quot;Some useful information: %s&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
</pre></div>
</div>
</dd></dl>

</div>
<span id="document-reference_capi/schema"></span><div class="section" id="lua-module.schema">
<span id="module-schema"></span><h3>Модуль <cite>schema</cite><a class="headerlink" href="#lua-module.schema" title="Ссылка на этот заголовок">¶</a></h3>
<dl class="enum">
<dt id="_CPPv26SCHEMA">
<em class="property">enum </em><code class="descclassname"></code><code class="descname">SCHEMA</code><a class="headerlink" href="#_CPPv26SCHEMA" title="Ссылка на это определение">¶</a></dt>
<dd><dl class="enumerator">
<dt id="_CPPv217BOX_SYSTEM_ID_MIN">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">BOX_SYSTEM_ID_MIN</code><a class="headerlink" href="#_CPPv217BOX_SYSTEM_ID_MIN" title="Ссылка на это определение">¶</a></dt>
<dd><p>Start of the reserved range of system spaces.</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv213BOX_SCHEMA_ID">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">BOX_SCHEMA_ID</code><a class="headerlink" href="#_CPPv213BOX_SCHEMA_ID" title="Ссылка на это определение">¶</a></dt>
<dd><p>Space id of _schema.</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv212BOX_SPACE_ID">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">BOX_SPACE_ID</code><a class="headerlink" href="#_CPPv212BOX_SPACE_ID" title="Ссылка на это определение">¶</a></dt>
<dd><p>Space id of _space.</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv213BOX_VSPACE_ID">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">BOX_VSPACE_ID</code><a class="headerlink" href="#_CPPv213BOX_VSPACE_ID" title="Ссылка на это определение">¶</a></dt>
<dd><p>Space id of _vspace view.</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv212BOX_INDEX_ID">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">BOX_INDEX_ID</code><a class="headerlink" href="#_CPPv212BOX_INDEX_ID" title="Ссылка на это определение">¶</a></dt>
<dd><p>Space id of _index.</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv213BOX_VINDEX_ID">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">BOX_VINDEX_ID</code><a class="headerlink" href="#_CPPv213BOX_VINDEX_ID" title="Ссылка на это определение">¶</a></dt>
<dd><p>Space id of _vindex view.</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv211BOX_FUNC_ID">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">BOX_FUNC_ID</code><a class="headerlink" href="#_CPPv211BOX_FUNC_ID" title="Ссылка на это определение">¶</a></dt>
<dd><p>Space id of _func.</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv212BOX_VFUNC_ID">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">BOX_VFUNC_ID</code><a class="headerlink" href="#_CPPv212BOX_VFUNC_ID" title="Ссылка на это определение">¶</a></dt>
<dd><p>Space id of _vfunc view.</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv211BOX_USER_ID">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">BOX_USER_ID</code><a class="headerlink" href="#_CPPv211BOX_USER_ID" title="Ссылка на это определение">¶</a></dt>
<dd><p>Space id of _user.</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv212BOX_VUSER_ID">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">BOX_VUSER_ID</code><a class="headerlink" href="#_CPPv212BOX_VUSER_ID" title="Ссылка на это определение">¶</a></dt>
<dd><p>Space id of _vuser view.</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv211BOX_PRIV_ID">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">BOX_PRIV_ID</code><a class="headerlink" href="#_CPPv211BOX_PRIV_ID" title="Ссылка на это определение">¶</a></dt>
<dd><p>Space id of _priv.</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv212BOX_VPRIV_ID">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">BOX_VPRIV_ID</code><a class="headerlink" href="#_CPPv212BOX_VPRIV_ID" title="Ссылка на это определение">¶</a></dt>
<dd><p>Space id of _vpriv view.</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv214BOX_CLUSTER_ID">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">BOX_CLUSTER_ID</code><a class="headerlink" href="#_CPPv214BOX_CLUSTER_ID" title="Ссылка на это определение">¶</a></dt>
<dd><p>Space id of _cluster.</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv217BOX_SYSTEM_ID_MAX">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">BOX_SYSTEM_ID_MAX</code><a class="headerlink" href="#_CPPv217BOX_SYSTEM_ID_MAX" title="Ссылка на это определение">¶</a></dt>
<dd><p>End of reserved range of system spaces.</p>
</dd></dl>

<dl class="enumerator">
<dt id="_CPPv210BOX_ID_NIL">
<em class="property">enumerator </em><code class="descclassname"></code><code class="descname">BOX_ID_NIL</code><a class="headerlink" href="#_CPPv210BOX_ID_NIL" title="Ссылка на это определение">¶</a></dt>
<dd><p>NULL value, returned on error.</p>
</dd></dl>

</dd></dl>

</div>
<span id="document-reference_capi/trivia"></span><div class="section" id="module-trivia-config">
<h3>Модуль <cite>trivia/config</cite><a class="headerlink" href="#module-trivia-config" title="Ссылка на этот заголовок">¶</a></h3>
<dl class="macro">
<dt id="c.API_EXPORT">
<code class="descname">API_EXPORT</code><a class="headerlink" href="#c.API_EXPORT" title="Ссылка на это определение">¶</a></dt>
<dd><p>Extern modifier for all public functions.</p>
</dd></dl>

<dl class="macro">
<dt id="c.PACKAGE_VERSION_MAJOR">
<code class="descname">PACKAGE_VERSION_MAJOR</code><a class="headerlink" href="#c.PACKAGE_VERSION_MAJOR" title="Ссылка на это определение">¶</a></dt>
<dd><p>Package major version - 1 for 1.7.0.</p>
</dd></dl>

<dl class="macro">
<dt id="c.PACKAGE_VERSION_MINOR">
<code class="descname">PACKAGE_VERSION_MINOR</code><a class="headerlink" href="#c.PACKAGE_VERSION_MINOR" title="Ссылка на это определение">¶</a></dt>
<dd><p>Package minor version - 7 for 1.7.0.</p>
</dd></dl>

<dl class="macro">
<dt id="c.PACKAGE_VERSION_PATCH">
<code class="descname">PACKAGE_VERSION_PATCH</code><a class="headerlink" href="#c.PACKAGE_VERSION_PATCH" title="Ссылка на это определение">¶</a></dt>
<dd><p>Package patch version - 0 for 1.7.0.</p>
</dd></dl>

<dl class="macro">
<dt id="c.PACKAGE_VERSION">
<code class="descname">PACKAGE_VERSION</code><a class="headerlink" href="#c.PACKAGE_VERSION" title="Ссылка на это определение">¶</a></dt>
<dd><p>A string with major-minor-patch-commit-id identifier of the release, e.g.
1.7.0-1216-g73f7154.</p>
</dd></dl>

<dl class="macro">
<dt id="c.SYSCONF_DIR">
<code class="descname">SYSCONF_DIR</code><a class="headerlink" href="#c.SYSCONF_DIR" title="Ссылка на это определение">¶</a></dt>
<dd><p>System configuration dir (e.g <code class="docutils literal"><span class="pre">/etc</span></code>)</p>
</dd></dl>

<dl class="macro">
<dt id="c.INSTALL_PREFIX">
<code class="descname">INSTALL_PREFIX</code><a class="headerlink" href="#c.INSTALL_PREFIX" title="Ссылка на это определение">¶</a></dt>
<dd><p>Install prefix (e.g. <code class="docutils literal"><span class="pre">/usr</span></code>)</p>
</dd></dl>

<dl class="macro">
<dt id="c.BUILD_TYPE">
<code class="descname">BUILD_TYPE</code><a class="headerlink" href="#c.BUILD_TYPE" title="Ссылка на это определение">¶</a></dt>
<dd><p>Build type, e.g. Debug or Release</p>
</dd></dl>

<dl class="macro">
<dt id="c.BUILD_INFO">
<code class="descname">BUILD_INFO</code><a class="headerlink" href="#c.BUILD_INFO" title="Ссылка на это определение">¶</a></dt>
<dd><p>CMake build type signature, e.g. <code class="docutils literal"><span class="pre">Linux-x86_64-Debug</span></code></p>
</dd></dl>

<dl class="macro">
<dt id="c.BUILD_OPTIONS">
<code class="descname">BUILD_OPTIONS</code><a class="headerlink" href="#c.BUILD_OPTIONS" title="Ссылка на это определение">¶</a></dt>
<dd><p>Command line used to run CMake.</p>
</dd></dl>

<dl class="macro">
<dt id="c.COMPILER_INFO">
<code class="descname">COMPILER_INFO</code><a class="headerlink" href="#c.COMPILER_INFO" title="Ссылка на это определение">¶</a></dt>
<dd><p>Pathes to C and CXX compilers.</p>
</dd></dl>

<dl class="macro">
<dt id="c.TARANTOOL_C_FLAGS">
<code class="descname">TARANTOOL_C_FLAGS</code><a class="headerlink" href="#c.TARANTOOL_C_FLAGS" title="Ссылка на это определение">¶</a></dt>
<dd><p>C compile flags used to build Tarantool.</p>
</dd></dl>

<dl class="macro">
<dt id="c.TARANTOOL_CXX_FLAGS">
<code class="descname">TARANTOOL_CXX_FLAGS</code><a class="headerlink" href="#c.TARANTOOL_CXX_FLAGS" title="Ссылка на это определение">¶</a></dt>
<dd><p>CXX compile flags used to build Tarantool.</p>
</dd></dl>

<dl class="macro">
<dt id="c.MODULE_LIBDIR">
<code class="descname">MODULE_LIBDIR</code><a class="headerlink" href="#c.MODULE_LIBDIR" title="Ссылка на это определение">¶</a></dt>
<dd><p>A path to install <code class="docutils literal"><span class="pre">*.lua</span></code> module files.</p>
</dd></dl>

<dl class="macro">
<dt id="c.MODULE_LUADIR">
<code class="descname">MODULE_LUADIR</code><a class="headerlink" href="#c.MODULE_LUADIR" title="Ссылка на это определение">¶</a></dt>
<dd><p>A path to install <code class="docutils literal"><span class="pre">*.so</span></code>/<code class="docutils literal"><span class="pre">*.dylib</span></code> module files.</p>
</dd></dl>

<dl class="macro">
<dt id="c.MODULE_INCLUDEDIR">
<code class="descname">MODULE_INCLUDEDIR</code><a class="headerlink" href="#c.MODULE_INCLUDEDIR" title="Ссылка на это определение">¶</a></dt>
<dd><p>A path to Lua includes (the same directory where this file is contained)</p>
</dd></dl>

<dl class="macro">
<dt id="c.MODULE_LUAPATH">
<code class="descname">MODULE_LUAPATH</code><a class="headerlink" href="#c.MODULE_LUAPATH" title="Ссылка на это определение">¶</a></dt>
<dd><p>A constant added to <code class="docutils literal"><span class="pre">package.path</span></code> in Lua to find <code class="docutils literal"><span class="pre">*.lua</span></code> module files.</p>
</dd></dl>

<dl class="macro">
<dt id="c.MODULE_LIBPATH">
<code class="descname">MODULE_LIBPATH</code><a class="headerlink" href="#c.MODULE_LIBPATH" title="Ссылка на это определение">¶</a></dt>
<dd><p>A constant added to <code class="docutils literal"><span class="pre">package.cpath</span></code> in Lua to find <code class="docutils literal"><span class="pre">*.so</span></code> module files.</p>
</dd></dl>

</div>
<span id="document-reference_capi/tuple"></span><div class="section" id="module-tuple">
<h3>Модуль <cite>tuple</cite><a class="headerlink" href="#module-tuple" title="Ссылка на этот заголовок">¶</a></h3>
<dl class="type">
<dt id="c.box_tuple_format_t">
<code class="descname">box_tuple_format_t</code><a class="headerlink" href="#c.box_tuple_format_t" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<span class="target" id="c-api-tuple-box-tuple-format-default"></span><dl class="function">
<dt id="c.box_tuple_format_default">
<a class="reference internal" href="singlehtml.html#c.box_tuple_format_t" title="box_tuple_format_t">box_tuple_format_t</a> *<code class="descname">box_tuple_format_default</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.box_tuple_format_default" title="Ссылка на это определение">¶</a></dt>
<dd><p>Tuple format.</p>
<p>Each Tuple has associated format (class). Default format is used to
create tuples which are not attach to any particular space.</p>
</dd></dl>

<dl class="type">
<dt id="c.box_tuple_t">
<code class="descname">box_tuple_t</code><a class="headerlink" href="#c.box_tuple_t" title="Ссылка на это определение">¶</a></dt>
<dd><p>Tuple</p>
</dd></dl>

<span class="target" id="c-api-tuple-box-tuple-new"></span><dl class="function">
<dt id="c.box_tuple_new">
<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a> *<code class="descname">box_tuple_new</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_tuple_format_t" title="box_tuple_format_t">box_tuple_format_t</a><em>&nbsp;*format</em>, const char<em>&nbsp;*tuple</em>, const char<em>&nbsp;*tuple_end</em><big>)</big><a class="headerlink" href="#c.box_tuple_new" title="Ссылка на это определение">¶</a></dt>
<dd><p>Allocate and initialize a new tuple from a raw MsgPack Array data.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>format</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_format_t" title="box_tuple_format_t"><em>box_tuple_format_t*</em></a>) -- tuple format. Use
<a class="reference internal" href="#c-api-tuple-box-tuple-format-default"><span class="std std-ref">box_tuple_format_default()</span></a>
to create space-independent tuple.</li>
<li><strong>char*          tuple</strong> (<em>const</em>) -- tuple data in MsgPack Array format ([field1, field2, ...])</li>
<li><strong>char*      tuple_end</strong> (<em>const</em>) -- the end of <code class="docutils literal"><span class="pre">data</span></code></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">NULL on out of memory</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">tuple otherwise</p>
</td>
</tr>
</tbody>
</table>
<p>See also: <a class="reference internal" href="singlehtml.html#box-tuple-new"><span class="std std-ref">box.tuple.new()</span></a></p>
</dd></dl>

<span class="target" id="c-api-tuple-box-tuple-ref"></span><dl class="function">
<dt id="c.box_tuple_ref">
int <code class="descname">box_tuple_ref</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;*tuple</em><big>)</big><a class="headerlink" href="#c.box_tuple_ref" title="Ссылка на это определение">¶</a></dt>
<dd><p>Increase the reference counter of tuple.</p>
<p>Tuples are reference counted. All functions that return tuples guarantee
that the last returned tuple is refcounted internally until the next
call to API function that yields or returns another tuple.</p>
<p>You should increase the reference counter before taking tuples for long
processing in your code. Such tuples will not be garbage collected even
if another fiber remove they from space. After processing please
decrement the reference counter using
<a class="reference internal" href="#c-api-tuple-box-tuple-unref"><span class="std std-ref">box_tuple_unref()</span></a>,
otherwise the tuple will leak.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>tuple</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t*</em></a>) -- a tuple</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">-1 on error</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">0 otherwise</p>
</td>
</tr>
</tbody>
</table>
<p>See also: <a class="reference internal" href="#c-api-tuple-box-tuple-unref"><span class="std std-ref">box_tuple_unref()</span></a></p>
</dd></dl>

<span class="target" id="c-api-tuple-box-tuple-unref"></span><dl class="function">
<dt id="c.box_tuple_unref">
void <code class="descname">box_tuple_unref</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;*tuple</em><big>)</big><a class="headerlink" href="#c.box_tuple_unref" title="Ссылка на это определение">¶</a></dt>
<dd><p>Decrease the reference counter of tuple.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>tuple</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t*</em></a>) -- a tuple</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">-1 on error</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">0 otherwise</p>
</td>
</tr>
</tbody>
</table>
<p>See also: <a class="reference internal" href="#c-api-tuple-box-tuple-ref"><span class="std std-ref">box_tuple_ref()</span></a></p>
</dd></dl>

<span class="target" id="c-api-tuple-box-tuple-field-count"></span><dl class="function">
<dt id="c.box_tuple_field_count">
uint32_t <code class="descname">box_tuple_field_count</code><big>(</big>const <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;*tuple</em><big>)</big><a class="headerlink" href="#c.box_tuple_field_count" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the number of fields in tuple (the size of MsgPack Array).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>tuple</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t*</em></a>) -- a tuple</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_tuple_bsize">
size_t <code class="descname">box_tuple_bsize</code><big>(</big>const <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;*tuple</em><big>)</big><a class="headerlink" href="#c.box_tuple_bsize" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the number of bytes used to store internal tuple data (MsgPack Array).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>tuple</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t*</em></a>) -- a tuple</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_tuple_to_buf">
ssize_t <code class="descname">box_tuple_to_buf</code><big>(</big>const <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;*tuple</em>, char<em>&nbsp;*buf</em>, size_t<em>&nbsp;size</em><big>)</big><a class="headerlink" href="#c.box_tuple_to_buf" title="Ссылка на это определение">¶</a></dt>
<dd><p>Dump raw MsgPack data to the memory buffer <code class="docutils literal"><span class="pre">buf</span></code> of size <code class="docutils literal"><span class="pre">size</span></code>.</p>
<p>Store tuple fields in the memory buffer.</p>
<p>Upon successful return, the function returns the number of bytes written.
If buffer size is not enough then the return value is the number of bytes
which would have been written if enough space had been available.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body">-1 on error</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body">number of bytes written on success.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_tuple_format">
<a class="reference internal" href="singlehtml.html#c.box_tuple_format_t" title="box_tuple_format_t">box_tuple_format_t</a> *<code class="descname">box_tuple_format</code><big>(</big>const <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;*tuple</em><big>)</big><a class="headerlink" href="#c.box_tuple_format" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the associated format.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>tuple</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t*</em></a>) -- a tuple</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">tuple format</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_tuple_field">
const char *<code class="descname">box_tuple_field</code><big>(</big>const <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;*tuple</em>, uint32_t<em>&nbsp;field_id</em><big>)</big><a class="headerlink" href="#c.box_tuple_field" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the raw tuple field in MsgPack format.</p>
<p>The buffer is valid until next call to box_tuple_* functions.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>tuple</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t"><em>box_tuple_t*</em></a>) -- a tuple</li>
<li><strong>field_id</strong> (<em>uint32_t</em>) -- zero-based index in MsgPack array.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">NULL if i &gt;= <a class="reference internal" href="#c-api-tuple-box-tuple-field-count"><span class="std std-ref">box_tuple_field_count()</span></a></p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">msgpack otherwise</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="type">
<dt id="c.box_tuple_iterator_t">
<code class="descname">box_tuple_iterator_t</code><a class="headerlink" href="#c.box_tuple_iterator_t" title="Ссылка на это определение">¶</a></dt>
<dd><p>Tuple iterator</p>
</dd></dl>

<dl class="function">
<dt id="c.box_tuple_iterator">
<a class="reference internal" href="singlehtml.html#c.box_tuple_iterator_t" title="box_tuple_iterator_t">box_tuple_iterator_t</a> *<code class="descname">box_tuple_iterator</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;*tuple</em><big>)</big><a class="headerlink" href="#c.box_tuple_iterator" title="Ссылка на это определение">¶</a></dt>
<dd><p>Allocate and initialize a new tuple iterator. The tuple iterator allow to
iterate over fields at root level of MsgPack array.</p>
<p><strong>Example:</strong></p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">box_tuple_iterator_t</span><span class="o">*</span> <span class="n">it</span> <span class="o">=</span> <span class="n">box_tuple_iterator</span><span class="p">(</span><span class="n">tuple</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// error handling using box_error_last()</span>
<span class="p">}</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">field</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="n">field</span> <span class="o">=</span> <span class="n">box_tuple_next</span><span class="p">(</span><span class="n">it</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// process raw MsgPack data</span>
<span class="p">}</span>

<span class="c1">// rewind iterator to first position</span>
<span class="n">box_tuple_rewind</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
<span class="n">assert</span><span class="p">(</span><span class="n">box_tuple_position</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

<span class="c1">// rewind three fields</span>
<span class="n">field</span> <span class="o">=</span> <span class="n">box_tuple_seek</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">assert</span><span class="p">(</span><span class="n">box_tuple_position</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">);</span>

<span class="n">box_iterator_free</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="c.box_tuple_iterator_free">
void <code class="descname">box_tuple_iterator_free</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_tuple_iterator_t" title="box_tuple_iterator_t">box_tuple_iterator_t</a><em>&nbsp;*it</em><big>)</big><a class="headerlink" href="#c.box_tuple_iterator_free" title="Ссылка на это определение">¶</a></dt>
<dd><p>Destroy and free tuple iterator</p>
</dd></dl>

<span class="target" id="c-api-tuple-box-tuple-position"></span><dl class="function">
<dt id="c.box_tuple_position">
uint32_t <code class="descname">box_tuple_position</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_tuple_iterator_t" title="box_tuple_iterator_t">box_tuple_iterator_t</a><em>&nbsp;*it</em><big>)</big><a class="headerlink" href="#c.box_tuple_position" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return zero-based next position in iterator. That is, this function
return the field id of field that will be returned by the next call
to <a class="reference internal" href="#c-api-tuple-box-tuple-next"><span class="std std-ref">box_tuple_next()</span></a>.
Returned value is zero after initialization
or rewind and <a class="reference internal" href="#c-api-tuple-box-tuple-field-count"><span class="std std-ref">box_tuple_field_count()</span></a>
after the end of iteration.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>it</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_iterator_t" title="box_tuple_iterator_t"><em>box_tuple_iterator_t*</em></a>) -- a tuple iterator</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">position</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_tuple_rewind">
void <code class="descname">box_tuple_rewind</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_tuple_iterator_t" title="box_tuple_iterator_t">box_tuple_iterator_t</a><em>&nbsp;*it</em><big>)</big><a class="headerlink" href="#c.box_tuple_rewind" title="Ссылка на это определение">¶</a></dt>
<dd><p>Rewind iterator to the initial position.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>it</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_iterator_t" title="box_tuple_iterator_t"><em>box_tuple_iterator_t*</em></a>) -- a tuple iterator</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>After: <code class="docutils literal"><span class="pre">box_tuple_position(it)</span> <span class="pre">==</span> <span class="pre">0</span></code></p>
</dd></dl>

<dl class="function">
<dt id="c.box_tuple_seek">
const char *<code class="descname">box_tuple_seek</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_tuple_iterator_t" title="box_tuple_iterator_t">box_tuple_iterator_t</a><em>&nbsp;*it</em>, uint32_t<em>&nbsp;field_no</em><big>)</big><a class="headerlink" href="#c.box_tuple_seek" title="Ссылка на это определение">¶</a></dt>
<dd><p>Seek the tuple iterator.</p>
<p>The returned buffer is valid until next call to box_tuple_* API.
Requested field_no returned by next call to box_tuple_next(it).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first last simple">
<li><strong>it</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_iterator_t" title="box_tuple_iterator_t"><em>box_tuple_iterator_t*</em></a>) -- a tuple iterator</li>
<li><strong>field_no</strong> (<em>uint32_t</em>) -- field number - zero-based position
in MsgPack array</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>After:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">box_tuple_position(it)</span> <span class="pre">==</span> <span class="pre">field_not</span></code> if returned value is not NULL.</li>
<li><code class="docutils literal"><span class="pre">box_tuple_position(it)</span> <span class="pre">==</span> <span class="pre">box_tuple_field_count(tuple)</span></code> if returned
value is NULL.</li>
</ul>
</dd></dl>

<span class="target" id="c-api-tuple-box-tuple-next"></span><dl class="function">
<dt id="c.box_tuple_next">
const char *<code class="descname">box_tuple_next</code><big>(</big><a class="reference internal" href="singlehtml.html#c.box_tuple_iterator_t" title="box_tuple_iterator_t">box_tuple_iterator_t</a><em>&nbsp;*it</em><big>)</big><a class="headerlink" href="#c.box_tuple_next" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return the next tuple field from tuple iterator.</p>
<p>The returned buffer is valid until next call to box_tuple_* API.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>it</strong> (<a class="reference internal" href="singlehtml.html#c.box_tuple_iterator_t" title="box_tuple_iterator_t"><em>box_tuple_iterator_t*</em></a>) -- </li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body"><p class="first">NULL if there are no more fields</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body"><p class="first last">MsgPack otherwise</p>
</td>
</tr>
</tbody>
</table>
<p>Before: <a class="reference internal" href="#c-api-tuple-box-tuple-position"><span class="std std-ref">box_tuple_position()</span></a>
is zero-based ID of returned field.</p>
<p>After: <code class="docutils literal"><span class="pre">box_tuple_position(it)</span> <span class="pre">==</span> <span class="pre">box_tuple_field_count(tuple)</span></code> if
returned value is NULL.</p>
</dd></dl>

<dl class="function">
<dt id="c.box_tuple_update">
<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a> *<code class="descname">box_tuple_update</code><big>(</big>const <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;*tuple</em>, const char<em>&nbsp;*expr</em>, const char<em>&nbsp;*expr_end</em><big>)</big><a class="headerlink" href="#c.box_tuple_update" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="c.box_tuple_upsert">
<a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a> *<code class="descname">box_tuple_upsert</code><big>(</big>const <a class="reference internal" href="singlehtml.html#c.box_tuple_t" title="box_tuple_t">box_tuple_t</a><em>&nbsp;*tuple</em>, const char<em>&nbsp;*expr</em>, const char<em>&nbsp;*expr_end</em><big>)</big><a class="headerlink" href="#c.box_tuple_upsert" title="Ссылка на это определение">¶</a></dt>
<dd></dd></dl>

</div>
<span id="document-reference_capi/txn"></span><div class="section" id="module-txn">
<h3>Модуль <cite>txn</cite><a class="headerlink" href="#module-txn" title="Ссылка на этот заголовок">¶</a></h3>
<dl class="function">
<dt id="c.box_txn">
bool <code class="descname">box_txn</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.box_txn" title="Ссылка на это определение">¶</a></dt>
<dd><p>Return true if there is an active transaction.</p>
</dd></dl>

<dl class="function">
<dt id="c.box_txn_begin">
int <code class="descname">box_txn_begin</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.box_txn_begin" title="Ссылка на это определение">¶</a></dt>
<dd><p>Begin a transaction in the current fiber.</p>
<p>A transaction is attached to caller fiber, therefore one fiber can have
only one active transaction.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body">0 on success</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body">-1 on error. Perhaps a transaction has already been started</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_txn_commit">
int <code class="descname">box_txn_commit</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.box_txn_commit" title="Ссылка на это определение">¶</a></dt>
<dd><p>Commit the current transaction.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body">0 on success</td>
</tr>
<tr class="field-even field"><th class="field-name">Результат:</th><td class="field-body">-1 on error. Perhaps a disk write failure</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="c.box_txn_rollback">
void <code class="descname">box_txn_rollback</code><big>(</big>void<big>)</big><a class="headerlink" href="#c.box_txn_rollback" title="Ссылка на это определение">¶</a></dt>
<dd><p>Rollback the current transaction.</p>
</dd></dl>

<dl class="function">
<dt id="c.box_txn_alloc">
void *<code class="descname">box_txn_alloc</code><big>(</big>size_t<em>&nbsp;size</em><big>)</big><a class="headerlink" href="#c.box_txn_alloc" title="Ссылка на это определение">¶</a></dt>
<dd><p>Allocate memory on txn memory pool.</p>
<p>The memory is automatically deallocated when the transaction is committed
or rolled back.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Результат:</th><td class="field-body">NULL on out of memory</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
</div>
</div>
<span id="document-dev_guide/index"></span><div class="section" id="contributing">
<h2>Руководство разработчика<a class="headerlink" href="#contributing" title="Ссылка на этот заголовок">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-dev_guide/intro"></span><div class="section" id="what-documentation-there-is">
<h3>Состав документации<a class="headerlink" href="#what-documentation-there-is" title="Ссылка на этот заголовок">¶</a></h3>
<p>Tarantool documentation consists of:</p>
<ul class="simple">
<li>a user guide</li>
<li>developer guide (you're reading it)</li>
<li>coding style guide for C, Python (for other connectors,
we use conventions of the connector programming language community)</li>
</ul>
</div>
<span id="document-dev_guide/building_from_source"></span><div class="section" id="building-from-source">
<span id="id1"></span><h3>Сборка из исходных файлов<a class="headerlink" href="#building-from-source" title="Ссылка на этот заголовок">¶</a></h3>
<p>For downloading Tarantool source and building it, the platforms can differ and the
preferences can differ. But the steps are always the same. Here in the manual we'll
explain what the steps are, and after that you can look at some example scripts
on the Internet.</p>
<ol class="arabic">
<li><p class="first">Get tools and libraries that will be necessary for building
and testing.</p>
<p>The absolutely necessary ones are:</p>
<ul class="simple">
<li>A program for downloading source repositories. <br />
For all platforms, this is <code class="docutils literal"><span class="pre">git</span></code>. It allows to download the latest
complete set of source files from the Tarantool repository at GitHub.</li>
<li>A C/C++ compiler. <br /> Ordinarily, this is <code class="docutils literal"><span class="pre">gcc</span></code> and <code class="docutils literal"><span class="pre">g++</span></code> version
4.6 or later. On Mac OS X, this is <code class="docutils literal"><span class="pre">Clang</span></code> version 3.2 or later.</li>
<li>A program for managing the build process. <br /> For all platforms, this is
<code class="docutils literal"><span class="pre">CMake</span></code>. The CMake version should be 2.8 or later.</li>
<li>Command-line interpreter for Python-based code (namely, for Tarantool test
suite). <br /> For all platforms, this is <code class="docutils literal"><span class="pre">python</span></code>. The Python version
should be greater than 2.6 -- preferably 2.7 -- and less than 3.0.</li>
</ul>
<p>Here are names of tools and libraries which may have to be installed in advance,
using <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span></code> (for Ubuntu), <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">yum</span> <span class="pre">install</span></code> (for CentOS), or the
equivalent on other platforms. Different platforms may use slightly different
names. Ignore the ones marked <cite>optional, only in Mac OS scripts</cite>
unless the platform is Mac OS.</p>
<ul class="simple">
<li><strong>gcc</strong> and <strong>g++</strong>, or <strong>clang</strong>        # see above</li>
<li><strong>git</strong>                                  # see above</li>
<li><strong>cmake</strong>                                # see above</li>
<li><strong>python</strong>                               # see above; for test suite</li>
<li><strong>libreadline-dev</strong> or <strong>libreadline6-dev</strong> or <strong>readline-devel</strong>  # for interactive mode</li>
<li><strong>libssl-dev</strong>                           # for <cite>digest</cite> module</li>
<li><strong>autoconf</strong>                             # optional, only in Mac OS scripts</li>
<li><strong>zlib1g</strong> or <strong>zlib</strong>                   # optional, only in Mac OS scripts</li>
</ul>
</li>
<li><p class="first">Set up Python modules for running the test suite.</p>
<p>This step is optional. Python modules are not necessary for building Tarantool
itself, unless you intend to use the &quot;Run the test suite&quot; option in step 7.</p>
<p>You need the following Python modules:</p>
<ul class="simple">
<li><a class="reference external" href="https://pypi.python.org/pypi/pip">pip</a>, any version</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/dev">dev</a>, any version</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/PyYAML">pyYAML</a> version 3.10</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/argparse">argparse</a> version 1.1</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/msgpack-python">msgpack-python</a> version 0.4.6</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/gevent">gevent</a> version 1.1b5</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/six)">six</a> version 1.8.0</li>
</ul>
<p>On Ubuntu, you can get the modules from the repository:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo apt-get install python-pip python-dev python-yaml &lt;...&gt;
</pre></div>
</div>
<p>On CentOS 6, you can likewise get the modules from the repository:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo yum install python26 python26-PyYAML &lt;...&gt;
</pre></div>
</div>
<p>If some modules are not available on a repository,
it is best to set up the modules by getting a tarball and
doing the setup with <code class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span></code>, thus:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># On some machines, this initial command may be necessary:</span>
<span class="c1"># wget https://bootstrap.pypa.io/ez_setup.py -O - | sudo python</span>

<span class="c1"># Python module for parsing YAML (pyYAML), for test suite:</span>
<span class="c1"># (If wget fails, check at http://pyyaml.org/wiki/PyYAML</span>
<span class="c1"># what the current version is.)</span>
<span class="nb">cd</span> ~
wget http://pyyaml.org/download/pyyaml/PyYAML-3.10.tar.gz
tar -xzf PyYAML-3.10.tar.gz
<span class="nb">cd</span> PyYAML-3.10
sudo python setup.py install
</pre></div>
</div>
<p>Finally, use Python <code class="code docutils literal"><span class="pre">pip</span></code> to bring in Python packages
that may not be up-to-date in the distro repositories.
(On CentOS 7, it will be necessary to install <code class="docutils literal"><span class="pre">pip</span></code> first,
with <code class="code docutils literal"><span class="pre">sudo</span> <span class="pre">yum</span> <span class="pre">install</span> <span class="pre">epel-release</span></code> followed by
<code class="code docutils literal"><span class="pre">sudo</span> <span class="pre">yum</span> <span class="pre">install</span> <span class="pre">python-pip</span></code>.)</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>pip install tarantool<span class="se">\&gt;</span>0.4 --user
</pre></div>
</div>
</li>
<li><p class="first">Use <code class="docutils literal"><span class="pre">git</span></code> to download the latest Tarantool source code from the
GitHub repository <code class="docutils literal"><span class="pre">tarantool/tarantool</span></code>, branch 1.7. For example, to a
local directory named <cite>~/tarantool</cite>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>git clone https://github.com/tarantool/tarantool.git ~/tarantool
</pre></div>
</div>
</li>
<li><p class="first">Use <code class="docutils literal"><span class="pre">git</span></code> again so that third-party contributions will be seen as well.</p>
<p>The build depends on the following external libraries:</p>
<ul class="simple">
<li>Readline development files (<code class="docutils literal"><span class="pre">libreadline-dev/readline-devel</span></code> package).</li>
<li>OpenSSL development files (<code class="docutils literal"><span class="pre">libssl-dev/openssl-devel</span></code> package).</li>
<li><code class="docutils literal"><span class="pre">libyaml</span></code> (<code class="docutils literal"><span class="pre">libyaml-dev/libyaml-devel</span></code> package).</li>
<li><code class="docutils literal"><span class="pre">liblz4</span></code> (<code class="docutils literal"><span class="pre">liblz4-dev/lz4-devel</span></code> package).</li>
<li>GNU <code class="docutils literal"><span class="pre">bfd</span></code> which is the part of GNU <code class="docutils literal"><span class="pre">binutils</span></code>
(<code class="docutils literal"><span class="pre">binutils-dev/binutils-devel</span></code> package).</li>
</ul>
<p>This step is only necessary once, the first time you do a download.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/tarantool
git submodule init
git submodule update --recursive
<span class="nb">cd</span> ../
</pre></div>
</div>
<p>On rare occasions, the submodules will need to be updated again with the
command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>git submodule update --init --recursive
</pre></div>
</div>
<p>Note: There is an alternative -- to say <code class="docutils literal"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">--recursive</span></code> earlier in
step 3, -- but we prefer the method above because it works with older
versions of <code class="docutils literal"><span class="pre">git</span></code>.</p>
</li>
<li><p class="first">Use CMake to initiate the build.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/tarantool
make clean         <span class="c1"># unnecessary, added for good luck</span>
rm CMakeCache.txt  <span class="c1"># unnecessary, added for good luck</span>
cmake .            <span class="c1"># start initiating with build type=Debug</span>
</pre></div>
</div>
<p>On some platforms, it may be necessary to specify the C and C++ versions,
for example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">CC</span><span class="o">=</span>gcc-4.8 <span class="nv">CXX</span><span class="o">=</span>g++-4.8 cmake .
</pre></div>
</div>
<p>The CMake option for specifying build type is <code class="samp docutils literal"><span class="pre">-DCMAKE_BUILD_TYPE=</span><em><span class="pre">type</span></em></code>,
where <code class="samp docutils literal"><em><span class="pre">type</span></em></code> can be:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Debug</span></code> -- used by project maintainers</li>
<li><code class="docutils literal"><span class="pre">Release</span></code> -- used only if the highest performance is required</li>
<li><code class="docutils literal"><span class="pre">RelWithDebInfo</span></code> -- used for production, also provides debugging capabilities</li>
</ul>
<p>The CMake option for hinting that the result will be distributed is
<code class="code docutils literal"><span class="pre">-DENABLE_DIST=ON</span></code>. If this option is on, then later <code class="docutils literal"><span class="pre">make</span> <span class="pre">install</span></code>
will install tarantoolctl files in addition to tarantool files.</p>
</li>
<li><p class="first">Use <code class="docutils literal"><span class="pre">make</span></code> to complete the build.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>make
</pre></div>
</div>
<p>This creates the 'tarantool' executable in the directory <cite>src/</cite></p>
<p>Next, it's highly recommended to say <code class="docutils literal"><span class="pre">make</span> <span class="pre">install</span></code> to install Tarantool to
the <cite>/usr/local</cite> directory and keep your system clean. However, it is
possible to run the Tarantool executable without installation.</p>
</li>
<li><p class="first">Run the test suite.</p>
<p>This step is optional. Tarantool's developers always run the test suite
before they publish new versions. You should run the test suite too, if you
make any changes in the code. Assuming you downloaded to <code class="docutils literal"><span class="pre">~/tarantool</span></code>, the
principal steps are:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># make a subdirectory named `bin`</span>
mkdir ~/tarantool/bin
<span class="c1"># link python to bin (this may require superuser privilege)</span>
ln /usr/bin/python ~/tarantool/bin/python
<span class="c1"># get on the test subdirectory</span>
<span class="nb">cd</span> ~/tarantool/test
<span class="c1"># run tests using python</span>
<span class="nv">PATH</span><span class="o">=</span>~/tarantool/bin:<span class="nv">$PATH</span> ./test-run.py
</pre></div>
</div>
<p>The output should contain reassuring reports, for example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">======================================================================</span>
TEST                                            RESULT
------------------------------------------------------------
box/bad_trigger.test.py                         <span class="o">[</span> pass <span class="o">]</span>
box/call.test.py                                <span class="o">[</span> pass <span class="o">]</span>
box/iproto.test.py                              <span class="o">[</span> pass <span class="o">]</span>
box/xlog.test.py                                <span class="o">[</span> pass <span class="o">]</span>
box/admin.test.lua                              <span class="o">[</span> pass <span class="o">]</span>
box/auth_access.test.lua                        <span class="o">[</span> pass <span class="o">]</span>
... etc.
</pre></div>
</div>
<p>To prevent later confusion, clean up what's in the <cite>bin</cite> subdirectory:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>rm ~/tarantool/bin/python
rmdir ~/tarantool/bin
</pre></div>
</div>
</li>
<li><p class="first">Make an rpm package.</p>
<p>This step is optional. It's only for people who want to redistribute
Tarantool. Package maintainers who want to build with <code class="docutils literal"><span class="pre">rpmbuild</span></code> should
consult the <code class="docutils literal"><span class="pre">rpm-build</span></code> instructions for the appropriate platform.</p>
</li>
<li><p class="first">Verify your Tarantool installation.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tarantool $ ./src/tarantool
</pre></div>
</div>
<p>This will start Tarantool in the interactive mode.</p>
</li>
</ol>
<p>For your added convenience, we provide OS-specific README files with example
scripts at GitHub:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.7/README.FreeBSD">README.FreeBSD</a> for FreeBSD 10.1</li>
<li><a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.7/README.MacOSX">README.MacOSX</a> for Mac OS X <cite>El Capitan</cite></li>
<li><a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.7/README.md">README.md</a> for generic GNU/Linux</li>
</ul>
<p>These example scripts assume that the intent is to download from the 1.7
branch, build the server and run tests after build.</p>
</div>
<span id="document-dev_guide/building_documentation"></span><div class="section" id="building-documentation">
<span id="id1"></span><h3>Сборка документации<a class="headerlink" href="#building-documentation" title="Ссылка на этот заголовок">¶</a></h3>
<p>This documentation is built using a simplified markup system named <code class="docutils literal"><span class="pre">Sphinx</span></code>
(see <a class="reference external" href="http://sphinx-doc.org">http://sphinx-doc.org</a>). You can build a local version of this documentation
and contribute to it.</p>
<p>You need to install:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">git</span></code> (a program for downloading source repositories)</li>
<li><code class="docutils literal"><span class="pre">CMake</span></code> version 2.8 or later (a program for managing the build process)</li>
<li><code class="docutils literal"><span class="pre">Python</span></code> version greater than 2.6 -- preferably 2.7 -- and less than 3.0
(Sphinx is a Python-based tool)</li>
</ul>
<p>Also, make sure to install the following Python modules:</p>
<ul class="simple">
<li><a class="reference external" href="https://pypi.python.org/pypi/pip">pip</a>, any version</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/dev">dev</a>, any version</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/PyYAML">pyYAML</a> version 3.10</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/Sphinx">Sphinx</a> version 1.4.4</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/sphinx-intl">sphinx-intl</a> version 0.9.9</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/pelican">pelican</a>, any version</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/BeautifulSoup">BeautifulSoup</a>, any version</li>
<li><a class="reference external" href="https://pypi.python.org/pypi/gevent">gevent</a> version 1.1b5</li>
</ul>
<p>See installation details in the <a class="reference internal" href="singlehtml.html#building-from-source"><span class="std std-ref">build-from-source</span></a>
section of this documentation. The procedure below implies that all the
prerequisites are met.</p>
<ol class="arabic">
<li><p class="first">Use <code class="docutils literal"><span class="pre">git</span></code> to download the latest source code of this documentation from the
GitHub repository <code class="docutils literal"><span class="pre">tarantool/doc</span></code>, branch 1.7. For example, to a local
directory named <cite>~/tarantool-doc</cite>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>git clone https://github.com/tarantool/doc.git ~/tarantool-doc
</pre></div>
</div>
</li>
<li><p class="first">Use <code class="docutils literal"><span class="pre">CMake</span></code> to initiate the build.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/tarantool-doc
make clean         <span class="c1"># unnecessary, added for good luck</span>
rm CMakeCache.txt  <span class="c1"># unnecessary, added for good luck</span>
cmake .            <span class="c1"># start initiating</span>
</pre></div>
</div>
</li>
<li><p class="first">Build a local version of the existing documentation package.</p>
<p>Run the <code class="docutils literal"><span class="pre">make</span></code> command with an appropriate option to specify which
documentation version to build.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/tarantool-doc
make all                <span class="c1"># all versions</span>
make sphinx-html        <span class="c1"># multi-page English version</span>
make sphinx-singlehtml  <span class="c1"># one-page English version</span>
make sphinx-html-ru     <span class="c1"># multi-page Russian version</span>
make sphinx-singlehtml  <span class="c1"># one-page Russian version</span>
</pre></div>
</div>
<p>Documentation is created and stored at <cite>/www/output</cite>:</p>
<ul class="simple">
<li><cite>/www/output/doc</cite> (English versions)</li>
<li><cite>/www/output/doc/ru</cite> (Russian versions)</li>
</ul>
<p>The entry point for each version is <cite>index.html</cite> file in the appropriate
directory.</p>
</li>
<li><p class="first">Set up a web-server.</p>
<p>Run the following command to set up a web-server (the example below is for
Ubuntu, but the procedure is similar for other supported OS's).
Make sure to run it from the documentation output folder, as specified below:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/tarantool-doc/www/output
python -m SimpleHTTPServer 8000
</pre></div>
</div>
</li>
<li><p class="first">Open your browser and enter <code class="docutils literal"><span class="pre">127.0.0.1:8000/doc</span></code> into the address box. If
your local documentation build is valid, the default version (English
multi-page) will be displayed in the browser.</p>
</li>
<li><p class="first">To contribute to documentation, use the <code class="docutils literal"><span class="pre">.rst</span></code> format for drafting and
submit your updates as &quot;Pull Requests&quot; via GitHub.</p>
<p>To comply with the writing and formatting style, use the
<a class="reference internal" href="singlehtml.html#documentation-guidelines"><span class="std std-ref">guidelines</span></a> provided in the documentation,
common sense and existing documents.</p>
<p>Notes:</p>
<ul class="simple">
<li>If you suggest creating a new documentation section (i.e., a whole new
page), it has to be saved to the relevant section at GitHub.</li>
<li>If you want to contribute to localizing this documentation (e.g. into
Russian), add your translation strings to <code class="docutils literal"><span class="pre">.po</span></code> files stored in the
corresponding locale directory (e.g. <code class="docutils literal"><span class="pre">/sphinx/locale/ru/LC_MESSAGES/</span></code>
for Russian). See more about localizing with Sphinx at
<a class="reference external" href="http://www.sphinx-doc.org/en/stable/intl.html">http://www.sphinx-doc.org/en/stable/intl.html</a></li>
</ul>
</li>
</ol>
</div>
<span id="document-dev_guide/developer_guidelines"></span><div class="section" id="developer-guidelines">
<h3>Соглашения по разработке<a class="headerlink" href="#developer-guidelines" title="Ссылка на этот заголовок">¶</a></h3>
<div class="section" id="how-to-work-on-a-bug">
<h4>How to work on a bug<a class="headerlink" href="#how-to-work-on-a-bug" title="Ссылка на этот заголовок">¶</a></h4>
<p>Any defect, even minor, if it changes the user-visible server behavior, needs
a bug report. Report a bug at <a class="reference external" href="http://github.com/tarantool/tarantool/issues">http://github.com/tarantool/tarantool/issues</a>.</p>
<p>When reporting a bug, try to come up with a test case right away. Set the
current maintenance milestone for the bug fix, and specify the series.
Assign the bug to yourself. Put the status to 'In progress' Once the patch is
ready, put the bug the bug to 'In review' and solicit a review for the fix.</p>
<p>Once there is a positive code review, push the patch and set the status to 'Closed'</p>
<p>Patches for bugs should contain a reference to the respective Launchpad bug page or
at least bug id. Each patch should have a test, unless coming up with one is
difficult in the current framework, in which case QA should be alerted.</p>
<p>There are two things you need to do when your patch makes it into the master:</p>
<ul class="simple">
<li>put the bug to 'fix committed',</li>
<li>delete the remote branch.</li>
</ul>
</div>
</div>
<span id="document-dev_guide/documentation_guidelines"></span><div class="section" id="documentation-guidelines">
<span id="id1"></span><h3>Соглашения по документации<a class="headerlink" href="#documentation-guidelines" title="Ссылка на этот заголовок">¶</a></h3>
<p>These guidelines are updated on the on-demand basis, covering only those issues
that cause pains to the existing writers. At this point, we do not aim to come
up with an exhaustive Documentation Style Guide for the Tarantool project.</p>
<div class="section" id="markup-issues">
<h4>Markup issues<a class="headerlink" href="#markup-issues" title="Ссылка на этот заголовок">¶</a></h4>
<div class="section" id="wrapping-text">
<h5>Wrapping text<a class="headerlink" href="#wrapping-text" title="Ссылка на этот заголовок">¶</a></h5>
<p>The limit is 80 characters per line for plain text, and no limit for any other
constructions when wrapping affects ReST readability and/or HTML output. Also,
it makes no sense to wrap text into lines shorter than 80 characters unless you
have a good reason to do so.</p>
<p>The 80-character limit comes from the ISO/ANSI 80x24 screen resolution, and it's
unlikely that readers/writers will use 80-character consoles. Yet it's still a
standard for many coding guidelines (including Tarantool). As for writers, the
benefit is that an 80-character page guide allows keeping the text window rather
narrow most of the time, leaving more space for other applications in a
wide-screen environment.</p>
</div>
<div class="section" id="formatting-code-snippets">
<h5>Formatting code snippets<a class="headerlink" href="#formatting-code-snippets" title="Ссылка на этот заголовок">¶</a></h5>
<p>For code snippets, we mainly use the <code class="docutils literal"><span class="pre">code-block</span></code> directive with an
appropriate highlighting language. The most commonly used highlighting languages
are:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">..</span> <span class="pre">code-block::</span> <span class="pre">tarantoolsession</span></code></li>
<li><code class="docutils literal"><span class="pre">..</span> <span class="pre">code-block::</span> <span class="pre">console</span></code></li>
<li><code class="docutils literal"><span class="pre">..</span> <span class="pre">code-block::</span> <span class="pre">lua</span></code></li>
</ul>
</div></blockquote>
<p>For example (a code snippet in Lua):</p>
<div class="highlight-lua"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">page</span> <span class="k">in</span> <span class="n">paged_iter</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">X&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">do</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">New Page. Number Of Tuples = &quot;</span> <span class="o">..</span> <span class="o">#</span><span class="n">page</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="o">#</span><span class="n">page</span><span class="p">,</span><span class="mi">1</span> <span class="k">do</span> <span class="nb">print</span><span class="p">(</span><span class="n">page</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>In rare cases, when we need custom highlight for specific parts of a code
snippet and the <code class="docutils literal"><span class="pre">code-block</span></code> directive is not enough, we use the per-line
<code class="docutils literal"><span class="pre">codenormal</span></code> directive together and explicit output formatting (defined in
<code class="file docutils literal"><span class="pre">doc/sphinx/_static/sphinx_design.css</span></code>).</p>
<p>Examples:</p>
<ul>
<li><p class="first">Function syntax (the placeholder <cite>space-name</cite> is displayed in italics):</p>
<p><span class="ccode">box.space.</span><span class="ccodei">space-name</span><span class="ccode">:create_index('index-name')</span></p>
</li>
<li><p class="first">A tdb session (user input is in bold, command prompt is in blue, computer
output is in green):</p>
<pre class="highlight literal-block">
$ <span class="ccodeb">tarantool example.lua</span>
<span class="ccodeblue">(TDB)</span>  <span class="ccodegreen">Tarantool debugger v.0.0.3. Type h for help</span>
example.lua
<span class="ccodeblue">(TDB)</span>  <span class="ccodegreen">[example.lua]</span>
<span class="ccodeblue">(TDB)</span>  <span class="ccode">3: i = 1</span>
</pre>
</li>
</ul>
<p>Warning: Every entry of explicit output formatting (<code class="docutils literal"><span class="pre">codenormal</span></code>, <code class="docutils literal"><span class="pre">codebold</span></code>,
etc) tends to cause troubles when this documentation is translated to other
languages. Please avoid using explicit output formatting unless it is REALLY
needed.</p>
</div>
<div class="section" id="using-separated-links">
<h5>Using separated links<a class="headerlink" href="#using-separated-links" title="Ссылка на этот заголовок">¶</a></h5>
<p>Avoid separating the link and the target definition (ref), like this:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>This is a paragraph that contains `a link`_.

.. _a link: http://example.com/
</pre></div>
</div>
<p>Use non-separated links instead:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>This is a paragraph that contains `a link &lt;http://example.com/&gt;`_.
</pre></div>
</div>
<p>Warning: Every separated link tends to cause troubles when this documentation is
translated to other languages. Please avoid using separated links unless it is
REALLY needed (e.g. in tables).</p>
</div>
<div class="section" id="creating-labels-for-local-links">
<h5>Creating labels for local links<a class="headerlink" href="#creating-labels-for-local-links" title="Ссылка на этот заголовок">¶</a></h5>
<p>We avoid using links that sphinx generates automatically for most objects.
Instead, we add our own labels for linking to any place in this documentation.</p>
<p>Our naming convention is as follows:</p>
<ul>
<li><p class="first">Character set: a through z, 0 through 9, dash, underscore.</p>
</li>
<li><p class="first">Format: <code class="docutils literal"><span class="pre">path</span> <span class="pre">dash</span> <span class="pre">filename</span> <span class="pre">dash</span> <span class="pre">tag</span></code></p>
<p>Example: <code class="docutils literal"><span class="pre">_c_api-box_index-iterator_type</span></code> <br />
where: <br />
<code class="docutils literal"><span class="pre">c_api</span></code> is the directory name, <br />
<code class="docutils literal"><span class="pre">box_index</span></code> is the file name (without &quot;.rst&quot;), and <br />
<code class="docutils literal"><span class="pre">iterator_type</span></code> is the tag.</p>
</li>
</ul>
<p>The file name is useful for knowing, when you see &quot;ref&quot;, where it is pointing
to. And if the file name is meaningful, you see that better.</p>
<p>The file name alone, without a path, is enough when the file name is unique
within <code class="docutils literal"><span class="pre">doc/sphinx</span></code>.
So, for <code class="docutils literal"><span class="pre">fiber.rst</span></code> it should be just &quot;fiber&quot;, not &quot;reference-fiber&quot;.
While for &quot;index.rst&quot; (we have a handful of &quot;index.rst&quot; in different
directories) please specify the path before the file name, e.g.
&quot;reference-index&quot;.</p>
<p>Use a dash &quot;-&quot; to delimit the path and the file name. In the documentation
source, we use only underscores &quot;_&quot; in paths and file names, reserving dash &quot;-&quot;
as the delimiter for local links.</p>
<p>The tag can be anything meaningful. The only guideline is for Tarantool syntax
items (such as members), where the preferred tag syntax is
<code class="docutils literal"><span class="pre">module_or_object_name</span> <span class="pre">dash</span> <span class="pre">member_name</span></code>. For example, <code class="docutils literal"><span class="pre">box_space-drop</span></code>.</p>
</div>
<div class="section" id="making-comments">
<h5>Making comments<a class="headerlink" href="#making-comments" title="Ссылка на этот заголовок">¶</a></h5>
<p>Sometimes we may need to leave comments in a ReST file. To make sphinx ignore
some text during processing, use the following per-line notation with &quot;.. //&quot; as
the comment marker:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>.. // your comment here
</pre></div>
</div>
<p>The starting symbols &quot;.. //&quot; do not interfere with the other ReST markup, and
they are easy to find both visually and using grep. There are no symbols to
escape in grep search, just go ahead with something like this:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">grep &quot;.. //&quot; doc/sphinx/dev_guide/*.rst</span>
</pre></div>
</div>
<p>These comments don't work properly in nested documentation, though (e.g. if you
leave a comment in module -&gt; object -&gt; method, sphinx ignores the comment and
all nested content that follows in the method description).</p>
</div>
</div>
<div class="section" id="language-and-style-issues">
<h4>Language and style issues<a class="headerlink" href="#language-and-style-issues" title="Ссылка на этот заголовок">¶</a></h4>
<div class="section" id="us-vs-british-spelling">
<h5>US vs British spelling<a class="headerlink" href="#us-vs-british-spelling" title="Ссылка на этот заголовок">¶</a></h5>
<p>We use English US spelling.</p>
</div>
</div>
<div class="section" id="examples-and-templates">
<h4>Examples and templates<a class="headerlink" href="#examples-and-templates" title="Ссылка на этот заголовок">¶</a></h4>
<div class="section" id="module-and-function">
<h5>Module and function<a class="headerlink" href="#module-and-function" title="Ссылка на этот заголовок">¶</a></h5>
<p>Here is an example of documenting a module (<code class="docutils literal"><span class="pre">my_fiber</span></code>) and a function
(<code class="docutils literal"><span class="pre">my_fiber.create</span></code>).</p>
<span class="target" id="lua-module.my_fiber"></span><dl class="function">
<dt id="lua-функция.my_fiber.create">
<em class="property"> </em><code class="descclassname">my_fiber.</code><code class="descname">create</code><big>(</big><em>function</em><span class="optional">[</span>, <em>function-arguments</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#lua-функция.my_fiber.create" title="Ссылка на это определение">¶</a></dt>
<dd><p>Create and start a <code class="docutils literal"><span class="pre">my_fiber</span></code> object. The object is created and begins to
run immediately.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>function</strong> -- the function to be associated with the <code class="docutils literal"><span class="pre">my_fiber</span></code> object</li>
<li><strong>function-arguments</strong> -- what will be passed to function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first">created <code class="docutils literal"><span class="pre">my_fiber</span></code> object</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Rtype:</th><td class="field-body"><p class="first last">userdata</p>
</td>
</tr>
</tbody>
</table>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">my_fiber</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">my_fiber&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="k">function</span> <span class="nf">function_name</span><span class="p">()</span>
<span class="gp">         &gt; </span>  <span class="n">my_fiber</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="gp">         &gt; </span><span class="k">end</span>
<span class="nn">---</span>
<span class="nn">...</span>
<span class="gp">tarantool&gt; </span><span class="n">my_fiber_object</span> <span class="o">=</span> <span class="n">my_fiber</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="module-class-and-method">
<h5>Module, class and method<a class="headerlink" href="#module-class-and-method" title="Ссылка на этот заголовок">¶</a></h5>
<p>Here is an example of documenting a module (<code class="docutils literal"><span class="pre">my_box.index</span></code>), a class
(<code class="docutils literal"><span class="pre">my_index_object</span></code>) and a function (<code class="docutils literal"><span class="pre">my_index_object.rename</span></code>).</p>
<span class="target" id="lua-module.my_box.index"></span><dl class="class">
<dt id="lua-объект.my_box.index.my_index_object">
<em class="property">объект </em><code class="descclassname">my_box.index.</code><code class="descname">my_index_object</code><a class="headerlink" href="#lua-объект.my_box.index.my_index_object" title="Ссылка на это определение">¶</a></dt>
<dd><dl class="method">
<dt id="lua-функция.my_index_object.rename">
<em class="property"> </em><code class="descclassname">my_index_object:</code><code class="descname">rename</code><big>(</big><em>index-name</em><big>)</big><a class="headerlink" href="#lua-функция.my_index_object.rename" title="Ссылка на это определение">¶</a></dt>
<dd><p>Rename an index.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Параметры:</th><td class="field-body"><ul class="first simple">
<li><strong>index_object</strong> -- an object reference</li>
<li><strong>index_name</strong> -- a new name for the index (type = string)</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return:</th><td class="field-body"><p class="first last">nil</p>
</td>
</tr>
</tbody>
</table>
<p>Possible errors: index_object does not exist.</p>
<p><strong>Example:</strong></p>
<div class="highlight-tarantoolsession"><div class="highlight"><pre><span></span><span class="gp">tarantool&gt; </span><span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">space55</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">primary</span><span class="p">:</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">secondary&#39;</span><span class="p">)</span>
<span class="nn">---</span>
<span class="nn">...</span>
</pre></div>
</div>
<p>Complexity Factors: Index size, Index type, Number of tuples accessed.</p>
</dd></dl>

</dd></dl>

</div>
</div>
</div>
<span id="document-dev_guide/box_protocol"></span><div class="section" id="tarantool-s-binary-protocol">
<span id="box-protocol-iproto-protocol"></span><h3>Бинарный протокол в Tarantool'е<a class="headerlink" href="#tarantool-s-binary-protocol" title="Ссылка на этот заголовок">¶</a></h3>
<div class="section" id="notion-in-diagrams">
<h4>Обозначения на диаграммах<a class="headerlink" href="#notion-in-diagrams" title="Ссылка на этот заголовок">¶</a></h4>
<div class="highlight-none"><div class="highlight"><pre><span></span>0    X
+----+
|    | - X байт
+----+
 TYPE - тип переменной из библиотеки MsgPack (если это объект из библиотеки MsgPack)

+====+
|    | - объект из библиотеки MsgPack, динамически изменяемого размера
+====+
 TYPE - тип переменной из библиотеки MsgPack

+~~~~+
|    | - массив/сопоставление из библиотеки MsgPack, динамически изменяемого размера
+~~~~+
 TYPE - тип переменной из библиотеки MsgPack
</pre></div>
</div>
<p>Типы данных из библиотеки MsgPack:</p>
<ul class="simple">
<li><p class="first"><strong>MP_INT</strong> - целое число (integer)</p>
</li>
<li><p class="first"><strong>MP_MAP</strong> - соответствие (map)</p>
</li>
<li><p class="first"><strong>MP_ARR</strong> - массив (array)</p>
</li>
<li><p class="first"><strong>MP_STRING</strong> - строка (string)</p>
</li>
<li><p class="first"><strong>MP_FIXSTR</strong> - строка фиксированной длины (fixed size string)</p>
</li>
<li><p class="first"><strong>MP_OBJECT</strong> - объект типа MsgPack (MsgPack object)</p>
</li>
</ul>
</div>
<div class="section" id="overview">
<h4>Общие сведения о протоколе<a class="headerlink" href="#overview" title="Ссылка на этот заголовок">¶</a></h4>
<p>Бинарный протокол в Tarantool'е -- это бинарный протокол для обмена запросами и ответами.</p>
</div>
<div class="section" id="greeting-packet">
<h4>Пакет-приветствие<a class="headerlink" href="#greeting-packet" title="Ссылка на этот заголовок">¶</a></h4>
<div class="highlight-none"><div class="highlight"><pre><span></span>TARANTOOL&#39;S GREETING:

0                                     63
+--------------------------------------+
|                                      |
| Tarantool Greeting (server version)  |
|               64 bytes               |
+---------------------+----------------+
|                     |                |
| BASE64 encoded SALT |      NULL      |
|      44 bytes       |                |
+---------------------+----------------+
64                  107              127
</pre></div>
</div>
<p>The server begins the dialogue by sending a fixed-size (128 bytes) text greeting
to the client. The greeting always contains two 64 byte lines of ASCII text, each
line ending with newline character ('\n'). The first line contains the server
version and protocol type. The second line contains up to 44 bytes of base64-encoded
random string, to use in authentication packet, and ends with up to 23 spaces.</p>
</div>
<div class="section" id="unified-packet-structure">
<h4>Unified packet structure<a class="headerlink" href="#unified-packet-structure" title="Ссылка на этот заголовок">¶</a></h4>
<p>Once a greeting is read, the protocol becomes pure request/response and features
a complete access to Tarantool functionality, including:</p>
<ul class="simple">
<li>request multiplexing, e.g. ability to asynchronously issue multiple requests
via the same connection</li>
<li>response format that supports zero-copy writes</li>
</ul>
<p>For data structuring and encoding, the protocol uses msgpack data format, see
<a class="reference external" href="http://msgpack.org">http://msgpack.org</a></p>
<p>Tarantool protocol mandates use of a few integer constants serving as keys in
maps used in the protocol. These constants are defined in <a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.7/src/box/iproto_constants.h">src/box/iproto_constants.h</a></p>
<p>Let's list them here too:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>-- user keys
&lt;code&gt;          ::= 0x00
&lt;sync&gt;          ::= 0x01
&lt;schema_id&gt;     ::= 0x05
&lt;space_id&gt;      ::= 0x10
&lt;index_id&gt;      ::= 0x11
&lt;limit&gt;         ::= 0x12
&lt;offset&gt;        ::= 0x13
&lt;iterator&gt;      ::= 0x14
&lt;key&gt;           ::= 0x20
&lt;tuple&gt;         ::= 0x21
&lt;function_name&gt; ::= 0x22
&lt;username&gt;      ::= 0x23
&lt;expression&gt;    ::= 0x27
&lt;ops&gt;           ::= 0x28
&lt;data&gt;          ::= 0x30
&lt;error&gt;         ::= 0x31
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre><span></span>-- -- Value for &lt;code&gt; key in request can be:
-- User command codes
&lt;select&gt;  ::= 0x01
&lt;insert&gt;  ::= 0x02
&lt;replace&gt; ::= 0x03
&lt;update&gt;  ::= 0x04
&lt;delete&gt;  ::= 0x05
&lt;call&gt;    ::= 0x06
&lt;auth&gt;    ::= 0x07
&lt;eval&gt;    ::= 0x08
&lt;upsert&gt;  ::= 0x09
-- Admin command codes
&lt;ping&gt;    ::= 0x40

-- -- Value for &lt;code&gt; key in response can be:
&lt;OK&gt;      ::= 0x00
&lt;ERROR&gt;   ::= 0x8XXX
</pre></div>
</div>
<p>Both <code class="code docutils literal"><span class="pre">&lt;header&gt;</span></code> and <code class="code docutils literal"><span class="pre">&lt;body&gt;</span></code> are msgpack maps:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>Request/Response:

0        5
+--------+ +============+ +===================================+
| BODY + | |            | |                                   |
| HEADER | |   HEADER   | |               BODY                |
|  SIZE  | |            | |                                   |
+--------+ +============+ +===================================+
  MP_INT       MP_MAP                     MP_MAP
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre><span></span>UNIFIED HEADER:

+================+================+=====================+
|                |                |                     |
|   0x00: CODE   |   0x01: SYNC   |    0x05: SCHEMA_ID  |
| MP_INT: MP_INT | MP_INT: MP_INT |  MP_INT: MP_INT     |
|                |                |                     |
+================+================+=====================+
                          MP_MAP
</pre></div>
</div>
<p>They only differ in the allowed set of keys and values, the key defines the type
of value that follows. If a body has no keys, entire msgpack map for the body
may be missing. Such is the case, for example, in &lt;ping&gt; request. <code class="docutils literal"><span class="pre">schema_id</span></code>
may be absent in request's header, that means that there'll be no version
checking, but it must be present in the response. If <code class="docutils literal"><span class="pre">schema_id</span></code> is sent in
the header, then it'll be checked.</p>
</div>
<div class="section" id="authentication">
<span id="box-protocol-authentication"></span><h4>Authentication<a class="headerlink" href="#authentication" title="Ссылка на этот заголовок">¶</a></h4>
<p>When a client connects to the server, the server responds with a 128-byte
text greeting message. Part of the greeting is base-64 encoded session salt -
a random string which can be used for authentication. The length of decoded
salt (44 bytes) exceeds the amount necessary to sign the authentication
message (first 20 bytes). An excess is reserved for future authentication
schemas.</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>PREPARE SCRAMBLE:

    LEN(ENCODED_SALT) = 44;
    LEN(SCRAMBLE)     = 20;

prepare &#39;chap-sha1&#39; scramble:

    salt = base64_decode(encoded_salt);
    step_1 = sha1(password);
    step_2 = sha1(step_1);
    step_3 = sha1(salt, step_2);
    scramble = xor(step_1, step_3);
    return scramble;

AUTHORIZATION BODY: CODE = 0x07

+==================+====================================+
|                  |        +-------------+-----------+ |
|  (KEY)           | (TUPLE)|  len == 9   | len == 20 | |
|   0x23:USERNAME  |   0x21:| &quot;chap-sha1&quot; |  SCRAMBLE | |
| MP_INT:MP_STRING | MP_INT:|  MP_STRING  | MP_STRING | |
|                  |        +-------------+-----------+ |
|                  |                   MP_ARRAY         |
+==================+====================================+
                        MP_MAP
</pre></div>
</div>
<p><code class="code docutils literal"><span class="pre">&lt;key&gt;</span></code> holds the user name. <code class="code docutils literal"><span class="pre">&lt;tuple&gt;</span></code> must be an array of 2 fields:
authentication mechanism (&quot;chap-sha1&quot; is the only supported mechanism right now)
and password, encrypted according to the specified mechanism. Authentication in
Tarantool is optional, if no authentication is performed, session user is 'guest'.
The server responds to authentication packet with a standard response with 0 tuples.</p>
</div>
<div class="section" id="requests">
<h4>Requests<a class="headerlink" href="#requests" title="Ссылка на этот заголовок">¶</a></h4>
<ul class="simple">
<li>SELECT: CODE - 0x01
Find tuples matching the search pattern</li>
</ul>
<div class="highlight-none"><div class="highlight"><pre><span></span>SELECT BODY:

+==================+==================+==================+
|                  |                  |                  |
|   0x10: SPACE_ID |   0x11: INDEX_ID |   0x12: LIMIT    |
| MP_INT: MP_INT   | MP_INT: MP_INT   | MP_INT: MP_INT   |
|                  |                  |                  |
+==================+==================+==================+
|                  |                  |                  |
|   0x13: OFFSET   |   0x14: ITERATOR |   0x20: KEY      |
| MP_INT: MP_INT   | MP_INT: MP_INT   | MP_INT: MP_ARRAY |
|                  |                  |                  |
+==================+==================+==================+
                          MP_MAP
</pre></div>
</div>
<ul class="simple">
<li>INSERT:  CODE - 0x02
Inserts tuple into the space, if no tuple with same unique keys exists. Otherwise throw <em>duplicate key</em> error.</li>
<li>REPLACE: CODE - 0x03
Insert a tuple into the space or replace an existing one.</li>
</ul>
<div class="highlight-none"><div class="highlight"><pre><span></span>INSERT/REPLACE BODY:

+==================+==================+
|                  |                  |
|   0x10: SPACE_ID |   0x21: TUPLE    |
| MP_INT: MP_INT   | MP_INT: MP_ARRAY |
|                  |                  |
+==================+==================+
                 MP_MAP
</pre></div>
</div>
<ul class="simple">
<li>UPDATE: CODE - 0x04
Update a tuple</li>
</ul>
<div class="highlight-none"><div class="highlight"><pre><span></span>UPDATE BODY:

+==================+=======================+
|                  |                       |
|   0x10: SPACE_ID |   0x11: INDEX_ID      |
| MP_INT: MP_INT   | MP_INT: MP_INT        |
|                  |                       |
+==================+=======================+
|                  |          +~~~~~~~~~~+ |
|                  |          |          | |
|                  | (TUPLE)  |    OP    | |
|   0x20: KEY      |    0x21: |          | |
| MP_INT: MP_ARRAY |  MP_INT: +~~~~~~~~~~+ |
|                  |            MP_ARRAY   |
+==================+=======================+
                 MP_MAP
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre><span></span>OP:
    Works only for integer fields:
    * Addition    OP = &#39;+&#39; . space[key][field_no] += argument
    * Subtraction OP = &#39;-&#39; . space[key][field_no] -= argument
    * Bitwise AND OP = &#39;&amp;&#39; . space[key][field_no] &amp;= argument
    * Bitwise XOR OP = &#39;^&#39; . space[key][field_no] ^= argument
    * Bitwise OR  OP = &#39;|&#39; . space[key][field_no] |= argument
    Works on any fields:
    * Delete      OP = &#39;#&#39;
      delete &lt;argument&gt; fields starting
      from &lt;field_no&gt; in the space[&lt;key&gt;]

0           2
+-----------+==========+==========+
|           |          |          |
|    OP     | FIELD_NO | ARGUMENT |
| MP_FIXSTR |  MP_INT  |  MP_INT  |
|           |          |          |
+-----------+==========+==========+
              MP_ARRAY
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre><span></span>    * Insert      OP = &#39;!&#39;
      insert &lt;argument&gt; before &lt;field_no&gt;
    * Assign      OP = &#39;=&#39;
      assign &lt;argument&gt; to field &lt;field_no&gt;.
      will extend the tuple if &lt;field_no&gt; == &lt;max_field_no&gt; + 1

0           2
+-----------+==========+===========+
|           |          |           |
|    OP     | FIELD_NO | ARGUMENT  |
| MP_FIXSTR |  MP_INT  | MP_OBJECT |
|           |          |           |
+-----------+==========+===========+
              MP_ARRAY

    Works on string fields:
    * Splice      OP = &#39;:&#39;
      take the string from space[key][field_no] and
      substitute &lt;offset&gt; bytes from &lt;position&gt; with &lt;argument&gt;
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre><span></span>0           2
+-----------+==========+==========+========+==========+
|           |          |          |        |          |
|    &#39;:&#39;    | FIELD_NO | POSITION | OFFSET | ARGUMENT |
| MP_FIXSTR |  MP_INT  |  MP_INT  | MP_INT |  MP_STR  |
|           |          |          |        |          |
+-----------+==========+==========+========+==========+
                         MP_ARRAY
</pre></div>
</div>
<p>It's an error to specify an argument of a type that differs from expected type.</p>
<ul class="simple">
<li>DELETE: CODE - 0x05
Delete a tuple</li>
</ul>
<div class="highlight-none"><div class="highlight"><pre><span></span>DELETE BODY:

+==================+==================+==================+
|                  |                  |                  |
|   0x10: SPACE_ID |   0x11: INDEX_ID |   0x20: KEY      |
| MP_INT: MP_INT   | MP_INT: MP_INT   | MP_INT: MP_ARRAY |
|                  |                  |                  |
+==================+==================+==================+
                          MP_MAP
</pre></div>
</div>
<ul class="simple">
<li>CALL: CODE - 0x06
Call a stored function</li>
</ul>
<div class="highlight-none"><div class="highlight"><pre><span></span>CALL BODY:

+=======================+==================+
|                       |                  |
|   0x22: FUNCTION_NAME |   0x21: TUPLE    |
| MP_INT: MP_STRING     | MP_INT: MP_ARRAY |
|                       |                  |
+=======================+==================+
                    MP_MAP
</pre></div>
</div>
<ul class="simple">
<li>EVAL: CODE - 0x08
Evaulate Lua expression</li>
</ul>
<div class="highlight-none"><div class="highlight"><pre><span></span>EVAL BODY:

+=======================+==================+
|                       |                  |
|   0x27: EXPRESSION    |   0x21: TUPLE    |
| MP_INT: MP_STRING     | MP_INT: MP_ARRAY |
|                       |                  |
+=======================+==================+
                    MP_MAP
</pre></div>
</div>
<ul class="simple">
<li>UPSERT: CODE - 0x09
Update tuple if it would be found elsewhere try to insert tuple. Always use primary index for key.</li>
</ul>
<div class="highlight-none"><div class="highlight"><pre><span></span>UPSERT BODY:

+==================+==================+==========================+
|                  |                  |             +~~~~~~~~~~+ |
|                  |                  |             |          | |
|   0x10: SPACE_ID |   0x21: TUPLE    |       (OPS) |    OP    | |
| MP_INT: MP_INT   | MP_INT: MP_ARRAY |       0x28: |          | |
|                  |                  |     MP_INT: +~~~~~~~~~~+ |
|                  |                  |               MP_ARRAY   |
+==================+==================+==========================+
                                MP_MAP

Operations structure same as for UPDATE operation.
   0           2
+-----------+==========+==========+
|           |          |          |
|    OP     | FIELD_NO | ARGUMENT |
| MP_FIXSTR |  MP_INT  |  MP_INT  |
|           |          |          |
+-----------+==========+==========+
              MP_ARRAY

Supported operations:

&#39;+&#39; - add a value to a numeric field. If the filed is not numeric, it&#39;s
      changed to 0 first. If the field does not exist, the operation is
      skipped. There is no error in case of overflow either, the value
      simply wraps around in C style. The range of the integer is MsgPack:
      from -2^63 to 2^64-1
&#39;-&#39; - same as the previous, but subtract a value
&#39;=&#39; - assign a field to a value. The field must exist, if it does not exist,
      the operation is skipped.
&#39;!&#39; - insert a field. It&#39;s only possible to insert a field if this create no
      nil &quot;gaps&quot; between fields. E.g. it&#39;s possible to add a field between
      existing fields or as the last field of the tuple.
&#39;#&#39; - delete a field. If the field does not exist, the operation is skipped.
      It&#39;s not possible to change with update operations a part of the primary
      key (this is validated before performing upsert).
</pre></div>
</div>
</div>
<div class="section" id="response-packet-structure">
<h4>Response packet structure<a class="headerlink" href="#response-packet-structure" title="Ссылка на этот заголовок">¶</a></h4>
<p>We'll show whole packets here:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>OK:    LEN + HEADER + BODY

0      5                                          OPTIONAL
+------++================+================++===================+
|      ||                |                ||                   |
| BODY ||   0x00: 0x00   |   0x01: SYNC   ||   0x30: DATA      |
|HEADER|| MP_INT: MP_INT | MP_INT: MP_INT || MP_INT: MP_OBJECT |
| SIZE ||                |                ||                   |
+------++================+================++===================+
 MP_INT                MP_MAP                      MP_MAP
</pre></div>
</div>
<p>Set of tuples in the response <code class="code docutils literal"><span class="pre">&lt;data&gt;</span></code> expects a msgpack array of tuples as value
EVAL command returns arbitrary <cite>MP_ARRAY</cite> with arbitrary MsgPack values.</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>ERROR: LEN + HEADER + BODY

0      5
+------++================+================++===================+
|      ||                |                ||                   |
| BODY ||   0x00: 0x8XXX |   0x01: SYNC   ||   0x31: ERROR     |
|HEADER|| MP_INT: MP_INT | MP_INT: MP_INT || MP_INT: MP_STRING |
| SIZE ||                |                ||                   |
+------++================+================++===================+
 MP_INT                MP_MAP                      MP_MAP

Where 0xXXX is ERRCODE.
</pre></div>
</div>
<p>Error message is present in the response only if there is an error <code class="code docutils literal"><span class="pre">&lt;error&gt;</span></code>
expects as value a msgpack string</p>
<p>Convenience macros which define hexadecimal constants for return codes
can be found in <a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.7/src/box/errcode.h">src/box/errcode.h</a></p>
</div>
<div class="section" id="replication-packet-structure">
<h4>Replication packet structure<a class="headerlink" href="#replication-packet-structure" title="Ссылка на этот заголовок">¶</a></h4>
<div class="highlight-none"><div class="highlight"><pre><span></span>-- replication keys
&lt;server_id&gt;     ::= 0x02
&lt;lsn&gt;           ::= 0x03
&lt;timestamp&gt;     ::= 0x04
&lt;server_uuid&gt;   ::= 0x24
&lt;cluster_uuid&gt;  ::= 0x25
&lt;vclock&gt;        ::= 0x26
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre><span></span>-- replication codes
&lt;join&gt;      ::= 0x41
&lt;subscribe&gt; ::= 0x42
</pre></div>
</div>
<div class="highlight-none"><div class="highlight"><pre><span></span>JOIN:

In the beginning you must send JOIN
                         HEADER                          BODY
+================+================+===================++-------+
|                |                |    SERVER_UUID    ||       |
|   0x00: 0x41   |   0x01: SYNC   |   0x24: UUID      || EMPTY |
| MP_INT: MP_INT | MP_INT: MP_INT | MP_INT: MP_STRING ||       |
|                |                |                   ||       |
+================+================+===================++-------+
               MP_MAP                                   MP_MAP

Then server, which we connect to, will send last SNAP file by, simply,
creating a number of INSERTs (with additional LSN and ServerID)
(don&#39;t reply). Then it&#39;ll send a vclock&#39;s MP_MAP and close a socket.

+================+================++============================+
|                |                ||        +~~~~~~~~~~~~~~~~~+ |
|                |                ||        |                 | |
|   0x00: 0x00   |   0x01: SYNC   ||   0x26:| SRV_ID: SRV_LSN | |
| MP_INT: MP_INT | MP_INT: MP_INT || MP_INT:| MP_INT: MP_INT  | |
|                |                ||        +~~~~~~~~~~~~~~~~~+ |
|                |                ||               MP_MAP       |
+================+================++============================+
               MP_MAP                      MP_MAP

SUBSCRIBE:

Then you must send SUBSCRIBE:

                              HEADER
+===================+===================+
|                   |                   |
|     0x00: 0x41    |    0x01: SYNC     |
|   MP_INT: MP_INT  |  MP_INT: MP_INT   |
|                   |                   |
+===================+===================+
|    SERVER_UUID    |    CLUSTER_UUID   |
|   0x24: UUID      |   0x25: UUID      |
| MP_INT: MP_STRING | MP_INT: MP_STRING |
|                   |                   |
+===================+===================+
                 MP_MAP

      BODY
+================+
|                |
|   0x26: VCLOCK |
| MP_INT: MP_INT |
|                |
+================+
      MP_MAP

Then you must process every query that&#39;ll came through other masters.
Every request between masters will have Additional LSN and SERVER_ID.
</pre></div>
</div>
</div>
<div class="section" id="xlog-snap">
<h4>XLOG / SNAP<a class="headerlink" href="#xlog-snap" title="Ссылка на этот заголовок">¶</a></h4>
<p>XLOG and SNAP have the same format. They start with:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>SNAP\n
0.12\n
Server: e6eda543-eda7-4a82-8bf4-7ddd442a9275\n
VClock: {1: 0}\n
\n
...
</pre></div>
</div>
<p>So, <strong>Header</strong> of an SNAP/XLOG consists of:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>&lt;format&gt;\n
&lt;format_version&gt;\n
Server: &lt;server_uuid&gt;\n
VClock: &lt;vclock_map&gt;\n
\n
</pre></div>
</div>
<p>There are two markers: tuple beginning - <strong>0xd5ba0bab</strong> and EOF marker -
<strong>0xd510aded</strong>. So, next, between <strong>Header</strong> and EOF marker there's data with
the following schema:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>0            3 4                                         17
+-------------+========+============+===========+=========+
|             |        |            |           |         |
| 0xd5ba0bab  | LENGTH | CRC32 PREV | CRC32 CUR | PADDING |
|             |        |            |           |         |
+-------------+========+============+===========+=========+
  MP_FIXEXT2    MP_INT     MP_INT       MP_INT      ---

+============+ +===================================+
|            | |                                   |
|   HEADER   | |                BODY               |
|            | |                                   |
+============+ +===================================+
    MP_MAP                     MP_MAP
</pre></div>
</div>
</div>
</div>
<span id="document-dev_guide/c_style_guide"></span><div class="section" id="c-style-guide">
<h3>Соглашения по разработке на языке C<a class="headerlink" href="#c-style-guide" title="Ссылка на этот заголовок">¶</a></h3>
<p>The project's coding style is based on a version of the Linux kernel coding style.</p>
<p>The latest version of the Linux style can be found at:
<a class="reference external" href="http://www.kernel.org/doc/Documentation/CodingStyle">http://www.kernel.org/doc/Documentation/CodingStyle</a></p>
<p>Since it is open for changes, the version of style that we follow,
one from 2007-July-13, will be also copied later in this document.</p>
<p>There are a few additional guidelines, either unique
to Tarantool or deviating from the Kernel guidelines.</p>
<ol class="upperalpha simple">
<li>Chapters 10 &quot;Kconfig configuration files&quot;, 11 &quot;Data structures&quot;,
13 &quot;Printing kernel messages&quot;, 14 &quot;Allocating memory&quot; and 17
&quot;Don't re-invent the kernel macros&quot; do not apply, since they are
specific to Linux kernel programming environment.</li>
<li>The rest of Linux Kernel Coding Style is amended as follows:</li>
</ol>
<div class="section" id="general-guidelines">
<h4>General guidelines<a class="headerlink" href="#general-guidelines" title="Ссылка на этот заголовок">¶</a></h4>
<p>We use Git for revision control. The latest development is happening in the
'master' branch. Our git repository is hosted on github, and can be checked
out with git clone git://github.com/tarantool/tarantool.git # anonymous read-only access</p>
<p>If you have any questions about Tarantool internals, please post them on the
developer discussion list, <a class="reference external" href="https://groups.google.com/forum/#!forum/tarantool">https://groups.google.com/forum/#!forum/tarantool</a>. However,
please be warned: Launchpad silently deletes posts from non-subscribed members,
thus please be sure to have subscribed to the list prior to posting. Additionally,
some engineers are always present on #tarantool channel on irc.freenode.net.</p>
<div class="section" id="commenting-style">
<h5>Commenting style<a class="headerlink" href="#commenting-style" title="Ссылка на этот заголовок">¶</a></h5>
<p>Use Doxygen comment format, Javadoc flavor, i.e. <cite>&#64;tag</cite> rather than <cite>tag</cite>.
The main tags in use are &#64;param, &#64;retval, &#64;return, &#64;see, &#64;note and &#64;todo.</p>
<p>Every function, except perhaps a very short and obvious one, should have a
comment. A sample function comment may look like below:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>/** Write all data to a descriptor.
 *
 * This function is equivalent to &#39;write&#39;, except it would ensure
 * that all data is written to the file unless a non-ignorable
 * error occurs.
 *
 * @retval 0  Success
 *
 * @reval  1  An error occurred (not EINTR)
 * /
static int
write_all(int fd, void \*data, size_t len);
</pre></div>
</div>
<p>Public structures and important structure members should be commented as well.</p>
</div>
<div class="section" id="header-files">
<h5>Header files<a class="headerlink" href="#header-files" title="Ссылка на этот заголовок">¶</a></h5>
<p>Use header guards. Put the header guard in the first line in the header,
before the copyright or declarations. Use all-uppercase name for the header
guard. Derive the header guard name from the file name, and append _INCLUDED
to get a macro name. For example, core/log_io.h -&gt; CORE_LOG_IO_H_INCLUDED. In
<code class="docutils literal"><span class="pre">.c</span></code> (implementation) file, include the respective declaration header before all
other headers, to ensure that the header is self- sufficient. Header &quot;header.h&quot;
is self-sufficient if the following compiles without errors:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;header.h&quot;</span><span class="cp"></span>
</pre></div>
</div>
</div>
<div class="section" id="allocating-memory">
<h5>Allocating memory<a class="headerlink" href="#allocating-memory" title="Ссылка на этот заголовок">¶</a></h5>
<p>Prefer the supplied slab (salloc) and pool (palloc) allocators to malloc()/free()
for any performance-intensive or large  memory allocations. Repetitive use of
malloc()/free() can lead to memory fragmentation and should therefore be avoided.</p>
<p>Always free all allocated memory, even allocated  at start-up. We aim at being
valgrind leak-check clean, and in most cases it's just as easy to free() the
allocated memory as it is to write a valgrind suppression. Freeing all allocated
memory is also dynamic-load friendly: assuming a plug-in can be dynamically loaded
and unloaded multiple times, reload should not lead to a memory leak.</p>
</div>
<div class="section" id="other">
<h5>Other<a class="headerlink" href="#other" title="Ссылка на этот заголовок">¶</a></h5>
<p>Select GNU C99 extensions are acceptable. It's OK to mix declarations and statements,
use true and false.</p>
<p>The not-so-current list of all GCC C extensions can be found at:
<a class="reference external" href="http://gcc.gnu.org/onlinedocs/gcc-4.3.5/gcc/C-Extensions.html">http://gcc.gnu.org/onlinedocs/gcc-4.3.5/gcc/C-Extensions.html</a></p>
</div>
</div>
<div class="section" id="linux-kernel-coding-style">
<h4>Linux kernel coding style<a class="headerlink" href="#linux-kernel-coding-style" title="Ссылка на этот заголовок">¶</a></h4>
<p>This is a short document describing the preferred coding style for the
linux kernel.  Coding style is very personal, and I won't _force_ my
views on anybody, but this is what goes for anything that I have to be
able to maintain, and I'd prefer it for most other things too.  Please
at least consider the points made here.</p>
<p>First off, I'd suggest printing out a copy of the GNU coding standards,
and NOT read it.  Burn them, it's a great symbolic gesture.</p>
<p>Anyway, here goes:</p>
<div class="section" id="chapter-1-indentation">
<h5>Chapter 1: Indentation<a class="headerlink" href="#chapter-1-indentation" title="Ссылка на этот заголовок">¶</a></h5>
<p>Tabs are 8 characters, and thus indentations are also 8 characters.
There are heretic movements that try to make indentations 4 (or even 2!)
characters deep, and that is akin to trying to define the value of PI to
be 3.</p>
<p>Rationale: The whole idea behind indentation is to clearly define where
a block of control starts and ends.  Especially when you've been looking
at your screen for 20 straight hours, you'll find it a lot easier to see
how the indentation works if you have large indentations.</p>
<p>Now, some people will claim that having 8-character indentations makes
the code move too far to the right, and makes it hard to read on a
80-character terminal screen.  The answer to that is that if you need
more than 3 levels of indentation, you're screwed anyway, and should fix
your program.</p>
<p>In short, 8-char indents make things easier to read, and have the added
benefit of warning you when you're nesting your functions too deep.
Heed that warning.</p>
<p>The preferred way to ease multiple indentation levels in a switch statement is
to align the &quot;switch&quot; and its subordinate &quot;case&quot; labels in the same column
instead of &quot;double-indenting&quot; the &quot;case&quot; labels. e.g.:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">switch</span> <span class="p">(</span><span class="n">suffix</span><span class="p">)</span> <span class="p">{</span>
<span class="k">case</span> <span class="sc">&#39;G&#39;</span><span class="o">:</span>
<span class="k">case</span> <span class="sc">&#39;g&#39;</span><span class="o">:</span>
    <span class="n">mem</span> <span class="o">&lt;&lt;=</span> <span class="mi">30</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="sc">&#39;M&#39;</span><span class="o">:</span>
<span class="k">case</span> <span class="sc">&#39;m&#39;</span><span class="o">:</span>
    <span class="n">mem</span> <span class="o">&lt;&lt;=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="sc">&#39;K&#39;</span><span class="o">:</span>
<span class="k">case</span> <span class="sc">&#39;k&#39;</span><span class="o">:</span>
    <span class="n">mem</span> <span class="o">&lt;&lt;=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="cm">/* fall through */</span>
<span class="k">default</span><span class="o">:</span>
    <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Don't put multiple statements on a single line unless you have
something to hide:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>if (condition) do_this;
  do_something_everytime;
</pre></div>
</div>
<p>Don't put multiple assignments on a single line either. Kernel coding style
is super simple. Avoid tricky expressions.</p>
<p>Outside of comments, documentation and except in Kconfig, spaces are never
used for indentation, and the above example is deliberately broken.</p>
<p>Get a decent editor and don't leave whitespace at the end of lines.</p>
</div>
<div class="section" id="chapter-2-breaking-long-lines-and-strings">
<h5>Chapter 2: Breaking long lines and strings<a class="headerlink" href="#chapter-2-breaking-long-lines-and-strings" title="Ссылка на этот заголовок">¶</a></h5>
<p>Coding style is all about readability and maintainability using commonly
available tools.</p>
<p>The limit on the length of lines is 80 columns and this is a strongly
preferred limit.</p>
<p>Statements longer than 80 columns will be broken into sensible chunks.
Descendants are always substantially shorter than the parent and are placed
substantially to the right. The same applies to function headers with a long
argument list. Long strings are as well broken into shorter strings. The
only exception to this is where exceeding 80 columns significantly increases
readability and does not hide information.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">fun</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">condition</span><span class="p">)</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Warning this is a long printk with &quot;</span>
                        <span class="s">&quot;3 parameters a: %u b: %u &quot;</span>
                        <span class="s">&quot;c: %u </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">next_statement</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="chapter-3-placing-braces-and-spaces">
<h5>Chapter 3: Placing Braces and Spaces<a class="headerlink" href="#chapter-3-placing-braces-and-spaces" title="Ссылка на этот заголовок">¶</a></h5>
<p>The other issue that always comes up in C styling is the placement of
braces.  Unlike the indent size, there are few technical reasons to
choose one placement strategy over the other, but the preferred way, as
shown to us by the prophets Kernighan and Ritchie, is to put the opening
brace last on the line, and put the closing brace first, thusly:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>if (x is true) {
    we do y
}
</pre></div>
</div>
<p>This applies to all non-function statement blocks (if, switch, for,
while, do). e.g.:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
<span class="k">case</span> <span class="nl">KOBJ_ADD</span><span class="p">:</span>
    <span class="k">return</span> <span class="s">&quot;add&quot;</span><span class="p">;</span>
<span class="k">case</span> <span class="nl">KOBJ_REMOVE</span><span class="p">:</span>
    <span class="k">return</span> <span class="s">&quot;remove&quot;</span><span class="p">;</span>
<span class="k">case</span> <span class="nl">KOBJ_CHANGE</span><span class="p">:</span>
    <span class="k">return</span> <span class="s">&quot;change&quot;</span><span class="p">;</span>
<span class="k">default</span><span class="o">:</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>However, there is one special case, namely functions: they have the
opening brace at the beginning of the next line, thus:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">function</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">body</span> <span class="n">of</span> <span class="n">function</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Heretic people all over the world have claimed that this inconsistency
is ...  well ...  inconsistent, but all right-thinking people know that
(a) K&amp;R are _right_ and (b) K&amp;R are right.  Besides, functions are
special anyway (you can't nest them in C).</p>
<p>Note that the closing brace is empty on a line of its own, _except_ in
the cases where it is followed by a continuation of the same statement,
ie a &quot;while&quot; in a do-statement or an &quot;else&quot; in an if-statement, like
this:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">do</span> <span class="p">{</span>
    <span class="n">body</span> <span class="n">of</span> <span class="k">do</span><span class="o">-</span><span class="n">loop</span><span class="p">;</span>
<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">condition</span><span class="p">);</span>
</pre></div>
</div>
<p>and</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">..</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="p">....</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Rationale: K&amp;R.</p>
<p>Also, note that this brace-placement also minimizes the number of empty
(or almost empty) lines, without any loss of readability.  Thus, as the
supply of new-lines on your screen is not a renewable resource (think
25-line terminal screens here), you have more empty lines to put
comments on.</p>
<p>Do not unnecessarily use braces where a single statement will do.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">condition</span><span class="p">)</span>
    <span class="n">action</span><span class="p">();</span>
</pre></div>
</div>
<p>This does not apply if one branch of a conditional statement is a single
statement. Use braces in both branches.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">do_this</span><span class="p">();</span>
    <span class="n">do_that</span><span class="p">();</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">otherwise</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="chapter-3-1-spaces">
<h5>Chapter 3.1:  Spaces<a class="headerlink" href="#chapter-3-1-spaces" title="Ссылка на этот заголовок">¶</a></h5>
<p>Linux kernel style for use of spaces depends (mostly) on
function-versus-keyword usage.  Use a space after (most) keywords.  The
notable exceptions are sizeof, typeof, alignof, and __attribute__, which look
somewhat like functions (and are usually used with parentheses in Linux,
although they are not required in the language, as in: &quot;sizeof info&quot; after
&quot;struct fileinfo info;&quot; is declared).</p>
<p>So use a space after these keywords: if, switch, case, for, do, while
but not with sizeof, typeof, alignof, or __attribute__.  E.g.,</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span><span class="p">);</span>
</pre></div>
</div>
<p>Do not add spaces around (inside) parenthesized expressions. This example is
<strong>bad</strong>:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span> <span class="k">struct</span> <span class="n">file</span> <span class="p">);</span>
</pre></div>
</div>
<p>When declaring pointer data or a function that returns a pointer type, the
preferred use of '*' is adjacent to the data name or function name and not
adjacent to the type name.  Examples:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">char</span> <span class="o">*</span><span class="n">linux_banner</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="nf">memparse</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">retptr</span><span class="p">);</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">match_strdup</span><span class="p">(</span><span class="n">substring_t</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
</pre></div>
</div>
<p>Use one space around (on each side of) most binary and ternary operators,
such as any of these:</p>
<blockquote>
<div>=  +  -  &lt;  &gt;  *  /  %  |  &amp;  ^  &lt;=  &gt;=  ==  !=  ?  :</div></blockquote>
<p>but no space after unary operators:</p>
<blockquote>
<div>&amp;  *  +  -  ~  !  sizeof  typeof  alignof  __attribute__  defined</div></blockquote>
<p>no space before the postfix increment &amp; decrement unary operators:</p>
<blockquote>
<div>++  --</div></blockquote>
<p>no space after the prefix increment &amp; decrement unary operators:</p>
<blockquote>
<div>++  --</div></blockquote>
<p>and no space around the '.' and &quot;-&gt;&quot; structure member operators.</p>
<p>Do not leave trailing whitespace at the ends of lines.  Some editors with
&quot;smart&quot; indentation will insert whitespace at the beginning of new lines as
appropriate, so you can start typing the next line of code right away.
However, some such editors do not remove the whitespace if you end up not
putting a line of code there, such as if you leave a blank line.  As a result,
you end up with lines containing trailing whitespace.</p>
<p>Git will warn you about patches that introduce trailing whitespace, and can
optionally strip the trailing whitespace for you; however, if applying a series
of patches, this may make later patches in the series fail by changing their
context lines.</p>
</div>
<div class="section" id="chapter-4-naming">
<h5>Chapter 4: Naming<a class="headerlink" href="#chapter-4-naming" title="Ссылка на этот заголовок">¶</a></h5>
<p>C is a Spartan language, and so should your naming be.  Unlike Modula-2
and Pascal programmers, C programmers do not use cute names like
ThisVariableIsATemporaryCounter.  A C programmer would call that
variable &quot;tmp&quot;, which is much easier to write, and not the least more
difficult to understand.</p>
<p>HOWEVER, while mixed-case names are frowned upon, descriptive names for
global variables are a must.  To call a global function &quot;foo&quot; is a
shooting offense.</p>
<p>GLOBAL variables (to be used only if you _really_ need them) need to
have descriptive names, as do global functions.  If you have a function
that counts the number of active users, you should call that
&quot;count_active_users()&quot; or similar, you should _not_ call it &quot;cntusr()&quot;.</p>
<p>Encoding the type of a function into the name (so-called Hungarian
notation) is brain damaged - the compiler knows the types anyway and can
check those, and it only confuses the programmer.  No wonder MicroSoft
makes buggy programs.</p>
<p>LOCAL variable names should be short, and to the point.  If you have
some random integer loop counter, it should probably be called &quot;i&quot;.
Calling it &quot;loop_counter&quot; is non-productive, if there is no chance of it
being mis-understood.  Similarly, &quot;tmp&quot; can be just about any type of
variable that is used to hold a temporary value.</p>
<p>If you are afraid to mix up your local variable names, you have another
problem, which is called the function-growth-hormone-imbalance syndrome.
See chapter 6 (Functions).</p>
</div>
<div class="section" id="chapter-5-typedefs">
<h5>Chapter 5: Typedefs<a class="headerlink" href="#chapter-5-typedefs" title="Ссылка на этот заголовок">¶</a></h5>
<p>Please don't use things like &quot;vps_t&quot;.</p>
<p>It's a _mistake_ to use typedef for structures and pointers. When you see a</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">vps_t</span> <span class="n">a</span><span class="p">;</span>
</pre></div>
</div>
<p>in the source, what does it mean?</p>
<p>In contrast, if it says</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">virtual_container</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
</pre></div>
</div>
<p>you can actually tell what &quot;a&quot; is.</p>
<p>Lots of people think that typedefs &quot;help readability&quot;. Not so. They are
useful only for:</p>
<ol class="loweralpha">
<li><p class="first">totally opaque objects (where the typedef is actively used to _hide_
what the object is).</p>
<p>Example: &quot;pte_t&quot; etc. opaque objects that you can only access using
the proper accessor functions.</p>
<p>NOTE! Opaqueness and &quot;accessor functions&quot; are not good in themselves.
The reason we have them for things like pte_t etc. is that there
really is absolutely _zero_ portably accessible information there.</p>
</li>
<li><p class="first">Clear integer types, where the abstraction _helps_ avoid confusion
whether it is &quot;int&quot; or &quot;long&quot;.</p>
<p>u8/u16/u32 are perfectly fine typedefs, although they fit into
category (d) better than here.</p>
<p>NOTE! Again - there needs to be a _reason_ for this. If something is
&quot;unsigned long&quot;, then there's no reason to do</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">myflags_t</span><span class="p">;</span>
</pre></div>
</div>
<p>but if there is a clear reason for why it under certain circumstances
might be an &quot;unsigned int&quot; and under other configurations might be
&quot;unsigned long&quot;, then by all means go ahead and use a typedef.</p>
</li>
<li><p class="first">when you use sparse to literally create a _new_ type for
type-checking.</p>
</li>
<li><p class="first">New types which are identical to standard C99 types, in certain
exceptional circumstances.</p>
<p>Although it would only take a short amount of time for the eyes and
brain to become accustomed to the standard types like 'uint32_t',
some people object to their use anyway.</p>
<p>Therefore, the Linux-specific 'u8/u16/u32/u64' types and their
signed equivalents which are identical to standard types are
permitted -- although they are not mandatory in new code of your
own.</p>
<p>When editing existing code which already uses one or the other set
of types, you should conform to the existing choices in that code.</p>
</li>
<li><p class="first">Types safe for use in userspace.</p>
<p>In certain structures which are visible to userspace, we cannot
require C99 types and cannot use the 'u32' form above. Thus, we
use __u32 and similar types in all structures which are shared
with userspace.</p>
</li>
</ol>
<p>Maybe there are other cases too, but the rule should basically be to NEVER
EVER use a typedef unless you can clearly match one of those rules.</p>
<p>In general, a pointer, or a struct that has elements that can reasonably
be directly accessed should <strong>never</strong> be a typedef.</p>
</div>
<div class="section" id="chapter-6-functions">
<h5>Chapter 6: Functions<a class="headerlink" href="#chapter-6-functions" title="Ссылка на этот заголовок">¶</a></h5>
<p>Functions should be short and sweet, and do just one thing.  They should
fit on one or two screenfuls of text (the ISO/ANSI screen size is 80x24,
as we all know), and do one thing and do that well.</p>
<p>The maximum length of a function is inversely proportional to the
complexity and indentation level of that function.  So, if you have a
conceptually simple function that is just one long (but simple)
case-statement, where you have to do lots of small things for a lot of
different cases, it's OK to have a longer function.</p>
<p>However, if you have a complex function, and you suspect that a
less-than-gifted first-year high-school student might not even
understand what the function is all about, you should adhere to the
maximum limits all the more closely.  Use helper functions with
descriptive names (you can ask the compiler to in-line them if you think
it's performance-critical, and it will probably do a better job of it
than you would have done).</p>
<p>Another measure of the function is the number of local variables.  They
shouldn't exceed 5-10, or you're doing something wrong.  Re-think the
function, and split it into smaller pieces.  A human brain can
generally easily keep track of about 7 different things, anything more
and it gets confu/sed.  You know you're brilliant, but maybe you'd like
to understand what you did 2 weeks from now.</p>
<p>In source files, separate functions with one blank line.  If the function is
exported, the EXPORT* macro for it should follow immediately after the closing
function brace line.  E.g.:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">system_is_up</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">system_state</span> <span class="o">==</span> <span class="n">SYSTEM_RUNNING</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">system_is_up</span><span class="p">);</span>
</pre></div>
</div>
<p>In function prototypes, include parameter names with their data types.
Although this is not required by the C language, it is preferred in Linux
because it is a simple way to add valuable information for the reader.</p>
</div>
<div class="section" id="chapter-7-centralized-exiting-of-functions">
<h5>Chapter 7: Centralized exiting of functions<a class="headerlink" href="#chapter-7-centralized-exiting-of-functions" title="Ссылка на этот заголовок">¶</a></h5>
<p>Albeit deprecated by some people, the equivalent of the goto statement is
used frequently by compilers in form of the unconditional jump instruction.</p>
<p>The goto statement comes in handy when a function exits from multiple
locations and some common work such as cleanup has to be done.</p>
<p>The rationale is:</p>
<ul class="simple">
<li>unconditional statements are easier to understand and follow</li>
<li>nesting is reduced</li>
<li>errors by not updating individual exit points when making
modifications are prevented</li>
<li>saves the compiler work to optimize redundant code away ;)</li>
</ul>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">fun</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">SIZE</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">condition1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">loop1</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">...</span>
        <span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="nl">out</span><span class="p">:</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="chapter-8-commenting">
<h5>Chapter 8: Commenting<a class="headerlink" href="#chapter-8-commenting" title="Ссылка на этот заголовок">¶</a></h5>
<p>Comments are good, but there is also a danger of over-commenting. NEVER
try to explain HOW your code works in a comment: it's much better to
write the code so that the _working_ is obvious, and it's a waste of
time to explain badly written code.
с
Generally, you want your comments to tell WHAT your code does, not HOW.
Also, try to avoid putting comments inside a function body: if the
function is so complex that you need to separately comment parts of it,
you should probably go back to chapter 6 for a while.  You can make
small comments to note or warn about something particularly clever (or
ugly), but try to avoid excess.  Instead, put the comments at the head
of the function, telling people what it does, and possibly WHY it does
it.</p>
<p>When commenting the kernel API functions, please use the kernel-doc format.
See the files Documentation/kernel-doc-nano-HOWTO.txt and scripts/kernel-doc
for details.</p>
<p>Linux style for comments is the C89 <code class="docutils literal"><span class="pre">&quot;/\*</span> <span class="pre">...</span> <span class="pre">\*/&quot;</span></code> style.
Don't use C99-style <code class="docutils literal"><span class="pre">&quot;//</span> <span class="pre">...&quot;</span></code> comments.</p>
<p>The preferred style for long (multi-line) comments is:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * This is the preferred style for multi-line</span>
<span class="cm"> * comments in the Linux kernel source code.</span>
<span class="cm"> * Please use it consistently.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:  A column of asterisks on the left side,</span>
<span class="cm"> * with beginning and ending almost-blank lines.</span>
<span class="cm"> */</span>
</pre></div>
</div>
<p>It's also important to comment data, whether they are basic types or derived
types.  To this end, use just one data declaration per line (no commas for
multiple data declarations).  This leaves you room for a small comment on each
item, explaining its use.</p>
</div>
<div class="section" id="chapter-9-you-ve-made-a-mess-of-it">
<h5>Chapter 9: You've made a mess of it<a class="headerlink" href="#chapter-9-you-ve-made-a-mess-of-it" title="Ссылка на этот заголовок">¶</a></h5>
<p>That's OK, we all do.  You've probably been told by your long-time Unix
user helper that &quot;GNU emacs&quot; automatically formats the C sources for
you, and you've noticed that yes, it does do that, but the defaults it
uses are less than desirable (in fact, they are worse than random
typing - an infinite number of monkeys typing into GNU emacs would never
make a good program).</p>
<p>So, you can either get rid of GNU emacs, or change it to use saner
values.  To do the latter, you can stick the following in your .emacs file:</p>
<div class="highlight-lisp"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">c-lineup-arglist-tabs-only</span> <span class="p">(</span><span class="nv">ignored</span><span class="p">)</span>
<span class="s">&quot;Line up argument lists by tabs, not spaces&quot;</span>
<span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">anchor</span> <span class="p">(</span><span class="nv">c-langelem-pos</span> <span class="nv">c-syntactic-element</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">column</span> <span class="p">(</span><span class="nv">c-langelem-2nd-pos</span> <span class="nv">c-syntactic-element</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">offset</span> <span class="p">(</span><span class="nb">-</span> <span class="p">(</span><span class="nb">1+</span> <span class="nv">column</span><span class="p">)</span> <span class="nv">anchor</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">steps</span> <span class="p">(</span><span class="nb">floor</span> <span class="nv">offset</span> <span class="nv">c-basic-offset</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">*</span> <span class="p">(</span><span class="nb">max</span> <span class="nv">steps</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nv">c-basic-offset</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;c-mode-common-hook</span>
        <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
            <span class="c1">;; Add kernel style</span>
            <span class="p">(</span><span class="nv">c-add-style</span>
            <span class="s">&quot;linux-tabs-only&quot;</span>
            <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;linux&quot;</span> <span class="p">(</span><span class="nv">c-offsets-alist</span>
                        <span class="p">(</span><span class="nv">arglist-cont-nonempty</span>
                        <span class="nv">c-lineup-gcc-asm-reg</span>
                        <span class="nv">c-lineup-arglist-tabs-only</span><span class="p">))))))</span>

<span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;c-mode-hook</span>
        <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
            <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">filename</span> <span class="p">(</span><span class="nv">buffer-file-name</span><span class="p">)))</span>
            <span class="c1">;; Enable kernel mode for the appropriate files</span>
            <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="nv">filename</span>
                        <span class="p">(</span><span class="nv">string-match</span> <span class="p">(</span><span class="nv">expand-file-name</span> <span class="s">&quot;~/src/linux-trees&quot;</span><span class="p">)</span>
                                    <span class="nv">filename</span><span class="p">))</span>
                <span class="p">(</span><span class="k">setq</span> <span class="nv">indent-tabs-mode</span> <span class="no">t</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">c-set-style</span> <span class="s">&quot;linux-tabs-only&quot;</span><span class="p">)))))</span>
</pre></div>
</div>
<p>This will make emacs go better with the kernel coding style for C
files below ~/src/linux-trees.</p>
<p>But even if you fail in getting emacs to do sane formatting, not
everything is lost: use &quot;indent&quot;.</p>
<p>Now, again, GNU indent has the same brain-dead settings that GNU emacs
has, which is why you need to give it a few command line options.
However, that's not too bad, because even the makers of GNU indent
recognize the authority of K&amp;R (the GNU people aren't evil, they are
just severely misguided in this matter), so you just give indent the
options &quot;-kr -i8&quot; (stands for &quot;K&amp;R, 8 character indents&quot;), or use
&quot;scripts/Lindent&quot;, which indents in the latest style.</p>
<p>&quot;indent&quot; has a lot of options, and especially when it comes to comment
re-formatting you may want to take a look at the man page.  But
remember: &quot;indent&quot; is not a fix for bad programming.</p>
</div>
<div class="section" id="chapter-10-kconfig-configuration-files">
<h5>Chapter 10: Kconfig configuration files<a class="headerlink" href="#chapter-10-kconfig-configuration-files" title="Ссылка на этот заголовок">¶</a></h5>
<p>For all of the Kconfig* configuration files throughout the source tree,
the indentation is somewhat different.  Lines under a &quot;config&quot; definition
are indented with one tab, while help text is indented an additional two
spaces. Example:</p>
<div class="highlight-kconfig"><div class="highlight"><pre><span></span><span class="k">config</span> AUDIT
    <span class="nb">bool</span> <span class="s2">&quot;Auditing support&quot;</span>
    <span class="k">depends on</span> NET
    <span class="k">help</span>
    Enable auditing infrastructure that can be used with another
    kernel subsystem, such as SELinux <span class="p">(</span>which requires this for
    logging of avc messages output).  Does not do system-call
    auditing without CONFIG_AUDITSYSCALL.
</pre></div>
</div>
<p>Features that might still be considered unstable should be defined as
dependent on &quot;EXPERIMENTAL&quot;:</p>
<div class="highlight-kconfig"><div class="highlight"><pre><span></span><span class="k">config</span> SLUB
    <span class="k">depends on</span> EXPERIMENTAL <span class="o">&amp;&amp;</span> <span class="o">!</span>ARCH_USES_SLAB_PAGE_STRUCT
    <span class="nb">bool</span> <span class="s2">&quot;SLUB (Unqueued Allocator)&quot;</span>
    ...
</pre></div>
</div>
<p>while seriously dangerous features (such as write support for certain
filesystems) should advertise this prominently in their prompt string:</p>
<div class="highlight-kconfig"><div class="highlight"><pre><span></span><span class="k">config</span> ADFS_FS_RW
    <span class="nb">bool</span> <span class="s2">&quot;ADFS write support (DANGEROUS)&quot;</span>
    <span class="k">depends on</span> ADFS_FS
    ...
</pre></div>
</div>
<p>For full documentation on the configuration files, see the file
Documentation/kbuild/kconfig-language.txt.</p>
</div>
<div class="section" id="chapter-11-data-structures">
<h5>Chapter 11: Data structures<a class="headerlink" href="#chapter-11-data-structures" title="Ссылка на этот заголовок">¶</a></h5>
<p>Data structures that have visibility outside the single-threaded
environment they are created and destroyed in should always have
reference counts.  In the kernel, garbage collection doesn't exist (and
outside the kernel garbage collection is slow and inefficient), which
means that you absolutely _have_ to reference count all your uses.</p>
<p>Reference counting means that you can avoid locking, and allows multiple
users to have access to the data structure in parallel - and not having
to worry about the structure suddenly going away from under them just
because they slept or did something else for a while.</p>
<p>Note that locking is _not_ a replacement for reference counting.
Locking is used to keep data structures coherent, while reference
counting is a memory management technique.  Usually both are needed, and
they are not to be confused with each other.</p>
<p>Many data structures can indeed have two levels of reference counting,
when there are users of different &quot;classes&quot;.  The subclass count counts
the number of subclass users, and decrements the global count just once
when the subclass count goes to zero.</p>
<p>Examples of this kind of &quot;multi-level-reference-counting&quot; can be found in
memory management (&quot;struct mm_struct&quot;: mm_users and mm_count), and in
filesystem code (&quot;struct super_block&quot;: s_count and s_active).</p>
<p>Remember: if another thread can find your data structure, and you don't
have a reference count on it, you almost certainly have a bug.</p>
</div>
<div class="section" id="chapter-12-macros-enums-and-rtl">
<h5>Chapter 12: Macros, Enums and RTL<a class="headerlink" href="#chapter-12-macros-enums-and-rtl" title="Ссылка на этот заголовок">¶</a></h5>
<p>Names of macros defining constants and labels in enums are capitalized.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#define CONSTANT 0x12345</span>
</pre></div>
</div>
<p>Enums are preferred when defining several related constants.</p>
<p>CAPITALIZED macro names are appreciated but macros resembling functions
may be named in lower case.</p>
<p>Generally, inline functions are preferable to macros resembling functions.</p>
<p>Macros with multiple statements should be enclosed in a do - while block:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#define macrofun(a, b, c)   \</span>
<span class="cp">    do {                    \</span>
<span class="cp">        if (a == 5)         \</span>
<span class="cp">            do_this(b, c);  \</span>
<span class="cp">    } while (0)</span>
</pre></div>
</div>
<p>Things to avoid when using macros:</p>
<ol class="arabic">
<li><p class="first">macros that affect control flow:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#define FOO(x)                  \</span>
<span class="cp">    do {                        \</span>
<span class="cp">        if (blah(x) &lt; 0)        \</span>
<span class="cp">            return -EBUGGERED;  \</span>
<span class="cp">    } while(0)</span>
</pre></div>
</div>
<p>is a _very_ bad idea.  It looks like a function call but exits the &quot;calling&quot;
function; don't break the internal parsers of those who will read the code.</p>
</li>
<li><p class="first">macros that depend on having a local variable with a magic name:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#define FOO(val) bar(index, val)</span>
</pre></div>
</div>
<p>might look like a good thing, but it's confusing as hell when one reads the
code and it's prone to breakage from seemingly innocent changes.</p>
</li>
<li><p class="first">macros with arguments that are used as l-values: FOO(x) = y; will
bite you if somebody e.g. turns FOO into an inline function.</p>
</li>
<li><p class="first">forgetting about precedence: macros defining constants using expressions
must enclose the expression in parentheses. Beware of similar issues with
macros using parameters.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#define CONSTANT 0x4000</span>
<span class="cp">#define CONSTEXP (CONSTANT | 3)</span>
</pre></div>
</div>
<p>The cpp manual deals with macros exhaustively. The gcc internals manual also
covers RTL which is used frequently with assembly language in the kernel.</p>
</li>
</ol>
</div>
<div class="section" id="chapter-13-printing-kernel-messages">
<h5>Chapter 13: Printing kernel messages<a class="headerlink" href="#chapter-13-printing-kernel-messages" title="Ссылка на этот заголовок">¶</a></h5>
<p>Kernel developers like to be seen as literate. Do mind the spelling
of kernel messages to make a good impression. Do not use crippled
words like &quot;dont&quot;; use &quot;do not&quot; or &quot;don't&quot; instead.  Make the messages
concise, clear, and unambiguous.</p>
<p>Kernel messages do not have to be terminated with a period.</p>
<p>Printing numbers in parentheses (%d) adds no value and should be avoided.</p>
<p>There are a number of driver model diagnostic macros in &lt;linux/device.h&gt;
which you should use to make sure messages are matched to the right device
and driver, and are tagged with the right level:  dev_err(), dev_warn(),
dev_info(), and so forth.  For messages that aren't associated with a
particular device, &lt;linux/kernel.h&gt; defines pr_debug() and pr_info().</p>
<p>Coming up with good debugging messages can be quite a challenge; and once
you have them, they can be a huge help for remote troubleshooting.  Such
messages should be compiled out when the DEBUG symbol is not defined (that
is, by default they are not included).  When you use dev_dbg() or pr_debug(),
that's automatic.  Many subsystems have Kconfig options to turn on -DDEBUG.
A related convention uses VERBOSE_DEBUG to add dev_vdbg() messages to the
ones already enabled by DEBUG.</p>
</div>
<div class="section" id="chapter-14-allocating-memory">
<h5>Chapter 14: Allocating memory<a class="headerlink" href="#chapter-14-allocating-memory" title="Ссылка на этот заголовок">¶</a></h5>
<p>The kernel provides the following general purpose memory allocators:
kmalloc(), kzalloc(), kcalloc(), and vmalloc().  Please refer to the API
documentation for further information about them.</p>
<p>The preferred form for passing a size of a struct is the following:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="p">...);</span>
</pre></div>
</div>
<p>The alternative form where struct name is spelled out hurts readability and
introduces an opportunity for a bug when the pointer variable type is changed
but the corresponding sizeof that is passed to a memory allocator is not.</p>
<p>Casting the return value which is a void pointer is redundant. The conversion
from void pointer to any other pointer type is guaranteed by the C programming
language.</p>
</div>
<div class="section" id="chapter-15-the-inline-disease">
<h5>Chapter 15: The inline disease<a class="headerlink" href="#chapter-15-the-inline-disease" title="Ссылка на этот заголовок">¶</a></h5>
<p>There appears to be a common misperception that gcc has a magic &quot;make me
faster&quot; speedup option called &quot;inline&quot;. While the use of inlines can be
appropriate (for example as a means of replacing macros, see Chapter 12), it
very often is not. Abundant use of the inline keyword leads to a much bigger
kernel, which in turn slows the system as a whole down, due to a bigger
icache footprint for the CPU and simply because there is less memory
available for the pagecache. Just think about it; a pagecache miss causes a
disk seek, which easily takes 5 milliseconds. There are a LOT of cpu cycles
that can go into these 5 milliseconds.</p>
<p>A reasonable rule of thumb is to not put inline at functions that have more
than 3 lines of code in them. An exception to this rule are the cases where
a parameter is known to be a compiletime constant, and as a result of this
constantness you <em>know</em> the compiler will be able to optimize most of your
function away at compile time. For a good example of this later case, see
the kmalloc() inline function.</p>
<p>Often people argue that adding inline to functions that are static and used
only once is always a win since there is no space tradeoff. While this is
technically correct, gcc is capable of inlining these automatically without
help, and the maintenance issue of removing the inline when a second user
appears outweighs the potential value of the hint that tells gcc to do
something it would have done anyway.</p>
</div>
<div class="section" id="chapter-16-function-return-values-and-names">
<h5>Chapter 16: Function return values and names<a class="headerlink" href="#chapter-16-function-return-values-and-names" title="Ссылка на этот заголовок">¶</a></h5>
<p>Functions can return values of many different kinds, and one of the
most common is a value indicating whether the function succeeded or
failed.  Such a value can be represented as an error-code integer
(-Exxx = failure, 0 = success) or a &quot;succeeded&quot; boolean (0 = failure,
non-zero = success).</p>
<p>Mixing up these two sorts of representations is a fertile source of
difficult-to-find bugs.  If the C language included a strong distinction
between integers and booleans then the compiler would find these mistakes
for us... but it doesn't.  To help prevent such bugs, always follow this
convention:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">If</span> <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">a</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">action</span> <span class="ow">or</span> <span class="n">an</span> <span class="n">imperative</span> <span class="n">command</span><span class="p">,</span>
<span class="n">the</span> <span class="n">function</span> <span class="n">should</span> <span class="k">return</span> <span class="n">an</span> <span class="n">error</span><span class="o">-</span><span class="n">code</span> <span class="n">integer</span><span class="o">.</span>  <span class="n">If</span> <span class="n">the</span> <span class="n">name</span>
<span class="ow">is</span> <span class="n">a</span> <span class="n">predicate</span><span class="p">,</span> <span class="n">the</span> <span class="n">function</span> <span class="n">should</span> <span class="k">return</span> <span class="n">a</span> <span class="s2">&quot;succeeded&quot;</span> <span class="n">boolean</span><span class="o">.</span>
</pre></div>
</div>
<p>For example, &quot;add work&quot; is a command, and the add_work() function returns 0
for success or -EBUSY for failure.  In the same way, &quot;PCI device present&quot; is
a predicate, and the pci_dev_present() function returns 1 if it succeeds in
finding a matching device or 0 if it doesn't.</p>
<p>All EXPORTed functions must respect this convention, and so should all
public functions.  Private (static) functions need not, but it is
recommended that they do.</p>
<p>Functions whose return value is the actual result of a computation, rather
than an indication of whether the computation succeeded, are not subject to
this rule.  Generally they indicate failure by returning some out-of-range
result.  Typical examples would be functions that return pointers; they use
NULL or the ERR_PTR mechanism to report failure.</p>
</div>
<div class="section" id="chapter-17-don-t-re-invent-the-kernel-macros">
<h5>Chapter 17:  Don't re-invent the kernel macros<a class="headerlink" href="#chapter-17-don-t-re-invent-the-kernel-macros" title="Ссылка на этот заголовок">¶</a></h5>
<p>The header file include/linux/kernel.h contains a number of macros that
you should use, rather than explicitly coding some variant of them yourself.
For example, if you need to calculate the length of an array, take advantage
of the macro</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#define ARRAY_SIZE(x) (sizeof(x) / sizeof((x)[0]))</span>
</pre></div>
</div>
<p>Similarly, if you need to calculate the size of some structure member, use</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#define FIELD_SIZEOF(t, f) (sizeof(((t*)0)-&gt;f))</span>
</pre></div>
</div>
<p>There are also min() and max() macros that do strict type checking if you
need them.  Feel free to peruse that header file to see what else is already
defined that you shouldn't reproduce in your code.</p>
</div>
<div class="section" id="chapter-18-editor-modelines-and-other-cruft">
<h5>Chapter 18:  Editor modelines and other cruft<a class="headerlink" href="#chapter-18-editor-modelines-and-other-cruft" title="Ссылка на этот заголовок">¶</a></h5>
<p>Some editors can interpret configuration information embedded in source files,
indicated with special markers.  For example, emacs interprets lines marked
like this:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>-*- mode: c -*-
</pre></div>
</div>
<p>Or like this:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>/*
Local Variables:
compile-command: &quot;gcc -DMAGIC_DEBUG_FLAG foo.c&quot;
End:
*/
</pre></div>
</div>
<p>Vim interprets markers that look like this:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>/* vim:set sw=8 noet */
</pre></div>
</div>
<p>Do not include any of these in source files.  People have their own personal
editor configurations, and your source files should not override them.  This
includes markers for indentation and mode configuration.  People may use their
own custom mode, or may have some other magic method for making indentation
work correctly.</p>
</div>
<div class="section" id="appendix-i-references">
<h5>Appendix I: References<a class="headerlink" href="#appendix-i-references" title="Ссылка на этот заголовок">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://en.wikipedia.org/wiki/The_C_Programming_Language">The C Programming Language, Second Edition</a>
by Brian W. Kernighan and Dennis M. Ritchie. <br />
Prentice Hall, Inc., 1988. <br />
ISBN 0-13-110362-8 (paperback), 0-13-110370-9 (hardback).</li>
<li><a class="reference external" href="https://en.wikipedia.org/wiki/The_Practice_of_Programming">The Practice of Programming</a>
by Brian W. Kernighan and Rob Pike. <br />
Addison-Wesley, Inc., 1999. <br />
ISBN 0-201-61586-X.</li>
<li><a class="reference external" href="http://www.gnu.org/manual/">GNU manuals</a> - where in compliance with K&amp;R and this text - for <strong>cpp</strong>, <strong>gcc</strong>,
<strong>gcc internals</strong> and <strong>indent</strong></li>
<li><a class="reference external" href="http://www.open-std.org/JTC1/SC22/WG14/">WG14 International standardization workgroup for the programming
language C</a></li>
<li><a class="reference external" href="http://www.kroah.com/linux/talks/ols_2002_kernel_codingstyle_talk/html/">Kernel CodingStyle, by greg&#64;kroah.com at OLS 2002</a></li>
</ul>
</div>
</div>
</div>
<span id="document-dev_guide/python_style_guide"></span><div class="section" id="python-style-guide">
<h3>Соглашения по разработке на языке Python<a class="headerlink" href="#python-style-guide" title="Ссылка на этот заголовок">¶</a></h3>
<div class="section" id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Ссылка на этот заголовок">¶</a></h4>
<p>This document gives coding conventions for the Python code comprising
the standard library in the main Python distribution.  Please see the
companion informational PEP describing style guidelines for the C code
in the C implementation of Python <a class="footnote-reference" href="#id4" id="id1">[1]</a>.</p>
<p>This document and PEP 257 (Docstring Conventions) were adapted from
Guido's original Python Style Guide essay, with some additions from
Barry's style guide <a class="footnote-reference" href="#id5" id="id2">[2]</a>.</p>
</div>
<div class="section" id="a-foolish-consistency-is-the-hobgoblin-of-little-minds">
<h4>A Foolish Consistency is the Hobgoblin of Little Minds<a class="headerlink" href="#a-foolish-consistency-is-the-hobgoblin-of-little-minds" title="Ссылка на этот заголовок">¶</a></h4>
<p>One of Guido's key insights is that code is read much more often than
it is written.  The guidelines provided here are intended to improve
the readability of code and make it consistent across the wide
spectrum of Python code.  As PEP 20 says, &quot;Readability counts&quot;.</p>
<p>A style guide is about consistency.  Consistency with this style guide
is important.  Consistency within a project is more important.
Consistency within one module or function is the most important.</p>
<p>But most importantly: know when to be inconsistent -- sometimes the
style guide just doesn't apply.  When in doubt, use your best
judgment.  Look at other examples and decide what looks best.  And
don't hesitate to ask!</p>
<p>Two good reasons to break a particular rule:</p>
<ol class="arabic simple">
<li>When applying the rule would make the code less readable, even for
someone who is used to reading code that follows the rules.</li>
<li>To be consistent with surrounding code that also breaks it (maybe
for historic reasons) -- although this is also an opportunity to
clean up someone else's mess (in true XP style).</li>
</ol>
</div>
<div class="section" id="code-lay-out">
<h4>Code lay-out<a class="headerlink" href="#code-lay-out" title="Ссылка на этот заголовок">¶</a></h4>
<div class="section" id="indentation">
<h5>Indentation<a class="headerlink" href="#indentation" title="Ссылка на этот заголовок">¶</a></h5>
<p>Use 4 spaces per indentation level.</p>
<p>For really old code that you don't want to mess up, you can continue
to use 8-space tabs.</p>
<p>Continuation lines should align wrapped elements either vertically
using Python's implicit line joining inside parentheses, brackets and
braces, or using a hanging indent.  When using a hanging indent the
following considerations should be applied; there should be no
arguments on the first line and further indentation should be used to
clearly distinguish itself as a continuation line.</p>
<p>Yes:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Aligned with opening delimiter</span>
<span class="n">foo</span> <span class="o">=</span> <span class="n">long_function_name</span><span class="p">(</span><span class="n">var_one</span><span class="p">,</span> <span class="n">var_two</span><span class="p">,</span>
                         <span class="n">var_three</span><span class="p">,</span> <span class="n">var_four</span><span class="p">)</span>

<span class="c1"># More indentation included to distinguish this from the rest.</span>
<span class="k">def</span> <span class="nf">long_function_name</span><span class="p">(</span>
        <span class="n">var_one</span><span class="p">,</span> <span class="n">var_two</span><span class="p">,</span> <span class="n">var_three</span><span class="p">,</span>
        <span class="n">var_four</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">var_one</span><span class="p">)</span>
</pre></div>
</div>
<p>No:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Arguments on first line forbidden when not using vertical alignment</span>
<span class="n">foo</span> <span class="o">=</span> <span class="n">long_function_name</span><span class="p">(</span><span class="n">var_one</span><span class="p">,</span> <span class="n">var_two</span><span class="p">,</span>
    <span class="n">var_three</span><span class="p">,</span> <span class="n">var_four</span><span class="p">)</span>

<span class="c1"># Further indentation required as indentation is not distinguishable</span>
<span class="k">def</span> <span class="nf">long_function_name</span><span class="p">(</span>
    <span class="n">var_one</span><span class="p">,</span> <span class="n">var_two</span><span class="p">,</span> <span class="n">var_three</span><span class="p">,</span>
    <span class="n">var_four</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">var_one</span><span class="p">)</span>
</pre></div>
</div>
<p>Optional:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Extra indentation is not necessary.</span>
<span class="n">foo</span> <span class="o">=</span> <span class="n">long_function_name</span><span class="p">(</span>
  <span class="n">var_one</span><span class="p">,</span> <span class="n">var_two</span><span class="p">,</span>
  <span class="n">var_three</span><span class="p">,</span> <span class="n">var_four</span><span class="p">)</span>
</pre></div>
</div>
<p>The closing brace/bracket/parenthesis on multi-line constructs may
either line up under the first non-whitespace character of the last
line of list, as in:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">my_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
    <span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">some_function_that_takes_arguments</span><span class="p">(</span>
    <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span>
    <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>or it may be lined up under the first character of the line that
starts the multi-line construct, as in:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">my_list</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">some_function_that_takes_arguments</span><span class="p">(</span>
    <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span>
    <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="tabs-or-spaces">
<h5>Tabs or Spaces?<a class="headerlink" href="#tabs-or-spaces" title="Ссылка на этот заголовок">¶</a></h5>
<p>Never mix tabs and spaces.</p>
<p>The most popular way of indenting Python is with spaces only.  The
second-most popular way is with tabs only.  Code indented with a
mixture of tabs and spaces should be converted to using spaces
exclusively.  When invoking the Python command line interpreter with
the <code class="docutils literal"><span class="pre">-t</span></code> option, it issues warnings about code that illegally mixes
tabs and spaces.  When using <code class="docutils literal"><span class="pre">-tt</span></code> these warnings become errors.
These options are highly recommended!</p>
<p>For new projects, spaces-only are strongly recommended over tabs.
Most editors have features that make this easy to do.</p>
</div>
<div class="section" id="maximum-line-length">
<h5>Maximum Line Length<a class="headerlink" href="#maximum-line-length" title="Ссылка на этот заголовок">¶</a></h5>
<p>Limit all lines to a maximum of 79 characters.</p>
<p>There are still many devices around that are limited to 80 character
lines; plus, limiting windows to 80 characters makes it possible to
have several windows side-by-side.  The default wrapping on such
devices disrupts the visual structure of the code, making it more
difficult to understand.  Therefore, please limit all lines to a
maximum of 79 characters.  For flowing long blocks of text (docstrings
or comments), limiting the length to 72 characters is recommended.</p>
<p>The preferred way of wrapping long lines is by using Python's implied
line continuation inside parentheses, brackets and braces.  Long lines
can be broken over multiple lines by wrapping expressions in
parentheses. These should be used in preference to using a backslash
for line continuation.</p>
<p>Backslashes may still be appropriate at times.  For example, long,
multiple <code class="docutils literal"><span class="pre">with</span></code>-statements cannot use implicit continuation, so
backslashes are acceptable:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/path/to/some/file/you/want/to/read&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_1</span><span class="p">,</span> \
        <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/path/to/some/file/being/written&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_2</span><span class="p">:</span>
    <span class="n">file_2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_1</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
<p>Another such case is with <code class="docutils literal"><span class="pre">assert</span></code> statements.</p>
<p>Make sure to indent the continued line appropriately.  The preferred
place to break around a binary operator is <em>after</em> the operator, not
before it.  Some examples:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Rectangle</span><span class="p">(</span><span class="n">Blob</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">emphasis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">highlight</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">height</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>
            <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;red&#39;</span> <span class="ow">and</span> <span class="n">emphasis</span> <span class="o">==</span> <span class="s1">&#39;strong&#39;</span> <span class="ow">or</span>
            <span class="n">highlight</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;sorry, you lose&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">width</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">height</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;red&#39;</span> <span class="ow">or</span>
                                           <span class="n">emphasis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;I don&#39;t think so -- values are </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
        <span class="n">Blob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span>
                      <span class="n">color</span><span class="p">,</span> <span class="n">emphasis</span><span class="p">,</span> <span class="n">highlight</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="blank-lines">
<h5>Blank Lines<a class="headerlink" href="#blank-lines" title="Ссылка на этот заголовок">¶</a></h5>
<p>Separate top-level function and class definitions with two blank
lines.</p>
<p>Method definitions inside a class are separated by a single blank
line.</p>
<p>Extra blank lines may be used (sparingly) to separate groups of
related functions.  Blank lines may be omitted between a bunch of
related one-liners (e.g. a set of dummy implementations).</p>
<p>Use blank lines in functions, sparingly, to indicate logical sections.</p>
<p>Python accepts the control-L (i.e. ^L) form feed character as
whitespace; Many tools treat these characters as page separators, so
you may use them to separate pages of related sections of your file.
Note, some editors and web-based code viewers may not recognize
control-L as a form feed and will show another glyph in its place.</p>
</div>
<div class="section" id="encodings-pep-263">
<h5>Encodings (PEP 263)<a class="headerlink" href="#encodings-pep-263" title="Ссылка на этот заголовок">¶</a></h5>
<p>Code in the core Python distribution should always use the ASCII or
Latin-1 encoding (a.k.a. ISO-8859-1).  For Python 3.0 and beyond,
UTF-8 is preferred over Latin-1, see PEP 3120.</p>
<p>Files using ASCII should not have a coding cookie.  Latin-1 (or UTF-8)
should only be used when a comment or docstring needs to mention an
author name that requires Latin-1; otherwise, using <code class="docutils literal"><span class="pre">\x</span></code>, <code class="docutils literal"><span class="pre">\u</span></code> or
<code class="docutils literal"><span class="pre">\U</span></code> escapes is the preferred way to include non-ASCII data in
string literals.</p>
<p>For Python 3.0 and beyond, the following policy is prescribed for the
standard library (see PEP 3131): All identifiers in the Python
standard library MUST use ASCII-only identifiers, and SHOULD use
English words wherever feasible (in many cases, abbreviations and
technical terms are used which aren't English). In addition, string
literals and comments must also be in ASCII. The only exceptions are
(a) test cases testing the non-ASCII features, and
(b) names of authors. Authors whose names are not based on the
latin alphabet MUST provide a latin transliteration of their
names.</p>
<p>Open source projects with a global audience are encouraged to adopt a
similar policy.</p>
</div>
<div class="section" id="imports">
<h5>Imports<a class="headerlink" href="#imports" title="Ссылка на этот заголовок">¶</a></h5>
<ul>
<li><p class="first">Imports should usually be on separate lines, e.g.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Yes</span><span class="p">:</span> <span class="kn">import</span> <span class="nn">os</span>
     <span class="kn">import</span> <span class="nn">sys</span>

<span class="n">No</span><span class="p">:</span>  <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
</pre></div>
</div>
<p>It's okay to say this though:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">subprocess</span> <span class="k">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
</pre></div>
</div>
</li>
<li><p class="first">Imports are always put at the top of the file, just after any module
comments and docstrings, and before module globals and constants.</p>
<p>Imports should be grouped in the following order:</p>
<ol class="arabic simple">
<li>standard library imports</li>
<li>related third party imports</li>
<li>local application/library specific imports</li>
</ol>
<p>You should put a blank line between each group of imports.</p>
<p>Put any relevant <code class="docutils literal"><span class="pre">__all__</span></code> specification after the imports.</p>
</li>
<li><p class="first">Relative imports for intra-package imports are highly discouraged.
Always use the absolute package path for all imports.  Even now that
PEP 328 is fully implemented in Python 2.5, its style of explicit
relative imports is actively discouraged; absolute imports are more
portable and usually more readable.</p>
</li>
<li><p class="first">When importing a class from a class-containing module, it's usually
okay to spell this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">myclass</span> <span class="k">import</span> <span class="n">MyClass</span>
<span class="kn">from</span> <span class="nn">foo.bar.yourclass</span> <span class="k">import</span> <span class="n">YourClass</span>
</pre></div>
</div>
<p>If this spelling causes local name clashes, then spell them</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">myclass</span>
<span class="kn">import</span> <span class="nn">foo.bar.yourclass</span>
</pre></div>
</div>
<p>and use &quot;myclass.MyClass&quot; and &quot;foo.bar.yourclass.YourClass&quot;.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="whitespace-in-expressions-and-statements">
<h4>Whitespace in Expressions and Statements<a class="headerlink" href="#whitespace-in-expressions-and-statements" title="Ссылка на этот заголовок">¶</a></h4>
<div class="section" id="pet-peeves">
<h5>Pet Peeves<a class="headerlink" href="#pet-peeves" title="Ссылка на этот заголовок">¶</a></h5>
<p>Avoid extraneous whitespace in the following situations:</p>
<ul>
<li><p class="first">Immediately inside parentheses, brackets or braces.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Yes</span><span class="p">:</span> <span class="n">spam</span><span class="p">(</span><span class="n">ham</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">{</span><span class="n">eggs</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="n">No</span><span class="p">:</span>  <span class="n">spam</span><span class="p">(</span> <span class="n">ham</span><span class="p">[</span> <span class="mi">1</span> <span class="p">],</span> <span class="p">{</span> <span class="n">eggs</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Immediately before a comma, semicolon, or colon:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Yes</span><span class="p">:</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="nb">print</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">;</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span>
<span class="n">No</span><span class="p">:</span>  <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">4</span> <span class="p">:</span> <span class="nb">print</span> <span class="n">x</span> <span class="p">,</span> <span class="n">y</span> <span class="p">;</span> <span class="n">x</span> <span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="p">,</span> <span class="n">x</span>
</pre></div>
</div>
</li>
<li><p class="first">Immediately before the open parenthesis that starts the argument
list of a function call:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Yes</span><span class="p">:</span> <span class="n">spam</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">No</span><span class="p">:</span>  <span class="n">spam</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Immediately before the open parenthesis that starts an indexing or
slicing:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Yes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
<span class="n">No</span><span class="p">:</span>  <span class="nb">dict</span> <span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">More than one space around an assignment (or other) operator to
align it with another.</p>
<p>Yes:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">long_variable</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<p>No:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">x</span>             <span class="o">=</span> <span class="mi">1</span>
<span class="n">y</span>             <span class="o">=</span> <span class="mi">2</span>
<span class="n">long_variable</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="other-recommendations">
<h5>Other Recommendations<a class="headerlink" href="#other-recommendations" title="Ссылка на этот заголовок">¶</a></h5>
<ul>
<li><p class="first">Always surround these binary operators with a single space on either
side: assignment (<code class="docutils literal"><span class="pre">=</span></code>), augmented assignment (<code class="docutils literal"><span class="pre">+=</span></code>, <code class="docutils literal"><span class="pre">-=</span></code>
etc.), comparisons (<code class="docutils literal"><span class="pre">==</span></code>, <code class="docutils literal"><span class="pre">&lt;</span></code>, <code class="docutils literal"><span class="pre">&gt;</span></code>, <code class="docutils literal"><span class="pre">!=</span></code>, <code class="docutils literal"><span class="pre">&lt;&gt;</span></code>, <code class="docutils literal"><span class="pre">&lt;=</span></code>,
<code class="docutils literal"><span class="pre">&gt;=</span></code>, <code class="docutils literal"><span class="pre">in</span></code>, <code class="docutils literal"><span class="pre">not</span> <span class="pre">in</span></code>, <code class="docutils literal"><span class="pre">is</span></code>, <code class="docutils literal"><span class="pre">is</span> <span class="pre">not</span></code>), Booleans (<code class="docutils literal"><span class="pre">and</span></code>,
<code class="docutils literal"><span class="pre">or</span></code>, <code class="docutils literal"><span class="pre">not</span></code>).</p>
</li>
<li><p class="first">If operators with different priorities are used, consider adding
whitespace around the operators with the lowest priority(ies). Use
your own judgement; however, never use more than one space, and
always have the same amount of whitespace on both sides of a binary
operator.</p>
<p>Yes:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">submitted</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">hypot2</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span>
<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
<p>No:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
<span class="n">submitted</span> <span class="o">+=</span><span class="mi">1</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">hypot2</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span>
<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Don't use spaces around the <code class="docutils literal"><span class="pre">=</span></code> sign when used to indicate a
keyword argument or a default parameter value.</p>
<p>Yes:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">complex</span><span class="p">(</span><span class="n">real</span><span class="p">,</span> <span class="n">imag</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">magic</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">real</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">imag</span><span class="p">)</span>
</pre></div>
</div>
<p>No:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">complex</span><span class="p">(</span><span class="n">real</span><span class="p">,</span> <span class="n">imag</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">magic</span><span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">real</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">imag</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Compound statements (multiple statements on the same line) are
generally discouraged.</p>
<p>Yes:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">foo</span> <span class="o">==</span> <span class="s1">&#39;blah&#39;</span><span class="p">:</span>
    <span class="n">do_blah_thing</span><span class="p">()</span>
<span class="n">do_one</span><span class="p">()</span>
<span class="n">do_two</span><span class="p">()</span>
<span class="n">do_three</span><span class="p">()</span>
</pre></div>
</div>
<p>Rather not:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">foo</span> <span class="o">==</span> <span class="s1">&#39;blah&#39;</span><span class="p">:</span> <span class="n">do_blah_thing</span><span class="p">()</span>
<span class="n">do_one</span><span class="p">();</span> <span class="n">do_two</span><span class="p">();</span> <span class="n">do_three</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p class="first">While sometimes it's okay to put an if/for/while with a small body
on the same line, never do this for multi-clause statements.  Also
avoid folding such long lines!</p>
<p>Rather not:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">foo</span> <span class="o">==</span> <span class="s1">&#39;blah&#39;</span><span class="p">:</span> <span class="n">do_blah_thing</span><span class="p">()</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span> <span class="n">total</span> <span class="o">+=</span> <span class="n">x</span>
<span class="k">while</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span> <span class="n">t</span> <span class="o">=</span> <span class="n">delay</span><span class="p">()</span>
</pre></div>
</div>
<p>Definitely not:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">foo</span> <span class="o">==</span> <span class="s1">&#39;blah&#39;</span><span class="p">:</span> <span class="n">do_blah_thing</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span> <span class="n">do_non_blah_thing</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span> <span class="n">something</span><span class="p">()</span>
<span class="k">finally</span><span class="p">:</span> <span class="n">cleanup</span><span class="p">()</span>

<span class="n">do_one</span><span class="p">();</span> <span class="n">do_two</span><span class="p">();</span> <span class="n">do_three</span><span class="p">(</span><span class="n">long</span><span class="p">,</span> <span class="n">argument</span><span class="p">,</span>
                             <span class="nb">list</span><span class="p">,</span> <span class="n">like</span><span class="p">,</span> <span class="n">this</span><span class="p">)</span>

<span class="k">if</span> <span class="n">foo</span> <span class="o">==</span> <span class="s1">&#39;blah&#39;</span><span class="p">:</span> <span class="n">one</span><span class="p">();</span> <span class="n">two</span><span class="p">();</span> <span class="n">three</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="comments">
<h4>Comments<a class="headerlink" href="#comments" title="Ссылка на этот заголовок">¶</a></h4>
<p>Comments that contradict the code are worse than no comments.  Always
make a priority of keeping the comments up-to-date when the code
changes!</p>
<p>Comments should be complete sentences.  If a comment is a phrase or
sentence, its first word should be capitalized, unless it is an
identifier that begins with a lower case letter (never alter the case
of identifiers!).</p>
<p>If a comment is short, the period at the end can be omitted.  Block
comments generally consist of one or more paragraphs built out of
complete sentences, and each sentence should end in a period.</p>
<p>You should use two spaces after a sentence-ending period.</p>
<p>When writing English, Strunk and White apply.</p>
<p>Python coders from non-English speaking countries: please write your
comments in English, unless you are 120% sure that the code will never
be read by people who don't speak your language.</p>
<div class="section" id="block-comments">
<h5>Block Comments<a class="headerlink" href="#block-comments" title="Ссылка на этот заголовок">¶</a></h5>
<p>Block comments generally apply to some (or all) code that follows
them, and are indented to the same level as that code.  Each line of a
block comment starts with a <code class="docutils literal"><span class="pre">#</span></code> and a single space (unless it is
indented text inside the comment).</p>
<p>Paragraphs inside a block comment are separated by a line containing a
single <code class="docutils literal"><span class="pre">#</span></code>.</p>
</div>
<div class="section" id="inline-comments">
<h5>Inline Comments<a class="headerlink" href="#inline-comments" title="Ссылка на этот заголовок">¶</a></h5>
<p>Use inline comments sparingly.</p>
<p>An inline comment is a comment on the same line as a statement.
Inline comments should be separated by at least two spaces from the
statement.  They should start with a # and a single space.</p>
<p>Inline comments are unnecessary and in fact distracting if they state
the obvious.  Don't do this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>                 <span class="c1"># Increment x</span>
</pre></div>
</div>
<p>But sometimes, this is useful:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>                 <span class="c1"># Compensate for border</span>
</pre></div>
</div>
</div>
<div class="section" id="documentation-strings">
<h5>Documentation Strings<a class="headerlink" href="#documentation-strings" title="Ссылка на этот заголовок">¶</a></h5>
<p>Conventions for writing good documentation strings
(a.k.a. &quot;docstrings&quot;) are immortalized in PEP 257.</p>
<ul>
<li><p class="first">Write docstrings for all public modules, functions, classes, and
methods.  Docstrings are not necessary for non-public methods, but
you should have a comment that describes what the method does.  This
comment should appear after the <code class="docutils literal"><span class="pre">def</span></code> line.</p>
</li>
<li><p class="first">PEP 257 describes good docstring conventions.  Note that most
importantly, the <code class="docutils literal"><span class="pre">&quot;&quot;&quot;</span></code> that ends a multiline docstring should be
on a line by itself, and preferably preceded by a blank line, e.g.:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Return a foobang</span>

<span class="sd">Optional plotz says to frobnicate the bizbaz first.</span>

<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">For one liner docstrings, it's okay to keep the closing <code class="docutils literal"><span class="pre">&quot;&quot;&quot;</span></code> on
the same line.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="version-bookkeeping">
<h4>Version Bookkeeping<a class="headerlink" href="#version-bookkeeping" title="Ссылка на этот заголовок">¶</a></h4>
<p>If you have to have Subversion, CVS, or RCS crud in your source file,
do it as follows.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;$Revision$&quot;</span>
<span class="c1"># $Source$</span>
</pre></div>
</div>
<p>These lines should be included after the module's docstring, before
any other code, separated by a blank line above and below.</p>
</div>
<div class="section" id="naming-conventions">
<h4>Naming Conventions<a class="headerlink" href="#naming-conventions" title="Ссылка на этот заголовок">¶</a></h4>
<p>The naming conventions of Python's library are a bit of a mess, so
we'll never get this completely consistent -- nevertheless, here are
the currently recommended naming standards.  New modules and packages
(including third party frameworks) should be written to these
standards, but where an existing library has a different style,
internal consistency is preferred.</p>
<div class="section" id="descriptive-naming-styles">
<h5>Descriptive: Naming Styles<a class="headerlink" href="#descriptive-naming-styles" title="Ссылка на этот заголовок">¶</a></h5>
<p>There are a lot of different naming styles.  It helps to be able to
recognize what naming style is being used, independently from what
they are used for.</p>
<p>The following naming styles are commonly distinguished:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">b</span></code> (single lowercase letter)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">B</span></code> (single uppercase letter)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">lowercase</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">lower_case_with_underscores</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">UPPERCASE</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">UPPER_CASE_WITH_UNDERSCORES</span></code></p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">CapitalizedWords</span></code> (or CapWords, or CamelCase -- so named because
of the bumpy look of its letters <a class="footnote-reference" href="#id6" id="id3">[3]</a>).  This is also sometimes known
as StudlyCaps.</p>
<p>Note: When using abbreviations in CapWords, capitalize all the
letters of the abbreviation.  Thus HTTPServerError is better than
HttpServerError.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">mixedCase</span></code> (differs from CapitalizedWords by initial lowercase
character!)</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">Capitalized_Words_With_Underscores</span></code> (ugly!)</p>
</li>
</ul>
<p>There's also the style of using a short unique prefix to group related
names together.  This is not used much in Python, but it is mentioned
for completeness.  For example, the <code class="docutils literal"><span class="pre">os.stat()</span></code> function returns a
tuple whose items traditionally have names like <code class="docutils literal"><span class="pre">st_mode</span></code>,
<code class="docutils literal"><span class="pre">st_size</span></code>, <code class="docutils literal"><span class="pre">st_mtime</span></code> and so on.  (This is done to emphasize the
correspondence with the fields of the POSIX system call struct, which
helps programmers familiar with that.)</p>
<p>The X11 library uses a leading X for all its public functions.  In
Python, this style is generally deemed unnecessary because attribute
and method names are prefixed with an object, and function names are
prefixed with a module name.</p>
<p>In addition, the following special forms using leading or trailing
underscores are recognized (these can generally be combined with any
case convention):</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">_single_leading_underscore</span></code>: weak &quot;internal use&quot; indicator.
E.g. <code class="docutils literal"><span class="pre">from</span> <span class="pre">M</span> <span class="pre">import</span> <span class="pre">*</span></code> does not import objects whose name starts
with an underscore.</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">single_trailing_underscore_</span></code>: used by convention to avoid
conflicts with Python keyword, e.g.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Tkinter</span><span class="o">.</span><span class="n">Toplevel</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s1">&#39;ClassName&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">__double_leading_underscore</span></code>: when naming a class attribute,
invokes name mangling (inside class FooBar, <code class="docutils literal"><span class="pre">__boo</span></code> becomes
<code class="docutils literal"><span class="pre">_FooBar__boo</span></code>; see below).</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">__double_leading_and_trailing_underscore__</span></code>: &quot;magic&quot; objects or
attributes that live in user-controlled namespaces.
E.g. <code class="docutils literal"><span class="pre">__init__</span></code>, <code class="docutils literal"><span class="pre">__import__</span></code> or <code class="docutils literal"><span class="pre">__file__</span></code>.  Never invent
such names; only use them as documented.</p>
</li>
</ul>
</div>
<div class="section" id="prescriptive-naming-conventions">
<h5>Prescriptive: Naming Conventions<a class="headerlink" href="#prescriptive-naming-conventions" title="Ссылка на этот заголовок">¶</a></h5>
<div class="section" id="names-to-avoid">
<h6>Names to Avoid<a class="headerlink" href="#names-to-avoid" title="Ссылка на этот заголовок">¶</a></h6>
<p>Never use the characters 'l' (lowercase letter el), 'O' (uppercase
letter oh), or 'I' (uppercase letter eye) as single character variable
names.</p>
<p>In some fonts, these characters are indistinguishable from the
numerals one and zero.  When tempted to use 'l', use 'L' instead.</p>
</div>
<div class="section" id="package-and-module-names">
<h6>Package and Module Names<a class="headerlink" href="#package-and-module-names" title="Ссылка на этот заголовок">¶</a></h6>
<p>Modules should have short, all-lowercase names.  Underscores can be
used in the module name if it improves readability.  Python packages
should also have short, all-lowercase names, although the use of
underscores is discouraged.</p>
<p>Since module names are mapped to file names, and some file systems are
case insensitive and truncate long names, it is important that module
names be chosen to be fairly short -- this won't be a problem on Unix,
but it may be a problem when the code is transported to older Mac or
Windows versions, or DOS.</p>
<p>When an extension module written in C or C++ has an accompanying
Python module that provides a higher level (e.g. more object oriented)
interface, the C/C++ module has a leading underscore
(e.g. <code class="docutils literal"><span class="pre">_socket</span></code>).</p>
</div>
<div class="section" id="class-names">
<h6>Class Names<a class="headerlink" href="#class-names" title="Ссылка на этот заголовок">¶</a></h6>
<p>Almost without exception, class names use the CapWords convention.
Classes for internal use have a leading underscore in addition.</p>
</div>
<div class="section" id="exception-names">
<h6>Exception Names<a class="headerlink" href="#exception-names" title="Ссылка на этот заголовок">¶</a></h6>
<p>Because exceptions should be classes, the class naming convention
applies here.  However, you should use the suffix &quot;Error&quot; on your
exception names (if the exception actually is an error).</p>
</div>
<div class="section" id="global-variable-names">
<h6>Global Variable Names<a class="headerlink" href="#global-variable-names" title="Ссылка на этот заголовок">¶</a></h6>
<p>(Let's hope that these variables are meant for use inside one module
only.)  The conventions are about the same as those for functions.</p>
<p>Modules that are designed for use via <code class="docutils literal"><span class="pre">from</span> <span class="pre">M</span> <span class="pre">import</span> <span class="pre">*</span></code> should use
the <code class="docutils literal"><span class="pre">__all__</span></code> mechanism to prevent exporting globals, or use the
older convention of prefixing such globals with an underscore (which
you might want to do to indicate these globals are &quot;module
non-public&quot;).</p>
</div>
<div class="section" id="function-names">
<h6>Function Names<a class="headerlink" href="#function-names" title="Ссылка на этот заголовок">¶</a></h6>
<p>Function names should be lowercase, with words separated by
underscores as necessary to improve readability.</p>
<p>mixedCase is allowed only in contexts where that's already the
prevailing style (e.g. threading.py), to retain backwards
compatibility.</p>
</div>
<div class="section" id="function-and-method-arguments">
<h6>Function and method arguments<a class="headerlink" href="#function-and-method-arguments" title="Ссылка на этот заголовок">¶</a></h6>
<p>Always use <code class="docutils literal"><span class="pre">self</span></code> for the first argument to instance methods.</p>
<p>Always use <code class="docutils literal"><span class="pre">cls</span></code> for the first argument to class methods.</p>
<p>If a function argument's name clashes with a reserved keyword, it is
generally better to append a single trailing underscore rather than
use an abbreviation or spelling corruption.  Thus <code class="docutils literal"><span class="pre">class_</span></code> is better
than <code class="docutils literal"><span class="pre">clss</span></code>.  (Perhaps better is to avoid such clashes by using a
synonym.)</p>
</div>
<div class="section" id="method-names-and-instance-variables">
<h6>Method Names and Instance Variables<a class="headerlink" href="#method-names-and-instance-variables" title="Ссылка на этот заголовок">¶</a></h6>
<p>Use the function naming rules: lowercase with words separated by
underscores as necessary to improve readability.</p>
<p>Use one leading underscore only for non-public methods and instance
variables.</p>
<p>To avoid name clashes with subclasses, use two leading underscores to
invoke Python's name mangling rules.</p>
<p>Python mangles these names with the class name: if class Foo has an
attribute named <code class="docutils literal"><span class="pre">__a</span></code>, it cannot be accessed by <code class="docutils literal"><span class="pre">Foo.__a</span></code>.  (An
insistent user could still gain access by calling <code class="docutils literal"><span class="pre">Foo._Foo__a</span></code>.)
Generally, double leading underscores should be used only to avoid
name conflicts with attributes in classes designed to be subclassed.</p>
<p>Note: there is some controversy about the use of __names (see below).</p>
</div>
<div class="section" id="constants">
<h6>Constants<a class="headerlink" href="#constants" title="Ссылка на этот заголовок">¶</a></h6>
<p>Constants are usually defined on a module level and written in all
capital letters with underscores separating words.  Examples include
<code class="docutils literal"><span class="pre">MAX_OVERFLOW</span></code> and <code class="docutils literal"><span class="pre">TOTAL</span></code>.</p>
</div>
<div class="section" id="designing-for-inheritance">
<h6>Designing for inheritance<a class="headerlink" href="#designing-for-inheritance" title="Ссылка на этот заголовок">¶</a></h6>
<p>Always decide whether a class's methods and instance variables
(collectively: &quot;attributes&quot;) should be public or non-public.  If in
doubt, choose non-public; it's easier to make it public later than to
make a public attribute non-public.</p>
<p>Public attributes are those that you expect unrelated clients of your
class to use, with your commitment to avoid backward incompatible
changes.  Non-public attributes are those that are not intended to be
used by third parties; you make no guarantees that non-public
attributes won't change or even be removed.</p>
<p>We don't use the term &quot;private&quot; here, since no attribute is really
private in Python (without a generally unnecessary amount of work).</p>
<p>Another category of attributes are those that are part of the
&quot;subclass API&quot; (often called &quot;protected&quot; in other languages).  Some
classes are designed to be inherited from, either to extend or modify
aspects of the class's behavior.  When designing such a class, take
care to make explicit decisions about which attributes are public,
which are part of the subclass API, and which are truly only to be
used by your base class.</p>
<p>With this in mind, here are the Pythonic guidelines:</p>
<ul>
<li><p class="first">Public attributes should have no leading underscores.</p>
</li>
<li><p class="first">If your public attribute name collides with a reserved keyword,
append a single trailing underscore to your attribute name.  This is
preferable to an abbreviation or corrupted spelling.  (However,
not withstanding this rule, 'cls' is the preferred spelling for any
variable or argument which is known to be a class, especially the
first argument to a class method.)</p>
<dl class="docutils">
<dt>Note 1:</dt>
<dd><p class="first last">See the argument name recommendation above for class methods.</p>
</dd>
</dl>
</li>
<li><p class="first">For simple public data attributes, it is best to expose just the
attribute name, without complicated accessor/mutator methods.  Keep
in mind that Python provides an easy path to future enhancement,
should you find that a simple data attribute needs to grow
functional behavior.  In that case, use properties to hide
functional implementation behind simple data attribute access
syntax.</p>
<dl class="docutils">
<dt>Note 1:</dt>
<dd><p class="first last">Properties only work on new-style classes.</p>
</dd>
<dt>Note 2:</dt>
<dd><p class="first last">Try to keep the functional behavior side-effect free,
although side-effects such as caching are generally fine.</p>
</dd>
<dt>Note 3:</dt>
<dd><p class="first last">Avoid using properties for computationally expensive operations;
the attribute notation makes the caller believe that access is
(relatively) cheap.</p>
</dd>
</dl>
</li>
<li><p class="first">If your class is intended to be subclassed, and you have attributes
that you do not want subclasses to use, consider naming them with
double leading underscores and no trailing underscores.  This
invokes Python's name mangling algorithm, where the name of the
class is mangled into the attribute name.  This helps avoid
attribute name collisions should subclasses inadvertently contain
attributes with the same name.</p>
<dl class="docutils">
<dt>Note 1:</dt>
<dd><p class="first last">Note that only the simple class name is used in the mangled
name, so if a subclass chooses both the same class name and
attribute name, you can still get name collisions.</p>
</dd>
<dt>Note 2:</dt>
<dd><p class="first last">Name mangling can make certain uses, such as debugging and
<code class="docutils literal"><span class="pre">__getattr__()</span></code>, less convenient.  However the name mangling
algorithm is well documented and easy to perform manually.</p>
</dd>
<dt>Note 3:</dt>
<dd><p class="first last">Not everyone likes name mangling.  Try to balance the
need to avoid accidental name clashes with potential use by
advanced callers.</p>
</dd>
</dl>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="references">
<h4>References<a class="headerlink" href="#references" title="Ссылка на этот заголовок">¶</a></h4>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="https://www.python.org/dev/peps/pep-0007/">PEP 7, Style Guide for C Code, van Rossum</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://barry.warsaw.us/software/STYLEGUIDE.txt">Barry's GNU Mailman style guide</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="http://www.wikipedia.com/wiki/CamelCase">CamelCase Wikipedia page</a></td></tr>
</tbody>
</table>
</div>
<div class="section" id="copyright">
<h4>Copyright<a class="headerlink" href="#copyright" title="Ссылка на этот заголовок">¶</a></h4>
<p>Author:</p>
<ul class="simple">
<li>Guido van Rossum &lt;<a class="reference external" href="mailto:guido&#37;&#52;&#48;python&#46;org">guido<span>&#64;</span>python<span>&#46;</span>org</a>&gt;</li>
<li>Barry Warsaw &lt;<a class="reference external" href="mailto:barry&#37;&#52;&#48;python&#46;org">barry<span>&#64;</span>python<span>&#46;</span>org</a>&gt;</li>
</ul>
</div>
</div>
<span id="document-dev_guide/release_management"></span><div class="section" id="release-management">
<h3>Работа с релизами<a class="headerlink" href="#release-management" title="Ссылка на этот заголовок">¶</a></h3>
<div class="section" id="how-to-make-a-minor-release">
<h4>How to make a minor release<a class="headerlink" href="#how-to-make-a-minor-release" title="Ссылка на этот заголовок">¶</a></h4>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ git tag -a 1.4.4 -m <span class="s2">&quot;Next minor in 1.4 series&quot;</span>
$ vim CMakeLists.txt <span class="c1"># edit CPACK_PACKAGE_VERSION_PATCH</span>
$ git push --tags
</pre></div>
</div>
<p>Update the Web site in doc/www</p>
<p>Update all issues, upload the ChangeLog based on <code class="docutils literal"><span class="pre">git</span> <span class="pre">log</span></code> output.
The ChangeLog must only include items which are mentioned as issues
on github. If anything significant is there, which is not mentioned,
something went wrong in release planning and the release should be
held up until this is cleared.</p>
<p>Click 'Release milestone'. Create a milestone for the next minor release.
Alert the driver to target bugs and blueprints to the new milestone.</p>
</div>
</div>
</div>
</div>
</div>
<ul class="simple">
<li><a class="reference internal" href="genindex.html"><span class="std std-ref">Алфавитный указатель</span></a></li>
</ul>
</div>


          
          
  <div id="disqus_thread"></div>
  <script>
    // DON'T EDIT
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//tarantooldb.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href="https://disqus.com/?ref_noscript" rel="nofollow">
      comments powered by Disqus.
    </a>
  </noscript>

          
  
</div>
      </div>
    </div>
  

      </div>
    </div>

  <!-- FOOTER > -->
  
<footer class="b-footer">
  <div class="b-footer-wrapper">
    <nav class="b-footer_menu">
      
  <ul class="b-menu">
    
      <li class="b-menu-item">
        <a href="/" class="b-menu-item-url">Overview</a>
      </li>
    
      <li class="b-menu-item">
        <a href="http://try.tarantool.org" class="b-menu-item-url">Try</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/doc/" class="b-menu-item-url">Documentation</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/download.html" class="b-menu-item-url">Download</a>
      </li>
    
      <li class="b-menu-item">
        <a href="/careers.html" class="b-menu-item-url">Careers</a>
      </li>
    
      <li class="b-menu-item">
        <a href="http://rocks.tarantool.org" class="b-menu-item-url">Rocks</a>
      </li>
    
  </ul>

      <div class="b-footer-other">
        <a href="http://15.tarantool.org">1.5 web site and downloads</a>
      </div>
    </nav>
  </div>
</footer>

  <!-- < FOOTER -->
  </body>
</html>

